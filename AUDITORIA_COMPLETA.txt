AUDITORA DE PROYECTO CONTROL DATA
Fecha: 2025-12-08T20:17:45.577Z
----------------------------------------


================================================================================
FILE: apps\functions\jest.config.js
================================================================================
/** @type {import('ts-jest').JestConfigWithTsJest} */
module.exports = {
  // Configuraci贸n base para proyectos TypeScript con Jest
  preset: 'ts-jest', 
  
  // Entorno de ejecuci贸n de Node.js (necesario para el backend)
  testEnvironment: 'node', 
  
  // Rutas donde buscar los archivos fuente y de prueba
  roots: ['<rootDir>/src/', '<rootDir>/test/'],
  
  // Expresiones regulares para identificar archivos de prueba (archivos terminados en .spec.ts o .test.ts)
  testRegex: '(/__tests__/.*|(\\.|/)(test|spec))\\.ts$',

  // Configuraci贸n de M贸dulos (para resolver rutas internas de NestJS)
  moduleNameMapper: {
    // Si tienes aliases definidos en tsconfig.json, se deben mapear aqu铆
  },
  
  // CLAVE: Definici贸n expl铆cita del transformador para manejar TypeScript
  transform: {
    // Usar ts-jest para todos los archivos .ts
    '^.+\\.ts$': [
      'ts-jest', 
      {
        // Indica a ts-jest que use el archivo de configuraci贸n de TypeScript del proyecto actual
        tsconfig: './tsconfig.json', 
      },
    ],
  },
  
  // Extensiones de archivos que debe buscar
  moduleFileExtensions: ['js', 'json', 'ts'],

  // Carpetas a ignorar para la transformaci贸n y ejecuci贸n
  testPathIgnorePatterns: [
    '/node_modules/',
    '/lib/' // Carpeta de salida de la compilaci贸n
  ],
  
  // Configuraci贸n de Cobertura de C贸digo (Opcional, pero recomendado en la WBS)
  collectCoverageFrom: [
    'src/**/*.{js,ts}'
  ],
  coverageDirectory: 'coverage',
};

================================================================================
FILE: apps\functions\package.json
================================================================================
{
  "name": "functions",
  "scripts": {
    "lint": "eslint --ext .ts,.js src/",
    "build": "tsc",
    "build:watch": "tsc --watch",
    "serve": "npm run build && firebase emulators:start --only functions",
    "shell": "npm run build && firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "20"
  },
  "main": "lib/index.js",
  "dependencies": {
    "@nestjs/common": "^10.0.0",
    "@nestjs/core": "^10.0.0",
    "@nestjs/platform-express": "^10.0.0",
    "firebase-admin": "^12.0.0",
    "firebase-functions": "^4.9.0", 
    "reflect-metadata": "^0.1.13",
    "rxjs": "^7.8.1"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@typescript-eslint/eslint-plugin": "^5.59.11",
    "@typescript-eslint/parser": "^5.59.11",
    "eslint": "^8.42.0",
    "eslint-config-google": "^0.14.0",
    "eslint-plugin-import": "^2.27.5",
    "typescript": "^5.1.3",
    "firebase-functions-test": "^3.1.0"
  },
  "private": true
}

================================================================================
FILE: apps\functions\src\app.module.ts
================================================================================
// apps/functions/src/app.module.ts
import { Module } from '@nestjs/common';
import { AuthModule } from './auth/auth.module';
import { SchedulingModule } from './scheduling/scheduling.module';
import { DataManagementModule } from './data-management/data-management.module'; // Importar nuevo m贸dulo

@Module({
  imports: [
    AuthModule,
    SchedulingModule,
    DataManagementModule, // Incluir el m贸dulo de gesti贸n de datos
  ],
  controllers: [],
  providers: [],
})
export class AppModule {}

================================================================================
FILE: apps\functions\src\auth\auth.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { AuthService } from './auth.service';

/**
 * @module AuthModule
 * @description M贸dulo encargado de la creaci贸n de usuarios, asignaci贸n de roles (Custom Claims)
 * y gesti贸n de perfiles en la colecci贸n 'empleados'.
 */
@Module({
  imports: [],
  providers: [AuthService],
  exports: [AuthService], // Exportamos el servicio para que otros m贸dulos lo utilicen.
})
export class AuthModule {}

================================================================================
FILE: apps\functions\src\auth\auth.service.ts
================================================================================
import { Injectable, InternalServerErrorException, ConflictException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IEmployee } from '../common/interfaces/employee.interface';

const EMPLOYEES_COLLECTION = 'empleados';

@Injectable()
export class AuthService {

  //  Inicializaci贸n diferida (Lazy Loading)
  private getAuth = () => admin.app().auth();
  private getDb = () => admin.app().firestore();

  async createEmployeeProfile(
    email: string,
    password: string,
    role: IEmployee['role'],
    name: string,
    //  Nuevo argumento: Datos extendidos del perfil
    profileData: { clientId: string, dni: string, fileNumber: string, address: string }
  ): Promise<IEmployee> {
    
    const authInstance = this.getAuth();

    // 1. Crear usuario en Auth
    const user = await authInstance.createUser({
      email,
      password,
      displayName: name,
      emailVerified: true,
    }).catch(error => {
      if (error.code === 'auth/email-already-exists') {
        throw new ConflictException('La direcci贸n de correo ya est谩 en uso.');
      }
      console.error('[AUTH_CREATE_ERROR]', error.message);
      throw new InternalServerErrorException('Error al crear usuario en Firebase Auth.');
    });

    const employeeUid = user.uid;

    // 2. Asignar Custom Claims (Rol)
    try {
      await authInstance.setCustomUserClaims(employeeUid, { role });
    } catch (error) {
      console.error(`[CLAIMS_ERROR] Failed to set claims.`, error);
      await authInstance.deleteUser(employeeUid); // Rollback
      throw new InternalServerErrorException('Error al asignar rol. Creaci贸n abortada.');
    }
    
    // 3. Crear Perfil en Firestore con los NUEVOS CAMPOS
    const employeeProfile: IEmployee = {
      uid: employeeUid,
      email: email,
      name: name,
      role: role,
      isAvailable: true,
      maxHoursPerMonth: 176,        // Valor est谩ndar
      contractType: 'FullTime',     // Valor est谩ndar
      //  Mapeo de campos extendidos
      clientId: profileData.clientId,
      dni: profileData.dni,
      fileNumber: profileData.fileNumber,
      address: profileData.address
    };

    const dbInstance = this.getDb();
    
    try {
      await dbInstance.collection(EMPLOYEES_COLLECTION).doc(employeeUid).set(employeeProfile);
    } catch (error) {
      console.error(`[FIRESTORE_ERROR] Failed to create profile.`, error);
      await authInstance.deleteUser(employeeUid); // Rollback
      throw new InternalServerErrorException('Error al guardar perfil. Creaci贸n abortada.');
    }

    return employeeProfile;
  }
}

================================================================================
FILE: apps\functions\src\auth\guards\roles.guard.ts
================================================================================
// apps/functions/src/auth/guards/roles.guard.ts
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { IEmployee } from '../../common/interfaces/employee.interface'; //  RUTA FINAL: Retrocede 2 niveles
import 'reflect-metadata'; 

// ... (resto del c贸digo permanece igual)

// 1. Decorador para definir los roles requeridos
export const ROLES_KEY = 'roles';
export const Roles = (...roles: IEmployee['role'][]) => 
  (target: any, key?: any, descriptor?: any) => {
    // Uso corregido de Reflect (Soluci贸n TS2339)
    Reflect.defineMetadata(ROLES_KEY, roles, descriptor.value || target);
  };


@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const requiredRoles = this.reflector.get<IEmployee['role'][]>(
      ROLES_KEY,
      context.getHandler(),
    );

    if (!requiredRoles) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const userRole = request.context?.auth?.token?.role;

    if (!userRole) {
        return false;
    }

    return requiredRoles.some((role) => role === userRole);
  }
}

================================================================================
FILE: apps\functions\src\common\interfaces\absence.interface.ts
================================================================================
import * as admin from 'firebase-admin';

export type AbsenceType = 'VACATION' | 'SICK_LEAVE' | 'OTHER';

export interface IAbsence {
  id: string;
  employeeId: string;
  employeeName: string; //  Campo necesario para la UI
  clientId: string;
  type: AbsenceType;
  startDate: admin.firestore.Timestamp;
  endDate: admin.firestore.Timestamp;
  reason: string;
  status: 'PENDING' | 'APPROVED' | 'REJECTED';
  createdAt: admin.firestore.Timestamp;
}

//  ESTA EXPORTACIN ES CRTICA PARA EL SERVICIO
export interface IAbsencePayload {
  employeeId: string;
  employeeName: string;
  clientId: string;
  type: AbsenceType;
  // Flexible para aceptar Dates del frontend o Timestamps internos
  startDate: admin.firestore.Timestamp | Date;
  endDate: admin.firestore.Timestamp | Date;
  reason: string;
}

================================================================================
FILE: apps\functions\src\common\interfaces\api.interface.ts
================================================================================
// api.interface.ts (Ejemplo de respuesta estandarizada de API Gateway/Backend)
export interface IApiResponse<T> {
  success: boolean;
  data: T;
  message?: string;
}

// employee.interface.ts (Aseguramos la interfaz de IEmployee)
export interface IEmployee {
  uid: string;
  name: string;
  role: string;
  // A帽adir cualquier otro campo relevante (ej: maxHoursPerMonth, email)
}

================================================================================
FILE: apps\functions\src\common\interfaces\client.interface.ts
================================================================================
import * as admin from 'firebase-admin';

/**
 * @interface IClient
 * @description La empresa o entidad que contrata nuestros servicios de seguridad/personal.
 * Es la entidad ra铆z de la jerarqu铆a comercial.
 */
export interface IClient {
  id: string;
  /** Raz贸n Social o Nombre Comercial */
  businessName: string; 
  /** Identificaci贸n Fiscal (CUIT/RUT/NIT) */
  cuit: string;         
  /** Nombre del contacto principal */
  contactName: string;
  /** Email del contacto para notificaciones autom谩ticas */
  contactEmail: string;
  /** Estado administrativo del cliente */
  status: 'Active' | 'Inactive' | 'Suspended';
  /** Fecha de alta en el sistema */
  createdAt: admin.firestore.Timestamp;
}

/**
 * @interface IObjective
 * @description El lugar f铆sico, sucursal o puesto donde se presta el servicio.
 * Pertenece a un Cliente.
 */
export interface IObjective {
  id: string;
  /** ID del Cliente al que pertenece (Foreign Key) */
  clientId: string; 
  /** Nombre del objetivo (Ej: "Planta Industrial Pilar") */
  name: string;     
  /** Direcci贸n f铆sica real */
  address: string;
  /** Coordenadas para el Geofencing (Check-in/out) */
  location: {
    latitude: number;
    longitude: number;
  };
  /** Zonas internas (opcional). Ej: ["Garita 1", "Recepci贸n", "Ronda"] */
  zones?: string[]; 
}

/**
 * @interface IServiceContract
 * @description Define el acuerdo de nivel de servicio (SLA) para un Objetivo.
 * Establece cu谩ntas horas se vendieron y en qu茅 per铆odo.
 */
export interface IServiceContract {
  id: string;
  /** ID del Objetivo asociado (Foreign Key) */
  objectiveId: string; 
  /** Nombre del servicio (Ej: "Seguridad 24x7 - 2025") */
  name: string;        
  startDate: admin.firestore.Timestamp;
  endDate?: admin.firestore.Timestamp; // Opcional si es indeterminado
  /** Objetivo de venta mensual en horas (para reportes de rentabilidad) */
  totalHoursPerMonth: number; 
  isActive: boolean;
}

/**
 * @interface IShiftType (Modalidad)
 * @description Plantilla de turno para agilizar la planificaci贸n.
 * Define los "moldes" que se arrastrar谩n al calendario.
 */
export interface IShiftType {
  id: string;
  /** ID del Contrato al que pertenece esta modalidad (Foreign Key) */
  contractId: string; 
  /** Nombre descriptivo (Ej: "Turno Tarde 8hs") */
  name: string;       
  /** C贸digo corto para visualizaci贸n en calendario (Ej: "T8") */
  code: string;       
  /** Color hexadecimal para diferenciar en el calendario (Ej: "#FF5733") */
  color: string;      
  
  // Configuraci贸n del Horario Base
  /** Hora de inicio sugerida en formato "HH:mm" (Ej: "14:00") */
  startTime: string;     
  /** Duraci贸n en horas para c谩lculo de costos (Ej: 8) */
  durationHours: number; 
  
  /** Requisitos espec铆ficos (Opcional). Ej: "Vigilador Armado", "Chofer" */
  requiredRole?: string; 
}

================================================================================
FILE: apps\functions\src\common\interfaces\employee.interface.ts
================================================================================
import * as admin from 'firebase-admin'; //  SDK SERVIDOR

/**
 * @description Define los roles de usuario dentro del sistema.
 */
export type EmployeeRole = 'admin' | 'employee';

/**
 * @description Define los tipos de contrato laboral soportados.
 */
export type ContractType = 'FullTime' | 'PartTime' | 'Eventual';

/**
 * @description Interfaz de Colaborador (Versi贸n Backend).
 * Se utiliza para validar datos y tipar retornos en Cloud Functions.
 */
export interface IEmployee {
  uid: string;
  name: string;
  role: EmployeeRole;
  email: string;
  
  isAvailable: boolean;
  maxHoursPerMonth: number;
  contractType: ContractType;

  //  CAMBIO ARQUITECTNICO: Pool de Recursos
  clientId?: string;       // Opcional en el backend
  businessUnitId?: string; // Nuevo campo para multi-tenancy

  dni: string;        
  fileNumber: string;
  address: string;    
  phone?: string;     
}

/**
 * @description Estructura de una ausencia en base de datos.
 * Usa admin.firestore.Timestamp para compatibilidad con Node.js.
 */
export interface IAbsence {
    id: string;
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    startDate: admin.firestore.Timestamp; 
    endDate: admin.firestore.Timestamp;
    reason: string;
    status: 'PENDING' | 'APPROVED' | 'REJECTED';
    createdAt: admin.firestore.Timestamp;
}

/**
 * @description Payload recibido en las Cloud Functions.
 * Puede recibir Dates o Timestamps serializados, por lo que es flexible.
 */
export interface IAbsencePayload {
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    // Flexible para aceptar lo que env铆e el front (Date, string ISO o Timestamp)
    startDate: admin.firestore.Timestamp | Date | string; 
    endDate: admin.firestore.Timestamp | Date | string;
    reason: string;
}

================================================================================
FILE: apps\functions\src\common\interfaces\service-pattern.interface.ts
================================================================================
import * as admin from 'firebase-admin';

/**
 * @interface IServicePattern (El "Molde" Inteligente)
 * @description Define una regla de recurrencia para generar turnos autom谩ticamente.
 * Ej: "Necesito 2 Vigiladores (Turno Noche) todos los Lunes, Mi茅rcoles y Viernes".
 */
export interface IServicePattern {
  id: string;
  contractId: string;      // Vinculado al contrato "Seguridad Planta 2025"
  shiftTypeId: string;     // Usa la modalidad "Turno Noche 12hs"
  
  // Configuraci贸n de Recurrencia
  // 0=Dom, 1=Lun, ..., 6=Sab. Ej: [1,2,3,4,5] para Lun-Vie.
  daysOfWeek: number[];    
  
  // Cantidad de recursos requeridos simult谩neamente
  quantityPerDay: number;  
  
  // Vigencia de la regla
  validFrom: admin.firestore.Timestamp;
  validTo?: admin.firestore.Timestamp; // Si es null, es indefinido
  
  // Metadatos
  createdAt: admin.firestore.Timestamp;
  createdBy: string; // UID del planificador
  active: boolean;
}

/**
 * Payload para crear/editar un patr贸n desde el Frontend.
 * Usamos strings para las fechas para evitar problemas de serializaci贸n.
 */
export interface IPatternPayload {
  contractId: string;
  shiftTypeId: string;
  daysOfWeek: number[];
  quantity: number;
  validFrom: string; // ISO String
  validTo?: string;  // ISO String
}

================================================================================
FILE: apps\functions\src\common\interfaces\shift.interface.ts
================================================================================
import * as admin from 'firebase-admin';

export interface IShift {
  id: string;
  employeeId: string;
  employeeName: string;
  objectiveId: string;
  objectiveName: string;
  
  startTime: admin.firestore.Timestamp; 
  endTime: admin.firestore.Timestamp;
  
  status: 'Assigned' | 'Confirmed' | 'InProgress' | 'Completed' | 'Canceled';
  
  checkInTime?: admin.firestore.Timestamp;
  checkOutTime?: admin.firestore.Timestamp;
  
  schedulerId: string;
  updatedAt: admin.firestore.Timestamp;
  
  //  FIX: Agregamos el campo role para evitar el error en el servicio
  role?: string; 
}

================================================================================
FILE: apps\functions\src\common\interfaces\system-user.interface.ts
================================================================================
import * as admin from 'firebase-admin'; //  SDK SERVIDOR

/**
 * Roles Jer谩rquicos del Sistema (RBAC):
 * - SuperAdmin: IT / Due帽o del SaaS. Ve todas las unidades.
 * - Manager: Gerente de Unidad. Ve todo dentro de su unidad.
 * - Scheduler: Planificador. Gestiona turnos y asignaciones.
 * - Supervisor: Campo. Gestiona incidencias y personal.
 * - Operator: Monitoreo. Solo lectura o vista de tablero en vivo.
 */
export type SystemRole = 
  | 'SuperAdmin' 
  | 'Manager' 
  | 'Scheduler' 
  | 'Supervisor' 
  | 'Operator';

/**
 * @interface ISystemUser
 * @description Usuario administrativo con acceso al Panel de Control (Back-Office).
 * Se almacena en la colecci贸n 'system_users'.
 */
export interface ISystemUser {
  uid: string;
  email: string;
  displayName: string;
  role: SystemRole;
  
  // ID de la Unidad de Negocio a la que pertenece
  // Si es undefined y el rol es SuperAdmin, tiene acceso global.
  businessUnitId?: string; 
  
  status: 'Active' | 'Inactive';
  
  //  IMPORTANTE: En el backend usamos el namespace de admin para Timestamps
  createdAt: admin.firestore.Timestamp;
  lastLogin?: admin.firestore.Timestamp;
}

================================================================================
FILE: apps\functions\src\data-management\absence.interface.ts
================================================================================
import * as admin from 'firebase-admin';

/**
 * Estructura de la entidad Ausencia almacenada en Firestore.
 */
export interface IAbsence {
    id: string; 
    employeeId: string;
    employeeName: string;
    clientId: string; 
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER'; 
    startDate: admin.firestore.Timestamp; 
    endDate: admin.firestore.Timestamp; 
    reason: string; 
    status: 'PENDING' | 'APPROVED' | 'REJECTED'; 
    createdAt: admin.firestore.Timestamp;
}

/**
 * Payload recibido del Frontend.
 *  ES CRTICO QUE ESTA INTERFAZ TENGA 'export' PARA QUE EL SERVICIO LA VEA.
 */
export interface IAbsencePayload {
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    // Flexible: Timestamp (si viene de otro servicio) o Date (si viene de JSON serializado)
    startDate: admin.firestore.Timestamp | Date; 
    endDate: admin.firestore.Timestamp | Date;
    reason: string;
}

================================================================================
FILE: apps\functions\src\data-management\absence.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { WorkloadService } from '../scheduling/workload.service';
import { IAbsence, IAbsencePayload } from '../common/interfaces/absence.interface';

@Injectable()
export class AbsenceService {
    private getDb = () => admin.app().firestore();
    private readonly absencesCollection = 'ausencias'; 
    private readonly shiftsCollection = 'turnos';
    
    constructor(private readonly workloadService: WorkloadService) {}

    async createAbsence(payload: IAbsencePayload): Promise<IAbsence> {
        // 1. Parsing de fechas (Robustez)
        const parseDate = (input: any): Date => {
            if (typeof input === 'string') return new Date(input);
            if (input && input.seconds) return new Date(input.seconds * 1000);
            return new Date(input);
        };

        const startDateObj = parseDate(payload.startDate);
        const endDateObj = parseDate(payload.endDate);

        if (isNaN(startDateObj.getTime()) || isNaN(endDateObj.getTime())) {
            throw new Error('Fechas inv谩lidas recibidas en el backend.');
        }

        // 2. DETECCIN DE CONFLICTOS (Turnos afectados)
        const conflictingShifts = await this.workloadService.checkShiftOverlap(
            payload.employeeId,
            startDateObj, 
            endDateObj    
        );

        const db = this.getDb();
        const batch = db.batch(); // Preparamos un lote de operaciones at贸micas

        //  LGICA DE NEGOCIO CORREGIDA:
        // Si hay turnos en el medio, NO bloqueamos. Los cancelamos/liberamos.
        if (conflictingShifts.length > 0) {
            console.log(`[AbsenceService] Se encontraron ${conflictingShifts.length} turnos afectados. Procesando bajas...`);
            
            conflictingShifts.forEach(shift => {
                const shiftRef = db.collection(this.shiftsCollection).doc(shift.id);
                
                // Opci贸n: Cancelamos el turno para que el Admin vea que "se cay贸" y deba reasignar
                batch.update(shiftRef, {
                    status: 'Canceled',
                    // Agregamos metadata para auditor铆a
                    description: `Cancelaci贸n autom谩tica por Ausencia: ${payload.reason}`,
                    updatedAt: admin.firestore.Timestamp.now()
                });
            });
        }

        // 3. Crear la Ausencia
        const startTimestamp = admin.firestore.Timestamp.fromDate(startDateObj);
        const endTimestamp = admin.firestore.Timestamp.fromDate(endDateObj);

        const newAbsence: any = { 
            employeeId: payload.employeeId,
            employeeName: payload.employeeName,
            clientId: payload.clientId,
            type: payload.type,
            startDate: startTimestamp,
            endDate: endTimestamp,     
            reason: payload.reason,
            status: 'APPROVED', 
            createdAt: admin.firestore.Timestamp.now(), 
            // Guardamos referencia de cu谩ntos turnos impact贸
            impactedShiftsCount: conflictingShifts.length 
        };

        // Agregamos la creaci贸n de ausencia al lote
        const newAbsenceRef = db.collection(this.absencesCollection).doc();
        batch.set(newAbsenceRef, newAbsence);

        // 4. Ejecutar todo junto (Atomicidad)
        await batch.commit();
        
        return { id: newAbsenceRef.id, ...newAbsence } as IAbsence;
    }
}

================================================================================
FILE: apps\functions\src\data-management\client.service.ts
================================================================================
import { Injectable, NotFoundException, InternalServerErrorException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { 
  IClient, 
  IObjective, 
  IServiceContract, 
  IShiftType 
} from '../common/interfaces/client.interface';

const COLL_CLIENTS = 'clientes';
const COLL_OBJECTIVES = 'objetivos';
const COLL_CONTRACTS = 'contratos_servicio';
const COLL_SHIFT_TYPES = 'tipos_turno';

@Injectable()
export class ClientService {

  private getDb = () => admin.app().firestore();

  // ==========================================
  // 1. GESTIN DE CLIENTES
  // ==========================================

  async createClient(data: Omit<IClient, 'id' | 'createdAt'>): Promise<IClient> {
    const db = this.getDb();
    const ref = db.collection(COLL_CLIENTS).doc();
    
    const newClient: IClient = {
      ...data,
      id: ref.id,
      createdAt: admin.firestore.Timestamp.now(),
    };
    await ref.set(newClient);
    return newClient;
  }

  async getClient(id: string): Promise<IClient> {
    const doc = await this.getDb().collection(COLL_CLIENTS).doc(id).get();
    if (!doc.exists) throw new NotFoundException('Cliente no encontrado');
    return { id: doc.id, ...doc.data() } as IClient;
  }

  async findAllClients(): Promise<IClient[]> {
    try {
      const snapshot = await this.getDb().collection(COLL_CLIENTS).get();
      if (snapshot.empty) return [];

      return snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
      } as IClient));
    } catch (error) {
      console.error('[ERROR_FIND_CLIENTS]', error);
      throw new InternalServerErrorException('Error al consultar clientes.');
    }
  }

  async updateClient(id: string, data: Partial<IClient>): Promise<void> {
    const ref = this.getDb().collection(COLL_CLIENTS).doc(id);
    const updateData = { ...data };
    delete (updateData as any).id;
    delete (updateData as any).createdAt;
    await ref.update(updateData);
  }

  async deleteClient(id: string): Promise<void> {
    await this.getDb().collection(COLL_CLIENTS).doc(id).delete();
  }

  // ==========================================
  // 2. GESTIN DE OBJETIVOS
  // ==========================================

  async createObjective(data: Omit<IObjective, 'id'>): Promise<IObjective> {
    await this.getClient(data.clientId); 
    const db = this.getDb();
    const ref = db.collection(COLL_OBJECTIVES).doc();
    const newObjective: IObjective = {
      ...data,
      id: ref.id,
    };
    await ref.set(newObjective);
    return newObjective;
  }

  async getObjectivesByClient(clientId: string): Promise<IObjective[]> {
    const snapshot = await this.getDb().collection(COLL_OBJECTIVES)
      .where('clientId', '==', clientId)
      .get();
    return snapshot.docs.map(d => ({ id: d.id, ...d.data() }) as IObjective);
  }

  //  NUEVO: Actualizar Objetivo
  async updateObjective(id: string, data: Partial<IObjective>): Promise<void> {
    const db = this.getDb();
    const updateData = { ...data };
    delete (updateData as any).id; 
    
    // Asegurar tipos num茅ricos en location
    if (updateData.location) {
        updateData.location.latitude = Number(updateData.location.latitude);
        updateData.location.longitude = Number(updateData.location.longitude);
    }

    await db.collection(COLL_OBJECTIVES).doc(id).update(updateData);
  }

  public async getClientById(clientId: string): Promise<IClient> {
      return this.getClient(clientId);
  }
  
  public async getObjectiveById(objectiveId: string): Promise<IObjective> {
      const doc = await this.getDb().collection(COLL_OBJECTIVES).doc(objectiveId).get();
      if (!doc.exists) {
          throw new NotFoundException(`Objective with ID ${objectiveId} not found.`);
      }
      return { id: doc.id, ...doc.data() } as IObjective;
  }

  // ==========================================
  // 3. GESTIN DE CONTRATOS (SERVICIOS)
  // ==========================================

  async createServiceContract(data: Omit<IServiceContract, 'id'>): Promise<IServiceContract> {
    const db = this.getDb();
    const ref = db.collection(COLL_CONTRACTS).doc();
    
    let startDate: admin.firestore.Timestamp;
    
    if (data.startDate instanceof admin.firestore.Timestamp) {
        startDate = data.startDate;
    } else if ((data.startDate as any)._seconds) {
        startDate = new admin.firestore.Timestamp((data.startDate as any)._seconds, (data.startDate as any)._nanoseconds);
    } else {
        startDate = admin.firestore.Timestamp.fromDate(new Date(data.startDate as any));
    }

    const newContract: IServiceContract = {
      ...data,
      id: ref.id,
      startDate: startDate,
    };
    await ref.set(newContract);
    return newContract;
  }

  //  NUEVO: Actualizar Contrato
  async updateServiceContract(id: string, data: Partial<IServiceContract>): Promise<void> {
    const db = this.getDb();
    const updateData = { ...data };
    delete (updateData as any).id; 
    await db.collection(COLL_CONTRACTS).doc(id).update(updateData);
  }

  //  NUEVO: Eliminar Contrato
  async deleteServiceContract(id: string): Promise<void> {
    const db = this.getDb();
    await db.collection(COLL_CONTRACTS).doc(id).delete();
  }

  // ==========================================
  // 4. GESTIN DE MODALIDADES (TIPOS DE TURNO)
  // ==========================================

  async createShiftType(data: Omit<IShiftType, 'id'>): Promise<IShiftType> {
    const db = this.getDb();
    const ref = db.collection(COLL_SHIFT_TYPES).doc();

    const newType: IShiftType = {
      ...data,
      id: ref.id,
    };
    await ref.set(newType);
    return newType;
  }

  async getShiftTypesByContract(contractId: string): Promise<IShiftType[]> {
    const snapshot = await this.getDb().collection(COLL_SHIFT_TYPES)
      .where('contractId', '==', contractId)
      .get();
    return snapshot.docs.map(d => ({ id: d.id, ...d.data() }) as IShiftType);
  }

  //  NUEVO: Actualizar Modalidad
  async updateShiftType(id: string, data: Partial<IShiftType>): Promise<void> {
    const db = this.getDb();
    const updateData = { ...data };
    delete (updateData as any).id; 
    await db.collection(COLL_SHIFT_TYPES).doc(id).update(updateData);
  }

  //  NUEVO: Eliminar Modalidad
  async deleteShiftType(id: string): Promise<void> {
    const db = this.getDb();
    await db.collection(COLL_SHIFT_TYPES).doc(id).delete();
  }
}

================================================================================
FILE: apps\functions\src\data-management\data-management.module.ts
================================================================================
import { Module, forwardRef } from '@nestjs/common';
import { DataManagementService } from './data-management.service';
import { ClientService } from './client.service';
import { EmployeeService } from './employee.service';
import { SystemUserService } from './system-user.service';
import { AbsenceService } from './absence.service';
// Importamos el m贸dulo de agendamiento
import { SchedulingModule } from '../scheduling/scheduling.module';

@Module({
  imports: [
    //  FIX: Usamos forwardRef para romper el ciclo con Scheduling
    forwardRef(() => SchedulingModule)
  ],
  providers: [
    DataManagementService,
    ClientService,
    EmployeeService,
    SystemUserService,
    AbsenceService
  ],
  exports: [
    DataManagementService,
    ClientService,
    EmployeeService,
    SystemUserService,
    AbsenceService
  ],
})
export class DataManagementModule {}

================================================================================
FILE: apps\functions\src\data-management\data-management.service.ts
================================================================================
import { Injectable, NotFoundException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IClient, IObjective } from '../common/interfaces/client.interface'; // RUTA RELATIVA FINAL
import { IShift } from '../common/interfaces/shift.interface'; // RUTA RELATIVA FINAL (Aunque IShift no se usa directamente aqu铆, la mantenemos si es necesario)

const CLIENTS_COLLECTION = 'clientes';
const OBJECTIVES_COLLECTION = 'objetivos';
//  ELIMINADO: const db = admin.firestore(); // Eliminado para resolver el error 'app/no-app'

/**
 * @class DataManagementService
 * @description Servicio CRUD para las entidades Cliente y Objetivo (P1). 
 */
@Injectable()
export class DataManagementService {
  
  //  FIX: Getter para asegurar que Firestore solo se accede despu茅s de initializeApp()
  private getDb = () => admin.app().firestore();

  // --- CRUD para Objetivos (Sucursales/Puestos) ---

  async createObjective(objectiveData: Omit<IObjective, 'id'>): Promise<IObjective> {
    const dbInstance = this.getDb();
    const newRef = dbInstance.collection(OBJECTIVES_COLLECTION).doc();
    const objective: IObjective = {
      ...objectiveData,
      id: newRef.id,
    };
    await newRef.set(objective);
    return objective;
  }

  async findAllObjectives(clientId?: string): Promise<IObjective[]> {
    const dbInstance = this.getDb();
    let query: admin.firestore.Query = dbInstance.collection(OBJECTIVES_COLLECTION);
    
    if (clientId) {
      query = query.where('clientId', '==', clientId);
    }

    const snapshot = await query.get();
    if (snapshot.empty) {
        return [];
    }

    return snapshot.docs.map(doc => doc.data() as IObjective);
  }
  
  // --- M茅todos de Lectura (Cr铆ticos para el Check-In) ---
  
  public async getClientById(clientId: string): Promise<IClient> {
      const dbInstance = this.getDb();
      const doc = await dbInstance.collection(CLIENTS_COLLECTION).doc(clientId).get();
      if (!doc.exists) {
          throw new NotFoundException(`Client with ID ${clientId} not found.`);
      }
      return doc.data() as IClient;
  }
  
  public async getObjectiveById(objectiveId: string): Promise<IObjective> {
      const dbInstance = this.getDb();
      const doc = await dbInstance.collection(OBJECTIVES_COLLECTION).doc(objectiveId).get();
      if (!doc.exists) {
          throw new NotFoundException(`Objective with ID ${objectiveId} not found.`);
      }
      return doc.data() as IObjective;
  }
}

================================================================================
FILE: apps\functions\src\data-management\employee.service.ts
================================================================================
import { Injectable, NotFoundException, InternalServerErrorException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IEmployee } from '../common/interfaces/employee.interface';

const COLL_EMPLOYEES = 'empleados';

@Injectable()
export class EmployeeService {

  // Inicializaci贸n diferida para evitar errores de 'app/no-app'
  private getDb = () => admin.app().firestore();
  private getAuth = () => admin.app().auth();

  /**
   * Obtiene todos los empleados. Si se provee clientId, filtra por esa empresa.
   */
  async findAllEmployees(clientId?: string): Promise<IEmployee[]> {
    try {
      let query: admin.firestore.Query = this.getDb().collection(COLL_EMPLOYEES);

      //  CORRECCIN: Filtrado din谩mico por Cliente
      if (clientId) {
        query = query.where('clientId', '==', clientId);
      }

      const snapshot = await query.get();
      return snapshot.docs.map(doc => doc.data() as IEmployee);
    } catch (error) {
      console.error('[GET_EMPLOYEES_ERROR]', error);
      throw new InternalServerErrorException('Error al obtener la lista de empleados.');
    }
  }

  /**
   * Actualiza los datos de un empleado (Ej: cambiar l铆mite de horas o rol).
   */
  async updateEmployee(uid: string, data: Partial<IEmployee>): Promise<void> {
    const db = this.getDb();
    const auth = this.getAuth();

    // 1. Actualizar en Firestore
    const ref = db.collection(COLL_EMPLOYEES).doc(uid);
    const doc = await ref.get();

    if (!doc.exists) {
        throw new NotFoundException('Empleado no encontrado.');
    }

    // Protegemos campos inmutables
    delete (data as any).uid;
    delete (data as any).email;

    await ref.update(data);

    // 2. Si cambi贸 el rol, actualizar Custom Claims en Auth
    if (data.role) {
        try {
            await auth.setCustomUserClaims(uid, { role: data.role });
        } catch (e) {
            console.error(`Error actualizando claims para ${uid}`, e);
            // No fallamos todo el proceso, pero logueamos el error
        }
    }
  }

  /**
   * Elimina un empleado (Firestore + Auth).
   */
  async deleteEmployee(uid: string): Promise<void> {
    try {
        // 1. Borrar de Auth (Impide nuevo login)
        await this.getAuth().deleteUser(uid);
        
        // 2. Borrar de Firestore
        await this.getDb().collection(COLL_EMPLOYEES).doc(uid).delete();
    } catch (error) {
        console.error('[DELETE_EMPLOYEE_ERROR]', error);
        throw new InternalServerErrorException('Error al eliminar el empleado.');
    }
  }
}

================================================================================
FILE: apps\functions\src\data-management\system-user.service.ts
================================================================================
import { Injectable, InternalServerErrorException, ConflictException, NotFoundException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { ISystemUser, SystemRole } from '../common/interfaces/system-user.interface';

const COLL_SYSTEM_USERS = 'system_users';

@Injectable()
export class SystemUserService {

  // Inicializaci贸n diferida
  private getAuth = () => admin.app().auth();
  private getDb = () => admin.app().firestore();

  /**
   * Crea un nuevo usuario administrativo.
   */
  async createSystemUser(data: { email: string, password: string, displayName: string, role: SystemRole }): Promise<ISystemUser> {
    const auth = this.getAuth();
    const db = this.getDb();

    // 1. Crear en Auth
    const userRecord = await auth.createUser({
      email: data.email,
      password: data.password,
      displayName: data.displayName,
      emailVerified: true,
    }).catch(error => {
      if (error.code === 'auth/email-already-exists') throw new ConflictException('El email ya est谩 registrado.');
      throw new InternalServerErrorException('Error al crear usuario en Auth.');
    });

    // 2. Asignar Claims (Rol)
    // Nota: Agregamos un claim 'type: admin' para diferenciarlo de empleados
    await auth.setCustomUserClaims(userRecord.uid, { role: data.role, type: 'system_user' });

    // 3. Crear Perfil en Firestore
    const newUser: ISystemUser = {
      uid: userRecord.uid,
      email: data.email,
      displayName: data.displayName,
      role: data.role,
      status: 'Active',
      createdAt: admin.firestore.Timestamp.now()
    };

    await db.collection(COLL_SYSTEM_USERS).doc(userRecord.uid).set(newUser);
    
    return newUser;
  }

  /**
   * Obtener todos los administradores.
   */
  async findAll(): Promise<ISystemUser[]> {
    const snapshot = await this.getDb().collection(COLL_SYSTEM_USERS).get();
    return snapshot.docs.map(doc => doc.data() as ISystemUser);
  }

  /**
   * Actualizar datos (Rol o Estado).
   */
  async updateSystemUser(uid: string, data: Partial<ISystemUser>): Promise<void> {
    const auth = this.getAuth();
    const db = this.getDb();

    // Si cambia el rol, actualizar Auth
    if (data.role) {
        await auth.setCustomUserClaims(uid, { role: data.role, type: 'system_user' });
    }

    // Si se desactiva, deshabilitar en Auth
    if (data.status) {
        await auth.updateUser(uid, { disabled: data.status === 'Inactive' });
    }

    // Actualizar Firestore
    const safeData = { ...data };
    delete (safeData as any).uid;
    delete (safeData as any).email; // No cambiamos email por aqu铆
    
    await db.collection(COLL_SYSTEM_USERS).doc(uid).update(safeData);
  }

  /**
   * Eliminar administrador.
   */
  async deleteSystemUser(uid: string): Promise<void> {
    await this.getAuth().deleteUser(uid);
    await this.getDb().collection(COLL_SYSTEM_USERS).doc(uid).delete();
  }
}

================================================================================
FILE: apps\functions\src\index.ts
================================================================================
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import { createNestApp } from './main';
import { INestApplicationContext } from '@nestjs/common';

// Servicios
import { SchedulingService } from './scheduling/scheduling.service';
import { AuthService } from './auth/auth.service';
import { DataManagementService } from './data-management/data-management.service';
import { AuditService } from './scheduling/audit.service';
import { ClientService } from './data-management/client.service';
import { EmployeeService } from './data-management/employee.service';
import { SystemUserService } from './data-management/system-user.service';
import { AbsenceService } from './data-management/absence.service';
import { PatternService } from './scheduling/pattern.service';

// Interfaces
import { EmployeeRole } from './common/interfaces/employee.interface';

// Inicializaci贸n
if (!admin.apps.length) {
  admin.initializeApp();
}

let nestApp: INestApplicationContext;

async function getService<T>(service: new (...args: any[]) => T): Promise<T> {
  if (!nestApp) {
    nestApp = await createNestApp();
  }
  return nestApp.get<T>(service); 
}

// Roles Administrativos
const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager', 'Manager', 'Operator', 'Supervisor'];
const ALLOWED_ROLES: EmployeeRole[] = ['admin', 'employee'];

// =========================================================
// 1. GESTIN DE USUARIOS (AUTH)
// =========================================================
export const createUser = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado. Rol insuficiente.');
  }

  try {
    const authService = await getService(AuthService);
    const { email, password, name, role: receivedRole, clientId, dni, fileNumber, address } = data;
    
    if (!ALLOWED_ROLES.includes(receivedRole as EmployeeRole)) {
       throw new functions.https.HttpsError('invalid-argument', 'Rol inv谩lido.');
    }

    const validRole = receivedRole as EmployeeRole;

    const newEmployee = await authService.createEmployeeProfile(
        email, 
        password, 
        validRole, 
        name,
        { clientId: clientId || '', dni, fileNumber, address }
    );
    return { success: true, uid: newEmployee.uid };
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[CREATE_USER_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', 'Error al crear usuario.');
  }
});

// =========================================================
// 2. MOTOR DE AGENDAMIENTO (CREAR TURNOS)
// =========================================================
export const scheduleShift = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado. Rol insuficiente.');
  }

  try {
    const schedulingService = await getService(SchedulingService);
    const result = await schedulingService.assignShift(data, callerAuth.token);
    return { success: true, shiftId: result.id };
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[SCHEDULE_SHIFT_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', `Error: ${err.message}`);
  }
});

// =========================================================
// 10. GESTIN DE TURNOS (EDITAR / ELIMINAR)
// =========================================================
export const manageShifts = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }

  const { action, payload } = data as { action: string, payload: any };

  try {
    const schedulingService = await getService(SchedulingService);

    switch (action) {
      case 'UPDATE_SHIFT':
        await schedulingService.updateShift(payload.id, payload.data);
        return { success: true, message: 'Turno actualizado.' };
      
      case 'DELETE_SHIFT':
        await schedulingService.deleteShift(payload.id);
        return { success: true, message: 'Turno eliminado.' };
      
      default:
        throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[SHIFT_ERROR] Action ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 3. AUDITORA (GEOFENCING & MANUAL OVERRIDE)
// =========================================================
export const auditShift = functions.https.onCall(async (data, context) => {
  if (!context.auth) throw new functions.https.HttpsError('unauthenticated', 'Requiere autenticaci贸n.');

  //  LEEMOS PARAMETROS EXTRA (isManualOverride)
  const { shiftId, action, coords, isManualOverride } = data;

  try {
    const auditService = await getService(AuditService);
    
    //  PASAMOS CONTEXTO DE SEGURIDAD (UID + ROL)
    const result = await auditService.auditShiftAction(
        shiftId, 
        action, 
        coords || null, 
        context.auth.uid,
        context.auth.token.role as string, // Rol del token
        isManualOverride || false          // Bandera manual
    );
    
    return { success: true, newStatus: result.status };
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[AUDIT_SHIFT_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 4. GESTIN DE DATOS BSICOS
// =========================================================
export const manageData = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }

  const { action, payload } = data;
  try {
    const dmService = await getService(DataManagementService);
    switch (action) {
      case 'CREATE_OBJECTIVE': return { success: true, data: await dmService.createObjective(payload) };
      case 'GET_ALL_OBJECTIVES': return { success: true, data: await dmService.findAllObjectives(payload?.clientId) };
      case 'GET_CLIENT_BY_ID': return { success: true, data: await dmService.getClientById(payload.clientId) };
      default: throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[DATA_MANAGEMENT_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 5. GESTIN DE JERARQUA COMERCIAL (CLIENTES, OBJETIVOS, SERVICIOS)
// =========================================================
export const manageHierarchy = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }
  
  const { action, payload } = data as { action: string, payload: any };

  try {
    const clientService = await getService(ClientService);

    switch (action) {
      // Clientes
      case 'CREATE_CLIENT': return { success: true, data: await clientService.createClient(payload) };
      case 'GET_CLIENT': return { success: true, data: await clientService.getClient(payload.id) };
      case 'GET_ALL_CLIENTS': return { success: true, data: await clientService.findAllClients() };
      case 'UPDATE_CLIENT': await clientService.updateClient(payload.id, payload.data); return { success: true, message: 'Cliente actualizado' };
      case 'DELETE_CLIENT': await clientService.deleteClient(payload.id); return { success: true, message: 'Cliente eliminado' };
      
      // Objetivos
      case 'CREATE_OBJECTIVE': return { success: true, data: await clientService.createObjective(payload) };
      case 'UPDATE_OBJECTIVE': 
          await clientService.updateObjective(payload.id, payload.data);
          return { success: true, message: 'Objetivo actualizado correctamente' };
      
      // Contratos (Servicios)
      case 'CREATE_CONTRACT': return { success: true, data: await clientService.createServiceContract(payload) };
      case 'UPDATE_CONTRACT': 
          await clientService.updateServiceContract(payload.id, payload.data);
          return { success: true, message: 'Servicio actualizado' };
      case 'DELETE_CONTRACT': 
          await clientService.deleteServiceContract(payload.id);
          return { success: true, message: 'Servicio eliminado' };

      // Modalidades (Tipos de Turno)
      case 'CREATE_SHIFT_TYPE': return { success: true, data: await clientService.createShiftType(payload) };
      case 'GET_SHIFT_TYPES': return { success: true, data: await clientService.getShiftTypesByContract(payload.contractId) };
      case 'UPDATE_SHIFT_TYPE': 
          await clientService.updateShiftType(payload.id, payload.data);
          return { success: true, message: 'Modalidad actualizada' };
      case 'DELETE_SHIFT_TYPE': 
          await clientService.deleteShiftType(payload.id);
          return { success: true, message: 'Modalidad eliminada' };
      
      default: throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[HIERARCHY_ERROR] Action ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    throw new functions.https.HttpsError('internal', `Error: ${err.message}`);
  }
});

// =========================================================
// 6. GESTIN DE EMPLEADOS (RRHH)
// =========================================================
export const manageEmployees = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }
  
  const { action, payload } = data as { action: string, payload: any };
  try {
    const employeeService = await getService(EmployeeService);
    switch (action) {
      case 'GET_ALL_EMPLOYEES':
        const employees = await employeeService.findAllEmployees(payload?.clientId);
        return { success: true, data: employees };
      case 'UPDATE_EMPLOYEE':
        await employeeService.updateEmployee(payload.uid, payload.data);
        return { success: true, message: 'Datos actualizados.' };
      case 'DELETE_EMPLOYEE':
        await employeeService.deleteEmployee(payload.uid);
        return { success: true, message: 'Empleado eliminado.' };
      default: throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[EMPLOYEE_ERROR] Action ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 7. GESTIN DE USUARIOS DEL SISTEMA (ADMINS)
// =========================================================
export const manageSystemUsers = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }
  
  const { action, payload } = data as { action: string, payload: any };

  try {
    const sysUserService = await getService(SystemUserService);

    switch (action) {
      case 'CREATE_USER':
         await sysUserService.createSystemUser(payload);
        return { success: true, message: 'Administrador creado exitosamente.' };
      case 'GET_ALL_USERS':
        const users = await sysUserService.findAll();
        return { success: true, data: users };
      case 'UPDATE_USER':
        await sysUserService.updateSystemUser(payload.uid, payload.data);
        return { success: true, message: 'Administrador actualizado.' };
      case 'DELETE_USER':
        await sysUserService.deleteSystemUser(payload.uid);
        return { success: true, message: 'Administrador eliminado.' };
      default:
        throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[SYS_USER_ERROR] ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 8. GESTIN DE NOVEDADES (AUSENCIAS)
// =========================================================
export const manageAbsences = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth) {
    throw new functions.https.HttpsError('unauthenticated', 'Requiere autenticaci贸n.');
  }

  const { action, payload } = data as { action: string, payload: any };

  const isAdmin = ADMIN_ROLES.includes(callerAuth.token.role as string);
  const isSelf = payload.employeeId === callerAuth.uid;

  if (!isAdmin && !(isSelf && action === 'CREATE_ABSENCE')) {
      throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }

  try {
    const absenceService = await getService(AbsenceService);

    switch (action) {
      case 'CREATE_ABSENCE':
        return { success: true, data: await absenceService.createAbsence(payload) };
      default:
        throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[ABSENCE_ERROR] Action ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    if (err.message.includes('Conflict')) {
        throw new functions.https.HttpsError('failed-precondition', err.message);
    }
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 11. GESTIN DE PATRONES DE SERVICIO (AUTOMATIZACIN) [NUEVO]
// =========================================================
export const managePatterns = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
      throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }

  const { action, payload } = data as { action: string, payload: any };

  try {
    const patternService = await getService(PatternService);

    switch(action) {
        case 'CREATE_PATTERN': return patternService.createPattern(payload, callerAuth.uid);
        case 'GET_PATTERNS': return patternService.getPatternsByContract(payload.contractId);
        case 'DELETE_PATTERN': await patternService.deletePattern(payload.id); return { success: true };
        case 'GENERATE_VACANCIES': 
            return patternService.generateVacancies(
                payload.contractId, 
                payload.month, 
                payload.year, 
                payload.objectiveId 
            );
        default: throw new functions.https.HttpsError('invalid-argument', 'Acci贸n inv谩lida');
    }
  } catch (error: any) {
      console.error(`[PATTERN_ERROR] Action ${action} failed:`, error.message);
      throw new functions.https.HttpsError('internal', error.message);
  }
});

// =========================================================
// 9. DIAGNSTICO DE SISTEMA (HEALTH CHECK)
// =========================================================
export const checkSystemHealth = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
      throw new functions.https.HttpsError('unauthenticated', 'Requiere autenticaci贸n.');
  }

  const start = Date.now();
  try {
    await admin.firestore().listCollections();
    const end = Date.now();

    return {
      status: 'ok',
      nodeVersion: process.version,
      database: {
        status: 'connected',
        latencyMs: end - start
      }
    };
  } catch (error: any) {
    console.error('[HEALTH_CHECK_ERROR]', error);
    return {
      status: 'error',
      nodeVersion: process.version,
      database: {
        status: 'disconnected',
        latencyMs: -1,
        error: error.message
      }
    };
  }
});

================================================================================
FILE: apps\functions\src\main.ts
================================================================================
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { INestApplicationContext } from '@nestjs/common';

/**
 * @async
 * @function createNestApp
 * @description Inicializa la aplicaci贸n NestJS y retorna el M贸dulo de Referencia.
 * @returns {Promise<INestApplicationContext>} El contexto de aplicaci贸n.
 */
export async function createNestApp(): Promise<INestApplicationContext> {
  // Usamos createApplicationContext para obtener el contexto de DI sin listener HTTP
  const app = await NestFactory.createApplicationContext(AppModule, { logger: false });
  
  await app.init();
  return app;
}

================================================================================
FILE: apps\functions\src\scheduling\audit.service.ts
================================================================================
import { Injectable, BadRequestException, ForbiddenException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { GeofencingService } from './geofencing.service';
import { DataManagementService } from '../data-management/data-management.service'; 
import { IShift } from '../common/interfaces/shift.interface';
import * as functions from 'firebase-functions';
import { IObjective } from '../common/interfaces/client.interface'; 

const SHIFTS_COLLECTION = 'turnos';

@Injectable()
export class AuditService {
  
  constructor(
    private readonly geofencingService: GeofencingService,
    private readonly dmService: DataManagementService,
  ) {}

  private getDb = () => admin.app().firestore();

  /**
   * Procesa el fichaje (Check-in/out) validando reglas de negocio, GPS y permisos.
   * Soporta modo "Manual Override" para operadores.
   */
  async auditShiftAction(
    shiftId: string,
    action: 'CHECK_IN' | 'CHECK_OUT',
    employeeCoords: { latitude: number, longitude: number } | null, // Puede ser null en manual
    actorUid: string,
    actorRole: string,          //  NUEVO: Rol de quien ejecuta
    isManualOverride: boolean   //  NUEVO: Bandera de fuerza mayor
  ): Promise<IShift> {
    
    const dbInstance = this.getDb();
    const shiftRef = dbInstance.collection(SHIFTS_COLLECTION).doc(shiftId);

    return dbInstance.runTransaction(async (transaction) => {
      const shiftDoc = await transaction.get(shiftRef);

      if (!shiftDoc.exists) {
        throw new BadRequestException('El turno no existe.');
      }

      const shift = shiftDoc.data() as IShift;
      
      // --- VALIDACIN DE PERMISOS ---
      const isOwner = shift.employeeId === actorUid;
      const isAdminOrOperator = ['admin', 'SuperAdmin', 'Manager', 'Operator', 'Scheduler', 'Supervisor'].includes(actorRole);

      // Si no es el due帽o y no es admin, fuera.
      if (!isOwner && !isAdminOrOperator) {
        throw new ForbiddenException('No tienes permiso para gestionar este turno.');
      }
      
      // --- REGLAS DE NEGOCIO ---
      const now = admin.firestore.Timestamp.now();

      if (!isManualOverride) {
          // MODO ESTNDAR (Empleado con Celular)
          
          // 1. Identidad: Solo el asignado puede fichar normal
          if (!isOwner) throw new ForbiddenException('Solo el empleado asignado puede fichar desde la app.');
          
          // 2. Tiempo (Anti-Anticipaci贸n)
          if (action === 'CHECK_IN') {
              const shiftStartMillis = shift.startTime.toMillis();
              const diffMinutes = (shiftStartMillis - now.toMillis()) / (1000 * 60);
              const TOLERANCE = 10; // minutos

              if (diffMinutes > TOLERANCE) {
                  throw new functions.https.HttpsError(
                      'failed-precondition', 
                      ` Muy temprano. Fichaje habilitado ${TOLERANCE} min antes.`
                  );
              }
          }

          // 3. Ubicaci贸n (Geofence)
          const objective = await this.dmService.getObjectiveById(shift.objectiveId) as IObjective; 
          
          // Validamos que vengan coordenadas
          if (!employeeCoords || !employeeCoords.latitude) {
               throw new functions.https.HttpsError('invalid-argument', 'Se requiere ubicaci贸n GPS.');
          }

          if (!this.geofencingService.isInGeofence(employeeCoords, objective.location)) {
            console.warn(`[GEOFENCE_FAIL] User ${actorUid} far from objective.`);
            throw new functions.https.HttpsError(
                'failed-precondition', 
                ' Est谩s demasiado lejos del objetivo. Ac茅rcate a la sede.'
            );
          }

      } else {
          // MODO MANUAL (Operador desde Torre de Control)
          
          // 1. Permisos: Solo admins
          if (!isAdminOrOperator) {
              throw new ForbiddenException('Solo supervisores pueden forzar el fichaje manual.');
          }
          
          console.log(`[MANUAL_OVERRIDE] Turno ${shiftId} forzado por ${actorUid} (${actorRole})`);
      }
      
      // --- TRANSICIN DE ESTADO ---
      let newStatus: IShift['status'];

      if (action === 'CHECK_IN') {
        // Permitimos re-fichar si estaba en Assigned, o corregir si hubo error
        if (shift.status !== 'Assigned' && !isManualOverride) {
            throw new BadRequestException(`Estado incorrecto para entrada: ${shift.status}`);
        }
        newStatus = 'InProgress';
        shift.checkInTime = now;

      } else if (action === 'CHECK_OUT') {
        if (shift.status !== 'InProgress' && !isManualOverride) {
            throw new BadRequestException(`El turno no est谩 en curso (Estado: ${shift.status})`);
        }
        newStatus = 'Completed';
        shift.checkOutTime = now;

      } else {
        throw new BadRequestException(`Acci贸n inv谩lida: ${action}`);
      }
      
      // --- ACTUALIZACIN ---
      const updateData: any = {
          status: newStatus,
          updatedAt: now,
          checkInTime: shift.checkInTime,
          checkOutTime: shift.checkOutTime
      };

      // Si fue manual, dejamos marca de auditor铆a
      if (isManualOverride) {
          updateData.isManualRecord = true;
          updateData.processedBy = actorUid; // Guardamos qui茅n lo forz贸
          updateData.manualReason = 'Operador Torre de Control';
      }

      transaction.update(shiftRef, updateData);

      return { ...shift, ...updateData };
    });
  }
}

================================================================================
FILE: apps\functions\src\scheduling\geofencing.service.ts
================================================================================
import { Injectable } from '@nestjs/common';

// Radio de la Tierra en kil贸metros (km)
const EARTH_RADIUS_KM = 6371;

// Radio de tolerancia: El empleado debe estar a menos de 100 metros del objetivo.
const GEOFENCE_RADIUS_KM = 0.1; // 100 metros

interface Coordinates {
  latitude: number;
  longitude: number;
}

/**
 * @class GeofencingService
 * @description L贸gica pura para el c谩lculo de distancia y verificaci贸n de Geofence (SRP/D5).
 */
@Injectable()
export class GeofencingService {

  /**
   * @function degreesToRadians
   * @description Convierte grados decimales a radianes.
   */
  private degreesToRadians(degrees: number): number {
    return degrees * (Math.PI / 180);
  }

  /**
   * @function calculateDistance
   * @description Calcula la distancia entre dos pares de coordenadas (F贸rmula del Haversine).
   * @returns {number} Distancia en kil贸metros.
   */
  public calculateDistance(p1: Coordinates, p2: Coordinates): number {
    const lat1 = this.degreesToRadians(p1.latitude);
    const lon1 = this.degreesToRadians(p1.longitude);
    const lat2 = this.degreesToRadians(p2.latitude);
    const lon2 = this.degreesToRadians(p2.longitude);

    const dLat = lat2 - lat1;
    const dLon = lon2 - lon1;

    // F贸rmula Haversine
    const a = 
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) * Math.sin(dLon / 2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return EARTH_RADIUS_KM * c; // Distancia en KM
  }

  /**
   * @function isInGeofence
   * @description Verifica si el punto del empleado est谩 dentro del radio del objetivo.
   * @param {Coordinates} employeeCoords - Coordenadas reportadas por el empleado.
   * @param {Coordinates} objectiveCoords - Coordenadas registradas del objetivo.
   * @returns {boolean} True si la distancia es menor al radio de tolerancia.
   */
  public isInGeofence(employeeCoords: Coordinates, objectiveCoords: Coordinates): boolean {
    const distance = this.calculateDistance(employeeCoords, objectiveCoords);
    return distance <= GEOFENCE_RADIUS_KM;
  }
}

================================================================================
FILE: apps\functions\src\scheduling\pattern.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IServicePattern, IPatternPayload } from '../common/interfaces/service-pattern.interface';
import { IShiftType } from '../common/interfaces/client.interface';

const PATTERNS_COLLECTION = 'patrones_servicio';
const SHIFTS_COLLECTION = 'turnos';
const SHIFT_TYPES_COLLECTION = 'tipos_turno';

@Injectable()
export class PatternService {
  
  private getDb = () => admin.app().firestore();

  // --- 1. GESTIN DE REGLAS (ABM) ---

  async createPattern(payload: IPatternPayload, userId: string): Promise<IServicePattern> {
    const db = this.getDb();
    const ref = db.collection(PATTERNS_COLLECTION).doc();
    
    // Convertimos fechas de string a Timestamp para Firestore
    const validFrom = admin.firestore.Timestamp.fromDate(new Date(payload.validFrom));
    const validTo = payload.validTo ? admin.firestore.Timestamp.fromDate(new Date(payload.validTo)) : undefined;

    const newPattern: IServicePattern = {
        id: ref.id,
        contractId: payload.contractId,
        shiftTypeId: payload.shiftTypeId,
        daysOfWeek: payload.daysOfWeek,
        quantityPerDay: payload.quantity,
        validFrom,
        validTo,
        active: true,
        createdAt: admin.firestore.Timestamp.now(),
        createdBy: userId
    };

    await ref.set(newPattern);
    return newPattern;
  }

  async getPatternsByContract(contractId: string): Promise<IServicePattern[]> {
      const snapshot = await this.getDb().collection(PATTERNS_COLLECTION)
        .where('contractId', '==', contractId)
        .where('active', '==', true)
        .get();
      return snapshot.docs.map(d => d.data() as IServicePattern);
  }

  async deletePattern(id: string): Promise<void> {
      await this.getDb().collection(PATTERNS_COLLECTION).doc(id).delete();
  }

  // --- 2. EL GENERADOR (LGICA AUTOMTICA) ---

  async generateVacancies(contractId: string, month: number, year: number, objectiveId: string): Promise<{ created: number, message: string }> {
    const db = this.getDb();
    
    // A. Buscar reglas (patrones) del contrato
    const patterns = await this.getPatternsByContract(contractId);
    if (patterns.length === 0) return { created: 0, message: 'No hay patrones definidos para este servicio.' };

    // B. Pre-cargar Tipos de Turno (Para saber horarios y duraci贸n)
    // Esto evita hacer una consulta por cada d铆a
    const shiftTypesMap = new Map<string, IShiftType>();
    const typesSnapshot = await db.collection(SHIFT_TYPES_COLLECTION).where('contractId', '==', contractId).get();
    
    typesSnapshot.forEach(doc => {
        shiftTypesMap.set(doc.id, { id: doc.id, ...doc.data() } as IShiftType);
    });

    // C. Definir el rango del mes solicitado
    // Nota: month viene 1-12, Date usa 0-11
    const startOfMonth = new Date(year, month - 1, 1); 
    const endOfMonth = new Date(year, month, 0); // El d铆a 0 del siguiente mes es el 煤ltimo de este
    
    const batch = db.batch();
    let count = 0;
    const MAX_BATCH_SIZE = 450; // Firestore limita a 500 ops por batch

    // D. Bucle: Recorrer d铆a por d铆a
    for (let d = new Date(startOfMonth); d <= endOfMonth; d.setDate(d.getDate() + 1)) {
        const currentDayOfWeek = d.getDay(); // 0=Dom ... 6=Sab
        
        for (const pattern of patterns) {
            // Validar si el patr贸n est谩 vigente en esta fecha
            const pStart = pattern.validFrom.toDate();
            // Normalizar a medianoche para comparar solo fechas
            pStart.setHours(0,0,0,0);
            const checkDate = new Date(d);
            checkDate.setHours(0,0,0,0);

            if (checkDate < pStart) continue;
            if (pattern.validTo) {
                const pEnd = pattern.validTo.toDate();
                pEnd.setHours(23,59,59,999);
                if (checkDate > pEnd) continue;
            }

            // Validar si toca trabajar este d铆a de la semana
            if (pattern.daysOfWeek.includes(currentDayOfWeek)) {
                
                const shiftType = shiftTypesMap.get(pattern.shiftTypeId);
                if (!shiftType) continue;

                // Crear N vacantes seg煤n la dotaci贸n requerida
                for (let i = 0; i < pattern.quantityPerDay; i++) {
                    const newShiftRef = db.collection(SHIFTS_COLLECTION).doc();
                    
                    // Calcular Horario Real (Fecha del bucle + Hora del Tipo)
                    // shiftType.startTime es "07:00"
                    const [h, m] = shiftType.startTime.split(':').map(Number);
                    
                    const start = new Date(d);
                    start.setHours(h, m, 0, 0);
                    
                    const end = new Date(start);
                    end.setHours(start.getHours() + shiftType.durationHours);

                    // E. Crear el Objeto Turno (Vacante)
                    const vacancy = {
                        id: newShiftRef.id,
                        employeeId: 'VACANTE', //  FLAG: Esto le dice al frontend que es gris
                        employeeName: 'VACANTE',
                        objectiveId: objectiveId,
                        objectiveName: 'Sede', // Idealmente buscar nombre real, pero Sede sirve
                        startTime: admin.firestore.Timestamp.fromDate(start),
                        endTime: admin.firestore.Timestamp.fromDate(end),
                        status: 'Assigned', // Estado v谩lido
                        shiftTypeId: shiftType.id,
                        role: shiftType.requiredRole || 'Vigilador',
                        schedulerId: 'SYSTEM_GENERATOR',
                        updatedAt: admin.firestore.Timestamp.now()
                    };

                    batch.set(newShiftRef, vacancy);
                    count++;

                    // Protecci贸n simple contra l铆mite de Batch
                    if (count >= MAX_BATCH_SIZE) break; 
                }
            }
        }
        if (count >= MAX_BATCH_SIZE) break;
    }

    if (count > 0) {
        await batch.commit();
    }

    return { 
        created: count, 
        message: count >= MAX_BATCH_SIZE 
            ? `L铆mite de lote alcanzado. Se generaron ${count} vacantes.` 
            : `隆xito! Se generaron ${count} turnos vacantes.` 
    };
  }
}

================================================================================
FILE: apps\functions\src\scheduling\scheduling.module.ts
================================================================================
import { Module, forwardRef } from '@nestjs/common';
import { SchedulingService } from './scheduling.service';
import { ShiftOverlapService } from './shift-overlap.service';
import { WorkloadService } from './workload.service';
import { AuditService } from './audit.service';
import { GeofencingService } from './geofencing.service';
// Importamos el m贸dulo de datos
import { DataManagementModule } from '../data-management/data-management.module';

@Module({
  imports: [
    //  FIX: Usamos forwardRef para romper el ciclo con DataManagement
    forwardRef(() => DataManagementModule)
  ],
  providers: [
    SchedulingService,
    ShiftOverlapService,
    WorkloadService,
    AuditService,      // Servicio de Auditor铆a (Fichaje)
    GeofencingService  // Dependencia de Auditor铆a
  ],
  exports: [
    SchedulingService,
    WorkloadService,
    AuditService       // Exportamos para que la API lo vea
  ],
})
export class SchedulingModule {}

================================================================================
FILE: apps\functions\src\scheduling\scheduling.service.ts
================================================================================
import { Injectable, BadRequestException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IShift } from '../common/interfaces/shift.interface';
import { ShiftOverlapService } from './shift-overlap.service';
import { WorkloadService } from './workload.service';
import * as functions from 'firebase-functions';

const SHIFTS_COLLECTION = 'turnos';

@Injectable()
export class SchedulingService {
  private getDb = () => admin.app().firestore();

  constructor(
    private readonly overlapService: ShiftOverlapService,
    private readonly workloadService: WorkloadService
  ) {}

  private convertToDate(input: any): Date {
    if (!input) throw new Error('Fecha inv谩lida.');
    if (typeof input.toDate === 'function') return input.toDate();
    if (input._seconds !== undefined) return new Date(input._seconds * 1000);
    if (input.seconds !== undefined) return new Date(input.seconds * 1000);
    return new Date(input);
  }

  async assignShift(shiftData: Partial<IShift>, userAuth: admin.auth.DecodedIdToken): Promise<IShift> {
    const dbInstance = this.getDb(); 
    const newShiftRef = dbInstance.collection(SHIFTS_COLLECTION).doc();

    if (!shiftData.startTime || !shiftData.endTime || !shiftData.employeeId || !shiftData.objectiveId) {
        throw new functions.https.HttpsError('invalid-argument', 'Faltan datos requeridos.');
    }
    
    let newStart: Date;
    let newEnd: Date;

    try {
        newStart = this.convertToDate(shiftData.startTime);
        newEnd = this.convertToDate(shiftData.endTime);
    } catch (e) { throw new functions.https.HttpsError('invalid-argument', 'Fecha inv谩lida.'); }
    
    const employeeId = shiftData.employeeId!;
    if (newStart.getTime() >= newEnd.getTime()) throw new BadRequestException('Horario inv谩lido.');

    try {
        await this.workloadService.validateAssignment(employeeId, newStart, newEnd);
    } catch (businessRuleError: any) {
        console.warn(`[BUSINESS_RULE] ${businessRuleError.message}`);
        throw new functions.https.HttpsError('failed-precondition', businessRuleError.message);
    }

    try {
      await dbInstance.runTransaction(async (transaction) => {
        const overlappingQuery = dbInstance.collection(SHIFTS_COLLECTION)
          .where('employeeId', '==', employeeId)
          .where('endTime', '>', newStart) 
          .limit(10); 

        const snapshot = await transaction.get(overlappingQuery);
        const hasOverlap = snapshot.docs.some(doc => {
            const data = doc.data();
            const existStart = this.convertToDate(data.startTime);
            const existEnd = this.convertToDate(data.endTime);
            return this.overlapService.isOverlap(existStart, existEnd, newStart, newEnd);
        });

        if (hasOverlap) throw new functions.https.HttpsError('already-exists', 'Solapamiento detectado.');
        
        const finalShift: IShift = {
          id: newShiftRef.id,
          employeeId,
          objectiveId: shiftData.objectiveId!,
          employeeName: shiftData.employeeName || 'S/D', 
          objectiveName: shiftData.objectiveName || 'S/D',
          startTime: admin.firestore.Timestamp.fromDate(newStart), 
          endTime: admin.firestore.Timestamp.fromDate(newEnd),
          status: 'Assigned',
          schedulerId: userAuth.uid,
          updatedAt: admin.firestore.Timestamp.now(),
          role: (shiftData as any).role || 'Vigilador' 
        };

        transaction.set(newShiftRef, finalShift);
        return finalShift.id; 
      });

      return { id: newShiftRef.id, ...shiftData } as IShift;
    } catch (error: any) {
        if (error instanceof functions.https.HttpsError) throw error;
        const msg = error.message || 'Error desconocido';
        if (msg.includes('LMITE') || msg.includes('BLOQUEO')) throw new functions.https.HttpsError('failed-precondition', msg);
        throw new functions.https.HttpsError('internal', msg);
    }
  }

  async updateShift(shiftId: string, updateData: Partial<IShift>): Promise<void> {
      const db = this.getDb();
      const shiftRef = db.collection(SHIFTS_COLLECTION).doc(shiftId);
      const safeUpdate = { ...updateData };
      delete (safeUpdate as any).id; 
      delete (safeUpdate as any).employeeId; 
      
      if (safeUpdate.startTime) safeUpdate.startTime = admin.firestore.Timestamp.fromDate(this.convertToDate(safeUpdate.startTime));
      if (safeUpdate.endTime) safeUpdate.endTime = admin.firestore.Timestamp.fromDate(this.convertToDate(safeUpdate.endTime));
      safeUpdate.updatedAt = admin.firestore.Timestamp.now();
      await shiftRef.update(safeUpdate);
  }

  async deleteShift(shiftId: string): Promise<void> {
      const db = this.getDb();
      await db.collection(SHIFTS_COLLECTION).doc(shiftId).delete();
  }
}

================================================================================
FILE: apps\functions\src\scheduling\shift-overlap.service.spec.ts
================================================================================
// D5: Unit Test que verifica la REGRA DE NEGOCIO m谩s importante.
import { ShiftOverlapService } from '../../src/scheduling/shift-overlap.service';

describe('ShiftOverlapService (Core Logic D5)', () => {
  let service: ShiftOverlapService;

  beforeEach(() => {
    service = new ShiftOverlapService();
  });

  // Turno base: De 10:00 a 14:00 (4 horas)
  const T_START = new Date('2025-11-20T10:00:00.000Z');
  const T_END = new Date('2025-11-20T14:00:00.000Z');

  // CASOS DE XITO (Solapamiento)
  it('should return TRUE if the new shift starts inside and ends outside the existing shift', () => {
    // Nuevo turno: 12:00 a 16:00
    const newStart = new Date('2025-11-20T12:00:00.000Z');
    const newEnd = new Date('2025-11-20T16:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });

  it('should return TRUE if the new shift is entirely contained within the existing shift', () => {
    // Nuevo turno: 11:00 a 13:00
    const newStart = new Date('2025-11-20T11:00:00.000Z');
    const newEnd = new Date('2025-11-20T13:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });
  
  it('should return TRUE if the new shift starts before and ends inside the existing shift', () => {
    // Nuevo turno: 09:00 a 11:00
    const newStart = new Date('2025-11-20T09:00:00.000Z');
    const newEnd = new Date('2025-11-20T11:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });

  // CASOS DE FRACASO (No Solapamiento)
  it('should return FALSE if the new shift is adjacent (starts exactly when the other ends)', () => {
    // Nuevo turno: 14:00 a 18:00
    const newStart = new Date('2025-11-20T14:00:00.000Z');
    const newEnd = new Date('2025-11-20T18:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift ends exactly when the other starts', () => {
    // Nuevo turno: 06:00 a 10:00
    const newStart = new Date('2025-11-20T06:00:00.000Z');
    const newEnd = new Date('2025-11-20T10:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift is completely outside the range', () => {
    // Nuevo turno: 07:00 a 09:00
    const newStart = new Date('2025-11-20T07:00:00.000Z');
    const newEnd = new Date('2025-11-20T09:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });
});

================================================================================
FILE: apps\functions\src\scheduling\shift-overlap.service.ts
================================================================================
import { Injectable } from '@nestjs/common';

/**
 * @class ShiftOverlapService
 * @description Servicio que encapsula la l贸gica pura (matem谩tica) para determinar
 * si dos rangos de tiempo se cruzan. Cumple con SRP (SOLID).
 */
@Injectable()
export class ShiftOverlapService {

  /**
   * @function isOverlap
   * @description Verifica si un nuevo rango de tiempo se superpone con un rango existente.
   * La f贸rmula evita solapamiento si los turnos son adyacentes (ej: uno termina a las 14:00 y el otro empieza a las 14:00).
   * @param {Date} existingStart - Inicio del turno ya registrado.
   * @param {Date} existingEnd - Fin del turno ya registrado.
   * @param {Date} newStart - Inicio del nuevo turno.
   * @param {Date} newEnd - Fin del nuevo turno.
   * @returns {boolean} True si hay solapamiento.
   */
  public isOverlap(existingStart: Date, existingEnd: Date, newStart: Date, newEnd: Date): boolean {
    // Si el nuevo empieza antes de que el existente termine Y el nuevo termina despues de que el existente empiece, S hay solapamiento.
    return (
      newStart.getTime() < existingEnd.getTime() && 
      newEnd.getTime() > existingStart.getTime()
    );
  }
}

================================================================================
FILE: apps\functions\src\scheduling\workload.service.ts
================================================================================
import { Injectable, BadRequestException, ConflictException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IEmployee } from '../common/interfaces/employee.interface';
import { IAbsence } from '../common/interfaces/absence.interface';
import { IShift } from '../common/interfaces/shift.interface';

const EMPLOYEES_COLLECTION = 'empleados';
const ABSENCES_COLLECTION = 'ausencias';
const SHIFTS_COLLECTION = 'turnos';

@Injectable()
export class WorkloadService {
  private getDb = () => admin.app().firestore();

  async validateAssignment(employeeId: string, shiftStart: Date, shiftEnd: Date): Promise<void> {
    const db = this.getDb();
    const empDoc = await db.collection(EMPLOYEES_COLLECTION).doc(employeeId).get();
    
    if (!empDoc.exists) throw new BadRequestException('Employee not found');
    const employee = empDoc.data() as IEmployee;

    // 1. Solapamiento (Llama al m茅todo nuevo)
    const conflicts = await this.checkShiftOverlap(employeeId, shiftStart, shiftEnd);
    if (conflicts.length > 0) {
        throw new ConflictException('SOLAPAMIENTO DETECTADO: El empleado ya tiene un turno asignado en este per铆odo.');
    }

    // 2. Disponibilidad
    await this.checkAvailability(employeeId, shiftStart, shiftEnd);

    // 3. L铆mite Mensual
    await this.checkMonthlyLimit(employee, shiftStart, shiftEnd);
  }

  //  MTODO QUE FALTABA EN TU CDIGO
  async checkShiftOverlap(employeeId: string, start: Date, end: Date): Promise<IShift[]> {
    const db = this.getDb();
    const shiftsQuery = db.collection(SHIFTS_COLLECTION)
        .where('employeeId', '==', employeeId)
        .where('endTime', '>', start);

    const snapshot = await shiftsQuery.get();
    const conflictingShifts: IShift[] = [];

    snapshot.forEach(doc => {
        const shift = doc.data(); 
        const sStart = (shift.startTime as admin.firestore.Timestamp).toDate();
        
        if (sStart.getTime() < end.getTime()) {
             // Doble casting para evitar error de tipos
             conflictingShifts.push({ id: doc.id, ...shift } as unknown as IShift);
        }
    });
    return conflictingShifts;
  }

  private async checkAvailability(employeeId: string, start: Date, end: Date): Promise<void> {
    const db = this.getDb();
    const absencesSnapshot = await db.collection(ABSENCES_COLLECTION)
      .where('employeeId', '==', employeeId)
      .where('endDate', '>=', start)
      .get();

    absencesSnapshot.forEach(doc => {
      const absence = doc.data() as IAbsence;
      const absStart = (absence.startDate as unknown as admin.firestore.Timestamp).toDate();
      const absEnd = (absence.endDate as unknown as admin.firestore.Timestamp).toDate();

      if (start.getTime() < absEnd.getTime() && end.getTime() > absStart.getTime()) {
        throw new ConflictException(`BLOQUEO: El empleado est谩 ausente por: ${absence.type}`);
      }
    });
  }

  private async checkMonthlyLimit(employee: IEmployee, newShiftStart: Date, newShiftEnd: Date): Promise<void> {
    const db = this.getDb();
    const newDurationHours = (newShiftEnd.getTime() - newShiftStart.getTime()) / (1000 * 60 * 60);
    const startOfMonth = new Date(newShiftStart.getFullYear(), newShiftStart.getMonth(), 1);
    const endOfMonth = new Date(newShiftStart.getFullYear(), newShiftStart.getMonth() + 1, 0, 23, 59, 59);

    const shiftsSnapshot = await db.collection(SHIFTS_COLLECTION)
      .where('employeeId', '==', employee.uid)
      .where('startTime', '>=', startOfMonth)
      .where('startTime', '<=', endOfMonth)
      .get();

    let accumulatedHours = 0;
    shiftsSnapshot.forEach(doc => {
      const shift = doc.data();
      const sStart = (shift.startTime as admin.firestore.Timestamp).toDate();
      const sEnd = (shift.endTime as admin.firestore.Timestamp).toDate();
      const duration = (sEnd.getTime() - sStart.getTime()) / (1000 * 60 * 60);
      accumulatedHours += duration;
    });

    const totalProjected = accumulatedHours + newDurationHours;
    const maxHours = employee.maxHoursPerMonth || 176;

    if (totalProjected > maxHours) {
      throw new ConflictException(`LMITE EXCEDIDO: Acumulado(${accumulatedHours.toFixed(1)}h) + Nuevo supera el m谩ximo.`);
    }
  }
}

================================================================================
FILE: apps\functions\test\scheduling\shift-overlap.service.spec.js
================================================================================
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// D5: Unit Test que verifica la REGRA DE NEGOCIO m谩s importante.
const shift_overlap_service_1 = require("../../src/scheduling/shift-overlap.service");
describe('ShiftOverlapService (Core Logic D5)', () => {
    let service;
    beforeEach(() => {
        service = new shift_overlap_service_1.ShiftOverlapService();
    });
    // Turno base (existente): De 10:00 a 14:00 (4 horas)
    const T_START = new Date('2025-11-20T10:00:00.000Z');
    const T_END = new Date('2025-11-20T14:00:00.000Z');
    // =========================================================
    // ESCENARIO 2.2: PRUEBA DE SOLAPAMIENTO (DEBE FALLAR)
    // =========================================================
    it('should return TRUE if the new shift overlaps with the existing shift (Escenario 2.2)', () => {
        // Turno B: 11:00 AM a 01:00 PM (Completamente dentro)
        const newStart = new Date('2025-11-20T11:00:00.000Z');
        const newEnd = new Date('2025-11-20T13:00:00.000Z');
        // Si esta prueba pasa (TRUE), la Transacci贸n At贸mica ABORTAR.
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
    });
    // Turno que se superpone parcialmente (Escenario 2.2a)
    it('should return TRUE if the new shift starts inside and ends outside', () => {
        // Nuevo turno: 12:00 a 16:00
        const newStart = new Date('2025-11-20T12:00:00.000Z');
        const newEnd = new Date('2025-11-20T16:00:00.000Z');
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
    });
    // =========================================================
    // ESCENARIO 2.3: PRUEBA DE ADYACENCIA (DEBE PASAR)
    // =========================================================
    it('should return FALSE if the new shift is adjacent (starts exactly when the other ends - Escenario 2.3)', () => {
        // Turno C: 14:00 PM a 18:00 PM (Empieza justo donde termina A)
        const newStart = new Date('2025-11-20T14:00:00.000Z');
        const newEnd = new Date('2025-11-20T18:00:00.000Z');
        // Si esta prueba pasa (FALSE), la Transacci贸n At贸mica CONTINUAR.
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
    });
    it('should return FALSE if the new shift ends exactly when the other starts (Adyacente inverso)', () => {
        // Nuevo turno: 06:00 a 10:00
        const newStart = new Date('2025-11-20T06:00:00.000Z');
        const newEnd = new Date('2025-11-20T10:00:00.000Z');
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
    });
    it('should return FALSE if the new shift is completely outside the range', () => {
        // Nuevo turno: 07:00 a 09:00
        const newStart = new Date('2025-11-20T07:00:00.000Z');
        const newEnd = new Date('2025-11-20T09:00:00.000Z');
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
    });
});
//# sourceMappingURL=shift-overlap.service.spec.js.map

================================================================================
FILE: apps\functions\test\scheduling\shift-overlap.service.spec.ts
================================================================================
// D5: Unit Test que verifica la REGRA DE NEGOCIO m谩s importante.
import { ShiftOverlapService } from '../../src/scheduling/shift-overlap.service';

describe('ShiftOverlapService (Core Logic D5)', () => {
  let service: ShiftOverlapService;

  beforeEach(() => {
    service = new ShiftOverlapService();
  });

  // Turno base (existente): De 10:00 a 14:00 (4 horas)
  const T_START = new Date('2025-11-20T10:00:00.000Z');
  const T_END = new Date('2025-11-20T14:00:00.000Z');

  // =========================================================
  // ESCENARIO 2.2: PRUEBA DE SOLAPAMIENTO (DEBE FALLAR)
  // =========================================================
  it('should return TRUE if the new shift overlaps with the existing shift (Escenario 2.2)', () => {
    // Turno B: 11:00 AM a 01:00 PM (Completamente dentro)
    const newStart = new Date('2025-11-20T11:00:00.000Z');
    const newEnd = new Date('2025-11-20T13:00:00.000Z');
    
    // Si esta prueba pasa (TRUE), la Transacci贸n At贸mica ABORTAR.
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });

  // Turno que se superpone parcialmente (Escenario 2.2a)
  it('should return TRUE if the new shift starts inside and ends outside', () => {
    // Nuevo turno: 12:00 a 16:00
    const newStart = new Date('2025-11-20T12:00:00.000Z');
    const newEnd = new Date('2025-11-20T16:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });


  // =========================================================
  // ESCENARIO 2.3: PRUEBA DE ADYACENCIA (DEBE PASAR)
  // =========================================================
  it('should return FALSE if the new shift is adjacent (starts exactly when the other ends - Escenario 2.3)', () => {
    // Turno C: 14:00 PM a 18:00 PM (Empieza justo donde termina A)
    const newStart = new Date('2025-11-20T14:00:00.000Z');
    const newEnd = new Date('2025-11-20T18:00:00.000Z');
    
    // Si esta prueba pasa (FALSE), la Transacci贸n At贸mica CONTINUAR.
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift ends exactly when the other starts (Adyacente inverso)', () => {
    // Nuevo turno: 06:00 a 10:00
    const newStart = new Date('2025-11-20T06:00:00.000Z');
    const newEnd = new Date('2025-11-20T10:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift is completely outside the range', () => {
    // Nuevo turno: 07:00 a 09:00
    const newStart = new Date('2025-11-20T07:00:00.000Z');
    const newEnd = new Date('2025-11-20T09:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });
});

================================================================================
FILE: apps\functions\tsconfig.json
================================================================================
{
  "compilerOptions": {
    "module": "commonjs",
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "es2021",
    "sourceMap": true,
    "outDir": "./lib",
    "baseUrl": "./",
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": false,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "forceConsistentCasingInFileNames": false,
    "noFallthroughCasesInSwitch": false
  },
  "include": [
    "src/**/*"
  ],
  //  EXCLUIR TEST PARA EVITAR ERRORES DE COMPILACIN
  "exclude": [
    "node_modules",
    "dist",
    "lib",
    "**/*.spec.ts", 
    "test"
  ]
}

================================================================================
FILE: apps\web\jest.config.js
================================================================================
// jest.config.js en apps/web/

/** @type {import('ts-jest').JestConfigWithTsJest} */
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  moduleNameMapper: {
    //  CRTICO: Mapear el alias @/ a la carpeta src/
    '^@/(.*)$': '<rootDir>/src/$1', 
    // Mapear archivos CSS y est谩ticos para Jest
    '\\.(css|less|scss|sass)$': 'identity-obj-proxy',
  },
  setupFilesAfterEnv: ['<rootDir>/setupTests.js'], // Archivo para importar @testing-library/jest-dom
};

================================================================================
FILE: apps\web\next-env.d.ts
================================================================================
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/pages/api-reference/config/typescript for more information.


================================================================================
FILE: apps\web\next.config.ts
================================================================================
// Archivo: apps/web/next.config.ts

const path = require('path');

/** @type {import('next').NextConfig} */
const nextConfig = {
  //  FIX CRTICO: Genera la carpeta 'out' para Firebase Hosting
  output: 'export',
  
  //  Requerido para 'output: export': Desactiva la optimizaci贸n de im谩genes de servidor
  images: {
    unoptimized: true,
  },

  // Configuraci贸n experimental (limpia)
  experimental: {},
  
  // Configuraci贸n de Webpack para Alias (@/)
  webpack: (config: any, context: any) => { 
    config.resolve.alias['@'] = path.resolve(__dirname, 'src');
    return config;
  },
};

module.exports = nextConfig;

================================================================================
FILE: apps\web\package.json
================================================================================
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@fullcalendar/daygrid": "^6.1.19",
    "@fullcalendar/interaction": "^6.1.19",
    "@fullcalendar/react": "^6.1.19",
    "@fullcalendar/timegrid": "^6.1.19",
    "@react-google-maps/api": "^2.20.7",
    "firebase": "^12.6.0",
    "lucide-react": "^0.556.0",
    "next": "16.0.5",
    "react": "19.2.0",
    "react-dom": "19.2.0",
    "react-hot-toast": "^2.6.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.22",
    "eslint": "^9",
    "eslint-config-next": "16.0.5",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "typescript": "^5"
  }
}


================================================================================
FILE: apps\web\pages\admin\clients\index.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import DashboardLayout from '@/components/layout/DashboardLayout'; // FIX: Importaci贸n por defecto
import { ClientManagement } from '@/components/admin/client-management';

function ClientsListPage() {
    return (
        <DashboardLayout title="Gesti贸n de Clientes y Empresas">
            <ClientManagement />
        </DashboardLayout>
    );
}

export default withAuthGuard(ClientsListPage, ['admin', 'manager']);

================================================================================
FILE: apps\web\pages\admin\clients\new.tsx
================================================================================
// Archivo: pages/admin/clients/new.tsx

import React from 'react';
// Imports con alias @/
import { withAuthGuard } from '@/components/common/withAuthGuard';

//  FIX: Importamos DashboardLayout por defecto (SIN LLAVES)
import DashboardLayout from '@/components/layout/DashboardLayout'; 

// Importamos el componente Wizard que creamos antes
import { ClientSetupWizard } from '@/components/admin/client-setup-wizard';

/**
 * Componente de la p谩gina de alta de nuevos clientes y servicios.
 */
function NewClientPage() {
  return (
    <DashboardLayout title="Alta de Cliente y Servicio">
      <div className="py-6">
        {/* Renderizamos el asistente aqu铆 */}
        <ClientSetupWizard />
      </div>
    </DashboardLayout>
  );
}

// Protegemos la ruta solo para admins (usamos array para consistencia con withAuthGuard corregido)
export default withAuthGuard(NewClientPage, ['admin']);

================================================================================
FILE: apps\web\pages\admin\dashboard.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import DashboardLayout from '@/components/layout/DashboardLayout';
import { DragAndDropScheduler } from '@/components/admin/scheduler';
import { useClient } from '@/context/ClientContext';
import { callManageData } from '@/services/firebase-client.service';
import { IObjective } from '@/common/interfaces/client.interface';
import { 
    Users, Calendar, AlertCircle, 
    Clock, ChevronDown, MapPin 
} from 'lucide-react';

function PlanningStudioPage() {
    const { selectedClientId } = useClient();
    
    const [objectives, setObjectives] = useState<IObjective[]>([]);
    const [currentObjectiveId, setCurrentObjectiveId] = useState<string>('');
    const [viewMode, setViewMode] = useState<'timeline' | 'calendar'>('calendar');

    useEffect(() => {
        if (!selectedClientId) {
            setObjectives([]);
            setCurrentObjectiveId('');
            return;
        }
        const load = async () => {
            try {
                const res = await callManageData({ 
                    action: 'GET_ALL_OBJECTIVES', 
                    payload: { clientId: selectedClientId } 
                });
                const data = (res.data as any).data || [];
                setObjectives(data);
                
                if (data.length > 0) {
                    setCurrentObjectiveId(data[0].id);
                } else {
                    setCurrentObjectiveId('');
                }
            } catch (e) { 
                console.error(e); 
            }
        };
        load();
    }, [selectedClientId]);

    return (
        <DashboardLayout title="Planificaci贸n Operativa">
            <div className="flex flex-col h-[calc(100vh-140px)] gap-4">
                {/* COMMAND BAR */}
                <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 shrink-0">
                    {/* KPIs */}
                    <div className="flex gap-4 w-full md:w-auto overflow-x-auto pb-2 md:pb-0 no-scrollbar">
                        <div className="flex items-center gap-3 px-4 py-2 bg-red-50 border border-red-100 rounded-lg min-w-[150px]">
                            <div className="p-1.5 bg-red-100 text-red-600 rounded-full"><AlertCircle size={18} /></div>
                            <div><p className="text-[10px] text-red-600 font-bold uppercase">Conflictos</p><p className="text-lg font-bold text-slate-800 leading-none">-</p></div>
                        </div>
                        <div className="flex items-center gap-3 px-4 py-2 bg-blue-50 border border-blue-100 rounded-lg min-w-[150px]">
                            <div className="p-1.5 bg-blue-100 text-blue-600 rounded-full"><Clock size={18} /></div>
                            <div><p className="text-[10px] text-blue-600 font-bold uppercase">Horas</p><p className="text-lg font-bold text-slate-800 leading-none">-</p></div>
                        </div>
                    </div>

                    {/* Selector */}
                    <div className="flex items-center gap-2 w-full md:w-auto flex-1 justify-end">
                        <div className="relative w-full md:w-72">
                            <MapPin className="absolute left-3 top-1/2 -translate-y-1/2 text-indigo-500" size={18} />
                            <select 
                                className="w-full pl-10 pr-8 py-2.5 text-sm border border-indigo-200 bg-indigo-50/30 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700 appearance-none cursor-pointer hover:bg-indigo-50 transition"
                                value={currentObjectiveId}
                                onChange={(e) => setCurrentObjectiveId(e.target.value)}
                                disabled={objectives.length === 0}
                            >
                                {objectives.length === 0 
                                    ? <option value="">Sin objetivos registrados</option> 
                                    : objectives.map(o => <option key={o.id} value={o.id}>{o.name}</option>)
                                }
                            </select>
                            <ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size={16} />
                        </div>
                        
                        <div className="h-8 w-px bg-slate-200 mx-2 hidden md:block"></div>
                        
                        <div className="flex bg-slate-100 p-1 rounded-lg shrink-0">
                            <button onClick={() => setViewMode('calendar')} className={`p-1.5 rounded-md transition-all ${viewMode === 'calendar' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`} title="Vista Mensual"><Calendar size={18} /></button>
                            <button onClick={() => setViewMode('timeline')} className={`p-1.5 rounded-md transition-all ${viewMode === 'timeline' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400 hover:text-slate-600'}`} title="Vista Semanal"><Users size={18} /></button>
                        </div>
                    </div>
                </div>

                {/* WORKBENCH */}
                <div className="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden relative">
                    <DragAndDropScheduler 
                        objectiveId={currentObjectiveId} 
                        viewMode={viewMode} 
                    />
                </div>
            </div>
        </DashboardLayout>
    );
}

export default withAuthGuard(PlanningStudioPage, ['admin', 'scheduler', 'manager']);

================================================================================
FILE: apps\web\pages\admin\employees.tsx
================================================================================
// Archivo: pages/admin/employees.tsx

import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
//  FIX CRTICO: Importamos DashboardLayout por defecto (SIN LLAVES)
import DashboardLayout from '@/components/layout/DashboardLayout'; 
import { EmployeeManagement } from '@/components/admin/employee-management';

function EmployeesPage() {
    return (
        <DashboardLayout title="Gesti贸n de Personal">
            <EmployeeManagement />
        </DashboardLayout>
    );
}

// Exportaci贸n protegida (asumo roles de administraci贸n y RRHH)
export default withAuthGuard(EmployeesPage, ['admin', 'hr_manager']);

================================================================================
FILE: apps\web\pages\admin\objective-detail\[id].tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/router';
import { withAuthGuard } from '@/components/common/withAuthGuard'; 
import DashboardLayout from '@/components/layout/DashboardLayout';
import { useClient } from '@/context/ClientContext'; //  Contexto para lista de clientes
import { 
    getObjectiveControlData, 
    getObjectiveContracts, 
    createServiceForObjective,
    updateServiceContract, 
    deleteServiceContract, 
    callScheduleShift,      
    callManageEmployees,
    getShiftTypes,
    createShiftType,
    updateShiftType,
    deleteShiftType,
    updateObjective 
} from '@/services/firebase-client.service';
import { IObjective, IServiceContract, IShiftType } from '@/common/interfaces/client.interface';
import { IShift } from '@/common/interfaces/shift.interface';
import { IEmployee } from '@/common/interfaces/employee.interface';
import toast from 'react-hot-toast';
import { GeocodingSelector } from '@/components/admin/GeocodingSelector'; 
import { 
    LayoutDashboard, Settings, MapPin, AlertTriangle, 
    Plus, Trash2, Edit2, FileText, Users, CalendarDays, Clock 
} from 'lucide-react';

type TabView = 'operations' | 'config' | 'map';

function ObjectiveDetailPage() {
    const router = useRouter();
    const { id } = router.query;
    
    // Acceso a la lista global de clientes para el selector de edici贸n
    const { clients } = useClient(); 

    // Datos
    const [objective, setObjective] = useState<IObjective | null>(null);
    const [shifts, setShifts] = useState<IShift[]>([]);
    const [contracts, setContracts] = useState<IServiceContract[]>([]);
    const [employees, setEmployees] = useState<IEmployee[]>([]); 
    
    // UI
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState<TabView>('operations');
    
    // Modales
    const [showServiceModal, setShowServiceModal] = useState(false);
    const [editingContract, setEditingContract] = useState<IServiceContract | null>(null);
    const [showShiftModal, setShowShiftModal] = useState(false);
    const [showModalitiesModal, setShowModalitiesModal] = useState(false);
    const [showEditObjectiveModal, setShowEditObjectiveModal] = useState(false);
    const [showGeoSelector, setShowGeoSelector] = useState(false);

    // Forms
    //  FORMULARIO DE SERVICIO COMPLETO (Fechas, D铆as, Dotaci贸n)
    const [serviceForm, setServiceForm] = useState({ 
        name: '', 
        hours: 720, 
        isActive: true, 
        quantity: 1, 
        days: [0,1,2,3,4,5,6],
        startDate: '', 
        endDate: '' 
    });

    const [shiftForm, setShiftForm] = useState({ employeeId: '', start: '', end: '' });
    const [modalityForm, setModalityForm] = useState({ id: '', name: '', code: '', startTime: '07:00', durationHours: 12 });
    
    //  FORMULARIO EDITAR OBJETIVO
    const [editObjForm, setEditObjForm] = useState({ name: '', address: '', clientId: '', latitude: '', longitude: '' });

    const [selectedContractForModalities, setSelectedContractForModalities] = useState<IServiceContract | null>(null);
    const [contractShiftTypes, setContractShiftTypes] = useState<IShiftType[]>([]);
    const [isEditingModality, setIsEditingModality] = useState(false);

    // --- CARGA DE DATOS ---
    const loadData = async () => {
        if (!id) return;
        try {
            const [controlData, contractData] = await Promise.all([
                getObjectiveControlData(id as string),
                getObjectiveContracts(id as string)
            ]);
            setObjective(controlData.objective);
            setShifts(controlData.shifts);
            setContracts(contractData);
        } catch (error) { console.error(error); } finally { setLoading(false); }
    };

    const loadEmployees = async () => {
        try {
            const res = await callManageEmployees({ action: 'GET_ALL_EMPLOYEES', payload: {} });
            setEmployees((res.data as any).data || []);
        } catch (e) { console.error(e); }
    };

    useEffect(() => {
        loadData();
        loadEmployees();
        const interval = setInterval(loadData, 60000);
        return () => clearInterval(interval);
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [id]);

    // Helpers
    const getDateObj = (ts: any) => {
        if (!ts) return new Date();
        if (ts.toDate) return ts.toDate();
        if (ts instanceof Date) return ts;
        if (typeof ts === 'string') return new Date(ts);
        if (ts.seconds) return new Date(ts.seconds * 1000);
        return new Date();
    };
    const formatDate = (ts: any) => getDateObj(ts).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });

    const renderDaysBadges = (days: number[]) => {
        const week = ['D','L','M','M','J','V','S'];
        if (days.length === 7) return <span className="text-xs text-green-600 font-medium">Todos los d铆as (24x7)</span>;
        return (
            <div className="flex gap-0.5">
                {week.map((d, i) => (
                    <span key={i} className={`text-[9px] w-4 h-4 flex items-center justify-center rounded-sm ${days.includes(i) ? 'bg-indigo-100 text-indigo-700 font-bold' : 'bg-gray-50 text-gray-300'}`}>
                        {d}
                    </span>
                ))}
            </div>
        );
    };

    // KPIs
    const activeShifts = shifts.filter(s => s.status === 'InProgress');
    const upcomingShifts = shifts.filter(s => s.status === 'Assigned' && getDateObj(s.startTime) > new Date());
    const issueShifts = shifts.filter(s => s.status === 'Canceled' || (s.status === 'Assigned' && new Date() > getDateObj(s.startTime)));
    const hasAlerts = issueShifts.length > 0;

    // --- HANDLERS OBJETIVO (EDITAR) ---
    const handleOpenEditObjective = () => {
        if (!objective) return;
        setEditObjForm({
            name: objective.name,
            address: objective.address,
            clientId: objective.clientId, // Cargamos cliente actual
            latitude: String(objective.location.latitude),
            longitude: String(objective.location.longitude)
        });
        setShowEditObjectiveModal(true);
    };

    const handleSaveObjective = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!objective) return;
        const toastId = toast.loading("Actualizando...");
        try {
            await updateObjective(objective.id, {
                name: editObjForm.name,
                address: editObjForm.address,
                clientId: editObjForm.clientId, // Guardamos cliente seleccionado
                location: { latitude: parseFloat(editObjForm.latitude), longitude: parseFloat(editObjForm.longitude) }
            });
            toast.success("Sede actualizada", { id: toastId });
            setShowEditObjectiveModal(false);
            loadData();
        } catch (error: any) { toast.error(error.message, { id: toastId }); }
    };

    const handleGeoSelected = (lat: string, lng: string) => {
        setEditObjForm(prev => ({ ...prev, latitude: lat, longitude: lng }));
        setShowGeoSelector(false);
    };

    // --- HANDLERS SERVICIOS ---
    const handleSaveService = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!serviceForm.startDate) { toast.error("Fecha de inicio obligatoria"); return; }
        
        const toastId = toast.loading("Procesando...");
        try {
            const payload = {
                name: serviceForm.name,
                totalHours: serviceForm.hours,
                isActive: serviceForm.isActive,
                quantity: serviceForm.quantity,
                daysOfWeek: serviceForm.days,
                startDate: new Date(serviceForm.startDate).toISOString(),
                endDate: serviceForm.endDate ? new Date(serviceForm.endDate).toISOString() : undefined
            };

            if (editingContract) {
                await updateServiceContract(editingContract.id, payload);
                toast.success("Actualizado", { id: toastId });
            } else {
                await createServiceForObjective({ objectiveId: id as string, ...payload as any }); // as any por compatibilidad r谩pida
                toast.success("Creado", { id: toastId });
            }
            setShowServiceModal(false); setEditingContract(null); loadData();
        } catch (e: any) { toast.error(e.message, { id: toastId }); }
    };
    
    const handleDeleteService = async (contractId: string) => {
        if (!confirm("驴Eliminar servicio?")) return;
        try { await deleteServiceContract(contractId); toast.success("Eliminado"); loadData(); } catch (e: any) { toast.error(e.message); }
    };
    
    const openEditService = (c: IServiceContract) => {
        setEditingContract(c);
        const formatInput = (v: any) => v ? getDateObj(v).toISOString().split('T')[0] : '';
        setServiceForm({ 
            name: c.name, hours: c.totalHoursPerMonth, isActive: c.isActive,
            quantity: c.quantity || 1, days: c.daysOfWeek || [0,1,2,3,4,5,6],
            startDate: formatInput(c.startDate), endDate: formatInput(c.endDate)
        }); 
        setShowServiceModal(true); 
    };

    const openNewService = () => { 
        setEditingContract(null); 
        const today = new Date().toISOString().split('T')[0];
        setServiceForm({ name: '', hours: 720, isActive: true, quantity: 1, days: [0,1,2,3,4,5,6], startDate: today, endDate: '' }); 
        setShowServiceModal(true); 
    };

    // ... (Handlers Modalidades y Turnos se mantienen igual) ...
    const openModalitiesManager = async (contract: IServiceContract) => {
        setSelectedContractForModalities(contract);
        const types = await getShiftTypes(contract.id);
        setContractShiftTypes(types);
        setModalityForm({ id: '', name: '', code: '', startTime: '07:00', durationHours: 12 });
        setIsEditingModality(false);
        setShowModalitiesModal(true);
    };

    const handleSaveModality = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!selectedContractForModalities) return;
        const toastId = toast.loading("Guardando...");
        try {
            if (isEditingModality) {
                await updateShiftType(modalityForm.id, { ...modalityForm });
            } else {
                await createShiftType({ contractId: selectedContractForModalities.id, color: '#4F46E5', ...modalityForm });
            }
            const types = await getShiftTypes(selectedContractForModalities.id);
            setContractShiftTypes(types);
            toast.success("Guardado", { id: toastId });
            if (!isEditingModality) setModalityForm({ id: '', name: '', code: '', startTime: '07:00', durationHours: 12 });
            setIsEditingModality(false);
        } catch (e: any) { toast.error(e.message, { id: toastId }); }
    };

    const handleEditModality = (m: IShiftType) => {
        setModalityForm({ id: m.id, name: m.name, code: m.code, startTime: m.startTime, durationHours: m.durationHours });
        setIsEditingModality(true);
    };

    const handleDeleteModality = async (id: string) => {
        if (!confirm("驴Borrar?")) return;
        await deleteShiftType(id);
        if (selectedContractForModalities) {
            const types = await getShiftTypes(selectedContractForModalities.id);
            setContractShiftTypes(types);
        }
    };

    const handleCreateShift = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!objective) return;
        const emp = employees.find(e => e.uid === shiftForm.employeeId);
        if (!emp) return toast.error("Seleccione empleado");
        const toastId = toast.loading("Asignando...");
        try {
            await callScheduleShift({
                employeeId: emp.uid, employeeName: emp.name,
                objectiveId: objective.id, objectiveName: objective.name,
                startTime: new Date(shiftForm.start), endTime: new Date(shiftForm.end),
                status: 'Assigned'
            });
            toast.success("Turno creado", { id: toastId });
            setShowShiftModal(false); loadData();
        } catch (e: any) { toast.error(e.message, { id: toastId }); }
    };

    if (loading) return <DashboardLayout title="Cargando...">Loading...</DashboardLayout>;
    if (!objective) return <DashboardLayout title="Error">404 - Objetivo no encontrado</DashboardLayout>;

    return (
        <DashboardLayout title={`Torre: ${objective.name}`}>
            <div className="space-y-6">
                
                {/* Header */}
                <div className={`rounded-2xl p-6 text-white shadow-lg relative overflow-hidden transition-colors duration-500 ${hasAlerts ? 'bg-gradient-to-r from-red-600 to-rose-600' : 'bg-gradient-to-r from-slate-800 to-indigo-900'}`}>
                    <div className="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <div className="flex items-center gap-3 mb-1">
                                <h2 className="text-3xl font-bold">{objective.name}</h2>
                                <button onClick={handleOpenEditObjective} className="p-1.5 bg-white/20 rounded-lg hover:bg-white/30 transition border border-white/30" title="Editar Sede"><Edit2 size={18} /></button>
                                {hasAlerts && <span className="bg-white/20 px-2 py-0.5 rounded text-xs font-bold animate-pulse">ALERTA</span>}
                            </div>
                            <p className="text-white/80 flex items-center text-sm"><MapPin className="w-4 h-4 mr-1" /> {objective.address}</p>
                        </div>
                        <div className="flex gap-3">
                            <div className="bg-white/10 backdrop-blur-md rounded-lg p-3 text-center min-w-[100px]"><p className="text-xs text-white/70 font-bold uppercase">En Servicio</p><p className="text-2xl font-bold">{activeShifts.length}</p></div>
                            <div className="bg-white/10 backdrop-blur-md rounded-lg p-3 text-center min-w-[100px]"><p className="text-xs text-white/70 font-bold uppercase">Pendientes</p><p className="text-2xl font-bold">{upcomingShifts.length}</p></div>
                        </div>
                    </div>
                </div>

                {/* Tabs */}
                <div className="flex border-b border-gray-200">
                    <button onClick={() => setActiveTab('operations')} className={`px-6 py-3 border-b-2 flex gap-2 ${activeTab === 'operations' ? 'border-indigo-600 text-indigo-600' : 'border-transparent'}`}><LayoutDashboard size={18} /> Operaciones</button>
                    <button onClick={() => setActiveTab('config')} className={`px-6 py-3 border-b-2 flex gap-2 ${activeTab === 'config' ? 'border-indigo-600 text-indigo-600' : 'border-transparent'}`}><Settings size={18} /> Configuraci贸n</button>
                </div>

                {/* OPERATIONS */}
                {activeTab === 'operations' && (
                    <div className="space-y-6">
                        <div className="flex justify-end">
                            <button onClick={() => setShowShiftModal(true)} className="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-700 font-bold shadow-sm"><Plus size={18} /> Asignar Turno</button>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="px-5 py-3 border-b bg-green-50"><h3 className="font-bold text-green-800">En Servicio</h3></div>
                                <div className="divide-y">
                                    {activeShifts.length === 0 && <p className="p-4 text-center text-gray-400">Sin actividad.</p>}
                                    {activeShifts.map(s => <div key={s.id} className="p-4 flex justify-between"><span className="font-bold">{s.employeeName}</span><span className="font-mono text-green-700">{formatDate(s.checkInTime)}</span></div>)}
                                </div>
                            </div>
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="px-5 py-3 border-b bg-blue-50"><h3 className="font-bold text-blue-800">Pr贸ximos</h3></div>
                                <div className="divide-y">
                                    {upcomingShifts.length === 0 && <p className="p-4 text-center text-gray-400">Sin ingresos.</p>}
                                    {upcomingShifts.map(s => <div key={s.id} className="p-4 flex justify-between"><span className="font-medium">{s.employeeName}</span><span className="font-mono text-indigo-600">{formatDate(s.startTime)}</span></div>)}
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* CONFIG (SERVICIOS MEJORADO) */}
                {activeTab === 'config' && (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h3 className="text-lg font-bold">Servicios Contratados</h3>
                            <button onClick={openNewService} className="bg-indigo-600 text-white px-4 py-2 rounded-lg flex gap-2"><Plus size={18} /> Nuevo Servicio</button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {contracts.map(c => (
                                <div key={c.id} className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative group hover:shadow-md transition-all">
                                    <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onClick={() => openEditService(c)} className="text-gray-400 hover:text-indigo-600"><Edit2 size={16} /></button>
                                        <button onClick={() => handleDeleteService(c.id)} className="text-gray-400 hover:text-red-600"><Trash2 size={16} /></button>
                                    </div>
                                    <div className="flex items-center gap-3 mb-4">
                                        <div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><FileText size={20} /></div>
                                        <div>
                                            <h4 className="font-bold text-slate-800 leading-tight">{c.name}</h4>
                                            <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold ${c.isActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>{c.isActive ? 'ACTIVO' : 'INACTIVO'}</span>
                                        </div>
                                    </div>
                                    {/* Datos Operativos Nuevos */}
                                    <div className="space-y-2 text-sm text-slate-600 mb-4 bg-slate-50 p-3 rounded-lg">
                                        <div className="flex justify-between"><span className="flex items-center gap-2 text-xs uppercase font-bold text-slate-400"><Users size={14}/> Dotaci贸n</span><span className="font-bold">{c.quantity || 1} Pers.</span></div>
                                        <div className="flex justify-between"><span className="flex items-center gap-2 text-xs uppercase font-bold text-slate-400"><CalendarDays size={14}/> Cobertura</span><div className="flex gap-0.5">{renderDaysBadges(c.daysOfWeek || [])}</div></div>
                                    </div>
                                    <div className="pt-3 border-t border-slate-100">
                                        <button onClick={() => openModalitiesManager(c)} className="w-full py-2 text-xs font-bold text-indigo-600 bg-indigo-50 rounded hover:bg-indigo-100 transition text-center block">Gestionar Turnos Base</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* MODAL EDITAR OBJETIVO (CON CLIENTE) */}
                {showEditObjectiveModal && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                        <div className="bg-white rounded-xl p-6 w-full max-w-md">
                            <h3 className="text-lg font-bold mb-4">Editar Sede</h3>
                            <form onSubmit={handleSaveObjective} className="space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500">Cliente</label>
                                    <select className="w-full border p-2 rounded bg-white" value={editObjForm.clientId} onChange={e => setEditObjForm({...editObjForm, clientId: e.target.value})} required>
                                        <option value="" disabled>Seleccione...</option>
                                        {clients.map(c => <option key={c.id} value={c.id}>{c.businessName}</option>)}
                                    </select>
                                </div>
                                <input className="w-full border p-2 rounded" value={editObjForm.name} onChange={e => setEditObjForm({...editObjForm, name: e.target.value})} placeholder="Nombre" required />
                                <input className="w-full border p-2 rounded" value={editObjForm.address} onChange={e => setEditObjForm({...editObjForm, address: e.target.value})} placeholder="Direcci贸n" required />
                                <div className="grid grid-cols-2 gap-2">
                                    <input className="w-full border p-2 rounded bg-gray-50" value={editObjForm.latitude} readOnly />
                                    <input className="w-full border p-2 rounded bg-gray-50" value={editObjForm.longitude} readOnly />
                                </div>
                                <button type="button" onClick={() => setShowGeoSelector(true)} className="w-full bg-green-600 text-white py-2 rounded-lg text-sm font-bold">Actualizar Mapa</button>
                                <div className="flex justify-end gap-2 pt-4 border-t">
                                    <button type="button" onClick={() => setShowEditObjectiveModal(false)} className="px-4 py-2 bg-gray-100 rounded">Cancelar</button>
                                    <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded">Guardar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}

                <GeocodingSelector address={editObjForm.address} isOpen={showGeoSelector} onClose={() => setShowGeoSelector(false)} onCoordinatesSelected={handleGeoSelected} />

                {/* MODAL SERVICIO (ACTUALIZADO) */}
                {showServiceModal && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
                        <div className="bg-white rounded-xl p-6 w-full max-w-md">
                            <h3 className="text-lg font-bold mb-4">{editingContract ? 'Editar Servicio' : 'Nuevo Servicio'}</h3>
                            <form onSubmit={handleSaveService} className="space-y-4">
                                <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Nombre</label><input className="w-full border p-2 rounded" value={serviceForm.name} onChange={e => setServiceForm({...serviceForm, name: e.target.value})} required /></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Horas/Mes</label><input className="w-full border p-2 rounded" type="number" value={serviceForm.hours} onChange={e => setServiceForm({...serviceForm, hours: +e.target.value})} required /></div>
                                    <div><label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Dotaci贸n</label><input className="w-full border p-2 rounded" type="number" min="1" value={serviceForm.quantity} onChange={e => setServiceForm({...serviceForm, quantity: +e.target.value})} required /></div>
                                </div>
                                {/* FECHAS */}
                                <div className="bg-slate-50 p-3 rounded border border-slate-100 grid grid-cols-2 gap-2">
                                    <div><label className="text-[10px] font-bold text-gray-400 uppercase block">Inicio</label><input type="date" className="w-full border p-1 rounded text-sm" value={serviceForm.startDate} onChange={e => setServiceForm({...serviceForm, startDate: e.target.value})} required /></div>
                                    <div><label className="text-[10px] font-bold text-gray-400 uppercase block">Fin</label><input type="date" className="w-full border p-1 rounded text-sm" value={serviceForm.endDate} onChange={e => setServiceForm({...serviceForm, endDate: e.target.value})} /></div>
                                </div>
                                {/* DIAS */}
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">D铆as</label>
                                    <div className="flex justify-between gap-1">
                                        {['Dom','Lun','Mar','Mi茅','Jue','Vie','S谩b'].map((day, index) => {
                                            const isSelected = serviceForm.days.includes(index);
                                            return <button key={index} type="button" onClick={() => setServiceForm(p => ({...p, days: isSelected ? p.days.filter(d => d !== index) : [...p.days, index]}))} className={`w-8 h-8 rounded text-xs font-bold ${isSelected ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-400'}`}>{day.charAt(0)}</button>
                                        })}
                                    </div>
                                </div>
                                <div className="flex justify-end gap-2 mt-6">
                                    <button type="button" onClick={() => setShowServiceModal(false)} className="px-4 py-2 bg-gray-100 rounded">Cancelar</button>
                                    <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded">Guardar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}

                {/* MODAL MODALIDADES */}
                {showModalitiesModal && selectedContractForModalities && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                        <div className="bg-white rounded-xl p-6 w-full max-w-2xl h-[80vh] flex flex-col">
                            <div className="flex justify-between items-center mb-4 border-b pb-2">
                                <div><h3 className="text-lg font-bold">Modalidades</h3><p className="text-xs text-gray-500">{selectedContractForModalities.name}</p></div>
                                <button onClick={() => setShowModalitiesModal(false)} className="text-gray-400 hover:text-gray-600"></button>
                            </div>
                            <div className="flex-1 overflow-y-auto mb-4 space-y-2 p-1">
                                {contractShiftTypes.map(t => (
                                    <div key={t.id} className="flex items-center justify-between p-3 border rounded-lg hover:bg-slate-50">
                                        <div><p className="font-bold text-sm">{t.name} <span className="text-gray-400 text-xs">({t.code})</span></p><p className="text-xs text-indigo-600 font-mono">{t.startTime}  {t.durationHours}hs</p></div>
                                        <div className="flex gap-2"><button onClick={() => handleEditModality(t)} className="text-indigo-600 hover:bg-indigo-50 p-1 rounded"><Edit2 size={14}/></button><button onClick={() => handleDeleteModality(t.id)} className="text-red-600 hover:bg-red-50 p-1 rounded"><Trash2 size={14}/></button></div>
                                    </div>
                                ))}
                            </div>
                            <form onSubmit={handleSaveModality} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h4 className="text-xs font-bold text-gray-500 uppercase mb-3">{isEditingModality ? 'Editar' : 'Nueva'}</h4>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                    <input placeholder="Nombre" className="border p-2 rounded text-sm" value={modalityForm.name} onChange={e => setModalityForm({...modalityForm, name: e.target.value})} required />
                                    <input placeholder="C贸digo" className="border p-2 rounded text-sm" value={modalityForm.code} onChange={e => setModalityForm({...modalityForm, code: e.target.value})} required />
                                    <input type="time" className="border p-2 rounded text-sm" value={modalityForm.startTime} onChange={e => setModalityForm({...modalityForm, startTime: e.target.value})} required />
                                    <input type="number" placeholder="Duraci贸n" className="border p-2 rounded text-sm" value={modalityForm.durationHours} onChange={e => setModalityForm({...modalityForm, durationHours: +e.target.value})} required />
                                </div>
                                <div className="flex justify-end gap-2">
                                    {isEditingModality && <button type="button" onClick={() => { setIsEditingModality(false); setModalityForm({ id: '', name: '', code: '', startTime: '07:00', durationHours: 12 }); }} className="text-xs text-gray-500 underline">Cancelar</button>}
                                    <button type="submit" className="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-black">{isEditingModality ? 'Actualizar' : 'Agregar'}</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}

                {/* MODAL TURNO */}
                {showShiftModal && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                        <div className="bg-white rounded-xl p-6 w-full max-w-md">
                            <h3 className="text-lg font-bold mb-4">Asignaci贸n Manual</h3>
                            <form onSubmit={handleCreateShift} className="space-y-4">
                                <select className="w-full border p-2 rounded" value={shiftForm.employeeId} onChange={e => setShiftForm({...shiftForm, employeeId: e.target.value})} required>
                                    <option value="">Seleccione Empleado</option>
                                    {employees.map(e => <option key={e.uid} value={e.uid}>{e.name}</option>)}
                                </select>
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="datetime-local" className="border p-2 rounded" value={shiftForm.start} onChange={e => setShiftForm({...shiftForm, start: e.target.value})} required />
                                    <input type="datetime-local" className="border p-2 rounded" value={shiftForm.end} onChange={e => setShiftForm({...shiftForm, end: e.target.value})} required />
                                </div>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button type="button" onClick={() => setShowShiftModal(false)} className="px-4 py-2 bg-gray-100 rounded">Cancelar</button>
                                    <button type="submit" className="px-4 py-2 bg-green-600 text-white rounded">Asignar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}

            </div>
        </DashboardLayout>
    );
}

export default withAuthGuard(ObjectiveDetailPage, ['admin', 'manager', 'supervisor']);

================================================================================
FILE: apps\web\pages\admin\objective-management.tsx
================================================================================
// Archivo: pages/admin/objective-management.tsx

import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
//  FIX CRTICO: Importamos DashboardLayout por defecto (SIN LLAVES)
import DashboardLayout from '@/components/layout/DashboardLayout'; 
import ObjectiveManagement from '@/components/admin/objective-management'; // Asumo exportaci贸n por defecto

function ObjectiveManagementPage() {
    return (
        <DashboardLayout title="Gesti贸n de Objetivos y Sucursales">
            <ObjectiveManagement />
        </DashboardLayout>
    );
}

// Exportaci贸n protegida
export default withAuthGuard(ObjectiveManagementPage, ['admin']);

================================================================================
FILE: apps\web\pages\admin\operations\map.tsx
================================================================================
import React, { useEffect, useState, useMemo, useCallback } from 'react';
import { useRouter } from 'next/router';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import DashboardLayout from '@/components/layout/DashboardLayout';
import { callManageData } from '@/services/firebase-client.service';
import { IObjective } from '@/common/interfaces/client.interface';
import { GoogleMap, useJsApiLoader, Marker, InfoWindow } from '@react-google-maps/api';
import { 
    MapPin, Search, ArrowRight, Building2, 
    AlertTriangle, Users, Activity, Navigation 
} from 'lucide-react';
import { useClient } from '@/context/ClientContext'; 

// --- CONFIGURACIN DEL MAPA ---
const containerStyle = { width: '100%', height: '100%' };
const defaultCenter = { lat: -34.6037, lng: -58.3816 }; // Buenos Aires Default

// Estilo "Silver" limpio para uso profesional (menos distracciones)
const mapOptions: google.maps.MapOptions = {
    disableDefaultUI: true,
    zoomControl: true,
    fullscreenControl: true,
    styles: [
        { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
        { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
        { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
        { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] },
        { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
        { featureType: "water", elementType: "geometry", stylers: [{ color: "#c9c9c9" }] },
        { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] }
    ]
};

// --- ICONOS DE MAPA DINMICOS ---
const getMarkerIcon = (status: 'ok' | 'alert' | 'warning') => {
    let color = '#10B981'; // Verde (Operativo)
    if (status === 'alert') color = '#EF4444'; // Rojo (Problema)
    if (status === 'warning') color = '#F59E0B'; // Amarillo (Atenci贸n)

    return {
        path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z M12 11.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z",
        fillColor: color,
        fillOpacity: 1,
        strokeWeight: 1.5,
        strokeColor: "#FFFFFF",
        scale: 1.8,
        anchor: { x: 12, y: 22 }
    } as google.maps.Symbol;
};

// Interfaz extendida para UI
interface IObjectiveMap extends IObjective {
    status: 'ok' | 'alert' | 'warning';
    activePersonnel: number;
}

function OperatorMapPage() {
  const router = useRouter();
  const { selectedClientId, selectedClient } = useClient(); // Conexi贸n con el selector global
  
  const [allObjectives, setAllObjectives] = useState<IObjectiveMap[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedObj, setSelectedObj] = useState<IObjectiveMap | null>(null);
  const [mapInstance, setMapInstance] = useState<google.maps.Map | null>(null);
  
  const [stats, setStats] = useState({ total: 0, alerts: 0, active: 0 });

  const { isLoaded } = useJsApiLoader({
    id: 'google-map-script',
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY || ''
  });

  // 1. CARGA DE DATOS (Reactiva al Filtro Global)
  useEffect(() => {
    const loadObjectives = async () => {
        try {
            // Si selectedClientId es "", el backend debe traer TODOS (ajustar backend si es necesario o manejarlo aqu铆)
            // Asumimos que manageData soporta payload vac铆o para traer todo si eres admin
            const payload = selectedClientId ? { clientId: selectedClientId } : {};
            const res = await callManageData({ action: 'GET_ALL_OBJECTIVES', payload });
            
            const data = (res.data as any).data || [];
            
            //  ENRIQUECIMIENTO (Simulaci贸n de estado operativo)
            // En el futuro, esto vendr谩 del backend con el estado real de la Torre de Control
            const enrichedData = data
                .filter((o: IObjective) => o.location && o.location.latitude)
                .map((obj: IObjective, index: number) => ({
                    ...obj,
                    status: index % 5 === 0 ? 'alert' : 'ok', // Mock de alertas
                    activePersonnel: Math.floor(Math.random() * 4) // Mock de personal
                }));

            setAllObjectives(enrichedData);
            
            // Recalcular Zoom del Mapa para abarcar todos los puntos
            if (mapInstance && enrichedData.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                enrichedData.forEach((o: IObjective) => bounds.extend({ lat: o.location.latitude, lng: o.location.longitude }));
                mapInstance.fitBounds(bounds);
            }

            // KPIs R谩pidos
            setStats({
                total: enrichedData.length,
                alerts: enrichedData.filter((o: any) => o.status === 'alert').length,
                active: enrichedData.reduce((acc: number, curr: any) => acc + curr.activePersonnel, 0)
            });

        } catch (error) {
            console.error("Error cargando mapa:", error);
        }
    };
    loadObjectives();
  }, [selectedClientId, mapInstance]);

  // 2. FILTRADO LOCAL (Buscador)
  const filteredObjectives = useMemo(() => {
      return allObjectives.filter(obj => 
        obj.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        obj.address.toLowerCase().includes(searchQuery.toLowerCase())
      );
  }, [allObjectives, searchQuery]);

  // 3. HANDLERS
  const handleSelectObjective = useCallback((obj: IObjectiveMap) => {
      setSelectedObj(obj);
      if (mapInstance) {
          mapInstance.panTo({ lat: obj.location.latitude, lng: obj.location.longitude });
          mapInstance.setZoom(15);
      }
  }, [mapInstance]);

  const goToControlTower = () => {
      if (selectedObj) {
          router.push(`/admin/objective-detail/${selectedObj.id}`);
      }
  };

  return (
    <DashboardLayout title="Centro de Operaciones Global">
      
      {/* 1. BARRA DE KPIS (HEADER OPERATIVO) */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between">
              <div>
                  <p className="text-xs text-slate-500 font-bold uppercase">Objetivos Visibles</p>
                  <p className="text-2xl font-bold text-slate-800">{stats.total}</p>
                  <p className="text-xs text-slate-400">{selectedClient ? selectedClient.businessName : 'Todas las Empresas'}</p>
              </div>
              <div className="p-2 bg-indigo-50 rounded-lg text-indigo-600"><Building2 size={24} /></div>
          </div>

          <div className={`p-4 rounded-xl shadow-sm border flex items-center justify-between ${stats.alerts > 0 ? 'bg-red-50 border-red-200' : 'bg-white border-slate-200'}`}>
              <div>
                  <p className={`text-xs font-bold uppercase ${stats.alerts > 0 ? 'text-red-600' : 'text-slate-500'}`}>Incidencias Activas</p>
                  <p className={`text-2xl font-bold ${stats.alerts > 0 ? 'text-red-700' : 'text-slate-800'}`}>{stats.alerts}</p>
                  <p className="text-xs text-slate-400">Requieren atenci贸n</p>
              </div>
              <div className={`p-2 rounded-lg ${stats.alerts > 0 ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-slate-50 text-slate-400'}`}>
                  <AlertTriangle size={24} />
              </div>
          </div>

          <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between">
              <div>
                  <p className="text-xs text-slate-500 font-bold uppercase">Fuerza Activa</p>
                  <p className="text-2xl font-bold text-green-700">{stats.active}</p>
                  <p className="text-xs text-slate-400">Empleados en sitio</p>
              </div>
              <div className="p-2 bg-green-50 rounded-lg text-green-600"><Activity size={24} /></div>
          </div>
      </div>

      {/* 2. AREA DE TRABAJO (SIDEBAR + MAPA) */}
      <div className="flex flex-col lg:flex-row h-[calc(100vh-250px)] bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
        
        {/* --- LISTA LATERAL (SIDEBAR) --- */}
        <div className="w-full lg:w-96 border-r border-slate-200 flex flex-col bg-white z-10 relative">
            <div className="p-4 border-b border-slate-100 bg-slate-50/50">
                <div className="relative">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={16} />
                    <input 
                        type="text" 
                        placeholder="Buscar objetivo..." 
                        className="w-full pl-9 pr-4 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-2 space-y-1 bg-slate-50/30">
                {filteredObjectives.length === 0 && <div className="p-4 text-center text-slate-400 text-sm">No se encontraron resultados.</div>}
                
                {filteredObjectives.map(obj => (
                    <div 
                        key={obj.id}
                        onClick={() => handleSelectObjective(obj)}
                        className={`p-3 rounded-lg border cursor-pointer transition-all group ${
                            selectedObj?.id === obj.id 
                            ? 'bg-white border-indigo-500 shadow-md ring-1 ring-indigo-50' 
                            : 'bg-white border-slate-200 hover:border-indigo-300 hover:shadow-sm'
                        }`}
                    >
                        <div className="flex justify-between items-start">
                            <div>
                                <p className={`font-bold text-sm ${selectedObj?.id === obj.id ? 'text-indigo-700' : 'text-slate-700'}`}>
                                    {obj.name}
                                </p>
                                <p className="text-xs text-slate-500 truncate w-48 flex items-center mt-0.5">
                                    <MapPin size={10} className="mr-1"/> {obj.address}
                                </p>
                            </div>
                            {/* Sem谩foro en la lista */}
                            <div className={`w-2.5 h-2.5 rounded-full shadow-sm ${
                                obj.status === 'alert' ? 'bg-red-500 animate-pulse' : 
                                obj.status === 'warning' ? 'bg-yellow-400' : 'bg-green-500'
                            }`} />
                        </div>
                        {selectedObj?.id === obj.id && (
                            <div className="mt-2 pt-2 border-t border-slate-100 flex justify-end">
                                <span className="text-[10px] text-indigo-600 font-bold flex items-center">
                                    VER EN MAPA <Navigation size={10} className="ml-1"/>
                                </span>
                            </div>
                        )}
                    </div>
                ))}
            </div>
        </div>

        {/* --- MAPA --- */}
        <div className="flex-1 relative bg-slate-100">
            {isLoaded ? (
                <GoogleMap
                    mapContainerStyle={containerStyle}
                    center={defaultCenter}
                    zoom={10}
                    onLoad={map => setMapInstance(map)}
                    options={mapOptions}
                >
                    {filteredObjectives.map(obj => (
                        <Marker
                            key={obj.id}
                            position={{ lat: obj.location.latitude, lng: obj.location.longitude }}
                            onClick={() => handleSelectObjective(obj)}
                            icon={getMarkerIcon(obj.status)}
                            animation={selectedObj?.id === obj.id ? google.maps.Animation.BOUNCE : undefined}
                        />
                    ))}

                    {/* POPUP DE DETALLE (InfoWindow) */}
                    {selectedObj && (
                        <InfoWindow
                            position={{ lat: selectedObj.location.latitude, lng: selectedObj.location.longitude }}
                            onCloseClick={() => setSelectedObj(null)}
                            options={{ pixelOffset: new google.maps.Size(0, -40) }}
                        >
                            <div className="p-1 min-w-[240px]">
                                <div className="flex items-center justify-between mb-3 border-b pb-2 border-gray-100">
                                    <h4 className="font-extrabold text-slate-800 text-sm">{selectedObj.name}</h4>
                                    <span className={`text-[10px] font-bold px-2 py-0.5 rounded uppercase ${
                                        selectedObj.status === 'alert' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'
                                    }`}>
                                        {selectedObj.status === 'alert' ? 'INCIDENCIA' : 'OPERATIVO'}
                                    </span>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    <div className="bg-slate-50 p-2 rounded text-center">
                                        <p className="text-[10px] text-slate-400 uppercase font-bold">Personal</p>
                                        <p className="text-sm font-bold text-slate-700">{selectedObj.activePersonnel}</p>
                                    </div>
                                    <div className="bg-slate-50 p-2 rounded text-center">
                                        <p className="text-[10px] text-slate-400 uppercase font-bold">Estado</p>
                                        <p className="text-sm font-bold text-slate-700">Activo</p>
                                    </div>
                                </div>

                                <button 
                                    onClick={goToControlTower}
                                    className="w-full bg-slate-900 text-white py-2 rounded-lg text-xs font-bold hover:bg-black flex items-center justify-center gap-2 transition-all shadow-md group"
                                >
                                    ABRIR TORRE DE CONTROL 
                                    <ArrowRight size={12} className="group-hover:translate-x-1 transition-transform"/>
                                </button>
                            </div>
                        </InfoWindow>
                    )}
                </GoogleMap>
            ) : (
                <div className="h-full w-full flex flex-col items-center justify-center text-slate-400">
                    <p className="animate-pulse">Cargando sat茅lite...</p>
                </div>
            )}
        </div>

      </div>
    </DashboardLayout>
  );
}

export default withAuthGuard(OperatorMapPage, ['admin', 'manager', 'operator', 'supervisor']);

================================================================================
FILE: apps\web\pages\admin\rrhh\novedades.tsx
================================================================================
// Archivo: pages/admin/rrhh/novedades.tsx

import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
//  FIX CRTICO: Importamos DashboardLayout por defecto (SIN LLAVES)
import DashboardLayout from '@/components/layout/DashboardLayout'; 
import { AbsenceManagementPage } from '@/components/admin/AbsenceManagementPage';

function NovedadesPage() {
    return (
        <DashboardLayout title="Novedades y Gesti贸n de Ausencias">
            <AbsenceManagementPage />
        </DashboardLayout>
    );
}

// Exportaci贸n protegida (asumo roles de administraci贸n y RRHH)
export default withAuthGuard(NovedadesPage, ['admin', 'hr_manager']);

================================================================================
FILE: apps\web\pages\admin\status.tsx
================================================================================
// Archivo: pages/admin/status.tsx

import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
//  FIX CRTICO: Importamos DashboardLayout por defecto (SIN LLAVES)
import DashboardLayout from '@/components/layout/DashboardLayout'; 
import { SystemStatus } from '@/components/admin/SystemStatus';

function StatusPage() {
    return (
        <DashboardLayout title="Diagn贸stico de Sistema">
            <div className="p-6">
                <SystemStatus />
            </div>
        </DashboardLayout>
    );
}

// Exportaci贸n protegida (asumo roles de administraci贸n)
export default withAuthGuard(StatusPage, ['admin']);

================================================================================
FILE: apps\web\pages\admin\system-users.tsx
================================================================================
// Archivo: pages/admin/system-users.tsx

import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
//  FIX CRTICO: Importamos DashboardLayout por defecto (SIN LLAVES)
import DashboardLayout from '@/components/layout/DashboardLayout'; 
import { SystemUserManagement } from '@/components/admin/system-user-management';

function SystemUsersPage() {
    return (
        <DashboardLayout title="Gesti贸n de Usuarios del Sistema">
            <SystemUserManagement />
        </DashboardLayout>
    );
}

// Exportaci贸n protegida (asumo roles de administraci贸n)
export default withAuthGuard(SystemUsersPage, ['admin']);

================================================================================
FILE: apps\web\pages\employee\dashboard.tsx
================================================================================
// Archivo: apps/web/pages/employee/dashboard.tsx

import React from 'react';
import { useRouter } from 'next/router';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { EmployeeDashboard } from '@/components/employee/employee-dashboard';
import { auth } from '@/services/firebase-client.service';

//  FIX: NO usamos DashboardLayout aqu铆 para evitar el sidebar de admin
// Si quieres un layout, deber铆amos crear uno espec铆fico para empleados.
// Por ahora, usamos un div simple para limpiar la vista.

function EmployeePage({ currentUser }: { currentUser: any }) {
  const router = useRouter(); 
  
  const handleLogout = async () => {
      await auth.signOut();
      window.location.href = '/';
  };

  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      {/* Header Simple para Empleado */}
      <header className="bg-white shadow-sm px-4 py-3 flex justify-between items-center sticky top-0 z-10">
        <div className="flex items-center space-x-3">
            <div className="bg-indigo-600 p-2 rounded-lg">
                {/* Logo simple */}
                <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            </div>
            <div>
                <h1 className="text-lg font-bold text-gray-800 leading-none">Mi Portal</h1>
                <p className="text-xs text-gray-500">{currentUser?.email}</p>
            </div>
        </div>
        
        <button onClick={handleLogout} className="text-sm text-red-600 font-medium border border-red-100 px-3 py-1.5 rounded-lg hover:bg-red-50 transition-colors">
            Salir
        </button>
      </header>

      {/* Renderizamos el componente de tarjetas nuevo */}
      <main className="p-4">
        <EmployeeDashboard currentUser={currentUser} />
      </main>
    </div>
  );
}

export default withAuthGuard(EmployeePage, ['employee']);

================================================================================
FILE: apps\web\pages\employee\employees.tsx
================================================================================
// Archivo: pages/employee/employees.tsx

import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
//  FIX CRTICO: Importamos DashboardLayout por defecto (SIN LLAVES)
import DashboardLayout from '@/components/layout/DashboardLayout'; 
// Importamos el componente de gesti贸n que ya tienes en src/components
import { EmployeeManagement } from '@/components/admin/employee-management';

function EmployeesPage() {
    return (
        <DashboardLayout title="Gesti贸n de Recursos Humanos">
            {/* Asumo que esta vista permite a los empleados ver la informaci贸n general */}
            <EmployeeManagement /> 
        </DashboardLayout>
    );
}

// Exportaci贸n protegida (asumo que esta ruta solo es para roles administrativos/HR)
export default withAuthGuard(EmployeesPage, ['admin', 'manager']);

================================================================================
FILE: apps\web\pages\index.tsx
================================================================================
import React, { useEffect } from 'react';
import { useRouter } from 'next/router';
import { onAuthStateChanged } from 'firebase/auth';
import { auth } from '@/services/firebase-client.service';
import { LoginForm } from '@/components/admin/login-form';

const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager'];

export default function HomePage() {
  const router = useRouter();

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          // Obtenemos el rol real del token
          const tokenResult = await user.getIdTokenResult();
          const role = tokenResult.claims.role as string;
          
          console.log("Usuario detectado:", user.email, "| Rol:", role);

          //  LGICA DE BIFURCACIN
          if (ADMIN_ROLES.includes(role)) {
            console.log("--> Redirigiendo a Admin Dashboard");
            router.push('/admin/dashboard');
          } else {
            // Si no es admin, asumimos que es empleado (o 'employee')
            console.log("--> Redirigiendo a Employee Dashboard");
            router.push('/employee/dashboard');
          }
        } catch (e) {
          console.error("Error leyendo rol:", e);
        }
      }
    });
    return () => unsubscribe();
  }, [router]);

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4 font-sans">
      <div className="w-full max-w-md">
        <LoginForm />
      </div>
    </div>
  );
}

================================================================================
FILE: apps\web\pages\_app.tsx
================================================================================
import React from 'react';
import type { AppProps } from 'next/app';
// 1. Importamos el sistema de notificaciones (Frontend)
import { Toaster } from 'react-hot-toast';
// 2. Importamos el proveedor de contexto de cliente (Frontend)
import { ClientProvider } from '@/context/ClientContext';
// 3. Importamos los estilos globales (Tailwind)
import '@/styles/globals.css'; 

export default function App({ Component, pageProps }: AppProps) {
  return (
    // Envolvemos toda la app en el ClientProvider para tener acceso a la empresa seleccionada
    <ClientProvider>
      
      {/* Renderizamos la p谩gina actual */}
      <Component {...pageProps} />
      
      {/* Configuraci贸n global de las notificaciones (Toasts) */}
      <Toaster 
        position="top-right" 
        reverseOrder={false}
        toastOptions={{
          // Estilos por defecto para todas las notificaciones
          style: {
            borderRadius: '10px',
            background: '#333',
            color: '#fff',
            fontSize: '14px',
          },
          // Estilos espec铆ficos para 茅xito (Verde)
          success: {
            style: {
              background: '#ECFDF5', // Verde muy claro
              color: '#065F46',      // Texto verde oscuro
              border: '1px solid #10B981',
            },
            iconTheme: {
              primary: '#10B981',
              secondary: '#FFFAEE',
            },
          },
          // Estilos espec铆ficos para error (Rojo)
          error: {
            style: {
              background: '#FEF2F2', // Rojo muy claro
              color: '#991B1B',      // Texto rojo oscuro
              border: '1px solid #EF4444',
            },
            duration: 5000, // Duran 5 segundos para poder leerlos bien
          },
        }}
      />
    </ClientProvider>
  );
}

================================================================================
FILE: apps\web\README.md
================================================================================
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.


================================================================================
FILE: apps\web\src\common\interfaces\client.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore';
import { ReactNode } from 'react';

export interface IClient {
  id: string;
  businessName: ReactNode;
  cuit: ReactNode;
  contactName: string;
  contactEmail: ReactNode;
  name: string;
  status: 'Active' | 'Inactive';
  createdAt: Timestamp;
}

export interface IObjective {
  id: string;
  clientId: string;
  name: string;
  address: string;
  location: { latitude: number; longitude: number; };
  type: string;
}

//  CLAVE: IServiceContract con campos operativos
export interface IServiceContract {
  id: string;
  objectiveId: string;
  name: string;        
  totalHoursPerMonth: number;
  isActive: boolean;
  startDate: any; 
  endDate?: any;
  quantity?: number;      // Dotaci贸n (Personas)
  daysOfWeek?: number[];  // D铆as [0-6]
}

export interface IShiftType {
  id: string;
  contractId: string;
  name: string;       
  code: string;       
  color: string;
  startTime: string;  
  durationHours: number; 
  requiredRole?: string;
}

================================================================================
FILE: apps\web\src\common\interfaces\employee.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore'; 

/**
 * @description Define los roles de usuario dentro del sistema Cronograma.
 */
export type EmployeeRole = 'admin' | 'employee';

/**
 * @description Define los tipos de contrato laboral soportados.
 */
export type ContractType = 'FullTime' | 'PartTime' | 'Eventual';

/**
 * @description Interfaz principal para la entidad Colaborador (Employee).
 * Estos son los datos que se obtienen del m贸dulo RRHH.
 */
export interface IEmployee {
    uid: string; // Firebase Auth UID / Document ID
    name: string;
    role: EmployeeRole;
    email: string;
    
    // Estado de disponibilidad general
    isAvailable: boolean;
    maxHoursPerMonth: number; // L铆mite de horas contractuales
    contractType: ContractType;

    //  CAMBIO ARQUITECTNICO: Pool de Recursos
    // El empleado pertenece a la Agencia (Unidad de Negocio), no necesariamente a un cliente fijo.
    clientId?: string;       // Cliente asignado actualmente (Opcional)
    businessUnitId?: string; // Unidad de Negocio (Ej: "Seguridad C贸rdoba")

    // Datos Personales
    dni: string;        // Documento
    fileNumber: string; // Legajo
    address: string;    // Direcci贸n
    phone?: string;     // Tel茅fono opcional
}

/**
 * @description Estructura de una ausencia.
 */
export interface IAbsence {
    id: string;
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    startDate: Timestamp; 
    endDate: Timestamp;
    reason: string;
    status: 'PENDING' | 'APPROVED' | 'REJECTED';
    createdAt: Timestamp;
}

/**
 * @description Payload para crear ausencia desde el cliente.
 * Se usan tipos nativos de JS (Date) para facilitar el manejo en formularios.
 */
export interface IAbsencePayload {
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    startDate: Date; 
    endDate: Date;
    reason: string;
}

================================================================================
FILE: apps\web\src\common\interfaces\service-pattern.interface.ts
================================================================================
import * as admin from 'firebase-admin';

/**
 * @interface IServicePattern (El "Molde" Inteligente)
 * @description Define una regla de recurrencia para generar turnos autom谩ticamente.
 * Ej: "Necesito 2 Vigiladores (Turno Noche) todos los Lunes, Mi茅rcoles y Viernes".
 */
export interface IServicePattern {
  id: string;
  contractId: string;      // Vinculado al contrato "Seguridad Planta 2025"
  shiftTypeId: string;     // Usa la modalidad "Turno Noche 12hs"
  
  // Configuraci贸n de Recurrencia
  // 0=Dom, 1=Lun, ..., 6=Sab. Ej: [1,2,3,4,5] para Lun-Vie.
  daysOfWeek: number[];    
  
  // Cantidad de recursos requeridos simult谩neamente
  quantityPerDay: number;  
  
  // Vigencia de la regla
  validFrom: admin.firestore.Timestamp;
  validTo?: admin.firestore.Timestamp; // Si es null, es indefinido
  
  // Metadatos
  createdAt: admin.firestore.Timestamp;
  createdBy: string; // UID del planificador
  active: boolean;
}

/**
 * Payload para crear/editar un patr贸n desde el Frontend
 */
export interface IPatternPayload {
  contractId: string;
  shiftTypeId: string;
  daysOfWeek: number[];
  quantity: number;
  validFrom: string; // ISO String
  validTo?: string;  // ISO String
}

================================================================================
FILE: apps\web\src\common\interfaces\shift.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore';

export interface IShift {
  id: string;
  employeeId: string;
  employeeName: string;
  objectiveId: string;
  objectiveName: string;
  
  startTime: Timestamp;
  endTime: Timestamp;
  
  status: 'Assigned' | 'Confirmed' | 'InProgress' | 'Completed' | 'Canceled';
  
  checkInTime?: Timestamp;
  checkOutTime?: Timestamp;
  
  schedulerId: string;
  updatedAt: Timestamp;

  //  CORRECCIN: Agregamos el campo opcional 'role' para que el Dashboard no falle
  role?: string; 
}

================================================================================
FILE: apps\web\src\common\interfaces\system-user.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore'; //  SDK CLIENTE (Importante para la Web)

/**
 * Roles Jer谩rquicos del Sistema (RBAC):
 * - SuperAdmin: IT / Due帽o del SaaS. Acceso total.
 * - Manager: Gerente de Unidad. Ve todo dentro de su unidad.
 * - Scheduler: Planificador. Gestiona turnos y asignaciones.
 * - Supervisor: Campo. Gestiona incidencias y personal.
 * - Operator: Monitoreo. Solo lectura o vista de tablero en vivo.
 */
export type SystemRole = 
  | 'SuperAdmin' 
  | 'Manager' 
  | 'Scheduler' 
  | 'Supervisor' 
  | 'Operator';

/**
 * Interfaz de Usuario del Sistema (Frontend).
 * Define la estructura de los administradores que acceden al Back-Office.
 */
export interface ISystemUser {
  uid: string;
  email: string;
  displayName: string;
  role: SystemRole;
  
  // ID de la Unidad de Negocio a la que pertenece
  // Si es undefined y el rol es SuperAdmin, tiene acceso global.
  businessUnitId?: string; 
  
  status: 'Active' | 'Inactive';
  
  // Fechas usando el tipo compatible con el SDK de Cliente
  createdAt: Timestamp;
  lastLogin?: Timestamp;
}

================================================================================
FILE: apps\web\src\components\admin\AbsenceManagementPage.test.tsx
================================================================================
//  FIX 1: Importar jest-dom para habilitar los matchers del DOM
import '@testing-library/jest-dom';
import { render, screen, waitFor, fireEvent } from '@testing-library/react';
import { AbsenceManagementPage } from './AbsenceManagementPage'; 
import { useClient } from '@/context/ClientContext';
import { callCreateAbsence, callManageEmployees } from '@/services/firebase-client.service'; 
import toast from 'react-hot-toast';

// Mocks de UI
jest.mock('../common/InputField', () => ({
    __esModule: true,
    default: ({ label, onChange, value, type }: any) => (
        <input aria-label={label} type={type || 'text'} value={value} onChange={onChange} />
    ),
}));

jest.mock('../common/SelectField', () => ({
    __esModule: true,
    default: ({ label, onChange, value, children }: any) => (
        <select aria-label={label} value={value} onChange={onChange}>{children}</select>
    ),
}));

jest.mock('../common/Button', () => ({
    __esModule: true,
    default: ({ children, disabled, type, onClick }: any) => (
        <button disabled={disabled} type={type} onClick={onClick} data-testid="submit-button">{children}</button>
    ),
}));

// Mocks de servicios
jest.mock('@/context/ClientContext', () => ({ useClient: jest.fn(), }));
jest.mock('@/services/firebase-client.service', () => ({
    callManageEmployees: jest.fn(),
    callCreateAbsence: jest.fn(), 
}));
jest.mock('react-hot-toast', () => ({
    error: jest.fn(),
    success: jest.fn(),
    loading: jest.fn().mockReturnValue('toast-id-mock'),
}));

const mockEmployees = [
    { uid: 'emp1', name: 'Juan P茅rez', role: 'Vigilador' },
];

const mockUseClient = (selectedClientId: string | null) => (
    (useClient as jest.Mock).mockReturnValue({ selectedClientId })
);

describe('AbsenceManagementPage', () => {
    beforeEach(() => {
        jest.clearAllMocks();
        
        //  FIX 2: Doble casting para silenciar a TypeScript
        (callManageEmployees as unknown as jest.Mock).mockResolvedValue({
            data: { data: mockEmployees },
        });
        (callCreateAbsence as unknown as jest.Mock).mockResolvedValue({
            data: { success: true },
        });
        
        mockUseClient('client_abc'); 
    });

    it('should render and fetch employees successfully', async () => {
        render(<AbsenceManagementPage />);
        await waitFor(() => {
            expect(callManageEmployees).toHaveBeenCalled();
        });
        // FIX 3: Usamos el matcher que ahora s铆 est谩 importado
        expect(screen.getByLabelText(/Colaborador/i)).toBeInTheDocument();
    });

    it('should validate form dates', async () => {
        render(<AbsenceManagementPage />);
        await waitFor(() => { expect(callManageEmployees).toHaveBeenCalled(); });

        fireEvent.change(screen.getByLabelText(/Colaborador/i), { target: { value: 'emp1' } });
        fireEvent.change(screen.getByLabelText(/Raz贸n \/ Comentarios/i), { target: { value: 'Test Reason' } });
        fireEvent.change(screen.getByLabelText(/Fecha de Inicio/i), { target: { value: '2025-01-10' } });
        fireEvent.change(screen.getByLabelText(/Fecha de Fin/i), { target: { value: '2025-01-01' } });

        fireEvent.click(screen.getByTestId('submit-button'));

        await waitFor(() => {
            expect(toast.error).toHaveBeenCalled();
        });
        expect(callCreateAbsence).not.toHaveBeenCalled();
    });

    it('should submit successfully', async () => {
        render(<AbsenceManagementPage />);
        await waitFor(() => { expect(callManageEmployees).toHaveBeenCalled(); });

        fireEvent.change(screen.getByLabelText(/Colaborador/i), { target: { value: 'emp1' } });
        fireEvent.change(screen.getByLabelText(/Tipo de Novedad/i), { target: { value: 'SICK_LEAVE' } });
        fireEvent.change(screen.getByLabelText(/Fecha de Inicio/i), { target: { value: '2025-01-01' } });
        fireEvent.change(screen.getByLabelText(/Fecha de Fin/i), { target: { value: '2025-01-05' } });
        fireEvent.change(screen.getByLabelText(/Raz贸n \/ Comentarios/i), { target: { value: 'Test Sick Leave' } });

        fireEvent.click(screen.getByTestId('submit-button'));

        await waitFor(() => {
            expect(callCreateAbsence).toHaveBeenCalled();
        });
        expect(toast.success).toHaveBeenCalled();
    });
});

================================================================================
FILE: apps\web\src\components\admin\AbsenceManagementPage.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import toast from 'react-hot-toast';
import { useClient } from '@/context/ClientContext';
import { IAbsencePayload, IEmployee } from '@/common/interfaces/employee.interface';
//  Importamos la funci贸n helper 'createAbsence' que ya maneja la conversi贸n de fechas
import { createAbsence, callManageEmployees } from '@/services/firebase-client.service';
import InputField from '@/components/common/InputField'; 
import SelectField from '@/components/common/SelectField';
import Button from '@/components/common/Button';

const ABSENCE_TYPES = [
    { value: 'VACATION', label: 'Vacaciones' },
    { value: 'SICK_LEAVE', label: 'Licencia M茅dica' },
    { value: 'OTHER', label: 'Otro / Personal' },
];

export function AbsenceManagementPage() {
    const { selectedClientId, selectedClient } = useClient(); // Usamos el contexto
    const [employees, setEmployees] = useState<IEmployee[]>([]);
    const [isLoadingEmployees, setIsLoadingEmployees] = useState<boolean>(false);
    const [isSubmitting, setIsSubmitting] = useState<boolean>(false);

    const [formData, setFormData] = useState<IAbsencePayload>({
        employeeId: '',
        employeeName: '',
        clientId: selectedClientId || '',
        type: 'VACATION',
        startDate: new Date(),
        endDate: new Date(),
        reason: '',
    });

    // Sincronizar clientId cuando cambia la selecci贸n en el men煤
    useEffect(() => {
        setFormData(prev => ({ 
            ...prev, 
            clientId: selectedClientId || '', 
            employeeId: '', 
            employeeName: '' 
        }));
    }, [selectedClientId]);

    // 1. Cargar Empleados (Filtrados por Empresa)
    useEffect(() => {
        const fetchEmployees = async () => {
            if (!selectedClientId) {
                setEmployees([]);
                return;
            }

            setIsLoadingEmployees(true);
            try {
                //  Filtramos por la empresa actual
                const empRes = await callManageEmployees({ 
                    action: 'GET_ALL_EMPLOYEES', 
                    payload: { clientId: selectedClientId } 
                });
                
                setEmployees((empRes.data as any).data || []); 
            } catch (error) {
                console.error("Error fetching employees:", error);
                toast.error("No se pudo cargar la lista de empleados.");
            } finally {
                setIsLoadingEmployees(false);
            }
        };
        fetchEmployees();
    }, [selectedClientId]);

    const handleEmployeeChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const selectedId = e.target.value;
        const selectedEmployee = employees.find(emp => emp.uid === selectedId);

        setFormData(prev => ({
            ...prev,
            employeeId: selectedId,
            employeeName: selectedEmployee ? selectedEmployee.name : ''
        }));
    };

    const handleDateChange = (name: keyof IAbsencePayload, value: string) => {
        // Fix de zona horaria simple: al crear fecha desde string YYYY-MM-DD, 
        // aseguramos que se interprete correctamente.
        const dateValue = new Date(value + 'T12:00:00'); // Mediod铆a para evitar saltos de d铆a por TZ
        setFormData(prev => ({
            ...prev,
            [name]: dateValue,
        }));
    };

    const validateForm = (data: IAbsencePayload): boolean => {
        if (!data.employeeId || !data.clientId || !data.type) {
            toast.error("Complete los campos obligatorios (Empleado, Tipo).");
            return false;
        }
        if (data.startDate.getTime() > data.endDate.getTime()) {
            toast.error("La fecha de inicio no puede ser posterior a la de fin.");
            return false;
        }
        if (!data.reason.trim()) {
            toast.error("Debe proporcionar una raz贸n o comentario.");
            return false;
        }
        return true;
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!validateForm(formData)) return;

        setIsSubmitting(true);
        const toastId = toast.loading(`Registrando ${formData.type}...`);

        try {
            // Usamos la funci贸n helper que creamos en el servicio
            await createAbsence({ action: 'CREATE_ABSENCE', payload: formData });
            
            toast.success("Novedad registrada exitosamente.", { id: toastId });
            
            // Reset parcial del formulario
            setFormData(prev => ({ 
                ...prev, 
                type: 'VACATION', 
                startDate: new Date(), 
                endDate: new Date(), 
                reason: '' 
            }));
        } catch (error: any) {
            console.error("Absence creation failed:", error);
            // Mensaje de error amigable si viene del backend (ej: Solapamiento)
            const message = error.message.includes('Conflicto') 
                ? error.message 
                : "Error al registrar la novedad. Verifique si hay turnos asignados.";
            
            toast.error(message, { id: toastId, duration: 5000 });
        } finally {
            setIsSubmitting(false);
        }
    };

    if (!selectedClientId) {
        return (
            <div className="flex flex-col items-center justify-center h-64 bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                <div className="bg-orange-100 p-3 rounded-full mb-4">
                    <svg className="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                </div>
                <h3 className="text-lg font-bold text-gray-800">Selecci贸n Requerida</h3>
                <p className="text-gray-500 mt-2">Por favor, seleccione una empresa en el men煤 lateral para gestionar las novedades de su personal.</p>
            </div>
        );
    }

    return (
        <div className="max-w-4xl mx-auto">
            {/* Cabecera */}
            <div className="mb-6 flex items-center justify-between">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800">Gesti贸n de Novedades</h2>
                    <p className="text-slate-500">Registrar licencias y vacaciones para <span className="font-semibold text-indigo-600">{selectedClient?.businessName}</span>.</p>
                </div>
            </div>

            <div className="bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                <form onSubmit={handleSubmit} className="space-y-6">
                    
                    <SelectField
                        label="Colaborador"
                        id="employeeId"
                        value={formData.employeeId}
                        onChange={handleEmployeeChange}
                        disabled={isLoadingEmployees || isSubmitting}
                        required
                    >
                        <option value="" disabled>{isLoadingEmployees ? 'Cargando...' : 'Seleccione un colaborador'}</option>
                        {employees.map(emp => (
                            //  MEJORA VISUAL: Mostramos Legajo para mejor identificaci贸n
                            <option key={emp.uid} value={emp.uid}>
                                {emp.name} (Leg: {emp.fileNumber || 'S/N'})
                            </option>
                        ))}
                    </SelectField>

                    <SelectField
                        label="Tipo de Novedad"
                        id="type"
                        value={formData.type}
                        onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value as IAbsencePayload['type'] }))}
                        disabled={isSubmitting}
                        required
                    >
                        {ABSENCE_TYPES.map(type => (
                            <option key={type.value} value={type.value}>{type.label}</option>
                        ))}
                    </SelectField>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <InputField
                            label="Fecha de Inicio"
                            id="startDate"
                            type="date"
                            value={formData.startDate.toISOString().split('T')[0]}
                            onChange={(e) => handleDateChange('startDate', e.target.value)}
                            disabled={isSubmitting}
                            required
                        />
                        <InputField
                            label="Fecha de Fin"
                            id="endDate"
                            type="date"
                            value={formData.endDate.toISOString().split('T')[0]}
                            onChange={(e) => handleDateChange('endDate', e.target.value)}
                            disabled={isSubmitting}
                            required
                        />
                    </div>

                    <InputField
                        label="Raz贸n / Comentarios"
                        id="reason"
                        type="textarea"
                        value={formData.reason}
                        onChange={(e) => setFormData(prev => ({ ...prev, reason: e.target.value }))}
                        rows={3}
                        disabled={isSubmitting}
                        required
                        placeholder="Detalle el motivo de la ausencia..."
                    />
                    
                    <div className="flex justify-end pt-4 border-t border-gray-100">
                        <Button type="submit" disabled={isSubmitting || !formData.employeeId} primary className="w-full md:w-auto">
                            {isSubmitting ? (
                                <span className="flex items-center">
                                    <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    Validando y Registrando...
                                </span>
                            ) : 'Registrar Novedad'}
                        </Button>
                    </div>
                </form>
            </div>
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\admin\client-management.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import toast from 'react-hot-toast';
import { callManageHierarchy } from '@/services/firebase-client.service';
import { IClient } from '@/common/interfaces/client.interface';
import InputField from '@/components/common/InputField';
import SelectField from '@/components/common/SelectField';
import Button from '@/components/common/Button';
import { useClient } from '@/context/ClientContext'; // Para recargar el contexto global al cambiar algo

export function ClientManagement() {
  const { setClient } = useClient(); // Usamos esto para forzar recarga si es necesario
  const [clients, setClients] = useState<IClient[]>([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Estado del Formulario
  const [formData, setFormData] = useState({
    id: '',
    businessName: '',
    cuit: '',
    contactName: '',
    contactEmail: '',
    status: 'Active' as 'Active' | 'Inactive'
  });

  // 1. Cargar Clientes
  const fetchClients = async () => {
    setLoading(true);
    try {
      const res = await callManageHierarchy({ action: 'GET_ALL_CLIENTS', payload: {} });
      const data = (res.data as any).data || [];
      setClients(data);
    } catch (error) {
      console.error(error);
      toast.error("Error al cargar la cartera de clientes.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchClients();
  }, []);

  // 2. Manejadores del Modal
  const handleOpenCreate = () => {
    setFormData({ id: '', businessName: '', cuit: '', contactName: '', contactEmail: '', status: 'Active' });
    setIsEditing(false);
    setShowModal(true);
  };

  const handleOpenEdit = (client: IClient) => {
    setFormData({
      id: client.id,
      businessName: String(client.businessName),
      cuit: String(client.cuit),
      contactName: client.contactName || '',
      contactEmail: String(client.contactEmail || ''),
      status: client.status
    });
    setIsEditing(true);
    setShowModal(true);
  };

  // 3. Guardar (Crear o Editar)
  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    const toastId = toast.loading(isEditing ? "Actualizando..." : "Creando empresa...");

    try {
      if (isEditing) {
        // UPDATE
        await callManageHierarchy({ 
            action: 'UPDATE_CLIENT', 
            payload: { 
                id: formData.id, 
                data: {
                    businessName: formData.businessName,
                    cuit: formData.cuit,
                    contactName: formData.contactName,
                    contactEmail: formData.contactEmail,
                    status: formData.status
                }
            } 
        });
        toast.success("Empresa actualizada", { id: toastId });
      } else {
        // CREATE
        await callManageHierarchy({ 
            action: 'CREATE_CLIENT', 
            payload: {
                businessName: formData.businessName,
                cuit: formData.cuit,
                contactName: formData.contactName,
                contactEmail: formData.contactEmail,
                status: formData.status
            }
        });
        toast.success("Empresa creada exitosamente", { id: toastId });
      }
      
      setShowModal(false);
      fetchClients(); // Recargar lista local
      // Opcional: Recargar contexto global si fuera necesario
      // setClient(''); 

    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`, { id: toastId });
    } finally {
        setIsSubmitting(false);
    }
  };

  // 4. Eliminar
  const handleDelete = async (id: string, name: string) => {
    if (!confirm(`驴Est谩s seguro de eliminar a ${name}? Esto podr铆a romper datos hist贸ricos.`)) return;
    
    const toastId = toast.loading("Eliminando...");
    try {
        await callManageHierarchy({ action: 'DELETE_CLIENT', payload: { id } });
        toast.success("Empresa eliminada", { id: toastId });
        fetchClients();
    } catch (error: any) {
        toast.error(`Error: ${error.message}`, { id: toastId });
    }
  };

  return (
    <div className="space-y-6">
      {/* Header de Secci贸n */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h2 className="text-2xl font-bold text-slate-800">Cartera de Clientes</h2>
            <p className="text-sm text-slate-500">Gestione las empresas contratantes.</p>
        </div>
        <Button onClick={handleOpenCreate} primary className="flex items-center shadow-sm">
            <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
            Nueva Empresa
        </Button>
      </div>

      {/* Tabla Responsiva */}
      <div className="bg-white shadow-sm rounded-xl border border-slate-200 overflow-hidden">
        {loading ? (
            <div className="p-12 text-center text-slate-500 animate-pulse">Cargando cartera...</div>
        ) : (
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Raz贸n Social</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">CUIT / ID</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Contacto</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Estado</th>
                            <th className="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                        {clients.length === 0 && (
                            <tr><td colSpan={5} className="px-6 py-8 text-center text-slate-500 italic">No hay clientes registrados.</td></tr>
                        )}
                        {clients.map((client) => (
                            <tr key={client.id} className="hover:bg-slate-50 transition duration-150">
                                <td className="px-6 py-4 whitespace-nowrap">
                                    <div className="flex items-center">
                                        <div className="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-sm mr-3">
                                            {String(client.businessName).charAt(0)}
                                        </div>
                                        <div className="text-sm font-bold text-slate-900">{client.businessName}</div>
                                    </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-600 font-mono">
                                    {client.cuit}<br/>
                                    <span className="text-[10px] text-slate-400">{client.id.substring(0,8)}...</span>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                    <div className="text-sm text-slate-900">{client.contactName}</div>
                                    <div className="text-xs text-slate-500">{client.contactEmail}</div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                    <span className={`px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                        client.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }`}>
                                        {client.status === 'Active' ? 'Activo' : 'Inactivo'}
                                    </span>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button onClick={() => handleOpenEdit(client)} className="text-indigo-600 hover:text-indigo-900 mr-4 font-semibold">Editar</button>
                                    <button onClick={() => handleDelete(client.id, String(client.businessName))} className="text-rose-600 hover:text-rose-900 font-semibold">Eliminar</button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        )}
      </div>

      {/* Modal CRUD */}
      {showModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6 border border-slate-100 transform transition-all">
                <div className="flex justify-between items-center mb-6">
                    <h3 className="text-xl font-bold text-slate-800">{isEditing ? 'Editar Empresa' : 'Nueva Empresa'}</h3>
                    <button onClick={() => setShowModal(false)} className="text-slate-400 hover:text-slate-600">
                        <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                
                <form onSubmit={handleSave} className="space-y-4">
                    <InputField 
                        label="Raz贸n Social" 
                        id="businessName" 
                        value={formData.businessName} 
                        onChange={e => setFormData({...formData, businessName: e.target.value})} 
                        placeholder="Ej: Seguridad Integral S.A."
                        required 
                    />
                    
                    <div className="grid grid-cols-2 gap-4">
                        <InputField 
                            label="CUIT" 
                            id="cuit" 
                            value={formData.cuit} 
                            onChange={e => setFormData({...formData, cuit: e.target.value})} 
                            placeholder="30-12345678-9"
                            required 
                        />
                        <SelectField 
                            label="Estado" 
                            id="status" 
                            value={formData.status} 
                            onChange={e => setFormData({...formData, status: e.target.value as any})}
                        >
                            <option value="Active">Activo</option>
                            <option value="Inactive">Inactivo</option>
                        </SelectField>
                    </div>

                    <div className="pt-4 border-t border-slate-100">
                        <h4 className="text-sm font-semibold text-slate-500 uppercase mb-3">Datos de Contacto</h4>
                        <div className="space-y-4">
                            <InputField 
                                label="Nombre Contacto" 
                                id="contactName" 
                                value={formData.contactName} 
                                onChange={e => setFormData({...formData, contactName: e.target.value})} 
                                placeholder="Ej: Juan Gerente"
                            />
                            <InputField 
                                label="Email Contacto" 
                                id="contactEmail" 
                                type="email"
                                value={formData.contactEmail} 
                                onChange={e => setFormData({...formData, contactEmail: e.target.value})} 
                                placeholder="contacto@empresa.com"
                            />
                        </div>
                    </div>

                    <div className="flex justify-end space-x-3 mt-8 pt-2">
                        <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 font-medium transition-colors">
                            Cancelar
                        </button>
                        <Button type="submit" primary disabled={isSubmitting}>
                            {isSubmitting ? 'Guardando...' : 'Guardar Empresa'}
                        </Button>
                    </div>
                </form>
            </div>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\client-setup-wizard.tsx
================================================================================
import React, { useState } from 'react';
import { useRouter } from 'next/router'; //  FIX: Usar router de Next.js para navegaci贸n segura
import { callManageHierarchy } from '@/services/firebase-client.service';
import toast from 'react-hot-toast';

// Interfaces locales para el estado del formulario
interface ShiftTypeUI {
  name: string;
  code: string;
  startTime: string;
  durationHours: number;
}

export function ClientSetupWizard() {
  const router = useRouter(); // Hook de navegaci贸n
  const [step, setStep] = useState(1);
  const [loading, setLoading] = useState(false);
  
  // IDs generados por el backend a medida que avanzamos
  const [ids, setIds] = useState({ clientId: '', objectiveId: '', contractId: '' });

  // Listado visual de modalidades agregadas en el paso 4
  const [addedShifts, setAddedShifts] = useState<ShiftTypeUI[]>([]);

  // Datos de Formularios
  const [clientData, setClientData] = useState({ businessName: '', cuit: '', contactName: '', contactEmail: '' });
  const [objData, setObjData] = useState({ name: '', address: '', latitude: '', longitude: '' });
  const [contractData, setContractData] = useState({ name: '', totalHoursPerMonth: 720 });
  
  // Datos del formulario de Modalidad actual
  const [shiftData, setShiftData] = useState<ShiftTypeUI>({ 
    name: 'Turno Ma帽ana', 
    code: 'TM', 
    startTime: '06:00', 
    durationHours: 8 
  });

  // --- PASO 1: CREAR CLIENTE ---
  const handleCreateClient = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const res = await callManageHierarchy({ action: 'CREATE_CLIENT', payload: { ...clientData, status: 'Active' } });
      const data = res.data as any;
      setIds(prev => ({ ...prev, clientId: data.data.id }));
      toast.success("Empresa creada correctamente");
      setStep(2);
    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- PASO 2: CREAR OBJETIVO ---
  const handleCreateObjective = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const payload = {
        ...objData,
        clientId: ids.clientId,
        location: { latitude: Number(objData.latitude), longitude: Number(objData.longitude) },
        type: 'Sede'
      };
      const res = await callManageHierarchy({ action: 'CREATE_OBJECTIVE', payload });
      const data = res.data as any;
      setIds(prev => ({ ...prev, objectiveId: data.data.id }));
      toast.success("Objetivo vinculado");
      setStep(3);
    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- PASO 3: CREAR CONTRATO ---
  const handleCreateContract = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const payload = {
        ...contractData,
        objectiveId: ids.objectiveId,
        startDate: new Date(),
        isActive: true
      };
      const res = await callManageHierarchy({ action: 'CREATE_CONTRACT', payload });
      const data = res.data as any;
      setIds(prev => ({ ...prev, contractId: data.data.id }));
      toast.success("Contrato generado");
      setStep(4);
    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- PASO 4: CREAR TIPO DE TURNO (MODALIDAD) ---
  const handleCreateShiftType = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const payload = { ...shiftData, contractId: ids.contractId, color: '#3B82F6' };
      
      // Llamada al Backend
      await callManageHierarchy({ action: 'CREATE_SHIFT_TYPE', payload });
      
      toast.success(`Modalidad "${shiftData.name}" agregada`);
      
      // 1. Agregamos a la lista visual de abajo para feedback
      setAddedShifts(prev => [...prev, shiftData]);
      
      // 2. Reseteamos el formulario para cargar el siguiente r谩pidamente
      setShiftData({ 
        name: '', 
        code: '', 
        startTime: '14:00', // Sugerencia de siguiente horario
        durationHours: 8 
      });

    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- ACCIN FINAL ---
  const handleFinish = () => {
    toast.success("Configuraci贸n finalizada con 茅xito.");
    //  FIX: Navegaci贸n segura de Next.js
    router.push('/admin/dashboard');
  };

  // Estilos reutilizables
  const inputClass = "w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 px-3 border mt-1";
  const labelClass = "block text-sm font-medium text-gray-700";
  const btnClass = "w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 font-medium shadow-sm";

  return (
    <div className="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
      
      {/* Barra de Progreso */}
      <div className="flex justify-between mb-8 relative">
        <div className="absolute top-1/2 left-0 w-full h-1 bg-gray-100 -z-10 rounded"></div>
        {[1, 2, 3, 4].map(num => (
            <div key={num} className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm transition-colors border-4 border-white ${step >= num ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-500'}`}>
                {num}
            </div>
        ))}
      </div>

      {step === 1 && (
        <form onSubmit={handleCreateClient} className="space-y-4 animate-fadeIn">
            <div className="border-b pb-4 mb-4">
                <h2 className="text-xl font-bold text-gray-800"> Paso 1: Datos de la Empresa</h2>
                <p className="text-sm text-gray-500">Registre la raz贸n social del cliente.</p>
            </div>
            <div><label className={labelClass}>Raz贸n Social</label><input className={inputClass} value={clientData.businessName} onChange={e => setClientData({...clientData, businessName: e.target.value})} required placeholder="Ej: Banco Galicia S.A." /></div>
            <div><label className={labelClass}>CUIT</label><input className={inputClass} value={clientData.cuit} onChange={e => setClientData({...clientData, cuit: e.target.value})} required placeholder="30-12345678-9" /></div>
            <button type="submit" disabled={loading} className={btnClass}>{loading ? 'Guardando...' : 'Guardar y Continuar'}</button>
        </form>
      )}

      {step === 2 && (
        <form onSubmit={handleCreateObjective} className="space-y-4 animate-fadeIn">
            <div className="border-b pb-4 mb-4">
                <h2 className="text-xl font-bold text-gray-800"> Paso 2: Crear Sede / Objetivo</h2>
                <p className="text-sm text-gray-500">Defina la ubicaci贸n f铆sica del servicio.</p>
            </div>
            <div><label className={labelClass}>Nombre del Objetivo</label><input className={inputClass} value={objData.name} onChange={e => setObjData({...objData, name: e.target.value})} required placeholder="Ej: Sucursal Centro" /></div>
            <div><label className={labelClass}>Direcci贸n</label><input className={inputClass} value={objData.address} onChange={e => setObjData({...objData, address: e.target.value})} required /></div>
            <div className="grid grid-cols-2 gap-4">
                <div><label className={labelClass}>Latitud</label><input type="number" className={inputClass} value={objData.latitude} onChange={e => setObjData({...objData, latitude: e.target.value})} required step="any"/></div>
                <div><label className={labelClass}>Longitud</label><input type="number" className={inputClass} value={objData.longitude} onChange={e => setObjData({...objData, longitude: e.target.value})} required step="any"/></div>
            </div>
            <button type="submit" disabled={loading} className={btnClass}>{loading ? 'Vinculando...' : 'Guardar y Continuar'}</button>
        </form>
      )}

      {step === 3 && (
        <form onSubmit={handleCreateContract} className="space-y-4 animate-fadeIn">
            <div className="border-b pb-4 mb-4">
                <h2 className="text-xl font-bold text-gray-800"> Paso 3: Definir Contrato</h2>
                <p className="text-sm text-gray-500">Establezca el acuerdo comercial y horas vendidas.</p>
            </div>
            <div><label className={labelClass}>Nombre del Servicio</label><input className={inputClass} value={contractData.name} onChange={e => setContractData({...contractData, name: e.target.value})} placeholder="Ej: Seguridad 24hs - 2025" required /></div>
            <div><label className={labelClass}>Horas Mensuales Vendidas</label><input type="number" className={inputClass} value={contractData.totalHoursPerMonth} onChange={e => setContractData({...contractData, totalHoursPerMonth: Number(e.target.value)})} required /></div>
            <button type="submit" disabled={loading} className={btnClass}>{loading ? 'Generando...' : 'Generar Contrato'}</button>
        </form>
      )}

      {step === 4 && (
        <div className="space-y-6 animate-fadeIn">
            <div className="text-center bg-green-50 p-4 rounded-lg border border-green-100">
                <h2 className="text-xl font-bold text-green-800">隆Estructura Base Creada!</h2>
                <p className="text-green-600 text-sm">Ahora define la "receta" de turnos (modalidades) para este contrato.</p>
            </div>

            <div className="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-inner">
                <h3 className="font-bold text-gray-700 mb-4 flex items-center">
                    <span className="bg-indigo-100 text-indigo-700 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">+</span>
                    Agregar Nueva Modalidad
                </h3>
                <div className="grid grid-cols-2 gap-4 mb-4">
                    <div><label className={labelClass}>Nombre</label><input className={inputClass} value={shiftData.name} onChange={e => setShiftData({...shiftData, name: e.target.value})} placeholder="Ej: Turno Tarde" /></div>
                    <div><label className={labelClass}>C贸digo</label><input className={inputClass} value={shiftData.code} onChange={e => setShiftData({...shiftData, code: e.target.value})} placeholder="TT" /></div>
                    <div><label className={labelClass}>Inicio (HH:mm)</label><input type="time" className={inputClass} value={shiftData.startTime} onChange={e => setShiftData({...shiftData, startTime: e.target.value})} /></div>
                    <div><label className={labelClass}>Duraci贸n (hs)</label><input type="number" className={inputClass} value={shiftData.durationHours} onChange={e => setShiftData({...shiftData, durationHours: Number(e.target.value)})} /></div>
                </div>
                <button 
                    onClick={handleCreateShiftType} 
                    disabled={loading || !shiftData.name} 
                    className="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition font-medium shadow-sm flex justify-center items-center"
                >
                    {loading ? 'Guardando...' : '+ Agregar Modalidad a la Lista'}
                </button>
            </div>

            {/* LISTA VISUAL DE LO CARGADO */}
            {addedShifts.length > 0 && (
                <div className="border rounded-lg overflow-hidden shadow-sm">
                    <div className="bg-gray-100 px-4 py-2 border-b font-semibold text-gray-700 text-sm flex justify-between items-center">
                        <span>Modalidades Cargadas</span>
                        <span className="bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full text-xs">{addedShifts.length}</span>
                    </div>
                    <ul className="divide-y divide-gray-100 bg-white">
                        {addedShifts.map((shift, index) => (
                            <li key={index} className="px-4 py-3 flex justify-between items-center text-sm hover:bg-gray-50">
                                <div>
                                    <span className="font-bold text-gray-800">{shift.name}</span>
                                    <span className="ml-2 text-gray-500 font-mono text-xs">({shift.code})</span>
                                </div>
                                <div className="text-gray-600 bg-gray-100 px-2 py-1 rounded">
                                    {shift.startTime} <span className="mx-1"></span> {shift.durationHours}hs
                                </div>
                            </li>
                        ))}
                    </ul>
                </div>
            )}
            
            <button onClick={handleFinish} className="w-full border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 font-bold transition mt-4 shadow-sm">
                Finalizar y Volver al Dashboard
            </button>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\employee-management.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { callManageEmployees, callCreateUser } from '@/services/firebase-client.service';
import { IEmployee } from '@/common/interfaces/employee.interface';
import toast from 'react-hot-toast';
import { useClient } from '@/context/ClientContext'; 
import InputField from '@/components/common/InputField';
import SelectField from '@/components/common/SelectField';
import Button from '@/components/common/Button'; // Usamos tu componente Button

export function EmployeeManagement() {
  const { clients, selectedClientId } = useClient(); 
  const [employees, setEmployees] = useState<IEmployee[]>([]);
  const [loading, setLoading] = useState(true);
  
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Estado del Formulario
  const [formData, setFormData] = useState({
    uid: '',
    name: '',
    email: '',
    password: '',
    role: 'employee',
    maxHoursPerMonth: 176,
    contractType: 'FullTime',
    isAvailable: true,
    clientId: '', 
    dni: '',
    fileNumber: '',
    address: ''
  });

  // 1. Cargar Empleados (Pool Global)
  const fetchEmployees = async () => {
    setLoading(true);
    try {
      const res = await callManageEmployees({ 
          action: 'GET_ALL_EMPLOYEES', 
          payload: {} 
      });
      const data = (res.data as any).data || [];
      setEmployees(data);
    } catch (error) {
      console.error(error);
      toast.error("Error al cargar la n贸mina.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchEmployees();
  }, []); 

  // Helper para nombre de cliente
  const getClientName = (id?: string) => {
      if (!id) return <span className="text-gray-400 italic">Sin Asignar (Pool)</span>;
      const client = clients.find(c => c.id === id);
      return client ? (
          <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800">
              {client.businessName}
          </span>
      ) : <span className="text-red-400">Cliente desconocido</span>;
  };

  // Abrir modal CREAR
  const handleOpenCreate = () => {
    setFormData({ 
        uid: '', name: '', email: '', password: '', role: 'employee', 
        maxHoursPerMonth: 176, contractType: 'FullTime', isAvailable: true,
        clientId: selectedClientId || '', 
        dni: '', fileNumber: '', address: ''
    });
    setIsEditing(false);
    setShowModal(true);
  };

  // Abrir modal EDITAR
  const handleOpenEdit = (emp: IEmployee) => {
    setFormData({
        uid: emp.uid,
        name: emp.name,
        email: emp.email,
        password: '', 
        role: emp.role as string,
        maxHoursPerMonth: emp.maxHoursPerMonth || 176,
        contractType: emp.contractType || 'FullTime',
        isAvailable: emp.isAvailable,
        clientId: emp.clientId || '',
        dni: emp.dni || '',
        fileNumber: emp.fileNumber || '',
        address: emp.address || ''
    });
    setIsEditing(true);
    setShowModal(true);
  };

  // Guardar
  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    const toastId = toast.loading(isEditing ? "Actualizando..." : "Creando recurso...");

    try {
      if (isEditing) {
        // UPDATE
        const updatePayload = {
            name: formData.name,
            role: formData.role,
            maxHoursPerMonth: Number(formData.maxHoursPerMonth),
            contractType: formData.contractType,
            isAvailable: formData.isAvailable,
            clientId: formData.clientId,
            dni: formData.dni,
            fileNumber: formData.fileNumber,
            address: formData.address
        };
        await callManageEmployees({ action: 'UPDATE_EMPLOYEE', payload: { uid: formData.uid, data: updatePayload } });
        toast.success("Datos actualizados", { id: toastId });
      } else {
        // CREATE
        await callCreateUser({ 
            email: formData.email, 
            password: formData.password, 
            name: formData.name, 
            role: formData.role,
            clientId: formData.clientId,
            dni: formData.dni,
            fileNumber: formData.fileNumber,
            address: formData.address
        });
        toast.success("Empleado creado exitosamente", { id: toastId });
      }
      
      setShowModal(false);
      fetchEmployees();

    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`, { id: toastId });
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleDelete = async (uid: string) => {
    if (!confirm("驴Eliminar este empleado? Esta acci贸n borrar谩 su acceso.")) return;
    try {
        await callManageEmployees({ action: 'DELETE_EMPLOYEE', payload: { uid } });
        toast.success("Empleado eliminado");
        fetchEmployees();
    } catch (error) {
        toast.error("Error al eliminar");
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-xl font-bold text-gray-800">N贸mina Global de Personal</h2>
            <p className="text-sm text-gray-500">Gesti贸n del pool de recursos de la agencia.</p>
        </div>
        <Button onClick={handleOpenCreate} primary className="flex items-center shadow-sm">
            <span className="mr-2 text-lg">+</span> Nuevo Recurso
        </Button>
      </div>

      {/* Tabla */}
      <div className="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
        <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                    <tr>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Legajo / Nombre</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Asignaci贸n</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">DNI / Contacto</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Estado</th>
                        <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Acciones</th>
                    </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                    {employees.map((emp) => (
                        <tr key={emp.uid} className="hover:bg-gray-50 transition-colors">
                            <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-xs text-gray-400 font-mono mb-0.5">#{emp.fileNumber || 'S/N'}</div>
                                <div className="text-sm font-bold text-gray-900">{emp.name}</div>
                                <div className="text-xs text-indigo-600 capitalize">{emp.role}</div>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap">
                                {getClientName(emp.clientId)}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm text-gray-900">{emp.dni || '-'}</div>
                                <div className="text-xs text-gray-500 truncate max-w-[150px]" title={emp.address}>{emp.address || '-'}</div>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm">
                                {emp.isAvailable ? 
                                    <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Activo</span> : 
                                    <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">Inactivo</span>
                                }
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onClick={() => handleOpenEdit(emp)} className="text-indigo-600 hover:text-indigo-900 mr-4 font-semibold">Editar</button>
                                <button onClick={() => handleDelete(emp.uid)} className="text-rose-600 hover:text-rose-900 font-semibold">Baja</button>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
            {!loading && employees.length === 0 && (
                <div className="p-12 text-center text-gray-500 flex flex-col items-center">
                    <p>No hay empleados registrados en el sistema.</p>
                </div>
            )}
        </div>
      </div>

      {/* Modal Formulario */}
      {showModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 border border-gray-100 transform transition-all">
                <div className="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                    <h3 className="text-xl font-bold text-gray-800">{isEditing ? 'Editar Ficha' : 'Alta de Personal'}</h3>
                    <button onClick={() => setShowModal(false)} className="text-gray-400 hover:text-gray-600"></button>
                </div>
                
                <form onSubmit={handleSave} className="grid grid-cols-1 md:grid-cols-2 gap-5">
                    
                    {/* Secci贸n 1: Datos Personales */}
                    <div className="md:col-span-2">
                        <h4 className="text-xs font-bold text-indigo-600 uppercase tracking-wider mb-3">Informaci贸n Personal</h4>
                    </div>

                    <InputField label="Nombre Completo" id="name" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required />
                    <InputField label="DNI" id="dni" value={formData.dni} onChange={e => setFormData({...formData, dni: e.target.value})} required placeholder="Sin puntos" />
                    <div className="md:col-span-2">
                        <InputField label="Direcci贸n Real" id="address" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} required />
                    </div>

                    {/* Secci贸n 2: Datos de Cuenta (Solo crear) */}
                    {!isEditing && (
                        <>
                            <div className="md:col-span-2 mt-2">
                                <h4 className="text-xs font-bold text-indigo-600 uppercase tracking-wider mb-3">Acceso al Sistema</h4>
                            </div>
                            <InputField label="Email" id="email" type="email" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required />
                            <InputField label="Contrase帽a Inicial" id="password" type="password" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} required />
                        </>
                    )}

                    {/* Secci贸n 3: Datos Laborales */}
                    <div className="md:col-span-2 mt-2">
                        <h4 className="text-xs font-bold text-indigo-600 uppercase tracking-wider mb-3">Contrataci贸n y Asignaci贸n</h4>
                    </div>

                    <InputField label="Nro. Legajo" id="fileNumber" value={formData.fileNumber} onChange={e => setFormData({...formData, fileNumber: e.target.value})} required />

                    <SelectField label="Empresa Principal (Opcional)" id="clientId" value={formData.clientId} onChange={e => setFormData({...formData, clientId: e.target.value})}>
                        <option value="">-- Sin Asignaci贸n (Pool) --</option>
                        {clients.map(c => <option key={c.id} value={c.id}>{c.businessName}</option>)}
                    </SelectField>

                    <SelectField label="Rol" id="role" value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})}>
                        <option value="employee">Vigilador / Operario</option>
                        <option value="admin">Administrativo</option>
                    </SelectField>

                    <SelectField label="Modalidad" id="contract" value={formData.contractType} onChange={e => setFormData({...formData, contractType: e.target.value})}>
                        <option value="FullTime">Full Time</option>
                        <option value="PartTime">Part Time</option>
                        <option value="Eventual">Eventual</option>
                    </SelectField>

                    <InputField label="L铆mite Horas Mensual" id="maxHours" type="number" value={formData.maxHoursPerMonth} onChange={e => setFormData({...formData, maxHoursPerMonth: Number(e.target.value)})} required />

                    {/* Footer de Acciones - Aqu铆 estaba el error */}
                    <div className="md:col-span-2 flex justify-end space-x-3 mt-6 border-t pt-4">
                        <button type="button" onClick={() => setShowModal(false)} className="px-5 py-2.5 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium transition">
                            Cancelar
                        </button>
                        
                        {/*  FIX: Usamos el componente Button importado correctamente */}
                        <Button type="submit" primary disabled={isSubmitting}>
                            {isSubmitting ? 'Guardando...' : 'Guardar Ficha'}
                        </Button>
                    </div>
                </form>
            </div>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\GeocodingSelector.tsx
================================================================================
import React, { useState } from 'react';
import toast from 'react-hot-toast';

interface GeocodingSelectorProps {
  address: string;
  onCoordinatesSelected: (lat: string, lng: string) => void;
  onClose: () => void;
  isOpen: boolean;
}

/**
 * Componente Modal para buscar coordenadas geogr谩ficas a partir de una direcci贸n.
 * Utiliza la API de Geocodificaci贸n de Google Maps.
 */
export const GeocodingSelector: React.FC<GeocodingSelectorProps> = ({ address, onCoordinatesSelected, onClose, isOpen }) => {
  const [loading, setLoading] = useState(false);
  // Acceso seguro a la clave de API configurada en .env.local
  const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY; 

  if (!isOpen) return null;

  /**
   * Fetches coordinates for the given address using Google's Geocoding API.
   */
  const fetchCoordinates = async () => {
    if (!address.trim()) {
      toast.error("Ingrese una direcci贸n v谩lida para buscar.");
      return;
    }
    // Verificaci贸n de seguridad
    if (!apiKey || apiKey.trim() === '') {
      toast.error("Error: Falta la clave de Google Maps (NEXT_PUBLIC_GOOGLE_MAPS_API_KEY).");
      console.error("GeocodingSelector: Missing Google Maps API Key.");
      return;
    }

    setLoading(true);
    const encodedAddress = encodeURIComponent(address);
    const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${apiKey}`;

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (data.status === 'OK' && data.results.length > 0) {
        const { lat, lng } = data.results[0].geometry.location;
        
        // Mantenemos la alta precisi贸n para el estado del formulario
        const latString = lat.toFixed(6); 
        const lngString = lng.toFixed(6);

        onCoordinatesSelected(latString, lngString);
        toast.success(`Coordenadas asignadas a: ${address}`);
        onClose();
      } else {
        toast.error("No se encontraron coordenadas para la direcci贸n proporcionada.");
      }
    } catch (error) {
      console.error("Error al consultar la API de Google:", error);
      toast.error("Error de red al buscar coordenadas.");
    } finally {
      setLoading(false);
    }
  };
  
  // Estructura del Modal (usando Tailwind)
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-xl font-bold mb-4 text-gray-800">Buscar Coordenadas</h3>
        <p className="text-sm text-gray-600 mb-4">
          Direcci贸n a buscar: <span className="font-semibold text-indigo-600">{address}</span>
        </p>
        
        <button
          onClick={fetchCoordinates}
          disabled={loading || !address.trim()}
          className={`w-full py-2 px-4 rounded-md text-white font-medium transition duration-200 ${
            loading || !address.trim() ? 'bg-indigo-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'
          }`}
        >
          {loading ? 'Buscando...' : 'Confirmar B煤squeda en Mapa'}
        </button>
        
        <button
          onClick={onClose}
          className="mt-3 w-full py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-200"
        >
          Cancelar
        </button>
      </div>
    </div>
  );
};

================================================================================
FILE: apps\web\src\components\admin\login-form.tsx
================================================================================
import React, { useState } from 'react';
import { useRouter } from 'next/router';
import { signInWithEmailAndPassword } from 'firebase/auth';
import { auth } from '@/services/firebase-client.service';

export function LoginForm() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  // Colores personalizados basados en la imagen de referencia (Rojo ATM)
  const colors = {
    primary: '#a81d1d', // Rojo intenso
    primaryHover: '#8c1818',
    bgInput: '#eff4fc', // Fondo azul muy claro de los inputs
    textGray: '#6b7280',
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      await signInWithEmailAndPassword(auth, email, password);
      router.push('/admin/dashboard');
    } catch (err: any) {
        console.error(err);
        if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
            setError('Credenciales incorrectas. Verifique email y contrase帽a.');
        } else if (err.code === 'auth/too-many-requests') {
            setError('Demasiados intentos. Por favor espere unos minutos.');
        } else {
            setError('Error al iniciar sesi贸n. Intente nuevamente.');
        }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="w-full max-w-md mx-auto">
      {/* Tarjeta de Login con sombra suave y bordes redondeados */}
      <div className="bg-white shadow-xl rounded-3xl px-8 pt-10 pb-12 mb-4 border border-gray-50 relative overflow-hidden">
        
        {/* Logo (Placeholder textual, puedes reemplazar por una etiqueta <img> si tienes el logo en /public) */}
        <div className="text-center mb-8">
            <div className="inline-flex flex-col items-center justify-center mb-4">
                {/* Icono/Logo Simulado en Rojo */}
                <div className="bg-red-50 p-3 rounded-full">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" style={{ color: colors.primary }} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                  </svg>
                </div>
                <h2 className="text-2xl font-extrabold text-gray-900 mt-4">Sistema de Gesti贸n</h2>
            </div>
            <p className="text-sm text-gray-500">Inicia sesi贸n para acceder al panel.</p>
        </div>
        
        <form onSubmit={handleSubmit}>
            {/* Banner de Error Estilizado */}
            {error && (
                <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r-md animate-pulse">
                    <div className="flex items-center">
                        <svg className="h-5 w-5 text-red-500 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                        </svg>
                        <p className="text-sm text-red-700 font-medium">{error}</p>
                    </div>
                </div>
            )}
            
            {/* Input Email con Icono */}
            <div className="mb-5 relative">
              <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                  <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                </svg>
              </div>
              <input
                className="appearance-none rounded-xl w-full py-4 pl-12 pr-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-200 transition duration-200 font-medium placeholder-gray-400"
                style={{ backgroundColor: colors.bgInput, border: '1px solid transparent' }}
                id="email"
                type="email"
                placeholder="admin@bacarsa.com.ar"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
              />
            </div>

            {/* Input Password con Icono */}
            <div className="mb-8 relative">
              <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                 <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
                  </svg>
              </div>
              <input
                className="appearance-none rounded-xl w-full py-4 pl-12 pr-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-200 transition duration-200 font-medium placeholder-gray-400 tracking-widest"
                style={{ backgroundColor: colors.bgInput, border: '1px solid transparent' }}
                id="password"
                type="password"
                placeholder="⑩⑩⑩⑩⑩⑩⑩"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
              />
            </div>

            {/* Bot贸n Submit */}
            <button
                className={`w-full text-white font-bold py-4 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-300 flex justify-center items-center text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
                style={{ backgroundColor: loading ? colors.primaryHover : colors.primary }}
                type="submit"
                disabled={loading}
            >
                {loading ? (
                    <>
                        <svg className="animate-spin -ml-1 mr-3 h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Accediendo...
                    </>
                ) : 'Acceder al Sistema'}
            </button>
        </form>
      </div>
      
      <p className="text-center text-gray-400 text-sm mt-6 font-medium">
        Ver 3.0 Beta
      </p>
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\new.tsx
================================================================================
// Archivo: ./src/components/admin/new.tsx (o la p谩gina asociada)

import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
//  FIX CRTICO: Importamos DashboardLayout por defecto (SIN LLAVES)
import DashboardLayout from '@/components/layout/DashboardLayout'; 
import { ClientSetupWizard } from '@/components/admin/client-setup-wizard';

function NewClientPage() {
    return (
        <DashboardLayout title="Alta de Cliente y Servicio">
            <div className="py-6">
                <ClientSetupWizard />
            </div>
        </DashboardLayout>
    );
}

// Exportaci贸n protegida (asumo roles de administraci贸n)
export default withAuthGuard(NewClientPage, ['admin']);

================================================================================
FILE: apps\web\src\components\admin\objective-management.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/router'; //  NECESARIO para la navegaci贸n de la tabla
import { callManageData } from '@/services/firebase-client.service';
import { IObjective } from '@/common/interfaces/client.interface';
import { useClient } from '@/context/ClientContext';
import toast from 'react-hot-toast';
import { GeocodingSelector } from './GeocodingSelector'; 
import styles from './ObjectiveManagement.module.css'; // Para cumplir con Next.js


// -- 1. INTERFACES Y CONSTANTES (Sin cambios) --
interface ObjectiveFormState {
  name: string;
  address: string;
  latitude: string; 
  longitude: string;
}

const STYLES = {
    inputClass: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-200",
    readOnlyInputClass: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none bg-gray-50 text-gray-500 cursor-not-allowed sm:text-sm transition duration-200",
    labelClass: "block text-sm font-medium text-gray-700",
    buttonDisabled: "opacity-70 cursor-not-allowed",
    buttonActive: "hover:bg-indigo-700",
};

const cleanAndParseCoordinate = (coordString: string): number => {
    const cleanedString = coordString.trim().replace(',', '.'); 
    return parseFloat(cleanedString);
};


export function ObjectiveManagement() {
  const router = useRouter(); //  Instancia del router
  const { selectedClientId, selectedClient } = useClient();

  const [objectives, setObjectives] = useState<IObjective[]>([]);
  const [isSelectorOpen, setIsSelectorOpen] = useState(false); 
  
  const [formData, setFormData] = useState<ObjectiveFormState>({
    name: '', address: '', latitude: '', longitude: '',
  });
  
  const [loading, setLoading] = useState(false);
  const [submitting, setSubmitting] = useState(false);

  /**
   * Carga de objetivos.
   */
  const fetchObjectives = async () => {
    if (!selectedClientId) {
        setObjectives([]);
        return;
    }
    setLoading(true);
    try {
      const result = await callManageData({ 
          action: 'GET_ALL_OBJECTIVES', 
          payload: { clientId: selectedClientId } 
      });
      const response = result.data as { success: boolean, data: IObjective[] };
      setObjectives(response.data || []);
      
    } catch (error) {
      console.error('[ObjectiveManagement] Fetch Error:', error);
      toast.error("Error al cargar objetivos");
    } finally { 
      setLoading(false); 
    }
  };

  useEffect(() => {
    fetchObjectives();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedClientId]);

  /**
   * Maneja el cambio en los inputs name y address.
   */
  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    if (name === 'name' || name === 'address') {
        setFormData(prev => ({ ...prev, [name]: value }));
    }
  };

  /**
   * Callback que recibe las coordenadas desde el GeocodingSelector y actualiza el estado.
   */
  const handleCoordinatesSelected = (lat: string, lng: string) => {
      setFormData(prev => ({
          ...prev,
          latitude: lat,
          longitude: lng,
      }));
      setIsSelectorOpen(false); // Cerramos el modal
  };

  /**
   * Valida y env铆a la creaci贸n del objetivo.
   */
  const handleCreateObjective = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // 1. Pre-Submission Checks
    if (!selectedClientId) {
        toast.error("锔 Debe seleccionar una empresa en el men煤 lateral.");
        return;
    }
    
    // Chequeo estricto de todos los campos obligatorios
    if (!formData.name.trim() || 
        !formData.address.trim() ||
        !formData.latitude.trim() || 
        !formData.longitude.trim() 
    ) {
        toast.error("Complete todos los campos obligatorios: Nombre, Direcci贸n y Coordenadas.");
        return;
    }
    
    // 2. Parsing y Validaci贸n
    const lat = cleanAndParseCoordinate(formData.latitude);
    const lng = cleanAndParseCoordinate(formData.longitude);

    if (isNaN(lat) || isNaN(lng)) { 
        toast.error("Las coordenadas deben ser n煤meros v谩lidos (ej: -34.60)."); 
        return; 
    }

    // 3. Submission Logic
    setSubmitting(true);
    try {
      const payload = { 
          name: formData.name.trim(),
          address: formData.address.trim(),
          clientId: selectedClientId,
          location: { latitude: lat, longitude: lng } 
      };
      
      await callManageData({ action: 'CREATE_OBJECTIVE', payload });
      
      toast.success(`Objetivo "${formData.name}" creado para ${selectedClient?.businessName}`);
      setFormData({ name: '', address: '', latitude: '', longitude: '' });
      fetchObjectives();

    } catch (error) { 
        console.error('[ObjectiveManagement] Create Error:', error);
        toast.error("Error al crear el objetivo."); 
    } finally { 
        setSubmitting(false); 
    }
  };


  return (
    <div className="space-y-8">
      {/* --- FORMULARIO (Secci贸n 1) --- */}
      <div className="bg-white shadow-lg rounded-2xl p-6 border border-gray-200">
        {/* ... Header del formulario ... */}
        
        <form onSubmit={handleCreateObjective} noValidate className="space-y-4">
          <div>
            <label className={STYLES.labelClass}>Nombre de la Sucursal/Puesto</label>
            <input 
                type="text" 
                name="name" 
                value={formData.name} 
                onChange={handleInputChange} 
                className={STYLES.inputClass} 
                placeholder="Ej: Casa Central" 
            />
          </div>
          <div>
            <label className={STYLES.labelClass}>Direcci贸n F铆sica</label>
            <input 
                type="text" 
                name="address" 
                value={formData.address} 
                onChange={handleInputChange} 
                className={STYLES.inputClass} 
                placeholder="Av. Siempreviva 742" 
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
                <label className={STYLES.labelClass}>Latitud</label>
                <input 
                    type="number" 
                    name="latitude" 
                    value={formData.latitude} 
                    onChange={handleInputChange} 
                    className={STYLES.readOnlyInputClass} 
                    readOnly={true} // Deshabilitar escritura manual
                    step="any" 
                    placeholder="Asignar con el bot贸n" 
                />
            </div>
            <div>
                <label className={STYLES.labelClass}>Longitud</label>
                <input 
                    type="number" 
                    name="longitude" 
                    value={formData.longitude} 
                    onChange={handleInputChange} 
                    className={STYLES.readOnlyInputClass} 
                    readOnly={true} // Deshabilitar escritura manual
                    step="any" 
                    placeholder="Asignar con el bot贸n" 
                />
            </div>
          </div>
          
          {/* Bot贸n para Activar la B煤squeda de Coordenadas */}
          <button 
              type="button" 
              onClick={() => setIsSelectorOpen(true)}
              disabled={!formData.address.trim()} 
              className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none transition duration-200 
                  ${!formData.address.trim() ? 'opacity-70 cursor-not-allowed' : ''}`}
          >
              Buscar/Asignar Coordenadas (Paso 1)
          </button>

          {/* Bot贸n Final de Creaci贸n */}
          <button 
            type="submit" 
            disabled={submitting || !selectedClientId || !formData.latitude.trim()} 
            className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 focus:outline-none transition duration-200 
                ${submitting || !selectedClientId || !formData.latitude.trim() ? STYLES.buttonDisabled : STYLES.buttonActive}`}
          >
            {submitting ? 'Guardando...' : 'Crear Objetivo (Paso 2)'}
          </button>
        </form>
      </div>

      {/* INTEGRACIN DEL MODAL DE GEOCODIFICACIN */}
      <GeocodingSelector 
          address={formData.address}
          isOpen={isSelectorOpen}
          onClose={() => setIsSelectorOpen(false)}
          onCoordinatesSelected={handleCoordinatesSelected}
      />
      
      {/* --- LISTADO DE OBJETIVOS (Secci贸n 2) --- */}
      <div className={`${styles.objectiveListCard} bg-white shadow-lg rounded-2xl overflow-hidden border border-gray-200`}>
        <div className="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
            <h3 className="text-lg font-bold text-gray-800">
                Objetivos de {selectedClient?.businessName || '...'}
            </h3>
            <span className="bg-gray-100 text-gray-600 py-1 px-3 rounded-full text-xs font-bold">{objectives.length}</span>
        </div>
        {loading ? <div className="p-6 text-center text-gray-500">Cargando datos...</div> : (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-100">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Nombre y Ubicaci贸n</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {objectives.length === 0 ? (
                    <tr><td className="px-6 py-8 text-center text-sm text-gray-500 italic">No hay objetivos registrados para esta empresa.</td></tr>
                ) : (
                    objectives.map((obj) => (
                    <tr 
                        key={obj.id} 
                        //  FIX DE NAVEGACIN: Hace la fila clickeable para ver detalles
                        className="hover:bg-gray-50 transition duration-150 cursor-pointer" 
                        onClick={() => router.push(`/admin/objective-detail/${obj.id}`)} 
                    >
                        <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center">
                            <div className="flex-shrink-0 h-10 w-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
                                <span className="font-bold text-lg">{obj.name.charAt(0).toUpperCase()}</span>
                            </div>
                            <div className="ml-4">
                            <div className="text-sm font-bold text-gray-900">{obj.name}</div>
                            <div className="text-sm text-gray-500">{obj.address}</div>
                            <div className="text-xs text-indigo-400 font-mono mt-1">
                                ({obj.location?.latitude?.toFixed(4) || 'N/A'}, {obj.location?.longitude?.toFixed(4) || 'N/A'})
                            </div>
                            </div>
                        </div>
                        </td>
                    </tr>
                    ))
                )}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

export default ObjectiveManagement;

================================================================================
FILE: apps\web\src\components\admin\scheduler.tsx
================================================================================
import React, { useState, useEffect, useRef } from 'react';
import FullCalendar from '@fullcalendar/react';
import dayGridPlugin from '@fullcalendar/daygrid';
import timeGridPlugin from '@fullcalendar/timegrid';
// Importaci贸n segura
import interactionPlugin, { Draggable } from '@fullcalendar/interaction';

import { Timestamp } from 'firebase/firestore';
import toast from 'react-hot-toast';
import { 
    callScheduleShift, 
    getObjectiveShifts, 
    callManageEmployees,
    getActiveContract,
    callManageHierarchy,
    updateShift,
    deleteShift
} from '@/services/firebase-client.service';
import { IShiftType, IServiceContract } from '@/common/interfaces/client.interface';
import { IEmployee } from '@/common/interfaces/employee.interface';
import { useClient } from '@/context/ClientContext';
import { 
    Info, AlertTriangle, CheckCircle2, Clock, 
    UserX, Trash2, RefreshCw, Copy, Clipboard, User
} from 'lucide-react';

interface SchedulerProps {
    objectiveId: string;
    viewMode: 'timeline' | 'calendar';
}

export function DragAndDropScheduler({ objectiveId, viewMode }: SchedulerProps) {
  const { selectedClientId } = useClient();
  
  // Datos
  const [employees, setEmployees] = useState<IEmployee[]>([]);
  const [shifts, setShifts] = useState<any[]>([]);
  const [shiftTypes, setShiftTypes] = useState<IShiftType[]>([]);
  const [contract, setContract] = useState<IServiceContract | null>(null);
  
  // KPIs
  const [contractHours, setContractHours] = useState(0);
  const [assignedHours, setAssignedHours] = useState(0);
  
  // UI
  const [loading, setLoading] = useState(false);
  const [isMobile, setIsMobile] = useState(false);
  
  // Modales
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
  const [isManageModalOpen, setIsManageModalOpen] = useState(false);
  const [selectedEvent, setSelectedEvent] = useState<any>(null);
  
  // Acciones
  const [isRotating, setIsRotating] = useState(false);
  const [rotationEmployeeId, setRotationEmployeeId] = useState('');
  const [copySourceDate, setCopySourceDate] = useState<Date | null>(null);
  const [copySourceShifts, setCopySourceShifts] = useState<any[]>([]);

  // Drag State
  const [pendingDrop, setPendingDrop] = useState<{
      employeeId: string;
      employeeName: string;
      targetDate: Date; // Usamos la fecha del drop, ignorando hora
      calendarApi: any;
      eventInstance: any;
  } | null>(null);

  const calendarRef = useRef<FullCalendar>(null);
  const draggableRef = useRef<HTMLDivElement>(null);

  // Colores
  const getColorByStatus = (status: string, isVacancy: boolean) => {
      if (isVacancy) return { bg: '#F3F4F6', border: '#9CA3AF', text: '#374151', pattern: true }; 
      switch (status) {
          case 'InProgress': return { bg: '#818CF8', border: '#4338ca', text: '#FFFFFF' };
          case 'Completed': return { bg: '#10B981', border: '#059669', text: '#FFFFFF' };
          case 'Canceled': return { bg: '#FECACA', border: '#EF4444', text: '#B91C1C' };
          case 'Assigned': default: return { bg: '#3B82F6', border: '#2563EB', text: '#FFFFFF' };
      }
  };

  // Configuraci贸n
  useEffect(() => {
    const checkMobile = () => setIsMobile(window.innerWidth < 1024);
    checkMobile(); 
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  useEffect(() => {
      const calendarApi = calendarRef.current?.getApi();
      if (calendarApi) {
          if (viewMode === 'calendar') calendarApi.changeView('dayGridMonth');
          else calendarApi.changeView(isMobile ? 'timeGridDay' : 'timeGridWeek');
      }
  }, [viewMode, isMobile]);

  // Cargar Empleados
  useEffect(() => {
    async function loadEmployees() {
        if (!selectedClientId) { setEmployees([]); return; }
        try {
            const empRes = await callManageEmployees({ action: 'GET_ALL_EMPLOYEES', payload: { clientId: selectedClientId } });
            setEmployees((empRes.data as any).data || []);
        } catch (e) { console.error(e); }
    }
    loadEmployees();
  }, [selectedClientId]);

  // Cargar Datos Objetivo
  const refreshShifts = () => {
    if (!objectiveId) { 
        setShifts([]); setContract(null); setContractHours(0); setAssignedHours(0); return; 
    }
    setLoading(true);
    
    getActiveContract(objectiveId).then(async (c) => {
        if (c) {
            // Forzamos defaults
            const safeContract = {
                ...c,
                quantity: c.quantity || 1, 
                daysOfWeek: c.daysOfWeek || [0,1,2,3,4,5,6] 
            } as unknown as IServiceContract;
            setContract(safeContract); 
            setContractHours(c.totalHours);
            
            try {
                const typesRes = await callManageHierarchy({ action: 'GET_SHIFT_TYPES', payload: { contractId: c.id } });
                setShiftTypes((typesRes.data as any).data || []);
            } catch (e) { console.error(e); }
        } else {
            setContract(null); setContractHours(0); setShiftTypes([]);
        }
    });

    getObjectiveShifts(objectiveId).then((data) => {
      let totalDuration = 0;
      const calendarEvents = data.map(shift => {
        const toDate = (t: any) => {
            if (!t) return new Date();
            if (typeof t.toDate === 'function') return t.toDate();
            if (t.seconds) return new Date(t.seconds * 1000);
            return new Date(t);
        };
        const start = toDate(shift.startTime);
        const end = toDate(shift.endTime);
        if (shift.status !== 'Canceled') totalDuration += (end.getTime() - start.getTime()) / (1000 * 60 * 60);

        const isVacancy = !shift.employeeId || shift.employeeId === 'VACANTE';
        const colors = getColorByStatus(shift.status, isVacancy);

        return {
            id: shift.id,
            title: isVacancy ? '锔 VACANTE' : shift.employeeName,
            start, end,
            backgroundColor: colors.bg,
            borderColor: colors.border,
            textColor: colors.text,
            classNames: [isVacancy ? 'striped-event' : '', shift.status === 'Canceled' ? 'canceled-event' : ''],
            extendedProps: { ...shift, isVacancy }
        };
      });
      setShifts(calendarEvents);
      setAssignedHours(totalDuration);
      setLoading(false);
    });
  };

  useEffect(() => { refreshShifts(); }, [objectiveId]);

  useEffect(() => {
    const draggableEl = draggableRef.current;
    if (draggableEl) {
      new Draggable(draggableEl, {
        itemSelector: '.fc-event-external',
        eventData: function(eventEl) {
          return {
            title: eventEl.getAttribute('data-name'),
            extendedProps: {
                employeeId: eventEl.getAttribute('data-id'),
                employeeName: eventEl.getAttribute('data-name')
            }
          };
        }
      });
    }
  }, [employees]);

  // --- RENDERERS ---

  const renderDayHeader = (arg: any) => {
      return (
          <div className="flex items-center justify-between px-2 w-full group">
              <span className="font-bold text-slate-700">{arg.text}</span>
              <div className="opacity-0 group-hover:opacity-100 transition-opacity">
                  {copySourceDate ? (
                      <button onClick={(e) => { e.stopPropagation(); handlePasteDay(arg.date); }} className="p-1 bg-indigo-600 text-white rounded hover:bg-indigo-700" title="Pegar aqu铆"><Clipboard size={12} /></button>
                  ) : (
                      <button onClick={(e) => { e.stopPropagation(); handleCopyDay(arg.date); }} className="p-1 bg-gray-100 text-gray-500 rounded hover:bg-gray-200 hover:text-indigo-600" title="Copiar d铆a"><Copy size={12} /></button>
                  )}
              </div>
          </div>
      );
  };

  const renderDayCell = (arg: any) => {
      if (arg.view.type !== 'dayGridMonth') return null;
      const date = arg.date;
      const dayOfWeek = date.getDay();
      if (!contract) return null;
      const requiredQuantity = contract.quantity || 1;
      const requiredDays = contract.daysOfWeek || [0,1,2,3,4,5,6];
      if (!requiredDays.includes(dayOfWeek)) return <div className="absolute inset-0 bg-gray-100/30 pointer-events-none" />;

      const shiftsToday = shifts.filter(s => {
          const shiftDate = new Date(s.start);
          return shiftDate.getDate() === date.getDate() &&
                 shiftDate.getMonth() === date.getMonth() &&
                 shiftDate.getFullYear() === date.getFullYear() &&
                 s.extendedProps.status !== 'Canceled' && !s.extendedProps.isVacancy;
      });
      const missing = requiredQuantity - shiftsToday.length;

      return (
          <div className="absolute bottom-1 left-0 right-0 px-2 pointer-events-none">
              {missing > 0 ? (
                  <div className="bg-red-50 border border-red-200 text-red-700 text-[10px] font-bold py-0.5 px-1 rounded flex items-center justify-center gap-1 shadow-sm">
                      <AlertTriangle size={10} /> Falta cubrir: {missing}
                  </div>
              ) : (
                  <div className="flex justify-end"><div className="bg-green-100 text-green-700 p-0.5 rounded-full border border-green-200"><CheckCircle2 size={12} /></div></div>
              )}
          </div>
      );
  };

  const renderEventContent = (arg: any) => {
      const isVacancy = arg.event.title === 'Vacante';
      return (
          <div className={`w-full h-full px-1 py-0.5 flex flex-col justify-center overflow-hidden text-[10px] leading-tight ${isVacancy ? 'italic' : ''}`}>
              <div className="font-bold truncate">{arg.event.title}</div>
              {!isMobile && arg.view.type !== 'dayGridMonth' && ( <div className="opacity-90">{arg.timeText}</div> )}
          </div>
      );
  };

  // --- HANDLERS ---
  const handleEventReceive = (info: any) => {
    if (!objectiveId) { toast.error("Seleccione un objetivo."); info.revert(); return; }
    const { employeeId, employeeName } = info.event.extendedProps;
    setPendingDrop({ 
        employeeId, employeeName, targetDate: info.event.start, //  FIX: Guardamos targetDate
        calendarApi: info, eventInstance: info.event 
    });
    setIsCreateModalOpen(true);
  };

  const handleConfirmAssignment = async (shiftType: IShiftType) => {
    if (!pendingDrop) return;
    setIsCreateModalOpen(false);
    
    //  FIX: Usamos la fecha del drop y la hora de la modalidad
    const startDate = new Date(pendingDrop.targetDate);
    const [h, m] = shiftType.startTime.split(':').map(Number);
    startDate.setHours(h, m, 0, 0);
    
    const endDate = new Date(startDate);
    endDate.setHours(startDate.getHours() + shiftType.durationHours);
    
    const toastId = toast.loading(`Asignando...`);
    try {
        await callScheduleShift({
            employeeId: pendingDrop.employeeId,
            employeeName: pendingDrop.employeeName,
            objectiveId: objectiveId,
            objectiveName: 'Sede', 
            startTime: Timestamp.fromDate(startDate),
            endTime: Timestamp.fromDate(endDate),
            shiftTypeId: shiftType.id,
            role: shiftType.requiredRole || 'Vigilador'
        });
        toast.success("Asignado", { id: toastId });
        pendingDrop.eventInstance.remove(); 
        refreshShifts();
    } catch (e: any) {
        toast.error(e.message, { id: toastId });
        pendingDrop.calendarApi.revert();
    } finally { setPendingDrop(null); }
  };

  const handleCopyDay = (date: Date) => {
      const shiftsToCopy = shifts.filter(s => {
          const sDate = s.start;
          return sDate.getDate() === date.getDate() && 
                 sDate.getMonth() === date.getMonth() && 
                 sDate.getFullYear() === date.getFullYear();
      });
      if (shiftsToCopy.length === 0) { toast.error("Nada para copiar."); return; }
      setCopySourceDate(date); setCopySourceShifts(shiftsToCopy);
      toast.success(`Copiados ${shiftsToCopy.length} turnos.`, { icon: '' });
  };

  const handlePasteDay = async (targetDate: Date) => {
      if (!copySourceDate || copySourceShifts.length === 0) return;
      const toastId = toast.loading("Pegando...");
      const promises = copySourceShifts.map(s => {
          const originalStart = s.start;
          const originalEnd = s.end;
          const newStart = new Date(targetDate);
          newStart.setHours(originalStart.getHours(), originalStart.getMinutes());
          const duration = originalEnd.getTime() - originalStart.getTime();
          const newEnd = new Date(newStart.getTime() + duration);

          return callScheduleShift({
              employeeId: s.extendedProps.employeeId,
              employeeName: s.extendedProps.employeeName,
              objectiveId, objectiveName: 'Sede',
              startTime: Timestamp.fromDate(newStart), endTime: Timestamp.fromDate(newEnd),
              shiftTypeId: s.extendedProps.shiftTypeId || 'manual', role: s.extendedProps.role || 'Vigilador'
          });
      });
      try { await Promise.all(promises); toast.success("Pegado", { id: toastId }); setCopySourceDate(null); setCopySourceShifts([]); refreshShifts(); } catch (e: any) { toast.error(e.message, { id: toastId }); }
  };

  const handleEventDrop = async (info: any) => {
    const { event } = info;
    if (info.jsEvent.altKey) {
        info.revert(); 
        const toastId = toast.loading("Clonando...");
        try {
            await callScheduleShift({
                employeeId: event.extendedProps.employeeId, employeeName: event.extendedProps.employeeName,
                objectiveId, objectiveName: 'Sede',
                startTime: Timestamp.fromDate(event.start), endTime: Timestamp.fromDate(event.end),
                shiftTypeId: event.extendedProps.shiftTypeId, role: event.extendedProps.role
            });
            toast.success("Duplicado", { id: toastId }); refreshShifts(); 
        } catch (e: any) { toast.error(e.message, { id: toastId }); }
    } else {
        const toastId = toast.loading("Moviendo...");
        try { await updateShift(event.id, { startTime: event.start, endTime: event.end }); toast.success("Movido", { id: toastId }); refreshShifts(); } catch (e: any) { toast.error(e.message, { id: toastId }); info.revert(); }
    }
  };

  const handleEventResize = async (info: any) => {
      const { event } = info;
      const toastId = toast.loading("Ajustando...");
      try { await updateShift(event.id, { startTime: event.start, endTime: event.end }); toast.success("Ajustado", { id: toastId }); refreshShifts(); } catch (e: any) { toast.error(e.message, { id: toastId }); info.revert(); }
  };

  const handleEventClick = (info: any) => {
      const event = info.event;
      setSelectedEvent({ id: event.id, title: event.title, start: event.start, end: event.end, extendedProps: event.extendedProps });
      setIsRotating(false); setRotationEmployeeId(''); setIsManageModalOpen(true);
  };

  const handleDelete = async () => {
      if (!selectedEvent) return;
      if (!confirm("驴Borrar?")) return;
      const toastId = toast.loading("Eliminando...");
      try { await deleteShift(selectedEvent.id); toast.success("Eliminado", { id: toastId }); setIsManageModalOpen(false); refreshShifts(); } catch (e: any) { toast.error(e.message, { id: toastId }); }
  };
  const handleMarkCanceled = async () => {
    if (!selectedEvent) return;
    try { await updateShift(selectedEvent.id, { status: 'Canceled' }); toast.success("Cancelado"); setIsManageModalOpen(false); refreshShifts(); } catch (e: any) { toast.error(e.message); }
  };
  const handleRotate = async () => {
      if (!selectedEvent || !rotationEmployeeId) return;
      const emp = employees.find(e => e.uid === rotationEmployeeId);
      if (!emp) return;
      try { await updateShift(selectedEvent.id, { employeeId: emp.uid, employeeName: emp.name, status: 'Assigned' }); toast.success(`Rotado`); setIsManageModalOpen(false); refreshShifts(); } catch (e: any) { toast.error(e.message); }
  };

  const coveragePercent = contractHours > 0 ? Math.min((assignedHours / contractHours) * 100, 100) : 0;

  return (
    <div className="flex flex-col lg:flex-row h-full relative bg-slate-50">
        <div className={`w-full lg:w-60 bg-white border-r p-3 flex flex-col ${isMobile ? 'hidden' : 'flex'}`} ref={draggableRef}>
            <h4 className="text-xs font-bold text-slate-500 uppercase mb-3">Plantilla</h4>
            <div className="flex-1 overflow-y-auto space-y-2">
                {employees.map(emp => (
                    <div key={emp.uid} data-id={emp.uid} data-name={emp.name} className="fc-event-external p-2 bg-white border rounded shadow-sm cursor-grab hover:border-indigo-500 flex items-center gap-2">
                        <div className="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-600">{emp.name.charAt(0)}</div>
                        <span className="text-sm truncate">{emp.name}</span>
                    </div>
                ))}
            </div>
        </div>

        <div className="flex-1 p-2 relative bg-white">
            <div className="absolute top-2 left-1/2 -translate-x-1/2 z-10 bg-white/90 backdrop-blur px-4 py-1 rounded-full shadow border flex items-center gap-3">
                <div className="flex items-center gap-1 text-xs text-slate-600"><Clock size={12}/><span className="font-bold">{assignedHours.toFixed(0)}</span>/{contractHours}h</div>
                <div className="w-24 h-1.5 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full transition-all duration-500 ${coveragePercent >= 100 ? 'bg-green-500' : 'bg-blue-500'}`} style={{ width: `${coveragePercent}%` }} /></div>
            </div>
            {copySourceDate && (
                <div className="absolute top-12 left-1/2 -translate-x-1/2 z-20 bg-indigo-600 text-white px-4 py-2 rounded-full shadow-lg text-sm flex items-center gap-2 animate-bounce cursor-pointer" onClick={() => setCopySourceDate(null)}>
                    <Clipboard size={16} /> Selecciona d铆a para pegar <button className="ml-2 opacity-50 hover:opacity-100"></button>
                </div>
            )}
            <FullCalendar
                ref={calendarRef}
                plugins={[dayGridPlugin, timeGridPlugin, interactionPlugin]}
                initialView="dayGridMonth"
                headerToolbar={false}
                slotMinTime="06:00:00"
                slotMaxTime="22:00:00"
                height="100%"
                locale="es"
                editable={true}
                droppable={true}
                events={shifts}
                eventReceive={handleEventReceive}
                eventDrop={handleEventDrop}
                eventResize={handleEventResize}
                eventClick={handleEventClick}
                dayHeaderContent={renderDayHeader}
                dayCellContent={renderDayCell} 
                eventContent={renderEventContent}
            />
        </div>

        {/* MODALES REUTILIZADOS (Crear y Gestionar) */}
        {/* ... (Mant茅n el c贸digo de los modales de la versi贸n anterior, es el mismo) ... */}
        {isCreateModalOpen && (
             <div className="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-[2px]">
                <div className="bg-white p-5 rounded-xl shadow-2xl max-w-xs w-full">
                    <h3 className="font-bold text-slate-800 mb-3">Asignar a {pendingDrop?.employeeName}</h3>
                    <div className="space-y-2 mb-4 max-h-60 overflow-y-auto">
                        {shiftTypes.map(type => (
                            <button key={type.id} onClick={() => handleConfirmAssignment(type)} className="w-full flex justify-between p-2 rounded border hover:bg-indigo-50 text-sm text-left">
                                <span className="font-bold">{type.name}</span>
                                <span className="text-xs bg-gray-100 px-1 rounded">{type.durationHours}h</span>
                            </button>
                        ))}
                        <button onClick={() => handleConfirmAssignment({ id: 'std', name: 'Manual 8hs', code: 'STD', startTime: '08:00', durationHours: 8 } as any)} className="w-full text-center text-xs text-slate-400 mt-2 hover:underline">Manual 8hs</button>
                    </div>
                    <button onClick={() => { setIsCreateModalOpen(false); pendingDrop?.calendarApi.revert(); }} className="w-full py-2 text-slate-500 text-sm rounded hover:bg-gray-50">Cancelar</button>
                </div>
             </div>
        )}

        {isManageModalOpen && selectedEvent && (
            <div className="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-[2px]">
                <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <div className="flex justify-between mb-4">
                        <h3 className="text-lg font-bold">{selectedEvent.title}</h3>
                        <button onClick={() => setIsManageModalOpen(false)} className="text-gray-400"></button>
                    </div>
                    <div className="space-y-3">
                        {!isRotating ? (
                            <button onClick={() => setIsRotating(true)} className="w-full flex justify-center gap-2 py-2 border rounded text-sm hover:bg-gray-50"><RefreshCw size={16} /> Rotar Personal</button>
                        ) : (
                            <div className="bg-slate-50 p-3 rounded border">
                                <select className="w-full border p-1 rounded text-sm mb-2" value={rotationEmployeeId} onChange={e => setRotationEmployeeId(e.target.value)}><option value="">Elegir...</option>{employees.map(e => <option key={e.uid} value={e.uid}>{e.name}</option>)}</select>
                                <div className="flex gap-2"><button onClick={() => setIsRotating(false)} className="flex-1 text-xs">Cancelar</button><button onClick={handleRotate} disabled={!rotationEmployeeId} className="flex-1 bg-indigo-600 text-white rounded text-xs py-1">OK</button></div>
                            </div>
                        )}
                        <button onClick={handleMarkCanceled} className="w-full flex justify-center gap-2 py-2 border border-red-100 text-red-600 rounded text-sm hover:bg-red-50"><UserX size={16}/> Cancelar</button>
                        <button onClick={handleDelete} className="w-full flex justify-center gap-2 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700"><Trash2 size={16}/> Eliminar</button>
                    </div>
                </div>
            </div>
        )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\shift-assignment-form.tsx
================================================================================
import React, { useState } from 'react';
import { callScheduleShift } from '@/services/firebase-client.service';
import { Timestamp } from 'firebase/firestore'; 

export function ShiftAssignmentForm() {
  const [employeeId, setEmployeeId] = useState('user_id_cajero_001'); // Placeholder
  const [objectiveId, setObjectiveId] = useState('obj_id_sucursal_centro'); // Placeholder
  const [startTime, setStartTime] = useState(''); 
  const [endTime, setEndTime] = useState('');
  const [message, setMessage] = useState<{ text: string, type: 'success' | 'error' } | null>(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setMessage(null);
    setLoading(true);

    try {
      const shiftData = {
        employeeId,
        objectiveId,
        startTime: Timestamp.fromDate(new Date(startTime)), 
        endTime: Timestamp.fromDate(new Date(endTime)),
      };

      const result = await callScheduleShift(shiftData);
      const data = result.data as { success: boolean, shiftId: string, message: string };
      setMessage({ text: data.message || "Turno asignado correctamente", type: 'success' });
      
    } catch (err: any) {
      const errorMessage = err.details || err.message;
      setMessage({ text: `Error: ${errorMessage}`, type: 'error' });
    } finally {
      setLoading(false);
    }
  };

  const inputClass = "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm";
  const labelClass = "block text-sm font-medium text-gray-700";

  return (
    <div className="space-y-6">
      {message && (
        <div className={`p-4 rounded-md ${message.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
          {message.text}
        </div>
      )}
      
      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label className={labelClass}>Inicio del Turno</label>
                <input type="datetime-local" value={startTime} onChange={(e) => setStartTime(e.target.value)} required className={inputClass} />
            </div>
            <div>
                <label className={labelClass}>Fin del Turno</label>
                <input type="datetime-local" value={endTime} onChange={(e) => setEndTime(e.target.value)} required className={inputClass} />
            </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label className={labelClass}>Empleado ID</label>
                <input type="text" value={employeeId} readOnly className={`${inputClass} bg-gray-100 cursor-not-allowed`} />
            </div>
            <div>
                <label className={labelClass}>Objetivo ID</label>
                <input type="text" value={objectiveId} readOnly className={`${inputClass} bg-gray-100 cursor-not-allowed`} />
            </div>
        </div>

        <button 
            type="submit" 
            disabled={loading}
            className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none transition duration-200 ${loading ? 'opacity-70' : ''}`}
        >
          {loading ? 'Asignando...' : 'Asignar Turno'}
        </button>
      </form>
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\system-user-management.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { callManageSystemUsers } from '@/services/firebase-client.service';
import { ISystemUser } from '@/common/interfaces/system-user.interface';
import toast from 'react-hot-toast';

export function SystemUserManagement() {
  const [users, setUsers] = useState<ISystemUser[]>([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);

  // Formulario
  const [formData, setFormData] = useState({
    uid: '',
    displayName: '',
    email: '',
    password: '',
    role: 'Scheduler',
    status: 'Active'
  });

  const fetchUsers = async () => {
    setLoading(true);
    try {
      const res = await callManageSystemUsers({ action: 'GET_ALL_USERS', payload: {} });
      const data = (res.data as any).data || [];
      setUsers(data);
    } catch (error) {
      console.error(error);
      toast.error("Error al cargar usuarios.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchUsers();
  }, []);

  const handleOpenCreate = () => {
    setFormData({ uid: '', displayName: '', email: '', password: '', role: 'Scheduler', status: 'Active' });
    setIsEditing(false);
    setShowModal(true);
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    const toastId = toast.loading("Procesando...");

    try {
      if (isEditing) {
        // Solo enviamos lo que cambia
        const payload = {
            uid: formData.uid,
            data: {
                role: formData.role,
                status: formData.status,
                displayName: formData.displayName
            }
        };
        await callManageSystemUsers({ action: 'UPDATE_USER', payload });
        toast.success("Usuario actualizado", { id: toastId });
      } else {
        await callManageSystemUsers({ 
            action: 'CREATE_USER', 
            payload: {
                email: formData.email,
                password: formData.password,
                displayName: formData.displayName,
                role: formData.role
            }
        });
        toast.success("Administrador creado", { id: toastId });
      }
      setShowModal(false);
      fetchUsers();
    } catch (error: any) {
      toast.error(`Error: ${error.message}`, { id: toastId });
    }
  };

  const handleDelete = async (uid: string) => {
    if (!confirm("驴Eliminar este administrador? Perder谩 el acceso inmediatamente.")) return;
    try {
        await callManageSystemUsers({ action: 'DELETE_USER', payload: { uid } });
        toast.success("Usuario eliminado");
        fetchUsers();
    } catch (error) {
        toast.error("Error al eliminar");
    }
  };

  // Estilos
  const inputClass = "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm";
  const labelClass = "block text-sm font-medium text-gray-700";

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-xl font-bold text-gray-800">Usuarios del Sistema</h2>
            <p className="text-sm text-gray-500">Gestione el acceso al panel administrativo.</p>
        </div>
        <button onClick={handleOpenCreate} className="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 transition shadow-sm flex items-center">
            <span className="mr-2">+</span> Nuevo Admin
        </button>
      </div>

      {/* Tabla */}
      <div className="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
                <tr>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Usuario</th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Rol</th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Estado</th>
                    <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Acciones</th>
                </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
                {users.map((user) => (
                    <tr key={user.uid} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center">
                                <div className="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-xs">
                                    {user.displayName.charAt(0)}
                                </div>
                                <div className="ml-3">
                                    <div className="text-sm font-medium text-gray-900">{user.displayName}</div>
                                    <div className="text-xs text-gray-500">{user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                            <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">
                                {user.role}
                            </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                {user.status}
                            </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onClick={() => handleDelete(user.uid)} className="text-red-600 hover:text-red-900">Eliminar</button>
                        </td>
                    </tr>
                ))}
            </tbody>
        </table>
      </div>

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <h3 className="text-lg font-bold text-gray-900 mb-4">{isEditing ? 'Editar Usuario' : 'Nuevo Administrador'}</h3>
                <form onSubmit={handleSave} className="space-y-4">
                    <div><label className={labelClass}>Nombre</label><input className={inputClass} value={formData.displayName} onChange={e => setFormData({...formData, displayName: e.target.value})} required /></div>
                    {!isEditing && (
                        <>
                            <div><label className={labelClass}>Email</label><input type="email" className={inputClass} value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required /></div>
                            <div><label className={labelClass}>Contrase帽a</label><input type="password" className={inputClass} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} required /></div>
                        </>
                    )}
                    <div>
                        <label className={labelClass}>Rol de Sistema</label>
                        <select className={inputClass} value={formData.role} onChange={e => setFormData({...formData, role: e.target.value as any})}>
                            <option value="SuperAdmin">Super Admin (Total)</option>
                            <option value="Scheduler">Planificador (Turnos)</option>
                            <option value="HR_Manager">RRHH (Empleados)</option>
                            <option value="Viewer">Solo Lectura</option>
                        </select>
                    </div>
                    <div className="flex justify-end space-x-3 mt-6">
                        <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg">Cancelar</button>
                        <button type="submit" className="px-4 py-2 text-white bg-gray-900 rounded-lg hover:bg-black">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\SystemStatus.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { callManageHierarchy, callManageEmployees, callCheckSystemHealth, auth } from '@/services/firebase-client.service';

interface HealthMetric {
    name: string;
    status: 'pending' | 'ok' | 'warning' | 'error';
    value?: string;
    details?: string;
}

export function SystemStatus() {
    const [metrics, setMetrics] = useState<HealthMetric[]>([
        { name: 'Conectividad Internet', status: 'pending' },
        { name: 'Sesi贸n de Usuario (Auth)', status: 'pending' },
        { name: 'Servidor (Cloud Functions)', status: 'pending' },
        { name: 'Base de Datos (Firestore)', status: 'pending' },
        { name: 'M贸dulo Jerarqu铆a', status: 'pending' },
        { name: 'M贸dulo RRHH', status: 'pending' },
    ]);
    const [isRunning, setIsRunning] = useState(false);

    useEffect(() => { runDiagnostics(); }, []);

    const updateMetric = (index: number, status: HealthMetric['status'], value: string, details: string = '') => {
        setMetrics(prev => {
            const newM = [...prev];
            newM[index] = { ...newM[index], status, value, details };
            return newM;
        });
    };

    const runDiagnostics = async () => {
        setIsRunning(true);
        
        // 1. Local Checks
        const isOnline = navigator.onLine;
        updateMetric(0, isOnline ? 'ok' : 'error', isOnline ? 'Online' : 'Offline');
        if (!isOnline) { setIsRunning(false); return; }

        const user = auth.currentUser;
        updateMetric(1, user ? 'ok' : 'error', user ? 'Autenticado' : 'Sin Sesi贸n', user?.uid);

        // 2. Health Check Real (Ping al servidor)
        const startServer = Date.now();
        try {
            const healthRes = await callCheckSystemHealth({});
            const endServer = Date.now();
            const data = healthRes.data as any;

            updateMetric(2, 'ok', `${endServer - startServer}ms`, `Node ${data.nodeVersion}`);
            
            const dbLat = data.database.latencyMs;
            updateMetric(3, data.database.status === 'connected' ? 'ok' : 'error', `${dbLat}ms`);

        } catch (error: any) {
            updateMetric(2, 'error', 'Fallo Cr铆tico', error.message);
            updateMetric(3, 'error', 'Inaccesible', 'Timeout o Error 500');
        }

        // 3. Smoke Test de M贸dulos
        await testModule(4, async () => callManageHierarchy({ action: 'GET_ALL_CLIENTS', payload: {} }));
        await testModule(5, async () => callManageEmployees({ action: 'GET_ALL_EMPLOYEES', payload: {} }));

        setIsRunning(false);
    };

    const testModule = async (index: number, call: () => Promise<any>) => {
        const start = Date.now();
        try {
            await call();
            updateMetric(index, 'ok', `${Date.now() - start}ms`, 'Operativo');
        } catch (error: any) {
            updateMetric(index, 'error', 'Fallo', error.message);
        }
    };

    return (
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <div className="flex justify-between items-center mb-6">
                <h3 className="font-bold text-slate-800 text-lg">Monitor de Salud</h3>
                <button onClick={runDiagnostics} disabled={isRunning} className="px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-bold hover:bg-indigo-100 disabled:opacity-50">
                    {isRunning ? 'Escaneando...' : 'Re-escanear'}
                </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {metrics.map((m, idx) => (
                    <div key={idx} className={`p-4 rounded-lg border flex items-center justify-between ${m.status === 'ok' ? 'bg-green-50 border-green-100' : m.status === 'error' ? 'bg-red-50 border-red-100' : 'bg-gray-50'}`}>
                        <div>
                            <p className="text-xs font-bold text-gray-500 uppercase mb-1">{m.name}</p>
                            <div className="flex items-center gap-2">
                                <div className={`w-2.5 h-2.5 rounded-full ${m.status === 'ok' ? 'bg-green-500' : m.status === 'error' ? 'bg-red-500' : 'bg-yellow-400 animate-pulse'}`} />
                                <span className="font-bold text-slate-700">{m.status === 'pending' ? '...' : m.value}</span>
                            </div>
                        </div>
                        {m.details && <div className="text-xs text-gray-500 text-right max-w-[120px] truncate" title={m.details}>{m.details}</div>}
                    </div>
                ))}
            </div>
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\common\Button.tsx
================================================================================
import React from 'react';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
    primary?: boolean;
    children: React.ReactNode;
}

/**
 * @description Reusable button component with basic Tailwind styles.
 */
export default function Button({ primary = true, children, className, disabled, ...props }: ButtonProps) {
    const baseStyle = "px-4 py-2 rounded-lg font-semibold transition-colors duration-150";
    const primaryStyle = "bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-indigo-300";
    const secondaryStyle = "bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:bg-gray-100";

    return (
        <button
            className={`${baseStyle} ${primary ? primaryStyle : secondaryStyle} ${className || ''}`}
            disabled={disabled}
            {...props}
        >
            {children}
        </button>
    );
}

================================================================================
FILE: apps\web\src\components\common\InputField.tsx
================================================================================
import React from 'react';

interface InputFieldProps extends React.InputHTMLAttributes<HTMLInputElement | HTMLTextAreaElement> {
    label: string;
    id: string;
    type?: 'text' | 'email' | 'password' | 'number' | 'date' | 'textarea';
    rows?: number;
}

/**
 * @description Reusable input/textarea component.
 */
export default function InputField({ label, id, type = 'text', rows = 1, className, ...props }: InputFieldProps) {
    const inputStyle = "w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 text-sm";

    return (
        <div className={`space-y-1 ${className}`}>
            <label htmlFor={id} className="block text-sm font-medium text-gray-700">
                {label}
            </label>
            {type === 'textarea' ? (
                <textarea
                    id={id}
                    className={inputStyle}
                    rows={rows}
                    {...props as React.TextareaHTMLAttributes<HTMLTextAreaElement>}
                />
            ) : (
                <input
                    id={id}
                    type={type}
                    className={inputStyle}
                    {...props as React.InputHTMLAttributes<HTMLInputElement>}
                />
            )}
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\common\SelectField.tsx
================================================================================
import React from 'react';

interface SelectFieldProps extends React.SelectHTMLAttributes<HTMLSelectElement> {
    label: string;
    id: string;
    children: React.ReactNode;
}

/**
 * @description Reusable select (dropdown) component.
 */
export default function SelectField({ label, id, children, className, ...props }: SelectFieldProps) {
    const selectStyle = "w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 text-sm";
    
    return (
        <div className={`space-y-1 ${className}`}>
            <label htmlFor={id} className="block text-sm font-medium text-gray-700">
                {label}
            </label>
            <select
                id={id}
                className={selectStyle}
                {...props}
            >
                {children}
            </select>
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\common\shift.interface.ts
================================================================================
/**
 * @file shift.interface.ts
 * @description Definici贸n de la estructura de un Turno (Shift) compartido entre Frontend y Backend.
 */

// Definimos un tipo flexible para las fechas para soportar:
// 1. admin.firestore.Timestamp (Backend)
// 2. firebase.firestore.Timestamp (Frontend SDK)
// 3. Date (Objetos JS nativos tras conversi贸n)
// 4. { seconds: number, nanoseconds: number } (JSON serializado)
export type FirestoreDate = any; 

export type ShiftStatus = 'Scheduled' | 'In Progress' | 'Completed' | 'Absent';

export interface IShift {
    id: string; // ID del documento en Firestore
    
    // Relaci贸n con Empleado
    employeeId: string;
    employeeName: string;
    
    // Relaci贸n con Objetivo (Cliente/Sede)
    objectiveId: string;
    objectiveName: string; //  Requerido para mostrar en el Dashboard
    
    // Tiempos
    startTime: FirestoreDate;
    endTime: FirestoreDate;
    
    // Estado del ciclo de vida
    status: ShiftStatus;
    
    // Datos opcionales de auditor铆a en el mismo documento (si aplica)
    checkInTime?: FirestoreDate;
    checkOutTime?: FirestoreDate;
    
    // Metadatos
    role?: string; // Rol del empleado durante ese turno (ej: 'Vigilador', 'Supervisor')
}

================================================================================
FILE: apps\web\src\components\common\withAuthGuard.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/router';
import { User, onAuthStateChanged } from 'firebase/auth';
import { auth } from '../../services/firebase-client.service'; 

// Roles administrativos globales (para referencia)
const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager'];

/**
 * Higher-Order Component para proteger rutas.
 * @param WrappedComponent El componente de p谩gina a proteger.
 * @param requiredRoles Un solo rol (string) o un array de roles permitidos (string[]).
 */
export const withAuthGuard = (
    WrappedComponent: React.ComponentType<any>, 
    requiredRoles: string | string[] = ['admin'] //  FIX: Acepta string o array
) => {
  
  // Normalizamos a array para facilitar la l贸gica
  const rolesArray = Array.isArray(requiredRoles) ? requiredRoles : [requiredRoles];

  console.log(`[DEBUG GUARD] Roles Requeridos:`, rolesArray);

  const ComponentWithAuthGuard = (props: any) => {
    const router = useRouter();
    const [loading, setLoading] = useState(true);
    const [currentUser, setCurrentUser] = useState<User | null>(null);

    useEffect(() => {
      const unsubscribe = onAuthStateChanged(auth, async (user) => {
        if (!user) {
          router.replace('/'); 
          return;
        }

        setCurrentUser(user);
        
        try {
          // Forzamos refresh del token para tener los claims actualizados
          const tokenResult = await user.getIdTokenResult(true);
          const userRole = tokenResult.claims.role as string;
          
          console.log(`[DEBUG GUARD] Usuario: ${user.email} | Rol: ${userRole}`);

          //  LGICA DE AUTORIZACIN CORREGIDA
          // Verificamos si el rol del usuario est谩 incluido en los roles permitidos
          const isAuthorized = rolesArray.includes(userRole);

          if (isAuthorized) {
            setLoading(false);
          } else {
            console.warn(` [GUARD] Acceso Denegado. Rol '${userRole}' no autorizado.`);
            router.replace('/'); 
          }
        } catch (error) {
          console.error(" [GUARD] Error validando rol:", error);
          router.replace('/');
        }
      });

      return () => unsubscribe();
    }, [router]);

    if (loading) {
      return (
        <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
            <p className="text-gray-500 font-medium animate-pulse">Verificando permisos...</p>
        </div>
      );
    }

    return <WrappedComponent {...props} currentUser={currentUser} />;
  };

  return ComponentWithAuthGuard;
};

================================================================================
FILE: apps\web\src\components\employee\employee-dashboard.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { getEmployeeShifts, callAuditShift, createAbsence } from '@/services/firebase-client.service';
import { IShift } from '@/common/interfaces/shift.interface';
import toast from 'react-hot-toast';
import { getCurrentPosition } from '@/utils/geolocation'; 

interface EmployeeDashboardProps {
  currentUser: User; 
}

type ViewMode = 'day' | 'week' | 'month';

export function EmployeeDashboard({ currentUser }: EmployeeDashboardProps) {
  const [shifts, setShifts] = useState<IShift[]>([]);
  const [loading, setLoading] = useState(true);
  const [viewMode, setViewMode] = useState<ViewMode>('week');
  const [auditingId, setAuditingId] = useState<string | null>(null);
  const [isAuditing, setIsAuditing] = useState(false);

  // Estados Modal Ausencia
  const [absenceModalOpen, setAbsenceModalOpen] = useState(false);
  const [selectedShiftForAbsence, setSelectedShiftForAbsence] = useState<IShift | null>(null);
  const [absenceReason, setAbsenceReason] = useState('');

  // --- 锔 HELPER DE FECHAS (El coraz贸n del arreglo) ---
  // Convierte Timestamp, {seconds...}, String o Date a un objeto Date v谩lido de JS
  const getDateObj = (timestamp: any): Date => {
      if (!timestamp) return new Date();
      // Caso 1: Firestore Timestamp (tiene .toDate())
      if (typeof timestamp.toDate === 'function') return timestamp.toDate();
      // Caso 2: Objeto Date nativo
      if (timestamp instanceof Date) return timestamp;
      // Caso 3: Objeto serializado { seconds, nanoseconds }
      if (timestamp.seconds !== undefined) return new Date(timestamp.seconds * 1000);
      // Caso 4: String ISO
      if (typeof timestamp === 'string') return new Date(timestamp);
      
      return new Date(); // Fallback
  };

  // --- Carga de Datos ---
  const loadShifts = async () => {
    setLoading(true);
    try {
      const data = await getEmployeeShifts(currentUser.uid);
      // Ordenamos cronol贸gicamente
      const sorted = data.sort((a, b) => {
         return getDateObj(a.startTime).getTime() - getDateObj(b.startTime).getTime();
      });
      setShifts(sorted);
    } catch (err: any) {
      console.error(err);
      toast.error("Error al cargar agenda.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { if (currentUser) loadShifts(); }, [currentUser]);

  // --- Filtros de Tiempo ---
  const getFilteredShifts = () => {
      const today = new Date();
      return shifts.filter(shift => {
          const date = getDateObj(shift.startTime);
          
          if (viewMode === 'day') {
              return date.getDate() === today.getDate() && 
                     date.getMonth() === today.getMonth() &&
                     date.getFullYear() === today.getFullYear();
          }
          if (viewMode === 'week') {
              // L贸gica simple: Desde hoy hasta 7 d铆as adelante
              const nextWeek = new Date();
              nextWeek.setDate(today.getDate() + 7);
              // Reseteamos horas para comparar d铆as completos
              const d = new Date(date); d.setHours(0,0,0,0);
              const t = new Date(today); t.setHours(0,0,0,0);
              return d >= t && d <= nextWeek;
          }
          if (viewMode === 'month') {
              return date.getMonth() === today.getMonth() && 
                     date.getFullYear() === today.getFullYear();
          }
          return true;
      });
  };

  // --- Formateadores Visuales ---
  const formatTime = (ts: any) => getDateObj(ts).toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'});
  const formatDate = (ts: any) => getDateObj(ts).toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' });

  // --- Fichaje (Check-In/Out) ---
  const handleAuditAction = async (shiftId: string, action: 'CHECK_IN' | 'CHECK_OUT') => {
    if (isAuditing || auditingId) return;
    
    setAuditingId(shiftId); 
    setIsAuditing(true);
    const toastId = toast.loading(action === 'CHECK_IN' ? "Validando ubicaci贸n..." : "Cerrando servicio...");

    try {
        const coords = await getCurrentPosition();
        await callAuditShift({ 
            shiftId, 
            action, 
            coords: { latitude: coords.latitude, longitude: coords.longitude } 
        });
        
        const msg = action === 'CHECK_IN' ? " 隆Presente registrado!" : " 隆Servicio finalizado!";
        toast.success(msg, { id: toastId });
        await loadShifts(); 
    } catch (error: any) {
        let msg = "Error al procesar.";
        // Mensajes priorizados
        if (error.message?.includes('temprano')) msg = " Es muy temprano (10 min antes).";
        else if (error.message?.includes('cerca') || error.code === 'functions/failed-precondition') msg = " Est谩s demasiado lejos.";
        else if (error.message?.includes('Permiso')) msg = "锔 Activa el GPS.";
        
        toast.error(msg, { id: toastId, duration: 5000 });
    } finally {
        setAuditingId(null); 
        setIsAuditing(false);
    }
  };

  // --- Reporte Ausencia ---
  const handleReportAbsence = async () => {
      if (!selectedShiftForAbsence || !absenceReason.trim()) {
          toast.error("Por favor indique el motivo."); return;
      }
      
      const toastId = toast.loading("Registrando ausencia...");
      try {
          //  FIX: Convertimos a Date nativo JS antes de enviar al servicio
          // Esto evita el error "seconds is not valid"
          const start = getDateObj(selectedShiftForAbsence.startTime);
          const end = getDateObj(selectedShiftForAbsence.endTime);

          await createAbsence({
              action: 'CREATE_ABSENCE',
              payload: {
                  employeeId: currentUser.uid,
                  employeeName: currentUser.displayName || 'Empleado',
                  clientId: selectedShiftForAbsence.objectiveId || 'unknown', 
                  type: 'SICK_LEAVE', // Podr铆amos agregar un selector de tipo en el modal
                  startDate: start, 
                  endDate: end,
                  reason: `[App] ${absenceReason}`
              }
          });
          toast.success("Ausencia reportada correctamente.", { id: toastId });
          setAbsenceModalOpen(false);
          setAbsenceReason('');
          // Opcional: Recargar para reflejar cambios si el backend marca el turno
          await loadShifts();
      } catch (error: any) {
          console.error(error);
          toast.error("Error: " + (error.message || "Fallo desconocido"), { id: toastId });
      }
  };

  // --- Render ---
  if (loading) return <div className="p-10 text-center animate-pulse text-gray-500">Cargando agenda...</div>;

  const filteredList = getFilteredShifts();
  // Buscamos el pr贸ximo turno relevante para el Header Azul
  const nextShift = shifts.find(s => s.status === 'Assigned' || s.status === 'InProgress');

  return (
    <div className="max-w-2xl mx-auto pb-24 px-4 font-sans">
      
      {/* 1. HEADER AZUL (RESTAURADO) */}
      <div className="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl p-6 text-white shadow-lg mb-6 mt-4 relative overflow-hidden transition-all hover:shadow-xl">
          <div className="relative z-10">
              <h2 className="text-2xl font-bold mb-1">
                  Hola, {currentUser.displayName?.split(' ')[0] || 'Colaborador'}
              </h2>
              <p className="text-indigo-100 text-sm mb-6">Panel de Operaciones</p>
              
              <div className="flex gap-4">
                  <div className="bg-white/10 backdrop-blur-sm rounded-lg p-3 flex-1 border border-white/10">
                      <p className="text-xs text-indigo-200 uppercase font-bold">Pr贸ximo Turno</p>
                      <p className="text-lg font-bold mt-1 truncate">
                          {nextShift ? getDateObj(nextShift.startTime).toLocaleDateString('es-AR', {weekday:'short', day:'numeric'}) : 'Libre'}
                      </p>
                  </div>
                  <div className="bg-white/10 backdrop-blur-sm rounded-lg p-3 flex-1 border border-white/10">
                      <p className="text-xs text-indigo-200 uppercase font-bold">Estado</p>
                      <p className="text-lg font-bold mt-1 flex items-center gap-2">
                          {nextShift?.status === 'InProgress' ? 
                            <><span className="w-2 h-2 rounded-full bg-green-400 animate-pulse shadow-[0_0_8px_rgba(74,222,128,0.8)]"/> En Servicio</> : 
                            'Disponible'}
                      </p>
                  </div>
              </div>
          </div>
          {/* Decoraci贸n de fondo */}
          <div className="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
          <div className="absolute bottom-0 left-0 -mb-4 -ml-4 w-24 h-24 bg-indigo-500/20 rounded-full blur-xl"></div>
      </div>

      {/* 2. FILTROS (TABS) */}
      <div className="flex bg-gray-100 p-1 rounded-xl mb-6 shadow-inner">
          {(['day', 'week', 'month'] as ViewMode[]).map(m => (
              <button 
                key={m} 
                onClick={() => setViewMode(m)} 
                className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all capitalize ${viewMode === m ? 'bg-white text-indigo-600 shadow-sm transform scale-[1.02]' : 'text-gray-500 hover:text-gray-700'}`}
              >
                  {m === 'day' ? 'Hoy' : m === 'week' ? 'Semana' : 'Mes'}
              </button>
          ))}
      </div>

      {/* 3. LISTADO DE TARJETAS */}
      <div className="space-y-5">
        {filteredList.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-12 bg-white rounded-2xl border border-dashed border-gray-200 text-center">
                <span className="text-4xl mb-3"></span>
                <p className="text-gray-500 font-medium">No hay servicios programados.</p>
                <p className="text-sm text-gray-400">Selecciona otro filtro para ver m谩s.</p>
            </div>
        ) : (
            filteredList.map((shift) => (
            <div key={shift.id} className="bg-white rounded-2xl shadow-md border border-slate-100 overflow-hidden hover:shadow-lg transition-all duration-300">
                
                {/* Header Tarjeta */}
                <div className="bg-slate-50 px-5 py-4 border-b border-slate-100 flex justify-between items-center">
                    <div>
                        <span className="font-bold text-gray-800 block truncate max-w-[180px] sm:max-w-xs">{shift.objectiveName || 'Objetivo'}</span>
                        <span className="text-xs text-gray-500 uppercase tracking-wider">{shift.role || 'Vigilador'}</span>
                    </div>
                    <span className={`text-[10px] px-2.5 py-1 rounded-full font-bold uppercase border ${
                        shift.status === 'InProgress' ? 'bg-indigo-50 text-indigo-700 border-indigo-100 animate-pulse' : 
                        shift.status === 'Completed' ? 'bg-green-50 text-green-700 border-green-100' : 'bg-white text-slate-500 border-slate-200'
                    }`}>
                        {shift.status === 'Assigned' ? 'Pendiente' : shift.status}
                    </span>
                </div>

                <div className="p-5">
                    {/* Info Tiempo */}
                    <div className="flex justify-between mb-5 text-sm">
                        <div>
                            <p className="text-gray-400 text-[10px] font-bold uppercase mb-0.5">Fecha</p>
                            <p className="font-medium text-slate-700 capitalize">{formatDate(shift.startTime)}</p>
                        </div>
                        <div className="text-right">
                            <p className="text-gray-400 text-[10px] font-bold uppercase mb-0.5">Horario</p>
                            <p className="font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">{formatTime(shift.startTime)} - {formatTime(shift.endTime)}</p>
                        </div>
                    </div>

                    <div className="space-y-3">
                        {/* Botones: PENDIENTE */}
                        {shift.status === 'Assigned' && (
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => handleAuditAction(shift.id, 'CHECK_IN')}
                                    disabled={!!auditingId}
                                    className="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow-md hover:bg-emerald-700 transition active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2"
                                >
                                    {auditingId === shift.id ? 'Validando...' : <><span></span> DAR PRESENTE</>}
                                </button>
                                <button 
                                    onClick={() => { setSelectedShiftForAbsence(shift); setAbsenceModalOpen(true); }}
                                    disabled={!!auditingId}
                                    className="px-4 py-3 bg-red-50 text-red-600 border border-red-100 rounded-xl font-bold text-lg hover:bg-red-100 transition active:scale-95"
                                    title="Reportar Ausencia / Problema"
                                >
                                    
                                </button>
                            </div>
                        )}

                        {/* Botones: EN CURSO */}
                        {shift.status === 'InProgress' && (
                            <button 
                                onClick={() => handleAuditAction(shift.id, 'CHECK_OUT')}
                                disabled={!!auditingId}
                                className="w-full bg-rose-600 text-white py-3 rounded-xl font-bold text-sm shadow-md hover:bg-rose-700 transition active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2"
                            >
                                {auditingId === shift.id ? 'Cerrando...' : <><span></span> FIN DE SERVICIO</>}
                            </button>
                        )}
                        
                        {/* Botones: FINALIZADO */}
                        {shift.status === 'Completed' && (
                            <div className="w-full bg-slate-50 text-slate-500 py-3 rounded-xl text-center text-sm font-medium border border-slate-200 flex items-center justify-center gap-2 cursor-default">
                                <svg className="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                                Servicio Completado
                            </div>
                        )}
                    </div>
                </div>
            </div>
            ))
        )}
      </div>

      {/* MODAL DE AUSENCIA */}
      {absenceModalOpen && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm animate-fadeIn">
              <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all">
                  <div className="flex items-center gap-3 mb-4 text-red-600">
                      <div className="bg-red-100 p-2 rounded-full">
                        <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                      </div>
                      <h3 className="text-lg font-bold text-gray-800">Reportar Ausencia</h3>
                  </div>
                  
                  <p className="text-sm text-gray-500 mb-4">
                      驴Por qu茅 no podr谩s asistir al turno en <strong>{selectedShiftForAbsence?.objectiveName}</strong>?
                  </p>
                  
                  <textarea 
                      className="w-full border-gray-300 rounded-xl shadow-sm focus:ring-red-500 focus:border-red-500 text-sm p-3 border mb-6"
                      rows={3}
                      placeholder="Escribe el motivo aqu铆..."
                      value={absenceReason}
                      onChange={e => setAbsenceReason(e.target.value)}
                  />

                  <div className="flex gap-3">
                      <button onClick={() => setAbsenceModalOpen(false)} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-xl transition bg-gray-50">Cancelar</button>
                      <button onClick={handleReportAbsence} className="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 shadow-md transition active:scale-95">Confirmar</button>
                  </div>
              </div>
          </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\layout\DashboardLayout.tsx
================================================================================
import React, { useState } from 'react';
import { useRouter } from 'next/router';
import { useClient } from '@/context/ClientContext';
import { auth } from '@/services/firebase-client.service';
import { APP_INFO } from '@/config/app.config';

// Importamos iconos modernos
import { 
  LayoutDashboard, 
  Building2, 
  Target, 
  Users, 
  CalendarDays, 
  ShieldCheck, 
  Activity, 
  Menu, 
  X, 
  LogOut,
  ChevronDown,
  Settings,
  Map
} from 'lucide-react';

interface LayoutProps {
  children: React.ReactNode;
  title: string;
}

// Mapeo de strings (del config) a Componentes de iconos
const iconMap: any = {
  LayoutDashboard: <LayoutDashboard size={20} />,
  Building2: <Building2 size={20} />,
  Target: <Target size={20} />,
  Users: <Users size={20} />,
  CalendarDays: <CalendarDays size={20} />,
  ShieldCheck: <ShieldCheck size={20} />,
  Activity: <Activity size={20} />,
  Map: <Map size={20} />, // Agregamos Map por si se usa en el men煤
};

function DashboardLayout({ children, title }: LayoutProps) {
  const router = useRouter();
  const { clients, selectedClientId, setClient, loading } = useClient();
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  
  const handleLogout = async () => {
    try {
      await auth.signOut();
      window.location.href = '/'; 
    } catch (error) {
      console.error("Error al cerrar sesi贸n:", error);
    }
  };

  const SidebarContent = () => (
    <>
      {/* 1. Header de Identidad: BacarPlan */}
      <div className="h-16 flex items-center px-6 border-b border-slate-100 bg-white">
        <div>
          <h1 className="text-xl font-extrabold text-indigo-700 tracking-tight">
            {APP_INFO.name}
          </h1>
          <div className="flex items-center space-x-2">
            <span className="text-[10px] font-mono text-slate-400 border border-slate-200 rounded px-1.5 bg-slate-50">
                v{APP_INFO.version}
            </span>
          </div>
        </div>
      </div>

      {/* 2. Selector de Contexto (Empresa Cliente / Global) */}
      <div className="px-4 py-4 border-b border-slate-100 bg-slate-50/50">
          <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block">
            Contexto Operativo
          </label>
          {loading ? (
              <div className="h-9 w-full bg-slate-200 rounded animate-pulse"></div>
          ) : (
              <div className="relative">
                <select 
                    value={selectedClientId} 
                    onChange={(e) => setClient(e.target.value)}
                    className={`w-full text-sm border-slate-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 py-2 pl-2 pr-8 appearance-none cursor-pointer truncate font-medium ${selectedClientId === '' ? 'bg-indigo-50 text-indigo-700 font-bold border-indigo-200' : 'bg-white text-slate-700'}`}
                >
                    {/*  OPCIN GLOBAL: Permite ver todo el mapa/operaci贸n */}
                    <option value=""> Ver Toda la Operaci贸n</option>
                    
                    <optgroup label="Clientes Espec铆ficos">
                        {clients.map(c => (
                            <option key={c.id} value={c.id}>{c.businessName}</option>
                        ))}
                    </optgroup>
                </select>
                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                  <ChevronDown size={14} />
                </div>
            </div>
          )}
      </div>

      {/* 3. Navegaci贸n Din谩mica */}
      <nav className="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
        {APP_INFO.menuItems.map((item) => {
          // La ruta activa se determina por el path de Next.js
          const isActive = router.pathname === item.path;
          return (
            <button
              key={item.path}
              onClick={() => {
                router.push(item.path);
                setIsMobileMenuOpen(false);
              }}
              className={`w-full flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all duration-200 group ${
                isActive 
                  ? 'bg-indigo-50 text-indigo-700 font-semibold shadow-sm ring-1 ring-indigo-200' 
                  : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-medium'
              }`}
            >
              <span className={`transition-colors ${isActive ? 'text-indigo-600' : 'text-slate-400 group-hover:text-slate-600'}`}>
                {iconMap[item.icon] || <Settings size={20} />}
              </span>
              <span className="text-sm">{item.name}</span>
            </button>
          )
        })}
      </nav>

      {/* 4. Footer Logout */}
      <div className="p-4 border-t border-slate-100 mt-auto bg-white">
        <button onClick={handleLogout} className="flex items-center space-x-3 text-rose-600 hover:bg-rose-50 w-full px-3 py-2.5 rounded-lg transition-colors text-sm font-medium group">
          <LogOut size={20} className="group-hover:text-rose-700" />
          <span>Cerrar Sesi贸n</span>
        </button>
      </div>
    </>
  );

  return (
    <div className="flex h-screen bg-[#F8FAFC] font-sans text-slate-600">
      
      {/* Desktop Sidebar */}
      <aside className="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col fixed h-full z-30 shadow-sm">
        <SidebarContent />
      </aside>

      {/* Mobile Menu Overlay */}
      {isMobileMenuOpen && (
        <div className="fixed inset-0 z-50 flex md:hidden">
          <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onClick={() => setIsMobileMenuOpen(false)}></div>
          <div className="relative flex-1 flex flex-col max-w-xs w-full bg-white shadow-2xl transform transition-transform duration-300 ease-in-out">
            <div className="absolute top-0 right-0 -mr-12 pt-2">
              <button className="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" onClick={() => setIsMobileMenuOpen(false)}>
                <X className="h-6 w-6 text-white" />
              </button>
            </div>
            <SidebarContent />
          </div>
        </div>
      )}

      {/* Main Content Area */}
      <div className="flex-1 flex flex-col md:pl-64 h-screen overflow-hidden transition-all duration-300">
        
        {/* Topbar */}
        <header className="h-16 bg-white/90 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-4 md:px-8 sticky top-0 z-20 shrink-0 shadow-sm">
          <div className="flex items-center gap-3">
            <button onClick={() => setIsMobileMenuOpen(true)} className="md:hidden -ml-2 p-2 text-slate-500 hover:text-indigo-600 rounded-md">
              <Menu className="w-6 h-6" />
            </button>
            {/* T铆tulo de la p谩gina, pasado como prop */}
            <h2 className="text-lg font-bold text-slate-800 truncate leading-tight">{title}</h2>
          </div>
          <div className="flex items-center space-x-4">
             {/* Avatar Placeholder */}
             <div className="h-9 w-9 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-700 font-bold text-sm border border-indigo-100 shadow-sm">
                AD
             </div>
          </div>
        </header>

        {/* Page Content */}
        <main className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
          <div className="max-w-7xl mx-auto h-full">
            {children}
          </div>
        </main>
      </div>
    </div>
  );
}

export default DashboardLayout;

================================================================================
FILE: apps\web\src\config\app.config.ts
================================================================================
export const APP_INFO = {
  name: 'BacarPlan',
  version: '1.2.0',
  description: 'Sistema Integral de Gesti贸n Operativa',
  menuItems: [
    { name: 'Panel de Control', path: '/admin/dashboard', icon: 'LayoutDashboard' },
    //  NUEVO: Centro de Operaciones (Mapa)
    { name: 'Centro de Operaciones', path: '/admin/operations/map', icon: 'Map' },
    { name: 'Empresas / Clientes', path: '/admin/clients', icon: 'Building2' },
    { name: 'Objetivos', path: '/admin/objective-management', icon: 'Target' },
    { name: 'RRHH / Empleados', path: '/admin/employees', icon: 'Users' },
    { name: 'Novedades (Ausencias)', path: '/admin/rrhh/novedades', icon: 'CalendarDays' },
    { name: 'Usuarios Sistema', path: '/admin/system-users', icon: 'ShieldCheck' },
    { name: 'Diagn贸stico', path: '/admin/status', icon: 'Activity' },
  ]
};

================================================================================
FILE: apps\web\src\context\ClientContext.tsx
================================================================================
import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { onAuthStateChanged } from 'firebase/auth';
import { auth, callManageHierarchy } from '@/services/firebase-client.service';
import { IClient } from '@/common/interfaces/client.interface';
import toast from 'react-hot-toast';

interface ClientContextType {
  clients: IClient[];
  selectedClientId: string;
  selectedClient: IClient | undefined;
  setClient: (id: string) => void;
  loading: boolean;
}

// Roles que tienen permiso para ver empresas
const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager', 'Manager', 'Operator', 'Supervisor'];

const ClientContext = createContext<ClientContextType | undefined>(undefined);

export function ClientProvider({ children }: { children: ReactNode }) {
  const [clients, setClients] = useState<IClient[]>([]);
  const [selectedClientId, setSelectedClientId] = useState<string>(''); // Default: Vac铆o = "Todos"
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const tokenResult = await user.getIdTokenResult();
          const role = tokenResult.claims.role as string;

          if (ADMIN_ROLES.includes(role)) {
            await loadClients();
          } else {
            setLoading(false);
          }
        } catch (error) {
          console.error("Error verificando permisos:", error);
          setLoading(false);
        }
      } else {
        setClients([]);
        setSelectedClientId('');
        setLoading(false);
      }
    });

    return () => unsubscribe();
  }, []);

  async function loadClients() {
    try {
      const res = await callManageHierarchy({ action: 'GET_ALL_CLIENTS', payload: {} });
      const responseData = res.data as any; 
      const data = responseData.data || [];
      
      setClients(data);

      //  LGICA DE SELECCIN INTELIGENTE
      const savedId = localStorage.getItem('selectedClientId');
      
      // Si hay un guardado v谩lido, lo usamos.
      if (savedId && (savedId === '' || data.find((c: IClient) => c.id === savedId))) {
        setSelectedClientId(savedId);
      } else {
        // Si no hay nada guardado, por defecto mostramos "TODOS" (vac铆o)
        // Esto es mejor para una visi贸n gerencial.
        setSelectedClientId('');
      }

    } catch (error: any) {
      console.error("Error loading clients", error);
      toast.error("No se pudieron cargar las empresas.");
    } finally {
      setLoading(false);
    }
  }

  const setClient = (id: string) => {
    setSelectedClientId(id);
    localStorage.setItem('selectedClientId', id);
    
    // Feedback visual opcional
    if (id === '') toast.success("Vista Global activada");
    else {
        const clientName = clients.find(c => c.id === id)?.businessName;
        toast.success(`Filtrando por: ${clientName}`);
    }
  };

  const selectedClient = clients.find(c => c.id === selectedClientId);

  return (
    <ClientContext.Provider value={{ clients, selectedClientId, selectedClient, setClient, loading }}>
      {children}
    </ClientContext.Provider>
  );
}

export function useClient() {
  const context = useContext(ClientContext);
  if (!context) throw new Error('useClient debe usarse dentro de ClientProvider');
  return context;
}

================================================================================
FILE: apps\web\src\hooks\useSchedulerDataFetcher.ts
================================================================================
import { useState, useEffect } from 'react';
import toast from 'react-hot-toast';
import { callManageEmployees, callManageData } from '@/services/firebase-client.service';
import { IEmployee } from '@/common/interfaces/employee.interface';
import { IObjective } from '@/common/interfaces/client.interface';

export const useSchedulerDataFetcher = (selectedClientId: string | null) => {
    const [employees, setEmployees] = useState<IEmployee[]>([]);
    const [objectives, setObjectives] = useState<IObjective[]>([]);
    const [selectedObjectiveId, setSelectedObjectiveId] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);

    useEffect(() => {
        const fetchAll = async () => {
            //  DEBUG: Verificar qu茅 ID llega al hook
            console.log(" [Fetcher] Cambio de empresa detectado. ID:", selectedClientId);

            // Si no hay cliente seleccionado, limpiamos y salimos
            if (!selectedClientId) {
                console.log("锔 [Fetcher] No hay cliente seleccionado. Limpiando datos.");
                setEmployees([]);
                setObjectives([]);
                setSelectedObjectiveId('');
                return;
            }

            setIsLoading(true);
            
            try {
                // 1. Obtener Empleados (Con filtro de empresa)
                console.log(" [Fetcher] Solicitando empleados al Backend para cliente:", selectedClientId);
                
                const empRes = await callManageEmployees({ 
                    action: 'GET_ALL_EMPLOYEES', 
                    payload: { clientId: selectedClientId } //  Aqu铆 enviamos el filtro
                });
                
                // Manejo defensivo de la respuesta
                const empData = (empRes.data as any).data || [];
                
                //  DEBUG: Verificar qu茅 devolvi贸 el Backend
                console.log(` [Fetcher] Recibidos ${empData.length} empleados.`);
                console.log(" [Fetcher] Lista de empleados:", empData);
                
                setEmployees(empData);

                // 2. Obtener Objetivos (Con filtro de empresa)
                console.log(" [Fetcher] Solicitando objetivos...");
                const objRes = await callManageData({ 
                    action: 'GET_ALL_OBJECTIVES', 
                    payload: { clientId: selectedClientId } 
                });
                
                const objData = (objRes.data as any).data || [];
                setObjectives(objData);
                
                // Seleccionar autom谩ticamente el primer objetivo si existe
                if (objData.length > 0) {
                    setSelectedObjectiveId(objData[0].id);
                } else {
                    setSelectedObjectiveId('');
                }
            
            } catch (error) {
                console.error(" [Fetcher] Error CRTICO cargando datos:", error);
                toast.error("Error al cargar los datos de la empresa.");
                setEmployees([]);
                setObjectives([]);
            } finally {
                setIsLoading(false);
            }
        };

        fetchAll();

    }, [selectedClientId]); //  DEPENDENCIA: Se ejecuta al cambiar el cliente

    return { 
        employees, 
        objectives, 
        selectedObjectiveId, 
        setSelectedObjectiveId, 
        isLoading 
    };
};

================================================================================
FILE: apps\web\src\services\firebase-client.service.ts
================================================================================
import { initializeApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getFunctions, httpsCallable } from 'firebase/functions';
import { 
    getFirestore, 
    collection, 
    query, 
    where, 
    getDocs, 
    doc,
    getDoc,
    QueryDocumentSnapshot
} from 'firebase/firestore';
import { IShift } from '@/common/interfaces/shift.interface';
import { IAbsencePayload } from '@/common/interfaces/employee.interface';
import { IObjective, IServiceContract, IShiftType } from '@/common/interfaces/client.interface';

// 1. CONFIGURACIN Y CREDENCIALES
const firebaseConfig = {
    apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
    authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
    projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
    storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
    messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
    appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
    measurementId: process.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID
};

const app = initializeApp(firebaseConfig);

// Exportamos las instancias para usarlas en toda la app
export const auth = getAuth(app);
export const functions = getFunctions(app, 'us-central1');
export const db = getFirestore(app);

// Constantes de Colecciones
const SHIFTS_COLLECTION = 'turnos';
const CONTRACTS_COLLECTION = 'contratos_servicio'; 
const OBJECTIVES_COLLECTION = 'objetivos';

// ------------------------------------------------------------------
// 2. FUNCIONES INVOCABLES (CLOUD FUNCTIONS)
// ------------------------------------------------------------------

// Auth y Usuarios
//  FIX: Nos aseguramos que esta l铆nea est茅 presente y exportada
export const callCreateUser = httpsCallable(functions, 'createUser');
export const callManageSystemUsers = httpsCallable(functions, 'manageSystemUsers');

// Jerarqu铆a y Datos Maestros
export const callManageHierarchy = httpsCallable(functions, 'manageHierarchy');
export const callManageData = httpsCallable(functions, 'manageData');
export const callManageEmployees = httpsCallable(functions, 'manageEmployees');

// Operaciones (Turnos y Fichadas)
export const callScheduleShift = httpsCallable(functions, 'scheduleShift'); 
export const callManageShifts = httpsCallable(functions, 'manageShifts');   
export const callAuditShift = httpsCallable(functions, 'auditShift');       
export const callManagePatterns = httpsCallable(functions, 'managePatterns'); 

// RRHH y Sistema
export const callManageAbsences = httpsCallable(functions, 'manageAbsences');
export const callCheckSystemHealth = httpsCallable(functions, 'checkSystemHealth');


// ------------------------------------------------------------------
// 3. WRAPPERS DE SERVICIOS (L贸gica de Cliente)
// ------------------------------------------------------------------

// --- GESTIN DE AUSENCIAS ---
export async function createAbsence(params: { action: 'CREATE_ABSENCE', payload: IAbsencePayload }): Promise<any> {
    const { payload } = params;

    if (!payload.employeeId || !payload.clientId || !payload.startDate || !payload.endDate || !payload.reason) {
        throw new Error("Faltan datos requeridos para la ausencia.");
    }
    
    if (!(payload.startDate instanceof Date) || isNaN(payload.startDate.getTime())) {
        throw new Error("Fecha de inicio inv谩lida.");
    }
    
    // Convertimos fechas a ISO String
    const absenceData = {
        employeeId: payload.employeeId,
        employeeName: payload.employeeName,
        clientId: payload.clientId,
        type: payload.type,
        startDate: payload.startDate.toISOString(),
        endDate: payload.endDate.toISOString(),
        reason: payload.reason,
    };

    try {
        const result = await callManageAbsences({ 
            action: params.action, 
            payload: absenceData 
        });

        if (result.data && (result.data as any).success === false) {
             throw new Error((result.data as any).message || "Error en backend.");
        }
        return result.data;
    } catch (error) {
        console.error("[Service Error - createAbsence]:", error);
        throw error;
    }
}

// --- GESTIN DE PATRONES (AUTOMATIZACIN) ---
export async function createPattern(payload: any) {
    // Validamos fechas
    const safePayload = { ...payload };
    if (payload.validFrom instanceof Date) safePayload.validFrom = payload.validFrom.toISOString();
    if (payload.validTo instanceof Date) safePayload.validTo = payload.validTo.toISOString();

    return callManagePatterns({ action: 'CREATE_PATTERN', payload: safePayload });
}

export async function getPatterns(contractId: string) {
    const res = await callManagePatterns({ action: 'GET_PATTERNS', payload: { contractId } });
    return (res.data as any) || [];
}

export async function deletePattern(id: string) {
    return callManagePatterns({ action: 'DELETE_PATTERN', payload: { id } });
}

export async function generateVacancies(contractId: string, objectiveId: string, month: number, year: number) {
    return callManagePatterns({ 
        action: 'GENERATE_VACANCIES', 
        payload: { contractId, objectiveId, month, year } 
    });
}


// ------------------------------------------------------------------
// 4. LECTURA DE DATOS (FIRESTORE DIRECTO)
// ------------------------------------------------------------------

export async function getEmployeeShifts(employeeId: string): Promise<IShift[]> {
    if (!employeeId) return [];
    
    const shiftsRef = collection(db, SHIFTS_COLLECTION);
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    
    const shiftsQuery = query(
        shiftsRef, 
        where('employeeId', '==', employeeId), 
        where('startTime', '>=', todayStart)
    );
    const snapshot = await getDocs(shiftsQuery);

    return snapshot.docs.map((doc: QueryDocumentSnapshot) => {
        const data = doc.data();
        return { ...data, id: doc.id };
    }) as unknown as IShift[];
}

export async function getObjectiveShifts(objectiveId: string): Promise<IShift[]> {
    if (!objectiveId) return [];
    
    const shiftsRef = collection(db, SHIFTS_COLLECTION);
    const shiftsQuery = query(shiftsRef, where('objectiveId', '==', objectiveId)); 
    const snapshot = await getDocs(shiftsQuery);
    
    return snapshot.docs.map((doc: QueryDocumentSnapshot) => {
        const data = doc.data();
        return { ...data, id: doc.id };
    }) as unknown as IShift[];
}

export async function getActiveContract(objectiveId: string): Promise<{ id: string, totalHours: number, name: string, quantity?: number, daysOfWeek?: number[] } | null> {
    if (!objectiveId) return null;

    try {
        const contractsRef = collection(db, CONTRACTS_COLLECTION);
        const q = query(
            contractsRef, 
            where('objectiveId', '==', objectiveId),
            where('isActive', '==', true) 
        );
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) return null;

        const docSnapshot = snapshot.docs[0];
        const docData = docSnapshot.data();
        return {
            id: docSnapshot.id,
            totalHours: docData.totalHoursPerMonth || 0,
            name: docData.name || 'Contrato',
            quantity: docData.quantity,
            daysOfWeek: docData.daysOfWeek
        };
    } catch (e) {
        console.error("Error fetching contract:", e);
        return null;
    }
}


// ------------------------------------------------------------------
// 5. TORRE DE CONTROL (DASHBOARD OBJETIVO)
// ------------------------------------------------------------------

export async function getObjectiveControlData(objectiveId: string) {
    if (!objectiveId) throw new Error("ID de objetivo requerido");

    try {
        const objRef = doc(db, OBJECTIVES_COLLECTION, objectiveId);
        const objSnap = await getDoc(objRef);

        if (!objSnap.exists()) throw new Error("El objetivo no existe.");
        const objective = { id: objSnap.id, ...objSnap.data() } as IObjective;

        const today = new Date();
        today.setHours(0,0,0,0);

        const shiftsRef = collection(db, SHIFTS_COLLECTION);
        const q = query(
            shiftsRef,
            where('objectiveId', '==', objectiveId),
            where('startTime', '>=', today)
        );

        const shiftSnaps = await getDocs(q);
        const shifts = shiftSnaps.docs.map(d => ({ id: d.id, ...d.data() })) as unknown as IShift[];

        shifts.sort((a, b) => {
            const timeA = (a.startTime as any).toDate ? (a.startTime as any).toDate() : new Date(a.startTime as any);
            const timeB = (b.startTime as any).toDate ? (b.startTime as any).toDate() : new Date(b.startTime as any);
            return timeA.getTime() - timeB.getTime();
        });

        return { objective, shifts };

    } catch (error) {
        console.error("Error fetching control data:", error);
        throw error;
    }
}


// ------------------------------------------------------------------
// 6. ABM DE JERARQUA Y TURNOS
// ------------------------------------------------------------------

export async function updateObjective(id: string, data: Partial<IObjective>) {
    return await callManageHierarchy({
        action: 'UPDATE_OBJECTIVE',
        payload: { id, data }
    });
}

export async function getObjectiveContracts(objectiveId: string): Promise<IServiceContract[]> {
    try {
        const q = query(collection(db, CONTRACTS_COLLECTION), where('objectiveId', '==', objectiveId));
        const snapshot = await getDocs(q);
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) as unknown as IServiceContract[];
    } catch (error) {
        console.error("Error fetching contracts:", error);
        return [];
    }
}

export async function createServiceForObjective(payload: { objectiveId: string, name: string, totalHours: number, quantity?: number, daysOfWeek?: number[] }) {
    return await callManageHierarchy({
        action: 'CREATE_CONTRACT',
        payload: {
            objectiveId: payload.objectiveId,
            name: payload.name,
            totalHoursPerMonth: payload.totalHours,
            quantity: payload.quantity || 1,
            daysOfWeek: payload.daysOfWeek || [],
            startDate: new Date().toISOString(),
            isActive: true
        }
    });
}

export async function updateServiceContract(id: string, data: any) {
    return await callManageHierarchy({ action: 'UPDATE_CONTRACT', payload: { id, data } });
}

export async function deleteServiceContract(id: string) {
    return await callManageHierarchy({ action: 'DELETE_CONTRACT', payload: { id } });
}

export async function getShiftTypes(contractId: string): Promise<IShiftType[]> {
    try {
        const res = await callManageHierarchy({ action: 'GET_SHIFT_TYPES', payload: { contractId } });
        return (res.data as any).data || [];
    } catch (error) { return []; }
}

export async function createShiftType(payload: Omit<IShiftType, 'id'>) {
    return await callManageHierarchy({ action: 'CREATE_SHIFT_TYPE', payload });
}

export async function updateShiftType(id: string, data: Partial<IShiftType>) {
    return await callManageHierarchy({ action: 'UPDATE_SHIFT_TYPE', payload: { id, data } });
}

export async function deleteShiftType(id: string) {
    return await callManageHierarchy({ action: 'DELETE_SHIFT_TYPE', payload: { id } });
}

// --- CRUD TURNOS ---
export async function updateShift(id: string, data: any) {
    const payloadData = { ...data };
    if (payloadData.startTime instanceof Date) payloadData.startTime = payloadData.startTime.toISOString();
    if (payloadData.endTime instanceof Date) payloadData.endTime = payloadData.endTime.toISOString();

    return await callManageShifts({ action: 'UPDATE_SHIFT', payload: { id, data: payloadData } });
}

export async function deleteShift(id: string) {
    return await callManageShifts({ action: 'DELETE_SHIFT', payload: { id } });
}

================================================================================
FILE: apps\web\src\utils\geocoding.ts
================================================================================
/**
 * Utilidad para geocodificaci贸n usando Google Maps Platform.
 */
export async function getCoordinatesFromAddress(address: string): Promise<{ lat: number, lng: number } | null> {
    const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_KEY;

    // 1. Diagn贸stico de la Clave
    if (!apiKey) {
        console.error(" ERROR CRTICO: La variable NEXT_PUBLIC_GOOGLE_MAPS_KEY est谩 vac铆a o undefined.");
        console.info(" RECUERDA: Debes crear el archivo .env.local en apps/web/ y reiniciar el servidor (npm run dev).");
        return null;
    }

    try {
        console.log(` Consultando Google Maps para: "${address}"`);
        
        const query = encodeURIComponent(address);
        const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${query}&key=${apiKey}`;
        
        const response = await fetch(url);
        const data = await response.json();

        // 2. Diagn贸stico de la Respuesta de Google
        if (data.status !== 'OK') {
            console.error(" Google Maps API Error:", data.status);
            console.error("Mensaje de error:", data.error_message); // Muy 煤til para ver si falta habilitar la API
            
            if (data.status === 'REQUEST_DENIED') {
                console.warn("锔 Revisa en Google Cloud Console que la 'Geocoding API' est茅 habilitada y que la API Key sea correcta.");
            }
            return null;
        }

        if (data.results.length > 0) {
            const location = data.results[0].geometry.location;
            console.log(" Coordenadas encontradas:", location);
            return {
                lat: location.lat,
                lng: location.lng
            };
        } else {
            console.warn("锔 Google no encontr贸 resultados para esa direcci贸n.");
            return null;
        }

    } catch (error) {
        console.error(" Error de red o fetch:", error);
        return null;
    }
}

================================================================================
FILE: apps\web\src\utils\geolocation.ts
================================================================================
export interface IGeoCoordinates {
    latitude: number;
    longitude: number;
    accuracy: number;
}

/**
 * Obtiene la posici贸n actual con promesa y manejo de errores en Espa帽ol.
 */
export function getCurrentPosition(timeoutMs: number = 10000): Promise<IGeoCoordinates> {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Tu navegador no soporta geolocalizaci贸n.'));
            return;
        }

        const options: PositionOptions = {
            enableHighAccuracy: true, // Intentar usar GPS real
            timeout: timeoutMs,
            maximumAge: 0 // No usar cach茅
        };

        navigator.geolocation.getCurrentPosition(
            (position) => {
                resolve({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                });
            },
            (error) => {
                let msg = 'Error desconocido de ubicaci贸n.';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        msg = 'Permiso de ubicaci贸n denegado. Habil铆talo en tu navegador.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        msg = 'Se帽al GPS no disponible.';
                        break;
                    case error.TIMEOUT:
                        msg = 'Se agot贸 el tiempo buscando se帽al GPS.';
                        break;
                }
                reject(new Error(msg));
            },
            options
        );
    });
}

================================================================================
FILE: apps\web\tailwind.config.ts
================================================================================
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/**/*.{js,ts,jsx,tsx,mdx}", //  CLAVE
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};
export default config;

================================================================================
FILE: apps\web\tsconfig.json
================================================================================
{
  //  Ya no extendemos el archivo ra铆z para evitar conflictos con rutas.
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx", // Necesario para Next.js 
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    //  FIX: Configuramos la base para que TypeScript entienda la ruta "src"
    "baseUrl": "./src", 
    "paths": {
      // FIX: Definici贸n expl铆cita de cada alias (ej: '@/components' -> 'src/components')
      "@/components/*": ["components/*"],
      "@/config/*": ["config/*"],
      "@/context/*": ["context/*"],
      "@/services/*": ["services/*"],
      "@/styles/*": ["styles/*"],
      "@/common/*": ["common/*"],
      "@/utils/*": ["utils/*"], // Aseguramos que la utilidad 'geolocation' se encuentre
      // FIX para dependencias del monorepo (lucide-react, etc.)
      "*": ["../../*"] 
    }
  },
  "include": [
    "next-env.d.ts", 
    "**/*.ts", 
    "**/*.tsx", 
    ".next/types/**/*.ts"
  ],
  "exclude": ["node_modules"]
}

================================================================================
FILE: CHANGELOG.md
================================================================================
---

### 2.  `CHANGELOG.md`

Este archivo registrar谩 la historia de cambios. He documentado todo lo que acabamos de arreglar bajo la versi贸n **1.1.0**. Gu谩rdalo tambi茅n en la **ra铆z**.

```markdown
# Changelog

Todos los cambios notables en el proyecto **ControlData** ser谩n documentados en este archivo.

El formato se basa en [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
y este proyecto adhiere a Semantic Versioning.

## [Unreleased]
- Planificaci贸n de m贸dulo de reportes avanzados.

## [1.1.0] - 2025-12-04 (Estabilizaci贸n y Fixes Cr铆ticos)

###  Agregado (Added)
- **Diagn贸stico de Sistema:** Nuevo endpoint `checkSystemHealth` y servicio en frontend para monitorear el estado de Node.js, Base de Datos y Latencia en tiempo real.
- **Gesti贸n de Ausencias:** Implementaci贸n completa (Backend/Frontend) para registrar novedades (Vacaciones, Enfermedad) validando reglas de negocio.
- **Seguridad Multi-tenant:** Ahora `findAllEmployees` acepta un filtro `clientId` para asegurar que los administradores solo vean empleados de la empresa seleccionada.
- **Endpoints Faltantes:** Se expusieron `manageAbsences` y `checkSystemHealth` en `index.ts`.

###  Corregido (Fixed)
- **Error de Build Frontend:** Se solucion贸 la falta de exportaci贸n de `callCheckSystemHealth` en `firebase-client.service.ts`.
- **Inyecci贸n de Dependencias (Backend):** Se registr贸 correctamente `AbsenceService` en `DataManagementModule` y se export贸 `WorkloadService` desde `SchedulingModule` para resolver errores de inicio de NestJS.
- **Errores de Importaci贸n:** Corregidos alias y rutas en `AbsenceManagementPage`.
- **Credenciales:** Actualizaci贸n y verificaci贸n de credenciales de Firebase en el cliente.

###  Modificado (Changed)
- Refactorizaci贸n de `firebase-client.service.ts` para incluir todas las definiciones `Callable` necesarias.
- Actualizaci贸n de `index.ts` (Functions) para soportar los nuevos m贸dulos de RRHH y Diagn贸stico.

## [1.0.0] - 2025-11-20
- Lanzamiento inicial del MVP.
- Funcionalidades b谩sicas: Login, Dashboard Admin, Scheduler Drag & Drop.

================================================================================
FILE: crear-admin.js
================================================================================
const admin = require('firebase-admin');
const serviceAccount = require('./service-account.json'); // 锔 OJO AQU

// Inicializar
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

const email = 'admin@bacar.com'; //  TU EMAIL DE ADMIN
const password = 'password123'; //  TU CONTRASEA

async function createSuperAdmin() {
  try {
    // 1. Crear usuario
    const userRecord = await admin.auth().createUser({
      email: email,
      password: password,
      displayName: 'Super Admin',
      emailVerified: true,
    });

    console.log('Usuario creado:', userRecord.uid);

    // 2. Asignar Custom Claim 'admin'
    await admin.auth().setCustomUserClaims(userRecord.uid, { role: 'admin' });
    console.log('Rol de ADMIN asignado exitosamente.');

    // 3. Crear perfil en Firestore (Opcional, para que no falle la UI)
    await admin.firestore().collection('empleados').doc(userRecord.uid).set({
        uid: userRecord.uid,
        name: 'Super Admin',
        email: email,
        role: 'admin',
        isAvailable: true
    });
    console.log('Perfil en Firestore creado.');

  } catch (error) {
    console.error('Error:', error);
  }
}

createSuperAdmin();

================================================================================
FILE: eslint.config.js
================================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])


================================================================================
FILE: firebase.json
================================================================================
{
  "functions": [
    {
      "source": "apps/functions",
      "codebase": "default",
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log"
      ],
      "predeploy": [
        "npm --prefix \"$RESOURCE_DIR\" run build"
      ]
    }
  ],
  "hosting": {
    "public": "apps/web/out",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "cleanUrls": true,
    "trailingSlash": false,
    "rewrites": [
      {
        "source": "**",
        "destination": "/404.html"
      }
    ]
  }
}

================================================================================
FILE: firestore.indexes.json
================================================================================
{
  "indexes": [
    {
      "collectionGroup": "ausencias",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "employeeId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "endDate",
          "order": "ASCENDING"
        }
      ]
    },
    {
      "collectionGroup": "turnos",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "employeeId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "startTime",
          "order": "ASCENDING"
        }
      ]
    }
  ],
  "fieldOverrides": []
}

================================================================================
FILE: firestore.rules
================================================================================
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIONES AUXILIARES ---
    
    // Verifica si el usuario tiene un rol administrativo v谩lido
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.role == 'admin' || 
        request.auth.token.role == 'SuperAdmin' || 
        request.auth.token.role == 'Scheduler' || 
        request.auth.token.role == 'HR_Manager'
      );
    }
    
    // Verifica si el usuario es el due帽o del documento
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // --- REGLAS POR COLECCIN ---

    // 1. Turnos (Operativo)
    match /turnos/{shiftId} {
      // Admins ven y editan todo
      allow read: if isAdmin();
      // Empleados solo ven sus propios turnos
      allow read: if request.auth != null && resource.data.employeeId == request.auth.uid;
      // Solo admins escriben (asignaci贸n)
      allow write: if isAdmin();
    }

    // 2. Empleados (RRHH)
    match /empleados/{employeeId} {
      // Admins gestionan todo
      allow read, write: if isAdmin();
      // Empleado ve su propio perfil
      allow read: if isOwner(employeeId);
    }

    // 3. Ausencias / Novedades
    match /ausencias/{absenceId} {
      allow read, write: if isAdmin();
      // Empleado puede ver sus propias ausencias
      allow read: if request.auth != null && resource.data.employeeId == request.auth.uid;
    }

    // 4. Jerarqu铆a Comercial (Clientes, Objetivos, Contratos)
    match /clientes/{clientId} {
      allow read, write: if isAdmin();
    }
    match /objetivos/{objectiveId} {
      allow read, write: if isAdmin();
    }
    match /contratos_servicio/{contractId} {
      allow read, write: if isAdmin();
    }
    match /tipos_turno/{typeId} {
      allow read, write: if isAdmin();
    }

    // 5. Usuarios del Sistema (Back-Office)
    match /system_users/{userId} {
      // Solo admins pueden ver/editar usuarios del sistema
      allow read, write: if isAdmin();
    }
  }
}

================================================================================
FILE: package.json
================================================================================
{
  "name": "cronoapp",
  "version": "1.0.0",
  "description": "Monorepositorio para la aplicaci贸n de cronogramas. Contiene Frontend (web) y Backend (functions).",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: Los tests se ejecutan en las subcarpetas: npm run test --workspace=functions\" && exit 1",
    "install:all": "npm install --workspaces",
    "dev:backend": "npm run serve --workspace=functions",
    "dev:frontend": "npm run dev --workspace=web"
  },
  "keywords": [
    "firebase",
    "nestjs",
    "nextjs",
    "typescript",
    "monorepo"
  ],
  "author": "Vale - Senior Tech Lead",
  "license": "ISC",
  "dependencies": {
    "firebase-admin": "^13.6.0",
    "lucide-react": "^0.555.0"
  }
}


================================================================================
FILE: README.md
================================================================================
# ControlData (Cronoapp)

**ControlData** es una plataforma SaaS de gesti贸n de fuerza laboral (WFM), dise帽ada para empresas de seguridad y servicios. Permite la gesti贸n integral de empleados, control de asistencia por geolocalizaci贸n, planificaci贸n de turnos y administraci贸n multi-empresa (Multi-tenancy).

## 锔 Arquitectura y Stack

El proyecto es un **Monorepo** que integra Frontend y Backend:

* **Frontend (`apps/web`):**
    * **Framework:** Next.js 16 (Static Export).
    * **Estilos:** Tailwind CSS.
    * **Estado/L贸gica:** React Context (ClientContext) + Hooks personalizados.
* **Backend (`apps/functions`):**
    * **Runtime:** Firebase Cloud Functions (Node.js 20).
    * **Framework:** NestJS (Inyecci贸n de dependencias y arquitectura modular).
    * **Base de Datos:** Firestore (NoSQL).
    * **Auth:** Firebase Authentication (Custom Claims para roles).

##  Requisitos Previos

* Node.js v20+
* NPM
* Firebase CLI (`npm install -g firebase-tools`)
* Java (Opcional, solo si se desea usar el Emulador de Firebase localmente)

## 锔 Instalaci贸n y Configuraci贸n

1.  **Clonar/Descargar el repositorio.**
2.  **Instalar dependencias ra铆z y workspaces:**
    ```bash
    npm install
    ```

##  Desarrollo Local

### Backend (Functions)
Para compilar y observar cambios en el backend TypeScript:
```bash
npm run build --prefix apps/functions -- --watch
# O para levantar emuladores (si est谩n configurados)
npm run serve --prefix apps/functions

================================================================================
FILE: service-account.json.json
================================================================================
{
  "type": "service_account",
  "project_id": "comtroldata",
  "private_key_id": "542b807649adab8f5142487ad529a0522adff565",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC+EARTAdAae35J\n11vk1mozAg+JRUgHjJ3n2tgcHHJToQZZdWBN090Q2nyxM3j4cdoR5BrDV9x5nhSj\nIU9QTE9Z2Sc4iFx6xac1Di8JdZpWXb7S3Y1n2EIPyeVJLiejzLYExG/ha9JV8mO9\nj0eD+UShtTHXVWhToA/6Jm2o1IZlmoWdTH9cDd8frMAYIOi8aZmpR/rP5H7RGRej\nAvRqoC9eoizbA8u0QHGzkIAvezbOgCBy55J/bVZ1N7ARitdGsnIbiK5H9Sv9QIjC\n0kz+EIdAMH6K3B8YuwtmCX53TMO8xBeGs+CTwXM86tic50WbdnTRV88uAOTEbTBC\nZPr8EiVNAgMBAAECggEAPfzeVC5Gr6RwU2f8Th3KRDmbVJN2gxPPGmPrUPvMI89k\nUT/xeWCsfIct3ONjRHBphaVGP0jEHRw8Mdo20oMY7D5hRtReiSI2vxyRpb2n6Rwp\nFP/yUxiaryiTcfMuNYOaJ+LjdHtkfeiQtC3rTrU5N55vk4IFBSUyoMzwvfwWm0Mi\nJfqmtGO0ADAUGgftkZlmd7Vh7yt3JNJRbsZW/hZFIAAsg7o8kQZ+5Frwmwo8Ntn+\nUd4QryPAtBEUgTeafdeCKzs49Yi3RdbB60CBrcCq8uHgKGPP8xoga2VIIbx+smgr\nV6rDp0GPXpEz3P5pq6LBKAQkfMd/1PMe7B0kCxPQpwKBgQD2X7befQ7JrR+HqZr0\nMnJlzOFUbZT9TOL70e0LhOK7UE5tV5PXC1am8DIx/zuMcIC80f8hnyelHHopEv4+\nvyChk4/U2NbU0ECxPqmDsFsIJJRt/Tc3/9TR8S3L7ZM7s+AezkxuEourrq5DSU1i\n2gLuee1V85oANt3+zUBnt69/BwKBgQDFfRB8MP3GDEk5Y3lm+k8o+P9iLM4V/ZFQ\ny57wq9pEZxWTbXyWefaN7aeg3wRxVpNQTK0HaT8mNppSBeI9c7S3EL5SbvkCyTUk\nVHTN8o4BnQizVwkv5+ILU8UGW6dz/JFhxw55HyiiJO9bbxWzbCQK6pioCOVHDrf7\nZafvlp7QCwKBgQCTDJXNPb8xyE7lXenKjsGQ2TQ0fCNM/DMOMkHVej8JpejpgjgP\nRgk2Im8TQE9+hzePe5dXrfKvrcuL8HYnZVRInBZg5/txkcrK/6eVnhD3Tz34WAY5\nOkz/8X9wFCCopbfDK0aa/B65Hc2NA5dYxN6zD7sEbh0gu57Mkh06ynvIyQKBgQCV\nDSI/CV7PdgBh/vDmxu6t9tgRCc31DO77MuNfs+TFkaPYJF9O1vg+AGtu4ENjIzuF\n9Ij3Ofj+Z2GrnGM3jDeNn2Z1ounvr1qbc97AfVuuXg3uBTea34FcmTnv5YcJ5Er5\nqBoFUn4BeqzornuLcof1cUAMOsKJEdPMOto32s88JwKBgBts8voUhdhCqWu7sDLB\nF6fAuzOQxKxiWB0CPn8GHNJwZgjiPB5+Hj9mZRyfsS5Bn8fmCrC8q4MTpKmpURMd\nxmXteJP63Y6z2TQz8DhfVL84/0cTxC9nkRFqYeIkz+AiHkP8aw5u95f3QbThaGiM\nQzvcb4tHgOvJh5+G4cOnOfHH\n-----END PRIVATE KEY-----\n",
  "client_email": "firebase-adminsdk-fbsvc@comtroldata.iam.gserviceaccount.com",
  "client_id": "109561112383296200622",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-fbsvc%40comtroldata.iam.gserviceaccount.com",
  "universe_domain": "googleapis.com"
}


================================================================================
FILE: set-admin-role.js
================================================================================
const admin = require('firebase-admin');
// Aseg煤rate de tener tu archivo de credenciales aqu铆
const serviceAccount = require('./service-account.json'); 

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

const uid = 'BIar6f7ILATdkucXKH9NTDUkKQG2'; //  COPIA AQU EL UID DE TU USUARIO QUE FALLA

async function setAdminRole() {
  try {
    // 1. Asignar el Custom Claim 'role: admin'
    await admin.auth().setCustomUserClaims(uid, { role: 'admin' });
    
    console.log(` XITO: Rol de admin asignado al usuario ${uid}`);
    console.log('锔 IMPORTANTE: Debes cerrar sesi贸n y volver a entrar para que el token se actualice.');
    
    // Verificaci贸n
    const user = await admin.auth().getUser(uid);
    console.log('Claims actuales:', user.customClaims);
    
  } catch (error) {
    console.error(' Error:', error);
  }
}

setAdminRole();

================================================================================
FILE: set-employee-role.js
================================================================================
const admin = require('firebase-admin');
const serviceAccount = require('./service-account.json'); 

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount)
  });
}

//  ESTE ES EL UID QUE SAQU DE TU CAPTURA DE PANTALLA
const uid = 'MBKd9pqsSPXPcxsLxyPUdC8NFCd2'; 

async function setEmployeeRole() {
  try {
    console.log(` Buscando usuario ${uid}...`);
    
    // 1. Asignar el Custom Claim en Auth (El sello en la tarjeta)
    await admin.auth().setCustomUserClaims(uid, { role: 'employee' });
    
    console.log(` XITO: Rol 'employee' asignado a D茅bora.`);
    console.log(`锔 IMPORTANTE: Ella debe cerrar sesi贸n y volver a entrar.`);

  } catch (error) {
    console.error(' Error:', error.message);
  }
}

setEmployeeRole();

================================================================================
FILE: vite.config.js
================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react-swc'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})

