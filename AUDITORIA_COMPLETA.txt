AUDITORA DE PROYECTO CONTROL DATA
Fecha: 2025-12-04T16:52:40.286Z
----------------------------------------


================================================================================
FILE: apps\functions\jest.config.js
================================================================================
/** @type {import('ts-jest').JestConfigWithTsJest} */
module.exports = {
  // Configuraci贸n base para proyectos TypeScript con Jest
  preset: 'ts-jest', 
  
  // Entorno de ejecuci贸n de Node.js (necesario para el backend)
  testEnvironment: 'node', 
  
  // Rutas donde buscar los archivos fuente y de prueba
  roots: ['<rootDir>/src/', '<rootDir>/test/'],
  
  // Expresiones regulares para identificar archivos de prueba (archivos terminados en .spec.ts o .test.ts)
  testRegex: '(/__tests__/.*|(\\.|/)(test|spec))\\.ts$',

  // Configuraci贸n de M贸dulos (para resolver rutas internas de NestJS)
  moduleNameMapper: {
    // Si tienes aliases definidos en tsconfig.json, se deben mapear aqu铆
  },
  
  // CLAVE: Definici贸n expl铆cita del transformador para manejar TypeScript
  transform: {
    // Usar ts-jest para todos los archivos .ts
    '^.+\\.ts$': [
      'ts-jest', 
      {
        // Indica a ts-jest que use el archivo de configuraci贸n de TypeScript del proyecto actual
        tsconfig: './tsconfig.json', 
      },
    ],
  },
  
  // Extensiones de archivos que debe buscar
  moduleFileExtensions: ['js', 'json', 'ts'],

  // Carpetas a ignorar para la transformaci贸n y ejecuci贸n
  testPathIgnorePatterns: [
    '/node_modules/',
    '/lib/' // Carpeta de salida de la compilaci贸n
  ],
  
  // Configuraci贸n de Cobertura de C贸digo (Opcional, pero recomendado en la WBS)
  collectCoverageFrom: [
    'src/**/*.{js,ts}'
  ],
  coverageDirectory: 'coverage',
};

================================================================================
FILE: apps\functions\package.json
================================================================================
{
  "name": "functions",
  "scripts": {
    "lint": "eslint --ext .ts,.js src/",
    "serve": "npm run build && firebase emulators:start --only functions",
    "shell": "npm run build && firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log",
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "test:watch": "jest --watch"
  },
  "engines": {
    "node": "18"
  },
  "main": "lib/index.js",
  "dependencies": {
    "@nestjs/common": "^10.0.0",
    "@nestjs/core": "^10.0.0",
    "firebase-admin": "^11.8.0",
    "firebase-functions": "^4.3.1",
    "reflect-metadata": "^0.1.13",
    "module-alias": "^2.2.3"
  },
  "devDependencies": {
    "@types/node": "^20.11.24",
    "@types/jest": "^29.5.12",
    "jest": "^29.7.0",
    "ts-jest": "^29.1.2",
    "@typescript-eslint/eslint-plugin": "^5.59.7",
    "@typescript-eslint/parser": "^5.59.7",
    "eslint": "^8.14.0",
    "eslint-config-google": "^0.14.0",
    "eslint-plugin-import": "^2.26.0",
    "typescript": "^5.3.3"
  },
  "_moduleAliases": {
    "@common": "lib/common"
  }
}

================================================================================
FILE: apps\functions\src\app.module.ts
================================================================================
// apps/functions/src/app.module.ts
import { Module } from '@nestjs/common';
import { AuthModule } from './auth/auth.module';
import { SchedulingModule } from './scheduling/scheduling.module';
import { DataManagementModule } from './data-management/data-management.module'; // Importar nuevo m贸dulo

@Module({
  imports: [
    AuthModule,
    SchedulingModule,
    DataManagementModule, // Incluir el m贸dulo de gesti贸n de datos
  ],
  controllers: [],
  providers: [],
})
export class AppModule {}

================================================================================
FILE: apps\functions\src\auth\auth.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { AuthService } from './auth.service';

/**
 * @module AuthModule
 * @description M贸dulo encargado de la creaci贸n de usuarios, asignaci贸n de roles (Custom Claims)
 * y gesti贸n de perfiles en la colecci贸n 'empleados'.
 */
@Module({
  imports: [],
  providers: [AuthService],
  exports: [AuthService], // Exportamos el servicio para que otros m贸dulos lo utilicen.
})
export class AuthModule {}

================================================================================
FILE: apps\functions\src\auth\auth.service.ts
================================================================================
import { Injectable, InternalServerErrorException, ConflictException } from '@nestjs/common';
import * as admin from 'firebase-admin';
// Usamos ruta relativa para evitar problemas de alias en el build
import { IEmployee } from '../common/interfaces/employee.interface';

const EMPLOYEES_COLLECTION = 'empleados';

@Injectable()
export class AuthService {

  //  Inicializaci贸n diferida (Lazy Loading) para evitar error 'app/no-app'
  private getAuth = () => admin.app().auth();
  private getDb = () => admin.app().firestore();

  async createEmployeeProfile(
    email: string,
    password: string,
    role: IEmployee['role'],
    name: string,
  ): Promise<IEmployee> {
    
    const authInstance = this.getAuth(); 
    
    // 1. Crear usuario en Auth
    const user = await authInstance.createUser({
      email,
      password,
      displayName: name,
      emailVerified: true,
    }).catch(error => {
      if (error.code === 'auth/email-already-exists') {
        throw new ConflictException('The email address is already in use.');
      }
      console.error('[AUTH_CREATE_ERROR]', error.message);
      throw new InternalServerErrorException('Failed to create user in Firebase Auth.');
    });

    const employeeUid = user.uid;

    // 2. Asignar Custom Claims (Rol)
    try {
      await authInstance.setCustomUserClaims(employeeUid, { role });
    } catch (error) {
      console.error(`[CLAIMS_ERROR] Failed to set claims.`, error);
      await authInstance.deleteUser(employeeUid); 
      throw new InternalServerErrorException('Failed to assign role. Account creation aborted.');
    }
    
    // 3. Crear Perfil en Firestore
    //  FIX TS2739: Agregamos los nuevos campos obligatorios con valores por defecto
    const employeeProfile: IEmployee = {
      uid: employeeUid,
      email: email,
      name: name,
      role: role,
      isAvailable: true,
      maxHoursPerMonth: 176,        // Valor est谩ndar (Convenio)
      contractType: 'FullTime'      // Valor est谩ndar
    };
    
    const dbInstance = this.getDb();
    
    try {
      await dbInstance.collection(EMPLOYEES_COLLECTION).doc(employeeUid).set(employeeProfile);
    } catch (error) {
      console.error(`[FIRESTORE_ERROR] Failed to create profile.`, error);
      await authInstance.deleteUser(employeeUid);
      throw new InternalServerErrorException('Failed to save profile. Account creation aborted.');
    }

    return employeeProfile;
  }
}

================================================================================
FILE: apps\functions\src\auth\guards\roles.guard.ts
================================================================================
// apps/functions/src/auth/guards/roles.guard.ts
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { IEmployee } from '../../common/interfaces/employee.interface'; //  RUTA FINAL: Retrocede 2 niveles
import 'reflect-metadata'; 

// ... (resto del c贸digo permanece igual)

// 1. Decorador para definir los roles requeridos
export const ROLES_KEY = 'roles';
export const Roles = (...roles: IEmployee['role'][]) => 
  (target: any, key?: any, descriptor?: any) => {
    // Uso corregido de Reflect (Soluci贸n TS2339)
    Reflect.defineMetadata(ROLES_KEY, roles, descriptor.value || target);
  };


@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const requiredRoles = this.reflector.get<IEmployee['role'][]>(
      ROLES_KEY,
      context.getHandler(),
    );

    if (!requiredRoles) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const userRole = request.context?.auth?.token?.role;

    if (!userRole) {
        return false;
    }

    return requiredRoles.some((role) => role === userRole);
  }
}

================================================================================
FILE: apps\functions\src\common\interfaces\absence.interface.ts
================================================================================
import * as admin from 'firebase-admin';

export type AbsenceType = 'Vacation' | 'SickLeave' | 'PersonalDay' | 'Unjustified';

/**
 * @interface IAbsence
 * @description Representa un per铆odo en el que el empleado NO est谩 disponible.
 * Se almacena en la colecci贸n 'ausencias'.
 */
export interface IAbsence {
  id: string;
  employeeId: string;
  type: AbsenceType;
  
  /** Fecha de inicio de la ausencia (Inclusive) */
  startDate: admin.firestore.Timestamp;
  
  /** Fecha de fin de la ausencia (Inclusive) */
  endDate: admin.firestore.Timestamp;
  
  reason?: string;
  approvedBy: string; // UID del Admin que carg贸 la novedad
  createdAt: admin.firestore.Timestamp;
}

================================================================================
FILE: apps\functions\src\common\interfaces\api.interface.ts
================================================================================
// api.interface.ts (Ejemplo de respuesta estandarizada de API Gateway/Backend)
export interface IApiResponse<T> {
  success: boolean;
  data: T;
  message?: string;
}

// employee.interface.ts (Aseguramos la interfaz de IEmployee)
export interface IEmployee {
  uid: string;
  name: string;
  role: string;
  // A帽adir cualquier otro campo relevante (ej: maxHoursPerMonth, email)
}

================================================================================
FILE: apps\functions\src\common\interfaces\client.interface.ts
================================================================================
import * as admin from 'firebase-admin';

/**
 * @interface IClient
 * @description La empresa o entidad que contrata nuestros servicios de seguridad/personal.
 * Es la entidad ra铆z de la jerarqu铆a comercial.
 */
export interface IClient {
  id: string;
  /** Raz贸n Social o Nombre Comercial */
  businessName: string; 
  /** Identificaci贸n Fiscal (CUIT/RUT/NIT) */
  cuit: string;         
  /** Nombre del contacto principal */
  contactName: string;
  /** Email del contacto para notificaciones autom谩ticas */
  contactEmail: string;
  /** Estado administrativo del cliente */
  status: 'Active' | 'Inactive' | 'Suspended';
  /** Fecha de alta en el sistema */
  createdAt: admin.firestore.Timestamp;
}

/**
 * @interface IObjective
 * @description El lugar f铆sico, sucursal o puesto donde se presta el servicio.
 * Pertenece a un Cliente.
 */
export interface IObjective {
  id: string;
  /** ID del Cliente al que pertenece (Foreign Key) */
  clientId: string; 
  /** Nombre del objetivo (Ej: "Planta Industrial Pilar") */
  name: string;     
  /** Direcci贸n f铆sica real */
  address: string;
  /** Coordenadas para el Geofencing (Check-in/out) */
  location: {
    latitude: number;
    longitude: number;
  };
  /** Zonas internas (opcional). Ej: ["Garita 1", "Recepci贸n", "Ronda"] */
  zones?: string[]; 
}

/**
 * @interface IServiceContract
 * @description Define el acuerdo de nivel de servicio (SLA) para un Objetivo.
 * Establece cu谩ntas horas se vendieron y en qu茅 per铆odo.
 */
export interface IServiceContract {
  id: string;
  /** ID del Objetivo asociado (Foreign Key) */
  objectiveId: string; 
  /** Nombre del servicio (Ej: "Seguridad 24x7 - 2025") */
  name: string;        
  startDate: admin.firestore.Timestamp;
  endDate?: admin.firestore.Timestamp; // Opcional si es indeterminado
  /** Objetivo de venta mensual en horas (para reportes de rentabilidad) */
  totalHoursPerMonth: number; 
  isActive: boolean;
}

/**
 * @interface IShiftType (Modalidad)
 * @description Plantilla de turno para agilizar la planificaci贸n.
 * Define los "moldes" que se arrastrar谩n al calendario.
 */
export interface IShiftType {
  id: string;
  /** ID del Contrato al que pertenece esta modalidad (Foreign Key) */
  contractId: string; 
  /** Nombre descriptivo (Ej: "Turno Tarde 8hs") */
  name: string;       
  /** C贸digo corto para visualizaci贸n en calendario (Ej: "T8") */
  code: string;       
  /** Color hexadecimal para diferenciar en el calendario (Ej: "#FF5733") */
  color: string;      
  
  // Configuraci贸n del Horario Base
  /** Hora de inicio sugerida en formato "HH:mm" (Ej: "14:00") */
  startTime: string;     
  /** Duraci贸n en horas para c谩lculo de costos (Ej: 8) */
  durationHours: number; 
  
  /** Requisitos espec铆ficos (Opcional). Ej: "Vigilador Armado", "Chofer" */
  requiredRole?: string; 
}

================================================================================
FILE: apps\functions\src\common\interfaces\employee.interface.ts
================================================================================
/**
 * @typedef {string} EmployeeRole
 * @description Define los roles de seguridad del sistema.
 */
export type EmployeeRole = 'admin' | 'employee';

/**
 * @typedef {string} ContractType
 * @description Define la modalidad de contrataci贸n para reglas de negocio.
 */
export type ContractType = 'FullTime' | 'PartTime' | 'Eventual';

/**
 * @interface IEmployee
 * @description Estructura del documento de perfil de empleado en Firestore.
 */
export interface IEmployee {
  /**
   * ID 煤nico del usuario de Firebase Authentication (UID).
   */
  uid: string;
  /**
   * Nombre completo del empleado.
   */
  name: string;
  /**
   * Rol asignado (para Custom Claims y reglas de seguridad).
   */
  role: EmployeeRole;
  /**
   * Correo electr贸nico para acceso.
   */
  email: string;
  /**
   * Indica si el empleado est谩 activo en la empresa.
   */
  isAvailable: boolean;

  //  NUEVOS CAMPOS DE CONTROL DE NEGOCIO (WFM)
  /**
   * L铆mite de horas mensuales permitidas (Ej: 176 hs est谩ndar).
   * Si se supera, el sistema bloquear谩 la asignaci贸n de nuevos turnos.
   */
  maxHoursPerMonth: number;
  
  /**
   * Tipo de contrato.
   */
  contractType: ContractType;
}

================================================================================
FILE: apps\functions\src\common\interfaces\shift.interface.ts
================================================================================
// apps/functions/src/common/interfaces/shift.interface.ts
import * as admin from 'firebase-admin'; //  CAMBIO CLAVE: Importar el m贸dulo core de admin

export interface IShift {
  id: string;
  employeeId: string;
  employeeName: string;
  objectiveId: string;
  objectiveName: string;
  //  Referenciar el Timestamp a trav茅s del namespace de admin.
  startTime: admin.firestore.Timestamp; 
  endTime: admin.firestore.Timestamp;
  status: 'Assigned' | 'Confirmed' | 'InProgress' | 'Completed' | 'Canceled';
  checkInTime?: admin.firestore.Timestamp;
  checkOutTime?: admin.firestore.Timestamp;
  schedulerId: string;
  updatedAt: admin.firestore.Timestamp;
}

================================================================================
FILE: apps\functions\src\common\interfaces\system-user.interface.ts
================================================================================
import * as admin from 'firebase-admin';

/**
 * Roles espec铆ficos para el Back-Office.
 */
export type SystemRole = 'SuperAdmin' | 'Scheduler' | 'HR_Manager' | 'Viewer';

/**
 * @interface ISystemUser
 * @description Usuario administrativo con acceso al Panel de Control.
 * Se almacena en la colecci贸n 'system_users'.
 */
export interface ISystemUser {
  uid: string;
  email: string;
  displayName: string;
  role: SystemRole;
  
  /** Estado del acceso */
  status: 'Active' | 'Inactive';
  
  /** Fecha de creaci贸n */
  createdAt: admin.firestore.Timestamp;
  
  /** ltimo acceso (Opcional, para auditor铆a futura) */
  lastLogin?: admin.firestore.Timestamp;
}

================================================================================
FILE: apps\functions\src\data-management\absence.interface.ts
================================================================================
import * as admin from 'firebase-admin';

/**
 * Estructura de la entidad Ausencia almacenada en Firestore.
 */
export interface IAbsence {
    id: string; 
    employeeId: string;
    employeeName: string;
    clientId: string; 
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER'; 
    startDate: admin.firestore.Timestamp; 
    endDate: admin.firestore.Timestamp; 
    reason: string; 
    status: 'PENDING' | 'APPROVED' | 'REJECTED'; 
    createdAt: admin.firestore.Timestamp;
}

/**
 * Payload recibido del Frontend.
 *  ES CRTICO QUE ESTA INTERFAZ TENGA 'export' PARA QUE EL SERVICIO LA VEA.
 */
export interface IAbsencePayload {
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    // Flexible: Timestamp (si viene de otro servicio) o Date (si viene de JSON serializado)
    startDate: admin.firestore.Timestamp | Date; 
    endDate: admin.firestore.Timestamp | Date;
    reason: string;
}

================================================================================
FILE: apps\functions\src\data-management\absence.service.ts
================================================================================
import { Injectable, ConflictException } from '@nestjs/common';
import * as admin from 'firebase-admin'; //  CORREGIDO: Importaci贸n de m贸dulo
import { WorkloadService } from '../scheduling/workload.service';
import { IAbsence, IAbsencePayload } from '../common/interfaces/absence.interface';

@Injectable()
export class AbsenceService {
    private getDb = () => admin.app().firestore();
    private readonly absencesCollection = this.getDb().collection('absences');
    
    constructor(private readonly workloadService: WorkloadService) {}

    async createAbsence(payload: IAbsencePayload): Promise<IAbsence> {
        const { employeeId, startDate, endDate, clientId } = payload;
        
        // Convertimos los inputs a Timestamps de Firestore para consistencia
        const startTimestamp = startDate as unknown as admin.firestore.Timestamp;
        const endTimestamp = endDate as unknown as admin.firestore.Timestamp;

        // 1. Validar solapamiento (Usa el m茅todo reci茅n agregado en WorkloadService)
        // Usamos .toDate() porque WorkloadService trabaja con objetos Date de JS
        const conflictingShifts = await this.workloadService.checkShiftOverlap(
            employeeId,
            startTimestamp.toDate(), 
            endTimestamp.toDate()    
        );

        if (conflictingShifts.length > 0) {
            console.warn(`[AbsenceService] Conflict found for employee ${employeeId}`);
            throw new ConflictException(`Conflict: Employee has ${conflictingShifts.length} shifts assigned during this period.`);
        }

        // 2. Crear el objeto a persistir
        const newAbsence: Omit<IAbsence, 'id'> = {
            employeeId: payload.employeeId,
            employeeName: payload.employeeName,
            clientId: payload.clientId,
            type: payload.type,
            startDate: startTimestamp,
            endDate: endTimestamp,     
            reason: payload.reason,
            status: 'APPROVED', 
            createdAt: admin.firestore.Timestamp.now(), 
        };

        const docRef = await this.absencesCollection.add(newAbsence);
        
        return { id: docRef.id, ...newAbsence } as IAbsence;
    }
}

================================================================================
FILE: apps\functions\src\data-management\client.service.ts
================================================================================
import { Injectable, NotFoundException, InternalServerErrorException } from '@nestjs/common';
import * as admin from 'firebase-admin';
// Rutas relativas correctas para evitar errores de compilaci贸n TS2307
import { 
  IClient, 
  IObjective, 
  IServiceContract, 
  IShiftType 
} from '../common/interfaces/client.interface'; 

const COLL_CLIENTS = 'clientes';
const COLL_OBJECTIVES = 'objetivos';
const COLL_CONTRACTS = 'contratos_servicio';
const COLL_SHIFT_TYPES = 'tipos_turno';

@Injectable()
export class ClientService {

  //  Inicializaci贸n diferida (Lazy Loading) para evitar error 'app/no-app'
  private getDb = () => admin.app().firestore();

  // ==========================================
  // 1. GESTIN DE CLIENTES (EMPRESAS)
  // ==========================================

  async createClient(data: Omit<IClient, 'id' | 'createdAt'>): Promise<IClient> {
    const db = this.getDb();
    const ref = db.collection(COLL_CLIENTS).doc();
    
    const newClient: IClient = {
      ...data,
      id: ref.id,
      createdAt: admin.firestore.Timestamp.now(),
    };

    await ref.set(newClient);
    return newClient;
  }

  async getClient(id: string): Promise<IClient> {
    const doc = await this.getDb().collection(COLL_CLIENTS).doc(id).get();
    if (!doc.exists) throw new NotFoundException('Cliente no encontrado');
    return { id: doc.id, ...doc.data() } as IClient;
  }

  async findAllClients(): Promise<IClient[]> {
    try {
      // Nota: Si quieres ver incluso los eliminados/inactivos, quita el .where
      const snapshot = await this.getDb().collection(COLL_CLIENTS)
        // .where('status', '==', 'Active') // Descomentar para filtrar solo activos
        .get();

      if (snapshot.empty) return [];

      return snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
      } as IClient));

    } catch (error) {
      console.error('[ERROR_FIND_CLIENTS]', error);
      throw new InternalServerErrorException('Error al consultar clientes.');
    }
  }

  //  NUEVO: Actualizar Cliente
  async updateClient(id: string, data: Partial<IClient>): Promise<void> {
    const ref = this.getDb().collection(COLL_CLIENTS).doc(id);
    
    // Protecci贸n: No permitir modificar ID ni fecha de creaci贸n
    const updateData = { ...data };
    delete (updateData as any).id;
    delete (updateData as any).createdAt;

    await ref.update(updateData);
  }

  //  NUEVO: Eliminar Cliente
  async deleteClient(id: string): Promise<void> {
    await this.getDb().collection(COLL_CLIENTS).doc(id).delete();
  }

  // ==========================================
  // 2. GESTIN DE OBJETIVOS (SEDES)
  // ==========================================

  async createObjective(data: Omit<IObjective, 'id'>): Promise<IObjective> {
    await this.getClient(data.clientId); // Validar existencia

    const db = this.getDb();
    const ref = db.collection(COLL_OBJECTIVES).doc();

    const newObjective: IObjective = {
      ...data,
      id: ref.id,
    };

    await ref.set(newObjective);
    return newObjective;
  }

  async getObjectivesByClient(clientId: string): Promise<IObjective[]> {
    const snapshot = await this.getDb().collection(COLL_OBJECTIVES)
      .where('clientId', '==', clientId)
      .get();
    return snapshot.docs.map(d => ({ id: d.id, ...d.data() }) as IObjective);
  }

  public async getClientById(clientId: string): Promise<IClient> {
      return this.getClient(clientId);
  }
  
  public async getObjectiveById(objectiveId: string): Promise<IObjective> {
      const doc = await this.getDb().collection(COLL_OBJECTIVES).doc(objectiveId).get();
      if (!doc.exists) {
          throw new NotFoundException(`Objective with ID ${objectiveId} not found.`);
      }
      return { id: doc.id, ...doc.data() } as IObjective;
  }

  // ==========================================
  // 3. GESTIN DE CONTRATOS
  // ==========================================

  async createServiceContract(data: Omit<IServiceContract, 'id'>): Promise<IServiceContract> {
    const db = this.getDb();
    const ref = db.collection(COLL_CONTRACTS).doc();
    
    let startDate: admin.firestore.Timestamp;
    
    // Manejo robusto de fechas entrantes (JSON o Date)
    if (data.startDate instanceof admin.firestore.Timestamp) {
        startDate = data.startDate;
    } else if ((data.startDate as any)._seconds) {
        startDate = new admin.firestore.Timestamp((data.startDate as any)._seconds, (data.startDate as any)._nanoseconds);
    } else {
        startDate = admin.firestore.Timestamp.fromDate(new Date(data.startDate as any));
    }

    const newContract: IServiceContract = {
      ...data,
      id: ref.id,
      startDate: startDate,
    };

    await ref.set(newContract);
    return newContract;
  }

  // ==========================================
  // 4. GESTIN DE MODALIDADES
  // ==========================================

  async createShiftType(data: Omit<IShiftType, 'id'>): Promise<IShiftType> {
    const db = this.getDb();
    const ref = db.collection(COLL_SHIFT_TYPES).doc();

    const newType: IShiftType = {
      ...data,
      id: ref.id,
    };

    await ref.set(newType);
    return newType;
  }

  async getShiftTypesByContract(contractId: string): Promise<IShiftType[]> {
    const snapshot = await this.getDb().collection(COLL_SHIFT_TYPES)
      .where('contractId', '==', contractId)
      .get();
    return snapshot.docs.map(d => ({ id: d.id, ...d.data() }) as IShiftType);
  }
}

================================================================================
FILE: apps\functions\src\data-management\data-management.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { DataManagementService } from './data-management.service';
import { ClientService } from './client.service';
import { EmployeeService } from './employee.service';
//  Importamos el nuevo servicio de usuarios del sistema
import { SystemUserService } from './system-user.service';

@Module({
  imports: [],
  providers: [
    DataManagementService, // Objetivos b谩sicos (Legacy)
    ClientService,         // Jerarqu铆a Comercial
    EmployeeService,       // RRHH (Operativos)
    SystemUserService      //  Gesti贸n de Admins (Back-Office)
  ],
  exports: [
    DataManagementService,
    ClientService,
    EmployeeService,
    SystemUserService      //  Exportar para usar en index.ts
  ],
})
export class DataManagementModule {}

================================================================================
FILE: apps\functions\src\data-management\data-management.service.ts
================================================================================
import { Injectable, NotFoundException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IClient, IObjective } from '../common/interfaces/client.interface'; // RUTA RELATIVA FINAL
import { IShift } from '../common/interfaces/shift.interface'; // RUTA RELATIVA FINAL (Aunque IShift no se usa directamente aqu铆, la mantenemos si es necesario)

const CLIENTS_COLLECTION = 'clientes';
const OBJECTIVES_COLLECTION = 'objetivos';
//  ELIMINADO: const db = admin.firestore(); // Eliminado para resolver el error 'app/no-app'

/**
 * @class DataManagementService
 * @description Servicio CRUD para las entidades Cliente y Objetivo (P1). 
 */
@Injectable()
export class DataManagementService {
  
  //  FIX: Getter para asegurar que Firestore solo se accede despu茅s de initializeApp()
  private getDb = () => admin.app().firestore();

  // --- CRUD para Objetivos (Sucursales/Puestos) ---

  async createObjective(objectiveData: Omit<IObjective, 'id'>): Promise<IObjective> {
    const dbInstance = this.getDb();
    const newRef = dbInstance.collection(OBJECTIVES_COLLECTION).doc();
    const objective: IObjective = {
      ...objectiveData,
      id: newRef.id,
    };
    await newRef.set(objective);
    return objective;
  }

  async findAllObjectives(clientId?: string): Promise<IObjective[]> {
    const dbInstance = this.getDb();
    let query: admin.firestore.Query = dbInstance.collection(OBJECTIVES_COLLECTION);
    
    if (clientId) {
      query = query.where('clientId', '==', clientId);
    }

    const snapshot = await query.get();
    if (snapshot.empty) {
        return [];
    }

    return snapshot.docs.map(doc => doc.data() as IObjective);
  }
  
  // --- M茅todos de Lectura (Cr铆ticos para el Check-In) ---
  
  public async getClientById(clientId: string): Promise<IClient> {
      const dbInstance = this.getDb();
      const doc = await dbInstance.collection(CLIENTS_COLLECTION).doc(clientId).get();
      if (!doc.exists) {
          throw new NotFoundException(`Client with ID ${clientId} not found.`);
      }
      return doc.data() as IClient;
  }
  
  public async getObjectiveById(objectiveId: string): Promise<IObjective> {
      const dbInstance = this.getDb();
      const doc = await dbInstance.collection(OBJECTIVES_COLLECTION).doc(objectiveId).get();
      if (!doc.exists) {
          throw new NotFoundException(`Objective with ID ${objectiveId} not found.`);
      }
      return doc.data() as IObjective;
  }
}

================================================================================
FILE: apps\functions\src\data-management\employee.service.ts
================================================================================
import { Injectable, NotFoundException, InternalServerErrorException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IEmployee } from '../common/interfaces/employee.interface';

const COLL_EMPLOYEES = 'empleados';

@Injectable()
export class EmployeeService {

  // Inicializaci贸n diferida para evitar errores de 'app/no-app'
  private getDb = () => admin.app().firestore();
  private getAuth = () => admin.app().auth();

  /**
   * Obtiene todos los empleados registrados.
   */
  async findAllEmployees(): Promise<IEmployee[]> {
    try {
      const snapshot = await this.getDb().collection(COLL_EMPLOYEES).get();
      return snapshot.docs.map(doc => doc.data() as IEmployee);
    } catch (error) {
      console.error('[GET_EMPLOYEES_ERROR]', error);
      throw new InternalServerErrorException('Error al obtener la lista de empleados.');
    }
  }

  /**
   * Actualiza los datos de un empleado (Ej: cambiar l铆mite de horas o rol).
   */
  async updateEmployee(uid: string, data: Partial<IEmployee>): Promise<void> {
    const db = this.getDb();
    const auth = this.getAuth();
    
    // 1. Actualizar en Firestore
    const ref = db.collection(COLL_EMPLOYEES).doc(uid);
    const doc = await ref.get();

    if (!doc.exists) {
        throw new NotFoundException('Empleado no encontrado.');
    }

    // Protegemos campos inmutables
    delete (data as any).uid;
    delete (data as any).email; 

    await ref.update(data);

    // 2. Si cambi贸 el rol, actualizar Custom Claims en Auth
    if (data.role) {
        try {
            await auth.setCustomUserClaims(uid, { role: data.role });
        } catch (e) {
            console.error(`Error actualizando claims para ${uid}`, e);
            // No fallamos todo el proceso, pero logueamos el error
        }
    }
  }

  /**
   * Elimina un empleado (Firestore + Auth).
   */
  async deleteEmployee(uid: string): Promise<void> {
    try {
        // 1. Borrar de Auth (Impide nuevo login)
        await this.getAuth().deleteUser(uid);
        
        // 2. Borrar de Firestore (Opcional: Podr铆as solo marcarlo como inactivo)
        await this.getDb().collection(COLL_EMPLOYEES).doc(uid).delete();
    } catch (error) {
        console.error('[DELETE_EMPLOYEE_ERROR]', error);
        throw new InternalServerErrorException('Error al eliminar el empleado.');
    }
  }
}

================================================================================
FILE: apps\functions\src\data-management\system-user.service.ts
================================================================================
import { Injectable, InternalServerErrorException, ConflictException, NotFoundException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { ISystemUser, SystemRole } from '../common/interfaces/system-user.interface';

const COLL_SYSTEM_USERS = 'system_users';

@Injectable()
export class SystemUserService {

  // Inicializaci贸n diferida
  private getAuth = () => admin.app().auth();
  private getDb = () => admin.app().firestore();

  /**
   * Crea un nuevo usuario administrativo.
   */
  async createSystemUser(data: { email: string, password: string, displayName: string, role: SystemRole }): Promise<ISystemUser> {
    const auth = this.getAuth();
    const db = this.getDb();

    // 1. Crear en Auth
    const userRecord = await auth.createUser({
      email: data.email,
      password: data.password,
      displayName: data.displayName,
      emailVerified: true,
    }).catch(error => {
      if (error.code === 'auth/email-already-exists') throw new ConflictException('El email ya est谩 registrado.');
      throw new InternalServerErrorException('Error al crear usuario en Auth.');
    });

    // 2. Asignar Claims (Rol)
    // Nota: Agregamos un claim 'type: admin' para diferenciarlo de empleados
    await auth.setCustomUserClaims(userRecord.uid, { role: data.role, type: 'system_user' });

    // 3. Crear Perfil en Firestore
    const newUser: ISystemUser = {
      uid: userRecord.uid,
      email: data.email,
      displayName: data.displayName,
      role: data.role,
      status: 'Active',
      createdAt: admin.firestore.Timestamp.now()
    };

    await db.collection(COLL_SYSTEM_USERS).doc(userRecord.uid).set(newUser);
    
    return newUser;
  }

  /**
   * Obtener todos los administradores.
   */
  async findAll(): Promise<ISystemUser[]> {
    const snapshot = await this.getDb().collection(COLL_SYSTEM_USERS).get();
    return snapshot.docs.map(doc => doc.data() as ISystemUser);
  }

  /**
   * Actualizar datos (Rol o Estado).
   */
  async updateSystemUser(uid: string, data: Partial<ISystemUser>): Promise<void> {
    const auth = this.getAuth();
    const db = this.getDb();

    // Si cambia el rol, actualizar Auth
    if (data.role) {
        await auth.setCustomUserClaims(uid, { role: data.role, type: 'system_user' });
    }

    // Si se desactiva, deshabilitar en Auth
    if (data.status) {
        await auth.updateUser(uid, { disabled: data.status === 'Inactive' });
    }

    // Actualizar Firestore
    const safeData = { ...data };
    delete (safeData as any).uid;
    delete (safeData as any).email; // No cambiamos email por aqu铆
    
    await db.collection(COLL_SYSTEM_USERS).doc(uid).update(safeData);
  }

  /**
   * Eliminar administrador.
   */
  async deleteSystemUser(uid: string): Promise<void> {
    await this.getAuth().deleteUser(uid);
    await this.getDb().collection(COLL_SYSTEM_USERS).doc(uid).delete();
  }
}

================================================================================
FILE: apps\functions\src\index.ts
================================================================================
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import { createNestApp } from './main';
import { INestApplicationContext } from '@nestjs/common';

// Servicios
import { SchedulingService } from './scheduling/scheduling.service';
import { AuthService } from './auth/auth.service';
import { DataManagementService } from './data-management/data-management.service';
import { AuditService } from './scheduling/audit.service';
import { ClientService } from './data-management/client.service';
import { EmployeeService } from './data-management/employee.service';
import { SystemUserService } from './data-management/system-user.service';

// Interfaces (Rutas relativas para backend)
import { EmployeeRole, IEmployee } from './common/interfaces/employee.interface';
import { IClient, IObjective, IServiceContract, IShiftType } from './common/interfaces/client.interface';
import { ISystemUser } from './common/interfaces/system-user.interface';

// Inicializaci贸n
admin.initializeApp();

let nestApp: INestApplicationContext;

async function getService<T>(service: new (...args: any[]) => T): Promise<T> {
  if (!nestApp) {
    nestApp = await createNestApp();
  }
  return nestApp.get<T>(service); 
}

//  FIX: Definimos qu茅 roles se consideran "Administradores"
const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager'];
const ALLOWED_ROLES: EmployeeRole[] = ['admin', 'employee']; 

// =========================================================
// 1. GESTIN DE USUARIOS (AUTH)
// =========================================================
export const createUser = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  
  //  Validaci贸n de Rol Mejorada: Permite SuperAdmin, Scheduler, etc.
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado. Rol insuficiente.');
  }

  try {
    const authService = await getService(AuthService);
    const { email, password, name, role: receivedRole } = data;
    
    if (!ALLOWED_ROLES.includes(receivedRole as EmployeeRole)) {
        throw new functions.https.HttpsError('invalid-argument', 'Rol inv谩lido.');
    }
    const validRole = receivedRole as EmployeeRole;
    // Orden corregido: email, password, role, name
    const newEmployee = await authService.createEmployeeProfile(email, password, validRole, name);

    return { success: true, uid: newEmployee.uid };
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[CREATE_USER_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', 'Error al crear usuario.');
  }
});

// =========================================================
// 2. MOTOR DE AGENDAMIENTO
// =========================================================
export const scheduleShift = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;

  //  Validaci贸n de Rol Mejorada
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado. Rol insuficiente.');
  }

  try {
    const schedulingService = await getService(SchedulingService);
    const result = await schedulingService.assignShift(data, callerAuth.token);
    return { success: true, shiftId: result.id };
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[SCHEDULE_SHIFT_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', `Error: ${err.message}`);
  }
});

// =========================================================
// 3. AUDITORA (GEOFENCING)
// =========================================================
export const auditShift = functions.https.onCall(async (data, context) => {
  // Esta funci贸n la pueden usar empleados, as铆 que solo validamos autenticaci贸n
  if (!context.auth) throw new functions.https.HttpsError('unauthenticated', 'Requiere autenticaci贸n.');

  try {
    const auditService = await getService(AuditService);
    const result = await auditService.auditShiftAction(data.shiftId, data.action, data.coords, context.auth.uid);
    return { success: true, newStatus: result.status };
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[AUDIT_SHIFT_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 4. GESTIN DE DATOS BSICOS
// =========================================================
export const manageData = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  //  Validaci贸n de Rol Mejorada
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }

  const { action, payload } = data;
  try {
    const dmService = await getService(DataManagementService);
    switch (action) {
      case 'CREATE_OBJECTIVE': return { success: true, data: await dmService.createObjective(payload) };
      case 'GET_ALL_OBJECTIVES': return { success: true, data: await dmService.findAllObjectives(payload?.clientId) };
      case 'GET_CLIENT_BY_ID': return { success: true, data: await dmService.getClientById(payload.clientId) };
      default: throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[DATA_MANAGEMENT_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 5. GESTIN DE JERARQUA COMERCIAL
// =========================================================
export const manageHierarchy = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  //  Validaci贸n de Rol Mejorada
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }
  
  const { action, payload } = data as { action: string, payload: any };

  try {
    const clientService = await getService(ClientService);

    switch (action) {
      case 'CREATE_CLIENT': return { success: true, data: await clientService.createClient(payload) };
      case 'GET_CLIENT': return { success: true, data: await clientService.getClient(payload.id) };
      case 'GET_ALL_CLIENTS': return { success: true, data: await clientService.findAllClients() };
      case 'UPDATE_CLIENT': await clientService.updateClient(payload.id, payload.data); return { success: true, message: 'Cliente actualizado' };
      case 'DELETE_CLIENT': await clientService.deleteClient(payload.id); return { success: true, message: 'Cliente eliminado' };
      case 'CREATE_OBJECTIVE': return { success: true, data: await clientService.createObjective(payload) };
      case 'CREATE_CONTRACT': return { success: true, data: await clientService.createServiceContract(payload) };
      case 'CREATE_SHIFT_TYPE': return { success: true, data: await clientService.createShiftType(payload) };
      case 'GET_SHIFT_TYPES': return { success: true, data: await clientService.getShiftTypesByContract(payload.contractId) };
      default: throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[HIERARCHY_ERROR] Action ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    throw new functions.https.HttpsError('internal', `Error: ${err.message}`);
  }
});

// =========================================================
// 6. GESTIN DE EMPLEADOS (RRHH)
// =========================================================
export const manageEmployees = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  //  Validaci贸n de Rol Mejorada
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }
  
  const { action, payload } = data as { action: string, payload: any };
  try {
    const employeeService = await getService(EmployeeService);
    switch (action) {
      case 'GET_ALL_EMPLOYEES':
        const employees = await employeeService.findAllEmployees();
        return { success: true, data: employees };
      case 'UPDATE_EMPLOYEE':
        await employeeService.updateEmployee(payload.uid, payload.data);
        return { success: true, message: 'Datos actualizados.' };
      case 'DELETE_EMPLOYEE':
        await employeeService.deleteEmployee(payload.uid);
        return { success: true, message: 'Empleado eliminado.' };
      default: throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[EMPLOYEE_ERROR] Action ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 7. GESTIN DE USUARIOS DEL SISTEMA (ADMINS)
// =========================================================
export const manageSystemUsers = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  //  Validaci贸n de Rol Mejorada (Incluso para gestionar admins, permitimos a SuperAdmin)
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }
  
  const { action, payload } = data as { action: string, payload: any };

  try {
    const sysUserService = await getService(SystemUserService);

    switch (action) {
      case 'CREATE_USER':
        await sysUserService.createSystemUser(payload);
        return { success: true, message: 'Administrador creado exitosamente.' };
      case 'GET_ALL_USERS':
        const users = await sysUserService.findAll();
        return { success: true, data: users };
      case 'UPDATE_USER':
        await sysUserService.updateSystemUser(payload.uid, payload.data);
        return { success: true, message: 'Administrador actualizado.' };
      case 'DELETE_USER':
        await sysUserService.deleteSystemUser(payload.uid);
        return { success: true, message: 'Administrador eliminado.' };
      default:
        throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[SYS_USER_ERROR] ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    throw new functions.https.HttpsError('internal', err.message);
  }
});

================================================================================
FILE: apps\functions\src\main.ts
================================================================================
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { INestApplicationContext } from '@nestjs/common';

/**
 * @async
 * @function createNestApp
 * @description Inicializa la aplicaci贸n NestJS y retorna el M贸dulo de Referencia.
 * @returns {Promise<INestApplicationContext>} El contexto de aplicaci贸n.
 */
export async function createNestApp(): Promise<INestApplicationContext> {
  // Usamos createApplicationContext para obtener el contexto de DI sin listener HTTP
  const app = await NestFactory.createApplicationContext(AppModule, { logger: false });
  
  await app.init();
  return app;
}

================================================================================
FILE: apps\functions\src\scheduling\audit.service.ts
================================================================================
import { Injectable, BadRequestException, ForbiddenException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { GeofencingService } from './geofencing.service';
import { DataManagementService } from '../data-management/data-management.service'; 
import { IShift } from '../common/interfaces/shift.interface'; // RUTA RELATIVA FINAL
import * as functions from 'firebase-functions';
import { IObjective } from '../common/interfaces/client.interface'; 

const SHIFTS_COLLECTION = 'turnos';
//  ELIMINADO: const db = admin.firestore(); // <--- ESTO CAUSABA EL ERROR

@Injectable()
export class AuditService {
  
  constructor(
    private readonly geofencingService: GeofencingService,
    private readonly dmService: DataManagementService,
  ) {}

  //  FIX: Getter privado para Inicializaci贸n Diferida (Lazy Init)
  private getDb = () => admin.app().firestore();

  async auditShiftAction(
    shiftId: string,
    action: 'CHECK_IN' | 'CHECK_OUT',
    employeeCoords: { latitude: number, longitude: number },
    employeeUid: string,
  ): Promise<IShift> {
    
    const dbInstance = this.getDb(); //  Usar la instancia diferida
    const shiftRef = dbInstance.collection(SHIFTS_COLLECTION).doc(shiftId);
    
    return dbInstance.runTransaction(async (transaction) => {
      const shiftDoc = await transaction.get(shiftRef);

      if (!shiftDoc.exists) {
        throw new BadRequestException('Shift not found.');
      }

      const shift = shiftDoc.data() as IShift;
      
      // Regla 1: Autorizaci贸n de Propiedad
      if (shift.employeeId !== employeeUid) {
        throw new ForbiddenException('No est谩s autorizado para modificar este turno.');
      }
      
      // Regla 2: Obtener Coordenadas del Objetivo
      const objective = await this.dmService.getObjectiveById(shift.objectiveId) as IObjective; 
      
      // Regla 3: Verificaci贸n de Geofence (P4)
      const objectiveCoords = objective.location;
      if (!this.geofencingService.isInGeofence(employeeCoords, objectiveCoords)) {
        console.warn(`Geofence failed for ${employeeUid} at shift ${shiftId}.`);
        throw new functions.https.HttpsError('failed-precondition', 'Debe estar cerca del objetivo para registrar la acci贸n.');
      }
      
      // Regla 4: L贸gica de Estado y Actualizaci贸n
      const now = admin.firestore.Timestamp.now();
      let newStatus: IShift['status'];

      if (action === 'CHECK_IN' && shift.status === 'Assigned') {
        newStatus = 'InProgress';
        shift.checkInTime = now;
      } else if (action === 'CHECK_OUT' && shift.status === 'InProgress') {
        newStatus = 'Completed';
        shift.checkOutTime = now;
      } else {
        throw new BadRequestException(`Acci贸n ${action} inv谩lida para el estado actual: ${shift.status}.`);
      }
      
      // Actualizaci贸n At贸mica
      shift.status = newStatus;
      shift.updatedAt = now;
      transaction.update(shiftRef, shift as Partial<IShift>);

      return shift;
    });
  }
}

================================================================================
FILE: apps\functions\src\scheduling\geofencing.service.ts
================================================================================
import { Injectable } from '@nestjs/common';

// Radio de la Tierra en kil贸metros (km)
const EARTH_RADIUS_KM = 6371;

// Radio de tolerancia: El empleado debe estar a menos de 100 metros del objetivo.
const GEOFENCE_RADIUS_KM = 0.1; // 100 metros

interface Coordinates {
  latitude: number;
  longitude: number;
}

/**
 * @class GeofencingService
 * @description L贸gica pura para el c谩lculo de distancia y verificaci贸n de Geofence (SRP/D5).
 */
@Injectable()
export class GeofencingService {

  /**
   * @function degreesToRadians
   * @description Convierte grados decimales a radianes.
   */
  private degreesToRadians(degrees: number): number {
    return degrees * (Math.PI / 180);
  }

  /**
   * @function calculateDistance
   * @description Calcula la distancia entre dos pares de coordenadas (F贸rmula del Haversine).
   * @returns {number} Distancia en kil贸metros.
   */
  public calculateDistance(p1: Coordinates, p2: Coordinates): number {
    const lat1 = this.degreesToRadians(p1.latitude);
    const lon1 = this.degreesToRadians(p1.longitude);
    const lat2 = this.degreesToRadians(p2.latitude);
    const lon2 = this.degreesToRadians(p2.longitude);

    const dLat = lat2 - lat1;
    const dLon = lon2 - lon1;

    // F贸rmula Haversine
    const a = 
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) * Math.sin(dLon / 2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return EARTH_RADIUS_KM * c; // Distancia en KM
  }

  /**
   * @function isInGeofence
   * @description Verifica si el punto del empleado est谩 dentro del radio del objetivo.
   * @param {Coordinates} employeeCoords - Coordenadas reportadas por el empleado.
   * @param {Coordinates} objectiveCoords - Coordenadas registradas del objetivo.
   * @returns {boolean} True si la distancia es menor al radio de tolerancia.
   */
  public isInGeofence(employeeCoords: Coordinates, objectiveCoords: Coordinates): boolean {
    const distance = this.calculateDistance(employeeCoords, objectiveCoords);
    return distance <= GEOFENCE_RADIUS_KM;
  }
}

================================================================================
FILE: apps\functions\src\scheduling\scheduling.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { SchedulingService } from './scheduling.service';
import { ShiftOverlapService } from './shift-overlap.service';
//  Importamos el nuevo servicio de reglas de negocio
import { WorkloadService } from '../scheduling/workload.service';

/**
 * @module SchedulingModule
 * @description M贸dulo de NestJS para toda la l贸gica de agendamiento de turnos.
 * Agrupa los servicios de asignaci贸n, validaci贸n de solapamiento y carga de trabajo.
 */
@Module({
  imports: [],
  providers: [
    SchedulingService,      // Servicio Principal
    ShiftOverlapService,    // Validador de Solapamiento (P2)
    WorkloadService         // Validador de Carga/Ausencias (Reglas de Negocio)
  ],
  exports: [SchedulingService], // Exportamos el servicio principal para usarlo en index.ts
})
export class SchedulingModule {}

================================================================================
FILE: apps\functions\src\scheduling\scheduling.service.ts
================================================================================
import { Injectable, InternalServerErrorException, BadRequestException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IShift } from '../common/interfaces/shift.interface'; // RUTA RELATIVA FINAL
import { ShiftOverlapService } from './shift-overlap.service';
import { WorkloadService } from './workload.service';
import * as functions from 'firebase-functions';

const SHIFTS_COLLECTION = 'turnos';

@Injectable()
export class SchedulingService {
  
  // Inicializaci贸n diferida (Lazy Init)
  private getDb = () => admin.app().firestore();

  constructor(
    private readonly overlapService: ShiftOverlapService,
    private readonly workloadService: WorkloadService
  ) {}

  /**
   *  FIX CRTICO: Funci贸n auxiliar para sanear fechas que vienen por la red.
   * Maneja: Firestore Timestamp, Serialized Timestamp ({_seconds}), Strings e ISOs.
   */
  private convertToDate(input: any): Date {
    if (!input) throw new Error('Fecha inv谩lida o inexistente.');
    
    // Caso 1: Es un Timestamp de Firestore real (tiene .toDate)
    if (typeof input.toDate === 'function') {
        return input.toDate();
    }
    // Caso 2: Es un Timestamp serializado (viene del Frontend como JSON)
    if (input._seconds !== undefined) {
        return new Date(input._seconds * 1000);
    }
    // Caso 3: Es un objeto seconds/nanoseconds est谩ndar de Google
    if (input.seconds !== undefined) {
        return new Date(input.seconds * 1000);
    }
    // Caso 4: Es un string ISO o n煤mero
    return new Date(input);
  }

  async assignShift(shiftData: Partial<IShift>, userAuth: admin.auth.DecodedIdToken): Promise<IShift> {
    const dbInstance = this.getDb(); 
    const newShiftRef = dbInstance.collection(SHIFTS_COLLECTION).doc();
    
    // 1. Validaci贸n de campos requeridos
    if (!shiftData.startTime || !shiftData.endTime || !shiftData.employeeId || !shiftData.objectiveId) {
        throw new functions.https.HttpsError('invalid-argument', 'Faltan datos requeridos: inicio, fin, empleado u objetivo.');
    }
    
    //  USAMOS LA NUEVA FUNCIN DE CONVERSIN AQU
    let newStart: Date;
    let newEnd: Date;

    try {
        newStart = this.convertToDate(shiftData.startTime);
        newEnd = this.convertToDate(shiftData.endTime);
    } catch (e) {
        throw new functions.https.HttpsError('invalid-argument', 'Formato de fecha inv谩lido recibido del cliente.');
    }
    
    const employeeId = shiftData.employeeId!;

    // 2. Validaci贸n de coherencia temporal
    if (newStart.getTime() >= newEnd.getTime()) {
      throw new BadRequestException('La hora de inicio debe ser anterior a la hora de fin.');
    }

    // 3. VALIDACIN DE REGLAS DE NEGOCIO (WFM)
    try {
        await this.workloadService.validateAssignment(employeeId, newStart, newEnd);
    } catch (businessRuleError: any) {
        console.warn(`[BUSINESS_RULE_BLOCK] ${businessRuleError.message}`);
        throw new functions.https.HttpsError('failed-precondition', businessRuleError.message);
    }

    try {
      await dbInstance.runTransaction(async (transaction) => {
        
        // 4. Verificaci贸n de Solapamiento
        const overlappingQuery = dbInstance.collection(SHIFTS_COLLECTION)
          .where('employeeId', '==', employeeId)
          .where('endTime', '>', newStart) 
          .where('startTime', '<', newEnd) 
          .limit(1);

        const snapshot = await transaction.get(overlappingQuery);

        if (!snapshot.empty) {
          const existingShift = snapshot.docs[0].data(); // Data cruda
          // Convertimos tambi茅n las fechas de la DB por seguridad
          const existingStart = this.convertToDate(existingShift.startTime);
          const existingEnd = this.convertToDate(existingShift.endTime);

          if (this.overlapService.isOverlap(existingStart, existingEnd, newStart, newEnd)) {
             console.error(`[SCHEDULING_ABORTED] Overlap detected for Employee: ${employeeId}.`);
             throw new functions.https.HttpsError('already-exists', 'El empleado ya tiene otro turno asignado en este horario.');
          }
        }
        
        // Escritura del nuevo turno
        const finalShift: IShift = {
          id: newShiftRef.id,
          employeeId: employeeId,
          objectiveId: shiftData.objectiveId!,
          employeeName: shiftData.employeeName || 'NOMBRE_NO_PROVISTO', 
          objectiveName: shiftData.objectiveName || 'OBJETIVO_NO_PROVISTO',
          // Guardamos como Timestamp de Firestore para consistencia en la DB
          startTime: admin.firestore.Timestamp.fromDate(newStart), 
          endTime: admin.firestore.Timestamp.fromDate(newEnd),
          status: 'Assigned',
          schedulerId: userAuth.uid,
          updatedAt: admin.firestore.Timestamp.now(),
        };

        transaction.set(newShiftRef, finalShift);
        return finalShift.id; 
      });

      return { id: newShiftRef.id, ...shiftData } as IShift;

    } catch (error: any) {
        if (error instanceof functions.https.HttpsError) {
            throw error;
        }

        const errorMessage = error.message || 'Error desconocido';

        if (errorMessage.includes('LMITE') || errorMessage.includes('BLOQUEO') || errorMessage.includes('ausente')) {
             console.warn(`[BUSINESS_RULE_VIOLATION] ${errorMessage}`);
             throw new functions.https.HttpsError('failed-precondition', errorMessage);
        }
        
        console.error(`[SCHEDULING_TRANSACTION_FAILURE] ${errorMessage}`, error.stack);
        throw new functions.https.HttpsError('internal', `Error en la asignaci贸n: ${errorMessage}`);
    }
  }
}

================================================================================
FILE: apps\functions\src\scheduling\shift-overlap.service.spec.ts
================================================================================
// D5: Unit Test que verifica la REGRA DE NEGOCIO m谩s importante.
import { ShiftOverlapService } from '../../src/scheduling/shift-overlap.service';

describe('ShiftOverlapService (Core Logic D5)', () => {
  let service: ShiftOverlapService;

  beforeEach(() => {
    service = new ShiftOverlapService();
  });

  // Turno base: De 10:00 a 14:00 (4 horas)
  const T_START = new Date('2025-11-20T10:00:00.000Z');
  const T_END = new Date('2025-11-20T14:00:00.000Z');

  // CASOS DE XITO (Solapamiento)
  it('should return TRUE if the new shift starts inside and ends outside the existing shift', () => {
    // Nuevo turno: 12:00 a 16:00
    const newStart = new Date('2025-11-20T12:00:00.000Z');
    const newEnd = new Date('2025-11-20T16:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });

  it('should return TRUE if the new shift is entirely contained within the existing shift', () => {
    // Nuevo turno: 11:00 a 13:00
    const newStart = new Date('2025-11-20T11:00:00.000Z');
    const newEnd = new Date('2025-11-20T13:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });
  
  it('should return TRUE if the new shift starts before and ends inside the existing shift', () => {
    // Nuevo turno: 09:00 a 11:00
    const newStart = new Date('2025-11-20T09:00:00.000Z');
    const newEnd = new Date('2025-11-20T11:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });

  // CASOS DE FRACASO (No Solapamiento)
  it('should return FALSE if the new shift is adjacent (starts exactly when the other ends)', () => {
    // Nuevo turno: 14:00 a 18:00
    const newStart = new Date('2025-11-20T14:00:00.000Z');
    const newEnd = new Date('2025-11-20T18:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift ends exactly when the other starts', () => {
    // Nuevo turno: 06:00 a 10:00
    const newStart = new Date('2025-11-20T06:00:00.000Z');
    const newEnd = new Date('2025-11-20T10:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift is completely outside the range', () => {
    // Nuevo turno: 07:00 a 09:00
    const newStart = new Date('2025-11-20T07:00:00.000Z');
    const newEnd = new Date('2025-11-20T09:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });
});

================================================================================
FILE: apps\functions\src\scheduling\shift-overlap.service.ts
================================================================================
import { Injectable } from '@nestjs/common';

/**
 * @class ShiftOverlapService
 * @description Servicio que encapsula la l贸gica pura (matem谩tica) para determinar
 * si dos rangos de tiempo se cruzan. Cumple con SRP (SOLID).
 */
@Injectable()
export class ShiftOverlapService {

  /**
   * @function isOverlap
   * @description Verifica si un nuevo rango de tiempo se superpone con un rango existente.
   * La f贸rmula evita solapamiento si los turnos son adyacentes (ej: uno termina a las 14:00 y el otro empieza a las 14:00).
   * @param {Date} existingStart - Inicio del turno ya registrado.
   * @param {Date} existingEnd - Fin del turno ya registrado.
   * @param {Date} newStart - Inicio del nuevo turno.
   * @param {Date} newEnd - Fin del nuevo turno.
   * @returns {boolean} True si hay solapamiento.
   */
  public isOverlap(existingStart: Date, existingEnd: Date, newStart: Date, newEnd: Date): boolean {
    // Si el nuevo empieza antes de que el existente termine Y el nuevo termina despues de que el existente empiece, S hay solapamiento.
    return (
      newStart.getTime() < existingEnd.getTime() && 
      newEnd.getTime() > existingStart.getTime()
    );
  }
}

================================================================================
FILE: apps\functions\src\scheduling\workload.service.ts
================================================================================
import { Injectable, BadRequestException, ConflictException } from '@nestjs/common';
import * as admin from 'firebase-admin';
//  IMPORTANTE: Rutas relativas ajustadas para estar en la carpeta 'scheduling'
import { IEmployee } from '../common/interfaces/employee.interface';
import { IAbsence } from '../common/interfaces/absence.interface';
import { IShift } from '../common/interfaces/shift.interface';

const EMPLOYEES_COLLECTION = 'empleados';
const ABSENCES_COLLECTION = 'ausencias';
const SHIFTS_COLLECTION = 'turnos';

@Injectable()
export class WorkloadService {
  
  //  Inicializaci贸n diferida (Lazy Loading)
  private getDb = () => admin.app().firestore();

  /**
   * Valida TODAS las reglas de negocio antes de asignar un turno.
   */
  async validateAssignment(employeeId: string, shiftStart: Date, shiftEnd: Date): Promise<void> {
    const db = this.getDb();

    // 1. Obtener datos del empleado
    const empDoc = await db.collection(EMPLOYEES_COLLECTION).doc(employeeId).get();
    if (!empDoc.exists) throw new BadRequestException('Employee not found');
    const employee = empDoc.data() as IEmployee;

    // REGLA 1: DISPONIBILIDAD
    await this.checkAvailability(employeeId, shiftStart, shiftEnd);

    // REGLA 2: LMITE MENSUAL
    await this.checkMonthlyLimit(employee, shiftStart, shiftEnd);
  }

  private async checkAvailability(employeeId: string, start: Date, end: Date): Promise<void> {
    const db = this.getDb();
    
    const absencesSnapshot = await db.collection(ABSENCES_COLLECTION)
      .where('employeeId', '==', employeeId)
      .where('endDate', '>=', start)
      .get();

    absencesSnapshot.forEach(doc => {
      const absence = doc.data() as IAbsence;
      const absStart = absence.startDate.toDate();
      const absEnd = absence.endDate.toDate();

      if (start < absEnd && end > absStart) {
        throw new ConflictException(`BLOQUEO: El empleado est谩 ausente por: ${absence.type}`);
      }
    });
  }

  private async checkMonthlyLimit(employee: IEmployee, newShiftStart: Date, newShiftEnd: Date): Promise<void> {
    const db = this.getDb();
    
    const newDurationHours = (newShiftEnd.getTime() - newShiftStart.getTime()) / (1000 * 60 * 60);

    const startOfMonth = new Date(newShiftStart.getFullYear(), newShiftStart.getMonth(), 1);
    const endOfMonth = new Date(newShiftStart.getFullYear(), newShiftStart.getMonth() + 1, 0, 23, 59, 59);

    const shiftsSnapshot = await db.collection(SHIFTS_COLLECTION)
      .where('employeeId', '==', employee.uid)
      .where('startTime', '>=', startOfMonth)
      .where('startTime', '<=', endOfMonth)
      .get();

    let accumulatedHours = 0;

    shiftsSnapshot.forEach(doc => {
      const shift = doc.data() as IShift;
      
      const sStart = (shift.startTime as any).toDate ? (shift.startTime as any).toDate() : new Date((shift.startTime as any).seconds * 1000);
      const sEnd = (shift.endTime as any).toDate ? (shift.endTime as any).toDate() : new Date((shift.endTime as any).seconds * 1000);
      
      const duration = (sEnd.getTime() - sStart.getTime()) / (1000 * 60 * 60);
      accumulatedHours += duration;
    });

    const totalProjected = accumulatedHours + newDurationHours;
    const maxHours = employee.maxHoursPerMonth || 176;

    if (totalProjected > maxHours) {
      throw new ConflictException(
        `LMITE EXCEDIDO: Acumulado(${accumulatedHours.toFixed(1)}h) + Nuevo(${newDurationHours.toFixed(1)}h) supera el m谩ximo de ${maxHours}h.`
      );
    }
  }
}

================================================================================
FILE: apps\functions\test\scheduling\shift-overlap.service.spec.js
================================================================================
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// D5: Unit Test que verifica la REGRA DE NEGOCIO m谩s importante.
const shift_overlap_service_1 = require("../../src/scheduling/shift-overlap.service");
describe('ShiftOverlapService (Core Logic D5)', () => {
    let service;
    beforeEach(() => {
        service = new shift_overlap_service_1.ShiftOverlapService();
    });
    // Turno base (existente): De 10:00 a 14:00 (4 horas)
    const T_START = new Date('2025-11-20T10:00:00.000Z');
    const T_END = new Date('2025-11-20T14:00:00.000Z');
    // =========================================================
    // ESCENARIO 2.2: PRUEBA DE SOLAPAMIENTO (DEBE FALLAR)
    // =========================================================
    it('should return TRUE if the new shift overlaps with the existing shift (Escenario 2.2)', () => {
        // Turno B: 11:00 AM a 01:00 PM (Completamente dentro)
        const newStart = new Date('2025-11-20T11:00:00.000Z');
        const newEnd = new Date('2025-11-20T13:00:00.000Z');
        // Si esta prueba pasa (TRUE), la Transacci贸n At贸mica ABORTAR.
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
    });
    // Turno que se superpone parcialmente (Escenario 2.2a)
    it('should return TRUE if the new shift starts inside and ends outside', () => {
        // Nuevo turno: 12:00 a 16:00
        const newStart = new Date('2025-11-20T12:00:00.000Z');
        const newEnd = new Date('2025-11-20T16:00:00.000Z');
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
    });
    // =========================================================
    // ESCENARIO 2.3: PRUEBA DE ADYACENCIA (DEBE PASAR)
    // =========================================================
    it('should return FALSE if the new shift is adjacent (starts exactly when the other ends - Escenario 2.3)', () => {
        // Turno C: 14:00 PM a 18:00 PM (Empieza justo donde termina A)
        const newStart = new Date('2025-11-20T14:00:00.000Z');
        const newEnd = new Date('2025-11-20T18:00:00.000Z');
        // Si esta prueba pasa (FALSE), la Transacci贸n At贸mica CONTINUAR.
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
    });
    it('should return FALSE if the new shift ends exactly when the other starts (Adyacente inverso)', () => {
        // Nuevo turno: 06:00 a 10:00
        const newStart = new Date('2025-11-20T06:00:00.000Z');
        const newEnd = new Date('2025-11-20T10:00:00.000Z');
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
    });
    it('should return FALSE if the new shift is completely outside the range', () => {
        // Nuevo turno: 07:00 a 09:00
        const newStart = new Date('2025-11-20T07:00:00.000Z');
        const newEnd = new Date('2025-11-20T09:00:00.000Z');
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
    });
});
//# sourceMappingURL=shift-overlap.service.spec.js.map

================================================================================
FILE: apps\functions\test\scheduling\shift-overlap.service.spec.ts
================================================================================
// D5: Unit Test que verifica la REGRA DE NEGOCIO m谩s importante.
import { ShiftOverlapService } from '../../src/scheduling/shift-overlap.service';

describe('ShiftOverlapService (Core Logic D5)', () => {
  let service: ShiftOverlapService;

  beforeEach(() => {
    service = new ShiftOverlapService();
  });

  // Turno base (existente): De 10:00 a 14:00 (4 horas)
  const T_START = new Date('2025-11-20T10:00:00.000Z');
  const T_END = new Date('2025-11-20T14:00:00.000Z');

  // =========================================================
  // ESCENARIO 2.2: PRUEBA DE SOLAPAMIENTO (DEBE FALLAR)
  // =========================================================
  it('should return TRUE if the new shift overlaps with the existing shift (Escenario 2.2)', () => {
    // Turno B: 11:00 AM a 01:00 PM (Completamente dentro)
    const newStart = new Date('2025-11-20T11:00:00.000Z');
    const newEnd = new Date('2025-11-20T13:00:00.000Z');
    
    // Si esta prueba pasa (TRUE), la Transacci贸n At贸mica ABORTAR.
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });

  // Turno que se superpone parcialmente (Escenario 2.2a)
  it('should return TRUE if the new shift starts inside and ends outside', () => {
    // Nuevo turno: 12:00 a 16:00
    const newStart = new Date('2025-11-20T12:00:00.000Z');
    const newEnd = new Date('2025-11-20T16:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });


  // =========================================================
  // ESCENARIO 2.3: PRUEBA DE ADYACENCIA (DEBE PASAR)
  // =========================================================
  it('should return FALSE if the new shift is adjacent (starts exactly when the other ends - Escenario 2.3)', () => {
    // Turno C: 14:00 PM a 18:00 PM (Empieza justo donde termina A)
    const newStart = new Date('2025-11-20T14:00:00.000Z');
    const newEnd = new Date('2025-11-20T18:00:00.000Z');
    
    // Si esta prueba pasa (FALSE), la Transacci贸n At贸mica CONTINUAR.
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift ends exactly when the other starts (Adyacente inverso)', () => {
    // Nuevo turno: 06:00 a 10:00
    const newStart = new Date('2025-11-20T06:00:00.000Z');
    const newEnd = new Date('2025-11-20T10:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift is completely outside the range', () => {
    // Nuevo turno: 07:00 a 09:00
    const newStart = new Date('2025-11-20T07:00:00.000Z');
    const newEnd = new Date('2025-11-20T09:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });
});

================================================================================
FILE: apps\functions\tsconfig.json
================================================================================
{
  "compilerOptions": {
    /* Opciones B谩sicas */
    "target": "es2020",                            /* Versi贸n del est谩ndar JS. */
    "module": "commonjs",                          /* Sistema de m贸dulos para Node.js/Functions. */
    "rootDir": "src",                              /* Directorio ra铆z de los archivos fuente de producci贸n. */
    "outDir": "lib",                               /* Directorio de salida. */
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "skipLibCheck": true,

    /* Tipado y Decoradores (NestJS) */
    "strict": true,
    "strictNullChecks": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,

    /* Rutas Absolutas (Para @common/*) */
    "baseUrl": "./src", 
    "paths": {
      "@common/*": ["common/*"], 
      "@auth/*": ["auth/*"]
    },

    /* Opciones de Debugging */
    "sourceMap": true
  },
  
  /* Archivos a Incluir y Excluir (SOLUCIN TS6059) */
  "include": [
    "src/**/*",                                    /* Incluye solo el c贸digo de producci贸n. */
    "test/**/*"                                    /* Incluimos los tests en el programa para el chequeo de tipos, pero los excluimos de la compilaci贸n. */
  ],
  "exclude": [
    "node_modules",                                
    "lib",                                         
    "test"                                         /*  CLAVE: Excluir la carpeta de tests de la compilaci贸n (TSC) final. */
  ]
}

================================================================================
FILE: apps\web\jest.config.js
================================================================================
// jest.config.js en apps/web/

/** @type {import('ts-jest').JestConfigWithTsJest} */
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  moduleNameMapper: {
    //  CRTICO: Mapear el alias @/ a la carpeta src/
    '^@/(.*)$': '<rootDir>/src/$1', 
    // Mapear archivos CSS y est谩ticos para Jest
    '\\.(css|less|scss|sass)$': 'identity-obj-proxy',
  },
  setupFilesAfterEnv: ['<rootDir>/setupTests.js'], // Archivo para importar @testing-library/jest-dom
};

================================================================================
FILE: apps\web\next-env.d.ts
================================================================================
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/pages/api-reference/config/typescript for more information.


================================================================================
FILE: apps\web\next.config.ts
================================================================================
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export',      //  CRTICO: Genera HTML est谩tico para Firebase Hosting
  images: {
    unoptimized: true,   //  CRTICO: Necesario para exportaci贸n est谩tica
  },
};

export default nextConfig;

================================================================================
FILE: apps\web\package.json
================================================================================
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@fullcalendar/daygrid": "^6.1.19",
    "@fullcalendar/interaction": "^6.1.19",
    "@fullcalendar/react": "^6.1.19",
    "@fullcalendar/timegrid": "^6.1.19",
    "firebase": "^12.6.0",
    "next": "16.0.5",
    "react": "19.2.0",
    "react-dom": "19.2.0",
    "react-hot-toast": "^2.6.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.22",
    "eslint": "^9",
    "eslint-config-next": "16.0.5",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "typescript": "^5"
  }
}


================================================================================
FILE: apps\web\pages\admin\clients\index.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/router';
import toast from 'react-hot-toast';
// Imports con alias @/ para evitar errores de ruta
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { callManageHierarchy } from '@/services/firebase-client.service';
import { IClient } from '@/common/interfaces/client.interface';

function ClientsListPage() {
  const router = useRouter();
  const [clients, setClients] = useState<IClient[]>([]);
  const [loading, setLoading] = useState(true);

  // Cargar clientes desde el Backend
  const fetchClients = async () => {
    setLoading(true);
    try {
      const res = await callManageHierarchy({ action: 'GET_ALL_CLIENTS', payload: {} });
      // Casting necesario porque la respuesta viene gen茅rica
      const responseData = res.data as any; 
      setClients(responseData.data || []);
    } catch (error) {
      console.error(error);
      toast.error("Error al cargar la cartera de clientes.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchClients();
  }, []);

  // Manejar borrado de cliente
  const handleDelete = async (id: string, name: string) => {
    if (!confirm(`驴Est谩s seguro de eliminar a ${name}? Esta acci贸n no se puede deshacer y podr铆a afectar datos hist贸ricos.`)) return;
    
    try {
      const loadingToast = toast.loading("Eliminando...");
      await callManageHierarchy({ action: 'DELETE_CLIENT', payload: { id } });
      toast.dismiss(loadingToast);
      toast.success("Cliente eliminado correctamente");
      fetchClients(); // Recargar lista
    } catch (error) {
      console.error(error);
      toast.error("No se pudo eliminar el cliente.");
    }
  };

  return (
    <DashboardLayout title="Cartera de Clientes">
      
      {/* Cabecera con Bot贸n de Crear */}
      <div className="flex justify-between items-center mb-6">
        <div>
            <h2 className="text-xl font-bold text-gray-800">Empresas</h2>
            <p className="text-sm text-gray-500">Gestione sus clientes, contratos y objetivos.</p>
        </div>
        <button 
            onClick={() => router.push('/admin/clients/new')} 
            className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center text-sm font-medium shadow-sm"
        >
            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
            Nuevo Cliente
        </button>
      </div>

      {/* Tabla de Clientes */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        {loading ? (
            <div className="p-12 text-center">
                <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-indigo-500 border-t-transparent"></div>
                <p className="mt-2 text-gray-500">Cargando cartera...</p>
            </div>
        ) : clients.length === 0 ? (
            <div className="p-12 text-center">
                <div className="mx-auto h-12 w-12 text-gray-300 mb-3 bg-gray-100 rounded-full flex items-center justify-center">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a2 2 0 00-2-2H7a2 2 0 00-2 2v5m14 0v-5a2 2 0 00-2-2h-2a2 2 0 00-2 2v5" /></svg>
                </div>
                <h3 className="text-lg font-medium text-gray-900">No hay clientes registrados</h3>
                <p className="mt-1 text-gray-500">Comience agregando su primera empresa cliente.</p>
            </div>
        ) : (
            <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                    <tr>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Raz贸n Social</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">CUIT</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Contacto</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Estado</th>
                        <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                    {clients.map((client) => (
                        <tr key={client.id} className="hover:bg-gray-50 transition duration-150">
                            <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm font-bold text-gray-900">{client.businessName}</div>
                                <div className="text-xs text-gray-400 font-mono mt-0.5">{client.id.substring(0, 8)}...</div>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">
                                {client.cuit}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm text-gray-900">{client.contactName || '-'}</div>
                                <div className="text-xs text-gray-500">{client.contactEmail}</div>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap">
                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${client.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                    {client.status}
                                </span>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button 
                                    onClick={() => router.push(`/admin/clients/${client.id}`)}
                                    className="text-indigo-600 hover:text-indigo-900 mr-4 font-semibold transition-colors"
                                >
                                    Editar
                                </button>
                                <button 
                                    //  FIX: Usamos String() y fallback para evitar el error TS2345
                                    onClick={() => handleDelete(client.id, String(client.businessName || 'Cliente'))}
                                    className="text-red-600 hover:text-red-900 font-semibold transition-colors"
                                >
                                    Eliminar
                                </button>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
            </div>
        )}
      </div>
    </DashboardLayout>
  );
}

// Exportamos con 'as any' para evitar el conflicto de tipos del HOC
export default withAuthGuard(ClientsListPage as any, 'admin');

================================================================================
FILE: apps\web\pages\admin\clients\new.tsx
================================================================================
import React from 'react';
// Imports con alias @/
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
// Importamos el componente Wizard que creamos antes
import { ClientSetupWizard } from '@/components/admin/client-setup-wizard';

function NewClientPage() {
  return (
    <DashboardLayout title="Alta de Cliente y Servicio">
      <div className="py-6">
        {/* Renderizamos el asistente aqu铆 */}
        <ClientSetupWizard />
      </div>
    </DashboardLayout>
  );
}

// Protegemos la ruta solo para admins
export default withAuthGuard(NewClientPage as any, 'admin');

================================================================================
FILE: apps\web\pages\admin\dashboard.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { DragAndDropScheduler } from '@/components/admin/scheduler';

function AdminDashboardPage() {
  return (
    <DashboardLayout title="Panel de Control Operativo">
      
      {/* 1. SECCIN DE KPIs / ESTADSTICAS */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4 transition-transform hover:scale-[1.02]">
            <div className="p-3 bg-blue-50 rounded-xl text-blue-600">
                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
            </div>
            <div>
                <p className="text-sm font-medium text-slate-500">Colaboradores Activos</p>
                <p className="text-2xl font-bold text-slate-800">24</p>
            </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4 transition-transform hover:scale-[1.02]">
            <div className="p-3 bg-green-50 rounded-xl text-green-600">
                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            </div>
            <div>
                <p className="text-sm font-medium text-slate-500">Turnos Programados</p>
                <p className="text-2xl font-bold text-slate-800">8</p>
            </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4 transition-transform hover:scale-[1.02]">
            <div className="p-3 bg-purple-50 rounded-xl text-purple-600">
                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <div>
                <p className="text-sm font-medium text-slate-500">Cobertura de Objetivos</p>
                <p className="text-2xl font-bold text-slate-800">98%</p>
            </div>
        </div>
      </div>

      {/* 2. SECCIN PRINCIPAL: PLANIFICADOR VISUAL */}
      <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <div>
                <h3 className="text-lg font-bold text-slate-800">Planificador de Cronogramas</h3>
                <p className="text-sm text-slate-500">Arrastra colaboradores al calendario para asignar turnos.</p>
            </div>
            <div className="hidden sm:block">
                <span className="px-3 py-1 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded-full">Vista Semanal</span>
            </div>
        </div>
        
        <div className="p-6">
            <DragAndDropScheduler />
        </div>
      </div>

    </DashboardLayout>
  );
}

// Exportaci贸n protegida solo para administradores
export default withAuthGuard(AdminDashboardPage as any, 'admin');

================================================================================
FILE: apps\web\pages\admin\employees.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { EmployeeManagement } from '@/components/admin/employee-management';

function EmployeesPage() {
  return (
    <DashboardLayout title="Gesti贸n de Recursos Humanos">
      <EmployeeManagement />
    </DashboardLayout>
  );
}

export default withAuthGuard(EmployeesPage as any, 'admin');

================================================================================
FILE: apps\web\pages\admin\objective-management.tsx
================================================================================
import React from 'react';
import { ObjectiveManagement } from '@/components/admin/objective-management';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout'; // Importamos el Layout

const ObjectiveManagementPage = () => {
  return (
    // Envolvemos el componente en el Layout
    <DashboardLayout title="Gesti贸n de Objetivos y Sucursales">
      <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
         <ObjectiveManagement />
      </div>
    </DashboardLayout>
  );
};

export default withAuthGuard(ObjectiveManagementPage as any, 'admin');

================================================================================
FILE: apps\web\pages\admin\rrhh\novedades.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout'; // Importaci贸n con llaves
import { AbsenceManagementPage } from '@/components/admin/AbsenceManagementPage';

function NovedadesPage() {
  return (
    //  SOLUCIN: Agregamos la prop 'title' obligatoria
    <DashboardLayout title="Gesti贸n de Novedades">
      <div className="p-6">
        <h1 className="text-2xl font-bold text-slate-800 mb-2">Gesti贸n de RRHH</h1>
        <p className="text-gray-500 mb-6">Registrar licencias, vacaciones y novedades.</p>
        <AbsenceManagementPage />
      </div>
    </DashboardLayout>
  );
}

export default withAuthGuard(NovedadesPage, 'admin');

================================================================================
FILE: apps\web\pages\admin\status.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
//  CORRECCIN: Agregamos llaves { } para usar la exportaci贸n nombrada
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { SystemStatus } from '@/components/admin/SystemStatus';

function StatusPage() {
  return (
    <DashboardLayout title="Diagn贸stico de Sistema">
      <div className="p-6">
        <SystemStatus />
      </div>
    </DashboardLayout>
  );
}

export default withAuthGuard(StatusPage, 'admin');

================================================================================
FILE: apps\web\pages\admin\system-users.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { SystemUserManagement } from '@/components/admin/system-user-management';

function SystemUsersPage() {
  return (
    <DashboardLayout title="Configuraci贸n de Acceso">
      <SystemUserManagement />
    </DashboardLayout>
  );
}

export default withAuthGuard(SystemUsersPage as any, 'admin');

================================================================================
FILE: apps\web\pages\employee\dashboard.tsx
================================================================================
import React from 'react';
import { useRouter } from 'next/router';
// 1. Importamos el guardia
import { withAuthGuard } from '@/components/common/withAuthGuard';
// 2. Importamos SOLO el componente visual del empleado que acabamos de revisar
import { EmployeeDashboard } from '@/components/employee/employee-dashboard';
import { auth } from '@/services/firebase-client.service';

function EmployeePage({ currentUser }: { currentUser: any }) {
  const router = useRouter();

  const handleLogout = async () => {
    await auth.signOut();
    window.location.href = '/';
  };

  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      {/* Header Exclusivo de Empleado (Sin Admin Sidebar) */}
      <header className="bg-white shadow-sm px-4 py-4 flex justify-between items-center sticky top-0 z-10">
        <div className="flex items-center space-x-2">
            <div className="bg-indigo-600 p-1.5 rounded-lg">
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            </div>
            <div className="leading-tight">
                <h1 className="text-lg font-bold text-gray-800">Mi Portal</h1>
                <p className="text-xs text-gray-500">{currentUser?.email}</p>
            </div>
        </div>
        
        <button onClick={handleLogout} className="text-sm text-red-600 font-medium border border-red-100 px-3 py-1.5 rounded-lg hover:bg-red-50">
            Salir
        </button>
      </header>

      <main>
        <EmployeeDashboard currentUser={currentUser} />
      </main>
    </div>
  );
}

//  NICO GUARDIA: Solo para 'employee'
export default withAuthGuard(EmployeePage as any, 'employee');

================================================================================
FILE: apps\web\pages\employee\employees.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
// Importamos el componente de gesti贸n que ya tienes en src/components
import { EmployeeManagement } from '@/components/admin/employee-management';

function EmployeesPage() {
  return (
    <DashboardLayout title="Gesti贸n de Recursos Humanos">
      <div className="p-6">
        <div className="mb-6">
            <h1 className="text-2xl font-bold text-slate-800">N贸mina de Personal</h1>
            <p className="text-gray-500">Administraci贸n de empleados operativos y seguridad.</p>
        </div>
        
        {/* Renderizamos el componente de l贸gica */}
        <EmployeeManagement />
      </div>
    </DashboardLayout>
  );
}

// Protegemos la ruta solo para administradores
export default withAuthGuard(EmployeesPage, 'admin');

================================================================================
FILE: apps\web\pages\index.tsx
================================================================================
import React, { useEffect } from 'react';
import { useRouter } from 'next/router';
import { onAuthStateChanged } from 'firebase/auth';
import { auth } from '@/services/firebase-client.service';
import { LoginForm } from '@/components/admin/login-form';

const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager'];

export default function HomePage() {
  const router = useRouter();

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          // Obtenemos el rol real del token
          const tokenResult = await user.getIdTokenResult();
          const role = tokenResult.claims.role as string;
          
          console.log("Usuario detectado:", user.email, "| Rol:", role);

          //  LGICA DE BIFURCACIN
          if (ADMIN_ROLES.includes(role)) {
            console.log("--> Redirigiendo a Admin Dashboard");
            router.push('/admin/dashboard');
          } else {
            // Si no es admin, asumimos que es empleado (o 'employee')
            console.log("--> Redirigiendo a Employee Dashboard");
            router.push('/employee/dashboard');
          }
        } catch (e) {
          console.error("Error leyendo rol:", e);
        }
      }
    });
    return () => unsubscribe();
  }, [router]);

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4 font-sans">
      <div className="w-full max-w-md">
        <LoginForm />
      </div>
    </div>
  );
}

================================================================================
FILE: apps\web\pages\_app.tsx
================================================================================
import React from 'react';
import type { AppProps } from 'next/app';
// 1. Importamos el sistema de notificaciones (Frontend)
import { Toaster } from 'react-hot-toast';
// 2. Importamos el proveedor de contexto de cliente (Frontend)
import { ClientProvider } from '@/context/ClientContext';
// 3. Importamos los estilos globales (Tailwind)
import '@/styles/globals.css'; 

export default function App({ Component, pageProps }: AppProps) {
  return (
    // Envolvemos toda la app en el ClientProvider para tener acceso a la empresa seleccionada
    <ClientProvider>
      
      {/* Renderizamos la p谩gina actual */}
      <Component {...pageProps} />
      
      {/* Configuraci贸n global de las notificaciones (Toasts) */}
      <Toaster 
        position="top-right" 
        reverseOrder={false}
        toastOptions={{
          // Estilos por defecto para todas las notificaciones
          style: {
            borderRadius: '10px',
            background: '#333',
            color: '#fff',
            fontSize: '14px',
          },
          // Estilos espec铆ficos para 茅xito (Verde)
          success: {
            style: {
              background: '#ECFDF5', // Verde muy claro
              color: '#065F46',      // Texto verde oscuro
              border: '1px solid #10B981',
            },
            iconTheme: {
              primary: '#10B981',
              secondary: '#FFFAEE',
            },
          },
          // Estilos espec铆ficos para error (Rojo)
          error: {
            style: {
              background: '#FEF2F2', // Rojo muy claro
              color: '#991B1B',      // Texto rojo oscuro
              border: '1px solid #EF4444',
            },
            duration: 5000, // Duran 5 segundos para poder leerlos bien
          },
        }}
      />
    </ClientProvider>
  );
}

================================================================================
FILE: apps\web\README.md
================================================================================
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.


================================================================================
FILE: apps\web\src\common\interfaces\client.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore';
import { ReactNode } from 'react';

export interface IClient {
  contactEmail: ReactNode;
  contactName: string;
  cuit: ReactNode;
  businessName: ReactNode;
  id: string;
  name: string;
  status: 'Active' | 'Inactive';
  createdAt: Timestamp;
}

export interface IObjective {
  id: string;
  clientId: string;
  name: string;
  address: string;
  location: {
    latitude: number;
    longitude: number;
  };
  type: string;
}

================================================================================
FILE: apps\web\src\common\interfaces\employee.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore'; 

/**
 * @description Define los roles de usuario dentro del sistema Cronograma.
 */
export type EmployeeRole = 'admin' | 'employee';

/**
 * @description Define los tipos de contrato laboral soportados.
 */
export type ContractType = 'FullTime' | 'PartTime' | 'Eventual';

/**
 * @description Interfaz principal para la entidad Colaborador (Employee).
 * Estos son los datos que se obtienen del m贸dulo RRHH.
 */
export interface IEmployee {
    uid: string; // Firebase Auth UID / Document ID (Identificador 煤nico)
    name: string;
    role: EmployeeRole;
    email: string;
    isAvailable: boolean; // Estado de disponibilidad general
    maxHoursPerMonth: number; // L铆mite de horas contractuales (Regla de Negocio Cr铆tica)
    contractType: ContractType;
    clientId: string; // Para scoping
}

/**
 * @description Define la estructura de una ausencia (vacaciones, licencia m茅dica) guardada en Firestore.
 * Consultada por el WorkloadService para validaci贸n de disponibilidad.
 */
export interface IAbsence {
    id: string; // Document ID (Firestore)
    employeeId: string;
    employeeName: string;
    clientId: string; // Para scoping
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER'; // Tipo de ausencia
    startDate: Timestamp; // Fecha y hora de inicio de la ausencia (usando Timestamp)
    endDate: Timestamp; // Fecha y hora de fin de la ausencia (usando Timestamp)
    reason: string; // Descripci贸n detallada
    status: 'PENDING' | 'APPROVED' | 'REJECTED'; // Estado de aprobaci贸n
    createdAt: Timestamp;
}

/**
 * @description Payload utilizado por el Frontend al enviar datos de una nueva ausencia.
 * Utiliza el tipo nativo 'Date' para facilitar el manejo en los formularios HTML/React.
 * La conversi贸n a Timestamp ocurre en la capa de servicios del Frontend.
 */
export interface IAbsencePayload {
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    startDate: Date; 
    endDate: Date;
    reason: string;
}

================================================================================
FILE: apps\web\src\common\interfaces\shift.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore';

export interface IShift {
  id: string;
  employeeId: string;
  employeeName: string;
  objectiveId: string;
  objectiveName: string;
  startTime: Timestamp;
  endTime: Timestamp;
  status: 'Assigned' | 'Confirmed' | 'InProgress' | 'Completed' | 'Canceled';
  checkInTime?: Timestamp;
  checkOutTime?: Timestamp;
  schedulerId: string;
  updatedAt: Timestamp;
}

================================================================================
FILE: apps\web\src\common\interfaces\system-user.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore';

export type SystemRole = 'SuperAdmin' | 'Scheduler' | 'HR_Manager' | 'Viewer';

export interface ISystemUser {
  uid: string;
  email: string;
  displayName: string;
  role: SystemRole;
  status: 'Active' | 'Inactive';
  createdAt: Timestamp;
  lastLogin?: Timestamp;
}

================================================================================
FILE: apps\web\src\components\admin\AbsenceManagementPage.test.tsx
================================================================================
//  IMPORTANTE: Habilita matchers como toBeInTheDocument
import '@testing-library/jest-dom';
import { render, screen, waitFor, fireEvent } from '@testing-library/react';
import { AbsenceManagementPage } from './AbsenceManagementPage'; 
import { useClient } from '@/context/ClientContext';
import { callCreateAbsence, callManageEmployees } from '@/services/firebase-client.service'; 
import toast from 'react-hot-toast';

// ----------------------------------------------------------------
// MOCKS DE UI
// ----------------------------------------------------------------
jest.mock('../common/InputField', () => ({
    __esModule: true,
    default: ({ label, onChange, value, type }: any) => (
        <input aria-label={label} type={type || 'text'} value={value} onChange={onChange} />
    ),
}));

jest.mock('../common/SelectField', () => ({
    __esModule: true,
    default: ({ label, onChange, value, children }: any) => (
        <select aria-label={label} value={value} onChange={onChange}>{children}</select>
    ),
}));

jest.mock('../common/Button', () => ({
    __esModule: true,
    default: ({ children, disabled, type, onClick }: any) => (
        <button disabled={disabled} type={type} onClick={onClick} data-testid="submit-button">
            {children}
        </button>
    ),
}));

// ----------------------------------------------------------------
// MOCKS DE SERVICIOS
// ----------------------------------------------------------------
jest.mock('@/context/ClientContext', () => ({ useClient: jest.fn(), }));
jest.mock('@/services/firebase-client.service', () => ({
    callManageEmployees: jest.fn(),
    callCreateAbsence: jest.fn(), 
}));
jest.mock('react-hot-toast', () => ({
    error: jest.fn(),
    success: jest.fn(),
    loading: jest.fn().mockReturnValue('toast-id-mock'),
}));

const mockEmployees = [
    { uid: 'emp1', name: 'Juan P茅rez', role: 'Vigilador' },
];

const mockUseClient = (selectedClientId: string | null) => (
    (useClient as jest.Mock).mockReturnValue({
        selectedClientId: selectedClientId,
    })
);

describe('AbsenceManagementPage', () => {
    beforeEach(() => {
        jest.clearAllMocks();
        
        //  SOLUCIN CRTICA: DOBLE CASTING (as unknown as jest.Mock)
        // Esto obliga a TypeScript a aceptar el mock sin quejarse.
        (callManageEmployees as unknown as jest.Mock).mockResolvedValue({
            data: { data: mockEmployees },
        });
        
        (callCreateAbsence as unknown as jest.Mock).mockResolvedValue({
            data: { success: true },
        });
        
        mockUseClient('client_abc'); 
    });

    it('should render and fetch employees successfully', async () => {
        render(<AbsenceManagementPage />);
        await waitFor(() => {
            expect(callManageEmployees).toHaveBeenCalled();
        });
        expect(screen.getByLabelText(/Colaborador/i)).toBeInTheDocument();
    });

    it('should validate form dates', async () => {
        render(<AbsenceManagementPage />);
        await waitFor(() => { expect(callManageEmployees).toHaveBeenCalled(); });

        fireEvent.change(screen.getByLabelText(/Colaborador/i), { target: { value: 'emp1' } });
        fireEvent.change(screen.getByLabelText(/Raz贸n \/ Comentarios/i), { target: { value: 'Test Reason' } });

        // Fechas inv谩lidas
        fireEvent.change(screen.getByLabelText(/Fecha de Inicio/i), { target: { value: '2025-01-10' } });
        fireEvent.change(screen.getByLabelText(/Fecha de Fin/i), { target: { value: '2025-01-01' } });

        fireEvent.click(screen.getByTestId('submit-button'));

        await waitFor(() => {
            expect(toast.error).toHaveBeenCalled();
        });
        expect(callCreateAbsence).not.toHaveBeenCalled();
    });

    it('should submit successfully', async () => {
        render(<AbsenceManagementPage />);
        await waitFor(() => { expect(callManageEmployees).toHaveBeenCalled(); });

        fireEvent.change(screen.getByLabelText(/Colaborador/i), { target: { value: 'emp1' } });
        fireEvent.change(screen.getByLabelText(/Tipo de Novedad/i), { target: { value: 'SICK_LEAVE' } });
        fireEvent.change(screen.getByLabelText(/Fecha de Inicio/i), { target: { value: '2025-01-01' } });
        fireEvent.change(screen.getByLabelText(/Fecha de Fin/i), { target: { value: '2025-01-05' } });
        fireEvent.change(screen.getByLabelText(/Raz贸n \/ Comentarios/i), { target: { value: 'Test Sick Leave' } });

        fireEvent.click(screen.getByTestId('submit-button'));

        await waitFor(() => {
            expect(callCreateAbsence).toHaveBeenCalled();
        });
        
        expect(toast.success).toHaveBeenCalled();
    });
});

================================================================================
FILE: apps\web\src\components\admin\AbsenceManagementPage.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import toast from 'react-hot-toast';
import { useClient } from '@/context/ClientContext';
import { IAbsencePayload, IEmployee } from '@/common/interfaces/employee.interface';
//  IMPORTACIN CORRECTA
import { callCreateAbsence, callManageEmployees } from '@/services/firebase-client.service'; 

import InputField from '@/components/common/InputField'; 
import SelectField from '@/components/common/SelectField';
import Button from '@/components/common/Button';

const ABSENCE_TYPES = [
    { value: 'VACATION', label: 'Vacaciones' },
    { value: 'SICK_LEAVE', label: 'Licencia M茅dica' },
    { value: 'OTHER', label: 'Otro' },
];

export function AbsenceManagementPage() {
    const { selectedClientId } = useClient();
    const [employees, setEmployees] = useState<IEmployee[]>([]);
    const [isLoadingEmployees, setIsLoadingEmployees] = useState<boolean>(false);
    const [isSubmitting, setIsSubmitting] = useState<boolean>(false);

    const [formData, setFormData] = useState<IAbsencePayload>({
        employeeId: '',
        employeeName: '',
        clientId: selectedClientId || '',
        type: 'VACATION',
        startDate: new Date(),
        endDate: new Date(),
        reason: '',
    });

    // Sincronizar clientId y reinicializar formulario al cambiar de cliente
    useEffect(() => {
        setFormData(prev => ({ 
            ...prev, 
            clientId: selectedClientId || '', 
            employeeId: '', 
            employeeName: '' 
        }));
    }, [selectedClientId]);

    // 1. Fetch de Empleados filtrados por Cliente
    useEffect(() => {
        const fetchEmployees = async () => {
            // Si no hay cliente seleccionado, limpiamos la lista y no hacemos fetch
            if (!selectedClientId) {
                setEmployees([]);
                return;
            }

            setIsLoadingEmployees(true);
            try {
                //  CAMBIO CRTICO: Enviamos el clientId para filtrar en Backend
                const empRes = await callManageEmployees({ 
                    action: 'GET_ALL_EMPLOYEES', 
                    payload: { clientId: selectedClientId } 
                });
                
                setEmployees((empRes.data as any).data || []); 
            } catch (error) {
                console.error("Error fetching employees for absence module:", error);
                toast.error("No se pudo cargar la lista de empleados.");
            } finally {
                setIsLoadingEmployees(false);
            }
        };
        fetchEmployees();
    }, [selectedClientId]);

    const handleEmployeeChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const selectedId = e.target.value;
        const selectedEmployee = employees.find(emp => emp.uid === selectedId);

        setFormData(prev => ({
            ...prev,
            employeeId: selectedId,
            employeeName: selectedEmployee ? selectedEmployee.name : ''
        }));
    };

    const handleDateChange = (name: keyof IAbsencePayload, value: string) => {
        setFormData(prev => ({
            ...prev,
            [name]: new Date(value),
        }));
    };

    const validateForm = (data: IAbsencePayload): boolean => {
        if (!data.employeeId || !data.clientId || !data.type) {
            toast.error("Complete los campos obligatorios (Empleado, Tipo).");
            return false;
        }
        if (data.startDate.getTime() >= data.endDate.getTime()) {
            toast.error("La fecha de inicio debe ser anterior a la fecha de fin.");
            return false;
        }
        if (!data.reason.trim()) {
            toast.error("Debe proporcionar una raz贸n para la novedad.");
            return false;
        }
        return true;
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!validateForm(formData)) return;

        setIsSubmitting(true);
        const toastId = toast.loading(`Registrando ${formData.type}...`);

        try {
            // Usamos la funci贸n de servicio que convierte Dates a Timestamps
            await callCreateAbsence({ action: 'CREATE_ABSENCE', payload: formData }); 
            
            toast.success("Novedad registrada exitosamente.", { id: toastId });
            
            // Reset parcial
            setFormData(prev => ({ 
                ...prev, 
                type: 'VACATION', 
                startDate: new Date(), 
                endDate: new Date(), 
                reason: '' 
            })); 
        } catch (error: any) {
            console.error("Absence creation failed:", error);
            const message = error.response?.data?.message || error.message || "Error al registrar la novedad. Verifique el log.";
            toast.error(message, { id: toastId });
        } finally {
            setIsSubmitting(false);
        }
    };

    if (!selectedClientId) {
        return <div className="p-8 text-center text-red-600">锔 Por favor, seleccione una empresa para gestionar novedades.</div>;
    }

    return (
        <div className="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-lg border border-slate-200">
            <h2 className="text-2xl font-bold text-slate-800 mb-6">Gesti贸n de Novedades (Ausencias)</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
                
                <SelectField
                    label="Colaborador"
                    id="employeeId"
                    value={formData.employeeId}
                    onChange={handleEmployeeChange}
                    disabled={isLoadingEmployees || isSubmitting}
                    required
                >
                    <option value="" disabled>{isLoadingEmployees ? 'Cargando...' : 'Seleccione un colaborador'}</option>
                    {employees.map(emp => (
                        <option key={emp.uid} value={emp.uid}>{emp.name} ({emp.role})</option>
                    ))}
                </SelectField>

                <SelectField
                    label="Tipo de Novedad"
                    id="type"
                    value={formData.type}
                    onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value as IAbsencePayload['type'] }))}
                    disabled={isSubmitting}
                    required
                >
                    {ABSENCE_TYPES.map(type => (
                        <option key={type.value} value={type.value}>{type.label}</option>
                    ))}
                </SelectField>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <InputField
                        label="Fecha de Inicio"
                        id="startDate"
                        type="date"
                        value={formData.startDate.toISOString().split('T')[0]}
                        onChange={(e) => handleDateChange('startDate', e.target.value)}
                        disabled={isSubmitting}
                        required
                    />
                    <InputField
                        label="Fecha de Fin"
                        id="endDate"
                        type="date"
                        value={formData.endDate.toISOString().split('T')[0]}
                        onChange={(e) => handleDateChange('endDate', e.target.value)}
                        disabled={isSubmitting}
                        required
                    />
                </div>

                <InputField
                    label="Raz贸n / Comentarios"
                    id="reason"
                    type="textarea"
                    value={formData.reason}
                    onChange={(e) => setFormData(prev => ({ ...prev, reason: e.target.value }))}
                    rows={4}
                    disabled={isSubmitting}
                    required
                />
                
                <div className="flex justify-end">
                    <Button type="submit" disabled={isSubmitting || !formData.employeeId} primary>
                        {isSubmitting ? 'Registrando...' : 'Registrar Novedad'}
                    </Button>
                </div>
            </form>
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\admin\client-setup-wizard.tsx
================================================================================
import React, { useState } from 'react';
import { useRouter } from 'next/router'; //  FIX: Usar router de Next.js para navegaci贸n segura
import { callManageHierarchy } from '@/services/firebase-client.service';
import toast from 'react-hot-toast';

// Interfaces locales para el estado del formulario
interface ShiftTypeUI {
  name: string;
  code: string;
  startTime: string;
  durationHours: number;
}

export function ClientSetupWizard() {
  const router = useRouter(); // Hook de navegaci贸n
  const [step, setStep] = useState(1);
  const [loading, setLoading] = useState(false);
  
  // IDs generados por el backend a medida que avanzamos
  const [ids, setIds] = useState({ clientId: '', objectiveId: '', contractId: '' });

  // Listado visual de modalidades agregadas en el paso 4
  const [addedShifts, setAddedShifts] = useState<ShiftTypeUI[]>([]);

  // Datos de Formularios
  const [clientData, setClientData] = useState({ businessName: '', cuit: '', contactName: '', contactEmail: '' });
  const [objData, setObjData] = useState({ name: '', address: '', latitude: '', longitude: '' });
  const [contractData, setContractData] = useState({ name: '', totalHoursPerMonth: 720 });
  
  // Datos del formulario de Modalidad actual
  const [shiftData, setShiftData] = useState<ShiftTypeUI>({ 
    name: 'Turno Ma帽ana', 
    code: 'TM', 
    startTime: '06:00', 
    durationHours: 8 
  });

  // --- PASO 1: CREAR CLIENTE ---
  const handleCreateClient = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const res = await callManageHierarchy({ action: 'CREATE_CLIENT', payload: { ...clientData, status: 'Active' } });
      const data = res.data as any;
      setIds(prev => ({ ...prev, clientId: data.data.id }));
      toast.success("Empresa creada correctamente");
      setStep(2);
    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- PASO 2: CREAR OBJETIVO ---
  const handleCreateObjective = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const payload = {
        ...objData,
        clientId: ids.clientId,
        location: { latitude: Number(objData.latitude), longitude: Number(objData.longitude) },
        type: 'Sede'
      };
      const res = await callManageHierarchy({ action: 'CREATE_OBJECTIVE', payload });
      const data = res.data as any;
      setIds(prev => ({ ...prev, objectiveId: data.data.id }));
      toast.success("Objetivo vinculado");
      setStep(3);
    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- PASO 3: CREAR CONTRATO ---
  const handleCreateContract = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const payload = {
        ...contractData,
        objectiveId: ids.objectiveId,
        startDate: new Date(),
        isActive: true
      };
      const res = await callManageHierarchy({ action: 'CREATE_CONTRACT', payload });
      const data = res.data as any;
      setIds(prev => ({ ...prev, contractId: data.data.id }));
      toast.success("Contrato generado");
      setStep(4);
    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- PASO 4: CREAR TIPO DE TURNO (MODALIDAD) ---
  const handleCreateShiftType = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const payload = { ...shiftData, contractId: ids.contractId, color: '#3B82F6' };
      
      // Llamada al Backend
      await callManageHierarchy({ action: 'CREATE_SHIFT_TYPE', payload });
      
      toast.success(`Modalidad "${shiftData.name}" agregada`);
      
      // 1. Agregamos a la lista visual de abajo para feedback
      setAddedShifts(prev => [...prev, shiftData]);
      
      // 2. Reseteamos el formulario para cargar el siguiente r谩pidamente
      setShiftData({ 
        name: '', 
        code: '', 
        startTime: '14:00', // Sugerencia de siguiente horario
        durationHours: 8 
      });

    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- ACCIN FINAL ---
  const handleFinish = () => {
    toast.success("Configuraci贸n finalizada con 茅xito.");
    //  FIX: Navegaci贸n segura de Next.js
    router.push('/admin/dashboard');
  };

  // Estilos reutilizables
  const inputClass = "w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 px-3 border mt-1";
  const labelClass = "block text-sm font-medium text-gray-700";
  const btnClass = "w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 font-medium shadow-sm";

  return (
    <div className="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
      
      {/* Barra de Progreso */}
      <div className="flex justify-between mb-8 relative">
        <div className="absolute top-1/2 left-0 w-full h-1 bg-gray-100 -z-10 rounded"></div>
        {[1, 2, 3, 4].map(num => (
            <div key={num} className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm transition-colors border-4 border-white ${step >= num ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-500'}`}>
                {num}
            </div>
        ))}
      </div>

      {step === 1 && (
        <form onSubmit={handleCreateClient} className="space-y-4 animate-fadeIn">
            <div className="border-b pb-4 mb-4">
                <h2 className="text-xl font-bold text-gray-800"> Paso 1: Datos de la Empresa</h2>
                <p className="text-sm text-gray-500">Registre la raz贸n social del cliente.</p>
            </div>
            <div><label className={labelClass}>Raz贸n Social</label><input className={inputClass} value={clientData.businessName} onChange={e => setClientData({...clientData, businessName: e.target.value})} required placeholder="Ej: Banco Galicia S.A." /></div>
            <div><label className={labelClass}>CUIT</label><input className={inputClass} value={clientData.cuit} onChange={e => setClientData({...clientData, cuit: e.target.value})} required placeholder="30-12345678-9" /></div>
            <button type="submit" disabled={loading} className={btnClass}>{loading ? 'Guardando...' : 'Guardar y Continuar'}</button>
        </form>
      )}

      {step === 2 && (
        <form onSubmit={handleCreateObjective} className="space-y-4 animate-fadeIn">
            <div className="border-b pb-4 mb-4">
                <h2 className="text-xl font-bold text-gray-800"> Paso 2: Crear Sede / Objetivo</h2>
                <p className="text-sm text-gray-500">Defina la ubicaci贸n f铆sica del servicio.</p>
            </div>
            <div><label className={labelClass}>Nombre del Objetivo</label><input className={inputClass} value={objData.name} onChange={e => setObjData({...objData, name: e.target.value})} required placeholder="Ej: Sucursal Centro" /></div>
            <div><label className={labelClass}>Direcci贸n</label><input className={inputClass} value={objData.address} onChange={e => setObjData({...objData, address: e.target.value})} required /></div>
            <div className="grid grid-cols-2 gap-4">
                <div><label className={labelClass}>Latitud</label><input type="number" className={inputClass} value={objData.latitude} onChange={e => setObjData({...objData, latitude: e.target.value})} required step="any"/></div>
                <div><label className={labelClass}>Longitud</label><input type="number" className={inputClass} value={objData.longitude} onChange={e => setObjData({...objData, longitude: e.target.value})} required step="any"/></div>
            </div>
            <button type="submit" disabled={loading} className={btnClass}>{loading ? 'Vinculando...' : 'Guardar y Continuar'}</button>
        </form>
      )}

      {step === 3 && (
        <form onSubmit={handleCreateContract} className="space-y-4 animate-fadeIn">
            <div className="border-b pb-4 mb-4">
                <h2 className="text-xl font-bold text-gray-800"> Paso 3: Definir Contrato</h2>
                <p className="text-sm text-gray-500">Establezca el acuerdo comercial y horas vendidas.</p>
            </div>
            <div><label className={labelClass}>Nombre del Servicio</label><input className={inputClass} value={contractData.name} onChange={e => setContractData({...contractData, name: e.target.value})} placeholder="Ej: Seguridad 24hs - 2025" required /></div>
            <div><label className={labelClass}>Horas Mensuales Vendidas</label><input type="number" className={inputClass} value={contractData.totalHoursPerMonth} onChange={e => setContractData({...contractData, totalHoursPerMonth: Number(e.target.value)})} required /></div>
            <button type="submit" disabled={loading} className={btnClass}>{loading ? 'Generando...' : 'Generar Contrato'}</button>
        </form>
      )}

      {step === 4 && (
        <div className="space-y-6 animate-fadeIn">
            <div className="text-center bg-green-50 p-4 rounded-lg border border-green-100">
                <h2 className="text-xl font-bold text-green-800">隆Estructura Base Creada!</h2>
                <p className="text-green-600 text-sm">Ahora define la "receta" de turnos (modalidades) para este contrato.</p>
            </div>

            <div className="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-inner">
                <h3 className="font-bold text-gray-700 mb-4 flex items-center">
                    <span className="bg-indigo-100 text-indigo-700 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">+</span>
                    Agregar Nueva Modalidad
                </h3>
                <div className="grid grid-cols-2 gap-4 mb-4">
                    <div><label className={labelClass}>Nombre</label><input className={inputClass} value={shiftData.name} onChange={e => setShiftData({...shiftData, name: e.target.value})} placeholder="Ej: Turno Tarde" /></div>
                    <div><label className={labelClass}>C贸digo</label><input className={inputClass} value={shiftData.code} onChange={e => setShiftData({...shiftData, code: e.target.value})} placeholder="TT" /></div>
                    <div><label className={labelClass}>Inicio (HH:mm)</label><input type="time" className={inputClass} value={shiftData.startTime} onChange={e => setShiftData({...shiftData, startTime: e.target.value})} /></div>
                    <div><label className={labelClass}>Duraci贸n (hs)</label><input type="number" className={inputClass} value={shiftData.durationHours} onChange={e => setShiftData({...shiftData, durationHours: Number(e.target.value)})} /></div>
                </div>
                <button 
                    onClick={handleCreateShiftType} 
                    disabled={loading || !shiftData.name} 
                    className="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition font-medium shadow-sm flex justify-center items-center"
                >
                    {loading ? 'Guardando...' : '+ Agregar Modalidad a la Lista'}
                </button>
            </div>

            {/* LISTA VISUAL DE LO CARGADO */}
            {addedShifts.length > 0 && (
                <div className="border rounded-lg overflow-hidden shadow-sm">
                    <div className="bg-gray-100 px-4 py-2 border-b font-semibold text-gray-700 text-sm flex justify-between items-center">
                        <span>Modalidades Cargadas</span>
                        <span className="bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full text-xs">{addedShifts.length}</span>
                    </div>
                    <ul className="divide-y divide-gray-100 bg-white">
                        {addedShifts.map((shift, index) => (
                            <li key={index} className="px-4 py-3 flex justify-between items-center text-sm hover:bg-gray-50">
                                <div>
                                    <span className="font-bold text-gray-800">{shift.name}</span>
                                    <span className="ml-2 text-gray-500 font-mono text-xs">({shift.code})</span>
                                </div>
                                <div className="text-gray-600 bg-gray-100 px-2 py-1 rounded">
                                    {shift.startTime} <span className="mx-1"></span> {shift.durationHours}hs
                                </div>
                            </li>
                        ))}
                    </ul>
                </div>
            )}
            
            <button onClick={handleFinish} className="w-full border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 font-bold transition mt-4 shadow-sm">
                Finalizar y Volver al Dashboard
            </button>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\employee-management.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { callManageEmployees, callCreateUser } from '@/services/firebase-client.service';
import { IEmployee } from '@/common/interfaces/employee.interface';
import toast from 'react-hot-toast';

export function EmployeeManagement() {
  const [employees, setEmployees] = useState<IEmployee[]>([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);

  // Estado del Formulario
  const [formData, setFormData] = useState({
    uid: '',
    name: '',
    email: '',
    password: '', // Solo para creaci贸n
    role: 'employee',
    maxHoursPerMonth: 176,
    contractType: 'FullTime',
    isAvailable: true
  });

  // Cargar empleados
  const fetchEmployees = async () => {
    setLoading(true);
    try {
      const res = await callManageEmployees({ action: 'GET_ALL_EMPLOYEES', payload: {} });
      const data = (res.data as any).data || [];
      setEmployees(data);
    } catch (error) {
      console.error(error);
      toast.error("Error al cargar empleados.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchEmployees();
  }, []);

  // Abrir modal para CREAR
  const handleOpenCreate = () => {
    setFormData({ uid: '', name: '', email: '', password: '', role: 'employee', maxHoursPerMonth: 176, contractType: 'FullTime', isAvailable: true });
    setIsEditing(false);
    setShowModal(true);
  };

  // Abrir modal para EDITAR
  const handleOpenEdit = (emp: IEmployee) => {
    setFormData({
        uid: emp.uid,
        name: emp.name,
        email: emp.email,
        password: '', // No editamos password aqu铆
        role: emp.role,
        maxHoursPerMonth: emp.maxHoursPerMonth || 176,
        contractType: emp.contractType || 'FullTime',
        isAvailable: emp.isAvailable
    });
    setIsEditing(true);
    setShowModal(true);
  };

  // Guardar (Crear o Editar)
  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    const toastId = toast.loading(isEditing ? "Actualizando..." : "Creando usuario...");

    try {
      if (isEditing) {
        // EDITAR: Usamos manageEmployees
        const updatePayload = {
            name: formData.name,
            role: formData.role,
            maxHoursPerMonth: Number(formData.maxHoursPerMonth),
            contractType: formData.contractType,
            isAvailable: formData.isAvailable
        };
        await callManageEmployees({ action: 'UPDATE_EMPLOYEE', payload: { uid: formData.uid, data: updatePayload } });
        toast.success("Empleado actualizado", { id: toastId });
      } else {
        // CREAR: Usamos callCreateUser (Auth + Perfil b谩sico)
        // Nota: Para simplificar, primero creamos el usuario y luego el usuario deber铆a editarse para ajustar horas si es necesario,
        // o actualizamos createUser para aceptar m谩s datos. Por ahora usamos el flujo est谩ndar.
        await callCreateUser({ 
            email: formData.email, 
            password: formData.password, 
            name: formData.name, 
            role: formData.role 
        });
        // Idealmente, aqu铆 har铆amos un update inmediato para setear las horas custom si difieren del default.
        toast.success("Usuario creado con 茅xito", { id: toastId });
      }
      
      setShowModal(false);
      fetchEmployees();

    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`, { id: toastId });
    }
  };

  // Eliminar
  const handleDelete = async (uid: string) => {
    if (!confirm("驴Eliminar este empleado? Esta acci贸n borrar谩 su acceso.")) return;
    try {
        await callManageEmployees({ action: 'DELETE_EMPLOYEE', payload: { uid } });
        toast.success("Empleado eliminado");
        fetchEmployees();
    } catch (error) {
        toast.error("Error al eliminar");
    }
  };

  // Clases CSS
  const inputClass = "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm";
  const labelClass = "block text-sm font-medium text-gray-700";

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-xl font-bold text-gray-800">N贸mina de Personal</h2>
        <button onClick={handleOpenCreate} className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm flex items-center">
            <span className="mr-2">+</span> Nuevo Empleado
        </button>
      </div>

      {/* Tabla */}
      <div className="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
        <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                    <tr>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Nombre / Email</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Rol</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Contrato</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">L铆mite Horas</th>
                        <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Acciones</th>
                    </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                    {employees.map((emp) => (
                        <tr key={emp.uid} className="hover:bg-gray-50">
                            <td className="px-6 py-4 whitespace-nowrap">
                                <div className="flex items-center">
                                    <div className="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold">
                                        {emp.name.charAt(0)}
                                    </div>
                                    <div className="ml-4">
                                        <div className="text-sm font-medium text-gray-900">{emp.name}</div>
                                        <div className="text-sm text-gray-500">{emp.email}</div>
                                    </div>
                                </div>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap">
                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${emp.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}`}>
                                    {emp.role}
                                </span>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                {emp.contractType || 'FullTime'}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                <span className="font-bold">{emp.maxHoursPerMonth || 176}</span> hs/mes
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onClick={() => handleOpenEdit(emp)} className="text-indigo-600 hover:text-indigo-900 mr-4">Editar</button>
                                <button onClick={() => handleDelete(emp.uid)} className="text-red-600 hover:text-red-900">Eliminar</button>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
            {!loading && employees.length === 0 && <div className="p-8 text-center text-gray-500">No hay empleados registrados.</div>}
        </div>
      </div>

      {/* Modal de Creaci贸n/Edici贸n */}
      {showModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <h3 className="text-lg font-bold text-gray-900 mb-4">{isEditing ? 'Editar Empleado' : 'Nuevo Empleado'}</h3>
                
                <form onSubmit={handleSave} className="space-y-4">
                    <div><label className={labelClass}>Nombre Completo</label><input className={inputClass} value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required /></div>
                    
                    {!isEditing && (
                        <>
                            <div><label className={labelClass}>Email</label><input type="email" className={inputClass} value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required /></div>
                            <div><label className={labelClass}>Contrase帽a</label><input type="password" className={inputClass} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} required /></div>
                        </>
                    )}

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className={labelClass}>Rol</label>
                            <select className={inputClass} value={formData.role} onChange={e => setFormData({...formData, role: e.target.value as any})}>
                                <option value="employee">Empleado</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div>
                            <label className={labelClass}>Contrato</label>
                            <select className={inputClass} value={formData.contractType} onChange={e => setFormData({...formData, contractType: e.target.value as any})}>
                                <option value="FullTime">Full Time</option>
                                <option value="PartTime">Part Time</option>
                                <option value="Eventual">Eventual</option>
                            </select>
                        </div>
                    </div>

                    <div><label className={labelClass}>L铆mite de Horas Mensual</label><input type="number" className={inputClass} value={formData.maxHoursPerMonth} onChange={e => setFormData({...formData, maxHoursPerMonth: Number(e.target.value)})} required /></div>

                    <div className="flex justify-end space-x-3 mt-6">
                        <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
                        <button type="submit" className="px-4 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\login-form.tsx
================================================================================
import React, { useState } from 'react';
import { useRouter } from 'next/router';
import { signInWithEmailAndPassword } from 'firebase/auth';
import { auth } from '@/services/firebase-client.service';

export function LoginForm() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  // Colores personalizados basados en la imagen de referencia (Rojo ATM)
  const colors = {
    primary: '#a81d1d', // Rojo intenso
    primaryHover: '#8c1818',
    bgInput: '#eff4fc', // Fondo azul muy claro de los inputs
    textGray: '#6b7280',
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      await signInWithEmailAndPassword(auth, email, password);
      router.push('/admin/dashboard');
    } catch (err: any) {
        console.error(err);
        if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
            setError('Credenciales incorrectas. Verifique email y contrase帽a.');
        } else if (err.code === 'auth/too-many-requests') {
            setError('Demasiados intentos. Por favor espere unos minutos.');
        } else {
            setError('Error al iniciar sesi贸n. Intente nuevamente.');
        }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="w-full max-w-md mx-auto">
      {/* Tarjeta de Login con sombra suave y bordes redondeados */}
      <div className="bg-white shadow-xl rounded-3xl px-8 pt-10 pb-12 mb-4 border border-gray-50 relative overflow-hidden">
        
        {/* Logo (Placeholder textual, puedes reemplazar por una etiqueta <img> si tienes el logo en /public) */}
        <div className="text-center mb-8">
            <div className="inline-flex flex-col items-center justify-center mb-4">
                {/* Icono/Logo Simulado en Rojo */}
                <div className="bg-red-50 p-3 rounded-full">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" style={{ color: colors.primary }} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                  </svg>
                </div>
                <h2 className="text-2xl font-extrabold text-gray-900 mt-4">Sistema de Gesti贸n</h2>
            </div>
            <p className="text-sm text-gray-500">Inicia sesi贸n para acceder al panel.</p>
        </div>
        
        <form onSubmit={handleSubmit}>
            {/* Banner de Error Estilizado */}
            {error && (
                <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r-md animate-pulse">
                    <div className="flex items-center">
                        <svg className="h-5 w-5 text-red-500 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                        </svg>
                        <p className="text-sm text-red-700 font-medium">{error}</p>
                    </div>
                </div>
            )}
            
            {/* Input Email con Icono */}
            <div className="mb-5 relative">
              <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                  <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                </svg>
              </div>
              <input
                className="appearance-none rounded-xl w-full py-4 pl-12 pr-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-200 transition duration-200 font-medium placeholder-gray-400"
                style={{ backgroundColor: colors.bgInput, border: '1px solid transparent' }}
                id="email"
                type="email"
                placeholder="admin@bacarsa.com.ar"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
              />
            </div>

            {/* Input Password con Icono */}
            <div className="mb-8 relative">
              <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                 <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
                  </svg>
              </div>
              <input
                className="appearance-none rounded-xl w-full py-4 pl-12 pr-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-200 transition duration-200 font-medium placeholder-gray-400 tracking-widest"
                style={{ backgroundColor: colors.bgInput, border: '1px solid transparent' }}
                id="password"
                type="password"
                placeholder="⑩⑩⑩⑩⑩⑩⑩"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
              />
            </div>

            {/* Bot贸n Submit */}
            <button
                className={`w-full text-white font-bold py-4 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-300 flex justify-center items-center text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
                style={{ backgroundColor: loading ? colors.primaryHover : colors.primary }}
                type="submit"
                disabled={loading}
            >
                {loading ? (
                    <>
                        <svg className="animate-spin -ml-1 mr-3 h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Accediendo...
                    </>
                ) : 'Acceder al Sistema'}
            </button>
        </form>
      </div>
      
      <p className="text-center text-gray-400 text-sm mt-6 font-medium">
        Ver 3.0 Beta
      </p>
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\new.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { ClientSetupWizard } from '@/components/admin/client-setup-wizard';

function NewClientPage() {
  return (
    <DashboardLayout title="Alta de Cliente y Servicio">
      <div className="py-6">
        <ClientSetupWizard />
      </div>
    </DashboardLayout>
  );
}

export default withAuthGuard(NewClientPage as any, 'admin');

================================================================================
FILE: apps\web\src\components\admin\objective-management.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { callManageData } from '@/services/firebase-client.service';
import { IObjective } from '@/common/interfaces/client.interface';
//  Importamos el contexto para saber qu茅 empresa est谩 seleccionada
import { useClient } from '@/context/ClientContext';
import toast from 'react-hot-toast';

interface ObjectiveForm {
  name: string;
  address: string;
  latitude: number | '';
  longitude: number | '';
}

export function ObjectiveManagement() {
  //  Usamos el cliente seleccionado globalmente
  const { selectedClientId, selectedClient } = useClient();

  const [objectives, setObjectives] = useState<IObjective[]>([]);
  const [formData, setFormData] = useState<ObjectiveForm>({
    name: '', address: '', latitude: '', longitude: '',
  });
  
  const [loading, setLoading] = useState(false);
  const [submitting, setSubmitting] = useState(false);

  // Cargar objetivos FILTRADOS por el cliente seleccionado
  const fetchObjectives = async () => {
    // Si no hay cliente seleccionado, limpiamos la lista
    if (!selectedClientId) {
        setObjectives([]);
        return;
    }

    setLoading(true);
    try {
      // Enviamos el clientId para que el backend filtre
      const result = await callManageData({ 
          action: 'GET_ALL_OBJECTIVES', 
          payload: { clientId: selectedClientId } 
      });
      const response = result.data as { success: boolean, data: IObjective[] };
      setObjectives(response.data || []);
    } catch (err: any) {
      console.error(err);
      toast.error("Error al cargar objetivos");
    } finally { setLoading(false); }
  };

  // Efecto: Se ejecuta al inicio y CADA VEZ que cambia selectedClientId
  useEffect(() => {
    fetchObjectives();
  }, [selectedClientId]);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    const processedValue = (name.includes('latitude') || name.includes('longitude')) ? (value === '' ? '' : parseFloat(value)) : value;
    setFormData(prev => ({ ...prev, [name]: processedValue }));
  };

  const handleCreateObjective = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!selectedClientId) {
        toast.error("锔 Debe seleccionar una empresa en el men煤 lateral.");
        return;
    }
    if (formData.latitude === '' || formData.longitude === '') { 
        toast.error("Las coordenadas son obligatorias."); 
        return; 
    }

    setSubmitting(true);
    try {
      const payload = { 
          ...formData, 
          clientId: selectedClientId, //  Asignaci贸n autom谩tica
          location: { latitude: formData.latitude, longitude: formData.longitude } 
      };
      
      await callManageData({ action: 'CREATE_OBJECTIVE', payload });
      
      toast.success(`Objetivo "${formData.name}" creado para ${selectedClient?.businessName}`);
      setFormData({ name: '', address: '', latitude: '', longitude: '' });
      fetchObjectives();
    } catch (err: any) { 
        toast.error("Error al crear el objetivo."); 
    } finally { setSubmitting(false); }
  };

  // Clases
  const inputClass = "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-200";
  const labelClass = "block text-sm font-medium text-gray-700";

  return (
    <div className="space-y-8">
      {/* Tarjeta del Formulario */}
      <div className="bg-white shadow-lg rounded-2xl p-6 border border-gray-200">
        <div className="flex items-center mb-6 justify-between">
            <div className="flex items-center">
                <div className="bg-indigo-100 p-2 rounded-full mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a2 2 0 00-2-2H7a2 2 0 00-2 2v5m14 0v-5a2 2 0 00-2-2h-2a2 2 0 00-2 2v5" />
                    </svg>
                </div>
                <div>
                    <h2 className="text-xl font-bold text-gray-800">Nuevo Objetivo</h2>
                    {/* Feedback visual */}
                    <p className="text-sm text-indigo-600 font-medium">
                        {selectedClient ? `Asociado a: ${selectedClient.businessName}` : '锔 Seleccione una empresa en el men煤 lateral'}
                    </p>
                </div>
            </div>
        </div>
        
        <form onSubmit={handleCreateObjective} className="space-y-4">
          <div><label className={labelClass}>Nombre de la Sucursal/Puesto</label><input type="text" name="name" value={formData.name} onChange={handleInputChange} required className={inputClass} placeholder="Ej: Casa Central" /></div>
          <div><label className={labelClass}>Direcci贸n F铆sica</label><input type="text" name="address" value={formData.address} onChange={handleInputChange} required className={inputClass} placeholder="Av. Siempreviva 742" /></div>
          <div className="grid grid-cols-2 gap-4">
            <div><label className={labelClass}>Latitud</label><input type="number" name="latitude" value={formData.latitude} onChange={handleInputChange} required className={inputClass} step="any" placeholder="-34.6037" /></div>
            <div><label className={labelClass}>Longitud</label><input type="number" name="longitude" value={formData.longitude} onChange={handleInputChange} required className={inputClass} step="any" placeholder="-58.3816" /></div>
          </div>
          <button type="submit" disabled={submitting || !selectedClientId} className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none transition duration-200 ${submitting || !selectedClientId ? 'opacity-70 cursor-not-allowed' : ''}`}>
            {submitting ? 'Guardando...' : 'Crear Objetivo'}
          </button>
        </form>
      </div>

      {/* Tarjeta del Listado */}
      <div className="bg-white shadow-lg rounded-2xl overflow-hidden border border-gray-200">
        <div className="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
            <h3 className="text-lg font-bold text-gray-800">
                Objetivos de {selectedClient?.businessName || '...'}
            </h3>
            <span className="bg-gray-100 text-gray-600 py-1 px-3 rounded-full text-xs font-bold">{objectives.length}</span>
        </div>
        {loading ? <div className="p-6 text-center text-gray-500">Cargando datos...</div> : (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-100">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Nombre y Ubicaci贸n</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {objectives.length === 0 ? (
                    <tr><td className="px-6 py-8 text-center text-sm text-gray-500 italic">No hay objetivos registrados para esta empresa.</td></tr>
                ) : (
                    objectives.map((obj) => (
                    <tr key={obj.id} className="hover:bg-gray-50 transition duration-150">
                        <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center">
                            <div className="flex-shrink-0 h-10 w-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
                                <span className="font-bold text-lg">{obj.name.charAt(0).toUpperCase()}</span>
                            </div>
                            <div className="ml-4">
                            <div className="text-sm font-bold text-gray-900">{obj.name}</div>
                            <div className="text-sm text-gray-500">{obj.address}</div>
                            <div className="text-xs text-indigo-400 font-mono mt-1">({obj.location?.latitude.toFixed(4)}, {obj.location?.longitude.toFixed(4)})</div>
                            </div>
                        </div>
                        </td>
                    </tr>
                    ))
                )}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\scheduler.tsx
================================================================================
import React, { useState, useEffect, useRef } from 'react';
import FullCalendar from '@fullcalendar/react';
import dayGridPlugin from '@fullcalendar/daygrid';
import timeGridPlugin from '@fullcalendar/timegrid';
import interactionPlugin, { Draggable } from '@fullcalendar/interaction';
import { Timestamp } from 'firebase/firestore'; 
import toast from 'react-hot-toast';

// Servicios, Interfaces y Contexto
import { 
    callScheduleShift, 
    getObjectiveShifts, 
    callManageData, 
    callManageEmployees //  Importamos la funci贸n para obtener empleados
} from '@/services/firebase-client.service';
import { IObjective } from '@/common/interfaces/client.interface';
import { IEmployee } from '@/common/interfaces/employee.interface'; // Interfaz de Empleado Real
import { useClient } from '@/context/ClientContext';


export function DragAndDropScheduler() {
  //  Consumimos el ID del cliente global para filtrar objetivos
  const { selectedClientId } = useClient();

  const [objectives, setObjectives] = useState<IObjective[]>([]);
  const [employees, setEmployees] = useState<IEmployee[]>([]); //  ESTADO REAL DE EMPLEADOS
  const [selectedObjective, setSelectedObjective] = useState<string>('');
  const [shifts, setShifts] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  
  const calendarRef = useRef<FullCalendar>(null);
  const draggableRef = useRef<HTMLDivElement>(null);

  // 1. Cargar Empleados REALES y Objetivos FILTRADOS
  useEffect(() => {
    async function loadAllData() {
        setLoading(true);
        if (!selectedClientId) {
            setEmployees([]);
            setObjectives([]);
            setSelectedObjective('');
            setLoading(false);
            return;
        }

        try {
            // A. Cargar EMPLEADOS REALES: Adi贸s Mocks!
            const empRes = await callManageEmployees({ action: 'GET_ALL_EMPLOYEES', payload: {} });
            setEmployees((empRes.data as any).data || []);
            
            // B. Cargar OBJETIVOS filtrados por la empresa seleccionada
            const objRes = await callManageData({ action: 'GET_ALL_OBJECTIVES', payload: { clientId: selectedClientId } });
            const objData = (objRes.data as any).data || [];
            
            setObjectives(objData);
            
            // Seleccionar autom谩ticamente el primer objetivo
            if (objData.length > 0) {
                setSelectedObjective(objData[0].id);
            } else {
                setSelectedObjective('');
            }
        } catch (e) {
            console.error("Error cargando datos del planificador", e);
            toast.error("Error al cargar empleados u objetivos de la empresa.");
        } finally {
            setLoading(false);
        }
    }
    loadAllData();
  }, [selectedClientId]); //  Dependencia: Se recarga al cambiar de empresa

  // 2. Cargar Turnos cuando cambia el Objetivo
  useEffect(() => {
    if (!selectedObjective) {
        setShifts([]);
        return;
    }
    setLoading(true);
    
    getObjectiveShifts(selectedObjective).then((data) => {
      const calendarEvents = data.map(shift => ({
        id: shift.id,
        title: shift.employeeName,
        // Manejo robusto de fechas
        start: (shift.startTime as any).toDate ? (shift.startTime as any).toDate() : new Date((shift.startTime as any).seconds * 1000),
        end: (shift.endTime as any).toDate ? (shift.endTime as any).toDate() : new Date((shift.endTime as any).seconds * 1000),
        backgroundColor: shift.status === 'Completed' ? '#10B981' : '#3B82F6',
        extendedProps: { ...shift }
      }));
      setShifts(calendarEvents);
      setLoading(false);
    });
  }, [selectedObjective]);

  // 3. Configurar Draggable
  useEffect(() => {
    if (draggableRef.current) {
      new Draggable(draggableRef.current, {
        itemSelector: '.fc-event-external',
        eventData: function(eventEl) {
          return {
            title: eventEl.getAttribute('data-name'),
            extendedProps: {
              employeeId: eventEl.getAttribute('data-id'),
              employeeName: eventEl.getAttribute('data-name')
            }
          };
        }
      });
    }
  }, []);

  // 4. L贸gica al SOLTAR (Crear Turno)
  const handleEventReceive = async (info: any) => {
    const { event } = info;
    const { employeeId, employeeName } = event.extendedProps;
    
    if (!selectedObjective) {
        toast.error("锔 Seleccione un objetivo primero.");
        info.revert(); // Quita el evento del calendario si fall贸
        return;
    }

    const startTime = event.start;
    let endTime = event.end;
    if (!endTime) {
        endTime = new Date(startTime);
        endTime.setHours(endTime.getHours() + 8);
    }

    const toastId = toast.loading(`Asignando a ${employeeName}...`);

    try {
      const shiftData = {
        employeeId,
        employeeName,
        objectiveId: selectedObjective,
        objectiveName: objectives.find(o => o.id === selectedObjective)?.name || 'Unknown',
        startTime: Timestamp.fromDate(startTime),
        endTime: Timestamp.fromDate(endTime),
      };

      //  LLAMADA AL BACKEND: Activa la validaci贸n de horas/vacaciones
      await callScheduleShift(shiftData);
      
      toast.success(`Turno asignado exitosamente`, { id: toastId });
      event.setProp('backgroundColor', '#4F46E5'); 

    } catch (error: any) {
      console.error(error);
      const message = error.message || 'Error al asignar.';
      toast.error(message, { id: toastId });
      info.revert(); 
    }
  };

  return (
    <div className="flex flex-col gap-6 h-[850px]">
      
      {/* HEADER: SELECTOR DE OBJETIVO */}
      <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between">
        <div>
            <h3 className="text-lg font-bold text-slate-800">Planificador de Turnos</h3>
            <p className="text-sm text-slate-500">Gesti贸n inteligente de cronogramas.</p>
        </div>
        <div className="w-1/3">
            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Objetivo</label>
            <select 
                value={selectedObjective} 
                onChange={(e) => setSelectedObjective(e.target.value)}
                className="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2"
                disabled={objectives.length === 0}
            >
                {objectives.length === 0 ? (
                    <option value="" disabled>Sin objetivos disponibles</option>
                ) : (
                    objectives.map(obj => (
                        <option key={obj.id} value={obj.id}>{obj.name}</option>
                    ))
                )}
            </select>
        </div>
      </div>

      <div className="flex flex-col lg:flex-row gap-6 flex-1 overflow-hidden">
        {/* PANEL IZQUIERDO: Colaboradores REALES */}
        <div className="w-full lg:w-1/5 bg-white p-4 rounded-xl shadow-sm border border-slate-200 overflow-y-auto flex flex-col" ref={draggableRef}>
            <div className="mb-4">
                <h4 className="font-bold text-slate-700">Colaboradores ({employees.length})</h4>
                {employees.length === 0 && selectedClientId && <p className="text-xs text-red-500 mt-1">Cargue personal en RRHH.</p>}
            </div>
            
            <div className="space-y-2 flex-1">
            {employees.map((emp) => (
                <div 
                key={emp.uid}
                data-id={emp.uid} // ID REAL para el Backend
                data-name={emp.name}
                className="fc-event-external p-3 bg-white border border-slate-200 rounded-lg cursor-grab hover:border-indigo-400 hover:shadow-md transition-all flex items-center space-x-3 shadow-sm select-none"
                >
                <div className="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-xs">
                    {emp.name.charAt(0)}
                </div>
                <div>
                    <p className="text-sm font-medium text-slate-800 leading-tight">{emp.name}</p>
                    <p className="text-xs text-slate-500">{emp.role}</p>
                </div>
                </div>
            ))}
            </div>
        </div>

        {/* PANEL DERECHO: Calendario */}
        <div className="w-full lg:w-4/5 bg-white p-2 rounded-xl shadow-sm border border-slate-200 relative">
            {loading && (
                <div className="absolute inset-0 bg-white/80 z-50 flex items-center justify-center rounded-xl">
                    <span className="text-indigo-600 font-medium animate-pulse">Cargando turnos...</span>
                </div>
            )}
            
            <FullCalendar
                ref={calendarRef}
                plugins={[dayGridPlugin, timeGridPlugin, interactionPlugin]}
                initialView="timeGridWeek"
                headerToolbar={{
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                }}
                slotMinTime="06:00:00"
                slotMaxTime="23:00:00"
                allDaySlot={false}
                height="100%"
                locale="es"
                editable={true}
                droppable={true}
                events={shifts}
                eventReceive={handleEventReceive}
            />
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\shift-assignment-form.tsx
================================================================================
import React, { useState } from 'react';
import { callScheduleShift } from '@/services/firebase-client.service';
import { Timestamp } from 'firebase/firestore'; 

export function ShiftAssignmentForm() {
  const [employeeId, setEmployeeId] = useState('user_id_cajero_001'); // Placeholder
  const [objectiveId, setObjectiveId] = useState('obj_id_sucursal_centro'); // Placeholder
  const [startTime, setStartTime] = useState(''); 
  const [endTime, setEndTime] = useState('');
  const [message, setMessage] = useState<{ text: string, type: 'success' | 'error' } | null>(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setMessage(null);
    setLoading(true);

    try {
      const shiftData = {
        employeeId,
        objectiveId,
        startTime: Timestamp.fromDate(new Date(startTime)), 
        endTime: Timestamp.fromDate(new Date(endTime)),
      };

      const result = await callScheduleShift(shiftData);
      const data = result.data as { success: boolean, shiftId: string, message: string };
      setMessage({ text: data.message || "Turno asignado correctamente", type: 'success' });
      
    } catch (err: any) {
      const errorMessage = err.details || err.message;
      setMessage({ text: `Error: ${errorMessage}`, type: 'error' });
    } finally {
      setLoading(false);
    }
  };

  const inputClass = "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm";
  const labelClass = "block text-sm font-medium text-gray-700";

  return (
    <div className="space-y-6">
      {message && (
        <div className={`p-4 rounded-md ${message.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
          {message.text}
        </div>
      )}
      
      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label className={labelClass}>Inicio del Turno</label>
                <input type="datetime-local" value={startTime} onChange={(e) => setStartTime(e.target.value)} required className={inputClass} />
            </div>
            <div>
                <label className={labelClass}>Fin del Turno</label>
                <input type="datetime-local" value={endTime} onChange={(e) => setEndTime(e.target.value)} required className={inputClass} />
            </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label className={labelClass}>Empleado ID</label>
                <input type="text" value={employeeId} readOnly className={`${inputClass} bg-gray-100 cursor-not-allowed`} />
            </div>
            <div>
                <label className={labelClass}>Objetivo ID</label>
                <input type="text" value={objectiveId} readOnly className={`${inputClass} bg-gray-100 cursor-not-allowed`} />
            </div>
        </div>

        <button 
            type="submit" 
            disabled={loading}
            className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none transition duration-200 ${loading ? 'opacity-70' : ''}`}
        >
          {loading ? 'Asignando...' : 'Asignar Turno'}
        </button>
      </form>
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\system-user-management.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { callManageSystemUsers } from '@/services/firebase-client.service';
import { ISystemUser } from '@/common/interfaces/system-user.interface';
import toast from 'react-hot-toast';

export function SystemUserManagement() {
  const [users, setUsers] = useState<ISystemUser[]>([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);

  // Formulario
  const [formData, setFormData] = useState({
    uid: '',
    displayName: '',
    email: '',
    password: '',
    role: 'Scheduler',
    status: 'Active'
  });

  const fetchUsers = async () => {
    setLoading(true);
    try {
      const res = await callManageSystemUsers({ action: 'GET_ALL_USERS', payload: {} });
      const data = (res.data as any).data || [];
      setUsers(data);
    } catch (error) {
      console.error(error);
      toast.error("Error al cargar usuarios.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchUsers();
  }, []);

  const handleOpenCreate = () => {
    setFormData({ uid: '', displayName: '', email: '', password: '', role: 'Scheduler', status: 'Active' });
    setIsEditing(false);
    setShowModal(true);
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    const toastId = toast.loading("Procesando...");

    try {
      if (isEditing) {
        // Solo enviamos lo que cambia
        const payload = {
            uid: formData.uid,
            data: {
                role: formData.role,
                status: formData.status,
                displayName: formData.displayName
            }
        };
        await callManageSystemUsers({ action: 'UPDATE_USER', payload });
        toast.success("Usuario actualizado", { id: toastId });
      } else {
        await callManageSystemUsers({ 
            action: 'CREATE_USER', 
            payload: {
                email: formData.email,
                password: formData.password,
                displayName: formData.displayName,
                role: formData.role
            }
        });
        toast.success("Administrador creado", { id: toastId });
      }
      setShowModal(false);
      fetchUsers();
    } catch (error: any) {
      toast.error(`Error: ${error.message}`, { id: toastId });
    }
  };

  const handleDelete = async (uid: string) => {
    if (!confirm("驴Eliminar este administrador? Perder谩 el acceso inmediatamente.")) return;
    try {
        await callManageSystemUsers({ action: 'DELETE_USER', payload: { uid } });
        toast.success("Usuario eliminado");
        fetchUsers();
    } catch (error) {
        toast.error("Error al eliminar");
    }
  };

  // Estilos
  const inputClass = "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm";
  const labelClass = "block text-sm font-medium text-gray-700";

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-xl font-bold text-gray-800">Usuarios del Sistema</h2>
            <p className="text-sm text-gray-500">Gestione el acceso al panel administrativo.</p>
        </div>
        <button onClick={handleOpenCreate} className="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 transition shadow-sm flex items-center">
            <span className="mr-2">+</span> Nuevo Admin
        </button>
      </div>

      {/* Tabla */}
      <div className="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
                <tr>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Usuario</th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Rol</th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Estado</th>
                    <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Acciones</th>
                </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
                {users.map((user) => (
                    <tr key={user.uid} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center">
                                <div className="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-xs">
                                    {user.displayName.charAt(0)}
                                </div>
                                <div className="ml-3">
                                    <div className="text-sm font-medium text-gray-900">{user.displayName}</div>
                                    <div className="text-xs text-gray-500">{user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                            <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">
                                {user.role}
                            </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                {user.status}
                            </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onClick={() => handleDelete(user.uid)} className="text-red-600 hover:text-red-900">Eliminar</button>
                        </td>
                    </tr>
                ))}
            </tbody>
        </table>
      </div>

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <h3 className="text-lg font-bold text-gray-900 mb-4">{isEditing ? 'Editar Usuario' : 'Nuevo Administrador'}</h3>
                <form onSubmit={handleSave} className="space-y-4">
                    <div><label className={labelClass}>Nombre</label><input className={inputClass} value={formData.displayName} onChange={e => setFormData({...formData, displayName: e.target.value})} required /></div>
                    {!isEditing && (
                        <>
                            <div><label className={labelClass}>Email</label><input type="email" className={inputClass} value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required /></div>
                            <div><label className={labelClass}>Contrase帽a</label><input type="password" className={inputClass} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} required /></div>
                        </>
                    )}
                    <div>
                        <label className={labelClass}>Rol de Sistema</label>
                        <select className={inputClass} value={formData.role} onChange={e => setFormData({...formData, role: e.target.value as any})}>
                            <option value="SuperAdmin">Super Admin (Total)</option>
                            <option value="Scheduler">Planificador (Turnos)</option>
                            <option value="HR_Manager">RRHH (Empleados)</option>
                            <option value="Viewer">Solo Lectura</option>
                        </select>
                    </div>
                    <div className="flex justify-end space-x-3 mt-6">
                        <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg">Cancelar</button>
                        <button type="submit" className="px-4 py-2 text-white bg-gray-900 rounded-lg hover:bg-black">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\SystemStatus.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { callManageHierarchy, callManageEmployees, callCheckSystemHealth, auth } from '@/services/firebase-client.service';

interface HealthMetric {
    name: string;
    status: 'pending' | 'ok' | 'warning' | 'error';
    value?: string;
    details?: string;
}

export function SystemStatus() {
    const [metrics, setMetrics] = useState<HealthMetric[]>([
        { name: 'Conectividad Internet', status: 'pending' },
        { name: 'Sesi贸n de Usuario (Auth)', status: 'pending' },
        { name: 'Servidor (Cloud Functions)', status: 'pending' },
        { name: 'Base de Datos (Firestore)', status: 'pending' },
        { name: 'M贸dulo Jerarqu铆a', status: 'pending' },
        { name: 'M贸dulo RRHH', status: 'pending' },
    ]);
    const [isRunning, setIsRunning] = useState(false);

    useEffect(() => { runDiagnostics(); }, []);

    const updateMetric = (index: number, status: HealthMetric['status'], value: string, details: string = '') => {
        setMetrics(prev => {
            const newM = [...prev];
            newM[index] = { ...newM[index], status, value, details };
            return newM;
        });
    };

    const runDiagnostics = async () => {
        setIsRunning(true);
        
        // 1. Local Checks
        const isOnline = navigator.onLine;
        updateMetric(0, isOnline ? 'ok' : 'error', isOnline ? 'Online' : 'Offline');
        if (!isOnline) { setIsRunning(false); return; }

        const user = auth.currentUser;
        updateMetric(1, user ? 'ok' : 'error', user ? 'Autenticado' : 'Sin Sesi贸n', user?.uid);

        // 2. Health Check Real (Ping al servidor)
        const startServer = Date.now();
        try {
            const healthRes = await callCheckSystemHealth({});
            const endServer = Date.now();
            const data = healthRes.data as any;

            updateMetric(2, 'ok', `${endServer - startServer}ms`, `Node ${data.nodeVersion}`);
            
            const dbLat = data.database.latencyMs;
            updateMetric(3, data.database.status === 'connected' ? 'ok' : 'error', `${dbLat}ms`);

        } catch (error: any) {
            updateMetric(2, 'error', 'Fallo Cr铆tico', error.message);
            updateMetric(3, 'error', 'Inaccesible', 'Timeout o Error 500');
        }

        // 3. Smoke Test de M贸dulos
        await testModule(4, async () => callManageHierarchy({ action: 'GET_ALL_CLIENTS', payload: {} }));
        await testModule(5, async () => callManageEmployees({ action: 'GET_ALL_EMPLOYEES', payload: {} }));

        setIsRunning(false);
    };

    const testModule = async (index: number, call: () => Promise<any>) => {
        const start = Date.now();
        try {
            await call();
            updateMetric(index, 'ok', `${Date.now() - start}ms`, 'Operativo');
        } catch (error: any) {
            updateMetric(index, 'error', 'Fallo', error.message);
        }
    };

    return (
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <div className="flex justify-between items-center mb-6">
                <h3 className="font-bold text-slate-800 text-lg">Monitor de Salud</h3>
                <button onClick={runDiagnostics} disabled={isRunning} className="px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-bold hover:bg-indigo-100 disabled:opacity-50">
                    {isRunning ? 'Escaneando...' : 'Re-escanear'}
                </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {metrics.map((m, idx) => (
                    <div key={idx} className={`p-4 rounded-lg border flex items-center justify-between ${m.status === 'ok' ? 'bg-green-50 border-green-100' : m.status === 'error' ? 'bg-red-50 border-red-100' : 'bg-gray-50'}`}>
                        <div>
                            <p className="text-xs font-bold text-gray-500 uppercase mb-1">{m.name}</p>
                            <div className="flex items-center gap-2">
                                <div className={`w-2.5 h-2.5 rounded-full ${m.status === 'ok' ? 'bg-green-500' : m.status === 'error' ? 'bg-red-500' : 'bg-yellow-400 animate-pulse'}`} />
                                <span className="font-bold text-slate-700">{m.status === 'pending' ? '...' : m.value}</span>
                            </div>
                        </div>
                        {m.details && <div className="text-xs text-gray-500 text-right max-w-[120px] truncate" title={m.details}>{m.details}</div>}
                    </div>
                ))}
            </div>
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\common\Button.tsx
================================================================================
import React from 'react';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
    primary?: boolean;
    children: React.ReactNode;
}

/**
 * @description Reusable button component with basic Tailwind styles.
 */
export default function Button({ primary = true, children, className, disabled, ...props }: ButtonProps) {
    const baseStyle = "px-4 py-2 rounded-lg font-semibold transition-colors duration-150";
    const primaryStyle = "bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-indigo-300";
    const secondaryStyle = "bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:bg-gray-100";

    return (
        <button
            className={`${baseStyle} ${primary ? primaryStyle : secondaryStyle} ${className || ''}`}
            disabled={disabled}
            {...props}
        >
            {children}
        </button>
    );
}

================================================================================
FILE: apps\web\src\components\common\InputField.tsx
================================================================================
import React from 'react';

interface InputFieldProps extends React.InputHTMLAttributes<HTMLInputElement | HTMLTextAreaElement> {
    label: string;
    id: string;
    type?: 'text' | 'email' | 'password' | 'number' | 'date' | 'textarea';
    rows?: number;
}

/**
 * @description Reusable input/textarea component.
 */
export default function InputField({ label, id, type = 'text', rows = 1, className, ...props }: InputFieldProps) {
    const inputStyle = "w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 text-sm";

    return (
        <div className={`space-y-1 ${className}`}>
            <label htmlFor={id} className="block text-sm font-medium text-gray-700">
                {label}
            </label>
            {type === 'textarea' ? (
                <textarea
                    id={id}
                    className={inputStyle}
                    rows={rows}
                    {...props as React.TextareaHTMLAttributes<HTMLTextAreaElement>}
                />
            ) : (
                <input
                    id={id}
                    type={type}
                    className={inputStyle}
                    {...props as React.InputHTMLAttributes<HTMLInputElement>}
                />
            )}
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\common\SelectField.tsx
================================================================================
import React from 'react';

interface SelectFieldProps extends React.SelectHTMLAttributes<HTMLSelectElement> {
    label: string;
    id: string;
    children: React.ReactNode;
}

/**
 * @description Reusable select (dropdown) component.
 */
export default function SelectField({ label, id, children, className, ...props }: SelectFieldProps) {
    const selectStyle = "w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 text-sm";
    
    return (
        <div className={`space-y-1 ${className}`}>
            <label htmlFor={id} className="block text-sm font-medium text-gray-700">
                {label}
            </label>
            <select
                id={id}
                className={selectStyle}
                {...props}
            >
                {children}
            </select>
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\common\shift.interface.ts
================================================================================
/**
 * @file shift.interface.ts
 * @description Definici贸n de la estructura de un Turno (Shift) compartido entre Frontend y Backend.
 */

// Definimos un tipo flexible para las fechas para soportar:
// 1. admin.firestore.Timestamp (Backend)
// 2. firebase.firestore.Timestamp (Frontend SDK)
// 3. Date (Objetos JS nativos tras conversi贸n)
// 4. { seconds: number, nanoseconds: number } (JSON serializado)
export type FirestoreDate = any; 

export type ShiftStatus = 'Scheduled' | 'In Progress' | 'Completed' | 'Absent';

export interface IShift {
    id: string; // ID del documento en Firestore
    
    // Relaci贸n con Empleado
    employeeId: string;
    employeeName: string;
    
    // Relaci贸n con Objetivo (Cliente/Sede)
    objectiveId: string;
    objectiveName: string; //  Requerido para mostrar en el Dashboard
    
    // Tiempos
    startTime: FirestoreDate;
    endTime: FirestoreDate;
    
    // Estado del ciclo de vida
    status: ShiftStatus;
    
    // Datos opcionales de auditor铆a en el mismo documento (si aplica)
    checkInTime?: FirestoreDate;
    checkOutTime?: FirestoreDate;
    
    // Metadatos
    role?: string; // Rol del empleado durante ese turno (ej: 'Vigilador', 'Supervisor')
}

================================================================================
FILE: apps\web\src\components\common\withAuthGuard.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/router';
import { User, onAuthStateChanged } from 'firebase/auth';
import { auth } from '../../services/firebase-client.service';

// Roles que se consideran "Administrativos"
const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager'];

export const withAuthGuard = (WrappedComponent: React.ComponentType<any>, requiredRole: string = 'admin') => {
  
  //  LOG DE DEBUG 1: Ver qu茅 configuraci贸n recibe el guardia al crearse
  console.log(`[DEBUG GUARD] Iniciando guardia para componente: ${WrappedComponent.displayName || WrappedComponent.name}`);
  console.log(`[DEBUG GUARD] Rol Requerido (requiredRole):`, requiredRole);

  const ComponentWithAuthGuard = (props: any) => {
    const router = useRouter();
    const [loading, setLoading] = useState(true);
    const [currentUser, setCurrentUser] = useState<User | null>(null);

    useEffect(() => {
      console.log("[DEBUG GUARD] useEffect ejecut谩ndose...");
      const unsubscribe = onAuthStateChanged(auth, async (user) => {
        if (!user) {
          console.log("[DEBUG GUARD] No hay usuario, redirigiendo a /");
          router.replace('/'); 
          return;
        }

        console.log(`[DEBUG GUARD] Usuario detectado: ${user.email}`);
        setCurrentUser(user);
        
        try {
          const tokenResult = await user.getIdTokenResult();
          const userRole = tokenResult.claims.role as string;
          
          //  LOG DE DEBUG 2: Ver qu茅 rol tiene el usuario real
          console.log(`[DEBUG GUARD] Rol del Usuario (Claims): ${userRole}`);
          console.log(`[DEBUG GUARD] Comparando contra Requerido: ${requiredRole}`);

          let isAuthorized = false;

          if (requiredRole === 'admin') {
            isAuthorized = ADMIN_ROLES.includes(userRole);
          } else {
            // Comparaci贸n estricta para otros roles (ej: 'employee')
            isAuthorized = userRole === requiredRole;
          }
          
          console.log(`[DEBUG GUARD] Resultado Autorizaci贸n: ${isAuthorized}`);

          if (isAuthorized) {
            setLoading(false);
          } else {
            console.warn(`[DEBUG GUARD] ACCESO DENEGADO. Requerido: ${requiredRole}, Encontrado: ${userRole}`);
            // Comentamos el signOut temporalmente para que puedas ver el log sin que te eche inmediatamente
            // await auth.signOut(); 
            // router.replace('/');
          }
        } catch (error) {
          console.error("[DEBUG GUARD] Error verificando rol:", error);
          router.replace('/');
        }
      });

      return () => unsubscribe();
    }, [router]);

    if (loading || !currentUser) {
      return <div className="p-10 text-center">Cargando seguridad... (Mira la consola)</div>;
    }

    return <WrappedComponent {...props} currentUser={currentUser} />;
  };

  return ComponentWithAuthGuard;
};

================================================================================
FILE: apps\web\src\components\employee\employee-dashboard.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { getEmployeeShifts, callAuditShift } from '@/services/firebase-client.service';
import { IShift } from '@/common/interfaces/shift.interface';
import toast from 'react-hot-toast';

interface EmployeeDashboardProps {
  currentUser: User; 
}

interface Coordinates {
    latitude: number;
    longitude: number;
}

//  NOTA: Esto es una funci贸n exportada normal. NO usar 'export default' ni 'withAuthGuard' aqu铆.
export function EmployeeDashboard({ currentUser }: EmployeeDashboardProps) {
  const [shifts, setShifts] = useState<IShift[]>([]);
  const [loading, setLoading] = useState(true);
  const [isAuditing, setIsAuditing] = useState(false); 
  
  const loadShifts = async () => {
    setLoading(true);
    try {
      const data = await getEmployeeShifts(currentUser.uid);
      setShifts(data);
    } catch (err: any) {
      console.error(err);
      toast.error("Error al cargar turnos.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (currentUser) loadShifts();
  }, [currentUser]);

  const formatTime = (timestamp: any) => {
    if (!timestamp) return 'N/A';
    if (timestamp?.toDate) return timestamp.toDate().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
    if (timestamp instanceof Date) return timestamp.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
    return 'N/A';
  };

  const formatDate = (timestamp: any) => {
    if (!timestamp) return 'N/A';
    if (timestamp?.toDate) return timestamp.toDate().toLocaleDateString('es-ES');
    return 'N/A';
  };
  
  const handleAuditAction = (shiftId: string, action: 'CHECK_IN' | 'CHECK_OUT') => {
    if (isAuditing) return;
    setIsAuditing(true);

    if (!navigator.geolocation) {
      toast.error('Tu navegador no soporta geolocalizaci贸n.');
      setIsAuditing(false);
      return;
    }

    const toastId = toast.loading("Verificando ubicaci贸n...");

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const employeeCoords: Coordinates = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
        };

        try {
          await callAuditShift({ shiftId, action, coords: employeeCoords });
          toast.success("隆Registro exitoso!", { id: toastId });
          loadShifts(); 
        } catch (err: any) {
          const msg = err.code === 'functions/failed-precondition' 
            ? ' Est谩s demasiado lejos del objetivo.' 
            : 'Error al registrar.';
          toast.error(msg, { id: toastId });
        } finally {
          setIsAuditing(false);
        }
      },
      (geoError) => {
        toast.error("Activa el GPS para continuar.", { id: toastId });
        setIsAuditing(false);
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  };

  if (loading) return <div className="p-8 text-center animate-pulse">Cargando tus asignaciones...</div>;
  
  return (
    <div className="max-w-lg mx-auto">
      <h2 className="text-xl font-bold mb-4 text-gray-700 px-4">锔 Tus Pr贸ximos Turnos</h2>
      
      {shifts.length === 0 && <div className="bg-white p-6 m-4 rounded-xl shadow text-center text-gray-500">No tienes turnos programados.</div>}

      <div className="space-y-4 px-4 pb-20">
        {shifts.map((shift) => (
          <div key={shift.id} className="bg-white p-5 rounded-xl shadow-sm border-l-4 border-indigo-500">
            <p className="font-bold text-lg text-gray-800">{shift.objectiveName || 'Objetivo'}</p>
            
            <div className="mt-2 text-sm text-gray-600 space-y-1">
                <p> {formatDate(shift.startTime)}</p>
                <p> <strong>{formatTime(shift.startTime)}</strong> - <strong>{formatTime(shift.endTime)}</strong></p>
                <p>Estado: <span className={`font-semibold ${shift.status === 'Completed' ? 'text-green-600' : 'text-blue-600'}`}>{shift.status}</span></p>
            </div>
            
            <div className="mt-4">
                {shift.status === 'Assigned' && (
                    <button onClick={() => handleAuditAction(shift.id, 'CHECK_IN')} disabled={isAuditing} className="w-full bg-green-600 text-white p-3 rounded-lg font-bold shadow hover:bg-green-700 transition">
                         Registrar Entrada
                    </button>
                )}
                {shift.status === 'InProgress' && (
                    <button onClick={() => handleAuditAction(shift.id, 'CHECK_OUT')} disabled={isAuditing} className="w-full bg-red-600 text-white p-3 rounded-lg font-bold shadow hover:bg-red-700 transition">
                         Registrar Salida
                    </button>
                )}
                {shift.status === 'Completed' && (
                    <div className="w-full p-2 bg-gray-100 text-gray-500 text-center rounded border"> Finalizado</div>
                )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\layout\DashboardLayout.tsx
================================================================================
import React from 'react';
import { useRouter } from 'next/router';
import { auth } from '@/services/firebase-client.service';
// Importamos el contexto para manejar el selector de clientes
import { useClient } from '@/context/ClientContext';

interface LayoutProps {
  children: React.ReactNode;
  title: string;
}

export function DashboardLayout({ children, title }: LayoutProps) {
  const router = useRouter();
  // Consumimos el estado global del cliente
  const { clients, selectedClientId, setClient, loading } = useClient();

  // Logout seguro con redirecci贸n "dura" a la ra铆z para evitar 404
  const handleLogout = async () => {
    try {
      await auth.signOut();
      window.location.href = '/'; 
    } catch (error) {
      console.error("Error al cerrar sesi贸n:", error);
    }
  };

  const menuItems = [
    { 
      name: 'Panel de Control', 
      path: '/admin/dashboard', 
      icon: (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>)
    },
    { 
      name: 'Alta Comercial', 
      path: '/admin/clients/new', 
      icon: (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>)
    },
    { 
      name: 'Objetivos', 
      path: '/admin/objective-management', 
      icon: (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a2 2 0 00-2-2H7a2 2 0 00-2 2v5m14 0v-5a2 2 0 00-2-2h-2a2 2 0 00-2 2v5" /></svg>)
    },
    { 
      name: 'RRHH / Empleados', 
      path: '/admin/employees', 
      icon: (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z" /></svg>)
    },
    //  NUEVO TEM: Usuarios del Sistema (Back-Office)
    { 
      name: 'Usuarios del Sistema', 
      path: '/admin/system-users', 
      icon: (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>)
    },
  ];

  return (
    <div className="flex h-screen bg-slate-50 font-sans">
      {/* Sidebar Lateral */}
      <aside className="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col fixed md:relative h-full z-20">
        <div className="h-16 flex items-center px-6 border-b border-gray-100">
          <span className="text-xl font-extrabold text-slate-800 tracking-tight">Control<span className="text-indigo-600">Data</span></span>
        </div>

        {/* Selector de Empresa */}
        <div className="px-4 py-4 border-b border-gray-100 bg-gray-50/50">
            <label className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1 block">Empresa Cliente</label>
            {loading ? (
                <div className="h-9 w-full bg-gray-200 rounded animate-pulse"></div>
            ) : (
                <div className="relative">
                  <select 
                      value={selectedClientId} 
                      onChange={(e) => setClient(e.target.value)}
                      className="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 pl-2 pr-8 appearance-none bg-white cursor-pointer truncate"
                  >
                      <option value="" disabled>Seleccionar...</option>
                      {clients.map(c => (
                          <option key={c.id} value={c.id}>{c.businessName}</option>
                      ))}
                  </select>
                  <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                  </div>
                </div>
            )}
        </div>

        <nav className="flex-1 px-4 py-4 space-y-2 overflow-y-auto scrollbar-thin">
          {menuItems.map((item) => {
            const isActive = router.pathname === item.path;
            return (
              <button
                key={item.name}
                onClick={() => router.push(item.path)}
                className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 group ${
                  isActive 
                    ? 'bg-indigo-50 text-indigo-700 font-semibold shadow-sm' 
                    : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                }`}
              >
                <span className={`${isActive ? 'text-indigo-600' : 'text-slate-400 group-hover:text-slate-600'}`}>
                  {item.icon}
                </span>
                <span>{item.name}</span>
              </button>
            )
          })}
        </nav>

        <div className="p-4 border-t border-gray-100 mt-auto">
          <button onClick={handleLogout} className="flex items-center space-x-3 text-red-500 hover:bg-red-50 w-full px-4 py-3 rounded-xl transition-colors text-sm font-medium">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
            <span>Cerrar Sesi贸n</span>
          </button>
        </div>
      </aside>

      {/* Contenido Principal */}
      <div className="flex-1 flex flex-col overflow-hidden h-screen">
        <header className="h-16 bg-white/80 backdrop-blur-md border-b border-gray-200 flex items-center justify-between px-4 md:px-8 sticky top-0 z-10 shrink-0">
          <h2 className="text-lg font-bold text-slate-800 truncate">{title}</h2>
          <div className="flex items-center space-x-4">
             <div className="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs border border-indigo-200">
                AD
             </div>
          </div>
        </header>

        <main className="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 scroll-smooth">
          <div className="max-w-7xl mx-auto h-full">
            {children}
          </div>
        </main>
      </div>
    </div>
  );
}

================================================================================
FILE: apps\web\src\context\ClientContext.tsx
================================================================================
import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { onAuthStateChanged } from 'firebase/auth';
import { auth, callManageHierarchy } from '@/services/firebase-client.service';
import { IClient } from '@/common/interfaces/client.interface';
import toast from 'react-hot-toast';

interface ClientContextType {
  clients: IClient[];
  selectedClientId: string;
  selectedClient: IClient | undefined;
  setClient: (id: string) => void;
  loading: boolean;
}

// Roles que tienen permiso para ver/listar empresas en el backend
const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager'];

const ClientContext = createContext<ClientContextType | undefined>(undefined);

export function ClientProvider({ children }: { children: ReactNode }) {
  const [clients, setClients] = useState<IClient[]>([]);
  const [selectedClientId, setSelectedClientId] = useState<string>('');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          //  FIX CRTICO: Verificar el rol ANTES de pedir datos al backend
          // Esto evita el error 403 cuando entra un empleado
          const tokenResult = await user.getIdTokenResult();
          const role = tokenResult.claims.role as string;

          if (ADMIN_ROLES.includes(role)) {
            await loadClients(); // Solo carga si es personal administrativo
          } else {
            // Si es empleado, no cargamos clientes y liberamos el loading
            setLoading(false);
          }
        } catch (error) {
          console.error("Error verificando permisos del contexto:", error);
          setLoading(false);
        }
      } else {
        // Logout
        setClients([]);
        setSelectedClientId('');
        setLoading(false);
      }
    });

    return () => unsubscribe();
  }, []);

  async function loadClients() {
    try {
      const res = await callManageHierarchy({ action: 'GET_ALL_CLIENTS', payload: {} });
      const responseData = res.data as any; 
      const data = responseData.data || [];
      
      setClients(data);

      // Recuperar selecci贸n previa o default
      const savedId = localStorage.getItem('selectedClientId');
      if (savedId && data.find((c: IClient) => c.id === savedId)) {
        setSelectedClientId(savedId);
      } else if (data.length > 0) {
        setSelectedClientId(data[0].id);
        localStorage.setItem('selectedClientId', data[0].id);
      }
    } catch (error: any) {
      console.error("Error loading clients", error);
      toast.error("No se pudieron cargar las empresas.");
    } finally {
      setLoading(false);
    }
  }

  const setClient = (id: string) => {
    setSelectedClientId(id);
    localStorage.setItem('selectedClientId', id);
    toast.success("Empresa cambiada");
  };

  const selectedClient = clients.find(c => c.id === selectedClientId);

  return (
    <ClientContext.Provider value={{ clients, selectedClientId, selectedClient, setClient, loading }}>
      {children}
    </ClientContext.Provider>
  );
}

export function useClient() {
  const context = useContext(ClientContext);
  if (!context) throw new Error('useClient debe usarse dentro de ClientProvider');
  return context;
}

================================================================================
FILE: apps\web\src\hooks\useSchedulerDataFetcher.ts
================================================================================
import { useState, useEffect } from 'react';
import toast from 'react-hot-toast';
import { callManageEmployees, callManageData } from '@/services/firebase-client.service';
import { IEmployee } from '@/common/interfaces/employee.interface';
import { IObjective } from '@/common/interfaces/client.interface';

export const useSchedulerDataFetcher = (selectedClientId: string | null) => {
    const [employees, setEmployees] = useState<IEmployee[]>([]);
    const [objectives, setObjectives] = useState<IObjective[]>([]);
    const [selectedObjectiveId, setSelectedObjectiveId] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);

    useEffect(() => {
        const fetchAll = async () => {
            //  DEBUG: Verificar qu茅 ID llega al hook
            console.log(" [Fetcher] Cambio de empresa detectado. ID:", selectedClientId);

            // Si no hay cliente seleccionado, limpiamos y salimos
            if (!selectedClientId) {
                console.log("锔 [Fetcher] No hay cliente seleccionado. Limpiando datos.");
                setEmployees([]);
                setObjectives([]);
                setSelectedObjectiveId('');
                return;
            }

            setIsLoading(true);
            
            try {
                // 1. Obtener Empleados (Con filtro de empresa)
                console.log(" [Fetcher] Solicitando empleados al Backend para cliente:", selectedClientId);
                
                const empRes = await callManageEmployees({ 
                    action: 'GET_ALL_EMPLOYEES', 
                    payload: { clientId: selectedClientId } //  Aqu铆 enviamos el filtro
                });
                
                // Manejo defensivo de la respuesta
                const empData = (empRes.data as any).data || [];
                
                //  DEBUG: Verificar qu茅 devolvi贸 el Backend
                console.log(` [Fetcher] Recibidos ${empData.length} empleados.`);
                console.log(" [Fetcher] Lista de empleados:", empData);
                
                setEmployees(empData);

                // 2. Obtener Objetivos (Con filtro de empresa)
                console.log(" [Fetcher] Solicitando objetivos...");
                const objRes = await callManageData({ 
                    action: 'GET_ALL_OBJECTIVES', 
                    payload: { clientId: selectedClientId } 
                });
                
                const objData = (objRes.data as any).data || [];
                setObjectives(objData);
                
                // Seleccionar autom谩ticamente el primer objetivo si existe
                if (objData.length > 0) {
                    setSelectedObjectiveId(objData[0].id);
                } else {
                    setSelectedObjectiveId('');
                }
            
            } catch (error) {
                console.error(" [Fetcher] Error CRTICO cargando datos:", error);
                toast.error("Error al cargar los datos de la empresa.");
                setEmployees([]);
                setObjectives([]);
            } finally {
                setIsLoading(false);
            }
        };

        fetchAll();

    }, [selectedClientId]); //  DEPENDENCIA: Se ejecuta al cambiar el cliente

    return { 
        employees, 
        objectives, 
        selectedObjectiveId, 
        setSelectedObjectiveId, 
        isLoading 
    };
};

================================================================================
FILE: apps\web\src\services\firebase-client.service.ts
================================================================================
import { initializeApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getFunctions, httpsCallable } from 'firebase/functions';
import { 
    getFirestore, 
    collection, 
    query, 
    where, 
    getDocs, 
    QueryDocumentSnapshot,
    Timestamp //  IMPORTACIN DE TIMESTAMP AADIDA
} from 'firebase/firestore';
// Usamos el alias @/ para importar las interfaces locales del Frontend
import { IShift } from '@/common/interfaces/shift.interface';
import { IAbsencePayload } from '@/common/interfaces/employee.interface'; //  IMPORTACIN DE PAYLOAD AADIDA

//  TUS CREDENCIALES REALES INTEGRADAS (No deben ser reveladas a menos que sea necesario para la inicializaci贸n)
const firebaseConfig = {
    apiKey: "AIzaSyBJaTiMekwbGPXAm-mkPl_u6KEWCSpvfic",
    authDomain: "comtroldata.firebaseapp.com",
    projectId: "comtroldata",
    storageBucket: "comtroldata.firebasestorage.app",
    messagingSenderId: "698108879063",
    appId: "1:698108879063:web:ab30eb8b80a774f52f1092",
    measurementId: "G-SWCD6XEWDH"
};

// 1. Inicializaci贸n de la app
const app = initializeApp(firebaseConfig);

// 2. Exportaci贸n de servicios base
export const auth = getAuth(app);
// La regi贸n 'us-central1' es la predeterminada de Cloud Functions
export const functions = getFunctions(app, 'us-central1');
export const db = getFirestore(app);

const SHIFTS_COLLECTION = 'turnos';

// ------------------------------------------------------------------
// 3. FUNCIONES INVOCABLES (CALLABLE FUNCTIONS - BACKEND)
// ------------------------------------------------------------------

/** P2: Asignaci贸n at贸mica de turnos */
export const callScheduleShift = httpsCallable(functions, 'scheduleShift');

/** P1: Crear usuarios (Solo Admin - Legacy) */
export const callCreateUser = httpsCallable(functions, 'createUser');

/** P1: Gesti贸n de Datos B谩sicos (Legacy) */
export const callManageData = httpsCallable(functions, 'manageData');

/** P4: Auditor铆a y Geofencing */
export const callAuditShift = httpsCallable(functions, 'auditShift');

/** P1: Gesti贸n de Jerarqu铆a Comercial (Clientes/Contratos) */
export const callManageHierarchy = httpsCallable(functions, 'manageHierarchy');

/**  NUEVO: Gesti贸n de RRHH (Empleados Operativos) */
export const callManageEmployees = httpsCallable(functions, 'manageEmployees');

/**  NUEVO: Gesti贸n de Usuarios del Sistema (Administradores) */
export const callManageSystemUsers = httpsCallable(functions, 'manageSystemUsers');

/**  FUNCIN AADIDA: Gesti贸n de Novedades (Ausencias) */
export const callManageAbsences = httpsCallable(functions, 'manageAbsences');


/**
 * @description Crea una nueva novedad/ausencia para un empleado.
 * Convierte el objeto Date del Frontend a Firebase Timestamp antes de la llamada.
 *  Nota: Esta es la implementaci贸n de la funci贸n de servicio, no la declaraci贸n callable.
 * La declaraci贸n callable se a帽ade arriba para reusabilidad.
 * * @param {{ action: 'CREATE_ABSENCE', payload: IAbsencePayload }} params - Datos de la ausencia.
 * @returns {Promise<any>} Respuesta del Backend tras la validaci贸n de WorkloadService.
 * @throws {Error} Si el Backend rechaza la ausencia por solapamiento o error interno.
 */
export async function createAbsence(params: { action: 'CREATE_ABSENCE', payload: IAbsencePayload }): Promise<any> {
    
    // 1. VALIDACIN (DRY, Seguridad)
    const { payload } = params;
    
    if (!payload.employeeId || !payload.clientId || !payload.startDate || !payload.endDate || !payload.reason) {
        console.error("Validation Error: Missing required fields for absence creation.", payload);
        throw new Error("Missing required fields for absence creation.");
    }
    
    // 2. CONVERSIN CRTICA (Date -> Timestamp)
    const absenceData = {
        employeeId: payload.employeeId,
        employeeName: payload.employeeName,
        clientId: payload.clientId,
        type: payload.type,
        // Usamos Timestamp.fromDate() para la conversi贸n
        startDate: Timestamp.fromDate(payload.startDate),
        endDate: Timestamp.fromDate(payload.endDate),
        reason: payload.reason,
    };

    try {
        // La callable function ya est谩 definida arriba: callManageAbsences
        const result = await callManageAbsences({ 
            action: params.action, 
            payload: absenceData 
        });
        
        // 3. Manejo de errores estructurado (Evitando fallos silenciosos)
        if (result.data && (result.data as any).success === false) {
             // Esto captura errores de negocio del NestJS Backend (ej: Conflicto de Turnos)
             throw new Error((result.data as any).message || "Backend validation failed.");
        }
        
        return result.data;
        
    } catch (error) {
        // Logging y re-throw para manejo en el componente
        console.error("[Service Error - createAbsence]:", error);
        throw error; 
    }
}


// ------------------------------------------------------------------
// 4. FUNCIONES DE CLIENTE (FIRESTORE DIRECTO)
// ------------------------------------------------------------------

/**
 * Obtiene los turnos de un empleado espec铆fico (Para el Dashboard del Empleado).
 */
export async function getEmployeeShifts(employeeId: string): Promise<IShift[]> {
    if (!employeeId) return [];
    
    const shiftsRef = collection(db, SHIFTS_COLLECTION);
    
    // Filtro: Solo turnos futuros o presentes para optimizar
    const now = new Date();
    
    //  FIX CRTICO DE SEGURIDAD: 
    // Agregamos where('employeeId', '==', employeeId) para cumplir con las reglas de Firestore
    const shiftsQuery = query(
        shiftsRef, 
        where('employeeId', '==', employeeId), 
        where('startTime', '>=', now)
    ); 
    
    const snapshot = await getDocs(shiftsQuery);

    return snapshot.docs.map((doc: QueryDocumentSnapshot) => {
        const data = doc.data();
        return {
            ...data,
            id: doc.id,
            // El SDK cliente ya devuelve timestamps compatibles
        };
    }) as unknown as IShift[];
}

/**
 * Obtiene los turnos de un Objetivo espec铆fico (Para el Scheduler del Admin).
 */
export async function getObjectiveShifts(objectiveId: string): Promise<IShift[]> {
    if (!objectiveId) return [];
    
    const shiftsRef = collection(db, SHIFTS_COLLECTION);
    const shiftsQuery = query(shiftsRef, where('objectiveId', '==', objectiveId)); 
    const snapshot = await getDocs(shiftsQuery);

    return snapshot.docs.map((doc: QueryDocumentSnapshot) => {
        const data = doc.data();
        return {
            ...data,
            id: doc.id,
        };
    }) as unknown as IShift[];
}

================================================================================
FILE: apps\web\src\utils\geolocation.ts
================================================================================
/**
 * @file apps/web/src/utils/geolocation.ts
 * @description Utility to handle browser Geolocation API with Promises and error handling.
 */

export interface IGeoCoordinates {
    latitude: number;
    longitude: number;
    accuracy: number;
}

/**
 * Obtiene la posici贸n actual del dispositivo con manejo de errores y timeout.
 * @param timeoutMs Tiempo m谩ximo de espera en milisegundos (default: 10s).
 * @returns Promise con las coordenadas o un error descriptivo.
 */
export function getCurrentPosition(timeoutMs: number = 10000): Promise<IGeoCoordinates> {
    return new Promise((resolve, reject) => {
        // 1. Verificar soporte del navegador
        if (!navigator.geolocation) {
            reject(new Error('La geolocalizaci贸n no es soportada por este navegador.'));
            return;
        }

        const options: PositionOptions = {
            enableHighAccuracy: true, // Intentar usar GPS real para mayor precisi贸n
            timeout: timeoutMs,       // Tiempo m谩ximo de espera
            maximumAge: 0             // No usar cach茅, queremos la ubicaci贸n actual
        };

        navigator.geolocation.getCurrentPosition(
            // Success Callback
            (position) => {
                resolve({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                });
            },
            // Error Callback
            (error) => {
                let message = 'Error desconocido de ubicaci贸n.';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'Permiso de ubicaci贸n denegado. Habil铆telo en su navegador para fichar.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'La ubicaci贸n no est谩 disponible (sin se帽al GPS).';
                        break;
                    case error.TIMEOUT:
                        message = 'Se agot贸 el tiempo para obtener la ubicaci贸n. Intente de nuevo.';
                        break;
                }
                reject(new Error(message));
            },
            options
        );
    });
}

================================================================================
FILE: apps\web\tailwind.config.ts
================================================================================
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/**/*.{js,ts,jsx,tsx,mdx}", //  CLAVE
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};
export default config;

================================================================================
FILE: apps\web\tsconfig.json
================================================================================
{
  "compilerOptions": {
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./src/*"
      ]
    },
    "target": "ES2017"
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}


================================================================================
FILE: CHANGELOG.md
================================================================================
---

### 2.  CHANGELOG.md

Crea este archivo en la ra铆z (`D:\APP\cronoapp\CHANGELOG.md`).

```markdown
# Changelog

Todos los cambios notables en el proyecto **ControlData** ser谩n documentados en este archivo.

## [1.0.2] - 2025-12-04 (Sprint: Estabilizaci贸n y Features Cr铆ticos)

###  Agregado (Features)
* **M贸dulo de Ausencias (Novedades):**
    * Frontend: Formulario de registro de ausencias (`AbsenceManagementPage`).
    * Backend: Servicio `AbsenceService` y endpoint `manageAbsences`.
    * Regla de Negocio: Bloqueo de creaci贸n de ausencias si existen turnos solapados.
* **Geolocalizaci贸n (Fichada):**
    * Implementada utilidad `getCurrentPosition` con manejo robusto de errores (timeout, permisos).
    * Integrada en `EmployeeDashboard` para obligar el env铆o de coordenadas GPS en `auditShift`.
* **Multi-tenancy (Filtrado por Empresa):**
    * Implementado `ClientContext` para manejar la empresa seleccionada globalmente.
    * Actualizado `useSchedulerDataFetcher` para filtrar empleados y objetivos seg煤n el `clientId`.
    * Actualizado el Backend (`EmployeeService`, `ClientService`) para soportar consultas filtradas.
* **Gesti贸n de N贸mina Avanzada:**
    * Formulario de alta de empleados con campos extendidos: DNI, Legajo, Direcci贸n.
    * Vinculaci贸n obligatoria de Empleado a Empresa (`clientId`).
* **Diagn贸stico:**
    * Nueva pantalla `/admin/status` para verificar la salud de los servicios del Backend en tiempo real.

###  Corregido (Bug Fixes)
* **Scheduler Duplication:** Solucionado bug donde los turnos se cargaban/asignaban 4 veces debido a m煤ltiples instancias de `Draggable` (agregado `cleanup` en `useEffect`).
* **Error 500 en Backend (Boot Crash):**
    * Solucionado error de inyecci贸n de dependencias en NestJS.
    * Implementada "Estrategia de Contenci贸n": Interfaces movidas dentro de los servicios (`ClientService`, `AbsenceService`) para evitar errores de "Module not found" en tiempo de ejecuci贸n.
    * Agregado `import 'reflect-metadata'` en `index.ts`.
    * Corregido `main.ts` para usar `createApplicationContext` en lugar de `create` (evita levantar servidor HTTP en Cloud Functions).
* **Errores 404 en Frontend:**
    * Configurado `cleanUrls: true` en `firebase.json`.
    * Configurado `output: 'export'` en `next.config.ts` para generaci贸n est谩tica correcta.
* **Navegaci贸n:** Corregido enlace de "Objetivos" en el Sidebar que apuntaba incorrectamente a "Clientes".
* **Borrado de Usuarios:** Ahora `deleteEmployee` elimina tanto el documento en Firestore como el usuario en Firebase Authentication.

###  Infraestructura
* **Runtime Upgrade:** Migraci贸n de Node.js 18 a **Node.js 20** en Cloud Functions.
* **Dependencias:**
    * Actualizaci贸n de `firebase-functions` a v4.9.0 (para compatibilidad Gen 1 con Node 20).
    * Instalaci贸n de `jest` y `@testing-library` en el frontend.
* **CI/CD:** Establecido procedimiento de "Despliegue Nuclear" (limpieza de `lib`, `.next`, `out`) para evitar inconsistencias de cach茅.

### 锔 Cambios Importantes (Breaking Changes)
* La interfaz `IEmployee` ahora requiere obligatoriamente `clientId`.
* Los servicios del Backend ya no dependen de archivos de interfaz externos en `common/interfaces` para evitar errores de compilaci贸n en la nube.

================================================================================
FILE: crear-admin.js
================================================================================
const admin = require('firebase-admin');
const serviceAccount = require('./service-account.json'); // 锔 OJO AQU

// Inicializar
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

const email = 'admin@bacar.com'; //  TU EMAIL DE ADMIN
const password = 'password123'; //  TU CONTRASEA

async function createSuperAdmin() {
  try {
    // 1. Crear usuario
    const userRecord = await admin.auth().createUser({
      email: email,
      password: password,
      displayName: 'Super Admin',
      emailVerified: true,
    });

    console.log('Usuario creado:', userRecord.uid);

    // 2. Asignar Custom Claim 'admin'
    await admin.auth().setCustomUserClaims(userRecord.uid, { role: 'admin' });
    console.log('Rol de ADMIN asignado exitosamente.');

    // 3. Crear perfil en Firestore (Opcional, para que no falle la UI)
    await admin.firestore().collection('empleados').doc(userRecord.uid).set({
        uid: userRecord.uid,
        name: 'Super Admin',
        email: email,
        role: 'admin',
        isAvailable: true
    });
    console.log('Perfil en Firestore creado.');

  } catch (error) {
    console.error('Error:', error);
  }
}

createSuperAdmin();

================================================================================
FILE: eslint.config.js
================================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])


================================================================================
FILE: firebase.json
================================================================================
{
  "functions": [
    {
      "source": "apps/functions",
      "codebase": "default",
      "runtime": "nodejs20", 
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log"
      ]
    }
  ],
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "hosting": {
    "public": "apps/web/out",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules"
    ],
    "rewrites": [
      {
        "source": "/api/**",
        "function": "api"
      }
    ]
  }
}

================================================================================
FILE: firestore.indexes.json
================================================================================
{
  "indexes": [
    {
      "collectionGroup": "ausencias",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "employeeId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "endDate",
          "order": "ASCENDING"
        }
      ]
    },
    {
      "collectionGroup": "turnos",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "employeeId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "startTime",
          "order": "ASCENDING"
        }
      ]
    }
  ],
  "fieldOverrides": []
}

================================================================================
FILE: firestore.rules
================================================================================
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIONES AUXILIARES ---
    
    // Verifica si el usuario tiene un rol administrativo v谩lido
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.role == 'admin' || 
        request.auth.token.role == 'SuperAdmin' || 
        request.auth.token.role == 'Scheduler' || 
        request.auth.token.role == 'HR_Manager'
      );
    }
    
    // Verifica si el usuario es el due帽o del documento
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // --- REGLAS POR COLECCIN ---

    // 1. Turnos (Operativo)
    match /turnos/{shiftId} {
      // Admins ven y editan todo
      allow read: if isAdmin();
      // Empleados solo ven sus propios turnos
      allow read: if request.auth != null && resource.data.employeeId == request.auth.uid;
      // Solo admins escriben (asignaci贸n)
      allow write: if isAdmin();
    }

    // 2. Empleados (RRHH)
    match /empleados/{employeeId} {
      // Admins gestionan todo
      allow read, write: if isAdmin();
      // Empleado ve su propio perfil
      allow read: if isOwner(employeeId);
    }

    // 3. Ausencias / Novedades
    match /ausencias/{absenceId} {
      allow read, write: if isAdmin();
      // Empleado puede ver sus propias ausencias
      allow read: if request.auth != null && resource.data.employeeId == request.auth.uid;
    }

    // 4. Jerarqu铆a Comercial (Clientes, Objetivos, Contratos)
    match /clientes/{clientId} {
      allow read, write: if isAdmin();
    }
    match /objetivos/{objectiveId} {
      allow read, write: if isAdmin();
    }
    match /contratos_servicio/{contractId} {
      allow read, write: if isAdmin();
    }
    match /tipos_turno/{typeId} {
      allow read, write: if isAdmin();
    }

    // 5. Usuarios del Sistema (Back-Office)
    match /system_users/{userId} {
      // Solo admins pueden ver/editar usuarios del sistema
      allow read, write: if isAdmin();
    }
  }
}

================================================================================
FILE: package.json
================================================================================
{
  "name": "cronoapp",
  "version": "1.0.0",
  "description": "Monorepositorio para la aplicaci贸n de cronogramas. Contiene Frontend (web) y Backend (functions).",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: Los tests se ejecutan en las subcarpetas: npm run test --workspace=functions\" && exit 1",
    "install:all": "npm install --workspaces",
    "dev:backend": "npm run serve --workspace=functions",
    "dev:frontend": "npm run dev --workspace=web"
  },
  "keywords": [
    "firebase",
    "nestjs",
    "nextjs",
    "typescript",
    "monorepo"
  ],
  "author": "Vale - Senior Tech Lead",
  "license": "ISC",
  "dependencies": {
    "firebase-admin": "^13.6.0"
  }
}


================================================================================
FILE: README.md
================================================================================
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is currently not compatible with SWC. See [this issue](https://github.com/vitejs/vite-plugin-react/issues/428) for tracking the progress.

## Expanding the ESLint configuration

If you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.


================================================================================
FILE: service-account.json.json
================================================================================
{
  "type": "service_account",
  "project_id": "comtroldata",
  "private_key_id": "542b807649adab8f5142487ad529a0522adff565",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC+EARTAdAae35J\n11vk1mozAg+JRUgHjJ3n2tgcHHJToQZZdWBN090Q2nyxM3j4cdoR5BrDV9x5nhSj\nIU9QTE9Z2Sc4iFx6xac1Di8JdZpWXb7S3Y1n2EIPyeVJLiejzLYExG/ha9JV8mO9\nj0eD+UShtTHXVWhToA/6Jm2o1IZlmoWdTH9cDd8frMAYIOi8aZmpR/rP5H7RGRej\nAvRqoC9eoizbA8u0QHGzkIAvezbOgCBy55J/bVZ1N7ARitdGsnIbiK5H9Sv9QIjC\n0kz+EIdAMH6K3B8YuwtmCX53TMO8xBeGs+CTwXM86tic50WbdnTRV88uAOTEbTBC\nZPr8EiVNAgMBAAECggEAPfzeVC5Gr6RwU2f8Th3KRDmbVJN2gxPPGmPrUPvMI89k\nUT/xeWCsfIct3ONjRHBphaVGP0jEHRw8Mdo20oMY7D5hRtReiSI2vxyRpb2n6Rwp\nFP/yUxiaryiTcfMuNYOaJ+LjdHtkfeiQtC3rTrU5N55vk4IFBSUyoMzwvfwWm0Mi\nJfqmtGO0ADAUGgftkZlmd7Vh7yt3JNJRbsZW/hZFIAAsg7o8kQZ+5Frwmwo8Ntn+\nUd4QryPAtBEUgTeafdeCKzs49Yi3RdbB60CBrcCq8uHgKGPP8xoga2VIIbx+smgr\nV6rDp0GPXpEz3P5pq6LBKAQkfMd/1PMe7B0kCxPQpwKBgQD2X7befQ7JrR+HqZr0\nMnJlzOFUbZT9TOL70e0LhOK7UE5tV5PXC1am8DIx/zuMcIC80f8hnyelHHopEv4+\nvyChk4/U2NbU0ECxPqmDsFsIJJRt/Tc3/9TR8S3L7ZM7s+AezkxuEourrq5DSU1i\n2gLuee1V85oANt3+zUBnt69/BwKBgQDFfRB8MP3GDEk5Y3lm+k8o+P9iLM4V/ZFQ\ny57wq9pEZxWTbXyWefaN7aeg3wRxVpNQTK0HaT8mNppSBeI9c7S3EL5SbvkCyTUk\nVHTN8o4BnQizVwkv5+ILU8UGW6dz/JFhxw55HyiiJO9bbxWzbCQK6pioCOVHDrf7\nZafvlp7QCwKBgQCTDJXNPb8xyE7lXenKjsGQ2TQ0fCNM/DMOMkHVej8JpejpgjgP\nRgk2Im8TQE9+hzePe5dXrfKvrcuL8HYnZVRInBZg5/txkcrK/6eVnhD3Tz34WAY5\nOkz/8X9wFCCopbfDK0aa/B65Hc2NA5dYxN6zD7sEbh0gu57Mkh06ynvIyQKBgQCV\nDSI/CV7PdgBh/vDmxu6t9tgRCc31DO77MuNfs+TFkaPYJF9O1vg+AGtu4ENjIzuF\n9Ij3Ofj+Z2GrnGM3jDeNn2Z1ounvr1qbc97AfVuuXg3uBTea34FcmTnv5YcJ5Er5\nqBoFUn4BeqzornuLcof1cUAMOsKJEdPMOto32s88JwKBgBts8voUhdhCqWu7sDLB\nF6fAuzOQxKxiWB0CPn8GHNJwZgjiPB5+Hj9mZRyfsS5Bn8fmCrC8q4MTpKmpURMd\nxmXteJP63Y6z2TQz8DhfVL84/0cTxC9nkRFqYeIkz+AiHkP8aw5u95f3QbThaGiM\nQzvcb4tHgOvJh5+G4cOnOfHH\n-----END PRIVATE KEY-----\n",
  "client_email": "firebase-adminsdk-fbsvc@comtroldata.iam.gserviceaccount.com",
  "client_id": "109561112383296200622",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-fbsvc%40comtroldata.iam.gserviceaccount.com",
  "universe_domain": "googleapis.com"
}


================================================================================
FILE: set-admin-role.js
================================================================================
const admin = require('firebase-admin');
// Aseg煤rate de tener tu archivo de credenciales aqu铆
const serviceAccount = require('./service-account.json'); 

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

const uid = 'BIar6f7ILATdkucXKH9NTDUkKQG2'; //  COPIA AQU EL UID DE TU USUARIO QUE FALLA

async function setAdminRole() {
  try {
    // 1. Asignar el Custom Claim 'role: admin'
    await admin.auth().setCustomUserClaims(uid, { role: 'admin' });
    
    console.log(` XITO: Rol de admin asignado al usuario ${uid}`);
    console.log('锔 IMPORTANTE: Debes cerrar sesi贸n y volver a entrar para que el token se actualice.');
    
    // Verificaci贸n
    const user = await admin.auth().getUser(uid);
    console.log('Claims actuales:', user.customClaims);
    
  } catch (error) {
    console.error(' Error:', error);
  }
}

setAdminRole();

================================================================================
FILE: set-employee-role.js
================================================================================
const admin = require('firebase-admin');
const serviceAccount = require('./service-account.json'); 

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount)
  });
}

//  ESTE ES EL UID QUE SAQU DE TU CAPTURA DE PANTALLA
const uid = 'MBKd9pqsSPXPcxsLxyPUdC8NFCd2'; 

async function setEmployeeRole() {
  try {
    console.log(` Buscando usuario ${uid}...`);
    
    // 1. Asignar el Custom Claim en Auth (El sello en la tarjeta)
    await admin.auth().setCustomUserClaims(uid, { role: 'employee' });
    
    console.log(` XITO: Rol 'employee' asignado a D茅bora.`);
    console.log(`锔 IMPORTANTE: Ella debe cerrar sesi贸n y volver a entrar.`);

  } catch (error) {
    console.error(' Error:', error.message);
  }
}

setEmployeeRole();

================================================================================
FILE: vite.config.js
================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react-swc'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})

