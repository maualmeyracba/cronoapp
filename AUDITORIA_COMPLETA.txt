AUDITORA DE PROYECTO CONTROL DATA
Fecha: 2025-12-05T18:46:55.784Z
----------------------------------------


================================================================================
FILE: apps\functions\jest.config.js
================================================================================
/** @type {import('ts-jest').JestConfigWithTsJest} */
module.exports = {
  // Configuraci贸n base para proyectos TypeScript con Jest
  preset: 'ts-jest', 
  
  // Entorno de ejecuci贸n de Node.js (necesario para el backend)
  testEnvironment: 'node', 
  
  // Rutas donde buscar los archivos fuente y de prueba
  roots: ['<rootDir>/src/', '<rootDir>/test/'],
  
  // Expresiones regulares para identificar archivos de prueba (archivos terminados en .spec.ts o .test.ts)
  testRegex: '(/__tests__/.*|(\\.|/)(test|spec))\\.ts$',

  // Configuraci贸n de M贸dulos (para resolver rutas internas de NestJS)
  moduleNameMapper: {
    // Si tienes aliases definidos en tsconfig.json, se deben mapear aqu铆
  },
  
  // CLAVE: Definici贸n expl铆cita del transformador para manejar TypeScript
  transform: {
    // Usar ts-jest para todos los archivos .ts
    '^.+\\.ts$': [
      'ts-jest', 
      {
        // Indica a ts-jest que use el archivo de configuraci贸n de TypeScript del proyecto actual
        tsconfig: './tsconfig.json', 
      },
    ],
  },
  
  // Extensiones de archivos que debe buscar
  moduleFileExtensions: ['js', 'json', 'ts'],

  // Carpetas a ignorar para la transformaci贸n y ejecuci贸n
  testPathIgnorePatterns: [
    '/node_modules/',
    '/lib/' // Carpeta de salida de la compilaci贸n
  ],
  
  // Configuraci贸n de Cobertura de C贸digo (Opcional, pero recomendado en la WBS)
  collectCoverageFrom: [
    'src/**/*.{js,ts}'
  ],
  coverageDirectory: 'coverage',
};

================================================================================
FILE: apps\functions\package.json
================================================================================
{
  "name": "functions",
  "scripts": {
    "lint": "eslint --ext .ts,.js src/",
    "build": "tsc",
    "build:watch": "tsc --watch",
    "serve": "npm run build && firebase emulators:start --only functions",
    "shell": "npm run build && firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "20"
  },
  "main": "lib/index.js",
  "dependencies": {
    "@nestjs/common": "^10.0.0",
    "@nestjs/core": "^10.0.0",
    "@nestjs/platform-express": "^10.0.0",
    "firebase-admin": "^12.0.0",
    "firebase-functions": "^4.9.0", 
    "reflect-metadata": "^0.1.13",
    "rxjs": "^7.8.1"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@typescript-eslint/eslint-plugin": "^5.59.11",
    "@typescript-eslint/parser": "^5.59.11",
    "eslint": "^8.42.0",
    "eslint-config-google": "^0.14.0",
    "eslint-plugin-import": "^2.27.5",
    "typescript": "^5.1.3",
    "firebase-functions-test": "^3.1.0"
  },
  "private": true
}

================================================================================
FILE: apps\functions\src\app.module.ts
================================================================================
// apps/functions/src/app.module.ts
import { Module } from '@nestjs/common';
import { AuthModule } from './auth/auth.module';
import { SchedulingModule } from './scheduling/scheduling.module';
import { DataManagementModule } from './data-management/data-management.module'; // Importar nuevo m贸dulo

@Module({
  imports: [
    AuthModule,
    SchedulingModule,
    DataManagementModule, // Incluir el m贸dulo de gesti贸n de datos
  ],
  controllers: [],
  providers: [],
})
export class AppModule {}

================================================================================
FILE: apps\functions\src\auth\auth.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { AuthService } from './auth.service';

/**
 * @module AuthModule
 * @description M贸dulo encargado de la creaci贸n de usuarios, asignaci贸n de roles (Custom Claims)
 * y gesti贸n de perfiles en la colecci贸n 'empleados'.
 */
@Module({
  imports: [],
  providers: [AuthService],
  exports: [AuthService], // Exportamos el servicio para que otros m贸dulos lo utilicen.
})
export class AuthModule {}

================================================================================
FILE: apps\functions\src\auth\auth.service.ts
================================================================================
import { Injectable, InternalServerErrorException, ConflictException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IEmployee } from '../common/interfaces/employee.interface';

const EMPLOYEES_COLLECTION = 'empleados';

@Injectable()
export class AuthService {

  //  Inicializaci贸n diferida (Lazy Loading)
  private getAuth = () => admin.app().auth();
  private getDb = () => admin.app().firestore();

  async createEmployeeProfile(
    email: string,
    password: string,
    role: IEmployee['role'],
    name: string,
    //  Nuevo argumento: Datos extendidos del perfil
    profileData: { clientId: string, dni: string, fileNumber: string, address: string }
  ): Promise<IEmployee> {
    
    const authInstance = this.getAuth();

    // 1. Crear usuario en Auth
    const user = await authInstance.createUser({
      email,
      password,
      displayName: name,
      emailVerified: true,
    }).catch(error => {
      if (error.code === 'auth/email-already-exists') {
        throw new ConflictException('La direcci贸n de correo ya est谩 en uso.');
      }
      console.error('[AUTH_CREATE_ERROR]', error.message);
      throw new InternalServerErrorException('Error al crear usuario en Firebase Auth.');
    });

    const employeeUid = user.uid;

    // 2. Asignar Custom Claims (Rol)
    try {
      await authInstance.setCustomUserClaims(employeeUid, { role });
    } catch (error) {
      console.error(`[CLAIMS_ERROR] Failed to set claims.`, error);
      await authInstance.deleteUser(employeeUid); // Rollback
      throw new InternalServerErrorException('Error al asignar rol. Creaci贸n abortada.');
    }
    
    // 3. Crear Perfil en Firestore con los NUEVOS CAMPOS
    const employeeProfile: IEmployee = {
      uid: employeeUid,
      email: email,
      name: name,
      role: role,
      isAvailable: true,
      maxHoursPerMonth: 176,        // Valor est谩ndar
      contractType: 'FullTime',     // Valor est谩ndar
      //  Mapeo de campos extendidos
      clientId: profileData.clientId,
      dni: profileData.dni,
      fileNumber: profileData.fileNumber,
      address: profileData.address
    };

    const dbInstance = this.getDb();
    
    try {
      await dbInstance.collection(EMPLOYEES_COLLECTION).doc(employeeUid).set(employeeProfile);
    } catch (error) {
      console.error(`[FIRESTORE_ERROR] Failed to create profile.`, error);
      await authInstance.deleteUser(employeeUid); // Rollback
      throw new InternalServerErrorException('Error al guardar perfil. Creaci贸n abortada.');
    }

    return employeeProfile;
  }
}

================================================================================
FILE: apps\functions\src\auth\guards\roles.guard.ts
================================================================================
// apps/functions/src/auth/guards/roles.guard.ts
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { IEmployee } from '../../common/interfaces/employee.interface'; //  RUTA FINAL: Retrocede 2 niveles
import 'reflect-metadata'; 

// ... (resto del c贸digo permanece igual)

// 1. Decorador para definir los roles requeridos
export const ROLES_KEY = 'roles';
export const Roles = (...roles: IEmployee['role'][]) => 
  (target: any, key?: any, descriptor?: any) => {
    // Uso corregido de Reflect (Soluci贸n TS2339)
    Reflect.defineMetadata(ROLES_KEY, roles, descriptor.value || target);
  };


@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const requiredRoles = this.reflector.get<IEmployee['role'][]>(
      ROLES_KEY,
      context.getHandler(),
    );

    if (!requiredRoles) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const userRole = request.context?.auth?.token?.role;

    if (!userRole) {
        return false;
    }

    return requiredRoles.some((role) => role === userRole);
  }
}

================================================================================
FILE: apps\functions\src\common\interfaces\absence.interface.ts
================================================================================
import * as admin from 'firebase-admin';

export type AbsenceType = 'VACATION' | 'SICK_LEAVE' | 'OTHER';

export interface IAbsence {
  id: string;
  employeeId: string;
  employeeName: string; //  Campo necesario para la UI
  clientId: string;
  type: AbsenceType;
  startDate: admin.firestore.Timestamp;
  endDate: admin.firestore.Timestamp;
  reason: string;
  status: 'PENDING' | 'APPROVED' | 'REJECTED';
  createdAt: admin.firestore.Timestamp;
}

//  ESTA EXPORTACIN ES CRTICA PARA EL SERVICIO
export interface IAbsencePayload {
  employeeId: string;
  employeeName: string;
  clientId: string;
  type: AbsenceType;
  // Flexible para aceptar Dates del frontend o Timestamps internos
  startDate: admin.firestore.Timestamp | Date;
  endDate: admin.firestore.Timestamp | Date;
  reason: string;
}

================================================================================
FILE: apps\functions\src\common\interfaces\api.interface.ts
================================================================================
// api.interface.ts (Ejemplo de respuesta estandarizada de API Gateway/Backend)
export interface IApiResponse<T> {
  success: boolean;
  data: T;
  message?: string;
}

// employee.interface.ts (Aseguramos la interfaz de IEmployee)
export interface IEmployee {
  uid: string;
  name: string;
  role: string;
  // A帽adir cualquier otro campo relevante (ej: maxHoursPerMonth, email)
}

================================================================================
FILE: apps\functions\src\common\interfaces\client.interface.ts
================================================================================
import * as admin from 'firebase-admin';

/**
 * @interface IClient
 * @description La empresa o entidad que contrata nuestros servicios de seguridad/personal.
 * Es la entidad ra铆z de la jerarqu铆a comercial.
 */
export interface IClient {
  id: string;
  /** Raz贸n Social o Nombre Comercial */
  businessName: string; 
  /** Identificaci贸n Fiscal (CUIT/RUT/NIT) */
  cuit: string;         
  /** Nombre del contacto principal */
  contactName: string;
  /** Email del contacto para notificaciones autom谩ticas */
  contactEmail: string;
  /** Estado administrativo del cliente */
  status: 'Active' | 'Inactive' | 'Suspended';
  /** Fecha de alta en el sistema */
  createdAt: admin.firestore.Timestamp;
}

/**
 * @interface IObjective
 * @description El lugar f铆sico, sucursal o puesto donde se presta el servicio.
 * Pertenece a un Cliente.
 */
export interface IObjective {
  id: string;
  /** ID del Cliente al que pertenece (Foreign Key) */
  clientId: string; 
  /** Nombre del objetivo (Ej: "Planta Industrial Pilar") */
  name: string;     
  /** Direcci贸n f铆sica real */
  address: string;
  /** Coordenadas para el Geofencing (Check-in/out) */
  location: {
    latitude: number;
    longitude: number;
  };
  /** Zonas internas (opcional). Ej: ["Garita 1", "Recepci贸n", "Ronda"] */
  zones?: string[]; 
}

/**
 * @interface IServiceContract
 * @description Define el acuerdo de nivel de servicio (SLA) para un Objetivo.
 * Establece cu谩ntas horas se vendieron y en qu茅 per铆odo.
 */
export interface IServiceContract {
  id: string;
  /** ID del Objetivo asociado (Foreign Key) */
  objectiveId: string; 
  /** Nombre del servicio (Ej: "Seguridad 24x7 - 2025") */
  name: string;        
  startDate: admin.firestore.Timestamp;
  endDate?: admin.firestore.Timestamp; // Opcional si es indeterminado
  /** Objetivo de venta mensual en horas (para reportes de rentabilidad) */
  totalHoursPerMonth: number; 
  isActive: boolean;
}

/**
 * @interface IShiftType (Modalidad)
 * @description Plantilla de turno para agilizar la planificaci贸n.
 * Define los "moldes" que se arrastrar谩n al calendario.
 */
export interface IShiftType {
  id: string;
  /** ID del Contrato al que pertenece esta modalidad (Foreign Key) */
  contractId: string; 
  /** Nombre descriptivo (Ej: "Turno Tarde 8hs") */
  name: string;       
  /** C贸digo corto para visualizaci贸n en calendario (Ej: "T8") */
  code: string;       
  /** Color hexadecimal para diferenciar en el calendario (Ej: "#FF5733") */
  color: string;      
  
  // Configuraci贸n del Horario Base
  /** Hora de inicio sugerida en formato "HH:mm" (Ej: "14:00") */
  startTime: string;     
  /** Duraci贸n en horas para c谩lculo de costos (Ej: 8) */
  durationHours: number; 
  
  /** Requisitos espec铆ficos (Opcional). Ej: "Vigilador Armado", "Chofer" */
  requiredRole?: string; 
}

================================================================================
FILE: apps\functions\src\common\interfaces\employee.interface.ts
================================================================================
//  CORRECCIN: Usar 'firebase-admin/firestore' en el backend
import { Timestamp } from 'firebase-admin/firestore'; 

export type EmployeeRole = 'admin' | 'employee';
export type ContractType = 'FullTime' | 'PartTime' | 'Eventual';

export interface IEmployee {
  uid: string;
  name: string;
  role: EmployeeRole;
  email: string;
  isAvailable: boolean;
  maxHoursPerMonth: number;
  contractType: ContractType;
    
    //  AGREGAMOS ESTOS CAMPOS PARA QUE DESAPAREZCAN LOS ERRORES ROJOS
    clientId: string;   
    dni: string;        
    fileNumber: string; 
    address: string;    
    phone?: string;     
}

// Interfaces auxiliares (D茅jalas si ya las tienes, o agr茅galas si faltan)
export interface IAbsence {
    id: string;
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    startDate: Timestamp; 
    endDate: Timestamp;
    reason: string;
    status: 'PENDING' | 'APPROVED' | 'REJECTED';
    createdAt: Timestamp;
}

export interface IAbsencePayload {
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    startDate: Date; 
    endDate: Date;
    reason: string;
}

================================================================================
FILE: apps\functions\src\common\interfaces\shift.interface.ts
================================================================================
// apps/functions/src/common/interfaces/shift.interface.ts
import * as admin from 'firebase-admin'; //  CAMBIO CLAVE: Importar el m贸dulo core de admin

export interface IShift {
  id: string;
  employeeId: string;
  employeeName: string;
  objectiveId: string;
  objectiveName: string;
  //  Referenciar el Timestamp a trav茅s del namespace de admin.
  startTime: admin.firestore.Timestamp; 
  endTime: admin.firestore.Timestamp;
  status: 'Assigned' | 'Confirmed' | 'InProgress' | 'Completed' | 'Canceled';
  checkInTime?: admin.firestore.Timestamp;
  checkOutTime?: admin.firestore.Timestamp;
  schedulerId: string;
  updatedAt: admin.firestore.Timestamp;
}

================================================================================
FILE: apps\functions\src\common\interfaces\system-user.interface.ts
================================================================================
import * as admin from 'firebase-admin';

/**
 * Roles espec铆ficos para el Back-Office.
 */
export type SystemRole = 'SuperAdmin' | 'Scheduler' | 'HR_Manager' | 'Viewer';

/**
 * @interface ISystemUser
 * @description Usuario administrativo con acceso al Panel de Control.
 * Se almacena en la colecci贸n 'system_users'.
 */
export interface ISystemUser {
  uid: string;
  email: string;
  displayName: string;
  role: SystemRole;
  
  /** Estado del acceso */
  status: 'Active' | 'Inactive';
  
  /** Fecha de creaci贸n */
  createdAt: admin.firestore.Timestamp;
  
  /** ltimo acceso (Opcional, para auditor铆a futura) */
  lastLogin?: admin.firestore.Timestamp;
}

================================================================================
FILE: apps\functions\src\data-management\absence.interface.ts
================================================================================
import * as admin from 'firebase-admin';

/**
 * Estructura de la entidad Ausencia almacenada en Firestore.
 */
export interface IAbsence {
    id: string; 
    employeeId: string;
    employeeName: string;
    clientId: string; 
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER'; 
    startDate: admin.firestore.Timestamp; 
    endDate: admin.firestore.Timestamp; 
    reason: string; 
    status: 'PENDING' | 'APPROVED' | 'REJECTED'; 
    createdAt: admin.firestore.Timestamp;
}

/**
 * Payload recibido del Frontend.
 *  ES CRTICO QUE ESTA INTERFAZ TENGA 'export' PARA QUE EL SERVICIO LA VEA.
 */
export interface IAbsencePayload {
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    // Flexible: Timestamp (si viene de otro servicio) o Date (si viene de JSON serializado)
    startDate: admin.firestore.Timestamp | Date; 
    endDate: admin.firestore.Timestamp | Date;
    reason: string;
}

================================================================================
FILE: apps\functions\src\data-management\absence.service.ts
================================================================================
import { Injectable, ConflictException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { WorkloadService } from '../scheduling/workload.service';
import { IAbsence, IAbsencePayload } from '../common/interfaces/absence.interface';

@Injectable()
export class AbsenceService {
    // Inicializaci贸n diferida
    private getDb = () => admin.app().firestore();
    private readonly absencesCollection = 'ausencias'; 
    
    constructor(private readonly workloadService: WorkloadService) {}

    async createAbsence(payload: IAbsencePayload): Promise<IAbsence> {
        // 1. Convertimos fechas
        const startDateObj = (payload.startDate as any).toDate ? (payload.startDate as any).toDate() : new Date(payload.startDate as any);
        const endDateObj = (payload.endDate as any).toDate ? (payload.endDate as any).toDate() : new Date(payload.endDate as any);

        // 2. Validar solapamiento
        const conflictingShifts = await this.workloadService.checkShiftOverlap(
            payload.employeeId,
            startDateObj, 
            endDateObj    
        );

        if (conflictingShifts.length > 0) {
            console.warn(`[AbsenceService] Conflict found for employee ${payload.employeeId}`);
            throw new ConflictException(`Conflicto: El empleado tiene ${conflictingShifts.length} turnos asignados durante este per铆odo.`);
        }

        // 3. Crear el objeto a persistir
        const startTimestamp = admin.firestore.Timestamp.fromDate(startDateObj);
        const endTimestamp = admin.firestore.Timestamp.fromDate(endDateObj);

        const newAbsence: any = { 
            employeeId: payload.employeeId,
            employeeName: payload.employeeName,
            clientId: payload.clientId,
            type: payload.type,
            startDate: startTimestamp,
            endDate: endTimestamp,     
            reason: payload.reason,
            status: 'APPROVED', 
            createdAt: admin.firestore.Timestamp.now(), 
        };

        const docRef = await this.getDb().collection(this.absencesCollection).add(newAbsence);
        
        return { id: docRef.id, ...newAbsence } as IAbsence;
    }
}

================================================================================
FILE: apps\functions\src\data-management\client.service.ts
================================================================================
import { Injectable, NotFoundException, InternalServerErrorException } from '@nestjs/common';
import * as admin from 'firebase-admin';
// Rutas relativas correctas para evitar errores de compilaci贸n TS2307
import { 
  IClient, 
  IObjective, 
  IServiceContract, 
  IShiftType 
} from '../common/interfaces/client.interface'; 

const COLL_CLIENTS = 'clientes';
const COLL_OBJECTIVES = 'objetivos';
const COLL_CONTRACTS = 'contratos_servicio';
const COLL_SHIFT_TYPES = 'tipos_turno';

@Injectable()
export class ClientService {

  //  Inicializaci贸n diferida (Lazy Loading) para evitar error 'app/no-app'
  private getDb = () => admin.app().firestore();

  // ==========================================
  // 1. GESTIN DE CLIENTES (EMPRESAS)
  // ==========================================

  async createClient(data: Omit<IClient, 'id' | 'createdAt'>): Promise<IClient> {
    const db = this.getDb();
    const ref = db.collection(COLL_CLIENTS).doc();
    
    const newClient: IClient = {
      ...data,
      id: ref.id,
      createdAt: admin.firestore.Timestamp.now(),
    };

    await ref.set(newClient);
    return newClient;
  }

  async getClient(id: string): Promise<IClient> {
    const doc = await this.getDb().collection(COLL_CLIENTS).doc(id).get();
    if (!doc.exists) throw new NotFoundException('Cliente no encontrado');
    return { id: doc.id, ...doc.data() } as IClient;
  }

  async findAllClients(): Promise<IClient[]> {
    try {
      // Nota: Si quieres ver incluso los eliminados/inactivos, quita el .where
      const snapshot = await this.getDb().collection(COLL_CLIENTS)
        // .where('status', '==', 'Active') // Descomentar para filtrar solo activos
        .get();

      if (snapshot.empty) return [];

      return snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
      } as IClient));

    } catch (error) {
      console.error('[ERROR_FIND_CLIENTS]', error);
      throw new InternalServerErrorException('Error al consultar clientes.');
    }
  }

  //  NUEVO: Actualizar Cliente
  async updateClient(id: string, data: Partial<IClient>): Promise<void> {
    const ref = this.getDb().collection(COLL_CLIENTS).doc(id);
    
    // Protecci贸n: No permitir modificar ID ni fecha de creaci贸n
    const updateData = { ...data };
    delete (updateData as any).id;
    delete (updateData as any).createdAt;

    await ref.update(updateData);
  }

  //  NUEVO: Eliminar Cliente
  async deleteClient(id: string): Promise<void> {
    await this.getDb().collection(COLL_CLIENTS).doc(id).delete();
  }

  // ==========================================
  // 2. GESTIN DE OBJETIVOS (SEDES)
  // ==========================================

  async createObjective(data: Omit<IObjective, 'id'>): Promise<IObjective> {
    await this.getClient(data.clientId); // Validar existencia

    const db = this.getDb();
    const ref = db.collection(COLL_OBJECTIVES).doc();

    const newObjective: IObjective = {
      ...data,
      id: ref.id,
    };

    await ref.set(newObjective);
    return newObjective;
  }

  async getObjectivesByClient(clientId: string): Promise<IObjective[]> {
    const snapshot = await this.getDb().collection(COLL_OBJECTIVES)
      .where('clientId', '==', clientId)
      .get();
    return snapshot.docs.map(d => ({ id: d.id, ...d.data() }) as IObjective);
  }

  public async getClientById(clientId: string): Promise<IClient> {
      return this.getClient(clientId);
  }
  
  public async getObjectiveById(objectiveId: string): Promise<IObjective> {
      const doc = await this.getDb().collection(COLL_OBJECTIVES).doc(objectiveId).get();
      if (!doc.exists) {
          throw new NotFoundException(`Objective with ID ${objectiveId} not found.`);
      }
      return { id: doc.id, ...doc.data() } as IObjective;
  }

  // ==========================================
  // 3. GESTIN DE CONTRATOS
  // ==========================================

  async createServiceContract(data: Omit<IServiceContract, 'id'>): Promise<IServiceContract> {
    const db = this.getDb();
    const ref = db.collection(COLL_CONTRACTS).doc();
    
    let startDate: admin.firestore.Timestamp;
    
    // Manejo robusto de fechas entrantes (JSON o Date)
    if (data.startDate instanceof admin.firestore.Timestamp) {
        startDate = data.startDate;
    } else if ((data.startDate as any)._seconds) {
        startDate = new admin.firestore.Timestamp((data.startDate as any)._seconds, (data.startDate as any)._nanoseconds);
    } else {
        startDate = admin.firestore.Timestamp.fromDate(new Date(data.startDate as any));
    }

    const newContract: IServiceContract = {
      ...data,
      id: ref.id,
      startDate: startDate,
    };

    await ref.set(newContract);
    return newContract;
  }

  // ==========================================
  // 4. GESTIN DE MODALIDADES
  // ==========================================

  async createShiftType(data: Omit<IShiftType, 'id'>): Promise<IShiftType> {
    const db = this.getDb();
    const ref = db.collection(COLL_SHIFT_TYPES).doc();

    const newType: IShiftType = {
      ...data,
      id: ref.id,
    };

    await ref.set(newType);
    return newType;
  }

  async getShiftTypesByContract(contractId: string): Promise<IShiftType[]> {
    const snapshot = await this.getDb().collection(COLL_SHIFT_TYPES)
      .where('contractId', '==', contractId)
      .get();
    return snapshot.docs.map(d => ({ id: d.id, ...d.data() }) as IShiftType);
  }
}

================================================================================
FILE: apps\functions\src\data-management\data-management.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { DataManagementService } from './data-management.service';
import { ClientService } from './client.service';
import { EmployeeService } from './employee.service';
import { SystemUserService } from './system-user.service';
//  CORRECCIN: Importamos el servicio de ausencias
import { AbsenceService } from './absence.service';
//  CORRECCIN: Importamos SchedulingModule para acceder a WorkloadService
import { SchedulingModule } from '../scheduling/scheduling.module';

@Module({
  imports: [
    SchedulingModule 
  ],
  providers: [
    DataManagementService,
    ClientService,
    EmployeeService,
    SystemUserService,
    AbsenceService //  Registrado
  ],
  exports: [
    DataManagementService,
    ClientService,
    EmployeeService,
    SystemUserService,
    AbsenceService //  Exportado
  ],
})
export class DataManagementModule {}

================================================================================
FILE: apps\functions\src\data-management\data-management.service.ts
================================================================================
import { Injectable, NotFoundException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IClient, IObjective } from '../common/interfaces/client.interface'; // RUTA RELATIVA FINAL
import { IShift } from '../common/interfaces/shift.interface'; // RUTA RELATIVA FINAL (Aunque IShift no se usa directamente aqu铆, la mantenemos si es necesario)

const CLIENTS_COLLECTION = 'clientes';
const OBJECTIVES_COLLECTION = 'objetivos';
//  ELIMINADO: const db = admin.firestore(); // Eliminado para resolver el error 'app/no-app'

/**
 * @class DataManagementService
 * @description Servicio CRUD para las entidades Cliente y Objetivo (P1). 
 */
@Injectable()
export class DataManagementService {
  
  //  FIX: Getter para asegurar que Firestore solo se accede despu茅s de initializeApp()
  private getDb = () => admin.app().firestore();

  // --- CRUD para Objetivos (Sucursales/Puestos) ---

  async createObjective(objectiveData: Omit<IObjective, 'id'>): Promise<IObjective> {
    const dbInstance = this.getDb();
    const newRef = dbInstance.collection(OBJECTIVES_COLLECTION).doc();
    const objective: IObjective = {
      ...objectiveData,
      id: newRef.id,
    };
    await newRef.set(objective);
    return objective;
  }

  async findAllObjectives(clientId?: string): Promise<IObjective[]> {
    const dbInstance = this.getDb();
    let query: admin.firestore.Query = dbInstance.collection(OBJECTIVES_COLLECTION);
    
    if (clientId) {
      query = query.where('clientId', '==', clientId);
    }

    const snapshot = await query.get();
    if (snapshot.empty) {
        return [];
    }

    return snapshot.docs.map(doc => doc.data() as IObjective);
  }
  
  // --- M茅todos de Lectura (Cr铆ticos para el Check-In) ---
  
  public async getClientById(clientId: string): Promise<IClient> {
      const dbInstance = this.getDb();
      const doc = await dbInstance.collection(CLIENTS_COLLECTION).doc(clientId).get();
      if (!doc.exists) {
          throw new NotFoundException(`Client with ID ${clientId} not found.`);
      }
      return doc.data() as IClient;
  }
  
  public async getObjectiveById(objectiveId: string): Promise<IObjective> {
      const dbInstance = this.getDb();
      const doc = await dbInstance.collection(OBJECTIVES_COLLECTION).doc(objectiveId).get();
      if (!doc.exists) {
          throw new NotFoundException(`Objective with ID ${objectiveId} not found.`);
      }
      return doc.data() as IObjective;
  }
}

================================================================================
FILE: apps\functions\src\data-management\employee.service.ts
================================================================================
import { Injectable, NotFoundException, InternalServerErrorException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IEmployee } from '../common/interfaces/employee.interface';

const COLL_EMPLOYEES = 'empleados';

@Injectable()
export class EmployeeService {

  // Inicializaci贸n diferida para evitar errores de 'app/no-app'
  private getDb = () => admin.app().firestore();
  private getAuth = () => admin.app().auth();

  /**
   * Obtiene todos los empleados. Si se provee clientId, filtra por esa empresa.
   */
  async findAllEmployees(clientId?: string): Promise<IEmployee[]> {
    try {
      let query: admin.firestore.Query = this.getDb().collection(COLL_EMPLOYEES);

      //  CORRECCIN: Filtrado din谩mico por Cliente
      if (clientId) {
        query = query.where('clientId', '==', clientId);
      }

      const snapshot = await query.get();
      return snapshot.docs.map(doc => doc.data() as IEmployee);
    } catch (error) {
      console.error('[GET_EMPLOYEES_ERROR]', error);
      throw new InternalServerErrorException('Error al obtener la lista de empleados.');
    }
  }

  /**
   * Actualiza los datos de un empleado (Ej: cambiar l铆mite de horas o rol).
   */
  async updateEmployee(uid: string, data: Partial<IEmployee>): Promise<void> {
    const db = this.getDb();
    const auth = this.getAuth();

    // 1. Actualizar en Firestore
    const ref = db.collection(COLL_EMPLOYEES).doc(uid);
    const doc = await ref.get();

    if (!doc.exists) {
        throw new NotFoundException('Empleado no encontrado.');
    }

    // Protegemos campos inmutables
    delete (data as any).uid;
    delete (data as any).email;

    await ref.update(data);

    // 2. Si cambi贸 el rol, actualizar Custom Claims en Auth
    if (data.role) {
        try {
            await auth.setCustomUserClaims(uid, { role: data.role });
        } catch (e) {
            console.error(`Error actualizando claims para ${uid}`, e);
            // No fallamos todo el proceso, pero logueamos el error
        }
    }
  }

  /**
   * Elimina un empleado (Firestore + Auth).
   */
  async deleteEmployee(uid: string): Promise<void> {
    try {
        // 1. Borrar de Auth (Impide nuevo login)
        await this.getAuth().deleteUser(uid);
        
        // 2. Borrar de Firestore
        await this.getDb().collection(COLL_EMPLOYEES).doc(uid).delete();
    } catch (error) {
        console.error('[DELETE_EMPLOYEE_ERROR]', error);
        throw new InternalServerErrorException('Error al eliminar el empleado.');
    }
  }
}

================================================================================
FILE: apps\functions\src\data-management\system-user.service.ts
================================================================================
import { Injectable, InternalServerErrorException, ConflictException, NotFoundException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { ISystemUser, SystemRole } from '../common/interfaces/system-user.interface';

const COLL_SYSTEM_USERS = 'system_users';

@Injectable()
export class SystemUserService {

  // Inicializaci贸n diferida
  private getAuth = () => admin.app().auth();
  private getDb = () => admin.app().firestore();

  /**
   * Crea un nuevo usuario administrativo.
   */
  async createSystemUser(data: { email: string, password: string, displayName: string, role: SystemRole }): Promise<ISystemUser> {
    const auth = this.getAuth();
    const db = this.getDb();

    // 1. Crear en Auth
    const userRecord = await auth.createUser({
      email: data.email,
      password: data.password,
      displayName: data.displayName,
      emailVerified: true,
    }).catch(error => {
      if (error.code === 'auth/email-already-exists') throw new ConflictException('El email ya est谩 registrado.');
      throw new InternalServerErrorException('Error al crear usuario en Auth.');
    });

    // 2. Asignar Claims (Rol)
    // Nota: Agregamos un claim 'type: admin' para diferenciarlo de empleados
    await auth.setCustomUserClaims(userRecord.uid, { role: data.role, type: 'system_user' });

    // 3. Crear Perfil en Firestore
    const newUser: ISystemUser = {
      uid: userRecord.uid,
      email: data.email,
      displayName: data.displayName,
      role: data.role,
      status: 'Active',
      createdAt: admin.firestore.Timestamp.now()
    };

    await db.collection(COLL_SYSTEM_USERS).doc(userRecord.uid).set(newUser);
    
    return newUser;
  }

  /**
   * Obtener todos los administradores.
   */
  async findAll(): Promise<ISystemUser[]> {
    const snapshot = await this.getDb().collection(COLL_SYSTEM_USERS).get();
    return snapshot.docs.map(doc => doc.data() as ISystemUser);
  }

  /**
   * Actualizar datos (Rol o Estado).
   */
  async updateSystemUser(uid: string, data: Partial<ISystemUser>): Promise<void> {
    const auth = this.getAuth();
    const db = this.getDb();

    // Si cambia el rol, actualizar Auth
    if (data.role) {
        await auth.setCustomUserClaims(uid, { role: data.role, type: 'system_user' });
    }

    // Si se desactiva, deshabilitar en Auth
    if (data.status) {
        await auth.updateUser(uid, { disabled: data.status === 'Inactive' });
    }

    // Actualizar Firestore
    const safeData = { ...data };
    delete (safeData as any).uid;
    delete (safeData as any).email; // No cambiamos email por aqu铆
    
    await db.collection(COLL_SYSTEM_USERS).doc(uid).update(safeData);
  }

  /**
   * Eliminar administrador.
   */
  async deleteSystemUser(uid: string): Promise<void> {
    await this.getAuth().deleteUser(uid);
    await this.getDb().collection(COLL_SYSTEM_USERS).doc(uid).delete();
  }
}

================================================================================
FILE: apps\functions\src\index.ts
================================================================================
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import { createNestApp } from './main';
import { INestApplicationContext } from '@nestjs/common';

// Servicios
import { SchedulingService } from './scheduling/scheduling.service';
import { AuthService } from './auth/auth.service';
import { DataManagementService } from './data-management/data-management.service';
import { AuditService } from './scheduling/audit.service';
import { ClientService } from './data-management/client.service';
import { EmployeeService } from './data-management/employee.service';
import { SystemUserService } from './data-management/system-user.service';
import { AbsenceService } from './data-management/absence.service';

// Interfaces
import { EmployeeRole } from './common/interfaces/employee.interface';

// Inicializaci贸n
admin.initializeApp();

let nestApp: INestApplicationContext;

async function getService<T>(service: new (...args: any[]) => T): Promise<T> {
  if (!nestApp) {
    nestApp = await createNestApp();
  }
  return nestApp.get<T>(service); 
}

// Roles Administrativos
const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager'];
const ALLOWED_ROLES: EmployeeRole[] = ['admin', 'employee']; 

// =========================================================
// 1. GESTIN DE USUARIOS (AUTH) -->  ACTUALIZADO
// =========================================================
export const createUser = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado. Rol insuficiente.');
  }

  try {
    const authService = await getService(AuthService);
    //  CAMBIO CRTICO: Recibimos los nuevos campos del frontend
    const { email, password, name, role: receivedRole, clientId, dni, fileNumber, address } = data;
    
    if (!ALLOWED_ROLES.includes(receivedRole as EmployeeRole)) {
       throw new functions.https.HttpsError('invalid-argument', 'Rol inv谩lido.');
    }
    
    // Validaci贸n b谩sica: El clientId es obligatorio para multi-tenancy
    if (!clientId) {
        throw new functions.https.HttpsError('invalid-argument', 'El ID de la empresa (clientId) es obligatorio.');
    }

    const validRole = receivedRole as EmployeeRole;
    
    //  CAMBIO CRTICO: Pasamos el objeto extra con dni, address, etc.
    const newEmployee = await authService.createEmployeeProfile(
        email, 
        password, 
        validRole, 
        name,
        { clientId, dni, fileNumber, address }
    );
    
    return { success: true, uid: newEmployee.uid };
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[CREATE_USER_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', 'Error al crear usuario.');
  }
});

// =========================================================
// 2. MOTOR DE AGENDAMIENTO
// =========================================================
export const scheduleShift = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado. Rol insuficiente.');
  }

  try {
    const schedulingService = await getService(SchedulingService);
    const result = await schedulingService.assignShift(data, callerAuth.token);
    return { success: true, shiftId: result.id };
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[SCHEDULE_SHIFT_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', `Error: ${err.message}`);
  }
});

// =========================================================
// 3. AUDITORA (GEOFENCING)
// =========================================================
export const auditShift = functions.https.onCall(async (data, context) => {
  if (!context.auth) throw new functions.https.HttpsError('unauthenticated', 'Requiere autenticaci贸n.');

  try {
    const auditService = await getService(AuditService);
    const result = await auditService.auditShiftAction(data.shiftId, data.action, data.coords, context.auth.uid);
    return { success: true, newStatus: result.status };
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[AUDIT_SHIFT_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 4. GESTIN DE DATOS BSICOS
// =========================================================
export const manageData = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }

  const { action, payload } = data;
  try {
    const dmService = await getService(DataManagementService);
    switch (action) {
      case 'CREATE_OBJECTIVE': return { success: true, data: await dmService.createObjective(payload) };
      case 'GET_ALL_OBJECTIVES': return { success: true, data: await dmService.findAllObjectives(payload?.clientId) };
      case 'GET_CLIENT_BY_ID': return { success: true, data: await dmService.getClientById(payload.clientId) };
      default: throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    if (error instanceof functions.https.HttpsError) throw error;
    console.error('[DATA_MANAGEMENT_FATAL]', err.message);
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 5. GESTIN DE JERARQUA COMERCIAL
// =========================================================
export const manageHierarchy = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }
  
  const { action, payload } = data as { action: string, payload: any };

  try {
    const clientService = await getService(ClientService);

    switch (action) {
      case 'CREATE_CLIENT': return { success: true, data: await clientService.createClient(payload) };
      case 'GET_CLIENT': return { success: true, data: await clientService.getClient(payload.id) };
      case 'GET_ALL_CLIENTS': return { success: true, data: await clientService.findAllClients() };
      case 'UPDATE_CLIENT': await clientService.updateClient(payload.id, payload.data); return { success: true, message: 'Cliente actualizado' };
      case 'DELETE_CLIENT': await clientService.deleteClient(payload.id); return { success: true, message: 'Cliente eliminado' };
      case 'CREATE_OBJECTIVE': return { success: true, data: await clientService.createObjective(payload) };
      case 'CREATE_CONTRACT': return { success: true, data: await clientService.createServiceContract(payload) };
      case 'CREATE_SHIFT_TYPE': return { success: true, data: await clientService.createShiftType(payload) };
      case 'GET_SHIFT_TYPES': return { success: true, data: await clientService.getShiftTypesByContract(payload.contractId) };
      default: throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[HIERARCHY_ERROR] Action ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    throw new functions.https.HttpsError('internal', `Error: ${err.message}`);
  }
});

// =========================================================
// 6. GESTIN DE EMPLEADOS (RRHH)
// =========================================================
export const manageEmployees = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }
  
  const { action, payload } = data as { action: string, payload: any };
  try {
    const employeeService = await getService(EmployeeService);
    switch (action) {
      case 'GET_ALL_EMPLOYEES':
        const employees = await employeeService.findAllEmployees(payload?.clientId);
        return { success: true, data: employees };
      case 'UPDATE_EMPLOYEE':
        await employeeService.updateEmployee(payload.uid, payload.data);
        return { success: true, message: 'Datos actualizados.' };
      case 'DELETE_EMPLOYEE':
        await employeeService.deleteEmployee(payload.uid);
        return { success: true, message: 'Empleado eliminado.' };
      default: throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[EMPLOYEE_ERROR] Action ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 7. GESTIN DE USUARIOS DEL SISTEMA (ADMINS)
// =========================================================
export const manageSystemUsers = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }
  
  const { action, payload } = data as { action: string, payload: any };

  try {
    const sysUserService = await getService(SystemUserService);

    switch (action) {
      case 'CREATE_USER':
         await sysUserService.createSystemUser(payload);
        return { success: true, message: 'Administrador creado exitosamente.' };
      case 'GET_ALL_USERS':
        const users = await sysUserService.findAll();
        return { success: true, data: users };
      case 'UPDATE_USER':
        await sysUserService.updateSystemUser(payload.uid, payload.data);
        return { success: true, message: 'Administrador actualizado.' };
      case 'DELETE_USER':
        await sysUserService.deleteSystemUser(payload.uid);
        return { success: true, message: 'Administrador eliminado.' };
      default:
        throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[SYS_USER_ERROR] ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 8. GESTIN DE NOVEDADES (AUSENCIAS)
// =========================================================
export const manageAbsences = functions.https.onCall(async (data, context) => {
  const callerAuth = context.auth;
  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {
    throw new functions.https.HttpsError('permission-denied', 'Acceso denegado.');
  }

  const { action, payload } = data as { action: string, payload: any };

  try {
    const absenceService = await getService(AbsenceService);

    switch (action) {
      case 'CREATE_ABSENCE':
        return { success: true, data: await absenceService.createAbsence(payload) };
      default:
        throw new functions.https.HttpsError('invalid-argument', `Acci贸n desconocida: ${action}`);
    }
  } catch (error: any) {
    const err = error as Error;
    console.error(`[ABSENCE_ERROR] Action ${action} failed:`, err.message);
    if (error instanceof functions.https.HttpsError) throw error;
    if (err.message.includes('Conflict')) {
        throw new functions.https.HttpsError('failed-precondition', err.message);
    }
    throw new functions.https.HttpsError('internal', err.message);
  }
});

// =========================================================
// 9. DIAGNSTICO DE SISTEMA (HEALTH CHECK)
// =========================================================
export const checkSystemHealth = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
      throw new functions.https.HttpsError('unauthenticated', 'Requiere autenticaci贸n.');
  }

  const start = Date.now();
  try {
    // Prueba de latencia con Firestore (listCollections es ligero)
    await admin.firestore().listCollections();
    const end = Date.now();

    return {
      status: 'ok',
      nodeVersion: process.version,
      database: {
        status: 'connected',
        latencyMs: end - start
      }
    };
  } catch (error: any) {
    console.error('[HEALTH_CHECK_ERROR]', error);
    return {
      status: 'error',
      nodeVersion: process.version,
      database: {
        status: 'disconnected',
        latencyMs: -1,
        error: error.message
      }
    };
  }
});

================================================================================
FILE: apps\functions\src\main.ts
================================================================================
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { INestApplicationContext } from '@nestjs/common';

/**
 * @async
 * @function createNestApp
 * @description Inicializa la aplicaci贸n NestJS y retorna el M贸dulo de Referencia.
 * @returns {Promise<INestApplicationContext>} El contexto de aplicaci贸n.
 */
export async function createNestApp(): Promise<INestApplicationContext> {
  // Usamos createApplicationContext para obtener el contexto de DI sin listener HTTP
  const app = await NestFactory.createApplicationContext(AppModule, { logger: false });
  
  await app.init();
  return app;
}

================================================================================
FILE: apps\functions\src\scheduling\audit.service.ts
================================================================================
import { Injectable, BadRequestException, ForbiddenException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { GeofencingService } from './geofencing.service';
import { DataManagementService } from '../data-management/data-management.service'; 
import { IShift } from '../common/interfaces/shift.interface'; // RUTA RELATIVA FINAL
import * as functions from 'firebase-functions';
import { IObjective } from '../common/interfaces/client.interface'; 

const SHIFTS_COLLECTION = 'turnos';
//  ELIMINADO: const db = admin.firestore(); // <--- ESTO CAUSABA EL ERROR

@Injectable()
export class AuditService {
  
  constructor(
    private readonly geofencingService: GeofencingService,
    private readonly dmService: DataManagementService,
  ) {}

  //  FIX: Getter privado para Inicializaci贸n Diferida (Lazy Init)
  private getDb = () => admin.app().firestore();

  async auditShiftAction(
    shiftId: string,
    action: 'CHECK_IN' | 'CHECK_OUT',
    employeeCoords: { latitude: number, longitude: number },
    employeeUid: string,
  ): Promise<IShift> {
    
    const dbInstance = this.getDb(); //  Usar la instancia diferida
    const shiftRef = dbInstance.collection(SHIFTS_COLLECTION).doc(shiftId);
    
    return dbInstance.runTransaction(async (transaction) => {
      const shiftDoc = await transaction.get(shiftRef);

      if (!shiftDoc.exists) {
        throw new BadRequestException('Shift not found.');
      }

      const shift = shiftDoc.data() as IShift;
      
      // Regla 1: Autorizaci贸n de Propiedad
      if (shift.employeeId !== employeeUid) {
        throw new ForbiddenException('No est谩s autorizado para modificar este turno.');
      }
      
      // Regla 2: Obtener Coordenadas del Objetivo
      const objective = await this.dmService.getObjectiveById(shift.objectiveId) as IObjective; 
      
      // Regla 3: Verificaci贸n de Geofence (P4)
      const objectiveCoords = objective.location;
      if (!this.geofencingService.isInGeofence(employeeCoords, objectiveCoords)) {
        console.warn(`Geofence failed for ${employeeUid} at shift ${shiftId}.`);
        throw new functions.https.HttpsError('failed-precondition', 'Debe estar cerca del objetivo para registrar la acci贸n.');
      }
      
      // Regla 4: L贸gica de Estado y Actualizaci贸n
      const now = admin.firestore.Timestamp.now();
      let newStatus: IShift['status'];

      if (action === 'CHECK_IN' && shift.status === 'Assigned') {
        newStatus = 'InProgress';
        shift.checkInTime = now;
      } else if (action === 'CHECK_OUT' && shift.status === 'InProgress') {
        newStatus = 'Completed';
        shift.checkOutTime = now;
      } else {
        throw new BadRequestException(`Acci贸n ${action} inv谩lida para el estado actual: ${shift.status}.`);
      }
      
      // Actualizaci贸n At贸mica
      shift.status = newStatus;
      shift.updatedAt = now;
      transaction.update(shiftRef, shift as Partial<IShift>);

      return shift;
    });
  }
}

================================================================================
FILE: apps\functions\src\scheduling\geofencing.service.ts
================================================================================
import { Injectable } from '@nestjs/common';

// Radio de la Tierra en kil贸metros (km)
const EARTH_RADIUS_KM = 6371;

// Radio de tolerancia: El empleado debe estar a menos de 100 metros del objetivo.
const GEOFENCE_RADIUS_KM = 0.1; // 100 metros

interface Coordinates {
  latitude: number;
  longitude: number;
}

/**
 * @class GeofencingService
 * @description L贸gica pura para el c谩lculo de distancia y verificaci贸n de Geofence (SRP/D5).
 */
@Injectable()
export class GeofencingService {

  /**
   * @function degreesToRadians
   * @description Convierte grados decimales a radianes.
   */
  private degreesToRadians(degrees: number): number {
    return degrees * (Math.PI / 180);
  }

  /**
   * @function calculateDistance
   * @description Calcula la distancia entre dos pares de coordenadas (F贸rmula del Haversine).
   * @returns {number} Distancia en kil贸metros.
   */
  public calculateDistance(p1: Coordinates, p2: Coordinates): number {
    const lat1 = this.degreesToRadians(p1.latitude);
    const lon1 = this.degreesToRadians(p1.longitude);
    const lat2 = this.degreesToRadians(p2.latitude);
    const lon2 = this.degreesToRadians(p2.longitude);

    const dLat = lat2 - lat1;
    const dLon = lon2 - lon1;

    // F贸rmula Haversine
    const a = 
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) * Math.sin(dLon / 2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return EARTH_RADIUS_KM * c; // Distancia en KM
  }

  /**
   * @function isInGeofence
   * @description Verifica si el punto del empleado est谩 dentro del radio del objetivo.
   * @param {Coordinates} employeeCoords - Coordenadas reportadas por el empleado.
   * @param {Coordinates} objectiveCoords - Coordenadas registradas del objetivo.
   * @returns {boolean} True si la distancia es menor al radio de tolerancia.
   */
  public isInGeofence(employeeCoords: Coordinates, objectiveCoords: Coordinates): boolean {
    const distance = this.calculateDistance(employeeCoords, objectiveCoords);
    return distance <= GEOFENCE_RADIUS_KM;
  }
}

================================================================================
FILE: apps\functions\src\scheduling\scheduling.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { SchedulingService } from './scheduling.service';
import { ShiftOverlapService } from './shift-overlap.service';
import { WorkloadService } from './workload.service';

/**
 * @module SchedulingModule
 * @description M贸dulo de NestJS para toda la l贸gica de agendamiento de turnos.
 * Agrupa los servicios de asignaci贸n, validaci贸n de solapamiento y carga de trabajo.
 */
@Module({
  imports: [],
  providers: [
    SchedulingService,      // Servicio Principal
    ShiftOverlapService,    // Validador de Solapamiento (P2)
    WorkloadService         // Validador de Carga/Ausencias (Reglas de Negocio)
  ],
  exports: [
    SchedulingService,      // Exportamos el servicio principal
    WorkloadService         //  CORRECCIN: Exportamos WorkloadService para que AbsenceService lo pueda usar
  ],
})
export class SchedulingModule {}

================================================================================
FILE: apps\functions\src\scheduling\scheduling.service.ts
================================================================================
import { Injectable, InternalServerErrorException, BadRequestException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IShift } from '../common/interfaces/shift.interface'; // RUTA RELATIVA FINAL
import { ShiftOverlapService } from './shift-overlap.service';
import { WorkloadService } from './workload.service';
import * as functions from 'firebase-functions';

const SHIFTS_COLLECTION = 'turnos';

@Injectable()
export class SchedulingService {
  
  // Inicializaci贸n diferida (Lazy Init)
  private getDb = () => admin.app().firestore();

  constructor(
    private readonly overlapService: ShiftOverlapService,
    private readonly workloadService: WorkloadService
  ) {}

  /**
   *  FIX CRTICO: Funci贸n auxiliar para sanear fechas que vienen por la red.
   * Maneja: Firestore Timestamp, Serialized Timestamp ({_seconds}), Strings e ISOs.
   */
  private convertToDate(input: any): Date {
    if (!input) throw new Error('Fecha inv谩lida o inexistente.');
    
    // Caso 1: Es un Timestamp de Firestore real (tiene .toDate)
    if (typeof input.toDate === 'function') {
        return input.toDate();
    }
    // Caso 2: Es un Timestamp serializado (viene del Frontend como JSON)
    if (input._seconds !== undefined) {
        return new Date(input._seconds * 1000);
    }
    // Caso 3: Es un objeto seconds/nanoseconds est谩ndar de Google
    if (input.seconds !== undefined) {
        return new Date(input.seconds * 1000);
    }
    // Caso 4: Es un string ISO o n煤mero
    return new Date(input);
  }

  async assignShift(shiftData: Partial<IShift>, userAuth: admin.auth.DecodedIdToken): Promise<IShift> {
    const dbInstance = this.getDb(); 
    const newShiftRef = dbInstance.collection(SHIFTS_COLLECTION).doc();
    
    // 1. Validaci贸n de campos requeridos
    if (!shiftData.startTime || !shiftData.endTime || !shiftData.employeeId || !shiftData.objectiveId) {
        throw new functions.https.HttpsError('invalid-argument', 'Faltan datos requeridos: inicio, fin, empleado u objetivo.');
    }
    
    //  USAMOS LA NUEVA FUNCIN DE CONVERSIN AQU
    let newStart: Date;
    let newEnd: Date;

    try {
        newStart = this.convertToDate(shiftData.startTime);
        newEnd = this.convertToDate(shiftData.endTime);
    } catch (e) {
        throw new functions.https.HttpsError('invalid-argument', 'Formato de fecha inv谩lido recibido del cliente.');
    }
    
    const employeeId = shiftData.employeeId!;

    // 2. Validaci贸n de coherencia temporal
    if (newStart.getTime() >= newEnd.getTime()) {
      throw new BadRequestException('La hora de inicio debe ser anterior a la hora de fin.');
    }

    // 3. VALIDACIN DE REGLAS DE NEGOCIO (WFM)
    try {
        await this.workloadService.validateAssignment(employeeId, newStart, newEnd);
    } catch (businessRuleError: any) {
        console.warn(`[BUSINESS_RULE_BLOCK] ${businessRuleError.message}`);
        throw new functions.https.HttpsError('failed-precondition', businessRuleError.message);
    }

    try {
      await dbInstance.runTransaction(async (transaction) => {
        
        // 4. Verificaci贸n de Solapamiento
        const overlappingQuery = dbInstance.collection(SHIFTS_COLLECTION)
          .where('employeeId', '==', employeeId)
          .where('endTime', '>', newStart) 
          .where('startTime', '<', newEnd) 
          .limit(1);

        const snapshot = await transaction.get(overlappingQuery);

        if (!snapshot.empty) {
          const existingShift = snapshot.docs[0].data(); // Data cruda
          // Convertimos tambi茅n las fechas de la DB por seguridad
          const existingStart = this.convertToDate(existingShift.startTime);
          const existingEnd = this.convertToDate(existingShift.endTime);

          if (this.overlapService.isOverlap(existingStart, existingEnd, newStart, newEnd)) {
             console.error(`[SCHEDULING_ABORTED] Overlap detected for Employee: ${employeeId}.`);
             throw new functions.https.HttpsError('already-exists', 'El empleado ya tiene otro turno asignado en este horario.');
          }
        }
        
        // Escritura del nuevo turno
        const finalShift: IShift = {
          id: newShiftRef.id,
          employeeId: employeeId,
          objectiveId: shiftData.objectiveId!,
          employeeName: shiftData.employeeName || 'NOMBRE_NO_PROVISTO', 
          objectiveName: shiftData.objectiveName || 'OBJETIVO_NO_PROVISTO',
          // Guardamos como Timestamp de Firestore para consistencia en la DB
          startTime: admin.firestore.Timestamp.fromDate(newStart), 
          endTime: admin.firestore.Timestamp.fromDate(newEnd),
          status: 'Assigned',
          schedulerId: userAuth.uid,
          updatedAt: admin.firestore.Timestamp.now(),
        };

        transaction.set(newShiftRef, finalShift);
        return finalShift.id; 
      });

      return { id: newShiftRef.id, ...shiftData } as IShift;

    } catch (error: any) {
        if (error instanceof functions.https.HttpsError) {
            throw error;
        }

        const errorMessage = error.message || 'Error desconocido';

        if (errorMessage.includes('LMITE') || errorMessage.includes('BLOQUEO') || errorMessage.includes('ausente')) {
             console.warn(`[BUSINESS_RULE_VIOLATION] ${errorMessage}`);
             throw new functions.https.HttpsError('failed-precondition', errorMessage);
        }
        
        console.error(`[SCHEDULING_TRANSACTION_FAILURE] ${errorMessage}`, error.stack);
        throw new functions.https.HttpsError('internal', `Error en la asignaci贸n: ${errorMessage}`);
    }
  }
}

================================================================================
FILE: apps\functions\src\scheduling\shift-overlap.service.spec.ts
================================================================================
// D5: Unit Test que verifica la REGRA DE NEGOCIO m谩s importante.
import { ShiftOverlapService } from '../../src/scheduling/shift-overlap.service';

describe('ShiftOverlapService (Core Logic D5)', () => {
  let service: ShiftOverlapService;

  beforeEach(() => {
    service = new ShiftOverlapService();
  });

  // Turno base: De 10:00 a 14:00 (4 horas)
  const T_START = new Date('2025-11-20T10:00:00.000Z');
  const T_END = new Date('2025-11-20T14:00:00.000Z');

  // CASOS DE XITO (Solapamiento)
  it('should return TRUE if the new shift starts inside and ends outside the existing shift', () => {
    // Nuevo turno: 12:00 a 16:00
    const newStart = new Date('2025-11-20T12:00:00.000Z');
    const newEnd = new Date('2025-11-20T16:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });

  it('should return TRUE if the new shift is entirely contained within the existing shift', () => {
    // Nuevo turno: 11:00 a 13:00
    const newStart = new Date('2025-11-20T11:00:00.000Z');
    const newEnd = new Date('2025-11-20T13:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });
  
  it('should return TRUE if the new shift starts before and ends inside the existing shift', () => {
    // Nuevo turno: 09:00 a 11:00
    const newStart = new Date('2025-11-20T09:00:00.000Z');
    const newEnd = new Date('2025-11-20T11:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });

  // CASOS DE FRACASO (No Solapamiento)
  it('should return FALSE if the new shift is adjacent (starts exactly when the other ends)', () => {
    // Nuevo turno: 14:00 a 18:00
    const newStart = new Date('2025-11-20T14:00:00.000Z');
    const newEnd = new Date('2025-11-20T18:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift ends exactly when the other starts', () => {
    // Nuevo turno: 06:00 a 10:00
    const newStart = new Date('2025-11-20T06:00:00.000Z');
    const newEnd = new Date('2025-11-20T10:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift is completely outside the range', () => {
    // Nuevo turno: 07:00 a 09:00
    const newStart = new Date('2025-11-20T07:00:00.000Z');
    const newEnd = new Date('2025-11-20T09:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });
});

================================================================================
FILE: apps\functions\src\scheduling\shift-overlap.service.ts
================================================================================
import { Injectable } from '@nestjs/common';

/**
 * @class ShiftOverlapService
 * @description Servicio que encapsula la l贸gica pura (matem谩tica) para determinar
 * si dos rangos de tiempo se cruzan. Cumple con SRP (SOLID).
 */
@Injectable()
export class ShiftOverlapService {

  /**
   * @function isOverlap
   * @description Verifica si un nuevo rango de tiempo se superpone con un rango existente.
   * La f贸rmula evita solapamiento si los turnos son adyacentes (ej: uno termina a las 14:00 y el otro empieza a las 14:00).
   * @param {Date} existingStart - Inicio del turno ya registrado.
   * @param {Date} existingEnd - Fin del turno ya registrado.
   * @param {Date} newStart - Inicio del nuevo turno.
   * @param {Date} newEnd - Fin del nuevo turno.
   * @returns {boolean} True si hay solapamiento.
   */
  public isOverlap(existingStart: Date, existingEnd: Date, newStart: Date, newEnd: Date): boolean {
    // Si el nuevo empieza antes de que el existente termine Y el nuevo termina despues de que el existente empiece, S hay solapamiento.
    return (
      newStart.getTime() < existingEnd.getTime() && 
      newEnd.getTime() > existingStart.getTime()
    );
  }
}

================================================================================
FILE: apps\functions\src\scheduling\workload.service.ts
================================================================================
import { Injectable, BadRequestException, ConflictException } from '@nestjs/common';
import * as admin from 'firebase-admin';
import { IEmployee } from '../common/interfaces/employee.interface';
import { IAbsence } from '../common/interfaces/absence.interface';
import { IShift } from '../common/interfaces/shift.interface';

const EMPLOYEES_COLLECTION = 'empleados';
const ABSENCES_COLLECTION = 'ausencias';
const SHIFTS_COLLECTION = 'turnos';

@Injectable()
export class WorkloadService {
  private getDb = () => admin.app().firestore();

  async validateAssignment(employeeId: string, shiftStart: Date, shiftEnd: Date): Promise<void> {
    const db = this.getDb();
    const empDoc = await db.collection(EMPLOYEES_COLLECTION).doc(employeeId).get();
    
    if (!empDoc.exists) throw new BadRequestException('Employee not found');
    const employee = empDoc.data() as IEmployee;

    // 1. Solapamiento (Llama al m茅todo nuevo)
    const conflicts = await this.checkShiftOverlap(employeeId, shiftStart, shiftEnd);
    if (conflicts.length > 0) {
        throw new ConflictException('SOLAPAMIENTO DETECTADO: El empleado ya tiene un turno asignado en este per铆odo.');
    }

    // 2. Disponibilidad
    await this.checkAvailability(employeeId, shiftStart, shiftEnd);

    // 3. L铆mite Mensual
    await this.checkMonthlyLimit(employee, shiftStart, shiftEnd);
  }

  //  MTODO QUE FALTABA EN TU CDIGO
  async checkShiftOverlap(employeeId: string, start: Date, end: Date): Promise<IShift[]> {
    const db = this.getDb();
    const shiftsQuery = db.collection(SHIFTS_COLLECTION)
        .where('employeeId', '==', employeeId)
        .where('endTime', '>', start);

    const snapshot = await shiftsQuery.get();
    const conflictingShifts: IShift[] = [];

    snapshot.forEach(doc => {
        const shift = doc.data(); 
        const sStart = (shift.startTime as admin.firestore.Timestamp).toDate();
        
        if (sStart.getTime() < end.getTime()) {
             // Doble casting para evitar error de tipos
             conflictingShifts.push({ id: doc.id, ...shift } as unknown as IShift);
        }
    });
    return conflictingShifts;
  }

  private async checkAvailability(employeeId: string, start: Date, end: Date): Promise<void> {
    const db = this.getDb();
    const absencesSnapshot = await db.collection(ABSENCES_COLLECTION)
      .where('employeeId', '==', employeeId)
      .where('endDate', '>=', start)
      .get();

    absencesSnapshot.forEach(doc => {
      const absence = doc.data() as IAbsence;
      const absStart = (absence.startDate as unknown as admin.firestore.Timestamp).toDate();
      const absEnd = (absence.endDate as unknown as admin.firestore.Timestamp).toDate();

      if (start.getTime() < absEnd.getTime() && end.getTime() > absStart.getTime()) {
        throw new ConflictException(`BLOQUEO: El empleado est谩 ausente por: ${absence.type}`);
      }
    });
  }

  private async checkMonthlyLimit(employee: IEmployee, newShiftStart: Date, newShiftEnd: Date): Promise<void> {
    const db = this.getDb();
    const newDurationHours = (newShiftEnd.getTime() - newShiftStart.getTime()) / (1000 * 60 * 60);
    const startOfMonth = new Date(newShiftStart.getFullYear(), newShiftStart.getMonth(), 1);
    const endOfMonth = new Date(newShiftStart.getFullYear(), newShiftStart.getMonth() + 1, 0, 23, 59, 59);

    const shiftsSnapshot = await db.collection(SHIFTS_COLLECTION)
      .where('employeeId', '==', employee.uid)
      .where('startTime', '>=', startOfMonth)
      .where('startTime', '<=', endOfMonth)
      .get();

    let accumulatedHours = 0;
    shiftsSnapshot.forEach(doc => {
      const shift = doc.data();
      const sStart = (shift.startTime as admin.firestore.Timestamp).toDate();
      const sEnd = (shift.endTime as admin.firestore.Timestamp).toDate();
      const duration = (sEnd.getTime() - sStart.getTime()) / (1000 * 60 * 60);
      accumulatedHours += duration;
    });

    const totalProjected = accumulatedHours + newDurationHours;
    const maxHours = employee.maxHoursPerMonth || 176;

    if (totalProjected > maxHours) {
      throw new ConflictException(`LMITE EXCEDIDO: Acumulado(${accumulatedHours.toFixed(1)}h) + Nuevo supera el m谩ximo.`);
    }
  }
}

================================================================================
FILE: apps\functions\test\scheduling\shift-overlap.service.spec.js
================================================================================
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// D5: Unit Test que verifica la REGRA DE NEGOCIO m谩s importante.
const shift_overlap_service_1 = require("../../src/scheduling/shift-overlap.service");
describe('ShiftOverlapService (Core Logic D5)', () => {
    let service;
    beforeEach(() => {
        service = new shift_overlap_service_1.ShiftOverlapService();
    });
    // Turno base (existente): De 10:00 a 14:00 (4 horas)
    const T_START = new Date('2025-11-20T10:00:00.000Z');
    const T_END = new Date('2025-11-20T14:00:00.000Z');
    // =========================================================
    // ESCENARIO 2.2: PRUEBA DE SOLAPAMIENTO (DEBE FALLAR)
    // =========================================================
    it('should return TRUE if the new shift overlaps with the existing shift (Escenario 2.2)', () => {
        // Turno B: 11:00 AM a 01:00 PM (Completamente dentro)
        const newStart = new Date('2025-11-20T11:00:00.000Z');
        const newEnd = new Date('2025-11-20T13:00:00.000Z');
        // Si esta prueba pasa (TRUE), la Transacci贸n At贸mica ABORTAR.
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
    });
    // Turno que se superpone parcialmente (Escenario 2.2a)
    it('should return TRUE if the new shift starts inside and ends outside', () => {
        // Nuevo turno: 12:00 a 16:00
        const newStart = new Date('2025-11-20T12:00:00.000Z');
        const newEnd = new Date('2025-11-20T16:00:00.000Z');
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
    });
    // =========================================================
    // ESCENARIO 2.3: PRUEBA DE ADYACENCIA (DEBE PASAR)
    // =========================================================
    it('should return FALSE if the new shift is adjacent (starts exactly when the other ends - Escenario 2.3)', () => {
        // Turno C: 14:00 PM a 18:00 PM (Empieza justo donde termina A)
        const newStart = new Date('2025-11-20T14:00:00.000Z');
        const newEnd = new Date('2025-11-20T18:00:00.000Z');
        // Si esta prueba pasa (FALSE), la Transacci贸n At贸mica CONTINUAR.
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
    });
    it('should return FALSE if the new shift ends exactly when the other starts (Adyacente inverso)', () => {
        // Nuevo turno: 06:00 a 10:00
        const newStart = new Date('2025-11-20T06:00:00.000Z');
        const newEnd = new Date('2025-11-20T10:00:00.000Z');
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
    });
    it('should return FALSE if the new shift is completely outside the range', () => {
        // Nuevo turno: 07:00 a 09:00
        const newStart = new Date('2025-11-20T07:00:00.000Z');
        const newEnd = new Date('2025-11-20T09:00:00.000Z');
        expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
    });
});
//# sourceMappingURL=shift-overlap.service.spec.js.map

================================================================================
FILE: apps\functions\test\scheduling\shift-overlap.service.spec.ts
================================================================================
// D5: Unit Test que verifica la REGRA DE NEGOCIO m谩s importante.
import { ShiftOverlapService } from '../../src/scheduling/shift-overlap.service';

describe('ShiftOverlapService (Core Logic D5)', () => {
  let service: ShiftOverlapService;

  beforeEach(() => {
    service = new ShiftOverlapService();
  });

  // Turno base (existente): De 10:00 a 14:00 (4 horas)
  const T_START = new Date('2025-11-20T10:00:00.000Z');
  const T_END = new Date('2025-11-20T14:00:00.000Z');

  // =========================================================
  // ESCENARIO 2.2: PRUEBA DE SOLAPAMIENTO (DEBE FALLAR)
  // =========================================================
  it('should return TRUE if the new shift overlaps with the existing shift (Escenario 2.2)', () => {
    // Turno B: 11:00 AM a 01:00 PM (Completamente dentro)
    const newStart = new Date('2025-11-20T11:00:00.000Z');
    const newEnd = new Date('2025-11-20T13:00:00.000Z');
    
    // Si esta prueba pasa (TRUE), la Transacci贸n At贸mica ABORTAR.
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });

  // Turno que se superpone parcialmente (Escenario 2.2a)
  it('should return TRUE if the new shift starts inside and ends outside', () => {
    // Nuevo turno: 12:00 a 16:00
    const newStart = new Date('2025-11-20T12:00:00.000Z');
    const newEnd = new Date('2025-11-20T16:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);
  });


  // =========================================================
  // ESCENARIO 2.3: PRUEBA DE ADYACENCIA (DEBE PASAR)
  // =========================================================
  it('should return FALSE if the new shift is adjacent (starts exactly when the other ends - Escenario 2.3)', () => {
    // Turno C: 14:00 PM a 18:00 PM (Empieza justo donde termina A)
    const newStart = new Date('2025-11-20T14:00:00.000Z');
    const newEnd = new Date('2025-11-20T18:00:00.000Z');
    
    // Si esta prueba pasa (FALSE), la Transacci贸n At贸mica CONTINUAR.
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift ends exactly when the other starts (Adyacente inverso)', () => {
    // Nuevo turno: 06:00 a 10:00
    const newStart = new Date('2025-11-20T06:00:00.000Z');
    const newEnd = new Date('2025-11-20T10:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });

  it('should return FALSE if the new shift is completely outside the range', () => {
    // Nuevo turno: 07:00 a 09:00
    const newStart = new Date('2025-11-20T07:00:00.000Z');
    const newEnd = new Date('2025-11-20T09:00:00.000Z');
    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);
  });
});

================================================================================
FILE: apps\functions\tsconfig.json
================================================================================
{
  "compilerOptions": {
    "module": "commonjs",
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "es2021",
    "sourceMap": true,
    "outDir": "./lib",
    "baseUrl": "./",
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": false,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "forceConsistentCasingInFileNames": false,
    "noFallthroughCasesInSwitch": false
  },
  "include": [
    "src/**/*"
  ],
  //  EXCLUIR TEST PARA EVITAR ERRORES DE COMPILACIN
  "exclude": [
    "node_modules",
    "dist",
    "lib",
    "**/*.spec.ts", 
    "test"
  ]
}

================================================================================
FILE: apps\web\jest.config.js
================================================================================
// jest.config.js en apps/web/

/** @type {import('ts-jest').JestConfigWithTsJest} */
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  moduleNameMapper: {
    //  CRTICO: Mapear el alias @/ a la carpeta src/
    '^@/(.*)$': '<rootDir>/src/$1', 
    // Mapear archivos CSS y est谩ticos para Jest
    '\\.(css|less|scss|sass)$': 'identity-obj-proxy',
  },
  setupFilesAfterEnv: ['<rootDir>/setupTests.js'], // Archivo para importar @testing-library/jest-dom
};

================================================================================
FILE: apps\web\next-env.d.ts
================================================================================
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/pages/api-reference/config/typescript for more information.


================================================================================
FILE: apps\web\next.config.ts
================================================================================
// Archivo: apps/web/next.config.ts

const path = require('path');

/** @type {import('next').NextConfig} */
const nextConfig = {
  // === 1. Configuraciones para el Subproyecto ===
  // Esto debe coincidir con las configuraciones que quieres activar
  
  // Eliminamos la clave appDir que causaba la advertencia/error.
  experimental: {
    // Si necesitas usar features experimentales, act铆valas aqu铆
  },
  
  // === 2. FIX CRTICO: Configuraci贸n de Webpack para Alias y Tipado ===
  // Usamos 'any' para forzar la aceptaci贸n del tipado, resolviendo los errores ts(7006)/ts(7031).
  // La ruta del alias '@/` es esencial para que Turbopack encuentre tus componentes.
  webpack: (config: any, context: any) => { 
    
    // FIX DE ALIAS: Resuelve todas las importaciones que empiezan con '@/...'
    // Apunta a la carpeta 'src' de la aplicaci贸n web.
    config.resolve.alias['@'] = path.resolve(__dirname, 'src');
    
    // Si tu proyecto usa symlinks para dependencias de monorepo:
    // config.resolve.symlinks = false; 
    
    return config;
  },
};

module.exports = nextConfig;

================================================================================
FILE: apps\web\package.json
================================================================================
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@fullcalendar/daygrid": "^6.1.19",
    "@fullcalendar/interaction": "^6.1.19",
    "@fullcalendar/react": "^6.1.19",
    "@fullcalendar/timegrid": "^6.1.19",
    "firebase": "^12.6.0",
    "lucide-react": "^0.556.0",
    "next": "16.0.5",
    "react": "19.2.0",
    "react-dom": "19.2.0",
    "react-hot-toast": "^2.6.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.22",
    "eslint": "^9",
    "eslint-config-next": "16.0.5",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "typescript": "^5"
  }
}


================================================================================
FILE: apps\web\pages\admin\clients\index.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import DashboardLayout from '@/components/layout/DashboardLayout'; // FIX: Importaci贸n por defecto
import { ClientManagement } from '@/components/admin/client-management';

function ClientsListPage() {
    return (
        <DashboardLayout title="Gesti贸n de Clientes y Empresas">
            <ClientManagement />
        </DashboardLayout>
    );
}

export default withAuthGuard(ClientsListPage, ['admin', 'manager']);

================================================================================
FILE: apps\web\pages\admin\clients\new.tsx
================================================================================
import React from 'react';
// Imports con alias @/
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
// Importamos el componente Wizard que creamos antes
import { ClientSetupWizard } from '@/components/admin/client-setup-wizard';

function NewClientPage() {
  return (
    <DashboardLayout title="Alta de Cliente y Servicio">
      <div className="py-6">
        {/* Renderizamos el asistente aqu铆 */}
        <ClientSetupWizard />
      </div>
    </DashboardLayout>
  );
}

// Protegemos la ruta solo para admins
export default withAuthGuard(NewClientPage as any, 'admin');

================================================================================
FILE: apps\web\pages\admin\dashboard.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { DragAndDropScheduler } from '@/components/admin/scheduler';

function AdminDashboardPage() {
  return (
    <DashboardLayout title="Panel de Control Operativo">
      
      {/* 1. SECCIN DE KPIs / ESTADSTICAS */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4 transition-transform hover:scale-[1.02]">
            <div className="p-3 bg-blue-50 rounded-xl text-blue-600">
                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
            </div>
            <div>
                <p className="text-sm font-medium text-slate-500">Colaboradores Activos</p>
                <p className="text-2xl font-bold text-slate-800">24</p>
            </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4 transition-transform hover:scale-[1.02]">
            <div className="p-3 bg-green-50 rounded-xl text-green-600">
                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            </div>
            <div>
                <p className="text-sm font-medium text-slate-500">Turnos Programados</p>
                <p className="text-2xl font-bold text-slate-800">8</p>
            </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4 transition-transform hover:scale-[1.02]">
            <div className="p-3 bg-purple-50 rounded-xl text-purple-600">
                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <div>
                <p className="text-sm font-medium text-slate-500">Cobertura de Objetivos</p>
                <p className="text-2xl font-bold text-slate-800">98%</p>
            </div>
        </div>
      </div>

      {/* 2. SECCIN PRINCIPAL: PLANIFICADOR VISUAL */}
      <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <div>
                <h3 className="text-lg font-bold text-slate-800">Planificador de Cronogramas</h3>
                <p className="text-sm text-slate-500">Arrastra colaboradores al calendario para asignar turnos.</p>
            </div>
            <div className="hidden sm:block">
                <span className="px-3 py-1 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded-full">Vista Semanal</span>
            </div>
        </div>
        
        <div className="p-6">
            <DragAndDropScheduler />
        </div>
      </div>

    </DashboardLayout>
  );
}

// Exportaci贸n protegida solo para administradores
export default withAuthGuard(AdminDashboardPage as any, 'admin');

================================================================================
FILE: apps\web\pages\admin\employees.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { EmployeeManagement } from '@/components/admin/employee-management';

function EmployeesPage() {
  return (
    <DashboardLayout title="Gesti贸n de Recursos Humanos">
      <EmployeeManagement />
    </DashboardLayout>
  );
}

export default withAuthGuard(EmployeesPage as any, 'admin');

================================================================================
FILE: apps\web\pages\admin\objective-detail\[id].tsx
================================================================================
// Archivo: pages/admin/objective-detail/[id].tsx

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/router';
import { withAuthGuard } from '@/components/common/withAuthGuard'; 
//  FIX 1: Importar DashboardLayout por defecto (sin llaves {})
import DashboardLayout from '@/components/layout/DashboardLayout'; 
import toast from 'react-hot-toast'; 


// Define una interfaz para los datos que esperas recibir (Sin cambios)
interface ObjectiveDetails {
    id: string;
    title: string;
    services: { name: string; status: string }[];
    shifts: { date: string; time: string }[];
}

function ObjectiveDetailPage() {
    const router = useRouter();
    const { id } = router.query;
    
    const [details, setDetails] = useState<ObjectiveDetails | null>(null);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        if (!id) return;

        const fetchDetails = async () => {
            setIsLoading(true);
            try {
                // MOCK DE DATOS (Debe ser reemplazado por la llamada a tu API)
                const mockData: ObjectiveDetails = {
                    id: id as string,
                    title: `Objetivo ID: ${id}`,
                    services: [{ name: 'Mantenimiento Preventivo', status: 'Activo' }],
                    shifts: [{ date: '2026-01-15', time: '10:00' }],
                };
                
                setDetails(mockData);
            } catch (error) {
                console.error("Error al cargar detalles:", error);
                toast.error("No se pudieron cargar los detalles del objetivo.");
            } finally {
                setIsLoading(false);
            }
        };

        fetchDetails();
    }, [id]);

    const objectiveTitle = details ? `Detalle: ${details.title}` : `Detalle Objetivo: ${id || 'Cargando...'}`;

    return (
        <DashboardLayout title={objectiveTitle}>
            {/* El error de la L铆nea 84 (cierre de DashboardLayout) se corrige con la importaci贸n correcta */}
            {isLoading && <p>Cargando detalles...</p>}
            
            {details && (
                <div className="space-y-6">
                    <h2 className="text-xl font-bold mt-4">Servicios Asociados</h2>
                    <ul className="list-disc ml-6 space-y-2">
                        {details.services.map((s, i) => (
                            <li key={i}>{s.name} - Estado: **{s.status}**</li>
                        ))}
                    </ul>

                    <h2 className="text-xl font-bold mt-4">Turnos Programados</h2>
                    <ul className="list-disc ml-6 space-y-2">
                        {details.shifts.map((t, i) => (
                            <li key={i}>{t.date} a las {t.time}</li>
                        ))}
                    </ul>
                </div>
            )}
        </DashboardLayout>
    );
}

// APLICACIN DE SEGURIDAD POR DISEO: 
export default withAuthGuard(ObjectiveDetailPage, ['admin']);

================================================================================
FILE: apps\web\pages\admin\objective-management.tsx
================================================================================
import React from 'react';
import { ObjectiveManagement } from '@/components/admin/objective-management';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout'; // Importamos el Layout

const ObjectiveManagementPage = () => {
  return (
    // Envolvemos el componente en el Layout
    <DashboardLayout title="Gesti贸n de Objetivos y Sucursales">
      <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
         <ObjectiveManagement />
      </div>
    </DashboardLayout>
  );
};

export default withAuthGuard(ObjectiveManagementPage as any, 'admin');

================================================================================
FILE: apps\web\pages\admin\rrhh\novedades.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout'; // Importaci贸n con llaves
import { AbsenceManagementPage } from '@/components/admin/AbsenceManagementPage';

function NovedadesPage() {
  return (
    //  SOLUCIN: Agregamos la prop 'title' obligatoria
    <DashboardLayout title="Gesti贸n de Novedades">
      <div className="p-6">
        <h1 className="text-2xl font-bold text-slate-800 mb-2">Gesti贸n de RRHH</h1>
        <p className="text-gray-500 mb-6">Registrar licencias, vacaciones y novedades.</p>
        <AbsenceManagementPage />
      </div>
    </DashboardLayout>
  );
}

export default withAuthGuard(NovedadesPage, 'admin');

================================================================================
FILE: apps\web\pages\admin\status.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
//  CORRECCIN: Agregamos llaves { } para usar la exportaci贸n nombrada
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { SystemStatus } from '@/components/admin/SystemStatus';

function StatusPage() {
  return (
    <DashboardLayout title="Diagn贸stico de Sistema">
      <div className="p-6">
        <SystemStatus />
      </div>
    </DashboardLayout>
  );
}

export default withAuthGuard(StatusPage, 'admin');

================================================================================
FILE: apps\web\pages\admin\system-users.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { SystemUserManagement } from '@/components/admin/system-user-management';

function SystemUsersPage() {
  return (
    <DashboardLayout title="Configuraci贸n de Acceso">
      <SystemUserManagement />
    </DashboardLayout>
  );
}

export default withAuthGuard(SystemUsersPage as any, 'admin');

================================================================================
FILE: apps\web\pages\employee\dashboard.tsx
================================================================================
import React from 'react';
import { useRouter } from 'next/router';
// 1. Importamos el guardia
import { withAuthGuard } from '@/components/common/withAuthGuard';
// 2. Importamos SOLO el componente visual del empleado que acabamos de revisar
import { EmployeeDashboard } from '@/components/employee/employee-dashboard';
import { auth } from '@/services/firebase-client.service';

function EmployeePage({ currentUser }: { currentUser: any }) {
  const router = useRouter();

  const handleLogout = async () => {
    await auth.signOut();
    window.location.href = '/';
  };

  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      {/* Header Exclusivo de Empleado (Sin Admin Sidebar) */}
      <header className="bg-white shadow-sm px-4 py-4 flex justify-between items-center sticky top-0 z-10">
        <div className="flex items-center space-x-2">
            <div className="bg-indigo-600 p-1.5 rounded-lg">
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            </div>
            <div className="leading-tight">
                <h1 className="text-lg font-bold text-gray-800">Mi Portal</h1>
                <p className="text-xs text-gray-500">{currentUser?.email}</p>
            </div>
        </div>
        
        <button onClick={handleLogout} className="text-sm text-red-600 font-medium border border-red-100 px-3 py-1.5 rounded-lg hover:bg-red-50">
            Salir
        </button>
      </header>

      <main>
        <EmployeeDashboard currentUser={currentUser} />
      </main>
    </div>
  );
}

//  NICO GUARDIA: Solo para 'employee'
export default withAuthGuard(EmployeePage as any, 'employee');

================================================================================
FILE: apps\web\pages\employee\employees.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
// Importamos el componente de gesti贸n que ya tienes en src/components
import { EmployeeManagement } from '@/components/admin/employee-management';

function EmployeesPage() {
  return (
    <DashboardLayout title="Gesti贸n de Recursos Humanos">
      <div className="p-6">
        <div className="mb-6">
            <h1 className="text-2xl font-bold text-slate-800">N贸mina de Personal</h1>
            <p className="text-gray-500">Administraci贸n de empleados operativos y seguridad.</p>
        </div>
        
        {/* Renderizamos el componente de l贸gica */}
        <EmployeeManagement />
      </div>
    </DashboardLayout>
  );
}

// Protegemos la ruta solo para administradores
export default withAuthGuard(EmployeesPage, 'admin');

================================================================================
FILE: apps\web\pages\index.tsx
================================================================================
import React, { useEffect } from 'react';
import { useRouter } from 'next/router';
import { onAuthStateChanged } from 'firebase/auth';
import { auth } from '@/services/firebase-client.service';
import { LoginForm } from '@/components/admin/login-form';

const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager'];

export default function HomePage() {
  const router = useRouter();

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          // Obtenemos el rol real del token
          const tokenResult = await user.getIdTokenResult();
          const role = tokenResult.claims.role as string;
          
          console.log("Usuario detectado:", user.email, "| Rol:", role);

          //  LGICA DE BIFURCACIN
          if (ADMIN_ROLES.includes(role)) {
            console.log("--> Redirigiendo a Admin Dashboard");
            router.push('/admin/dashboard');
          } else {
            // Si no es admin, asumimos que es empleado (o 'employee')
            console.log("--> Redirigiendo a Employee Dashboard");
            router.push('/employee/dashboard');
          }
        } catch (e) {
          console.error("Error leyendo rol:", e);
        }
      }
    });
    return () => unsubscribe();
  }, [router]);

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4 font-sans">
      <div className="w-full max-w-md">
        <LoginForm />
      </div>
    </div>
  );
}

================================================================================
FILE: apps\web\pages\_app.tsx
================================================================================
import React from 'react';
import type { AppProps } from 'next/app';
// 1. Importamos el sistema de notificaciones (Frontend)
import { Toaster } from 'react-hot-toast';
// 2. Importamos el proveedor de contexto de cliente (Frontend)
import { ClientProvider } from '@/context/ClientContext';
// 3. Importamos los estilos globales (Tailwind)
import '@/styles/globals.css'; 

export default function App({ Component, pageProps }: AppProps) {
  return (
    // Envolvemos toda la app en el ClientProvider para tener acceso a la empresa seleccionada
    <ClientProvider>
      
      {/* Renderizamos la p谩gina actual */}
      <Component {...pageProps} />
      
      {/* Configuraci贸n global de las notificaciones (Toasts) */}
      <Toaster 
        position="top-right" 
        reverseOrder={false}
        toastOptions={{
          // Estilos por defecto para todas las notificaciones
          style: {
            borderRadius: '10px',
            background: '#333',
            color: '#fff',
            fontSize: '14px',
          },
          // Estilos espec铆ficos para 茅xito (Verde)
          success: {
            style: {
              background: '#ECFDF5', // Verde muy claro
              color: '#065F46',      // Texto verde oscuro
              border: '1px solid #10B981',
            },
            iconTheme: {
              primary: '#10B981',
              secondary: '#FFFAEE',
            },
          },
          // Estilos espec铆ficos para error (Rojo)
          error: {
            style: {
              background: '#FEF2F2', // Rojo muy claro
              color: '#991B1B',      // Texto rojo oscuro
              border: '1px solid #EF4444',
            },
            duration: 5000, // Duran 5 segundos para poder leerlos bien
          },
        }}
      />
    </ClientProvider>
  );
}

================================================================================
FILE: apps\web\README.md
================================================================================
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.


================================================================================
FILE: apps\web\src\common\interfaces\client.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore';
import { ReactNode } from 'react';

export interface IClient {
  contactEmail: ReactNode;
  contactName: string;
  cuit: ReactNode;
  businessName: ReactNode;
  id: string;
  name: string;
  status: 'Active' | 'Inactive';
  createdAt: Timestamp;
}

export interface IObjective {
  id: string;
  clientId: string;
  name: string;
  address: string;
  location: {
    latitude: number;
    longitude: number;
  };
  type: string;
}

//  AGREGADO: Contrato de servicio (para saber las horas vendidas)
export interface IServiceContract {
  id: string;
  objectiveId: string;
  name: string;        
  totalHoursPerMonth: number;
  isActive: boolean;
}

//  AGREGADO: Tipos de turno (Modalidades) - Soluciona el error en scheduler.tsx
export interface IShiftType {
  id: string;
  contractId: string;
  name: string;       // Ej: "Turno Tarde"
  code: string;       // Ej: "TT"
  color: string;      // Ej: "#FF5733"
  startTime: string;  // Ej: "14:00"
  durationHours: number; // Ej: 8
  requiredRole?: string; 
}

================================================================================
FILE: apps\web\src\common\interfaces\employee.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore'; 

/**
 * @description Define los roles de usuario dentro del sistema Cronograma.
 */
export type EmployeeRole = 'admin' | 'employee';

/**
 * @description Define los tipos de contrato laboral soportados.
 */
export type ContractType = 'FullTime' | 'PartTime' | 'Eventual';

/**
 * @description Interfaz principal para la entidad Colaborador (Employee).
 * Estos son los datos que se obtienen del m贸dulo RRHH.
 */
export interface IEmployee {
    uid: string; // Firebase Auth UID / Document ID
    name: string;
    role: EmployeeRole;
    email: string;
    isAvailable: boolean; // Estado de disponibilidad general
    maxHoursPerMonth: number; // L铆mite de horas contractuales
    contractType: ContractType;
    
    //  NUEVOS CAMPOS (Solucionan el error de build)
    clientId: string;   // Para scoping (Vinculaci贸n a empresa)
    dni: string;        // Documento
    fileNumber: string; // Legajo
    address: string;    // Direcci贸n
    phone?: string;     // Tel茅fono opcional
}

/**
 * @description Estructura de una ausencia.
 */
export interface IAbsence {
    id: string;
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    startDate: Timestamp; 
    endDate: Timestamp;
    reason: string;
    status: 'PENDING' | 'APPROVED' | 'REJECTED';
    createdAt: Timestamp;
}

/**
 * @description Payload para crear ausencia desde el cliente.
 */
export interface IAbsencePayload {
    employeeId: string;
    employeeName: string;
    clientId: string;
    type: 'VACATION' | 'SICK_LEAVE' | 'OTHER';
    startDate: Date; 
    endDate: Date;
    reason: string;
}

================================================================================
FILE: apps\web\src\common\interfaces\shift.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore';

export interface IShift {
  id: string;
  employeeId: string;
  employeeName: string;
  objectiveId: string;
  objectiveName: string;
  
  startTime: Timestamp;
  endTime: Timestamp;
  
  status: 'Assigned' | 'Confirmed' | 'InProgress' | 'Completed' | 'Canceled';
  
  checkInTime?: Timestamp;
  checkOutTime?: Timestamp;
  
  schedulerId: string;
  updatedAt: Timestamp;

  //  CORRECCIN: Agregamos el campo opcional 'role' para que el Dashboard no falle
  role?: string; 
}

================================================================================
FILE: apps\web\src\common\interfaces\system-user.interface.ts
================================================================================
import { Timestamp } from 'firebase/firestore';

export type SystemRole = 'SuperAdmin' | 'Scheduler' | 'HR_Manager' | 'Viewer';

export interface ISystemUser {
  uid: string;
  email: string;
  displayName: string;
  role: SystemRole;
  status: 'Active' | 'Inactive';
  createdAt: Timestamp;
  lastLogin?: Timestamp;
}

================================================================================
FILE: apps\web\src\components\admin\AbsenceManagementPage.test.tsx
================================================================================
//  FIX 1: Importar jest-dom para habilitar los matchers del DOM
import '@testing-library/jest-dom';
import { render, screen, waitFor, fireEvent } from '@testing-library/react';
import { AbsenceManagementPage } from './AbsenceManagementPage'; 
import { useClient } from '@/context/ClientContext';
import { callCreateAbsence, callManageEmployees } from '@/services/firebase-client.service'; 
import toast from 'react-hot-toast';

// Mocks de UI
jest.mock('../common/InputField', () => ({
    __esModule: true,
    default: ({ label, onChange, value, type }: any) => (
        <input aria-label={label} type={type || 'text'} value={value} onChange={onChange} />
    ),
}));

jest.mock('../common/SelectField', () => ({
    __esModule: true,
    default: ({ label, onChange, value, children }: any) => (
        <select aria-label={label} value={value} onChange={onChange}>{children}</select>
    ),
}));

jest.mock('../common/Button', () => ({
    __esModule: true,
    default: ({ children, disabled, type, onClick }: any) => (
        <button disabled={disabled} type={type} onClick={onClick} data-testid="submit-button">{children}</button>
    ),
}));

// Mocks de servicios
jest.mock('@/context/ClientContext', () => ({ useClient: jest.fn(), }));
jest.mock('@/services/firebase-client.service', () => ({
    callManageEmployees: jest.fn(),
    callCreateAbsence: jest.fn(), 
}));
jest.mock('react-hot-toast', () => ({
    error: jest.fn(),
    success: jest.fn(),
    loading: jest.fn().mockReturnValue('toast-id-mock'),
}));

const mockEmployees = [
    { uid: 'emp1', name: 'Juan P茅rez', role: 'Vigilador' },
];

const mockUseClient = (selectedClientId: string | null) => (
    (useClient as jest.Mock).mockReturnValue({ selectedClientId })
);

describe('AbsenceManagementPage', () => {
    beforeEach(() => {
        jest.clearAllMocks();
        
        //  FIX 2: Doble casting para silenciar a TypeScript
        (callManageEmployees as unknown as jest.Mock).mockResolvedValue({
            data: { data: mockEmployees },
        });
        (callCreateAbsence as unknown as jest.Mock).mockResolvedValue({
            data: { success: true },
        });
        
        mockUseClient('client_abc'); 
    });

    it('should render and fetch employees successfully', async () => {
        render(<AbsenceManagementPage />);
        await waitFor(() => {
            expect(callManageEmployees).toHaveBeenCalled();
        });
        // FIX 3: Usamos el matcher que ahora s铆 est谩 importado
        expect(screen.getByLabelText(/Colaborador/i)).toBeInTheDocument();
    });

    it('should validate form dates', async () => {
        render(<AbsenceManagementPage />);
        await waitFor(() => { expect(callManageEmployees).toHaveBeenCalled(); });

        fireEvent.change(screen.getByLabelText(/Colaborador/i), { target: { value: 'emp1' } });
        fireEvent.change(screen.getByLabelText(/Raz贸n \/ Comentarios/i), { target: { value: 'Test Reason' } });
        fireEvent.change(screen.getByLabelText(/Fecha de Inicio/i), { target: { value: '2025-01-10' } });
        fireEvent.change(screen.getByLabelText(/Fecha de Fin/i), { target: { value: '2025-01-01' } });

        fireEvent.click(screen.getByTestId('submit-button'));

        await waitFor(() => {
            expect(toast.error).toHaveBeenCalled();
        });
        expect(callCreateAbsence).not.toHaveBeenCalled();
    });

    it('should submit successfully', async () => {
        render(<AbsenceManagementPage />);
        await waitFor(() => { expect(callManageEmployees).toHaveBeenCalled(); });

        fireEvent.change(screen.getByLabelText(/Colaborador/i), { target: { value: 'emp1' } });
        fireEvent.change(screen.getByLabelText(/Tipo de Novedad/i), { target: { value: 'SICK_LEAVE' } });
        fireEvent.change(screen.getByLabelText(/Fecha de Inicio/i), { target: { value: '2025-01-01' } });
        fireEvent.change(screen.getByLabelText(/Fecha de Fin/i), { target: { value: '2025-01-05' } });
        fireEvent.change(screen.getByLabelText(/Raz贸n \/ Comentarios/i), { target: { value: 'Test Sick Leave' } });

        fireEvent.click(screen.getByTestId('submit-button'));

        await waitFor(() => {
            expect(callCreateAbsence).toHaveBeenCalled();
        });
        expect(toast.success).toHaveBeenCalled();
    });
});

================================================================================
FILE: apps\web\src\components\admin\AbsenceManagementPage.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import toast from 'react-hot-toast';
import { useClient } from '@/context/ClientContext';
import { IAbsencePayload, IEmployee } from '@/common/interfaces/employee.interface';
//  Importamos la funci贸n helper 'createAbsence' que ya maneja la conversi贸n de fechas
import { createAbsence, callManageEmployees } from '@/services/firebase-client.service';
import InputField from '@/components/common/InputField'; 
import SelectField from '@/components/common/SelectField';
import Button from '@/components/common/Button';

const ABSENCE_TYPES = [
    { value: 'VACATION', label: 'Vacaciones' },
    { value: 'SICK_LEAVE', label: 'Licencia M茅dica' },
    { value: 'OTHER', label: 'Otro / Personal' },
];

export function AbsenceManagementPage() {
    const { selectedClientId, selectedClient } = useClient(); // Usamos el contexto
    const [employees, setEmployees] = useState<IEmployee[]>([]);
    const [isLoadingEmployees, setIsLoadingEmployees] = useState<boolean>(false);
    const [isSubmitting, setIsSubmitting] = useState<boolean>(false);

    const [formData, setFormData] = useState<IAbsencePayload>({
        employeeId: '',
        employeeName: '',
        clientId: selectedClientId || '',
        type: 'VACATION',
        startDate: new Date(),
        endDate: new Date(),
        reason: '',
    });

    // Sincronizar clientId cuando cambia la selecci贸n en el men煤
    useEffect(() => {
        setFormData(prev => ({ 
            ...prev, 
            clientId: selectedClientId || '', 
            employeeId: '', 
            employeeName: '' 
        }));
    }, [selectedClientId]);

    // 1. Cargar Empleados (Filtrados por Empresa)
    useEffect(() => {
        const fetchEmployees = async () => {
            if (!selectedClientId) {
                setEmployees([]);
                return;
            }

            setIsLoadingEmployees(true);
            try {
                //  Filtramos por la empresa actual
                const empRes = await callManageEmployees({ 
                    action: 'GET_ALL_EMPLOYEES', 
                    payload: { clientId: selectedClientId } 
                });
                
                setEmployees((empRes.data as any).data || []); 
            } catch (error) {
                console.error("Error fetching employees:", error);
                toast.error("No se pudo cargar la lista de empleados.");
            } finally {
                setIsLoadingEmployees(false);
            }
        };
        fetchEmployees();
    }, [selectedClientId]);

    const handleEmployeeChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const selectedId = e.target.value;
        const selectedEmployee = employees.find(emp => emp.uid === selectedId);

        setFormData(prev => ({
            ...prev,
            employeeId: selectedId,
            employeeName: selectedEmployee ? selectedEmployee.name : ''
        }));
    };

    const handleDateChange = (name: keyof IAbsencePayload, value: string) => {
        // Fix de zona horaria simple: al crear fecha desde string YYYY-MM-DD, 
        // aseguramos que se interprete correctamente.
        const dateValue = new Date(value + 'T12:00:00'); // Mediod铆a para evitar saltos de d铆a por TZ
        setFormData(prev => ({
            ...prev,
            [name]: dateValue,
        }));
    };

    const validateForm = (data: IAbsencePayload): boolean => {
        if (!data.employeeId || !data.clientId || !data.type) {
            toast.error("Complete los campos obligatorios (Empleado, Tipo).");
            return false;
        }
        if (data.startDate.getTime() > data.endDate.getTime()) {
            toast.error("La fecha de inicio no puede ser posterior a la de fin.");
            return false;
        }
        if (!data.reason.trim()) {
            toast.error("Debe proporcionar una raz贸n o comentario.");
            return false;
        }
        return true;
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!validateForm(formData)) return;

        setIsSubmitting(true);
        const toastId = toast.loading(`Registrando ${formData.type}...`);

        try {
            // Usamos la funci贸n helper que creamos en el servicio
            await createAbsence({ action: 'CREATE_ABSENCE', payload: formData });
            
            toast.success("Novedad registrada exitosamente.", { id: toastId });
            
            // Reset parcial del formulario
            setFormData(prev => ({ 
                ...prev, 
                type: 'VACATION', 
                startDate: new Date(), 
                endDate: new Date(), 
                reason: '' 
            }));
        } catch (error: any) {
            console.error("Absence creation failed:", error);
            // Mensaje de error amigable si viene del backend (ej: Solapamiento)
            const message = error.message.includes('Conflicto') 
                ? error.message 
                : "Error al registrar la novedad. Verifique si hay turnos asignados.";
            
            toast.error(message, { id: toastId, duration: 5000 });
        } finally {
            setIsSubmitting(false);
        }
    };

    if (!selectedClientId) {
        return (
            <div className="flex flex-col items-center justify-center h-64 bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                <div className="bg-orange-100 p-3 rounded-full mb-4">
                    <svg className="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                </div>
                <h3 className="text-lg font-bold text-gray-800">Selecci贸n Requerida</h3>
                <p className="text-gray-500 mt-2">Por favor, seleccione una empresa en el men煤 lateral para gestionar las novedades de su personal.</p>
            </div>
        );
    }

    return (
        <div className="max-w-4xl mx-auto">
            {/* Cabecera */}
            <div className="mb-6 flex items-center justify-between">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800">Gesti贸n de Novedades</h2>
                    <p className="text-slate-500">Registrar licencias y vacaciones para <span className="font-semibold text-indigo-600">{selectedClient?.businessName}</span>.</p>
                </div>
            </div>

            <div className="bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                <form onSubmit={handleSubmit} className="space-y-6">
                    
                    <SelectField
                        label="Colaborador"
                        id="employeeId"
                        value={formData.employeeId}
                        onChange={handleEmployeeChange}
                        disabled={isLoadingEmployees || isSubmitting}
                        required
                    >
                        <option value="" disabled>{isLoadingEmployees ? 'Cargando...' : 'Seleccione un colaborador'}</option>
                        {employees.map(emp => (
                            //  MEJORA VISUAL: Mostramos Legajo para mejor identificaci贸n
                            <option key={emp.uid} value={emp.uid}>
                                {emp.name} (Leg: {emp.fileNumber || 'S/N'})
                            </option>
                        ))}
                    </SelectField>

                    <SelectField
                        label="Tipo de Novedad"
                        id="type"
                        value={formData.type}
                        onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value as IAbsencePayload['type'] }))}
                        disabled={isSubmitting}
                        required
                    >
                        {ABSENCE_TYPES.map(type => (
                            <option key={type.value} value={type.value}>{type.label}</option>
                        ))}
                    </SelectField>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <InputField
                            label="Fecha de Inicio"
                            id="startDate"
                            type="date"
                            value={formData.startDate.toISOString().split('T')[0]}
                            onChange={(e) => handleDateChange('startDate', e.target.value)}
                            disabled={isSubmitting}
                            required
                        />
                        <InputField
                            label="Fecha de Fin"
                            id="endDate"
                            type="date"
                            value={formData.endDate.toISOString().split('T')[0]}
                            onChange={(e) => handleDateChange('endDate', e.target.value)}
                            disabled={isSubmitting}
                            required
                        />
                    </div>

                    <InputField
                        label="Raz贸n / Comentarios"
                        id="reason"
                        type="textarea"
                        value={formData.reason}
                        onChange={(e) => setFormData(prev => ({ ...prev, reason: e.target.value }))}
                        rows={3}
                        disabled={isSubmitting}
                        required
                        placeholder="Detalle el motivo de la ausencia..."
                    />
                    
                    <div className="flex justify-end pt-4 border-t border-gray-100">
                        <Button type="submit" disabled={isSubmitting || !formData.employeeId} primary className="w-full md:w-auto">
                            {isSubmitting ? (
                                <span className="flex items-center">
                                    <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    Validando y Registrando...
                                </span>
                            ) : 'Registrar Novedad'}
                        </Button>
                    </div>
                </form>
            </div>
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\admin\client-management.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import toast from 'react-hot-toast';
import { callManageHierarchy } from '@/services/firebase-client.service';
import { IClient } from '@/common/interfaces/client.interface';
import InputField from '@/components/common/InputField';
import SelectField from '@/components/common/SelectField';
import Button from '@/components/common/Button';
import { useClient } from '@/context/ClientContext'; // Para recargar el contexto global al cambiar algo

export function ClientManagement() {
  const { setClient } = useClient(); // Usamos esto para forzar recarga si es necesario
  const [clients, setClients] = useState<IClient[]>([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Estado del Formulario
  const [formData, setFormData] = useState({
    id: '',
    businessName: '',
    cuit: '',
    contactName: '',
    contactEmail: '',
    status: 'Active' as 'Active' | 'Inactive'
  });

  // 1. Cargar Clientes
  const fetchClients = async () => {
    setLoading(true);
    try {
      const res = await callManageHierarchy({ action: 'GET_ALL_CLIENTS', payload: {} });
      const data = (res.data as any).data || [];
      setClients(data);
    } catch (error) {
      console.error(error);
      toast.error("Error al cargar la cartera de clientes.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchClients();
  }, []);

  // 2. Manejadores del Modal
  const handleOpenCreate = () => {
    setFormData({ id: '', businessName: '', cuit: '', contactName: '', contactEmail: '', status: 'Active' });
    setIsEditing(false);
    setShowModal(true);
  };

  const handleOpenEdit = (client: IClient) => {
    setFormData({
      id: client.id,
      businessName: String(client.businessName),
      cuit: String(client.cuit),
      contactName: client.contactName || '',
      contactEmail: String(client.contactEmail || ''),
      status: client.status
    });
    setIsEditing(true);
    setShowModal(true);
  };

  // 3. Guardar (Crear o Editar)
  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    const toastId = toast.loading(isEditing ? "Actualizando..." : "Creando empresa...");

    try {
      if (isEditing) {
        // UPDATE
        await callManageHierarchy({ 
            action: 'UPDATE_CLIENT', 
            payload: { 
                id: formData.id, 
                data: {
                    businessName: formData.businessName,
                    cuit: formData.cuit,
                    contactName: formData.contactName,
                    contactEmail: formData.contactEmail,
                    status: formData.status
                }
            } 
        });
        toast.success("Empresa actualizada", { id: toastId });
      } else {
        // CREATE
        await callManageHierarchy({ 
            action: 'CREATE_CLIENT', 
            payload: {
                businessName: formData.businessName,
                cuit: formData.cuit,
                contactName: formData.contactName,
                contactEmail: formData.contactEmail,
                status: formData.status
            }
        });
        toast.success("Empresa creada exitosamente", { id: toastId });
      }
      
      setShowModal(false);
      fetchClients(); // Recargar lista local
      // Opcional: Recargar contexto global si fuera necesario
      // setClient(''); 

    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`, { id: toastId });
    } finally {
        setIsSubmitting(false);
    }
  };

  // 4. Eliminar
  const handleDelete = async (id: string, name: string) => {
    if (!confirm(`驴Est谩s seguro de eliminar a ${name}? Esto podr铆a romper datos hist贸ricos.`)) return;
    
    const toastId = toast.loading("Eliminando...");
    try {
        await callManageHierarchy({ action: 'DELETE_CLIENT', payload: { id } });
        toast.success("Empresa eliminada", { id: toastId });
        fetchClients();
    } catch (error: any) {
        toast.error(`Error: ${error.message}`, { id: toastId });
    }
  };

  return (
    <div className="space-y-6">
      {/* Header de Secci贸n */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h2 className="text-2xl font-bold text-slate-800">Cartera de Clientes</h2>
            <p className="text-sm text-slate-500">Gestione las empresas contratantes.</p>
        </div>
        <Button onClick={handleOpenCreate} primary className="flex items-center shadow-sm">
            <svg className="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
            Nueva Empresa
        </Button>
      </div>

      {/* Tabla Responsiva */}
      <div className="bg-white shadow-sm rounded-xl border border-slate-200 overflow-hidden">
        {loading ? (
            <div className="p-12 text-center text-slate-500 animate-pulse">Cargando cartera...</div>
        ) : (
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Raz贸n Social</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">CUIT / ID</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Contacto</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Estado</th>
                            <th className="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                        {clients.length === 0 && (
                            <tr><td colSpan={5} className="px-6 py-8 text-center text-slate-500 italic">No hay clientes registrados.</td></tr>
                        )}
                        {clients.map((client) => (
                            <tr key={client.id} className="hover:bg-slate-50 transition duration-150">
                                <td className="px-6 py-4 whitespace-nowrap">
                                    <div className="flex items-center">
                                        <div className="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-sm mr-3">
                                            {String(client.businessName).charAt(0)}
                                        </div>
                                        <div className="text-sm font-bold text-slate-900">{client.businessName}</div>
                                    </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-600 font-mono">
                                    {client.cuit}<br/>
                                    <span className="text-[10px] text-slate-400">{client.id.substring(0,8)}...</span>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                    <div className="text-sm text-slate-900">{client.contactName}</div>
                                    <div className="text-xs text-slate-500">{client.contactEmail}</div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                    <span className={`px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                        client.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }`}>
                                        {client.status === 'Active' ? 'Activo' : 'Inactivo'}
                                    </span>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button onClick={() => handleOpenEdit(client)} className="text-indigo-600 hover:text-indigo-900 mr-4 font-semibold">Editar</button>
                                    <button onClick={() => handleDelete(client.id, String(client.businessName))} className="text-rose-600 hover:text-rose-900 font-semibold">Eliminar</button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        )}
      </div>

      {/* Modal CRUD */}
      {showModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6 border border-slate-100 transform transition-all">
                <div className="flex justify-between items-center mb-6">
                    <h3 className="text-xl font-bold text-slate-800">{isEditing ? 'Editar Empresa' : 'Nueva Empresa'}</h3>
                    <button onClick={() => setShowModal(false)} className="text-slate-400 hover:text-slate-600">
                        <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                
                <form onSubmit={handleSave} className="space-y-4">
                    <InputField 
                        label="Raz贸n Social" 
                        id="businessName" 
                        value={formData.businessName} 
                        onChange={e => setFormData({...formData, businessName: e.target.value})} 
                        placeholder="Ej: Seguridad Integral S.A."
                        required 
                    />
                    
                    <div className="grid grid-cols-2 gap-4">
                        <InputField 
                            label="CUIT" 
                            id="cuit" 
                            value={formData.cuit} 
                            onChange={e => setFormData({...formData, cuit: e.target.value})} 
                            placeholder="30-12345678-9"
                            required 
                        />
                        <SelectField 
                            label="Estado" 
                            id="status" 
                            value={formData.status} 
                            onChange={e => setFormData({...formData, status: e.target.value as any})}
                        >
                            <option value="Active">Activo</option>
                            <option value="Inactive">Inactivo</option>
                        </SelectField>
                    </div>

                    <div className="pt-4 border-t border-slate-100">
                        <h4 className="text-sm font-semibold text-slate-500 uppercase mb-3">Datos de Contacto</h4>
                        <div className="space-y-4">
                            <InputField 
                                label="Nombre Contacto" 
                                id="contactName" 
                                value={formData.contactName} 
                                onChange={e => setFormData({...formData, contactName: e.target.value})} 
                                placeholder="Ej: Juan Gerente"
                            />
                            <InputField 
                                label="Email Contacto" 
                                id="contactEmail" 
                                type="email"
                                value={formData.contactEmail} 
                                onChange={e => setFormData({...formData, contactEmail: e.target.value})} 
                                placeholder="contacto@empresa.com"
                            />
                        </div>
                    </div>

                    <div className="flex justify-end space-x-3 mt-8 pt-2">
                        <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 font-medium transition-colors">
                            Cancelar
                        </button>
                        <Button type="submit" primary disabled={isSubmitting}>
                            {isSubmitting ? 'Guardando...' : 'Guardar Empresa'}
                        </Button>
                    </div>
                </form>
            </div>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\client-setup-wizard.tsx
================================================================================
import React, { useState } from 'react';
import { useRouter } from 'next/router'; //  FIX: Usar router de Next.js para navegaci贸n segura
import { callManageHierarchy } from '@/services/firebase-client.service';
import toast from 'react-hot-toast';

// Interfaces locales para el estado del formulario
interface ShiftTypeUI {
  name: string;
  code: string;
  startTime: string;
  durationHours: number;
}

export function ClientSetupWizard() {
  const router = useRouter(); // Hook de navegaci贸n
  const [step, setStep] = useState(1);
  const [loading, setLoading] = useState(false);
  
  // IDs generados por el backend a medida que avanzamos
  const [ids, setIds] = useState({ clientId: '', objectiveId: '', contractId: '' });

  // Listado visual de modalidades agregadas en el paso 4
  const [addedShifts, setAddedShifts] = useState<ShiftTypeUI[]>([]);

  // Datos de Formularios
  const [clientData, setClientData] = useState({ businessName: '', cuit: '', contactName: '', contactEmail: '' });
  const [objData, setObjData] = useState({ name: '', address: '', latitude: '', longitude: '' });
  const [contractData, setContractData] = useState({ name: '', totalHoursPerMonth: 720 });
  
  // Datos del formulario de Modalidad actual
  const [shiftData, setShiftData] = useState<ShiftTypeUI>({ 
    name: 'Turno Ma帽ana', 
    code: 'TM', 
    startTime: '06:00', 
    durationHours: 8 
  });

  // --- PASO 1: CREAR CLIENTE ---
  const handleCreateClient = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const res = await callManageHierarchy({ action: 'CREATE_CLIENT', payload: { ...clientData, status: 'Active' } });
      const data = res.data as any;
      setIds(prev => ({ ...prev, clientId: data.data.id }));
      toast.success("Empresa creada correctamente");
      setStep(2);
    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- PASO 2: CREAR OBJETIVO ---
  const handleCreateObjective = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const payload = {
        ...objData,
        clientId: ids.clientId,
        location: { latitude: Number(objData.latitude), longitude: Number(objData.longitude) },
        type: 'Sede'
      };
      const res = await callManageHierarchy({ action: 'CREATE_OBJECTIVE', payload });
      const data = res.data as any;
      setIds(prev => ({ ...prev, objectiveId: data.data.id }));
      toast.success("Objetivo vinculado");
      setStep(3);
    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- PASO 3: CREAR CONTRATO ---
  const handleCreateContract = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const payload = {
        ...contractData,
        objectiveId: ids.objectiveId,
        startDate: new Date(),
        isActive: true
      };
      const res = await callManageHierarchy({ action: 'CREATE_CONTRACT', payload });
      const data = res.data as any;
      setIds(prev => ({ ...prev, contractId: data.data.id }));
      toast.success("Contrato generado");
      setStep(4);
    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- PASO 4: CREAR TIPO DE TURNO (MODALIDAD) ---
  const handleCreateShiftType = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      const payload = { ...shiftData, contractId: ids.contractId, color: '#3B82F6' };
      
      // Llamada al Backend
      await callManageHierarchy({ action: 'CREATE_SHIFT_TYPE', payload });
      
      toast.success(`Modalidad "${shiftData.name}" agregada`);
      
      // 1. Agregamos a la lista visual de abajo para feedback
      setAddedShifts(prev => [...prev, shiftData]);
      
      // 2. Reseteamos el formulario para cargar el siguiente r谩pidamente
      setShiftData({ 
        name: '', 
        code: '', 
        startTime: '14:00', // Sugerencia de siguiente horario
        durationHours: 8 
      });

    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`);
    } finally { setLoading(false); }
  };

  // --- ACCIN FINAL ---
  const handleFinish = () => {
    toast.success("Configuraci贸n finalizada con 茅xito.");
    //  FIX: Navegaci贸n segura de Next.js
    router.push('/admin/dashboard');
  };

  // Estilos reutilizables
  const inputClass = "w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 px-3 border mt-1";
  const labelClass = "block text-sm font-medium text-gray-700";
  const btnClass = "w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 font-medium shadow-sm";

  return (
    <div className="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
      
      {/* Barra de Progreso */}
      <div className="flex justify-between mb-8 relative">
        <div className="absolute top-1/2 left-0 w-full h-1 bg-gray-100 -z-10 rounded"></div>
        {[1, 2, 3, 4].map(num => (
            <div key={num} className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm transition-colors border-4 border-white ${step >= num ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-500'}`}>
                {num}
            </div>
        ))}
      </div>

      {step === 1 && (
        <form onSubmit={handleCreateClient} className="space-y-4 animate-fadeIn">
            <div className="border-b pb-4 mb-4">
                <h2 className="text-xl font-bold text-gray-800"> Paso 1: Datos de la Empresa</h2>
                <p className="text-sm text-gray-500">Registre la raz贸n social del cliente.</p>
            </div>
            <div><label className={labelClass}>Raz贸n Social</label><input className={inputClass} value={clientData.businessName} onChange={e => setClientData({...clientData, businessName: e.target.value})} required placeholder="Ej: Banco Galicia S.A." /></div>
            <div><label className={labelClass}>CUIT</label><input className={inputClass} value={clientData.cuit} onChange={e => setClientData({...clientData, cuit: e.target.value})} required placeholder="30-12345678-9" /></div>
            <button type="submit" disabled={loading} className={btnClass}>{loading ? 'Guardando...' : 'Guardar y Continuar'}</button>
        </form>
      )}

      {step === 2 && (
        <form onSubmit={handleCreateObjective} className="space-y-4 animate-fadeIn">
            <div className="border-b pb-4 mb-4">
                <h2 className="text-xl font-bold text-gray-800"> Paso 2: Crear Sede / Objetivo</h2>
                <p className="text-sm text-gray-500">Defina la ubicaci贸n f铆sica del servicio.</p>
            </div>
            <div><label className={labelClass}>Nombre del Objetivo</label><input className={inputClass} value={objData.name} onChange={e => setObjData({...objData, name: e.target.value})} required placeholder="Ej: Sucursal Centro" /></div>
            <div><label className={labelClass}>Direcci贸n</label><input className={inputClass} value={objData.address} onChange={e => setObjData({...objData, address: e.target.value})} required /></div>
            <div className="grid grid-cols-2 gap-4">
                <div><label className={labelClass}>Latitud</label><input type="number" className={inputClass} value={objData.latitude} onChange={e => setObjData({...objData, latitude: e.target.value})} required step="any"/></div>
                <div><label className={labelClass}>Longitud</label><input type="number" className={inputClass} value={objData.longitude} onChange={e => setObjData({...objData, longitude: e.target.value})} required step="any"/></div>
            </div>
            <button type="submit" disabled={loading} className={btnClass}>{loading ? 'Vinculando...' : 'Guardar y Continuar'}</button>
        </form>
      )}

      {step === 3 && (
        <form onSubmit={handleCreateContract} className="space-y-4 animate-fadeIn">
            <div className="border-b pb-4 mb-4">
                <h2 className="text-xl font-bold text-gray-800"> Paso 3: Definir Contrato</h2>
                <p className="text-sm text-gray-500">Establezca el acuerdo comercial y horas vendidas.</p>
            </div>
            <div><label className={labelClass}>Nombre del Servicio</label><input className={inputClass} value={contractData.name} onChange={e => setContractData({...contractData, name: e.target.value})} placeholder="Ej: Seguridad 24hs - 2025" required /></div>
            <div><label className={labelClass}>Horas Mensuales Vendidas</label><input type="number" className={inputClass} value={contractData.totalHoursPerMonth} onChange={e => setContractData({...contractData, totalHoursPerMonth: Number(e.target.value)})} required /></div>
            <button type="submit" disabled={loading} className={btnClass}>{loading ? 'Generando...' : 'Generar Contrato'}</button>
        </form>
      )}

      {step === 4 && (
        <div className="space-y-6 animate-fadeIn">
            <div className="text-center bg-green-50 p-4 rounded-lg border border-green-100">
                <h2 className="text-xl font-bold text-green-800">隆Estructura Base Creada!</h2>
                <p className="text-green-600 text-sm">Ahora define la "receta" de turnos (modalidades) para este contrato.</p>
            </div>

            <div className="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-inner">
                <h3 className="font-bold text-gray-700 mb-4 flex items-center">
                    <span className="bg-indigo-100 text-indigo-700 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">+</span>
                    Agregar Nueva Modalidad
                </h3>
                <div className="grid grid-cols-2 gap-4 mb-4">
                    <div><label className={labelClass}>Nombre</label><input className={inputClass} value={shiftData.name} onChange={e => setShiftData({...shiftData, name: e.target.value})} placeholder="Ej: Turno Tarde" /></div>
                    <div><label className={labelClass}>C贸digo</label><input className={inputClass} value={shiftData.code} onChange={e => setShiftData({...shiftData, code: e.target.value})} placeholder="TT" /></div>
                    <div><label className={labelClass}>Inicio (HH:mm)</label><input type="time" className={inputClass} value={shiftData.startTime} onChange={e => setShiftData({...shiftData, startTime: e.target.value})} /></div>
                    <div><label className={labelClass}>Duraci贸n (hs)</label><input type="number" className={inputClass} value={shiftData.durationHours} onChange={e => setShiftData({...shiftData, durationHours: Number(e.target.value)})} /></div>
                </div>
                <button 
                    onClick={handleCreateShiftType} 
                    disabled={loading || !shiftData.name} 
                    className="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition font-medium shadow-sm flex justify-center items-center"
                >
                    {loading ? 'Guardando...' : '+ Agregar Modalidad a la Lista'}
                </button>
            </div>

            {/* LISTA VISUAL DE LO CARGADO */}
            {addedShifts.length > 0 && (
                <div className="border rounded-lg overflow-hidden shadow-sm">
                    <div className="bg-gray-100 px-4 py-2 border-b font-semibold text-gray-700 text-sm flex justify-between items-center">
                        <span>Modalidades Cargadas</span>
                        <span className="bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full text-xs">{addedShifts.length}</span>
                    </div>
                    <ul className="divide-y divide-gray-100 bg-white">
                        {addedShifts.map((shift, index) => (
                            <li key={index} className="px-4 py-3 flex justify-between items-center text-sm hover:bg-gray-50">
                                <div>
                                    <span className="font-bold text-gray-800">{shift.name}</span>
                                    <span className="ml-2 text-gray-500 font-mono text-xs">({shift.code})</span>
                                </div>
                                <div className="text-gray-600 bg-gray-100 px-2 py-1 rounded">
                                    {shift.startTime} <span className="mx-1"></span> {shift.durationHours}hs
                                </div>
                            </li>
                        ))}
                    </ul>
                </div>
            )}
            
            <button onClick={handleFinish} className="w-full border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 font-bold transition mt-4 shadow-sm">
                Finalizar y Volver al Dashboard
            </button>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\employee-management.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { callManageEmployees, callCreateUser } from '@/services/firebase-client.service';
import { IEmployee } from '@/common/interfaces/employee.interface'; // 锔 Aseg煤rate de actualizar esta interfaz en web tambi茅n
import toast from 'react-hot-toast';
import { useClient } from '@/context/ClientContext'; 
import InputField from '@/components/common/InputField';
import SelectField from '@/components/common/SelectField';

export function EmployeeManagement() {
  const { clients, selectedClientId } = useClient(); // Acceso al contexto multi-empresa
  const [employees, setEmployees] = useState<IEmployee[]>([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);

  // Estado del Formulario Extendido
  const [formData, setFormData] = useState({
    uid: '',
    name: '',
    email: '',
    password: '',
    role: 'employee',
    maxHoursPerMonth: 176,
    contractType: 'FullTime',
    isAvailable: true,
    //  Nuevos campos
    clientId: '', 
    dni: '',
    fileNumber: '',
    address: ''
  });

  // Cargar empleados (Filtrados por la empresa seleccionada)
  const fetchEmployees = async () => {
    // Si no hay empresa seleccionada, no cargamos nada
    if (!selectedClientId) {
        setEmployees([]);
        setLoading(false);
        return;
    }

    setLoading(true);
    try {
      //  Enviamos el filtro clientId al backend
      const res = await callManageEmployees({ 
          action: 'GET_ALL_EMPLOYEES', 
          payload: { clientId: selectedClientId } 
      });
      const data = (res.data as any).data || [];
      setEmployees(data);
    } catch (error) {
      console.error(error);
      toast.error("Error al cargar empleados.");
    } finally {
      setLoading(false);
    }
  };

  // Recargar autom谩ticamente cuando cambia la empresa en el Sidebar
  useEffect(() => {
    fetchEmployees();
  }, [selectedClientId]);

  // Abrir modal para CREAR
  const handleOpenCreate = () => {
    setFormData({ 
        uid: '', name: '', email: '', password: '', role: 'employee', 
        maxHoursPerMonth: 176, contractType: 'FullTime', isAvailable: true,
        //  Pre-seleccionamos la empresa actual
        clientId: selectedClientId || '', 
        dni: '', fileNumber: '', address: ''
    });
    setIsEditing(false);
    setShowModal(true);
  };

  // Abrir modal para EDITAR
  const handleOpenEdit = (emp: IEmployee) => {
    setFormData({
        uid: emp.uid,
        name: emp.name,
        email: emp.email,
        password: '', // No editamos password aqu铆
        role: emp.role as string,
        maxHoursPerMonth: emp.maxHoursPerMonth || 176,
        contractType: emp.contractType || 'FullTime',
        isAvailable: emp.isAvailable,
        //  Mapear nuevos campos (con fallback por si son registros viejos)
        clientId: emp.clientId || '',
        dni: emp.dni || '',
        fileNumber: emp.fileNumber || '',
        address: emp.address || ''
    });
    setIsEditing(true);
    setShowModal(true);
  };

  // Guardar (Crear o Editar)
  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!formData.clientId) {
        toast.error("Debe asignar una empresa al empleado.");
        return;
    }

    const toastId = toast.loading(isEditing ? "Actualizando..." : "Creando usuario...");

    try {
      if (isEditing) {
        // EDITAR: Enviamos payload completo a manageEmployees (UPDATE_EMPLOYEE)
        const updatePayload = {
            name: formData.name,
            role: formData.role,
            maxHoursPerMonth: Number(formData.maxHoursPerMonth),
            contractType: formData.contractType,
            isAvailable: formData.isAvailable,
            clientId: formData.clientId,
            dni: formData.dni,
            fileNumber: formData.fileNumber,
            address: formData.address
        };
        await callManageEmployees({ action: 'UPDATE_EMPLOYEE', payload: { uid: formData.uid, data: updatePayload } });
        toast.success("Empleado actualizado", { id: toastId });
      } else {
        // CREAR: Usamos createUser (Auth + Firestore) con los nuevos campos
        await callCreateUser({ 
            email: formData.email, 
            password: formData.password, 
            name: formData.name, 
            role: formData.role,
            //  Enviamos nuevos datos
            clientId: formData.clientId,
            dni: formData.dni,
            fileNumber: formData.fileNumber,
            address: formData.address
        });
        toast.success("Usuario creado con 茅xito", { id: toastId });
      }
      
      setShowModal(false);
      fetchEmployees();

    } catch (error: any) {
      console.error(error);
      toast.error(`Error: ${error.message}`, { id: toastId });
    }
  };

  const handleDelete = async (uid: string) => {
    if (!confirm("驴Eliminar este empleado? Esta acci贸n borrar谩 su acceso.")) return;
    try {
        await callManageEmployees({ action: 'DELETE_EMPLOYEE', payload: { uid } });
        toast.success("Empleado eliminado");
        fetchEmployees();
    } catch (error) {
        toast.error("Error al eliminar");
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-xl font-bold text-gray-800">N贸mina de Personal</h2>
            <p className="text-sm text-gray-500">
                {selectedClientId ? 'Gestionando empleados de la empresa seleccionada.' : 'Seleccione una empresa para ver sus empleados.'}
            </p>
        </div>
        <button 
            onClick={handleOpenCreate} 
            disabled={!selectedClientId} 
            className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
        >
            <span className="mr-2">+</span> Nuevo Empleado
        </button>
      </div>

      {/* Tabla */}
      <div className="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
        <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                    <tr>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Nombre / Legajo</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">DNI / Direcci贸n</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Rol</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Estado</th>
                        <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Acciones</th>
                    </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                    {employees.map((emp) => (
                        <tr key={emp.uid} className="hover:bg-gray-50">
                            <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm font-bold text-gray-900">{emp.name}</div>
                                <div className="text-xs text-gray-500">Leg: {emp.fileNumber || '-'}</div>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm text-gray-900">{emp.dni || '-'}</div>
                                <div className="text-xs text-gray-500 truncate max-w-[150px]" title={emp.address}>{emp.address || '-'}</div>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap">
                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${emp.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}`}>
                                    {emp.role}
                                </span>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm">
                                {emp.isAvailable ? <span className="text-green-600 font-bold">Activo</span> : <span className="text-red-500">Inactivo</span>}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onClick={() => handleOpenEdit(emp)} className="text-indigo-600 hover:text-indigo-900 mr-4">Editar</button>
                                <button onClick={() => handleDelete(emp.uid)} className="text-red-600 hover:text-red-900">Eliminar</button>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
            {!loading && employees.length === 0 && <div className="p-8 text-center text-gray-500">No hay empleados registrados en esta empresa.</div>}
        </div>
      </div>

      {/* Modal Formulario */}
      {showModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-xl max-w-2xl w-full p-6">
                <h3 className="text-lg font-bold text-gray-900 mb-4">{isEditing ? 'Editar Empleado' : 'Nuevo Empleado'}</h3>
                
                <form onSubmit={handleSave} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    {/* Secci贸n 1: Datos Personales */}
                    <div className="md:col-span-2 border-b pb-2 mb-2">
                        <h4 className="text-sm font-semibold text-gray-500 uppercase">Datos Personales</h4>
                    </div>

                    <InputField label="Nombre Completo" id="name" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required />
                    
                    <InputField label="DNI" id="dni" value={formData.dni} onChange={e => setFormData({...formData, dni: e.target.value})} required placeholder="Sin puntos" />
                    
                    <div className="md:col-span-2">
                        <InputField label="Direcci贸n" id="address" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} required />
                    </div>

                    {/* Secci贸n 2: Datos de Cuenta */}
                    <div className="md:col-span-2 border-b pb-2 mb-2 mt-2">
                        <h4 className="text-sm font-semibold text-gray-500 uppercase">Cuenta y Acceso</h4>
                    </div>

                    {!isEditing && (
                        <>
                            <InputField label="Email" id="email" type="email" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required />
                            <InputField label="Contrase帽a" id="password" type="password" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} required />
                        </>
                    )}

                    {/* Secci贸n 3: Datos Laborales */}
                    <div className="md:col-span-2 border-b pb-2 mb-2 mt-2">
                        <h4 className="text-sm font-semibold text-gray-500 uppercase">Datos Laborales</h4>
                    </div>

                    <SelectField label="Empresa" id="clientId" value={formData.clientId} onChange={e => setFormData({...formData, clientId: e.target.value})} required>
                        <option value="" disabled>Seleccione empresa...</option>
                        {clients.map(c => <option key={c.id} value={c.id}>{c.businessName}</option>)}
                    </SelectField>

                    <InputField label="Nro. Legajo" id="fileNumber" value={formData.fileNumber} onChange={e => setFormData({...formData, fileNumber: e.target.value})} required />

                    <SelectField label="Rol" id="role" value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})}>
                        <option value="employee">Empleado</option>
                        <option value="admin">Administrador</option>
                    </SelectField>

                    <SelectField label="Contrato" id="contract" value={formData.contractType} onChange={e => setFormData({...formData, contractType: e.target.value})}>
                        <option value="FullTime">Full Time</option>
                        <option value="PartTime">Part Time</option>
                        <option value="Eventual">Eventual</option>
                    </SelectField>

                    <InputField label="L铆mite Horas Mensual" id="maxHours" type="number" value={formData.maxHoursPerMonth} onChange={e => setFormData({...formData, maxHoursPerMonth: Number(e.target.value)})} required />

                    <div className="md:col-span-2 flex justify-end space-x-3 mt-6 border-t pt-4">
                        <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
                        <button type="submit" className="px-4 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\GeocodingSelector.tsx
================================================================================
import React, { useState } from 'react';
import toast from 'react-hot-toast';

interface GeocodingSelectorProps {
  address: string;
  onCoordinatesSelected: (lat: string, lng: string) => void;
  onClose: () => void;
  isOpen: boolean;
}

/**
 * Componente Modal para buscar coordenadas geogr谩ficas a partir de una direcci贸n.
 * Utiliza la API de Geocodificaci贸n de Google Maps.
 */
export const GeocodingSelector: React.FC<GeocodingSelectorProps> = ({ address, onCoordinatesSelected, onClose, isOpen }) => {
  const [loading, setLoading] = useState(false);
  // Acceso seguro a la clave de API configurada en .env.local
  const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY; 

  if (!isOpen) return null;

  /**
   * Fetches coordinates for the given address using Google's Geocoding API.
   */
  const fetchCoordinates = async () => {
    if (!address.trim()) {
      toast.error("Ingrese una direcci贸n v谩lida para buscar.");
      return;
    }
    // Verificaci贸n de seguridad
    if (!apiKey || apiKey.trim() === '') {
      toast.error("Error: Falta la clave de Google Maps (NEXT_PUBLIC_GOOGLE_MAPS_API_KEY).");
      console.error("GeocodingSelector: Missing Google Maps API Key.");
      return;
    }

    setLoading(true);
    const encodedAddress = encodeURIComponent(address);
    const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${apiKey}`;

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (data.status === 'OK' && data.results.length > 0) {
        const { lat, lng } = data.results[0].geometry.location;
        
        // Mantenemos la alta precisi贸n para el estado del formulario
        const latString = lat.toFixed(6); 
        const lngString = lng.toFixed(6);

        onCoordinatesSelected(latString, lngString);
        toast.success(`Coordenadas asignadas a: ${address}`);
        onClose();
      } else {
        toast.error("No se encontraron coordenadas para la direcci贸n proporcionada.");
      }
    } catch (error) {
      console.error("Error al consultar la API de Google:", error);
      toast.error("Error de red al buscar coordenadas.");
    } finally {
      setLoading(false);
    }
  };
  
  // Estructura del Modal (usando Tailwind)
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <h3 className="text-xl font-bold mb-4 text-gray-800">Buscar Coordenadas</h3>
        <p className="text-sm text-gray-600 mb-4">
          Direcci贸n a buscar: <span className="font-semibold text-indigo-600">{address}</span>
        </p>
        
        <button
          onClick={fetchCoordinates}
          disabled={loading || !address.trim()}
          className={`w-full py-2 px-4 rounded-md text-white font-medium transition duration-200 ${
            loading || !address.trim() ? 'bg-indigo-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'
          }`}
        >
          {loading ? 'Buscando...' : 'Confirmar B煤squeda en Mapa'}
        </button>
        
        <button
          onClick={onClose}
          className="mt-3 w-full py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-200"
        >
          Cancelar
        </button>
      </div>
    </div>
  );
};

================================================================================
FILE: apps\web\src\components\admin\login-form.tsx
================================================================================
import React, { useState } from 'react';
import { useRouter } from 'next/router';
import { signInWithEmailAndPassword } from 'firebase/auth';
import { auth } from '@/services/firebase-client.service';

export function LoginForm() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  // Colores personalizados basados en la imagen de referencia (Rojo ATM)
  const colors = {
    primary: '#a81d1d', // Rojo intenso
    primaryHover: '#8c1818',
    bgInput: '#eff4fc', // Fondo azul muy claro de los inputs
    textGray: '#6b7280',
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      await signInWithEmailAndPassword(auth, email, password);
      router.push('/admin/dashboard');
    } catch (err: any) {
        console.error(err);
        if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
            setError('Credenciales incorrectas. Verifique email y contrase帽a.');
        } else if (err.code === 'auth/too-many-requests') {
            setError('Demasiados intentos. Por favor espere unos minutos.');
        } else {
            setError('Error al iniciar sesi贸n. Intente nuevamente.');
        }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="w-full max-w-md mx-auto">
      {/* Tarjeta de Login con sombra suave y bordes redondeados */}
      <div className="bg-white shadow-xl rounded-3xl px-8 pt-10 pb-12 mb-4 border border-gray-50 relative overflow-hidden">
        
        {/* Logo (Placeholder textual, puedes reemplazar por una etiqueta <img> si tienes el logo en /public) */}
        <div className="text-center mb-8">
            <div className="inline-flex flex-col items-center justify-center mb-4">
                {/* Icono/Logo Simulado en Rojo */}
                <div className="bg-red-50 p-3 rounded-full">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" style={{ color: colors.primary }} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                  </svg>
                </div>
                <h2 className="text-2xl font-extrabold text-gray-900 mt-4">Sistema de Gesti贸n</h2>
            </div>
            <p className="text-sm text-gray-500">Inicia sesi贸n para acceder al panel.</p>
        </div>
        
        <form onSubmit={handleSubmit}>
            {/* Banner de Error Estilizado */}
            {error && (
                <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r-md animate-pulse">
                    <div className="flex items-center">
                        <svg className="h-5 w-5 text-red-500 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                        </svg>
                        <p className="text-sm text-red-700 font-medium">{error}</p>
                    </div>
                </div>
            )}
            
            {/* Input Email con Icono */}
            <div className="mb-5 relative">
              <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                  <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                </svg>
              </div>
              <input
                className="appearance-none rounded-xl w-full py-4 pl-12 pr-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-200 transition duration-200 font-medium placeholder-gray-400"
                style={{ backgroundColor: colors.bgInput, border: '1px solid transparent' }}
                id="email"
                type="email"
                placeholder="admin@bacarsa.com.ar"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
              />
            </div>

            {/* Input Password con Icono */}
            <div className="mb-8 relative">
              <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                 <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
                  </svg>
              </div>
              <input
                className="appearance-none rounded-xl w-full py-4 pl-12 pr-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-200 transition duration-200 font-medium placeholder-gray-400 tracking-widest"
                style={{ backgroundColor: colors.bgInput, border: '1px solid transparent' }}
                id="password"
                type="password"
                placeholder="⑩⑩⑩⑩⑩⑩⑩"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
              />
            </div>

            {/* Bot贸n Submit */}
            <button
                className={`w-full text-white font-bold py-4 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-300 flex justify-center items-center text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
                style={{ backgroundColor: loading ? colors.primaryHover : colors.primary }}
                type="submit"
                disabled={loading}
            >
                {loading ? (
                    <>
                        <svg className="animate-spin -ml-1 mr-3 h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Accediendo...
                    </>
                ) : 'Acceder al Sistema'}
            </button>
        </form>
      </div>
      
      <p className="text-center text-gray-400 text-sm mt-6 font-medium">
        Ver 3.0 Beta
      </p>
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\new.tsx
================================================================================
import React from 'react';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { DashboardLayout } from '@/components/layout/DashboardLayout';
import { ClientSetupWizard } from '@/components/admin/client-setup-wizard';

function NewClientPage() {
  return (
    <DashboardLayout title="Alta de Cliente y Servicio">
      <div className="py-6">
        <ClientSetupWizard />
      </div>
    </DashboardLayout>
  );
}

export default withAuthGuard(NewClientPage as any, 'admin');

================================================================================
FILE: apps\web\src\components\admin\objective-management.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/router'; //  NECESARIO para la navegaci贸n de la tabla
import { callManageData } from '@/services/firebase-client.service';
import { IObjective } from '@/common/interfaces/client.interface';
import { useClient } from '@/context/ClientContext';
import toast from 'react-hot-toast';
import { GeocodingSelector } from './GeocodingSelector'; 
import styles from './ObjectiveManagement.module.css'; // Para cumplir con Next.js


// -- 1. INTERFACES Y CONSTANTES (Sin cambios) --
interface ObjectiveFormState {
  name: string;
  address: string;
  latitude: string; 
  longitude: string;
}

const STYLES = {
    inputClass: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-200",
    readOnlyInputClass: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none bg-gray-50 text-gray-500 cursor-not-allowed sm:text-sm transition duration-200",
    labelClass: "block text-sm font-medium text-gray-700",
    buttonDisabled: "opacity-70 cursor-not-allowed",
    buttonActive: "hover:bg-indigo-700",
};

const cleanAndParseCoordinate = (coordString: string): number => {
    const cleanedString = coordString.trim().replace(',', '.'); 
    return parseFloat(cleanedString);
};


export function ObjectiveManagement() {
  const router = useRouter(); //  Instancia del router
  const { selectedClientId, selectedClient } = useClient();

  const [objectives, setObjectives] = useState<IObjective[]>([]);
  const [isSelectorOpen, setIsSelectorOpen] = useState(false); 
  
  const [formData, setFormData] = useState<ObjectiveFormState>({
    name: '', address: '', latitude: '', longitude: '',
  });
  
  const [loading, setLoading] = useState(false);
  const [submitting, setSubmitting] = useState(false);

  /**
   * Carga de objetivos.
   */
  const fetchObjectives = async () => {
    if (!selectedClientId) {
        setObjectives([]);
        return;
    }
    setLoading(true);
    try {
      const result = await callManageData({ 
          action: 'GET_ALL_OBJECTIVES', 
          payload: { clientId: selectedClientId } 
      });
      const response = result.data as { success: boolean, data: IObjective[] };
      setObjectives(response.data || []);
      
    } catch (error) {
      console.error('[ObjectiveManagement] Fetch Error:', error);
      toast.error("Error al cargar objetivos");
    } finally { 
      setLoading(false); 
    }
  };

  useEffect(() => {
    fetchObjectives();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedClientId]);

  /**
   * Maneja el cambio en los inputs name y address.
   */
  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    if (name === 'name' || name === 'address') {
        setFormData(prev => ({ ...prev, [name]: value }));
    }
  };

  /**
   * Callback que recibe las coordenadas desde el GeocodingSelector y actualiza el estado.
   */
  const handleCoordinatesSelected = (lat: string, lng: string) => {
      setFormData(prev => ({
          ...prev,
          latitude: lat,
          longitude: lng,
      }));
      setIsSelectorOpen(false); // Cerramos el modal
  };

  /**
   * Valida y env铆a la creaci贸n del objetivo.
   */
  const handleCreateObjective = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // 1. Pre-Submission Checks
    if (!selectedClientId) {
        toast.error("锔 Debe seleccionar una empresa en el men煤 lateral.");
        return;
    }
    
    // Chequeo estricto de todos los campos obligatorios
    if (!formData.name.trim() || 
        !formData.address.trim() ||
        !formData.latitude.trim() || 
        !formData.longitude.trim() 
    ) {
        toast.error("Complete todos los campos obligatorios: Nombre, Direcci贸n y Coordenadas.");
        return;
    }
    
    // 2. Parsing y Validaci贸n
    const lat = cleanAndParseCoordinate(formData.latitude);
    const lng = cleanAndParseCoordinate(formData.longitude);

    if (isNaN(lat) || isNaN(lng)) { 
        toast.error("Las coordenadas deben ser n煤meros v谩lidos (ej: -34.60)."); 
        return; 
    }

    // 3. Submission Logic
    setSubmitting(true);
    try {
      const payload = { 
          name: formData.name.trim(),
          address: formData.address.trim(),
          clientId: selectedClientId,
          location: { latitude: lat, longitude: lng } 
      };
      
      await callManageData({ action: 'CREATE_OBJECTIVE', payload });
      
      toast.success(`Objetivo "${formData.name}" creado para ${selectedClient?.businessName}`);
      setFormData({ name: '', address: '', latitude: '', longitude: '' });
      fetchObjectives();

    } catch (error) { 
        console.error('[ObjectiveManagement] Create Error:', error);
        toast.error("Error al crear el objetivo."); 
    } finally { 
        setSubmitting(false); 
    }
  };


  return (
    <div className="space-y-8">
      {/* --- FORMULARIO (Secci贸n 1) --- */}
      <div className="bg-white shadow-lg rounded-2xl p-6 border border-gray-200">
        {/* ... Header del formulario ... */}
        
        <form onSubmit={handleCreateObjective} noValidate className="space-y-4">
          <div>
            <label className={STYLES.labelClass}>Nombre de la Sucursal/Puesto</label>
            <input 
                type="text" 
                name="name" 
                value={formData.name} 
                onChange={handleInputChange} 
                className={STYLES.inputClass} 
                placeholder="Ej: Casa Central" 
            />
          </div>
          <div>
            <label className={STYLES.labelClass}>Direcci贸n F铆sica</label>
            <input 
                type="text" 
                name="address" 
                value={formData.address} 
                onChange={handleInputChange} 
                className={STYLES.inputClass} 
                placeholder="Av. Siempreviva 742" 
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
                <label className={STYLES.labelClass}>Latitud</label>
                <input 
                    type="number" 
                    name="latitude" 
                    value={formData.latitude} 
                    onChange={handleInputChange} 
                    className={STYLES.readOnlyInputClass} 
                    readOnly={true} // Deshabilitar escritura manual
                    step="any" 
                    placeholder="Asignar con el bot贸n" 
                />
            </div>
            <div>
                <label className={STYLES.labelClass}>Longitud</label>
                <input 
                    type="number" 
                    name="longitude" 
                    value={formData.longitude} 
                    onChange={handleInputChange} 
                    className={STYLES.readOnlyInputClass} 
                    readOnly={true} // Deshabilitar escritura manual
                    step="any" 
                    placeholder="Asignar con el bot贸n" 
                />
            </div>
          </div>
          
          {/* Bot贸n para Activar la B煤squeda de Coordenadas */}
          <button 
              type="button" 
              onClick={() => setIsSelectorOpen(true)}
              disabled={!formData.address.trim()} 
              className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none transition duration-200 
                  ${!formData.address.trim() ? 'opacity-70 cursor-not-allowed' : ''}`}
          >
              Buscar/Asignar Coordenadas (Paso 1)
          </button>

          {/* Bot贸n Final de Creaci贸n */}
          <button 
            type="submit" 
            disabled={submitting || !selectedClientId || !formData.latitude.trim()} 
            className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 focus:outline-none transition duration-200 
                ${submitting || !selectedClientId || !formData.latitude.trim() ? STYLES.buttonDisabled : STYLES.buttonActive}`}
          >
            {submitting ? 'Guardando...' : 'Crear Objetivo (Paso 2)'}
          </button>
        </form>
      </div>

      {/* INTEGRACIN DEL MODAL DE GEOCODIFICACIN */}
      <GeocodingSelector 
          address={formData.address}
          isOpen={isSelectorOpen}
          onClose={() => setIsSelectorOpen(false)}
          onCoordinatesSelected={handleCoordinatesSelected}
      />
      
      {/* --- LISTADO DE OBJETIVOS (Secci贸n 2) --- */}
      <div className={`${styles.objectiveListCard} bg-white shadow-lg rounded-2xl overflow-hidden border border-gray-200`}>
        <div className="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
            <h3 className="text-lg font-bold text-gray-800">
                Objetivos de {selectedClient?.businessName || '...'}
            </h3>
            <span className="bg-gray-100 text-gray-600 py-1 px-3 rounded-full text-xs font-bold">{objectives.length}</span>
        </div>
        {loading ? <div className="p-6 text-center text-gray-500">Cargando datos...</div> : (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-100">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Nombre y Ubicaci贸n</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {objectives.length === 0 ? (
                    <tr><td className="px-6 py-8 text-center text-sm text-gray-500 italic">No hay objetivos registrados para esta empresa.</td></tr>
                ) : (
                    objectives.map((obj) => (
                    <tr 
                        key={obj.id} 
                        //  FIX DE NAVEGACIN: Hace la fila clickeable para ver detalles
                        className="hover:bg-gray-50 transition duration-150 cursor-pointer" 
                        onClick={() => router.push(`/admin/objective-detail/${obj.id}`)} 
                    >
                        <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center">
                            <div className="flex-shrink-0 h-10 w-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
                                <span className="font-bold text-lg">{obj.name.charAt(0).toUpperCase()}</span>
                            </div>
                            <div className="ml-4">
                            <div className="text-sm font-bold text-gray-900">{obj.name}</div>
                            <div className="text-sm text-gray-500">{obj.address}</div>
                            <div className="text-xs text-indigo-400 font-mono mt-1">
                                ({obj.location?.latitude?.toFixed(4) || 'N/A'}, {obj.location?.longitude?.toFixed(4) || 'N/A'})
                            </div>
                            </div>
                        </div>
                        </td>
                    </tr>
                    ))
                )}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

export default ObjectiveManagement;

================================================================================
FILE: apps\web\src\components\admin\scheduler.tsx
================================================================================
import React, { useState, useEffect, useRef } from 'react';
import FullCalendar from '@fullcalendar/react';
import dayGridPlugin from '@fullcalendar/daygrid';
import timeGridPlugin from '@fullcalendar/timegrid';
import interactionPlugin, { Draggable } from '@fullcalendar/interaction';
import { Timestamp } from 'firebase/firestore';
import toast from 'react-hot-toast';

import { 
    callScheduleShift, 
    getObjectiveShifts, 
    callManageData, 
    callManageEmployees,
    getActiveContract,
    callManageHierarchy 
} from '@/services/firebase-client.service';
import { IObjective, IShiftType } from '@/common/interfaces/client.interface';
import { IEmployee } from '@/common/interfaces/employee.interface';
import { useClient } from '@/context/ClientContext'; 

export function DragAndDropScheduler() {
  const { selectedClientId } = useClient();
  
  const [objectives, setObjectives] = useState<IObjective[]>([]);
  const [employees, setEmployees] = useState<IEmployee[]>([]);
  const [selectedObjective, setSelectedObjective] = useState<string>('');
  const [shifts, setShifts] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  
  // M茅tricas
  const [contractHours, setContractHours] = useState<number>(0);
  const [assignedHours, setAssignedHours] = useState<number>(0);
  const [shiftTypes, setShiftTypes] = useState<IShiftType[]>([]); 
  
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [pendingDrop, setPendingDrop] = useState<{
      employeeId: string;
      employeeName: string;
      startTime: Date;
      calendarApi: any;
      eventInstance: any;
  } | null>(null);

  const [isMobile, setIsMobile] = useState(false);
  const calendarRef = useRef<FullCalendar>(null);
  const draggableRef = useRef<HTMLDivElement>(null);

  // 1. Mobile Check
  useEffect(() => {
    const checkMobile = () => setIsMobile(window.innerWidth < 1024);
    checkMobile(); 
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // 2. Cargar Datos Iniciales
  useEffect(() => {
    async function loadAllData() {
        setLoading(true);
        if (!selectedClientId) {
            setEmployees([]);
            setObjectives([]);
            setSelectedObjective('');
            setLoading(false);
            return;
        }
        try {
            const empRes = await callManageEmployees({ action: 'GET_ALL_EMPLOYEES', payload: { clientId: selectedClientId } });
            setEmployees((empRes.data as any).data || []);
            
            const objRes = await callManageData({ action: 'GET_ALL_OBJECTIVES', payload: { clientId: selectedClientId } });
            const objData = (objRes.data as any).data || [];
            setObjectives(objData);
            
            if (objData.length > 0) setSelectedObjective(objData[0].id);
            else setSelectedObjective('');
        } catch (e) {
            console.error(e);
            toast.error("Error al cargar datos.");
        } finally { setLoading(false); }
    }
    loadAllData();
  }, [selectedClientId]); 

  // 3. Cargar Contrato y Tipos de Turno
  useEffect(() => {
    if (!selectedObjective) {
        setShifts([]);
        setContractHours(0);
        setAssignedHours(0);
        setShiftTypes([]); 
        return;
    }
    setLoading(true);
    
    // A. Buscar Contrato y sus Modalidades
    getActiveContract(selectedObjective).then(async (contract) => {
        if (contract) {
            setContractHours(contract.totalHours);
            // Buscar los tipos de turno de este contrato
            try {
                const typesRes = await callManageHierarchy({ 
                    action: 'GET_SHIFT_TYPES', 
                    payload: { contractId: contract.id } 
                });
                //  CORRECCIN CRTICA: Accedemos a .data.data para obtener el array
                const responseData = typesRes.data as any;
                setShiftTypes(responseData.data || []);
            } catch (error) {
                console.error("Error loading shift types", error);
                setShiftTypes([]);
            }
        } else {
            setContractHours(0);
            setShiftTypes([]);
        }
    });

    // B. Cargar Turnos Existentes
    getObjectiveShifts(selectedObjective).then((data) => {
      let totalDuration = 0;
      const calendarEvents = data.map(shift => {
        const start = (shift.startTime as any).toDate ? (shift.startTime as any).toDate() : new Date((shift.startTime as any).seconds * 1000);
        const end = (shift.endTime as any).toDate ? (shift.endTime as any).toDate() : new Date((shift.endTime as any).seconds * 1000);
        
        const duration = (end.getTime() - start.getTime()) / (1000 * 60 * 60);
        totalDuration += duration;

        return {
            id: shift.id,
            title: shift.employeeName,
            start, end,
            backgroundColor: shift.status === 'Completed' ? '#10B981' : '#3B82F6',
            extendedProps: { ...shift }
        };
      });
      setShifts(calendarEvents);
      setAssignedHours(totalDuration);
      setLoading(false);
    });
  }, [selectedObjective]);

  // 4. Draggable Cleanup
  useEffect(() => {
    const draggableEl = draggableRef.current;
    let draggableInstance: Draggable | null = null;
    if (draggableEl) {
      draggableInstance = new Draggable(draggableEl, {
        itemSelector: '.fc-event-external',
        eventData: function(eventEl) {
          return {
            title: eventEl.getAttribute('data-name'),
            extendedProps: {
                employeeId: eventEl.getAttribute('data-id'),
                employeeName: eventEl.getAttribute('data-name')
            }
          };
        }
      });
    }
    return () => { if (draggableInstance) draggableInstance.destroy(); };
  }, [employees]); 

  // 5. INTERCEPTOR
  const handleEventReceive = (info: any) => {
    const { event } = info;
    const { employeeId, employeeName } = event.extendedProps;
    
    if (!selectedObjective) {
        toast.error("Seleccione un objetivo.");
        info.revert(); 
        return;
    }

    setPendingDrop({
        employeeId,
        employeeName,
        startTime: event.start,
        calendarApi: info,
        eventInstance: event
    });
    
    setIsModalOpen(true);
  };

  // 6. CONFIRMACIN
  const handleConfirmAssignment = async (shiftType: IShiftType) => {
    if (!pendingDrop) return;
    setIsModalOpen(false);

    const { startTime, employeeId, employeeName, eventInstance } = pendingDrop;
    
    const endTime = new Date(startTime);
    endTime.setHours(endTime.getHours() + shiftType.durationHours);

    const toastId = toast.loading(`Asignando ${shiftType.name}...`);

    try {
        const shiftData = {
            employeeId,
            employeeName,
            objectiveId: selectedObjective,
            objectiveName: objectives.find(o => o.id === selectedObjective)?.name || 'Unknown',
            startTime: Timestamp.fromDate(startTime),
            endTime: Timestamp.fromDate(endTime),
            shiftTypeId: shiftType.id 
        };

        await callScheduleShift(shiftData);
        
        toast.success("Turno asignado", { id: toastId });
        
        eventInstance.setProp('backgroundColor', shiftType.color || '#4F46E5');
        eventInstance.setEnd(endTime); 
        
        setAssignedHours(prev => prev + shiftType.durationHours);

    } catch (error: any) {
        console.error(error);
        toast.error(error.message || 'Error al asignar.', { id: toastId });
        pendingDrop.calendarApi.revert(); 
    } finally {
        setPendingDrop(null);
    }
  };

  const handleCancelAssignment = () => {
      setIsModalOpen(false);
      if (pendingDrop) pendingDrop.calendarApi.revert();
      setPendingDrop(null);
  };

  const getProgressColor = () => {
      if (contractHours === 0) return 'bg-gray-300';
      const percentage = (assignedHours / contractHours) * 100;
      if (percentage > 100) return 'bg-red-500 animate-pulse';
      if (percentage > 95) return 'bg-green-500';
      return 'bg-yellow-400';
  };
  const coveragePercent = contractHours > 0 ? Math.min((assignedHours / contractHours) * 100, 100) : 0;

  return (
    <div className="flex flex-col gap-4 h-[calc(100vh-140px)] relative">
      
      {/* HEADER + SMART BAR */}
      <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col gap-4 shrink-0">
        <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
            <div>
                <h3 className="text-lg font-bold text-slate-800">Planificador</h3>
                <p className="text-sm text-slate-500 hidden sm:block">Operaciones.</p>
            </div>
            <div className="w-full sm:w-1/3">
                <select 
                    value={selectedObjective} 
                    onChange={(e) => setSelectedObjective(e.target.value)}
                    className="w-full border-slate-300 rounded-lg shadow-sm py-2 text-sm"
                    disabled={objectives.length === 0}
                >
                    {objectives.length === 0 ? <option value="" disabled>Sin objetivos</option> : objectives.map(obj => <option key={obj.id} value={obj.id}>{obj.name}</option>)}
                </select>
            </div>
        </div>
        {contractHours > 0 && (
            <div className="w-full bg-slate-100 rounded-full h-6 relative overflow-hidden border border-slate-200">
                <div className={`h-full transition-all duration-500 flex items-center justify-end pr-2 text-xs font-bold text-white shadow-sm ${getProgressColor()}`} style={{ width: `${coveragePercent}%` }}>
                    {coveragePercent.toFixed(0)}%
                </div>
                <div className="absolute inset-0 flex items-center justify-center text-xs font-semibold text-slate-600">
                    {assignedHours.toFixed(1)} / {contractHours} hs
                </div>
            </div>
        )}
      </div>

      {/* CALENDARIO + LISTA */}
      <div className="flex flex-col lg:flex-row gap-4 flex-1 overflow-hidden">
        <div className={`w-full lg:w-1/5 bg-white p-4 rounded-xl shadow-sm border border-slate-200 overflow-y-auto flex flex-col ${isMobile ? 'h-48 order-2' : 'h-full order-1'}`} ref={draggableRef}>
            <div className="mb-3 shrink-0"><h4 className="font-bold text-slate-700 text-sm">Colaboradores</h4></div>
            <div className="space-y-2 flex-1 overflow-y-auto pr-1">
                {employees.map((emp) => (
                    <div key={emp.uid} data-id={emp.uid} data-name={emp.name} className="fc-event-external p-2.5 bg-white border border-slate-200 rounded-lg cursor-grab hover:border-indigo-400 hover:shadow-md transition-all flex items-center space-x-3 shadow-sm select-none">
                        <div className="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-xs shrink-0 border border-indigo-100">{emp.name.charAt(0)}</div>
                        <div className="overflow-hidden"><p className="text-xs font-bold text-slate-700 truncate">{emp.name}</p><p className="text-[10px] text-slate-500 truncate">{emp.role}</p></div>
                    </div>
                ))}
            </div>
        </div>

        <div className={`w-full lg:w-4/5 bg-white p-2 rounded-xl shadow-sm border border-slate-200 relative ${isMobile ? 'h-full order-1' : 'order-2'}`}>
            <FullCalendar
                ref={calendarRef}
                plugins={[dayGridPlugin, timeGridPlugin, interactionPlugin]}
                initialView={isMobile ? "timeGridDay" : "timeGridWeek"}
                headerToolbar={{ left: isMobile ? 'prev,next' : 'prev,next today', center: 'title', right: isMobile ? 'dayGridMonth,timeGridDay' : 'dayGridMonth,timeGridWeek' }}
                slotMinTime="06:00:00"
                slotMaxTime="23:00:00"
                allDaySlot={false}
                height="100%"
                locale="es"
                editable={true}
                droppable={true}
                events={shifts}
                eventReceive={handleEventReceive}
                longPressDelay={500}
                eventContent={(arg) => (
                    <div className="text-xs p-0.5 overflow-hidden">
                        <div className="font-bold truncate">{arg.event.title}</div>
                        {!isMobile && <div className="text-[10px] opacity-90">{arg.timeText}</div>}
                    </div>
                )}
            />
        </div>
      </div>

      {/*  MODAL DE SELECCIN DE TURNO */}
      {isModalOpen && (
        <div className="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm rounded-xl">
            <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 border border-slate-100 transform transition-all scale-100">
                <h3 className="text-lg font-bold text-slate-800 mb-2">Asignar a {pendingDrop?.employeeName}</h3>
                <p className="text-sm text-slate-500 mb-4">Seleccione la modalidad:</p>
                
                <div className="space-y-2 mb-6 max-h-60 overflow-y-auto">
                    {shiftTypes.length === 0 ? (
                        <p className="text-sm text-orange-500 bg-orange-50 p-3 rounded-lg">锔 No hay modalidades configuradas. Se asignar谩 8hs.</p>
                    ) : (
                        shiftTypes.map(type => (
                            <button 
                                key={type.id}
                                onClick={() => handleConfirmAssignment(type)}
                                className="w-full flex items-center justify-between p-3 rounded-xl border border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all group"
                            >
                                <span className="font-semibold text-slate-700 group-hover:text-indigo-700">{type.name}</span>
                                <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded group-hover:bg-white">{type.durationHours}hs</span>
                            </button>
                        ))
                    )}
                    {/* Opci贸n Default */}
                    <button 
                        onClick={() => handleConfirmAssignment({ id: 'default', name: 'Turno Est谩ndar', durationHours: 8, code: 'STD', color: '#6366f1', contractId: '', startTime: '08:00' })}
                        className="w-full text-center text-sm text-slate-400 hover:text-slate-600 mt-2 underline"
                    >
                        Usar est谩ndar (8hs)
                    </button>
                </div>

                <button onClick={handleCancelAssignment} className="w-full py-3 text-slate-600 font-bold hover:bg-slate-50 rounded-xl transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\shift-assignment-form.tsx
================================================================================
import React, { useState } from 'react';
import { callScheduleShift } from '@/services/firebase-client.service';
import { Timestamp } from 'firebase/firestore'; 

export function ShiftAssignmentForm() {
  const [employeeId, setEmployeeId] = useState('user_id_cajero_001'); // Placeholder
  const [objectiveId, setObjectiveId] = useState('obj_id_sucursal_centro'); // Placeholder
  const [startTime, setStartTime] = useState(''); 
  const [endTime, setEndTime] = useState('');
  const [message, setMessage] = useState<{ text: string, type: 'success' | 'error' } | null>(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setMessage(null);
    setLoading(true);

    try {
      const shiftData = {
        employeeId,
        objectiveId,
        startTime: Timestamp.fromDate(new Date(startTime)), 
        endTime: Timestamp.fromDate(new Date(endTime)),
      };

      const result = await callScheduleShift(shiftData);
      const data = result.data as { success: boolean, shiftId: string, message: string };
      setMessage({ text: data.message || "Turno asignado correctamente", type: 'success' });
      
    } catch (err: any) {
      const errorMessage = err.details || err.message;
      setMessage({ text: `Error: ${errorMessage}`, type: 'error' });
    } finally {
      setLoading(false);
    }
  };

  const inputClass = "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm";
  const labelClass = "block text-sm font-medium text-gray-700";

  return (
    <div className="space-y-6">
      {message && (
        <div className={`p-4 rounded-md ${message.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
          {message.text}
        </div>
      )}
      
      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label className={labelClass}>Inicio del Turno</label>
                <input type="datetime-local" value={startTime} onChange={(e) => setStartTime(e.target.value)} required className={inputClass} />
            </div>
            <div>
                <label className={labelClass}>Fin del Turno</label>
                <input type="datetime-local" value={endTime} onChange={(e) => setEndTime(e.target.value)} required className={inputClass} />
            </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label className={labelClass}>Empleado ID</label>
                <input type="text" value={employeeId} readOnly className={`${inputClass} bg-gray-100 cursor-not-allowed`} />
            </div>
            <div>
                <label className={labelClass}>Objetivo ID</label>
                <input type="text" value={objectiveId} readOnly className={`${inputClass} bg-gray-100 cursor-not-allowed`} />
            </div>
        </div>

        <button 
            type="submit" 
            disabled={loading}
            className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none transition duration-200 ${loading ? 'opacity-70' : ''}`}
        >
          {loading ? 'Asignando...' : 'Asignar Turno'}
        </button>
      </form>
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\system-user-management.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { callManageSystemUsers } from '@/services/firebase-client.service';
import { ISystemUser } from '@/common/interfaces/system-user.interface';
import toast from 'react-hot-toast';

export function SystemUserManagement() {
  const [users, setUsers] = useState<ISystemUser[]>([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);

  // Formulario
  const [formData, setFormData] = useState({
    uid: '',
    displayName: '',
    email: '',
    password: '',
    role: 'Scheduler',
    status: 'Active'
  });

  const fetchUsers = async () => {
    setLoading(true);
    try {
      const res = await callManageSystemUsers({ action: 'GET_ALL_USERS', payload: {} });
      const data = (res.data as any).data || [];
      setUsers(data);
    } catch (error) {
      console.error(error);
      toast.error("Error al cargar usuarios.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchUsers();
  }, []);

  const handleOpenCreate = () => {
    setFormData({ uid: '', displayName: '', email: '', password: '', role: 'Scheduler', status: 'Active' });
    setIsEditing(false);
    setShowModal(true);
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    const toastId = toast.loading("Procesando...");

    try {
      if (isEditing) {
        // Solo enviamos lo que cambia
        const payload = {
            uid: formData.uid,
            data: {
                role: formData.role,
                status: formData.status,
                displayName: formData.displayName
            }
        };
        await callManageSystemUsers({ action: 'UPDATE_USER', payload });
        toast.success("Usuario actualizado", { id: toastId });
      } else {
        await callManageSystemUsers({ 
            action: 'CREATE_USER', 
            payload: {
                email: formData.email,
                password: formData.password,
                displayName: formData.displayName,
                role: formData.role
            }
        });
        toast.success("Administrador creado", { id: toastId });
      }
      setShowModal(false);
      fetchUsers();
    } catch (error: any) {
      toast.error(`Error: ${error.message}`, { id: toastId });
    }
  };

  const handleDelete = async (uid: string) => {
    if (!confirm("驴Eliminar este administrador? Perder谩 el acceso inmediatamente.")) return;
    try {
        await callManageSystemUsers({ action: 'DELETE_USER', payload: { uid } });
        toast.success("Usuario eliminado");
        fetchUsers();
    } catch (error) {
        toast.error("Error al eliminar");
    }
  };

  // Estilos
  const inputClass = "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm";
  const labelClass = "block text-sm font-medium text-gray-700";

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h2 className="text-xl font-bold text-gray-800">Usuarios del Sistema</h2>
            <p className="text-sm text-gray-500">Gestione el acceso al panel administrativo.</p>
        </div>
        <button onClick={handleOpenCreate} className="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 transition shadow-sm flex items-center">
            <span className="mr-2">+</span> Nuevo Admin
        </button>
      </div>

      {/* Tabla */}
      <div className="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
                <tr>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Usuario</th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Rol</th>
                    <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Estado</th>
                    <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Acciones</th>
                </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
                {users.map((user) => (
                    <tr key={user.uid} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center">
                                <div className="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-xs">
                                    {user.displayName.charAt(0)}
                                </div>
                                <div className="ml-3">
                                    <div className="text-sm font-medium text-gray-900">{user.displayName}</div>
                                    <div className="text-xs text-gray-500">{user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                            <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">
                                {user.role}
                            </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                {user.status}
                            </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onClick={() => handleDelete(user.uid)} className="text-red-600 hover:text-red-900">Eliminar</button>
                        </td>
                    </tr>
                ))}
            </tbody>
        </table>
      </div>

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <h3 className="text-lg font-bold text-gray-900 mb-4">{isEditing ? 'Editar Usuario' : 'Nuevo Administrador'}</h3>
                <form onSubmit={handleSave} className="space-y-4">
                    <div><label className={labelClass}>Nombre</label><input className={inputClass} value={formData.displayName} onChange={e => setFormData({...formData, displayName: e.target.value})} required /></div>
                    {!isEditing && (
                        <>
                            <div><label className={labelClass}>Email</label><input type="email" className={inputClass} value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required /></div>
                            <div><label className={labelClass}>Contrase帽a</label><input type="password" className={inputClass} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} required /></div>
                        </>
                    )}
                    <div>
                        <label className={labelClass}>Rol de Sistema</label>
                        <select className={inputClass} value={formData.role} onChange={e => setFormData({...formData, role: e.target.value as any})}>
                            <option value="SuperAdmin">Super Admin (Total)</option>
                            <option value="Scheduler">Planificador (Turnos)</option>
                            <option value="HR_Manager">RRHH (Empleados)</option>
                            <option value="Viewer">Solo Lectura</option>
                        </select>
                    </div>
                    <div className="flex justify-end space-x-3 mt-6">
                        <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg">Cancelar</button>
                        <button type="submit" className="px-4 py-2 text-white bg-gray-900 rounded-lg hover:bg-black">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\admin\SystemStatus.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { callManageHierarchy, callManageEmployees, callCheckSystemHealth, auth } from '@/services/firebase-client.service';

interface HealthMetric {
    name: string;
    status: 'pending' | 'ok' | 'warning' | 'error';
    value?: string;
    details?: string;
}

export function SystemStatus() {
    const [metrics, setMetrics] = useState<HealthMetric[]>([
        { name: 'Conectividad Internet', status: 'pending' },
        { name: 'Sesi贸n de Usuario (Auth)', status: 'pending' },
        { name: 'Servidor (Cloud Functions)', status: 'pending' },
        { name: 'Base de Datos (Firestore)', status: 'pending' },
        { name: 'M贸dulo Jerarqu铆a', status: 'pending' },
        { name: 'M贸dulo RRHH', status: 'pending' },
    ]);
    const [isRunning, setIsRunning] = useState(false);

    useEffect(() => { runDiagnostics(); }, []);

    const updateMetric = (index: number, status: HealthMetric['status'], value: string, details: string = '') => {
        setMetrics(prev => {
            const newM = [...prev];
            newM[index] = { ...newM[index], status, value, details };
            return newM;
        });
    };

    const runDiagnostics = async () => {
        setIsRunning(true);
        
        // 1. Local Checks
        const isOnline = navigator.onLine;
        updateMetric(0, isOnline ? 'ok' : 'error', isOnline ? 'Online' : 'Offline');
        if (!isOnline) { setIsRunning(false); return; }

        const user = auth.currentUser;
        updateMetric(1, user ? 'ok' : 'error', user ? 'Autenticado' : 'Sin Sesi贸n', user?.uid);

        // 2. Health Check Real (Ping al servidor)
        const startServer = Date.now();
        try {
            const healthRes = await callCheckSystemHealth({});
            const endServer = Date.now();
            const data = healthRes.data as any;

            updateMetric(2, 'ok', `${endServer - startServer}ms`, `Node ${data.nodeVersion}`);
            
            const dbLat = data.database.latencyMs;
            updateMetric(3, data.database.status === 'connected' ? 'ok' : 'error', `${dbLat}ms`);

        } catch (error: any) {
            updateMetric(2, 'error', 'Fallo Cr铆tico', error.message);
            updateMetric(3, 'error', 'Inaccesible', 'Timeout o Error 500');
        }

        // 3. Smoke Test de M贸dulos
        await testModule(4, async () => callManageHierarchy({ action: 'GET_ALL_CLIENTS', payload: {} }));
        await testModule(5, async () => callManageEmployees({ action: 'GET_ALL_EMPLOYEES', payload: {} }));

        setIsRunning(false);
    };

    const testModule = async (index: number, call: () => Promise<any>) => {
        const start = Date.now();
        try {
            await call();
            updateMetric(index, 'ok', `${Date.now() - start}ms`, 'Operativo');
        } catch (error: any) {
            updateMetric(index, 'error', 'Fallo', error.message);
        }
    };

    return (
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <div className="flex justify-between items-center mb-6">
                <h3 className="font-bold text-slate-800 text-lg">Monitor de Salud</h3>
                <button onClick={runDiagnostics} disabled={isRunning} className="px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-bold hover:bg-indigo-100 disabled:opacity-50">
                    {isRunning ? 'Escaneando...' : 'Re-escanear'}
                </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {metrics.map((m, idx) => (
                    <div key={idx} className={`p-4 rounded-lg border flex items-center justify-between ${m.status === 'ok' ? 'bg-green-50 border-green-100' : m.status === 'error' ? 'bg-red-50 border-red-100' : 'bg-gray-50'}`}>
                        <div>
                            <p className="text-xs font-bold text-gray-500 uppercase mb-1">{m.name}</p>
                            <div className="flex items-center gap-2">
                                <div className={`w-2.5 h-2.5 rounded-full ${m.status === 'ok' ? 'bg-green-500' : m.status === 'error' ? 'bg-red-500' : 'bg-yellow-400 animate-pulse'}`} />
                                <span className="font-bold text-slate-700">{m.status === 'pending' ? '...' : m.value}</span>
                            </div>
                        </div>
                        {m.details && <div className="text-xs text-gray-500 text-right max-w-[120px] truncate" title={m.details}>{m.details}</div>}
                    </div>
                ))}
            </div>
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\common\Button.tsx
================================================================================
import React from 'react';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
    primary?: boolean;
    children: React.ReactNode;
}

/**
 * @description Reusable button component with basic Tailwind styles.
 */
export default function Button({ primary = true, children, className, disabled, ...props }: ButtonProps) {
    const baseStyle = "px-4 py-2 rounded-lg font-semibold transition-colors duration-150";
    const primaryStyle = "bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-indigo-300";
    const secondaryStyle = "bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:bg-gray-100";

    return (
        <button
            className={`${baseStyle} ${primary ? primaryStyle : secondaryStyle} ${className || ''}`}
            disabled={disabled}
            {...props}
        >
            {children}
        </button>
    );
}

================================================================================
FILE: apps\web\src\components\common\InputField.tsx
================================================================================
import React from 'react';

interface InputFieldProps extends React.InputHTMLAttributes<HTMLInputElement | HTMLTextAreaElement> {
    label: string;
    id: string;
    type?: 'text' | 'email' | 'password' | 'number' | 'date' | 'textarea';
    rows?: number;
}

/**
 * @description Reusable input/textarea component.
 */
export default function InputField({ label, id, type = 'text', rows = 1, className, ...props }: InputFieldProps) {
    const inputStyle = "w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 text-sm";

    return (
        <div className={`space-y-1 ${className}`}>
            <label htmlFor={id} className="block text-sm font-medium text-gray-700">
                {label}
            </label>
            {type === 'textarea' ? (
                <textarea
                    id={id}
                    className={inputStyle}
                    rows={rows}
                    {...props as React.TextareaHTMLAttributes<HTMLTextAreaElement>}
                />
            ) : (
                <input
                    id={id}
                    type={type}
                    className={inputStyle}
                    {...props as React.InputHTMLAttributes<HTMLInputElement>}
                />
            )}
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\common\SelectField.tsx
================================================================================
import React from 'react';

interface SelectFieldProps extends React.SelectHTMLAttributes<HTMLSelectElement> {
    label: string;
    id: string;
    children: React.ReactNode;
}

/**
 * @description Reusable select (dropdown) component.
 */
export default function SelectField({ label, id, children, className, ...props }: SelectFieldProps) {
    const selectStyle = "w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 text-sm";
    
    return (
        <div className={`space-y-1 ${className}`}>
            <label htmlFor={id} className="block text-sm font-medium text-gray-700">
                {label}
            </label>
            <select
                id={id}
                className={selectStyle}
                {...props}
            >
                {children}
            </select>
        </div>
    );
}

================================================================================
FILE: apps\web\src\components\common\shift.interface.ts
================================================================================
/**
 * @file shift.interface.ts
 * @description Definici贸n de la estructura de un Turno (Shift) compartido entre Frontend y Backend.
 */

// Definimos un tipo flexible para las fechas para soportar:
// 1. admin.firestore.Timestamp (Backend)
// 2. firebase.firestore.Timestamp (Frontend SDK)
// 3. Date (Objetos JS nativos tras conversi贸n)
// 4. { seconds: number, nanoseconds: number } (JSON serializado)
export type FirestoreDate = any; 

export type ShiftStatus = 'Scheduled' | 'In Progress' | 'Completed' | 'Absent';

export interface IShift {
    id: string; // ID del documento en Firestore
    
    // Relaci贸n con Empleado
    employeeId: string;
    employeeName: string;
    
    // Relaci贸n con Objetivo (Cliente/Sede)
    objectiveId: string;
    objectiveName: string; //  Requerido para mostrar en el Dashboard
    
    // Tiempos
    startTime: FirestoreDate;
    endTime: FirestoreDate;
    
    // Estado del ciclo de vida
    status: ShiftStatus;
    
    // Datos opcionales de auditor铆a en el mismo documento (si aplica)
    checkInTime?: FirestoreDate;
    checkOutTime?: FirestoreDate;
    
    // Metadatos
    role?: string; // Rol del empleado durante ese turno (ej: 'Vigilador', 'Supervisor')
}

================================================================================
FILE: apps\web\src\components\common\withAuthGuard.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/router';
import { User, onAuthStateChanged } from 'firebase/auth';
import { auth } from '../../services/firebase-client.service';

// Roles que se consideran "Administrativos"
const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager'];

export const withAuthGuard = (WrappedComponent: React.ComponentType<any>, requiredRole: string = 'admin') => {
  
  //  LOG DE DEBUG 1: Ver qu茅 configuraci贸n recibe el guardia al crearse
  console.log(`[DEBUG GUARD] Iniciando guardia para componente: ${WrappedComponent.displayName || WrappedComponent.name}`);
  console.log(`[DEBUG GUARD] Rol Requerido (requiredRole):`, requiredRole);

  const ComponentWithAuthGuard = (props: any) => {
    const router = useRouter();
    const [loading, setLoading] = useState(true);
    const [currentUser, setCurrentUser] = useState<User | null>(null);

    useEffect(() => {
      console.log("[DEBUG GUARD] useEffect ejecut谩ndose...");
      const unsubscribe = onAuthStateChanged(auth, async (user) => {
        if (!user) {
          console.log("[DEBUG GUARD] No hay usuario, redirigiendo a /");
          router.replace('/'); 
          return;
        }

        console.log(`[DEBUG GUARD] Usuario detectado: ${user.email}`);
        setCurrentUser(user);
        
        try {
          const tokenResult = await user.getIdTokenResult();
          const userRole = tokenResult.claims.role as string;
          
          //  LOG DE DEBUG 2: Ver qu茅 rol tiene el usuario real
          console.log(`[DEBUG GUARD] Rol del Usuario (Claims): ${userRole}`);
          console.log(`[DEBUG GUARD] Comparando contra Requerido: ${requiredRole}`);

          let isAuthorized = false;

          if (requiredRole === 'admin') {
            isAuthorized = ADMIN_ROLES.includes(userRole);
          } else {
            // Comparaci贸n estricta para otros roles (ej: 'employee')
            isAuthorized = userRole === requiredRole;
          }
          
          console.log(`[DEBUG GUARD] Resultado Autorizaci贸n: ${isAuthorized}`);

          if (isAuthorized) {
            setLoading(false);
          } else {
            console.warn(`[DEBUG GUARD] ACCESO DENEGADO. Requerido: ${requiredRole}, Encontrado: ${userRole}`);
            // Comentamos el signOut temporalmente para que puedas ver el log sin que te eche inmediatamente
            // await auth.signOut(); 
            // router.replace('/');
          }
        } catch (error) {
          console.error("[DEBUG GUARD] Error verificando rol:", error);
          router.replace('/');
        }
      });

      return () => unsubscribe();
    }, [router]);

    if (loading || !currentUser) {
      return <div className="p-10 text-center">Cargando seguridad... (Mira la consola)</div>;
    }

    return <WrappedComponent {...props} currentUser={currentUser} />;
  };

  return ComponentWithAuthGuard;
};

================================================================================
FILE: apps\web\src\components\employee\employee-dashboard.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { User } from 'firebase/auth';
import { getEmployeeShifts, callAuditShift } from '@/services/firebase-client.service';
import { IShift } from '@/common/interfaces/shift.interface';
import toast from 'react-hot-toast';
//  Importamos la utilidad de geolocalizaci贸n (Aseg煤rate de que este archivo exista)
import { getCurrentPosition } from '@/utils/geolocation';

interface EmployeeDashboardProps {
  currentUser: User; 
}

export function EmployeeDashboard({ currentUser }: EmployeeDashboardProps) {
  const [shifts, setShifts] = useState<IShift[]>([]);
  const [loading, setLoading] = useState(true);
  const [isAuditing, setIsAuditing] = useState(false); 
  
  const loadShifts = async () => {
    setLoading(true);
    try {
      const data = await getEmployeeShifts(currentUser.uid);
      setShifts(data);
    } catch (err: any) {
      console.error(err);
      toast.error("Error al cargar turnos.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (currentUser) loadShifts();
  }, [currentUser]);

  const formatTime = (timestamp: any) => {
    if (!timestamp) return 'N/A';
    if (timestamp?.toDate) return timestamp.toDate().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
    if (timestamp instanceof Date) return timestamp.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
    return 'N/A';
  };

  const formatDate = (timestamp: any) => {
    if (!timestamp) return 'N/A';
    if (timestamp?.toDate) return timestamp.toDate().toLocaleDateString('es-ES');
    return 'N/A';
  };
  
  const handleAuditAction = async (shiftId: string, action: 'CHECK_IN' | 'CHECK_OUT') => {
    if (isAuditing) return;
    
    const toastId = toast.loading("Obteniendo ubicaci贸n GPS...");
    setIsAuditing(true);

    try {
        // 1. Obtener Coordenadas Robustas
        const coords = await getCurrentPosition();
        
        // 2. Llamar al Backend
        toast.loading("Verificando zona...", { id: toastId });
        
        await callAuditShift({ 
            shiftId, 
            action, 
            coords: { latitude: coords.latitude, longitude: coords.longitude } 
        });

        toast.success(action === 'CHECK_IN' ? "隆Entrada registrada!" : "隆Salida registrada!", { id: toastId });
        loadShifts(); 

    } catch (error: any) {
        console.error("Audit Error:", error);
        
        let errorMessage = "Error al procesar la fichada.";
        
        // Error de GPS (Frontend)
        if (error.message.includes('Permiso') || error.message.includes('GPS') || error.message.includes('navegador')) {
            errorMessage = `锔 ${error.message}`;
        }
        // Error de Geofence (Backend)
        else if (error.message.includes('cerca del objetivo') || error.code === 'functions/failed-precondition') {
            errorMessage = " Est谩s demasiado lejos del objetivo.";
        }
        
        toast.error(errorMessage, { id: toastId, duration: 5000 });
    } finally {
        setIsAuditing(false);
    }
  };

  if (loading) return <div className="p-8 text-center animate-pulse text-gray-500">Cargando tus asignaciones...</div>;

  return (
    <div className="max-w-lg mx-auto pb-20"> 
      <h2 className="text-xl font-bold mb-4 text-gray-800 px-4 pt-4">锔 Tus Pr贸ximos Turnos</h2>
      
      {shifts.length === 0 && (
          <div className="bg-white p-8 m-4 rounded-xl shadow-sm text-center border border-gray-100">
              <p className="text-gray-500">No tienes turnos programados pr贸ximamente.</p>
          </div>
      )}

      <div className="space-y-4 px-4">
        {shifts.map((shift) => (
          <div key={shift.id} className="bg-white p-5 rounded-xl shadow-sm border-l-4 border-indigo-500 relative overflow-hidden">
            <div className="flex justify-between items-start">
                <div>
                    <p className="font-bold text-lg text-gray-800">{shift.objectiveName || 'Objetivo'}</p>
                    <p className="text-xs text-gray-400 mb-2 uppercase tracking-wider">{shift.role || 'Seguridad'}</p>
                </div>
                <span className={`px-2 py-1 rounded text-xs font-bold ${
                    shift.status === 'Completed' ? 'bg-green-100 text-green-700' :
                    shift.status === 'InProgress' ? 'bg-blue-100 text-blue-700' :
                    'bg-gray-100 text-gray-600'
                }`}>
                    {shift.status === 'Assigned' ? 'Pendiente' : 
                     shift.status === 'InProgress' ? 'En Curso' : 
                     shift.status === 'Completed' ? 'Finalizado' : shift.status}
                </span>
            </div>
            
            <div className="mt-2 text-sm text-gray-600 grid grid-cols-2 gap-2">
                <div className="flex items-center">
                    <span className="mr-2"></span> {formatDate(shift.startTime)}
                </div>
                <div className="flex items-center font-medium">
                    <span className="mr-2"></span> {formatTime(shift.startTime)} - {formatTime(shift.endTime)}
                </div>
            </div>
            
            <div className="mt-5 border-t border-gray-100 pt-4">
                {shift.status === 'Assigned' && (
                    <button 
                        onClick={() => handleAuditAction(shift.id, 'CHECK_IN')} 
                        disabled={isAuditing} 
                        className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-sm hover:bg-indigo-700 active:scale-95 transition-all flex justify-center items-center disabled:opacity-70 disabled:active:scale-100"
                    >
                        {isAuditing ? 'Verificando...' : ' MARCAR ENTRADA'}
                    </button>
                )}
                {shift.status === 'InProgress' && (
                    <button 
                        onClick={() => handleAuditAction(shift.id, 'CHECK_OUT')} 
                        disabled={isAuditing} 
                        className="w-full bg-rose-600 text-white py-3 rounded-lg font-bold shadow-sm hover:bg-rose-700 active:scale-95 transition-all flex justify-center items-center disabled:opacity-70 disabled:active:scale-100"
                    >
                        {isAuditing ? 'Verificando...' : ' MARCAR SALIDA'}
                    </button>
                )}
                {shift.status === 'Completed' && (
                    <div className="flex items-center justify-center text-green-600 font-medium bg-green-50 py-2 rounded-lg border border-green-100">
                        <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                        Turno Completado
                    </div>
                )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

================================================================================
FILE: apps\web\src\components\layout\DashboardLayout.tsx
================================================================================
// Archivo: src/components/layout/DashboardLayout.tsx

import React, { useState } from 'react';
import { useRouter } from 'next/router';
import { useClient } from '@/context/ClientContext';
import { auth } from '@/services/firebase-client.service';
import { APP_INFO } from '@/config/app.config'; //  Centralizaci贸n de la identidad

// Importamos iconos modernos
import { 
  LayoutDashboard, 
  Building2, 
  Target, 
  Users, 
  CalendarDays, 
  ShieldCheck, 
  Activity, 
  Menu, 
  X, 
  LogOut,
  ChevronDown,
  Settings
} from 'lucide-react';

interface LayoutProps {
  children: React.ReactNode;
  title: string;
}

// Mapeo de strings (del config) a Componentes de iconos
const iconMap: any = {
  LayoutDashboard: <LayoutDashboard size={20} />,
  Building2: <Building2 size={20} />,
  Target: <Target size={20} />,
  Users: <Users size={20} />,
  CalendarDays: <CalendarDays size={20} />,
  ShieldCheck: <ShieldCheck size={20} />,
  Activity: <Activity size={20} />,
};

//  EXPORTACIN NORMAL: Quitamos 'export'
function DashboardLayout({ children, title }: LayoutProps) {
  const router = useRouter();
  const { clients, selectedClientId, setClient, loading } = useClient();
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  
  const handleLogout = async () => {
    try {
      await auth.signOut();
      window.location.href = '/'; 
    } catch (error) {
      console.error("Error al cerrar sesi贸n:", error);
    }
  };

  const SidebarContent = () => (
    <>
      {/* 1. Header de Identidad: BacarPlan v1.0.0 */}
      <div className="h-16 flex items-center px-6 border-b border-slate-100 bg-white">
        <div>
          <h1 className="text-xl font-extrabold text-indigo-700 tracking-tight">
            {APP_INFO.name}
          </h1>
          <div className="flex items-center space-x-2">
            <span className="text-[10px] font-mono text-slate-400 border border-slate-200 rounded px-1.5 bg-slate-50">
                v{APP_INFO.version}
            </span>
          </div>
        </div>
      </div>

      {/* 2. Selector de Contexto (Empresa Cliente) */}
      <div className="px-4 py-4 border-b border-slate-100 bg-slate-50/50">
          <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block">
            Empresa Cliente
          </label>
          {loading ? (
              <div className="h-9 w-full bg-slate-200 rounded animate-pulse"></div>
          ) : (
              <div className="relative">
                <select 
                    value={selectedClientId} 
                    onChange={(e) => setClient(e.target.value)}
                    className="w-full text-sm border-slate-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 py-2 pl-2 pr-8 appearance-none bg-white cursor-pointer truncate font-medium text-slate-700"
                >
                    <option value="" disabled>Seleccionar...</option>
                    {clients.map(c => (
                        <option key={c.id} value={c.id}>{c.businessName}</option>
                    ))}
                </select>
                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                  <ChevronDown size={14} />
                </div>
            </div>
          )}
      </div>

      {/* 3. Navegaci贸n Din谩mica */}
      <nav className="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
        {APP_INFO.menuItems.map((item) => {
          // La ruta activa se determina por el path de Next.js
          const isActive = router.pathname === item.path;
          return (
            <button
              key={item.path}
              onClick={() => {
                router.push(item.path);
                setIsMobileMenuOpen(false);
              }}
              className={`w-full flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all duration-200 group ${
                isActive 
                  ? 'bg-indigo-50 text-indigo-700 font-semibold shadow-sm ring-1 ring-indigo-200' 
                  : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-medium'
              }`}
            >
              <span className={`transition-colors ${isActive ? 'text-indigo-600' : 'text-slate-400 group-hover:text-slate-600'}`}>
                {iconMap[item.icon] || <Settings size={20} />}
              </span>
              <span className="text-sm">{item.name}</span>
            </button>
          )
        })}
      </nav>

      {/* 4. Footer Logout */}
      <div className="p-4 border-t border-slate-100 mt-auto bg-white">
        <button onClick={handleLogout} className="flex items-center space-x-3 text-rose-600 hover:bg-rose-50 w-full px-3 py-2.5 rounded-lg transition-colors text-sm font-medium group">
          <LogOut size={20} className="group-hover:text-rose-700" />
          <span>Cerrar Sesi贸n</span>
        </button>
      </div>
    </>
  );

  return (
    <div className="flex h-screen bg-[#F8FAFC] font-sans text-slate-600">
      
      {/* Desktop Sidebar */}
      <aside className="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col fixed h-full z-30 shadow-sm">
        <SidebarContent />
      </aside>

      {/* Mobile Menu Overlay */}
      {isMobileMenuOpen && (
        <div className="fixed inset-0 z-50 flex md:hidden">
          <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onClick={() => setIsMobileMenuOpen(false)}></div>
          <div className="relative flex-1 flex flex-col max-w-xs w-full bg-white shadow-2xl transform transition-transform duration-300 ease-in-out">
            <div className="absolute top-0 right-0 -mr-12 pt-2">
              <button className="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" onClick={() => setIsMobileMenuOpen(false)}>
                <X className="h-6 w-6 text-white" />
              </button>
            </div>
            <SidebarContent />
          </div>
        </div>
      )}

      {/* Main Content Area */}
      <div className="flex-1 flex flex-col md:pl-64 h-screen overflow-hidden transition-all duration-300">
        
        {/* Topbar */}
        <header className="h-16 bg-white/90 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-4 md:px-8 sticky top-0 z-20 shrink-0 shadow-sm">
          <div className="flex items-center gap-3">
            <button onClick={() => setIsMobileMenuOpen(true)} className="md:hidden -ml-2 p-2 text-slate-500 hover:text-indigo-600 rounded-md">
              <Menu className="w-6 h-6" />
            </button>
            {/* T铆tulo de la p谩gina, pasado como prop */}
            <h2 className="text-lg font-bold text-slate-800 truncate leading-tight">{title}</h2>
          </div>
          <div className="flex items-center space-x-4">
             {/* Avatar Placeholder */}
             <div className="h-9 w-9 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-700 font-bold text-sm border border-indigo-100 shadow-sm">
                AD
             </div>
          </div>
        </header>

        {/* Page Content */}
        <main className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
          <div className="max-w-7xl mx-auto h-full">
            {children}
          </div>
        </main>
      </div>
    </div>
  );
}

//  FIX FINAL: Usar export default para la correcta importaci贸n en [id].tsx y otras p谩ginas.
export default DashboardLayout;

================================================================================
FILE: apps\web\src\config\app.config.ts
================================================================================
export const APP_INFO = {
  name: 'BacarPlan',
  version: '1.0.0',
  description: 'Sistema Integral de Gesti贸n Operativa',
  // Definimos los items usando claves de iconos para mantener el layout limpio
  menuItems: [
    { name: 'Panel de Control', path: '/admin/dashboard', icon: 'LayoutDashboard' },
    { name: 'Empresas / Clientes', path: '/admin/clients', icon: 'Building2' },
    { name: 'Objetivos', path: '/admin/objective-management', icon: 'Target' },
    { name: 'RRHH / Empleados', path: '/admin/employees', icon: 'Users' },
    { name: 'Novedades (Ausencias)', path: '/admin/rrhh/novedades', icon: 'CalendarDays' },
    { name: 'Usuarios Sistema', path: '/admin/system-users', icon: 'ShieldCheck' },
    { name: 'Diagn贸stico', path: '/admin/status', icon: 'Activity' },
  ]
};

================================================================================
FILE: apps\web\src\context\ClientContext.tsx
================================================================================
import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { onAuthStateChanged } from 'firebase/auth';
import { auth, callManageHierarchy } from '@/services/firebase-client.service';
import { IClient } from '@/common/interfaces/client.interface';
import toast from 'react-hot-toast';

interface ClientContextType {
  clients: IClient[];
  selectedClientId: string;
  selectedClient: IClient | undefined;
  setClient: (id: string) => void;
  loading: boolean;
}

// Roles que tienen permiso para ver/listar empresas en el backend
const ADMIN_ROLES = ['admin', 'SuperAdmin', 'Scheduler', 'HR_Manager'];

const ClientContext = createContext<ClientContextType | undefined>(undefined);

export function ClientProvider({ children }: { children: ReactNode }) {
  const [clients, setClients] = useState<IClient[]>([]);
  const [selectedClientId, setSelectedClientId] = useState<string>('');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          //  FIX CRTICO: Verificar el rol ANTES de pedir datos al backend
          // Esto evita el error 403 cuando entra un empleado
          const tokenResult = await user.getIdTokenResult();
          const role = tokenResult.claims.role as string;

          if (ADMIN_ROLES.includes(role)) {
            await loadClients(); // Solo carga si es personal administrativo
          } else {
            // Si es empleado, no cargamos clientes y liberamos el loading
            setLoading(false);
          }
        } catch (error) {
          console.error("Error verificando permisos del contexto:", error);
          setLoading(false);
        }
      } else {
        // Logout
        setClients([]);
        setSelectedClientId('');
        setLoading(false);
      }
    });

    return () => unsubscribe();
  }, []);

  async function loadClients() {
    try {
      const res = await callManageHierarchy({ action: 'GET_ALL_CLIENTS', payload: {} });
      const responseData = res.data as any; 
      const data = responseData.data || [];
      
      setClients(data);

      // Recuperar selecci贸n previa o default
      const savedId = localStorage.getItem('selectedClientId');
      if (savedId && data.find((c: IClient) => c.id === savedId)) {
        setSelectedClientId(savedId);
      } else if (data.length > 0) {
        setSelectedClientId(data[0].id);
        localStorage.setItem('selectedClientId', data[0].id);
      }
    } catch (error: any) {
      console.error("Error loading clients", error);
      toast.error("No se pudieron cargar las empresas.");
    } finally {
      setLoading(false);
    }
  }

  const setClient = (id: string) => {
    setSelectedClientId(id);
    localStorage.setItem('selectedClientId', id);
    toast.success("Empresa cambiada");
  };

  const selectedClient = clients.find(c => c.id === selectedClientId);

  return (
    <ClientContext.Provider value={{ clients, selectedClientId, selectedClient, setClient, loading }}>
      {children}
    </ClientContext.Provider>
  );
}

export function useClient() {
  const context = useContext(ClientContext);
  if (!context) throw new Error('useClient debe usarse dentro de ClientProvider');
  return context;
}

================================================================================
FILE: apps\web\src\hooks\useSchedulerDataFetcher.ts
================================================================================
import { useState, useEffect } from 'react';
import toast from 'react-hot-toast';
import { callManageEmployees, callManageData } from '@/services/firebase-client.service';
import { IEmployee } from '@/common/interfaces/employee.interface';
import { IObjective } from '@/common/interfaces/client.interface';

export const useSchedulerDataFetcher = (selectedClientId: string | null) => {
    const [employees, setEmployees] = useState<IEmployee[]>([]);
    const [objectives, setObjectives] = useState<IObjective[]>([]);
    const [selectedObjectiveId, setSelectedObjectiveId] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);

    useEffect(() => {
        const fetchAll = async () => {
            //  DEBUG: Verificar qu茅 ID llega al hook
            console.log(" [Fetcher] Cambio de empresa detectado. ID:", selectedClientId);

            // Si no hay cliente seleccionado, limpiamos y salimos
            if (!selectedClientId) {
                console.log("锔 [Fetcher] No hay cliente seleccionado. Limpiando datos.");
                setEmployees([]);
                setObjectives([]);
                setSelectedObjectiveId('');
                return;
            }

            setIsLoading(true);
            
            try {
                // 1. Obtener Empleados (Con filtro de empresa)
                console.log(" [Fetcher] Solicitando empleados al Backend para cliente:", selectedClientId);
                
                const empRes = await callManageEmployees({ 
                    action: 'GET_ALL_EMPLOYEES', 
                    payload: { clientId: selectedClientId } //  Aqu铆 enviamos el filtro
                });
                
                // Manejo defensivo de la respuesta
                const empData = (empRes.data as any).data || [];
                
                //  DEBUG: Verificar qu茅 devolvi贸 el Backend
                console.log(` [Fetcher] Recibidos ${empData.length} empleados.`);
                console.log(" [Fetcher] Lista de empleados:", empData);
                
                setEmployees(empData);

                // 2. Obtener Objetivos (Con filtro de empresa)
                console.log(" [Fetcher] Solicitando objetivos...");
                const objRes = await callManageData({ 
                    action: 'GET_ALL_OBJECTIVES', 
                    payload: { clientId: selectedClientId } 
                });
                
                const objData = (objRes.data as any).data || [];
                setObjectives(objData);
                
                // Seleccionar autom谩ticamente el primer objetivo si existe
                if (objData.length > 0) {
                    setSelectedObjectiveId(objData[0].id);
                } else {
                    setSelectedObjectiveId('');
                }
            
            } catch (error) {
                console.error(" [Fetcher] Error CRTICO cargando datos:", error);
                toast.error("Error al cargar los datos de la empresa.");
                setEmployees([]);
                setObjectives([]);
            } finally {
                setIsLoading(false);
            }
        };

        fetchAll();

    }, [selectedClientId]); //  DEPENDENCIA: Se ejecuta al cambiar el cliente

    return { 
        employees, 
        objectives, 
        selectedObjectiveId, 
        setSelectedObjectiveId, 
        isLoading 
    };
};

================================================================================
FILE: apps\web\src\services\firebase-client.service.ts
================================================================================
import { initializeApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getFunctions, httpsCallable } from 'firebase/functions';
import { 
    getFirestore, 
    collection, 
    query, 
    where, 
    getDocs, 
    QueryDocumentSnapshot,
    Timestamp 
} from 'firebase/firestore';
import { IShift } from '@/common/interfaces/shift.interface';
import { IAbsencePayload } from '@/common/interfaces/employee.interface';

//  CREDENCIALES REALES
const firebaseConfig = {
    apiKey: "AIzaSyBJaTiMekwbGPXAm-mkPl_u6KEWCSpvfic",
    authDomain: "comtroldata.firebaseapp.com",
    projectId: "comtroldata",
    storageBucket: "comtroldata.firebasestorage.app",
    messagingSenderId: "698108879063",
    appId: "1:698108879063:web:ab30eb8b80a774f52f1092",
    measurementId: "G-SWCD6XEWDH"
};

const app = initializeApp(firebaseConfig);

export const auth = getAuth(app);
export const functions = getFunctions(app, 'us-central1');
export const db = getFirestore(app);

// Colecciones
const SHIFTS_COLLECTION = 'turnos';
const CONTRACTS_COLLECTION = 'contratos_servicio'; 

// ------------------------------------------------------------------
// 3. FUNCIONES INVOCABLES (CALLABLE FUNCTIONS - BACKEND)
// ------------------------------------------------------------------

export const callScheduleShift = httpsCallable(functions, 'scheduleShift');
export const callCreateUser = httpsCallable(functions, 'createUser');
export const callManageData = httpsCallable(functions, 'manageData');
export const callAuditShift = httpsCallable(functions, 'auditShift');
export const callManageHierarchy = httpsCallable(functions, 'manageHierarchy'); //  Necesario para buscar Tipos de Turno
export const callManageEmployees = httpsCallable(functions, 'manageEmployees');
export const callManageSystemUsers = httpsCallable(functions, 'manageSystemUsers');
export const callManageAbsences = httpsCallable(functions, 'manageAbsences');
export const callCheckSystemHealth = httpsCallable(functions, 'checkSystemHealth');

/**
 * Crea una nueva novedad/ausencia para un empleado.
 */
export async function createAbsence(params: { action: 'CREATE_ABSENCE', payload: IAbsencePayload }): Promise<any> {
    const { payload } = params;
    if (!payload.employeeId || !payload.clientId || !payload.startDate || !payload.endDate || !payload.reason) {
        console.error("Validation Error: Missing required fields.", payload);
        throw new Error("Missing required fields for absence creation.");
    }
    
    const absenceData = {
        employeeId: payload.employeeId,
        employeeName: payload.employeeName,
        clientId: payload.clientId,
        type: payload.type,
        startDate: Timestamp.fromDate(payload.startDate),
        endDate: Timestamp.fromDate(payload.endDate),
        reason: payload.reason,
    };

    try {
        const result = await callManageAbsences({ 
            action: params.action, 
            payload: absenceData 
        });
        
        if (result.data && (result.data as any).success === false) {
             throw new Error((result.data as any).message || "Backend validation failed.");
        }
        return result.data;
    } catch (error) {
        console.error("[Service Error - createAbsence]:", error);
        throw error; 
    }
}

// ------------------------------------------------------------------
// 4. FUNCIONES DE CLIENTE (FIRESTORE DIRECTO)
// ------------------------------------------------------------------

export async function getEmployeeShifts(employeeId: string): Promise<IShift[]> {
    if (!employeeId) return [];
    
    const shiftsRef = collection(db, SHIFTS_COLLECTION);
    const now = new Date();
    const shiftsQuery = query(
        shiftsRef, 
        where('employeeId', '==', employeeId), 
        where('startTime', '>=', now)
    );
    const snapshot = await getDocs(shiftsQuery);

    return snapshot.docs.map((doc: QueryDocumentSnapshot) => {
        const data = doc.data();
        return { ...data, id: doc.id };
    }) as unknown as IShift[];
}

export async function getObjectiveShifts(objectiveId: string): Promise<IShift[]> {
    if (!objectiveId) return [];
    
    const shiftsRef = collection(db, SHIFTS_COLLECTION);
    const shiftsQuery = query(shiftsRef, where('objectiveId', '==', objectiveId)); 
    const snapshot = await getDocs(shiftsQuery);
    return snapshot.docs.map((doc: QueryDocumentSnapshot) => {
        const data = doc.data();
        return { ...data, id: doc.id };
    }) as unknown as IShift[];
}

/** * Obtiene el contrato activo de un objetivo.
 * Retorna ID, Horas Totales y Nombre.
 */
export async function getActiveContract(objectiveId: string): Promise<{ id: string, totalHours: number, name: string } | null> {
    if (!objectiveId) return null;

    try {
        const contractsRef = collection(db, CONTRACTS_COLLECTION);
        const q = query(
            contractsRef, 
            where('objectiveId', '==', objectiveId),
            where('isActive', '==', true) 
        );
        
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) return null;

        const docSnapshot = snapshot.docs[0];
        const docData = docSnapshot.data();

        return {
            id: docSnapshot.id,
            totalHours: docData.totalHoursPerMonth || 0,
            name: docData.name || 'Contrato'
        };
    } catch (e) {
        console.error("Error fetching contract:", e);
        return null;
    }
}

================================================================================
FILE: apps\web\src\utils\geocoding.ts
================================================================================
/**
 * Utilidad para geocodificaci贸n usando Google Maps Platform.
 */
export async function getCoordinatesFromAddress(address: string): Promise<{ lat: number, lng: number } | null> {
    const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_KEY;

    // 1. Diagn贸stico de la Clave
    if (!apiKey) {
        console.error(" ERROR CRTICO: La variable NEXT_PUBLIC_GOOGLE_MAPS_KEY est谩 vac铆a o undefined.");
        console.info(" RECUERDA: Debes crear el archivo .env.local en apps/web/ y reiniciar el servidor (npm run dev).");
        return null;
    }

    try {
        console.log(` Consultando Google Maps para: "${address}"`);
        
        const query = encodeURIComponent(address);
        const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${query}&key=${apiKey}`;
        
        const response = await fetch(url);
        const data = await response.json();

        // 2. Diagn贸stico de la Respuesta de Google
        if (data.status !== 'OK') {
            console.error(" Google Maps API Error:", data.status);
            console.error("Mensaje de error:", data.error_message); // Muy 煤til para ver si falta habilitar la API
            
            if (data.status === 'REQUEST_DENIED') {
                console.warn("锔 Revisa en Google Cloud Console que la 'Geocoding API' est茅 habilitada y que la API Key sea correcta.");
            }
            return null;
        }

        if (data.results.length > 0) {
            const location = data.results[0].geometry.location;
            console.log(" Coordenadas encontradas:", location);
            return {
                lat: location.lat,
                lng: location.lng
            };
        } else {
            console.warn("锔 Google no encontr贸 resultados para esa direcci贸n.");
            return null;
        }

    } catch (error) {
        console.error(" Error de red o fetch:", error);
        return null;
    }
}

================================================================================
FILE: apps\web\src\utils\geolocation.ts
================================================================================
export interface IGeoCoordinates {
    latitude: number;
    longitude: number;
    accuracy: number;
}

/**
 * Obtiene la posici贸n actual con promesa y manejo de errores en Espa帽ol.
 */
export function getCurrentPosition(timeoutMs: number = 10000): Promise<IGeoCoordinates> {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Tu navegador no soporta geolocalizaci贸n.'));
            return;
        }

        const options: PositionOptions = {
            enableHighAccuracy: true, // Intentar usar GPS real
            timeout: timeoutMs,
            maximumAge: 0 // No usar cach茅
        };

        navigator.geolocation.getCurrentPosition(
            (position) => {
                resolve({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                });
            },
            (error) => {
                let msg = 'Error desconocido de ubicaci贸n.';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        msg = 'Permiso de ubicaci贸n denegado. Habil铆talo en tu navegador.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        msg = 'Se帽al GPS no disponible.';
                        break;
                    case error.TIMEOUT:
                        msg = 'Se agot贸 el tiempo buscando se帽al GPS.';
                        break;
                }
                reject(new Error(msg));
            },
            options
        );
    });
}

================================================================================
FILE: apps\web\tailwind.config.ts
================================================================================
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/**/*.{js,ts,jsx,tsx,mdx}", //  CLAVE
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};
export default config;

================================================================================
FILE: apps\web\tsconfig.json
================================================================================
{
  //  Ya no extendemos el archivo ra铆z para evitar conflictos.
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    // Configuramos la base para que TypeScript entienda la ruta "src"
    "baseUrl": "./src", 
    "paths": {
      //  FIX: Definici贸n expl铆cita de cada alias que usa la aplicaci贸n.
      "@/components/*": ["components/*"],
      "@/config/*": ["config/*"],
      "@/context/*": ["context/*"],
      "@/services/*": ["services/*"],
      "@/styles/*": ["styles/*"],
      "@/common/*": ["common/*"],
      // FIX para m贸dulos (lucide-react, etc. que est谩n en node_modules)
      "*": ["../../*"] 
    }
  },
  "include": [
    "next-env.d.ts", 
    "**/*.ts", 
    "**/*.tsx", 
    ".next/types/**/*.ts"
  ],
  "exclude": ["node_modules"]
}

================================================================================
FILE: CHANGELOG.md
================================================================================
---

### 2.  `CHANGELOG.md`

Este archivo registrar谩 la historia de cambios. He documentado todo lo que acabamos de arreglar bajo la versi贸n **1.1.0**. Gu谩rdalo tambi茅n en la **ra铆z**.

```markdown
# Changelog

Todos los cambios notables en el proyecto **ControlData** ser谩n documentados en este archivo.

El formato se basa en [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
y este proyecto adhiere a Semantic Versioning.

## [Unreleased]
- Planificaci贸n de m贸dulo de reportes avanzados.

## [1.1.0] - 2025-12-04 (Estabilizaci贸n y Fixes Cr铆ticos)

###  Agregado (Added)
- **Diagn贸stico de Sistema:** Nuevo endpoint `checkSystemHealth` y servicio en frontend para monitorear el estado de Node.js, Base de Datos y Latencia en tiempo real.
- **Gesti贸n de Ausencias:** Implementaci贸n completa (Backend/Frontend) para registrar novedades (Vacaciones, Enfermedad) validando reglas de negocio.
- **Seguridad Multi-tenant:** Ahora `findAllEmployees` acepta un filtro `clientId` para asegurar que los administradores solo vean empleados de la empresa seleccionada.
- **Endpoints Faltantes:** Se expusieron `manageAbsences` y `checkSystemHealth` en `index.ts`.

###  Corregido (Fixed)
- **Error de Build Frontend:** Se solucion贸 la falta de exportaci贸n de `callCheckSystemHealth` en `firebase-client.service.ts`.
- **Inyecci贸n de Dependencias (Backend):** Se registr贸 correctamente `AbsenceService` en `DataManagementModule` y se export贸 `WorkloadService` desde `SchedulingModule` para resolver errores de inicio de NestJS.
- **Errores de Importaci贸n:** Corregidos alias y rutas en `AbsenceManagementPage`.
- **Credenciales:** Actualizaci贸n y verificaci贸n de credenciales de Firebase en el cliente.

###  Modificado (Changed)
- Refactorizaci贸n de `firebase-client.service.ts` para incluir todas las definiciones `Callable` necesarias.
- Actualizaci贸n de `index.ts` (Functions) para soportar los nuevos m贸dulos de RRHH y Diagn贸stico.

## [1.0.0] - 2025-11-20
- Lanzamiento inicial del MVP.
- Funcionalidades b谩sicas: Login, Dashboard Admin, Scheduler Drag & Drop.

================================================================================
FILE: crear-admin.js
================================================================================
const admin = require('firebase-admin');
const serviceAccount = require('./service-account.json'); // 锔 OJO AQU

// Inicializar
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

const email = 'admin@bacar.com'; //  TU EMAIL DE ADMIN
const password = 'password123'; //  TU CONTRASEA

async function createSuperAdmin() {
  try {
    // 1. Crear usuario
    const userRecord = await admin.auth().createUser({
      email: email,
      password: password,
      displayName: 'Super Admin',
      emailVerified: true,
    });

    console.log('Usuario creado:', userRecord.uid);

    // 2. Asignar Custom Claim 'admin'
    await admin.auth().setCustomUserClaims(userRecord.uid, { role: 'admin' });
    console.log('Rol de ADMIN asignado exitosamente.');

    // 3. Crear perfil en Firestore (Opcional, para que no falle la UI)
    await admin.firestore().collection('empleados').doc(userRecord.uid).set({
        uid: userRecord.uid,
        name: 'Super Admin',
        email: email,
        role: 'admin',
        isAvailable: true
    });
    console.log('Perfil en Firestore creado.');

  } catch (error) {
    console.error('Error:', error);
  }
}

createSuperAdmin();

================================================================================
FILE: eslint.config.js
================================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])


================================================================================
FILE: firebase.json
================================================================================
{
  "functions": [
    {
      "source": "apps/functions",
      "codebase": "default",
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log"
      ],
      "predeploy": [
        "npm --prefix \"$RESOURCE_DIR\" run build"
      ]
    }
  ],
  "hosting": {
    "public": "apps/web/out",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "cleanUrls": true,
    "trailingSlash": false,
    "rewrites": [
      {
        "source": "**",
        "destination": "/404.html"
      }
    ]
  }
}

================================================================================
FILE: firestore.indexes.json
================================================================================
{
  "indexes": [
    {
      "collectionGroup": "ausencias",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "employeeId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "endDate",
          "order": "ASCENDING"
        }
      ]
    },
    {
      "collectionGroup": "turnos",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "employeeId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "startTime",
          "order": "ASCENDING"
        }
      ]
    }
  ],
  "fieldOverrides": []
}

================================================================================
FILE: firestore.rules
================================================================================
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIONES AUXILIARES ---
    
    // Verifica si el usuario tiene un rol administrativo v谩lido
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.role == 'admin' || 
        request.auth.token.role == 'SuperAdmin' || 
        request.auth.token.role == 'Scheduler' || 
        request.auth.token.role == 'HR_Manager'
      );
    }
    
    // Verifica si el usuario es el due帽o del documento
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // --- REGLAS POR COLECCIN ---

    // 1. Turnos (Operativo)
    match /turnos/{shiftId} {
      // Admins ven y editan todo
      allow read: if isAdmin();
      // Empleados solo ven sus propios turnos
      allow read: if request.auth != null && resource.data.employeeId == request.auth.uid;
      // Solo admins escriben (asignaci贸n)
      allow write: if isAdmin();
    }

    // 2. Empleados (RRHH)
    match /empleados/{employeeId} {
      // Admins gestionan todo
      allow read, write: if isAdmin();
      // Empleado ve su propio perfil
      allow read: if isOwner(employeeId);
    }

    // 3. Ausencias / Novedades
    match /ausencias/{absenceId} {
      allow read, write: if isAdmin();
      // Empleado puede ver sus propias ausencias
      allow read: if request.auth != null && resource.data.employeeId == request.auth.uid;
    }

    // 4. Jerarqu铆a Comercial (Clientes, Objetivos, Contratos)
    match /clientes/{clientId} {
      allow read, write: if isAdmin();
    }
    match /objetivos/{objectiveId} {
      allow read, write: if isAdmin();
    }
    match /contratos_servicio/{contractId} {
      allow read, write: if isAdmin();
    }
    match /tipos_turno/{typeId} {
      allow read, write: if isAdmin();
    }

    // 5. Usuarios del Sistema (Back-Office)
    match /system_users/{userId} {
      // Solo admins pueden ver/editar usuarios del sistema
      allow read, write: if isAdmin();
    }
  }
}

================================================================================
FILE: package.json
================================================================================
{
  "name": "cronoapp",
  "version": "1.0.0",
  "description": "Monorepositorio para la aplicaci贸n de cronogramas. Contiene Frontend (web) y Backend (functions).",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: Los tests se ejecutan en las subcarpetas: npm run test --workspace=functions\" && exit 1",
    "install:all": "npm install --workspaces",
    "dev:backend": "npm run serve --workspace=functions",
    "dev:frontend": "npm run dev --workspace=web"
  },
  "keywords": [
    "firebase",
    "nestjs",
    "nextjs",
    "typescript",
    "monorepo"
  ],
  "author": "Vale - Senior Tech Lead",
  "license": "ISC",
  "dependencies": {
    "firebase-admin": "^13.6.0",
    "lucide-react": "^0.555.0"
  }
}


================================================================================
FILE: README.md
================================================================================
# ControlData (Cronoapp)

**ControlData** es una plataforma SaaS de gesti贸n de fuerza laboral (WFM), dise帽ada para empresas de seguridad y servicios. Permite la gesti贸n integral de empleados, control de asistencia por geolocalizaci贸n, planificaci贸n de turnos y administraci贸n multi-empresa (Multi-tenancy).

## 锔 Arquitectura y Stack

El proyecto es un **Monorepo** que integra Frontend y Backend:

* **Frontend (`apps/web`):**
    * **Framework:** Next.js 16 (Static Export).
    * **Estilos:** Tailwind CSS.
    * **Estado/L贸gica:** React Context (ClientContext) + Hooks personalizados.
* **Backend (`apps/functions`):**
    * **Runtime:** Firebase Cloud Functions (Node.js 20).
    * **Framework:** NestJS (Inyecci贸n de dependencias y arquitectura modular).
    * **Base de Datos:** Firestore (NoSQL).
    * **Auth:** Firebase Authentication (Custom Claims para roles).

##  Requisitos Previos

* Node.js v20+
* NPM
* Firebase CLI (`npm install -g firebase-tools`)
* Java (Opcional, solo si se desea usar el Emulador de Firebase localmente)

## 锔 Instalaci贸n y Configuraci贸n

1.  **Clonar/Descargar el repositorio.**
2.  **Instalar dependencias ra铆z y workspaces:**
    ```bash
    npm install
    ```

##  Desarrollo Local

### Backend (Functions)
Para compilar y observar cambios en el backend TypeScript:
```bash
npm run build --prefix apps/functions -- --watch
# O para levantar emuladores (si est谩n configurados)
npm run serve --prefix apps/functions

================================================================================
FILE: service-account.json.json
================================================================================
{
  "type": "service_account",
  "project_id": "comtroldata",
  "private_key_id": "542b807649adab8f5142487ad529a0522adff565",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC+EARTAdAae35J\n11vk1mozAg+JRUgHjJ3n2tgcHHJToQZZdWBN090Q2nyxM3j4cdoR5BrDV9x5nhSj\nIU9QTE9Z2Sc4iFx6xac1Di8JdZpWXb7S3Y1n2EIPyeVJLiejzLYExG/ha9JV8mO9\nj0eD+UShtTHXVWhToA/6Jm2o1IZlmoWdTH9cDd8frMAYIOi8aZmpR/rP5H7RGRej\nAvRqoC9eoizbA8u0QHGzkIAvezbOgCBy55J/bVZ1N7ARitdGsnIbiK5H9Sv9QIjC\n0kz+EIdAMH6K3B8YuwtmCX53TMO8xBeGs+CTwXM86tic50WbdnTRV88uAOTEbTBC\nZPr8EiVNAgMBAAECggEAPfzeVC5Gr6RwU2f8Th3KRDmbVJN2gxPPGmPrUPvMI89k\nUT/xeWCsfIct3ONjRHBphaVGP0jEHRw8Mdo20oMY7D5hRtReiSI2vxyRpb2n6Rwp\nFP/yUxiaryiTcfMuNYOaJ+LjdHtkfeiQtC3rTrU5N55vk4IFBSUyoMzwvfwWm0Mi\nJfqmtGO0ADAUGgftkZlmd7Vh7yt3JNJRbsZW/hZFIAAsg7o8kQZ+5Frwmwo8Ntn+\nUd4QryPAtBEUgTeafdeCKzs49Yi3RdbB60CBrcCq8uHgKGPP8xoga2VIIbx+smgr\nV6rDp0GPXpEz3P5pq6LBKAQkfMd/1PMe7B0kCxPQpwKBgQD2X7befQ7JrR+HqZr0\nMnJlzOFUbZT9TOL70e0LhOK7UE5tV5PXC1am8DIx/zuMcIC80f8hnyelHHopEv4+\nvyChk4/U2NbU0ECxPqmDsFsIJJRt/Tc3/9TR8S3L7ZM7s+AezkxuEourrq5DSU1i\n2gLuee1V85oANt3+zUBnt69/BwKBgQDFfRB8MP3GDEk5Y3lm+k8o+P9iLM4V/ZFQ\ny57wq9pEZxWTbXyWefaN7aeg3wRxVpNQTK0HaT8mNppSBeI9c7S3EL5SbvkCyTUk\nVHTN8o4BnQizVwkv5+ILU8UGW6dz/JFhxw55HyiiJO9bbxWzbCQK6pioCOVHDrf7\nZafvlp7QCwKBgQCTDJXNPb8xyE7lXenKjsGQ2TQ0fCNM/DMOMkHVej8JpejpgjgP\nRgk2Im8TQE9+hzePe5dXrfKvrcuL8HYnZVRInBZg5/txkcrK/6eVnhD3Tz34WAY5\nOkz/8X9wFCCopbfDK0aa/B65Hc2NA5dYxN6zD7sEbh0gu57Mkh06ynvIyQKBgQCV\nDSI/CV7PdgBh/vDmxu6t9tgRCc31DO77MuNfs+TFkaPYJF9O1vg+AGtu4ENjIzuF\n9Ij3Ofj+Z2GrnGM3jDeNn2Z1ounvr1qbc97AfVuuXg3uBTea34FcmTnv5YcJ5Er5\nqBoFUn4BeqzornuLcof1cUAMOsKJEdPMOto32s88JwKBgBts8voUhdhCqWu7sDLB\nF6fAuzOQxKxiWB0CPn8GHNJwZgjiPB5+Hj9mZRyfsS5Bn8fmCrC8q4MTpKmpURMd\nxmXteJP63Y6z2TQz8DhfVL84/0cTxC9nkRFqYeIkz+AiHkP8aw5u95f3QbThaGiM\nQzvcb4tHgOvJh5+G4cOnOfHH\n-----END PRIVATE KEY-----\n",
  "client_email": "firebase-adminsdk-fbsvc@comtroldata.iam.gserviceaccount.com",
  "client_id": "109561112383296200622",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-fbsvc%40comtroldata.iam.gserviceaccount.com",
  "universe_domain": "googleapis.com"
}


================================================================================
FILE: set-admin-role.js
================================================================================
const admin = require('firebase-admin');
// Aseg煤rate de tener tu archivo de credenciales aqu铆
const serviceAccount = require('./service-account.json'); 

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

const uid = 'BIar6f7ILATdkucXKH9NTDUkKQG2'; //  COPIA AQU EL UID DE TU USUARIO QUE FALLA

async function setAdminRole() {
  try {
    // 1. Asignar el Custom Claim 'role: admin'
    await admin.auth().setCustomUserClaims(uid, { role: 'admin' });
    
    console.log(` XITO: Rol de admin asignado al usuario ${uid}`);
    console.log('锔 IMPORTANTE: Debes cerrar sesi贸n y volver a entrar para que el token se actualice.');
    
    // Verificaci贸n
    const user = await admin.auth().getUser(uid);
    console.log('Claims actuales:', user.customClaims);
    
  } catch (error) {
    console.error(' Error:', error);
  }
}

setAdminRole();

================================================================================
FILE: set-employee-role.js
================================================================================
const admin = require('firebase-admin');
const serviceAccount = require('./service-account.json'); 

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount)
  });
}

//  ESTE ES EL UID QUE SAQU DE TU CAPTURA DE PANTALLA
const uid = 'MBKd9pqsSPXPcxsLxyPUdC8NFCd2'; 

async function setEmployeeRole() {
  try {
    console.log(` Buscando usuario ${uid}...`);
    
    // 1. Asignar el Custom Claim en Auth (El sello en la tarjeta)
    await admin.auth().setCustomUserClaims(uid, { role: 'employee' });
    
    console.log(` XITO: Rol 'employee' asignado a D茅bora.`);
    console.log(`锔 IMPORTANTE: Ella debe cerrar sesi贸n y volver a entrar.`);

  } catch (error) {
    console.error(' Error:', error.message);
  }
}

setEmployeeRole();

================================================================================
FILE: vite.config.js
================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react-swc'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})

