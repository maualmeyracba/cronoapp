"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[431],{27431:function(e,t,a){a.d(t,{A:function(){return useOperacionesMonitor}});var i=a(67294),n=a(93504),s=a(28477),o=a(85876),r=a(64712);let getSafeDate=e=>{if(!e)return null;try{if(e.toDate&&"function"==typeof e.toDate)return e.toDate();if(e instanceof Date)return e;if(e.seconds)return new Date(1e3*e.seconds);if("string"==typeof e||"number"==typeof e)return new Date(e)}catch(e){}return null},formatName=e=>{if(!e)return"Operador";try{if("object"==typeof e){if(e.displayName&&e.displayName.length>1)return e.displayName;if(e.email)return e.email.split("@")[0].replace(/[0-9._-]/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ").trim()}if("string"==typeof e&&e.includes("@"))return e.split("@")[0].replace(/[0-9._-]/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ").trim();if("string"==typeof e)return e}catch(e){}return"Operador"},useOperacionesMonitor=()=>{let[e,t]=(0,i.useState)(new Date),[a,l]=(0,i.useState)([]),[d,c]=(0,i.useState)([]),[u,m]=(0,i.useState)([]),[f,p]=(0,i.useState)([]),[N,A]=(0,i.useState)([]),[h,b]=(0,i.useState)({toleranceLate:15,toleranceAbsent:60,toleranceRetention:15}),[E,D]=(0,i.useState)({name:"",startTime:new Date}),[I,g]=(0,i.useState)("PRIORIDAD"),[T,C]=(0,i.useState)(""),[O,v]=(0,i.useState)(!1),[S,R]=(0,i.useState)({checkout:!1,novedad:!1,coverage:!1}),[j,w]=(0,i.useState)(null),[P,y]=(0,i.useState)({tipo:"Llegada Tarde",nota:""}),_=(0,i.useRef)([]),L=(0,i.useRef)([]),U=(0,i.useRef)([]);(0,i.useEffect)(()=>{let e=setInterval(()=>t(new Date),3e4);return()=>clearInterval(e)},[]),(0,i.useEffect)(()=>{let e=(0,o.v0)(),t=e.onAuthStateChanged(e=>{e&&D(t=>({...t,name:formatName(e)}))});return()=>t()},[]),(0,i.useEffect)(()=>{let e=new Date;e.setHours(0,0,0,0);let t=(0,n.cf)((0,n.IO)((0,n.hJ)(s.db,"audit_logs"),(0,n.ar)("timestamp",">=",n.EK.fromDate(e)),(0,n.b9)(100)),e=>{let t=e.docs.map(e=>({id:e.id,...e.data(),time:getSafeDate(e.data().timestamp),formattedActor:formatName(e.data().actorName||e.data().actor||"Sistema"),fullDetail:e.data().details||e.data().notes||"-"}));A(t.sort((e,t)=>t.time-e.time))}),fetchConfig=async()=>{try{let e=await (0,n.PL)((0,n.IO)((0,n.hJ)(s.db,"config"),(0,n.b9)(1)));e.empty||b({...h,...e.docs[0].data()})}catch(e){}};fetchConfig();let a=(0,n.cf)((0,n.hJ)(s.db,"empleados"),e=>c(e.docs.map(e=>({id:e.id,fullName:"".concat(e.data().lastName||""," ").concat(e.data().firstName||"").trim()||e.data().name||"Sin Nombre",...e.data()})))),i=(0,n.cf)((0,n.hJ)(s.db,"clients"),e=>{let t=[];e.docs.forEach(e=>{let a=e.data();a.objetivos?a.objetivos.forEach(i=>{t.push({...i,clientName:a.name,clientId:e.id})}):t.push({id:e.id,name:a.name,clientName:a.name})}),m(t),U.current=t}),o=(0,n.cf)((0,n.IO)((0,n.hJ)(s.db,"servicios_sla"),(0,n.ar)("status","==","active")),e=>{let t=e.docs.map(e=>({id:e.id,...e.data()}));p(t),_.current=t});return()=>{t(),a(),i(),o()}},[]),(0,i.useEffect)(()=>{let e=new Date;e.setHours(0,0,0,0),e.setDate(e.getDate()-1);let t=new Date;return t.setHours(23,59,59,999),t.setDate(t.getDate()+1),(0,n.cf)((0,n.IO)((0,n.hJ)(s.db,"turnos"),(0,n.ar)("startTime",">=",n.EK.fromDate(e)),(0,n.ar)("startTime","<=",n.EK.fromDate(t))),e=>{l(e.docs.map(e=>{let t=e.data(),a=getSafeDate(t.startTime),i=getSafeDate(t.endTime)||new Date(a.getTime()+288e5);return{id:e.id,...t,shiftDateObj:a,endDateObj:i,visualEndDateObj:i}}))})},[]);let G=(0,i.useMemo)(()=>{let t=a.map(t=>{if(!t.shiftDateObj)return null;let a="UNCOVERED_REPORTED"===t.status||!0===t.reportedToPlanning,i="COMPLETED"===t.status||!!t.isCompleted,n="PRESENT"===t.status||"CHECK_IN"===t.status||!!t.isPresent,s=!!t.isRetention,o=!t.employeeId||"VACANTE"===t.employeeId,r=(e.getTime()-t.shiftDateObj.getTime())/6e4,l=!n&&!i&&r>h.toleranceLate,c=!n&&!i&&r>h.toleranceAbsent,m="ABSENT"===t.status||!!t.isAbsent,p="PLANIFICADO";a?p="EN PLANIFICACI\xd3N":o?p="VACANTE":s?p="RETENIDO":n?p="EN SERVICIO":i?p="FINALIZADO":l&&(p="LLEGADA TARDE");let N=u.find(e=>e.id===t.objectiveId||e.name===t.objectiveName),A=t.positionName||t.position||"Puesto General",b=f.find(e=>e.objectiveId===t.objectiveId);if(b&&b.positions){let e=b.positions.find(e=>e.id===t.positionId);e&&e.name?A=e.name:1===b.positions.length&&b.positions[0].name&&(A=b.positions[0].name)}let E=t.employeeName;if(!E&&t.employeeId&&"VACANTE"!==t.employeeId){let e=d.find(e=>e.id===t.employeeId);e&&(E=e.fullName)}return o&&(E="VACANTE"),E||(E="Sin Asignar"),{...t,clientName:(null==N?void 0:N.clientName)||t.clientName,objectiveName:(null==N?void 0:N.name)||t.objectiveName,positionName:A,employeeName:E,isUnassigned:o,isRetention:s,isReported:a,isPresent:n,isCompleted:i,statusText:p,isLate:l,isCriticallyLate:c,isAbsent:m,hasPendingIssue:!i&&!a&&(s||o||l)}}).filter(Boolean),i=[],n=e.toDateString();f.forEach(a=>{let s=a.objectiveId,o=a.positions||[],r=u.find(e=>e.id===s)||{name:a.objectiveName||"Objetivo",clientName:a.clientName||"Cliente"},l=t.filter(e=>{var t;return e.objectiveId===s&&(null===(t=e.shiftDateObj)||void 0===t?void 0:t.toDateString())===n});o.forEach(t=>{let n=parseInt(t.quantity||"1",10),o=(t.coverageType||"").toLowerCase().includes("24hs")||t.M&&t.T&&t.N,d=(t.name||"").toUpperCase(),c=l.filter(e=>e.positionId===t.id||(e.positionName||"").toUpperCase()===d),u=t.name||"Guardia",m=[];o?(m.push({code:"M",start:5,end:12,label:"TURNO MA\xd1ANA"}),m.push({code:"T",start:13,end:20,label:"TURNO TARDE"}),m.push({code:"N",start:21,end:29,label:"TURNO NOCHE"})):m.push({code:"G",start:0,end:24,label:"TURNO GENERAL"}),m.forEach(o=>{let l=c.filter(e=>{let t=e.shiftDateObj.getHours();return t>=o.start&&t<=o.end}).length,d=n-l;if(d>0)for(let n=0;n<d;n++){let l=new Date(e);l.setHours(0===o.start?9:5===o.start?7:13===o.start?15:23,0,0,0),i.push({id:"SLA_GAP_".concat(a.id,"_").concat(t.id,"_").concat(o.code,"_").concat(n),employeeName:"FALTANTE ".concat(o.label),clientName:r.clientName,objectiveName:r.name,positionName:u,shiftDateObj:l,endDateObj:new Date(l.getTime()+288e5),hasPendingIssue:!0,isSlaGap:!0,statusText:"VACANTE DE CONTRATO",objectiveId:s,positionId:t.id,clientId:a.clientId})}})})});let s=[...t,...i].sort((e,t)=>e.shiftDateObj-t.shiftDateObj);return L.current=s,s},[a,e,d,u,f,h]),M=(0,i.useMemo)(()=>({total:G.filter(e=>e.isCompleted).length,prioridad:G.filter(e=>(e.hasPendingIssue||e.isSlaGap)&&!e.isReported).length,retenidos:G.filter(e=>e.isRetention).length,aunNo:G.filter(e=>!e.isLate&&!e.isPresent&&!e.isAbsent&&!e.isCompleted&&!e.isRetention).length,activos:G.filter(e=>e.isPresent&&!e.isCompleted&&!e.isRetention).length,ausentes:G.filter(e=>e.isAbsent).length,planificado:G.filter(t=>t.shiftDateObj>e&&!t.isUnassigned&&!t.isCompleted&&!t.isSlaGap).length}),[G,e]),H=(0,i.useMemo)(()=>{let t=G;if(T){let e=T.toLowerCase();t=t.filter(t=>(t.employeeName||"").toLowerCase().includes(e)||(t.clientName||"").toLowerCase().includes(e))}switch(I){case"PRIORIDAD":return t.filter(e=>(e.hasPendingIssue||e.isSlaGap)&&!e.isReported&&!e.isPresent);case"RETENIDOS":return t.filter(e=>e.isRetention);case"AUN_NO":return t.filter(t=>t.shiftDateObj>e&&!t.isPresent&&!t.isCompleted&&!t.isRetention&&!t.isSlaGap&&!t.isReported);case"ACTIVOS":return t.filter(e=>e.isPresent&&!e.isCompleted&&!e.isRetention);case"AUSENTES":return t.filter(e=>e.isAbsent);case"PLANIFICADO":return t.filter(t=>t.shiftDateObj>e&&!t.isUnassigned&&!t.isCompleted&&!t.isAbsent&&!t.isSlaGap&&!t.isReported);case"HOY":return t.filter(e=>e.isCompleted||e.isReported||e.isResolved);default:return t}},[G,I,T,e]),handleAction=async(e,t,i)=>{if("NOTIFY_GAP"===e){w(t),y({tipo:"Falta de Cobertura (Notificar)",nota:"Reportado desde panel de resoluci\xf3n"}),confirmNovedad(t,"Falta de Cobertura (Notificar)");return}if(t.startsWith("SLA_GAP_")){r.Am.error("Para un faltante de SLA, use 'RESOLVER' o 'NOTIFICAR'.");return}let l=a.find(e=>e.id===t);if(!l)return;w(t);let d=(0,o.v0)(),c=d.currentUser,u=formatName(c);try{"CHECKIN"===e?(await (0,n.r7)((0,n.JU)(s.db,"turnos",t),{status:"PRESENT",isPresent:!0,realStartTime:(0,n.Bt)(),checkInMethod:"MANUAL_DASHBOARD"}),await (0,n.ET)((0,n.hJ)(s.db,"audit_logs"),{action:"MANUAL_CHECKIN",targetShiftId:t,actorName:u,timestamp:(0,n.Bt)(),details:"Ingreso manual"}),r.Am.success("Ingreso registrado")):"CHECKOUT"===e?(await (0,n.r7)((0,n.JU)(s.db,"turnos",t),{status:"COMPLETED",isCompleted:!0,isPresent:!1,realEndTime:(0,n.Bt)(),checkoutNote:i||null}),await (0,n.ET)((0,n.hJ)(s.db,"audit_logs"),{action:"MANUAL_CHECKOUT",targetShiftId:t,actorName:u,timestamp:(0,n.Bt)(),details:i?"Salida: ".concat(i):"Salida normal"}),r.Am.success("Salida registrada")):"NOVEDAD"===e&&R(e=>({...e,novedad:!0}))}catch(e){r.Am.error("Error en acci\xf3n")}w(null)},confirmNovedad=async(e,t)=>{let a=e||j,i=t||P.tipo;if(!a)return;let l=(0,o.v0)(),d=l.currentUser,c=formatName(d);try{let e=a.startsWith("SLA_GAP_");if(i.includes("Notificar")){let t="Guardia",i=null,o=null,l=new Date,d="Cliente",f="Objetivo",p="Ma\xf1ana";if(e){let e=a.split("_");if(e.length>=4){let a=e[2],n=e[3];if(e.length>=5){let t=e[4],a=new Date;"M"===t?(a.setHours(7,0,0,0),p="Ma\xf1ana"):"T"===t?(a.setHours(15,0,0,0),p="Tarde"):"N"===t&&(a.setHours(23,0,0,0),p="Noche"),l=a}let s=_.current.find(e=>e.id===a);if(s){var u,m;i=s.objectiveId,o=s.clientId,d=s.clientName||"Cliente",f=s.objectiveName||"Objetivo";let e=null===(u=s.positions)||void 0===u?void 0:u.find(e=>String(e.id)===String(n));!e&&(null===(m=s.positions)||void 0===m?void 0:m.length)>0&&(e=s.positions[0]),e&&e.name&&(t=e.name)}}if(!i){let e=L.current.find(e=>e.id===a);e&&(i=e.objectiveId,o=e.clientId,t=e.positionName||"Guardia",e.shiftDateObj&&(l=e.shiftDateObj),d=e.clientName,f=e.objectiveName)}if(i&&"Objetivo"===f){let e=U.current.find(e=>e.id===i);e&&(f=e.name,d=e.clientName)}if(!i)throw Error("No se pudo identificar el objetivo.");let r={objectiveId:i,clientId:o,clientName:d,objectiveName:f,positionName:t,type:p,startTime:n.EK.fromDate(l||new Date),endTime:n.EK.fromDate(new Date((l||new Date).getTime()+288e5)),status:"UNCOVERED_REPORTED",isReported:!0,reportedToPlanning:!0,employeeName:"VACANTE (A ASIGNAR)",employeeId:"VACANTE",client:{id:o,name:d,razonsocial:d},objective:{id:i,name:f},metadata:{alertTitle:"Vacante: ".concat(t)},createdAt:(0,n.Bt)(),generatedFromSlaGap:!0};Object.keys(r).forEach(e=>void 0===r[e]&&delete r[e]),await (0,n.ET)((0,n.hJ)(s.db,"turnos"),r)}else await (0,n.r7)((0,n.JU)(s.db,"turnos",a),{status:"UNCOVERED_REPORTED",isReported:!0,reportedToPlanning:!0,comments:"No se planific\xf3 turno en puesto ".concat(t),reportedAt:(0,n.Bt)()});await (0,n.ET)((0,n.hJ)(s.db,"audit_logs"),{action:"SLA_REPORT",targetShiftId:a,actorName:c,timestamp:(0,n.Bt)(),details:"Notific\xf3 falta en ".concat(t)}),r.Am.success("Notificado a planificaci\xf3n.")}else await (0,n.ET)((0,n.hJ)(s.db,"novedades"),{shiftId:a,type:i,notes:P.nota,createdAt:(0,n.Bt)(),viewed:!1}),await (0,n.r7)((0,n.JU)(s.db,"turnos",a),{hasNovedad:!0}),r.Am.success("Novedad reportada");R(e=>({...e,novedad:!1}))}catch(e){console.error("Error t\xe9cnico:",e),r.Am.error("No se pudo notificar: "+e.message)}w(null)};return{now:e,processedData:G,listData:H,stats:M,recentLogs:N,objectives:u,servicesSLA:f,operatorInfo:E,formatName,viewTab:I,setViewTab:g,filterText:T,setFilterText:C,isCompact:O,setIsCompact:v,modals:S,setModals:R,handleAction,processingId:j,confirmNovedad,novedadData:P,setNovedadData:y}}},28477:function(e,t,a){a.d(t,{I8:function(){return l},db:function(){return d},wk:function(){return c}});var i=a(83977),n=a(85876),s=a(93504),o=a(23914);let r=(0,i.C6)().length?(0,i.Mq)():(0,i.ZF)({apiKey:"AIzaSyBJaTiMekwbGPXAm-mkPl_u6KEWCSpvfic",authDomain:"comtroldata.firebaseapp.com",projectId:"comtroldata",storageBucket:"comtroldata.firebasestorage.app",messagingSenderId:"698108879063",appId:"1:698108879063:web:ab30eb8b80a774f52f1092"}),l=(0,n.v0)(r),d=(0,s.ad)(r),c=(0,o.$C)(r)}}]);