"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[431],{27431:function(e,t,a){a.d(t,{A:function(){return useOperacionesMonitor}});var i=a(67294),s=a(93504),n=a(28477),r=a(85876),o=a(64712);let getSafeDate=e=>{if(!e)return null;try{if(e.toDate&&"function"==typeof e.toDate)return e.toDate();if(e instanceof Date)return e;if(e.seconds)return new Date(1e3*e.seconds);if("string"==typeof e||"number"==typeof e)return new Date(e)}catch(e){}return null},formatName=e=>{if(!e)return"Operador";try{if("object"==typeof e){if(e.displayName&&e.displayName.length>1)return e.displayName;if(e.email)return e.email.split("@")[0].replace(/[0-9._-]/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ").trim()}if("string"==typeof e&&e.includes("@"))return e.split("@")[0].replace(/[0-9._-]/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ").trim();if("string"==typeof e)return e}catch(e){}return"Operador"},useOperacionesMonitor=()=>{let[e,t]=(0,i.useState)(new Date),[a,l]=(0,i.useState)([]),[d,c]=(0,i.useState)([]),[u,m]=(0,i.useState)([]),[f,p]=(0,i.useState)([]),[N,h]=(0,i.useState)([]),[A,E]=(0,i.useState)({toleranceLate:15,toleranceAbsent:60,toleranceRetention:15}),[b,g]=(0,i.useState)({name:"",startTime:new Date}),[D,I]=(0,i.useState)("PRIORIDAD"),[T,v]=(0,i.useState)(""),[C,S]=(0,i.useState)(!1),[O,R]=(0,i.useState)({checkout:!1,novedad:!1,coverage:!1}),[w,P]=(0,i.useState)(null),[j,L]=(0,i.useState)({tipo:"Llegada Tarde",nota:""}),_=(0,i.useRef)([]),y=(0,i.useRef)([]),U=(0,i.useRef)([]);(0,i.useEffect)(()=>{let e=setInterval(()=>t(new Date),3e4);return()=>clearInterval(e)},[]),(0,i.useEffect)(()=>{let e=(0,r.v0)(),t=e.onAuthStateChanged(e=>{e&&g(t=>({...t,name:formatName(e)}))});return()=>t()},[]),(0,i.useEffect)(()=>{let e=new Date;e.setHours(0,0,0,0);let t=(0,s.cf)((0,s.IO)((0,s.hJ)(n.db,"audit_logs"),(0,s.ar)("timestamp",">=",s.EK.fromDate(e)),(0,s.b9)(100)),e=>{let t=e.docs.map(e=>({id:e.id,...e.data(),time:getSafeDate(e.data().timestamp),formattedActor:formatName(e.data().actorName||e.data().actor||"Sistema"),fullDetail:e.data().details||e.data().notes||"-"}));h(t.sort((e,t)=>t.time-e.time))}),fetchConfig=async()=>{try{let e=await (0,s.PL)((0,s.IO)((0,s.hJ)(n.db,"config"),(0,s.b9)(1)));e.empty||E({...A,...e.docs[0].data()})}catch(e){}};fetchConfig();let a=(0,s.cf)((0,s.hJ)(n.db,"empleados"),e=>c(e.docs.map(e=>({id:e.id,fullName:"".concat(e.data().lastName||""," ").concat(e.data().firstName||"").trim()||e.data().name||"Sin Nombre",...e.data()})))),i=(0,s.cf)((0,s.hJ)(n.db,"clients"),e=>{let t=[];e.docs.forEach(e=>{let a=e.data();a.objetivos?a.objetivos.forEach(i=>{t.push({...i,clientName:a.name,clientId:e.id})}):t.push({id:e.id,name:a.name,clientName:a.name})}),m(t),U.current=t}),r=(0,s.cf)((0,s.IO)((0,s.hJ)(n.db,"servicios_sla"),(0,s.ar)("status","==","active")),e=>{let t=e.docs.map(e=>({id:e.id,...e.data()}));p(t),_.current=t});return()=>{t(),a(),i(),r()}},[]),(0,i.useEffect)(()=>{let e=new Date;e.setHours(0,0,0,0),e.setDate(e.getDate()-1);let t=new Date;return t.setHours(23,59,59,999),t.setDate(t.getDate()+1),(0,s.cf)((0,s.IO)((0,s.hJ)(n.db,"turnos"),(0,s.ar)("startTime",">=",s.EK.fromDate(e)),(0,s.ar)("startTime","<=",s.EK.fromDate(t))),e=>{l(e.docs.map(e=>{let t=e.data(),a=getSafeDate(t.startTime),i=getSafeDate(t.endTime)||new Date(a.getTime()+288e5);return{id:e.id,...t,shiftDateObj:a,endDateObj:i,visualEndDateObj:i}}))})},[]);let G=(0,i.useMemo)(()=>{let t=a.map(t=>{if(!t.shiftDateObj)return null;let a="UNCOVERED_REPORTED"===t.status||!0===t.reportedToPlanning,i="COMPLETED"===t.status||!!t.isCompleted,s="PRESENT"===t.status||"CHECK_IN"===t.status||!!t.isPresent,n=!!t.isRetention,r=!t.employeeId||"VACANTE"===t.employeeId,o=(e.getTime()-t.shiftDateObj.getTime())/6e4,l=!s&&!i&&o>A.toleranceLate,d=!s&&!i&&o>A.toleranceAbsent,c="ABSENT"===t.status||!!t.isAbsent,m="PLANIFICADO";a?m="EN PLANIFICACI\xd3N":r?m="VACANTE":n?m="RETENIDO":s?m="EN SERVICIO":i?m="FINALIZADO":l&&(m="LLEGADA TARDE");let p=u.find(e=>e.id===t.objectiveId||e.name===t.objectiveName),N=t.positionName||t.position||"Puesto General",h=f.find(e=>e.objectiveId===t.objectiveId);if(h&&h.positions){let e=h.positions.find(e=>e.id===t.positionId);e&&e.name?N=e.name:1===h.positions.length&&h.positions[0].name&&(N=h.positions[0].name)}return{...t,clientName:(null==p?void 0:p.clientName)||t.clientName,objectiveName:(null==p?void 0:p.name)||t.objectiveName,positionName:N,isUnassigned:r,isRetention:n,isReported:a,isPresent:s,isCompleted:i,statusText:m,isLate:l,isCriticallyLate:d,isAbsent:c,hasPendingIssue:!i&&!a&&(n||r||l)}}).filter(Boolean),i=[],s=e.toDateString();f.forEach(a=>{let n=a.objectiveId,r=a.positions||[],o=u.find(e=>e.id===n)||{name:a.objectiveName||"Objetivo",clientName:a.clientName||"Cliente"},l=t.filter(e=>{var t;return e.objectiveId===n&&(null===(t=e.shiftDateObj)||void 0===t?void 0:t.toDateString())===s});r.forEach(t=>{var s;let r=parseInt(t.quantity||"1",10),d=(t.coverageType||"").toLowerCase().replace(/\s/g,""),c="24hs"===d||(null===(s=t.tags)||void 0===s?void 0:s.includes("24HS"))||t.M&&t.T&&t.N,u=(t.name||"").toUpperCase(),m=l.filter(e=>e.positionId===t.id||(e.positionName||"").toUpperCase()===u),f=t.name;f&&"Puesto General"!==f||(f="Guardia");let p=[];c?(p.push({code:"M",start:5,end:12,label:"TURNO MA\xd1ANA"}),p.push({code:"T",start:13,end:20,label:"TURNO TARDE"}),p.push({code:"N",start:21,end:29,label:"TURNO NOCHE"})):p.push({code:"G",start:0,end:24,label:"TURNO GENERAL"}),p.forEach(s=>{let l=m.filter(e=>{let t=e.shiftDateObj.getHours();return t>=s.start&&t<=s.end}).length,d=r-l;if(d>0)for(let r=0;r<d;r++){let l=new Date(e);l.setHours(0===s.start?9:5===s.start?7:13===s.start?15:23,0,0,0),i.push({id:"SLA_GAP_".concat(a.id,"_").concat(t.id,"_").concat(s.code,"_").concat(r),employeeName:"FALTANTE ".concat(s.label),clientName:o.clientName,objectiveName:o.name,positionName:f,shiftDateObj:l,endDateObj:new Date(l.getTime()+288e5),hasPendingIssue:!0,isSlaGap:!0,statusText:"VACANTE DE CONTRATO",objectiveId:n,positionId:t.id,clientId:a.clientId})}})})});let n=[...t,...i].sort((e,t)=>e.shiftDateObj-t.shiftDateObj);return y.current=n,n},[a,e,d,u,f,A]),M=(0,i.useMemo)(()=>({total:G.filter(e=>e.isCompleted).length,prioridad:G.filter(e=>(e.hasPendingIssue||e.isSlaGap)&&!e.isReported).length,retenidos:G.filter(e=>e.isRetention).length,aunNo:G.filter(e=>!e.isLate&&!e.isPresent&&!e.isAbsent&&!e.isCompleted&&!e.isRetention).length,activos:G.filter(e=>e.isPresent&&!e.isCompleted&&!e.isRetention).length,ausentes:G.filter(e=>e.isAbsent||e.isCriticallyLate).length,planificado:G.filter(t=>t.shiftDateObj>e&&!t.isUnassigned&&!t.isCompleted&&!t.isSlaGap).length}),[G,e]),H=(0,i.useMemo)(()=>{let t=G;if(T){let e=T.toLowerCase();t=t.filter(t=>(t.employeeName||"").toLowerCase().includes(e)||(t.clientName||"").toLowerCase().includes(e))}switch(D){case"PRIORIDAD":return t.filter(e=>(e.hasPendingIssue||e.isCriticallyLate||e.isLate||e.isSlaGap)&&!e.isReported&&!e.isPresent);case"RETENIDOS":return t.filter(e=>e.isRetention);case"AUN_NO":return t.filter(e=>!e.isLate&&!e.isPresent&&!e.isAbsent&&!e.isCompleted&&!e.isRetention&&!e.isSlaGap&&!e.isReported);case"ACTIVOS":return t.filter(e=>e.isPresent&&!e.isCompleted&&!e.isRetention);case"AUSENTES":return t.filter(e=>e.isAbsent||e.isCriticallyLate);case"PLANIFICADO":return t.filter(t=>t.shiftDateObj>e&&!t.isUnassigned&&!t.isCompleted&&!t.isAbsent&&!t.isSlaGap&&!t.isReported);case"HOY":return t.filter(e=>e.isCompleted||e.isReported||e.isResolved);default:return t}},[G,D,T,e]),handleAction=async(e,t,i)=>{if("INSPECT"===e){try{if(t.startsWith("SLA_GAP_")){alert("Es un GAP Virtual.");return}let e=(0,s.JU)(n.db,"turnos",t),a=await (0,s.QT)(e);if(a.exists()){let e=a.data();alert(JSON.stringify(e,null,2))}}catch(e){alert("Error: "+e.message)}return}if("NOTIFY_GAP"===e){P(t),L({tipo:"Falta de Cobertura (Notificar)",nota:"Reportado desde panel de resoluci\xf3n"}),confirmNovedad(t,"Falta de Cobertura (Notificar)");return}if(t.startsWith("SLA_GAP_")){o.Am.error("Para un faltante de SLA, use 'RESOLVER' o 'NOTIFICAR'.");return}let l=a.find(e=>e.id===t);if(!l)return;P(t);let d=(0,r.v0)(),c=d.currentUser,u=formatName(c);try{if("CHECKIN"===e){let e=new Date,a=getSafeDate(l.startTime),i=a?(e.getTime()-a.getTime())/6e4:0;if(i>15){L({tipo:"Llegada Tarde",nota:"Ingreso con ".concat(Math.floor(i)," min de demora")}),R(e=>({...e,novedad:!0})),P(t);return}await (0,s.r7)((0,s.JU)(n.db,"turnos",t),{status:"PRESENT",isPresent:!0,realStartTime:(0,s.Bt)(),checkInMethod:"MANUAL_DASHBOARD"}),await (0,s.ET)((0,s.hJ)(n.db,"audit_logs"),{action:"MANUAL_CHECKIN",targetShiftId:t,actorName:u,timestamp:(0,s.Bt)(),details:"Ingreso manual"}),o.Am.success("Ingreso registrado")}else"CHECKOUT"===e?(await (0,s.r7)((0,s.JU)(n.db,"turnos",t),{status:"COMPLETED",isCompleted:!0,isPresent:!1,realEndTime:(0,s.Bt)(),checkoutNote:i||null}),await (0,s.ET)((0,s.hJ)(n.db,"audit_logs"),{action:"MANUAL_CHECKOUT",targetShiftId:t,actorName:u,timestamp:(0,s.Bt)(),details:i?"Salida: ".concat(i):"Salida normal"}),o.Am.success("Salida registrada")):"NOVEDAD"===e&&R(e=>({...e,novedad:!0}))}catch(e){o.Am.error("Error en acci\xf3n")}P(null)},confirmNovedad=async(e,t)=>{let a=e||w,i=t||j.tipo;if(!a)return;let l=(0,r.v0)(),d=l.currentUser,c=formatName(d);try{if("Llegada Tarde"===i&&!a.startsWith("SLA_GAP_")){await (0,s.r7)((0,s.JU)(n.db,"turnos",a),{status:"PRESENT",isPresent:!0,realStartTime:(0,s.Bt)(),checkInMethod:"MANUAL_DASHBOARD",hasNovedad:!0,novedadNote:j.nota}),await (0,s.ET)((0,s.hJ)(n.db,"novedades"),{shiftId:a,type:i,notes:j.nota,createdAt:(0,s.Bt)(),viewed:!1}),await (0,s.ET)((0,s.hJ)(n.db,"audit_logs"),{action:"LATE_CHECKIN",targetShiftId:a,actorName:c,timestamp:(0,s.Bt)(),details:"Ingreso tard\xedo registrado"}),o.Am.success("Ingreso tard\xedo registrado correctamente."),R(e=>({...e,novedad:!1})),P(null);return}let e=a.startsWith("SLA_GAP_");if(i.includes("Notificar")){let t="Guardia",i=null,r=null,l=new Date,d="Cliente",f="Objetivo",p="Ma\xf1ana";if(e){let e=a.split("_");if(e.length>=4){let a=e[2],s=e[3];if(e.length>=5){let t=e[4],a=new Date;"M"===t?(a.setHours(7,0,0,0),p="Ma\xf1ana"):"T"===t?(a.setHours(15,0,0,0),p="Tarde"):"N"===t?(a.setHours(23,0,0,0),p="Noche"):"D12"===t?(a.setHours(7,0,0,0),p="Diurno"):"N12"===t&&(a.setHours(19,0,0,0),p="Nocturno"),l=a}let n=_.current.find(e=>e.id===a);if(n){var u,m;i=n.objectiveId,r=n.clientId,d=n.clientName||"Cliente",f=n.objectiveName||"Objetivo";let e=null===(u=n.positions)||void 0===u?void 0:u.find(e=>String(e.id)===String(s));!e&&(null===(m=n.positions)||void 0===m?void 0:m.length)>0&&(e=n.positions[0]),e&&e.name&&(t=e.name)}}if(!i){let e=y.current.find(e=>e.id===a);e&&(i=e.objectiveId,r=e.clientId,t=e.positionName||"Guardia",e.shiftDateObj&&(l=e.shiftDateObj),d=e.clientName,f=e.objectiveName)}if(i&&"Objetivo"===f){let e=U.current.find(e=>e.id===i);e&&(f=e.name,d=e.clientName)}if(!i)throw Error("No se pudo identificar el objetivo.");let o={objectiveId:i,clientId:r,clientName:d,objectiveName:f,positionName:t,type:p,startTime:s.EK.fromDate(l||new Date),endTime:s.EK.fromDate(new Date((l||new Date).getTime()+288e5)),status:"UNCOVERED_REPORTED",isReported:!0,reportedToPlanning:!0,employeeName:"VACANTE (A ASIGNAR)",employeeId:"VACANTE",client:{id:r,name:d,razonsocial:d},objective:{id:i,name:f},metadata:{alertTitle:"Vacante: ".concat(t)},createdAt:(0,s.Bt)(),generatedFromSlaGap:!0};Object.keys(o).forEach(e=>void 0===o[e]&&delete o[e]),await (0,s.ET)((0,s.hJ)(n.db,"turnos"),o)}else await (0,s.r7)((0,s.JU)(n.db,"turnos",a),{status:"UNCOVERED_REPORTED",isReported:!0,reportedToPlanning:!0,comments:"No se planific\xf3 turno en puesto ".concat(t),reportedAt:(0,s.Bt)()});await (0,s.ET)((0,s.hJ)(n.db,"audit_logs"),{action:"SLA_REPORT",targetShiftId:a,actorName:c,timestamp:(0,s.Bt)(),details:"Notific\xf3 falta en ".concat(t)}),o.Am.success("Notificado a planificaci\xf3n.")}else e||(await (0,s.ET)((0,s.hJ)(n.db,"novedades"),{shiftId:a,type:i,notes:j.nota,createdAt:(0,s.Bt)(),viewed:!1}),await (0,s.r7)((0,s.JU)(n.db,"turnos",a),{hasNovedad:!0}),o.Am.success("Novedad reportada"));R(e=>({...e,novedad:!1}))}catch(e){console.error("Error t\xe9cnico:",e),o.Am.error("No se pudo notificar: "+e.message)}P(null)};return{now:e,processedData:G,listData:H,stats:M,recentLogs:N,objectives:u,servicesSLA:f,operatorInfo:b,formatName,viewTab:D,setViewTab:I,filterText:T,setFilterText:v,isCompact:C,setIsCompact:S,modals:O,setModals:R,handleAction,processingId:w,confirmNovedad,novedadData:j,setNovedadData:L}}},28477:function(e,t,a){a.d(t,{I8:function(){return l},db:function(){return d},wk:function(){return c}});var i=a(83977),s=a(85876),n=a(93504),r=a(23914);let o=(0,i.C6)().length?(0,i.Mq)():(0,i.ZF)({apiKey:"AIzaSyBJaTiMekwbGPXAm-mkPl_u6KEWCSpvfic",authDomain:"comtroldata.firebaseapp.com",projectId:"comtroldata",storageBucket:"comtroldata.firebasestorage.app",messagingSenderId:"698108879063",appId:"1:698108879063:web:ab30eb8b80a774f52f1092"}),l=(0,s.v0)(o),d=(0,n.ad)(o),c=(0,r.$C)(o)}}]);