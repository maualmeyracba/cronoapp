
import React, { useEffect, useState } from 'react';
import { collection, query, where, onSnapshot } from 'firebase/firestore';
import { db } from '@/lib/firebase';
import { format, startOfWeek, addDays, parseISO } from 'date-fns';
import { es } from 'date-fns/locale';
import { procesarAsignacionTurno } from '@/utils/shiftManager';
import { useAuth } from '@/context/AuthContext';

export const PlanningPage = () => {
  const { user } = useAuth();
  const [currentDate, setCurrentDate] = useState(new Date());
  const [employees, setEmployees] = useState([]);
  const [turnos, setTurnos] = useState([]);
  const [ausencias, setAusencias] = useState([]);
  const [loading, setLoading] = useState(true);
  const [confirmModal, setConfirmModal] = useState({ show: false, warnings: [], data: null });

  useEffect(() => {
    // 1. Cargar Empleados
    const unsubUsers = onSnapshot(query(collection(db, 'system_users'), where('role', '!=', 'SuperAdmin')), (snap) => {
      setEmployees(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });

    // 2. Cargar Turnos
    const unsubTurnos = onSnapshot(collection(db, 'turnos'), (snap) => {
      setTurnos(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });

    // 3. Cargar NOVEDADES (Ausencias)
    const unsubAusencias = onSnapshot(collection(db, 'ausencias'), (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setAusencias(data);
      console.log("üî• NOVEDADES CARGADAS:", data);
    });

    setLoading(false);
    return () => { unsubUsers(); unsubTurnos(); unsubAusencias(); };
  }, []);

  const startOfCurrentWeek = startOfWeek(currentDate, { weekStartsOn: 1 });
  const weekDays = Array.from({ length: 7 }).map((_, i) => addDays(startOfCurrentWeek, i));

  // --- FUNCI√ìN DE COINCIDENCIA (ID O NOMBRE) ---
  const checkCoincidence = (emp, aus) => {
    // 1. Coincidencia exacta de ID
    if (aus.employeeId === emp.id) return true;
    
    // 2. Coincidencia de Nombre (FALLBACK POR SI EL ID EST√Å ROTO)
    // Normalizamos a min√∫sculas y quitamos espacios para comparar "Garcia Valentina" con "Valentina Garcia"
    const empName = (emp.displayName || emp.email || "").toLowerCase().replace(/\s/g, '');
    const ausName = (aus.employeeName || "").toLowerCase().replace(/\s/g, '');
    
    // Si uno incluye al otro (ej: "garcia" en "garciavalentina")
    if (empName.includes(ausName) || ausName.includes(empName)) return true;
    
    return false;
  };

  const getCellContent = (emp, dayObj) => {
    const dayString = format(dayObj, 'yyyy-MM-dd');

    // 1. BUSCAR EN NOVEDADES (Usando coincidencia flexible)
    const novedad = ausencias.find(a => 
      checkCoincidence(emp, a) && 
      dayString >= a.startDate && 
      dayString <= a.endDate
    );

    if (novedad) {
      let bgColor = "bg-gray-500";
      let label = "L";

      const tipo = (novedad.type || "").toLowerCase();
      
      if (tipo.includes('vacaciones')) {
        bgColor = "bg-green-600";
        label = "V";
      } else if (tipo.includes('enfermedad') || tipo.includes('medica')) {
        bgColor = "bg-red-600";
        label = "E";
      } else if (tipo.includes('franco')) {
         bgColor = "bg-blue-600";
         label = "F";
      }

      return (
        <div className={`w-full h-full ${bgColor} text-white font-bold flex items-center justify-center text-xl shadow-md cursor-not-allowed border-2 border-white`} title={novedad.type}>
          {label}
        </div>
      );
    }

    // 2. BUSCAR TURNO
    const turno = turnos.find(t => 
      t.employeeId === emp.id && 
      t.startTime.startsWith(dayString)
    );

    if (turno) {
      const horaStart = turno.startTime.split('T')[1].substring(0, 5);
      const horaEnd = turno.endTime.split('T')[1].substring(0, 5);
      return (
        <div className="w-full h-full bg-indigo-50 border-l-4 border-indigo-500 text-indigo-900 text-xs flex flex-col items-center justify-center font-semibold">
          <span>{horaStart}</span>
          <span>{horaEnd}</span>
        </div>
      );
    }

    return null; 
  };

  // --- CLICK EN CELDA ---
  const handleCellClick = async (empId, day) => {
    // Necesitamos el objeto empleado completo para verificar nombre
    const empObj = employees.find(e => e.id === empId);
    if (!empObj) return;

    const dayString = format(day, 'yyyy-MM-dd');

    // 1. BLOQUEO
    const bloqueado = ausencias.find(a => 
      checkCoincidence(empObj, a) && 
      dayString >= a.startDate && 
      dayString <= a.endDate
    );

    if (bloqueado) {
      alert(`‚õî BLOQUEADO: ${bloqueado.employeeName} tiene ${bloqueado.type}`);
      return;
    }

    // 2. CREAR TURNO
    const newTurnoData = {
      employeeId: empId,
      startTime: `${dayString}T06:00:00`,
      endTime: `${dayString}T18:00:00`,
      typeId: 'TM',
      createdById: user.uid
    };

    const resultado = await procesarAsignacionTurno({
      adminUid: user.uid, newTurnoData, existingTurnos: turnos, ausencias: ausencias, fechaReferencia: day
    });

    if (!resultado.success) {
      if (resultado.requiresConfirmation) {
        setConfirmModal({ show: true, warnings: resultado.warnings, data: newTurnoData });
      } else {
        alert(resultado.error);
      }
    }
  };

  const confirmForceSave = async () => {
    await procesarAsignacionTurno({
      adminUid: user.uid, newTurnoData: confirmModal.data, existingTurnos: turnos, ausencias: ausencias, fechaReferencia: new Date(confirmModal.data.startTime)
    }, true);
    setConfirmModal({ show: false, warnings: [], data: null });
  };

  // NAVEGACI√ìN R√ÅPIDA A LICENCIAS (Para encontrarlas si est√°n en otra fecha)
  const irALicencia = (fechaStr) => {
     // Truco: le agregamos hora para que no reste un d√≠a por timezone
     setCurrentDate(new Date(fechaStr + 'T12:00:00'));
  };

  if (loading) return <div className="p-10 font-bold text-gray-600">Cargando Tablero...</div>;

  return (
    <div className="p-4 h-full flex flex-col bg-white">
      {/* HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-center mb-4 p-4 bg-slate-100 rounded-lg shadow-sm gap-4">
        <div>
           <h2 className="text-2xl font-black text-slate-800">PLANIFICACI√ìN</h2>
           <p className="text-sm text-slate-500">Gesti√≥n de Turnos y Novedades</p>
        </div>
        
        <div className="flex items-center gap-4 bg-white p-2 rounded shadow-sm">
             <button onClick={() => setCurrentDate(addDays(currentDate, -7))} className="w-10 h-10 flex items-center justify-center bg-slate-200 rounded-full font-bold hover:bg-slate-300">{"<"}</button>
             <div className="text-center min-w-[180px]">
                <span className="block text-xl font-bold text-slate-700 capitalize">{format(startOfCurrentWeek, "MMMM yyyy", { locale: es })}</span>
                <span className="text-xs text-slate-400">Semana del {format(weekDays[0], 'd')} al {format(weekDays[6], 'd')}</span>
             </div>
             <button onClick={() => setCurrentDate(addDays(currentDate, 7))} className="w-10 h-10 flex items-center justify-center bg-slate-200 rounded-full font-bold hover:bg-slate-300">{">"}</button>
        </div>
      </div>

      {/* REFERENCIAS Y LISTA DE NOVEDADES ACTIVAS */}
      <div className="mb-4 flex flex-wrap gap-4 items-start">
          <div className="flex gap-2 text-sm font-bold bg-white p-2 rounded border">
              <span className="flex items-center gap-1"><span className="w-6 h-6 bg-green-600 text-white flex items-center justify-center rounded text-xs">V</span> Vacaciones</span>
              <span className="flex items-center gap-1"><span className="w-6 h-6 bg-red-600 text-white flex items-center justify-center rounded text-xs">E</span> Enfermedad</span>
              <span className="flex items-center gap-1"><span className="w-6 h-6 bg-blue-600 text-white flex items-center justify-center rounded text-xs">F</span> Franco</span>
          </div>
          
          {/* LISTA DE ACCESO R√ÅPIDO A LICENCIAS (BOTONES) */}
          <div className="flex-1 flex gap-2 overflow-x-auto pb-1">
             {ausencias.map(a => (
               <button 
                 key={a.id}
                 onClick={() => irALicencia(a.startDate)}
                 className="px-3 py-1 bg-yellow-100 border border-yellow-300 text-yellow-800 text-xs rounded-full whitespace-nowrap hover:bg-yellow-200 transition-colors"
               >
                 üîç Ir a: {a.employeeName} ({a.startDate})
               </button>
             ))}
             {ausencias.length === 0 && <span className="text-xs text-gray-400 italic py-1">Sin novedades cargadas</span>}
          </div>
      </div>

      {/* MODAL CONFIRMACI√ìN */}
      {confirmModal.show && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm">
          <div className="bg-white p-6 rounded-xl shadow-2xl border-t-8 border-red-500 max-w-sm w-full animate-in fade-in zoom-in duration-200">
            <h3 className="text-red-600 font-black text-xl mb-3">‚ö†Ô∏è CONFIRMAR EXCEPCI√ìN</h3>
            <div className="bg-red-50 p-4 rounded-lg mb-4">
              <ul className="list-disc pl-4 text-sm text-red-800 space-y-1">
                {confirmModal.warnings.map((w, i) => <li key={i} className="font-medium">{w}</li>)}
              </ul>
            </div>
            <p className="text-xs text-gray-500 mb-6 text-center">Esta acci√≥n quedar√° registrada en la auditor√≠a del sistema.</p>
            <div className="flex justify-end gap-3">
              <button onClick={() => setConfirmModal({ show: false, warnings: [], data: null })} className="px-5 py-2 text-gray-600 font-bold hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
              <button onClick={confirmForceSave} className="px-5 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 shadow-lg transition-transform active:scale-95">AUTORIZAR</button>
            </div>
          </div>
        </div>
      )}

      {/* TABLA PRINCIPAL */}
      <div className="flex-1 overflow-auto border rounded-xl shadow-inner bg-slate-50 relative">
        <table className="min-w-full divide-y divide-gray-200 border-collapse">
          <thead className="bg-slate-800 text-white sticky top-0 z-20 shadow-md">
            <tr>
              <th className="px-4 py-4 text-left text-xs font-bold uppercase tracking-wider sticky left-0 bg-slate-800 z-30 w-64 border-r border-slate-600">AGENTE</th>
              {weekDays.map(day => (
                <th key={day.toString()} className="px-2 py-3 text-center text-xs font-bold uppercase tracking-wider border-l border-slate-600 min-w-[100px]">
                  {format(day, 'EEE d', { locale: es })}
                </th>
              ))}
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {employees.map(emp => (
              <tr key={emp.id} className="hover:bg-blue-50 transition-colors">
                <td className="px-4 py-3 whitespace-nowrap text-sm font-bold text-slate-700 sticky left-0 bg-white z-10 border-r border-slate-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                  {emp.displayName || emp.email}
                </td>
                {weekDays.map(day => (
                  <td 
                    key={day.toString()} 
                    className="p-1 border-l border-slate-100 h-20 w-32 relative cursor-pointer hover:brightness-95 transition-all"
                    onClick={() => handleCellClick(emp.id, day)}
                  >
                    {getCellContent(emp, day)}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};
