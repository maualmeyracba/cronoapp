import React, { useEffect, useState } from 'react';
import Head from 'next/head';
import { 
    Shield, Users, Building, RefreshCw, FileText, Printer, Search, X, 
    AlertCircle, AlertTriangle, Calendar, Clock, BarChart2, MapPin, 
    CheckCircle, XCircle, AlertOctagon, Download, Filter, ChevronDown, 
    ChevronRight, Activity, Percent, TrendingDown, Stethoscope, Plane, 
    FileCheck, HelpCircle, Briefcase, User, Trash2, Edit3, PlusCircle 
} from 'lucide-react';
import DashboardLayout from '@/components/layout/DashboardLayout';
import { withAuthGuard } from '@/components/common/withAuthGuard';
import { db } from '@/lib/firebase';
import { collection, getDocs, query, orderBy, limit, where, getCountFromServer, Timestamp } from 'firebase/firestore';

// --- TIPOS ---
interface ILog { id: string; action: string; module: string; details: any; actorName: string; timestamp: any; }
interface IStats { totalClients: number; activeEmployees: number; totalAuditLogs: number; }

interface IReportRow { 
    id: string; 
    col1: string; category: string; col2: string; col3: number; col4: number; 
    col5: number; col6: number; col_nocturnal: number; details?: string;
    objectivesBreakdown?: { name: string; hours: number }[]; 
    shiftsDetail?: any[]; rawShifts?: any[]; absenceData?: any;
}

interface IAgreement {
    id: string; name: string; maxHoursWeekly: number; maxHoursMonthly: number;
    saturdayCutoffHour: number; saturdayRate: number; nightShiftStart: number;
    nightShiftEnd: number; paysDoubleOnFranco: boolean;
}

// --- HELPER FECHAS ---
const formatDate = (dateInput: any) => {
    try {
        let date = dateInput?.toDate ? dateInput.toDate() : new Date(dateInput);
        return new Intl.DateTimeFormat('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(date);
    } catch (e) { return '-'; }
};

const formatTime = (dateInput: any) => {
    try {
        let date = dateInput?.toDate ? dateInput.toDate() : new Date(dateInput);
        return date.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
    } catch (e) { return '--:--'; }
};

// --- MOTOR DE C√ÅLCULO RRHH ---
const calculateStatsExact = (shifts: any[], holidaysMap: Record<string, boolean>, rule: IAgreement) => {
    const sortedDocs = [...shifts].sort((a, b) => a.startTime.seconds - b.startTime.seconds);
    let totalPlanificado = 0, totalNocturnas = 0, totalExtra50 = 0, totalExtra100 = 0;
    let cycleHours = 0, monthlyAccumulated = 0;
    let francoDaysRef: {[key: string]: boolean} = {};

    sortedDocs.forEach(d => { if (d.isFranco) francoDaysRef[d.startTime.toDate().toDateString()] = true; });

    sortedDocs.forEach(d => {
        // FILTRO DE SEGURIDAD: Ignorar borrados en el c√°lculo
        const status = (d.status || '').toLowerCase();
        if (status.includes('delet') || status.includes('cancel') || status.includes('borrad')) return;

        const start = d.startTime.toDate();
        const end = d.endTime.toDate();
        const duration = (end.getTime() - start.getTime()) / 3600000;
        const dateKey = start.toDateString();

        if (d.isFranco) { cycleHours = 0; return; }

        totalPlanificado += duration;
        let isSpecial100 = false;
        if (holidaysMap[dateKey] || (francoDaysRef[dateKey] && rule.paysDoubleOnFranco)) isSpecial100 = true;

        if (isSpecial100) {
            totalExtra100 += duration;
        } else {
            let durationNormal = duration, durationExtra = 0;
            const previousCycleHours = cycleHours;
            cycleHours += duration;

            if (previousCycleHours >= rule.maxHoursWeekly) { durationNormal = 0; durationExtra = duration; }
            else if (cycleHours > rule.maxHoursWeekly) { durationNormal = rule.maxHoursWeekly - previousCycleHours; durationExtra = cycleHours - rule.maxHoursWeekly; }

            if (durationNormal > 0) {
                const previousMonthly = monthlyAccumulated;
                monthlyAccumulated += durationNormal;
                if (previousMonthly >= rule.maxHoursMonthly) { durationExtra += durationNormal; durationNormal = 0; }
                else if (monthlyAccumulated > rule.maxHoursMonthly) { durationExtra += monthlyAccumulated - rule.maxHoursMonthly; durationNormal = rule.maxHoursMonthly - previousMonthly; }
            }
            totalExtra50 += durationExtra;

            let tempTime = new Date(start);
            while (tempTime < end) {
                if (tempTime.getHours() >= rule.nightShiftStart || tempTime.getHours() < rule.nightShiftEnd) totalNocturnas += 1;
                tempTime.setHours(tempTime.getHours() + 1);
            }
        }
    });
    return { totalPlanificado, dayHours: totalPlanificado - totalExtra100 - totalExtra50, nightHours: totalNocturnas, extra50: totalExtra50, extra100: totalExtra100 };
};

function ReportsPage() {
    const [activeTab, setActiveTab] = useState<'AUDIT' | 'MANAGEMENT'>('AUDIT');
    const [loading, setLoading] = useState(false);
    const [stats, setStats] = useState<IStats>({ totalClients: 0, activeEmployees: 0, totalAuditLogs: 0 });
    const [selectedLog, setSelectedLog] = useState<ILog | null>(null);

    const [reportType, setReportType] = useState('HOURS_BY_EMPLOYEE');
    const [reportDates, setReportDates] = useState({ start: '', end: '' });
    const [reportData, setReportData] = useState<IReportRow[]>([]);
    const [selectedReportRow, setSelectedReportRow] = useState<IReportRow | null>(null);
    
    // FILTROS
    const [objectiveEmployeeFilter, setObjectiveEmployeeFilter] = useState('ALL');
    const [selectedClientFilter, setSelectedClientFilter] = useState(''); 
    const [clientsList, setClientsList] = useState<any[]>([]); 

    // AUDITORIA STATE
    const [auditLogs, setAuditLogs] = useState<ILog[]>([]);
    const [auditDates, setAuditDates] = useState({ start: '', end: '' });
    const [auditFilterType, setAuditFilterType] = useState('ALL');
    const [auditActorFilter, setAuditActorFilter] = useState('ALL');
    const [actorsList, setActorsList] = useState<string[]>([]);
    
    const [empMap, setEmpMap] = useState<Record<string, string>>({});

    useEffect(() => {
        const now = new Date();
        const sStr = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0, 10);
        const eStr = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().slice(0, 10);
        setAuditDates({ start: sStr, end: eStr });
        setReportDates({ start: sStr, end: eStr });
        loadStats(); 
        loadCatalogs(); 
    }, []);

    useEffect(() => { setObjectiveEmployeeFilter('ALL'); }, [selectedReportRow]);
    
    const loadStats = async () => { try { const [e, c, l] = await Promise.all([ getCountFromServer(query(collection(db,'empleados'),where('status','==','active'))), getCountFromServer(collection(db,'clients')), getCountFromServer(collection(db,'historial_operaciones'))]); setStats({activeEmployees:e.data().count, totalClients:c.data().count, totalAuditLogs:l.data().count}); } catch{} };
    
    const loadCatalogs = async () => { 
        try {
            const [s, c] = await Promise.all([
                getDocs(collection(db, 'empleados')),
                getDocs(collection(db, 'clients'))
            ]);
            const m: any = {}; s.forEach(d => m[d.id] = d.data().name || d.data().firstName+' '+d.data().lastName); 
            setEmpMap(m);
            // Cargar lista de clientes
            setClientsList(c.docs.map(d => ({id: d.id, name: d.data().name || d.data().fantasyName})));
        } catch {}
    };
    
    // --- AUDITOR√çA ROBUSTA ---
    const loadAuditLogs = async () => {
        setLoading(true);
        try {
            const startDate = new Date(auditDates.start + 'T00:00:00');
            const endDate = new Date(auditDates.end + 'T23:59:59');
            const startTs = Timestamp.fromDate(startDate);
            const endTs = Timestamp.fromDate(endDate);

            let q = query(
                collection(db, 'historial_operaciones'), 
                where('timestamp', '>=', startTs),
                where('timestamp', '<=', endTs),
                orderBy('timestamp', 'desc')
            );

            q = query(q, limit(2000)); // L√≠mite alto

            const snap = await getDocs(q);
            let logs = snap.docs.map(d => ({id: d.id, ...d.data()})) as ILog[];
            
            if(auditFilterType !== 'ALL') {
                logs = logs.filter(l => {
                    const action = (l.action || '').toUpperCase();
                    if (auditFilterType === 'ASIGNACION') return action.includes('ASIGN') || action.includes('ASSIGN') || action.includes('CREA');
                    if (auditFilterType === 'ELIMINACION') return action.includes('ELIMIN') || action.includes('DELET') || action.includes('REMOV') || action.includes('BAJA') || action.includes('BORRA') || action.includes('CANCEL');
                    if (auditFilterType === 'ALERTA') return action.includes('ALERTA') || action.includes('ALERT') || action.includes('WARN');
                    return true;
                });
            }

            if(auditActorFilter !== 'ALL') logs = logs.filter(l => l.actorName === auditActorFilter);

            const uniqueActors = Array.from(new Set(logs.map(l => l.actorName)));
            setActorsList(prev => Array.from(new Set([...prev, ...uniqueActors])));

            setAuditLogs(logs);
        } catch(e) { console.error(e); } finally { setLoading(false); }
    };

    // --- RENDERIZADOR DETALLE AUDITOR√çA (BILING√úE) ---
    const renderAuditDetails = (log: ILog, isModal: boolean = false) => {
        let data: any = log.details;
        if (typeof data === 'string' && (data.startsWith('{') || data.startsWith('['))) {
            try { data = JSON.parse(data); } catch {}
        }

        const getName = (id: string) => empMap[id] || id || 'Desconocido';
        const actor = log.actorName || 'Sistema';
        const hasEmpData = data.empleado || data.employeeId || data.employeeName;
        const empleado = hasEmpData ? (empMap[hasEmpData] || hasEmpData) : 'Registro Eliminado';
        
        const actionUpper = (log.action || '').toUpperCase();
        const isDelete = actionUpper.includes('ELIMIN') || actionUpper.includes('DELET') || actionUpper.includes('BORRA') || actionUpper.includes('REMOV') || actionUpper.includes('CANCEL');
        const isAssign = actionUpper.includes('ASIGN') || actionUpper.includes('ASSIGN') || actionUpper.includes('CREA');
        const isAlert = actionUpper.includes('ALERTA') || actionUpper.includes('ALERT');

        if (!isModal) {
            if (isAlert) return <span className="text-amber-600 font-bold flex gap-1 items-center"><AlertTriangle size={12}/> {log.action}</span>;
            if (isDelete) return <span className="text-rose-600 font-bold flex gap-1 items-center"><Trash2 size={12}/> Baja / Borrado</span>;
            if (isAssign) return <span className="text-indigo-600 font-bold">Asignaci√≥n ‚Üí {empleado.split(' ')[0]}</span>;
            return <span className="text-slate-500">{log.action}</span>;
        }

        return (
            <div className="space-y-4">
                <div className="flex items-center justify-between bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border dark:border-slate-700">
                    <div>
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Responsable</p>
                        <div className="flex items-center gap-2 mt-1">
                            <div className="p-1 bg-indigo-100 text-indigo-700 rounded-full"><User size={14}/></div>
                            <span className="font-bold text-sm dark:text-white">{actor}</span>
                        </div>
                    </div>
                    <div className="text-right">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Afectado</p>
                        <div className="flex items-center gap-2 mt-1 justify-end">
                            <span className="font-bold text-sm dark:text-white">{empleado}</span>
                            <div className="p-1 bg-slate-200 text-slate-700 rounded-full"><Briefcase size={14}/></div>
                        </div>
                    </div>
                </div>

                <div className={`p-4 rounded-xl border-l-4 shadow-sm ${ isAlert ? 'bg-amber-50 border-amber-500' : isDelete ? 'bg-rose-50 border-rose-500' : 'bg-indigo-50 border-indigo-500' }`}>
                    <h4 className={`font-black text-sm uppercase mb-2 flex items-center gap-2 ${ isAlert ? 'text-amber-700' : isDelete ? 'text-rose-700' : 'text-indigo-700' }`}>
                        {isAlert ? <AlertTriangle size={18}/> : isDelete ? <Trash2 size={18}/> : <CheckCircle size={18}/>}
                        {log.action.replace(/_/g, ' ')}
                    </h4>
                    
                    <div className="text-sm space-y-1 text-slate-700">
                        {data.risks ? (
                            <ul className="list-disc pl-4 space-y-1">
                                {data.risks.map((r: any, i: number) => (<li key={i}><span className="font-bold">{r.type}:</span> {r.label}</li>))}
                            </ul>
                        ) : (
                            <>
                                {data.objectiveName && <p><strong>Objetivo:</strong> {data.objectiveName}</p>}
                                {data.startTime && <p><strong>Fecha:</strong> {formatDate(data.startTime)}</p>}
                                {isDelete && <p className="text-rose-600 font-bold bg-rose-50 inline-block px-2 rounded mt-2">REGISTRO ELIMINADO</p>}
                            </>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    const getActionIcon = (action: string) => {
        const u = action.toUpperCase();
        if (u.includes('ASIGN') || u.includes('CREA')) return <PlusCircle size={16} className="text-indigo-500"/>;
        if (u.includes('ELIMIN') || u.includes('DELET') || u.includes('BORRA')) return <Trash2 size={16} className="text-rose-500"/>;
        if (u.includes('ALERTA')) return <AlertOctagon size={16} className="text-amber-600"/>;
        return <FileText size={16} className="text-slate-400"/>;
    };

    // --- GENERAR REPORTE (LOGICA CORREGIDA) ---
    const generateReport = async () => {
        if (!reportDates.start || !reportDates.end) return alert('Seleccione un rango de fechas v√°lido.');
        setLoading(true);
        setReportData([]); 

        try {
            const startDate = new Date(reportDates.start + 'T00:00:00');
            const endDate = new Date(reportDates.end + 'T23:59:59');
            const startTs = Timestamp.fromDate(startDate);
            const endTs = Timestamp.fromDate(endDate);

            // Fetch en Paralelo
            const shiftsQuery = query(collection(db, 'turnos'), where('startTime', '>=', startTs), where('startTime', '<=', endTs));
            const absencesQuery = query(collection(db, 'ausencias'), where('startDate', '>=', reportDates.start)); 
            const holidaysQuery = query(collection(db, 'feriados'));
            const agreementsQuery = query(collection(db, 'convenios'));
            const clientsQuery = query(collection(db, 'clients')); 

            const [shiftsSnap, absencesSnap, holidaysSnap, agreementsSnap, clientsSnap] = await Promise.all([
                getDocs(shiftsQuery),
                getDocs(absencesQuery),
                getDocs(holidaysQuery),
                getDocs(agreementsQuery),
                getDocs(clientsQuery)
            ]);

            // MAPA DE OBJETIVOS REAL (ID -> CLIENTE)
            const objectiveMap: Record<string, {clientId: string, name: string}> = {};
            clientsSnap.docs.forEach(doc => {
                const d = doc.data();
                if (d.objetivos && Array.isArray(d.objetivos)) {
                    d.objetivos.forEach((obj: any) => {
                        if(obj.id) objectiveMap[obj.id] = { clientId: doc.id, name: obj.name || 'Sede sin nombre' };
                    });
                }
            });

            const holidaysMap: Record<string, boolean> = {};
            holidaysSnap.docs.forEach(doc => { const d = doc.data(); if(d.date) holidaysMap[new Date(d.date + 'T00:00:00').toDateString()] = true; });

            const agreementsMap: Record<string, IAgreement> = {};
            agreementsSnap.docs.forEach(doc => { agreementsMap[doc.data().name] = { id: doc.id, ...doc.data() } as IAgreement; });
            const defaultAgreement: IAgreement = { id: 'def', name: 'General', maxHoursWeekly: 48, maxHoursMonthly: 200, saturdayCutoffHour: 13, saturdayRate: 1.5, nightShiftStart: 21, nightShiftEnd: 6, paysDoubleOnFranco: true };

            const allShifts = shiftsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const allAbsences = absencesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let rows: IReportRow[] = [];

            if (reportType === 'HOURS_BY_EMPLOYEE') {
                const shiftsByEmp: Record<string, any[]> = {};
                allShifts.forEach((s: any) => {
                    const status = (s.status || 'active').toLowerCase();
                    if (status.includes('delet') || status.includes('cancel') || status.includes('borrad')) return;
                    if (!shiftsByEmp[s.employeeId]) shiftsByEmp[s.employeeId] = [];
                    shiftsByEmp[s.employeeId].push(s);
                });

                Object.keys(shiftsByEmp).forEach(empId => {
                    const empShifts = shiftsByEmp[empId];
                    // EVITAR FANTASMAS: Si el empleado no est√° en el cat√°logo, saltar
                    if (!empMap[empId] || empShifts.length === 0) return;

                    const empName = empMap[empId] || 'Sin Nombre';
                    const agreementName = empShifts[0].agreement || 'Comercio'; 
                    const rule = agreementsMap[agreementName] || defaultAgreement;
                    const stats = calculateStatsExact(empShifts, holidaysMap, rule);

                    rows.push({
                        id: empId, col1: empName, category: 'Activo', col2: empShifts.length.toString(), 
                        col3: stats.totalPlanificado, col4: stats.dayHours, col_nocturnal: stats.nightHours,   
                        col5: stats.extra50, col6: stats.extra100, details: agreementName, rawShifts: empShifts,              
                    });
                });

            } else if (reportType === 'SHIFTS_BY_OBJECTIVE') {
                const shiftsByObj: Record<string, any[]> = {};
                allShifts.forEach((s: any) => {
                    const status = (s.status || 'active').toLowerCase();
                    if (status.includes('delet') || status.includes('cancel') || status.includes('borrad')) return;

                    const objData = objectiveMap[s.objectiveId];
                    const realClientId = objData?.clientId || s.clientId;

                    // FILTRO DE CLIENTE
                    if (selectedClientFilter && realClientId !== selectedClientFilter) return;
                    
                    const objName = objData?.name || s.objectiveName || 'Sin Asignar';
                    const groupKey = s.objectiveId || 'unknown'; 
                    if (!shiftsByObj[groupKey]) shiftsByObj[groupKey] = [];
                    s._displayName = objName; 
                    shiftsByObj[groupKey].push(s);
                });

                Object.keys(shiftsByObj).forEach(key => {
                    const objShifts = shiftsByObj[key];
                    if (objShifts.length === 0) return;
                    const objName = objShifts[0]._displayName; 
                    const totalHours = objShifts.reduce((acc, curr) => { const dur = (curr.endTime.seconds - curr.startTime.seconds) / 3600; return acc + (isNaN(dur) ? 0 : dur); }, 0);
                    const realHours = objShifts.filter((s:any) => !s.absence).reduce((acc, curr) => { const dur = (curr.endTime.seconds - curr.startTime.seconds) / 3600; return acc + (isNaN(dur) ? 0 : dur); }, 0);

                    rows.push({
                        id: key, col1: objName, category: 'Sede', col2: objShifts.length.toString(), 
                        col3: totalHours, col4: realHours, col5: objShifts.length,            
                        col6: objShifts.filter((s:any) => !s.absence).length, col_nocturnal: 0, shiftsDetail: objShifts            
                    });
                });

            } else if (reportType === 'ABSENCES') {
                rows = allAbsences.map((a: any) => {
                    if (!empMap[a.employeeId]) return null;
                    return {
                        id: a.id, col1: empMap[a.employeeId], category: a.type || 'General',
                        col2: `${formatDate(a.startDate)} - ${formatDate(a.endDate)}`, col3: 0, col4: 0, col5: 0, col6: 0, col_nocturnal: 0,
                        details: a.status || 'Pendiente', absenceData: a 
                    };
                }).filter(Boolean) as any;
            }
            setReportData(rows);
        } catch (error) { console.error(error); alert("Error generando reporte."); } finally { setLoading(false); }
    };

    const handleExportCSV = () => { if (reportData.length === 0) return; let headers: string[] = []; let dataMapper: (row: IReportRow) => any[] = () => []; if (reportType === 'HOURS_BY_EMPLOYEE') { headers = ['ID Empleado', 'Nombre', 'Categor√≠a', 'Cant. Turnos', 'Hs Totales', 'Normales', 'Nocturnas', 'Extra 50%', 'Extra 100%', 'Convenio']; dataMapper = (r) => [r.id, r.col1, r.category, r.col2, r.col3.toFixed(2).replace('.', ','), r.col4.toFixed(2).replace('.', ','), r.col_nocturnal.toFixed(2).replace('.', ','), r.col5.toFixed(2).replace('.', ','), r.col6.toFixed(2).replace('.', ','), r.details]; } else if (reportType === 'SHIFTS_BY_OBJECTIVE') { headers = ['ID', 'Objetivo/Cliente', 'Turnos Plan', 'Turnos Real', 'Hs Plan', 'Hs Real']; dataMapper = (r) => [r.id, r.col1, r.col5, r.col6, r.col3.toFixed(2).replace('.', ','), r.col4.toFixed(2).replace('.', ',')]; } else { headers = ['ID', 'Empleado', 'Tipo', 'Estado', 'Desde', 'Hasta', 'D√≠as', 'Detalle']; dataMapper = (r) => [r.id, r.col1, r.category, r.details, formatDate(r.absenceData?.startDate), formatDate(r.absenceData?.endDate), r.col3, r.absenceData?.reason]; } const csvRows = [headers.join(';'), ...reportData.map(row => dataMapper(row).map(field => `"${String(field||'').replace(/"/g, '""')}"`).join(';'))]; const blob = new Blob(["\uFEFF" + csvRows.join('\r\n')], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.setAttribute('download', `Reporte_${reportType}_${reportDates.start}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
    const handlePrint = () => window.print();
    const handlePrintIndividual = () => window.print();
    const calculateGlobalKPIs = () => { if (reportData.length === 0) return null; const totalPlan = reportData.reduce((sum, row) => sum + row.col3, 0); const totalReal = reportData.reduce((sum, row) => sum + row.col4, 0); const compliance = totalPlan > 0 ? (totalReal / totalPlan) * 100 : 0; return { totalPlan, totalReal, compliance }; };
    const calculateAbsencesKPIs = () => { const totalDays = reportData.reduce((sum, row) => sum + row.col3, 0); const unjustified = reportData.filter(r => r.details === 'Injustificada').length; const pending = reportData.filter(r => r.details === 'Pendiente').length; const medical = reportData.filter(r => r.category === 'Enfermedad' || r.category === 'Accidente').length; return { totalDays, unjustified, pending, medical }; };
    const calculateObjectiveKPIs = (shifts: any[]) => { const activeShifts=shifts.filter(s=>!s.isFranco); const uniqueEmp=new Set(activeShifts.map(s=>s.employee)).size; const totalShifts=activeShifts.length; const absences=activeShifts.filter(s=>s.absence).length; const absenceRate=totalShifts>0?(absences/totalShifts)*100:0; return {uniqueEmp,absenceRate,totalShifts}; };
    const groupShiftsByObjective = (shifts: any[]) => { const g:any={}; shifts.forEach(s=>{const k=s.objectiveName||'Sin'; if(!g[k])g[k]=[]; g[k].push(s)}); return g; };
    const globalKPIs = reportType === 'SHIFTS_BY_OBJECTIVE' ? calculateGlobalKPIs() : null;
    const getAbsenceIcon = (type: string) => { if(type.includes('Enfermedad')) return <Stethoscope size={16} className="text-rose-500"/>; if(type.includes('Vacaciones')) return <Plane size={16} className="text-blue-500"/>; if(type.includes('Justificada')) return <FileCheck size={16} className="text-emerald-500"/>; return <HelpCircle size={16} className="text-amber-500"/>; };

    return (
    <DashboardLayout>
      <Head><title>Reportes | CronoApp</title></Head>
      <style>{`@media print { body * { visibility: hidden; } #printable-modal, #printable-modal * { visibility: visible; } #printable-modal { position: absolute; left: 0; top: 0; width: 100%; background: white !important; color: black !important; border: none !important; } body:not(:has(#printable-modal)) #printable-area, body:not(:has(#printable-modal)) #printable-area * { visibility: visible; } body:not(:has(#printable-modal)) #printable-area { position: absolute; left: 0; top: 0; width: 100%; } .no-print { display: none !important; } }`}</style>
      
      <div className="p-6 max-w-7xl mx-auto space-y-6 animate-in fade-in" id="printable-area">
        {/* HEADER */}
        <div className="hidden print:block mb-8 text-center border-b pb-4"><h1 className="text-2xl font-bold">REPORTE - CRONOAPP</h1></div>
        <div className="flex border-b border-gray-200 dark:border-slate-700 mb-4 no-print">
            <button onClick={() => setActiveTab('AUDIT')} className={`py-2 px-4 font-bold text-sm border-b-2 transition-colors ${activeTab === 'AUDIT' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500'}`}>Auditor√≠a</button>
            <button onClick={() => setActiveTab('MANAGEMENT')} className={`py-2 px-4 font-bold text-sm border-b-2 transition-colors ${activeTab === 'MANAGEMENT' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500'}`}>Gesti√≥n y Liquidaci√≥n</button>
        </div>

        {/* --- PESTA√ëA AUDITORIA --- */}
        {activeTab === 'AUDIT' && (
            <div className="bg-white dark:bg-slate-800 rounded-2xl border dark:border-slate-700 shadow-sm flex flex-col min-h-[600px]">
                {/* BARRA DE FILTROS AUDITORIA */}
                <div className="p-4 border-b dark:border-slate-700 bg-gray-50 dark:bg-slate-900/50 flex flex-wrap gap-4 items-end no-print">
                    <div><label className="text-xs font-bold text-slate-400 block mb-1">DESDE</label><input type="date" value={auditDates.start} onChange={e => setAuditDates({...auditDates, start: e.target.value})} className="p-2 border rounded text-sm dark:bg-slate-800 dark:text-white"/></div>
                    <div><label className="text-xs font-bold text-slate-400 block mb-1">HASTA</label><input type="date" value={auditDates.end} onChange={e => setAuditDates({...auditDates, end: e.target.value})} className="p-2 border rounded text-sm dark:bg-slate-800 dark:text-white"/></div>
                    
                    <div>
                        <label className="text-xs font-bold text-slate-400 block mb-1">TIPO ACCI√ìN</label>
                        <select value={auditFilterType} onChange={e => setAuditFilterType(e.target.value)} className="p-2 border rounded text-sm w-40 dark:bg-slate-800 dark:text-white">
                            <option value="ALL">Todas</option>
                            <option value="ASIGNACION">Asignaciones</option>
                            <option value="ELIMINACION">Borrados</option>
                            <option value="ALERTA">Alertas</option>
                        </select>
                    </div>
                    <div>
                        <label className="text-xs font-bold text-slate-400 block mb-1">USUARIO / ACTOR</label>
                        <select value={auditActorFilter} onChange={e => setAuditActorFilter(e.target.value)} className="p-2 border rounded text-sm w-48 dark:bg-slate-800 dark:text-white">
                            <option value="ALL">Todos los Usuarios</option>
                            {actorsList.map((actor, i) => <option key={i} value={actor}>{actor}</option>)}
                        </select>
                    </div>

                    <button onClick={loadAuditLogs} className="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 hover:bg-indigo-700"><Search size={16}/> BUSCAR</button>
                    <button onClick={loadAuditLogs} className="bg-slate-200 text-slate-700 px-4 py-2 rounded text-sm font-bold flex items-center gap-2 hover:bg-slate-300 ml-auto" title="Actualizar Datos"><RefreshCw size={16} className={loading ? 'animate-spin' : ''}/></button>
                </div>
                
                {/* TABLA DE AUDITORIA */}
                <div className="flex-1 overflow-auto p-4">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-100 dark:bg-slate-900 uppercase font-black text-slate-500 text-xs sticky top-0">
                            <tr>
                                <th className="p-3">Fecha y Hora</th>
                                <th className="p-3">Actor (Qui√©n)</th>
                                <th className="p-3">Acci√≥n</th>
                                <th className="p-3">Detalle Operativo</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y dark:divide-slate-700">
                            {auditLogs.map(log => (
                                <tr key={log.id} onClick={() => setSelectedLog(log)} className="cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                    <td className="p-3 w-40">
                                        <div className="font-mono text-xs text-slate-600 dark:text-slate-300">{formatDate(log.timestamp)}</div>
                                        <div className="text-[10px] text-slate-400">{formatTime(log.timestamp)}</div>
                                    </td>
                                    <td className="p-3 w-48">
                                        <div className="flex items-center gap-2">
                                            <div className="p-1 bg-indigo-100 text-indigo-600 rounded-full"><User size={12}/></div>
                                            <span className="font-bold text-xs truncate max-w-[150px] block" title={log.actorName}>{log.actorName}</span>
                                        </div>
                                    </td>
                                    <td className="p-3 w-40">
                                        <div className="flex items-center gap-2">
                                            {getActionIcon(log.action)}
                                            <span className="text-[10px] font-black uppercase bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded border dark:border-slate-600">
                                                {log.action.replace('_', ' ')}
                                            </span>
                                        </div>
                                    </td>
                                    <td className="p-3">
                                        {renderAuditDetails(log)}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {auditLogs.length === 0 && <p className="text-center p-8 text-slate-400 italic">No hay registros de auditor√≠a para estos filtros.</p>}
                </div>
            </div>
        )}

        {/* GESTI√ìN Y LIQUIDACI√ìN */}
        {activeTab === 'MANAGEMENT' && (
            <div className="bg-white dark:bg-slate-800 rounded-2xl border dark:border-slate-700 shadow-sm flex flex-col min-h-[600px]">
                <div className="p-4 border-b dark:border-slate-700 bg-indigo-50/50 dark:bg-indigo-900/10 flex flex-wrap gap-4 items-end no-print">
                    <div><label className="text-xs font-bold text-slate-400 block mb-1">REPORTE</label><select value={reportType} onChange={e => setReportType(e.target.value)} className="p-2 border rounded text-sm w-56 font-bold text-indigo-700 dark:bg-slate-800 dark:text-white"><option value="HOURS_BY_EMPLOYEE">üïí Horas por Empleado</option><option value="SHIFTS_BY_OBJECTIVE">üìç Turnos por Objetivo</option><option value="ABSENCES">ü§í Ausencias</option></select></div>
                    {reportType === 'SHIFTS_BY_OBJECTIVE' && (<div><label className="text-xs font-bold text-slate-400 block mb-1">CLIENTE</label><select value={selectedClientFilter} onChange={e => setSelectedClientFilter(e.target.value)} className="p-2 border rounded text-sm w-48 font-bold text-slate-700 dark:bg-slate-800 dark:text-white"><option value="">Todos los Clientes</option>{clientsList.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>)}
                    <div><label className="text-xs font-bold text-slate-400 block mb-1">DESDE</label><input type="date" value={reportDates.start} onChange={e => setReportDates({...reportDates, start: e.target.value})} className="p-2 border rounded text-sm dark:bg-slate-800 dark:text-white"/></div>
                    <div><label className="text-xs font-bold text-slate-400 block mb-1">HASTA</label><input type="date" value={reportDates.end} onChange={e => setReportDates({...reportDates, end: e.target.value})} className="p-2 border rounded text-sm dark:bg-slate-800 dark:text-white"/></div>
                    <button onClick={generateReport} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2">{loading ? <RefreshCw className="animate-spin"/> : <Search size={16}/>} GENERAR</button>
                    <button onClick={handleExportCSV} className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 ml-auto"><Download size={16}/> CSV</button>
                    <button onClick={handlePrint} className="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2"><Printer size={16}/> IMPRIMIR</button>
                </div>

                <div className="flex-1 p-6 overflow-auto">
                    {reportType === 'SHIFTS_BY_OBJECTIVE' && globalKPIs && (
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 animate-in fade-in">
                            <div className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border dark:border-slate-700 flex items-center gap-4"><div className="p-3 bg-indigo-100 text-indigo-600 rounded-xl"><Building/></div><div><p className="text-xs font-bold text-slate-400 uppercase">Objetivos Activos</p><h3 className="text-2xl font-black dark:text-white">{reportData.length}</h3></div></div>
                            <div className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border dark:border-slate-700 flex items-center gap-4"><div className="p-3 bg-slate-200 text-slate-600 rounded-xl"><Clock/></div><div><p className="text-xs font-bold text-slate-400 uppercase">Hs Planificadas</p><h3 className="text-2xl font-black dark:text-white">{globalKPIs.totalPlan.toFixed(0)}</h3></div></div>
                            <div className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border dark:border-slate-700 flex items-center gap-4"><div className="p-3 bg-emerald-100 text-emerald-600 rounded-xl"><CheckCircle/></div><div><p className="text-xs font-bold text-slate-400 uppercase">Hs Realizadas</p><h3 className="text-2xl font-black dark:text-white">{globalKPIs.totalReal.toFixed(0)}</h3></div></div>
                            <div className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border dark:border-slate-700 flex items-center gap-4"><div className={`p-3 rounded-xl ${globalKPIs.compliance >= 95 ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'}`}><Activity/></div><div><p className="text-xs font-bold text-slate-400 uppercase">Cumplimiento</p><h3 className="text-2xl font-black dark:text-white">{globalKPIs.compliance.toFixed(1)}%</h3></div></div>
                        </div>
                    )}
                    
                    {reportData.length > 0 ? (
                        <>
                           <div className="bg-slate-100 p-2 mb-4 rounded flex justify-between dark:bg-slate-700"><span className="font-bold text-sm">Resultados: {reportData.length}</span></div>
                           <table className="w-full text-sm text-left">
                                <thead className="bg-slate-200 dark:bg-slate-900 font-black text-slate-600 dark:text-slate-400 uppercase text-xs">
                                    <tr>
                                        <th className="p-3">{reportType === 'SHIFTS_BY_OBJECTIVE' ? 'Objetivo / Cliente' : 'Empleado'}</th>
                                        {reportType === 'HOURS_BY_EMPLOYEE' && <th className="p-3">Categor√≠a</th>}
                                        {reportType === 'SHIFTS_BY_OBJECTIVE' ? (
                                            <><th className="p-3 text-center">Turnos (Real / Plan)</th><th className="p-3 text-right">Hs Planificadas</th><th className="p-3 text-right">Hs Realizadas</th><th className="p-3 text-right">Cumplimiento</th></>
                                        ) : reportType === 'ABSENCES' ? (
                                            <><th className="p-3">Tipo de Ausencia</th><th className="p-3 text-center">Periodo</th><th className="p-3 text-center">D√≠as</th><th className="p-3 text-center">Estado</th><th className="p-3 text-center">Certif.</th></>
                                        ) : (
                                            <><th className="p-3 text-center">Cant.</th><th className="p-3 text-right">Hs Totales</th><th className="p-3 text-right">Normales</th><th className="p-3 text-right text-indigo-400">Noct</th><th className="p-3 text-right text-amber-600">Extra 50%</th><th className="p-3 text-right text-emerald-600">Extra 100%</th></>
                                        )}
                                    </tr>
                                </thead>
                                <tbody className="divide-y dark:divide-slate-700">
                                    {reportData.map((row, i) => (
                                        <tr key={i} onClick={() => setSelectedReportRow(row)} className="hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer">
                                            <td className="p-3 font-bold dark:text-white">{row.col1}</td>
                                            {reportType === 'HOURS_BY_EMPLOYEE' && (<><td className="p-3 text-xs text-slate-500">{row.category}</td><td className="p-3 text-center">{row.col2}</td><td className="p-3 text-right font-bold text-indigo-600">{row.col3.toFixed(1)}</td><td className="p-3 text-right">{row.col4.toFixed(1)}</td><td className="p-3 text-right text-indigo-500">{row.col_nocturnal?.toFixed(1)}</td><td className="p-3 text-right text-amber-600">{row.col5.toFixed(1)}</td><td className="p-3 text-right text-emerald-600">{row.col6.toFixed(1)}</td></>)}
                                            {reportType === 'SHIFTS_BY_OBJECTIVE' && (<><td className="p-3 text-center font-mono">{row.col2}</td><td className="p-3 text-right text-slate-500">{row.col3.toFixed(1)} h</td><td className="p-3 text-right font-bold text-slate-800 dark:text-white">{row.col4.toFixed(1)} h</td><td className="p-3 text-right"><span className={`text-xs font-black px-2 py-1 rounded ${(row.col4/row.col3)>=0.95?'bg-emerald-100 text-emerald-600':'bg-amber-100 text-amber-600'}`}>{row.col3>0?Math.round((row.col4/row.col3)*100):0}%</span></td></>)}
                                            {reportType === 'ABSENCES' && (<><td className="p-3"><div className="flex items-center gap-2">{getAbsenceIcon(row.category)}<span className="text-xs font-bold uppercase">{row.category}</span></div></td><td className="p-3 text-center text-xs font-mono text-slate-500">{row.col2}</td><td className="p-3 text-center font-black">{row.col3}</td><td className="p-3 text-center"><span className={`px-2 py-1 rounded text-[10px] font-black uppercase ${row.details==='Justificada'?'bg-emerald-100 text-emerald-600':row.details==='Injustificada'?'bg-rose-100 text-rose-600':'bg-amber-100 text-amber-600'}`}>{row.details}</span></td><td className="p-3 text-center text-slate-400">{row.absenceData?.hasCertificate ? <CheckCircle size={16} className="text-emerald-500 mx-auto"/> : '-'}</td></>)}
                                        </tr>
                                    ))}
                                </tbody>
                             </table>
                             <p className="text-xs text-slate-400 mt-4 text-center">üí° Clic en una fila para ver el detalle en profundidad.</p>
                        </>
                    ) : (<div className="text-center p-10 text-slate-400">{reportType === 'SHIFTS_BY_OBJECTIVE' && selectedClientFilter ? 'No se encontraron turnos para este cliente.' : 'Selecciona fechas y genera el reporte.'}</div>)}
                </div>
            </div>
        )}

        {/* MODAL AUDITORIA MEJORADO */}
        {selectedLog && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm no-print">
                <div className="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-lg p-8 relative animate-in zoom-in-95">
                    <button onClick={() => setSelectedLog(null)} className="absolute top-6 right-6 text-slate-400 hover:text-slate-600 dark:hover:text-white transition-colors"><X/></button>
                    
                    <h3 className="font-black text-2xl mb-1 dark:text-white uppercase">Detalle de Operaci√≥n</h3>
                    <p className="text-xs text-slate-400 mb-6 flex items-center gap-2">
                        <Clock size={12}/> {formatDate(selectedLog.timestamp)} a las {formatTime(selectedLog.timestamp)}
                    </p>
                    
                    {/* LLAMADA AL RENDERIZADOR CON MODO MODAL ACTIVADO */}
                    {renderAuditDetails(selectedLog, true)}

                    <div className="mt-6 pt-6 border-t dark:border-slate-700">
                        <details className="group">
                            <summary className="text-[10px] font-black text-slate-400 uppercase cursor-pointer hover:text-indigo-500 list-none flex items-center gap-2">
                                <ChevronRight size={12} className="group-open:rotate-90 transition-transform"/> Ver JSON Crudo
                            </summary>
                            <pre className="mt-2 text-[10px] bg-slate-900 text-green-400 p-4 rounded-xl overflow-auto max-h-40 font-mono">
                                {JSON.stringify(selectedLog.details, null, 2)}
                            </pre>
                        </details>
                    </div>
                </div>
            </div>
        )}
        
        {/* MODAL DETALLES UNIFICADO (Management) */}
        {selectedReportRow && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={() => setSelectedReportRow(null)}>
                <div id="printable-modal" className="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                    <div className="p-8 bg-slate-50 dark:bg-slate-950 border-b dark:border-slate-800 flex justify-between items-start">
                        <div>
                            <p className="text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Informe Detallado</p>
                            <h2 className="text-3xl font-black text-slate-900 dark:text-white uppercase leading-none">{selectedReportRow.col1}</h2>
                            <p className="text-xs text-slate-500 mt-2">Periodo: {reportDates.start} al {reportDates.end}</p>
                        </div>
                        <div className="flex gap-2 no-print">
                            <button onClick={handlePrintIndividual} className="p-3 bg-slate-900 text-white rounded-xl hover:bg-slate-700 transition-colors shadow-lg"><Printer size={20}/></button>
                            <button onClick={() => setSelectedReportRow(null)} className="p-3 bg-white border hover:bg-slate-100 rounded-xl transition-colors"><X size={20}/></button>
                        </div>
                    </div>
                    
                    <div className="p-8 overflow-y-auto custom-scrollbar">
                        {reportType === 'SHIFTS_BY_OBJECTIVE' && selectedReportRow.shiftsDetail && (
                            <div className="space-y-6">
                                {(() => { const kpis = calculateObjectiveKPIs(selectedReportRow.shiftsDetail); return ( <div className="grid grid-cols-4 gap-4"><div className="p-4 border rounded-xl text-center"><p className="text-[10px] uppercase text-slate-400 font-bold mb-1">Dotaci√≥n</p><p className="text-2xl font-black flex items-center justify-center gap-2"><Users size={20} className="text-indigo-500"/> {kpis.uniqueEmp}</p></div><div className="p-4 border rounded-xl text-center"><p className="text-[10px] uppercase text-rose-500 font-bold mb-1">Ausentismo</p><p className="text-2xl font-black text-rose-600 flex items-center justify-center gap-2"><TrendingDown size={20}/> {kpis.absenceRate.toFixed(1)}%</p></div><div className="p-4 border rounded-xl text-center"><p className="text-[10px] uppercase text-slate-400 font-bold mb-1">Horas Totales</p><p className="text-2xl font-black">{selectedReportRow.col3.toFixed(1)}h</p></div><div className="p-4 border rounded-xl text-center"><p className="text-[10px] uppercase text-slate-400 font-bold mb-1">Turnos</p><p className="text-2xl font-black">{kpis.totalShifts}</p></div></div> ); })()}
                                <table className="w-full text-sm text-left"><thead className="bg-slate-100 dark:bg-slate-800 text-[10px] uppercase font-black text-slate-500"><tr><th className="p-2">Fecha</th><th className="p-2">Empleado</th><th className="p-2">Horario</th><th className="p-2 text-right">Hs</th><th className="p-2 text-center">Estado</th></tr></thead><tbody className="divide-y dark:divide-slate-700">{selectedReportRow.shiftsDetail.filter(s => !s.isFranco).map((s, i) => (<tr key={i} className={s.isVacante?'bg-amber-50 dark:bg-amber-900/10':''}><td className="p-2 font-mono text-xs">{formatDate(s.startTime)}</td><td className="p-2 font-bold">{s.employeeName}</td><td className="p-2 text-xs text-slate-500">{formatTime(s.startTime)} - {formatTime(s.endTime)}</td><td className="p-2 text-right font-mono">{((s.endTime.seconds - s.startTime.seconds)/3600).toFixed(1)}</td><td className="p-2 text-center">{s.absence?<AlertOctagon size={16} className="text-rose-500 mx-auto"/>:<CheckCircle size={16} className="text-emerald-500 mx-auto"/>}</td></tr>))}</tbody></table>
                            </div>
                        )}
                        {reportType === 'HOURS_BY_EMPLOYEE' && selectedReportRow.rawShifts && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-4 gap-4"><div className="p-4 border rounded-xl text-center"><p className="text-[10px] uppercase text-slate-400 font-bold">Total</p><p className="text-2xl font-black">{selectedReportRow.col3.toFixed(1)}h</p></div><div className="p-4 border rounded-xl text-center"><p className="text-[10px] uppercase text-slate-400 font-bold">Normales</p><p className="text-2xl font-black">{selectedReportRow.col4.toFixed(1)}h</p></div><div className="p-4 border rounded-xl text-center"><p className="text-[10px] uppercase text-amber-500 font-bold">Extra 50%</p><p className="text-2xl font-black text-amber-600">{selectedReportRow.col5.toFixed(1)}h</p></div><div className="p-4 border rounded-xl text-center"><p className="text-[10px] uppercase text-emerald-500 font-bold">Extra 100%</p><p className="text-2xl font-black text-emerald-600">{selectedReportRow.col6.toFixed(1)}h</p></div></div>
                                {Object.entries(groupShiftsByObjective(selectedReportRow.rawShifts)).map(([objName, shifts]:any, idx) => (<div key={idx} className="mb-6 border rounded-xl overflow-hidden"><div className="p-3 bg-slate-100 dark:bg-slate-800 font-bold text-xs">{objName}</div><table className="w-full text-sm text-left"><tbody className="divide-y dark:divide-slate-700">{shifts.map((s:any,i:number)=>(<tr key={i}><td className="p-2 pl-4 text-xs font-mono">{formatDate(s.startTime)}</td><td className="p-2 text-xs">{formatTime(s.startTime)} - {formatTime(s.endTime)}</td><td className="p-2 text-right">{s.isFranco?<span className="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-[10px] font-bold">FRANCO</span>:<span className="font-bold">{((s.endTime.seconds - s.startTime.seconds)/3600).toFixed(1)}</span>}</td></tr>))}</tbody></table></div>))}
                            </div>
                        )}
                        {reportType === 'ABSENCES' && selectedReportRow.absenceData && (
                            <div className="space-y-6">
                                <div className="bg-rose-50 p-4 rounded-xl border border-rose-100"><h3 className="font-black text-lg text-rose-700 uppercase">{selectedReportRow.category}</h3><p className="text-sm">Del {formatDate(selectedReportRow.absenceData.startDate)} al {formatDate(selectedReportRow.absenceData.endDate)}</p></div>
                                <p className="font-medium text-sm">{selectedReportRow.absenceData.reason || 'Sin detalles.'}</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        )}
      </div>
    </DashboardLayout>
  );
}
export default withAuthGuard(ReportsPage, ['admin', 'SuperAdmin', 'Director', 'Director ', 'Auditor']);