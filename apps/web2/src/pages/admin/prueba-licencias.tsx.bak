import React, { useState, useEffect } from 'react';
import DashboardLayout from '@/components/layout/DashboardLayout';
import { planningService } from '@/services/planningService';
import { ChevronLeft, ChevronRight, Search } from 'lucide-react';

// --- EL HELPER M√ÅGICO (La soluci√≥n propuesta) ---
// Convierte lo que sea (String o Timestamp) a "YYYY-MM-DD"
const toDateStr = (dateInput: any) => {
  if (!dateInput) return '';
  // Si ya es texto "2026-01-02", devolvemos eso.
  if (typeof dateInput === 'string') return dateInput.substring(0, 10);
  // Si es objeto, lo forzamos a Argentina
  const d = dateInput.seconds ? new Date(dateInput.seconds * 1000) : new Date(dateInput);
  return d.toLocaleDateString('en-CA', { timeZone: 'America/Argentina/Buenos_Aires' });
};
// ------------------------------------------------

export default function PruebaLicenciasPage() {
  const [absences, setAbsences] = useState<any[]>([]);
  const [employees, setEmployees] = useState<any[]>([]);
  const [currentDate, setCurrentDate] = useState(new Date('2026-01-01T12:00:00')); // Arrancamos en 2026 directo
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadData();
  }, [currentDate]);

  const loadData = async () => {
    setLoading(true);
    try {
      // Cargamos Empleados
      const emps = await planningService.getActiveEmployees();
      setEmployees(emps);

      // Cargamos Licencias del mes seleccionado
      const start = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const end = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      const abs = await planningService.getAbsencesByRange(start, end);
      
      console.log('üìÖ Rango:', start.toISOString(), 'al', end.toISOString());
      console.log('üìÇ Licencias encontradas en DB:', abs.length);
      
      setAbsences(abs);
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  };

  // Generar d√≠as del mes actual para la grilla
  const getDaysInMonth = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const days = new Date(year, month + 1, 0).getDate();
    const result = [];
    for (let i = 1; i <= days; i++) {
      const d = new Date(year, month, i);
      // TRUCO: Usamos toLocaleDateString('en-CA') para generar "2026-01-02" localmente
      const dateStr = d.toLocaleDateString('en-CA'); 
      result.push({ dateStr, dayNum: i });
    }
    return result;
  };

  const days = getDaysInMonth();
  const monthName = currentDate.toLocaleString('es-AR', { month: 'long', year: 'numeric' }).toUpperCase();

  return (
    <DashboardLayout>
      <div className="p-6 bg-slate-50 min-h-screen">
        <div className="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm">
            <h1 className="text-xl font-black text-indigo-700">üß™ LABORATORIO DE LICENCIAS</h1>
            
            <div className="flex items-center gap-4">
                <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()-1)))} className="p-2 bg-slate-100 rounded-lg hover:bg-slate-200"><ChevronLeft/></button>
                <span className="font-bold w-40 text-center">{monthName}</span>
                <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()+1)))} className="p-2 bg-slate-100 rounded-lg hover:bg-slate-200"><ChevronRight/></button>
            </div>

            <div className="text-xs text-right">
                <p>Mostrando datos de: <b>{absences.length}</b> licencias</p>
                <button onClick={() => setCurrentDate(new Date('2026-01-01T12:00:00'))} className="text-indigo-500 underline font-bold">IR A ENERO 2026</button>
            </div>
        </div>

        {/* GRILLA SIMPLIFICADA */}
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden border">
            {/* Cabecera D√≠as */}
            <div className="flex border-b bg-slate-100">
                <div className="w-48 p-3 font-bold text-xs text-slate-500 uppercase border-r shrink-0">Empleado</div>
                <div className="flex-1 flex overflow-x-auto">
                    {days.map(d => (
                        <div key={d.dateStr} className="min-w-[30px] flex-1 border-r p-1 text-center text-[10px] font-bold text-slate-400">
                            {d.dayNum}
                        </div>
                    ))}
                </div>
            </div>

            {/* Filas Empleados */}
            <div className="max-h-[600px] overflow-y-auto">
                {employees.map(emp => (
                    <div key={emp.id} className="flex border-b hover:bg-slate-50">
                        <div className="w-48 p-3 text-xs font-bold border-r shrink-0 truncate">{emp.name}</div>
                        <div className="flex-1 flex">
                            {days.map(day => {
                                // --- AQU√ç EST√Å LA MAGIA DE LA COMPARACI√ìN ---
                                const currentDayStr = day.dateStr; // Ejemplo: "2026-01-02"

                                const license = absences.find(a => {
                                    if (a.employeeId !== emp.id) return false;
                                    
                                    // Normalizamos los datos de firebase usando el helper
                                    const startStr = toDateStr(a.startDate);
                                    const endStr = toDateStr(a.endDate);

                                    // Comparamos TEXTO vs TEXTO
                                    return currentDayStr >= startStr && currentDayStr <= endStr;
                                });
                                // ---------------------------------------------

                                return (
                                    <div key={day.dateStr} className="min-w-[30px] flex-1 border-r flex items-center justify-center">
                                        {license ? (
                                            <div 
                                                title={`${license.type} (${toDateStr(license.startDate)} al ${toDateStr(license.endDate)})`}
                                                className="w-full h-full bg-emerald-500 text-white font-bold text-[10px] flex items-center justify-center cursor-help"
                                            >
                                                L
                                            </div>
                                        ) : null}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                ))}
            </div>
        </div>
        
        {/* DEBUGGER VISUAL */}
        <div className="mt-8 p-4 bg-slate-800 text-green-400 rounded-xl font-mono text-xs overflow-auto h-40">
            <p className="text-white font-bold border-b border-slate-600 mb-2 pb-2">üîç DATOS CRUDOS DE LICENCIAS (Primeros 3):</p>
            {absences.slice(0, 3).map((a, i) => (
                <div key={i} className="mb-2">
                    {JSON.stringify(a)}
                </div>
            ))}
        </div>
      </div>
    </DashboardLayout>
  );
}
