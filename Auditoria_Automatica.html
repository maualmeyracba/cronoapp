
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard T茅cnico Autom谩tico</title>
    <style>
        body { margin:0; display:flex; height:100vh; font-family: sans-serif; background: #f8fafc; color: #334155; }
        aside { width: 300px; background: #0f172a; color: white; display: flex; flex-direction: column; overflow: hidden; }
        .header { padding: 20px; border-bottom: 1px solid #334155; }
        .header h2 { margin: 0; font-size: 1.2rem; }
        .search { padding: 10px; border-bottom: 1px solid #334155; }
        .search input { width: 100%; padding: 8px; background: #1e293b; border: none; color: white; border-radius: 4px; }
        
        .list { flex: 1; overflow-y: auto; padding: 10px; }
        .category { font-size: 0.7rem; font-weight: bold; color: #64748b; margin: 15px 0 5px 5px; letter-spacing: 1px; }
        .item { padding: 8px 10px; cursor: pointer; font-size: 0.85rem; color: #cbd5e1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item:hover { background: rgba(255,255,255,0.1); color: white; border-radius: 4px; }
        .item.active { background: #3b82f6; color: white; border-radius: 4px; }

        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .topbar { height: 50px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .path { font-family: monospace; font-size: 0.9rem; color: #64748b; }
        .btn-pdf { padding: 5px 15px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

        #codeArea { flex: 1; overflow: auto; padding: 20px; background: #1e293b; color: #e2e8f0; font-family: 'Consolas', monospace; font-size: 14px; line-height: 1.5; white-space: pre; }
        
        /* Syntax Highlight Simple */
        .kw { color: #c678dd; } .str { color: #98c379; } .cm { color: #7f848e; font-style: italic; }

        @media print {
            aside, .topbar button { display: none; }
            #codeArea { background: white; color: black; border: 1px solid #ccc; white-space: pre-wrap; }
        }
    </style>
</head>
<body>
    <aside>
        <div class="header"><h2>CronoApp Audit</h2></div>
        <div class="search"><input type="text" id="search" placeholder="Filtrar..." onkeyup="render()"></div>
        <div class="list" id="list"></div>
    </aside>
    <main>
        <div class="topbar">
            <span class="path" id="pathDisplay">Selecciona un archivo</span>
            <button class="btn-pdf" onclick="window.print()">Imprimir / PDF</button>
        </div>
        <div id="codeArea">// El c贸digo aparecer谩 aqu铆</div>
    </main>

    <script>
        const files = [{"id":"o7si7zdh2","name":"app.module.ts","path":"apps\\\\functions\\\\src\\\\app.module.ts","area":"BACKEND","content":"import { Module } from \'@nestjs/common\';\\r\\nimport { AuthModule } from \'./auth/auth.module\';\\r\\nimport { SchedulingModule } from \'./scheduling/scheduling.module\';\\r\\nimport { DataManagementModule } from \'./data-management/data-management.module\';\\r\\n\\r\\n@Module({\\r\\n  imports: [\\r\\n    AuthModule,\\r\\n    SchedulingModule, // Este m贸dulo ahora exporta PatternService correctamente\\r\\n    DataManagementModule,\\r\\n  ],\\r\\n  controllers: [],\\r\\n  providers: [],\\r\\n})\\r\\nexport class AppModule {}\\n\\n\\n\\n"},{"id":"bn255oesa","name":"auth.module.ts","path":"apps\\\\functions\\\\src\\\\auth\\\\auth.module.ts","area":"BACKEND","content":"import { Module } from \'@nestjs/common\';\\r\\nimport { AuthService } from \'./auth.service\';\\r\\n\\r\\n/**\\r\\n * @module AuthModule\\r\\n * @description M贸dulo encargado de la creaci贸n de usuarios, asignaci贸n de roles (Custom Claims)\\r\\n * y gesti贸n de perfiles en la colecci贸n \'empleados\'.\\r\\n */\\r\\n@Module({\\r\\n  imports: [],\\r\\n  providers: [AuthService],\\r\\n  exports: [AuthService], // Exportamos el servicio para que otros m贸dulos lo utilicen.\\r\\n})\\r\\nexport class AuthModule {}\\n\\n\\n\\n"},{"id":"p9g9tymv1","name":"auth.service.ts","path":"apps\\\\functions\\\\src\\\\auth\\\\auth.service.ts","area":"BACKEND","content":"import { Injectable, InternalServerErrorException, ConflictException } from \'@nestjs/common\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { IEmployee } from \'../common/interfaces/employee.interface\';\\r\\n\\r\\nconst EMPLOYEES_COLLECTION = \'empleados\';\\r\\n\\r\\n@Injectable()\\r\\nexport class AuthService {\\r\\n\\r\\n  //  Inicializaci贸n diferida (Lazy Loading)\\r\\n  private getAuth = () => admin.app().auth();\\r\\n  private getDb = () => admin.app().firestore();\\r\\n\\r\\n  async createEmployeeProfile(\\r\\n    email: string,\\r\\n    password: string,\\r\\n    role: IEmployee[\'role\'],\\r\\n    name: string,\\r\\n    //  Nuevo argumento: Datos extendidos del perfil\\r\\n    profileData: { clientId: string, dni: string, fileNumber: string, address: string }\\r\\n  ): Promise<IEmployee> {\\r\\n    \\r\\n    const authInstance = this.getAuth();\\r\\n\\r\\n    // 1. Crear usuario en Auth\\r\\n    const user = await authInstance.createUser({\\r\\n      email,\\r\\n      password,\\r\\n      displayName: name,\\r\\n      emailVerified: true,\\r\\n    }).catch(error => {\\r\\n      if (error.code === \'auth/email-already-exists\') {\\r\\n        throw new ConflictException(\'La direcci贸n de correo ya est谩 en uso.\');\\r\\n      }\\r\\n      console.error(\'[AUTH_CREATE_ERROR]\', error.message);\\r\\n      throw new InternalServerErrorException(\'Error al crear usuario en Firebase Auth.\');\\r\\n    });\\r\\n\\r\\n    const employeeUid = user.uid;\\r\\n\\r\\n    // 2. Asignar Custom Claims (Rol)\\r\\n    try {\\r\\n      await authInstance.setCustomUserClaims(employeeUid, { role });\\r\\n    } catch (error) {\\r\\n      console.error(`[CLAIMS_ERROR] Failed to set claims.`, error);\\r\\n      await authInstance.deleteUser(employeeUid); // Rollback\\r\\n      throw new InternalServerErrorException(\'Error al asignar rol. Creaci贸n abortada.\');\\r\\n    }\\r\\n    \\r\\n    // 3. Crear Perfil en Firestore con los NUEVOS CAMPOS\\r\\n    const employeeProfile: IEmployee = {\\r\\n      uid: employeeUid,\\r\\n      email: email,\\r\\n      name: name,\\r\\n      role: role,\\r\\n      isAvailable: true,\\r\\n      maxHoursPerMonth: 176,        // Valor est谩ndar\\r\\n      contractType: \'FullTime\',     // Valor est谩ndar\\r\\n      //  Mapeo de campos extendidos\\r\\n      clientId: profileData.clientId,\\r\\n      dni: profileData.dni,\\r\\n      fileNumber: profileData.fileNumber,\\r\\n      address: profileData.address\\r\\n    };\\r\\n\\r\\n    const dbInstance = this.getDb();\\r\\n    \\r\\n    try {\\r\\n      await dbInstance.collection(EMPLOYEES_COLLECTION).doc(employeeUid).set(employeeProfile);\\r\\n    } catch (error) {\\r\\n      console.error(`[FIRESTORE_ERROR] Failed to create profile.`, error);\\r\\n      await authInstance.deleteUser(employeeUid); // Rollback\\r\\n      throw new InternalServerErrorException(\'Error al guardar perfil. Creaci贸n abortada.\');\\r\\n    }\\r\\n\\r\\n    return employeeProfile;\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"qih1953kn","name":"roles.guard.ts","path":"apps\\\\functions\\\\src\\\\auth\\\\guards\\\\roles.guard.ts","area":"BACKEND","content":"// apps/functions/src/auth/guards/roles.guard.ts\\r\\nimport { Injectable, CanActivate, ExecutionContext } from \'@nestjs/common\';\\r\\nimport { Reflector } from \'@nestjs/core\';\\r\\nimport { IEmployee } from \'../../common/interfaces/employee.interface\'; //  RUTA FINAL: Retrocede 2 niveles\\r\\nimport \'reflect-metadata\'; \\r\\n\\r\\n// ... (resto del c贸digo permanece igual)\\r\\n\\r\\n// 1. Decorador para definir los roles requeridos\\r\\nexport const ROLES_KEY = \'roles\';\\r\\nexport const Roles = (...roles: IEmployee[\'role\'][]) => \\r\\n  (target: any, key?: any, descriptor?: any) => {\\r\\n    // Uso corregido de Reflect (Soluci贸n TS2339)\\r\\n    Reflect.defineMetadata(ROLES_KEY, roles, descriptor.value || target);\\r\\n  };\\r\\n\\r\\n\\r\\n@Injectable()\\r\\nexport class RolesGuard implements CanActivate {\\r\\n  constructor(private reflector: Reflector) {}\\r\\n\\r\\n  canActivate(context: ExecutionContext): boolean {\\r\\n    const requiredRoles = this.reflector.get<IEmployee[\'role\'][]>(\\r\\n      ROLES_KEY,\\r\\n      context.getHandler(),\\r\\n    );\\r\\n\\r\\n    if (!requiredRoles) {\\r\\n      return true;\\r\\n    }\\r\\n\\r\\n    const request = context.switchToHttp().getRequest();\\r\\n    const userRole = request.context?.auth?.token?.role;\\r\\n\\r\\n    if (!userRole) {\\r\\n        return false;\\r\\n    }\\r\\n\\r\\n    return requiredRoles.some((role) => role === userRole);\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"bn1wtch6f","name":"roles-permissions.config.ts","path":"apps\\\\functions\\\\src\\\\common\\\\config\\\\roles-permissions.config.ts","area":"BACKEND","content":"// 1. DEFINICIN DE PERMISOS (Lo que se puede hacer)\\r\\nexport const PERMISSIONS = {\\r\\n    // Dashboard\\r\\n    VIEW_DASHBOARD: \'view_dashboard\',\\r\\n    \\r\\n    // Operaciones\\r\\n    MANAGE_SHIFTS: \'manage_shifts\',      // Crear/Editar Turnos\\r\\n    AUDIT_GPS: \'audit_gps\',              // Ver mapa en vivo\\r\\n    \\r\\n    // RRHH\\r\\n    VIEW_EMPLOYEES: \'view_employees\',\\r\\n    MANAGE_EMPLOYEES: \'manage_employees\', // ABM Empleados\\r\\n    MANAGE_ABSENCES: \'manage_absences\',   // Cargar licencias\\r\\n    \\r\\n    // Configuraci贸n\\r\\n    VIEW_AUDIT: \'view_audit\',            // Ver historial\\r\\n    MANAGE_USERS: \'manage_users\',        // Crear otros admins\\r\\n    MANAGE_ROLES: \'manage_roles\',        // (Futuro) Crear roles\\r\\n} as const;\\r\\n\\r\\n// 2. DEFINICIN DE ROLES (Agrupaci贸n de permisos)\\r\\nexport const ROLES_CONFIG = {\\r\\n    \'SuperAdmin\': [ \'ALL\' ], // Acceso total (Llave maestra)\\r\\n    \\r\\n    \'Director\': [\\r\\n        PERMISSIONS.VIEW_DASHBOARD,\\r\\n        PERMISSIONS.VIEW_AUDIT,\\r\\n        PERMISSIONS.AUDIT_GPS,\\r\\n        PERMISSIONS.VIEW_EMPLOYEES\\r\\n    ],\\r\\n    \\r\\n    \'RRHH\': [\\r\\n        PERMISSIONS.VIEW_DASHBOARD,\\r\\n        PERMISSIONS.VIEW_EMPLOYEES,\\r\\n        PERMISSIONS.MANAGE_EMPLOYEES,\\r\\n        PERMISSIONS.MANAGE_ABSENCES\\r\\n    ],\\r\\n    \\r\\n    \'Scheduler\': [ // Planificador\\r\\n        PERMISSIONS.VIEW_DASHBOARD,\\r\\n        PERMISSIONS.MANAGE_SHIFTS,\\r\\n        PERMISSIONS.VIEW_EMPLOYEES\\r\\n    ],\\r\\n\\r\\n    // Agrega aqu铆 los roles que quieras inventar\\r\\n    \'Auditor\': [\\r\\n        PERMISSIONS.VIEW_AUDIT,\\r\\n        PERMISSIONS.AUDIT_GPS\\r\\n    ]\\r\\n};\\n\\n"},{"id":"zeq1wzymm","name":"labor-rules.ts","path":"apps\\\\functions\\\\src\\\\common\\\\constants\\\\labor-rules.ts","area":"BACKEND","content":"import { LaborAgreement } from \'../interfaces/employee.interface\';\\r\\n\\r\\nexport interface LaborRule {\\r\\n    name: string;\\r\\n    maxHoursWeekly?: number;      // L铆mite semanal (ej: 48hs)\\r\\n    maxHoursMonthly: number;      // L铆mite mensual referencial\\r\\n    overtimeThresholdDaily?: number; // A partir de qu茅 hora diaria es extra (ej: 9hs o 12hs)\\r\\n    saturdayCutoffHour: number;   // Hora corte s谩bado para el 100% (ej: 13:00)\\r\\n    nightShiftStart: number;      // Hora inicio nocturnidad (21:00)\\r\\n    nightShiftEnd: number;        // Hora fin nocturnidad (06:00)\\r\\n}\\r\\n\\r\\n// DEFINICIN DE CONVENIOS\\r\\nexport const LABOR_RULES: Record<LaborAgreement, LaborRule> = {\\r\\n    \'SUVICO\': {\\r\\n        name: \'Seguridad Privada (CCT 422/05)\',\\r\\n        maxHoursWeekly: 48,\\r\\n        maxHoursMonthly: 204, // Divisor est谩ndar convenio\\r\\n        overtimeThresholdDaily: 12, // Se permiten jornadas de 12h sin extra si no pasa las 48h sem\\r\\n        saturdayCutoffHour: 13,\\r\\n        nightShiftStart: 21,\\r\\n        nightShiftEnd: 6\\r\\n    },\\r\\n    \'COMERCIO\': {\\r\\n        name: \'Empleados de Comercio\',\\r\\n        maxHoursWeekly: 48,\\r\\n        maxHoursMonthly: 196,\\r\\n        overtimeThresholdDaily: 9, // Jornada de 9h\\r\\n        saturdayCutoffHour: 13,\\r\\n        nightShiftStart: 21,\\r\\n        nightShiftEnd: 6\\r\\n    },\\r\\n    \'UOCRA\': {\\r\\n        name: \'Construcci贸n\',\\r\\n        maxHoursWeekly: 44,\\r\\n        maxHoursMonthly: 176,\\r\\n        overtimeThresholdDaily: 9,\\r\\n        saturdayCutoffHour: 13,\\r\\n        nightShiftStart: 20,\\r\\n        nightShiftEnd: 6\\r\\n    },\\r\\n    \'FUERA_CONVENIO\': {\\r\\n        name: \'Personal Jer谩rquico\',\\r\\n        maxHoursWeekly: 999, // Sin l铆mite estricto de horas extra\\r\\n        maxHoursMonthly: 999,\\r\\n        overtimeThresholdDaily: 24,\\r\\n        saturdayCutoffHour: 24,\\r\\n        nightShiftStart: 22,\\r\\n        nightShiftEnd: 6\\r\\n    }\\r\\n};\\n\\n\\n\\n"},{"id":"erkokflhp","name":"absence.interface.ts","path":"apps\\\\functions\\\\src\\\\common\\\\interfaces\\\\absence.interface.ts","area":"BACKEND","content":"import * as admin from \'firebase-admin\';\\r\\n\\r\\nexport type AbsenceType = \'VACATION\' | \'SICK_LEAVE\' | \'OTHER\';\\r\\n\\r\\nexport interface IAbsence {\\r\\n  id: string;\\r\\n  employeeId: string;\\r\\n  employeeName: string; //  Campo necesario para la UI\\r\\n  clientId: string;\\r\\n  type: AbsenceType;\\r\\n  startDate: admin.firestore.Timestamp;\\r\\n  endDate: admin.firestore.Timestamp;\\r\\n  reason: string;\\r\\n  status: \'PENDING\' | \'APPROVED\' | \'REJECTED\';\\r\\n  createdAt: admin.firestore.Timestamp;\\r\\n}\\r\\n\\r\\n//  ESTA EXPORTACIN ES CRTICA PARA EL SERVICIO\\r\\nexport interface IAbsencePayload {\\r\\n  employeeId: string;\\r\\n  employeeName: string;\\r\\n  clientId: string;\\r\\n  type: AbsenceType;\\r\\n  // Flexible para aceptar Dates del frontend o Timestamps internos\\r\\n  startDate: admin.firestore.Timestamp | Date;\\r\\n  endDate: admin.firestore.Timestamp | Date;\\r\\n  reason: string;\\r\\n}\\n\\n\\n\\n"},{"id":"zr3wvzg7r","name":"api.interface.ts","path":"apps\\\\functions\\\\src\\\\common\\\\interfaces\\\\api.interface.ts","area":"BACKEND","content":"// api.interface.ts (Ejemplo de respuesta estandarizada de API Gateway/Backend)\\r\\nexport interface IApiResponse<T> {\\r\\n  success: boolean;\\r\\n  data: T;\\r\\n  message?: string;\\r\\n}\\r\\n\\r\\n// employee.interface.ts (Aseguramos la interfaz de IEmployee)\\r\\nexport interface IEmployee {\\r\\n  uid: string;\\r\\n  name: string;\\r\\n  role: string;\\r\\n  // A帽adir cualquier otro campo relevante (ej: maxHoursPerMonth, email)\\r\\n}\\n\\n\\n\\n"},{"id":"6rbtt6w1g","name":"client.interface.ts","path":"apps\\\\functions\\\\src\\\\common\\\\interfaces\\\\client.interface.ts","area":"BACKEND","content":"import * as admin from \'firebase-admin\';\\r\\n\\r\\n/**\\r\\n * @interface IClient\\r\\n * @description La empresa o entidad que contrata nuestros servicios de seguridad/personal.\\r\\n * Es la entidad ra铆z de la jerarqu铆a comercial.\\r\\n */\\r\\nexport interface IClient {\\r\\n  id: string;\\r\\n  /** Raz贸n Social o Nombre Comercial */\\r\\n  businessName: string; \\r\\n  /** Identificaci贸n Fiscal (CUIT/RUT/NIT) */\\r\\n  cuit: string;         \\r\\n  /** Nombre del contacto principal */\\r\\n  contactName: string;\\r\\n  /** Email del contacto para notificaciones autom谩ticas */\\r\\n  contactEmail: string;\\r\\n  /** Estado administrativo del cliente */\\r\\n  status: \'Active\' | \'Inactive\' | \'Suspended\';\\r\\n  /** Fecha de alta en el sistema */\\r\\n  createdAt: admin.firestore.Timestamp;\\r\\n}\\r\\n\\r\\n/**\\r\\n * @interface IObjective\\r\\n * @description El lugar f铆sico, sucursal o puesto donde se presta el servicio.\\r\\n * Pertenece a un Cliente.\\r\\n */\\r\\nexport interface IObjective {\\r\\n  id: string;\\r\\n  /** ID del Cliente al que pertenece (Foreign Key) */\\r\\n  clientId: string; \\r\\n  /** Nombre del objetivo (Ej: \\"Planta Industrial Pilar\\") */\\r\\n  name: string;     \\r\\n  /** Direcci贸n f铆sica real */\\r\\n  address: string;\\r\\n  /** Coordenadas para el Geofencing (Check-in/out) */\\r\\n  location: {\\r\\n    latitude: number;\\r\\n    longitude: number;\\r\\n  };\\r\\n  /** Zonas internas (opcional). Ej: [\\"Garita 1\\", \\"Recepci贸n\\", \\"Ronda\\"] */\\r\\n  zones?: string[]; \\r\\n}\\r\\n\\r\\n/**\\r\\n * @interface IServiceContract\\r\\n * @description Define el acuerdo de nivel de servicio (SLA) para un Objetivo.\\r\\n * Establece cu谩ntas horas se vendieron y en qu茅 per铆odo.\\r\\n */\\r\\nexport interface IServiceContract {\\r\\n  id: string;\\r\\n  /** ID del Objetivo asociado (Foreign Key) */\\r\\n  objectiveId: string; \\r\\n  /** Nombre del servicio (Ej: \\"Seguridad 24x7 - 2025\\") */\\r\\n  name: string;        \\r\\n  startDate: admin.firestore.Timestamp;\\r\\n  endDate?: admin.firestore.Timestamp; // Opcional si es indeterminado\\r\\n  /** Objetivo de venta mensual en horas (para reportes de rentabilidad) */\\r\\n  totalHoursPerMonth: number; \\r\\n  isActive: boolean;\\r\\n}\\r\\n\\r\\n/**\\r\\n * @interface IShiftType (Modalidad)\\r\\n * @description Plantilla de turno para agilizar la planificaci贸n.\\r\\n * Define los \\"moldes\\" que se arrastrar谩n al calendario.\\r\\n */\\r\\nexport interface IShiftType {\\r\\n  id: string;\\r\\n  /** ID del Contrato al que pertenece esta modalidad (Foreign Key) */\\r\\n  contractId: string; \\r\\n  /** Nombre descriptivo (Ej: \\"Turno Tarde 8hs\\") */\\r\\n  name: string;       \\r\\n  /** C贸digo corto para visualizaci贸n en calendario (Ej: \\"T8\\") */\\r\\n  code: string;       \\r\\n  /** Color hexadecimal para diferenciar en el calendario (Ej: \\"#FF5733\\") */\\r\\n  color: string;      \\r\\n  \\r\\n  // Configuraci贸n del Horario Base\\r\\n  /** Hora de inicio sugerida en formato \\"HH:mm\\" (Ej: \\"14:00\\") */\\r\\n  startTime: string;     \\r\\n  /** Duraci贸n en horas para c谩lculo de costos (Ej: 8) */\\r\\n  durationHours: number; \\r\\n  \\r\\n  /** Requisitos espec铆ficos (Opcional). Ej: \\"Vigilador Armado\\", \\"Chofer\\" */\\r\\n  requiredRole?: string; \\r\\n}\\n\\n\\n\\n"},{"id":"49cnx689o","name":"employee.interface.ts","path":"apps\\\\functions\\\\src\\\\common\\\\interfaces\\\\employee.interface.ts","area":"BACKEND","content":"import * as admin from \'firebase-admin\';\\r\\n\\r\\n/**\\r\\n * @description Define los roles de usuario dentro del sistema.\\r\\n */\\r\\nexport type EmployeeRole = \'admin\' | \'employee\';\\r\\n\\r\\n/**\\r\\n * @description Define los tipos de contrato laboral soportados.\\r\\n */\\r\\nexport type ContractType = \'FullTime\' | \'PartTime\' | \'Eventual\';\\r\\n\\r\\n/**\\r\\n *  NUEVO: Convenios Colectivos soportados para reglas de negocio.\\r\\n */\\r\\nexport type LaborAgreement = \'SUVICO\' | \'COMERCIO\' | \'UOCRA\' | \'FUERA_CONVENIO\';\\r\\n\\r\\n/**\\r\\n * @description Interfaz de Colaborador (Versi贸n Backend).\\r\\n */\\r\\nexport interface IEmployee {\\r\\n  uid: string;\\r\\n  name: string;\\r\\n  role: EmployeeRole;\\r\\n  email: string;\\r\\n  \\r\\n  isAvailable: boolean;\\r\\n  \\r\\n  // Configuraci贸n Laboral\\r\\n  maxHoursPerMonth: number;\\r\\n  contractType: ContractType;\\r\\n  \\r\\n  //  NUEVO CAMPO: Convenio Colectivo\\r\\n  laborAgreement?: LaborAgreement; \\r\\n  \\r\\n  // Campos para el Ciclo de N贸mina\\r\\n  payrollCycleStartDay?: number; \\r\\n  payrollCycleEndDay?: number;\\r\\n  \\r\\n  clientId?: string;\\r\\n  businessUnitId?: string;\\r\\n\\r\\n  dni: string;        \\r\\n  fileNumber: string;\\r\\n  address: string;    \\r\\n  phone?: string;\\r\\n}\\r\\n\\r\\nexport interface IAbsence {\\r\\n    id: string;\\r\\n    employeeId: string;\\r\\n    employeeName: string;\\r\\n    clientId: string;\\r\\n    type: \'VACATION\' | \'SICK_LEAVE\' | \'OTHER\';\\r\\n    startDate: admin.firestore.Timestamp; \\r\\n    endDate: admin.firestore.Timestamp;\\r\\n    reason: string;\\r\\n    status: \'PENDING\' | \'APPROVED\' | \'REJECTED\';\\r\\n    createdAt: admin.firestore.Timestamp;\\r\\n}\\r\\n\\r\\nexport interface IAbsencePayload {\\r\\n    employeeId: string;\\r\\n    employeeName: string;\\r\\n    clientId: string;\\r\\n    type: \'VACATION\' | \'SICK_LEAVE\' | \'OTHER\';\\r\\n    startDate: admin.firestore.Timestamp | Date | string; \\r\\n    endDate: admin.firestore.Timestamp | Date | string;\\r\\n    reason: string;\\r\\n}\\n\\n\\n\\n"},{"id":"uk71zaz0t","name":"labor-agreement.interface.ts","path":"apps\\\\functions\\\\src\\\\common\\\\interfaces\\\\labor-agreement.interface.ts","area":"BACKEND","content":"import * as admin from \'firebase-admin\';\\r\\n\\r\\nexport interface ILaborAgreement {\\r\\n    id: string;\\r\\n    name: string;           // Ej: \\"Seguridad Privada 422/05\\"\\r\\n    code: string;           // Ej: \\"SUVICO\\"\\r\\n    \\r\\n    // Reglas de Negocio\\r\\n    maxHoursWeekly: number; // 48\\r\\n    maxHoursMonthly: number;// 204\\r\\n    \\r\\n    // Configuraci贸n de Extras\\r\\n    saturdayCutoffHour: number; // 13\\r\\n    nightShiftStart: number;    // 21\\r\\n    nightShiftEnd: number;      // 6\\r\\n    \\r\\n    isActive: boolean;\\r\\n    createdAt?: admin.firestore.Timestamp;\\r\\n}\\n\\n\\n\\n"},{"id":"pdqhiumsg","name":"service-pattern.interface.ts","path":"apps\\\\functions\\\\src\\\\common\\\\interfaces\\\\service-pattern.interface.ts","area":"BACKEND","content":"import * as admin from \'firebase-admin\';\\r\\n\\r\\n/**\\r\\n * @interface IServicePattern (El \\"Molde\\" Inteligente)\\r\\n * @description Define una regla de recurrencia para generar turnos autom谩ticamente.\\r\\n * Ej: \\"Necesito 2 Vigiladores (Turno Noche) todos los Lunes, Mi茅rcoles y Viernes\\".\\r\\n */\\r\\nexport interface IServicePattern {\\r\\n  id: string;\\r\\n  contractId: string;      // Vinculado al contrato \\"Seguridad Planta 2025\\"\\r\\n  shiftTypeId: string;     // Usa la modalidad \\"Turno Noche 12hs\\"\\r\\n  \\r\\n  // Configuraci贸n de Recurrencia\\r\\n  // 0=Dom, 1=Lun, ..., 6=Sab. Ej: [1,2,3,4,5] para Lun-Vie.\\r\\n  daysOfWeek: number[];    \\r\\n  \\r\\n  // Cantidad de recursos requeridos simult谩neamente\\r\\n  quantityPerDay: number;  \\r\\n  \\r\\n  // Vigencia de la regla\\r\\n  validFrom: admin.firestore.Timestamp;\\r\\n  validTo?: admin.firestore.Timestamp; // Si es null, es indefinido\\r\\n  \\r\\n  // Metadatos\\r\\n  createdAt: admin.firestore.Timestamp;\\r\\n  createdBy: string; // UID del planificador\\r\\n  active: boolean;\\r\\n}\\r\\n\\r\\n/**\\r\\n * Payload para crear/editar un patr贸n desde el Frontend.\\r\\n * Usamos strings para las fechas para evitar problemas de serializaci贸n.\\r\\n */\\r\\nexport interface IPatternPayload {\\r\\n  contractId: string;\\r\\n  shiftTypeId: string;\\r\\n  daysOfWeek: number[];\\r\\n  quantity: number;\\r\\n  validFrom: string; // ISO String\\r\\n  validTo?: string;  // ISO String\\r\\n}\\n\\n\\n\\n"},{"id":"b4xs384u7","name":"shift.interface.ts","path":"apps\\\\functions\\\\src\\\\common\\\\interfaces\\\\shift.interface.ts","area":"BACKEND","content":"import * as admin from \'firebase-admin\';\\r\\n\\r\\nexport interface IShift {\\r\\n  id: string;\\r\\n  \\r\\n  // Relaci贸n con Empleado\\r\\n  employeeId: string;\\r\\n  employeeName: string;\\r\\n  \\r\\n  // Relaci贸n con Objetivo\\r\\n  objectiveId: string;\\r\\n  objectiveName: string;\\r\\n  \\r\\n  // Tiempos (Firestore Admin SDK)\\r\\n  startTime: admin.firestore.Timestamp; \\r\\n  endTime: admin.firestore.Timestamp;\\r\\n  \\r\\n  // Estado\\r\\n  status: \'Assigned\' | \'Confirmed\' | \'InProgress\' | \'Completed\' | \'Canceled\';\\r\\n  \\r\\n  // Auditor铆a de Fichaje\\r\\n  checkInTime?: admin.firestore.Timestamp;\\r\\n  checkOutTime?: admin.firestore.Timestamp;\\r\\n  \\r\\n  // Metadatos\\r\\n  schedulerId: string;\\r\\n  updatedAt: admin.firestore.Timestamp;\\r\\n  \\r\\n  // Roles y Flags\\r\\n  role?: string;           // Ej: \'Vigilador\'\\r\\n  isOvertime?: boolean;    //  NUEVO: Indica si el turno fue autorizado con exceso de horas\\r\\n}\\n\\n\\n\\n"},{"id":"2y2z91wew","name":"system-user.interface.ts","path":"apps\\\\functions\\\\src\\\\common\\\\interfaces\\\\system-user.interface.ts","area":"BACKEND","content":"import * as admin from \'firebase-admin\'; //  SDK SERVIDOR\\r\\n\\r\\n/**\\r\\n * Roles Jer谩rquicos del Sistema (RBAC):\\r\\n * - SuperAdmin: IT / Due帽o del SaaS. Ve todas las unidades.\\r\\n * - Manager: Gerente de Unidad. Ve todo dentro de su unidad.\\r\\n * - Scheduler: Planificador. Gestiona turnos y asignaciones.\\r\\n * - Supervisor: Campo. Gestiona incidencias y personal.\\r\\n * - Operator: Monitoreo. Solo lectura o vista de tablero en vivo.\\r\\n */\\r\\nexport type SystemRole = \\r\\n  | \'SuperAdmin\' \\r\\n  | \'Manager\' \\r\\n  | \'Scheduler\' \\r\\n  | \'Supervisor\' \\r\\n  | \'Operator\';\\r\\n\\r\\n/**\\r\\n * @interface ISystemUser\\r\\n * @description Usuario administrativo con acceso al Panel de Control (Back-Office).\\r\\n * Se almacena en la colecci贸n \'system_users\'.\\r\\n */\\r\\nexport interface ISystemUser {\\r\\n  uid: string;\\r\\n  email: string;\\r\\n  displayName: string;\\r\\n  role: SystemRole;\\r\\n  \\r\\n  // ID de la Unidad de Negocio a la que pertenece\\r\\n  // Si es undefined y el rol es SuperAdmin, tiene acceso global.\\r\\n  businessUnitId?: string; \\r\\n  \\r\\n  status: \'Active\' | \'Inactive\';\\r\\n  \\r\\n  //  IMPORTANTE: En el backend usamos el namespace de admin para Timestamps\\r\\n  createdAt: admin.firestore.Timestamp;\\r\\n  lastLogin?: admin.firestore.Timestamp;\\r\\n}\\n\\n\\n\\n"},{"id":"9mpl7zi29","name":"absence.interface.ts","path":"apps\\\\functions\\\\src\\\\data-management\\\\absence.interface.ts","area":"BACKEND","content":"import * as admin from \'firebase-admin\';\\r\\n\\r\\n/**\\r\\n * Estructura de la entidad Ausencia almacenada en Firestore.\\r\\n */\\r\\nexport interface IAbsence {\\r\\n    id: string; \\r\\n    employeeId: string;\\r\\n    employeeName: string;\\r\\n    clientId: string; \\r\\n    type: \'VACATION\' | \'SICK_LEAVE\' | \'OTHER\'; \\r\\n    startDate: admin.firestore.Timestamp; \\r\\n    endDate: admin.firestore.Timestamp; \\r\\n    reason: string; \\r\\n    status: \'PENDING\' | \'APPROVED\' | \'REJECTED\'; \\r\\n    createdAt: admin.firestore.Timestamp;\\r\\n}\\r\\n\\r\\n/**\\r\\n * Payload recibido del Frontend.\\r\\n *  ES CRTICO QUE ESTA INTERFAZ TENGA \'export\' PARA QUE EL SERVICIO LA VEA.\\r\\n */\\r\\nexport interface IAbsencePayload {\\r\\n    employeeId: string;\\r\\n    employeeName: string;\\r\\n    clientId: string;\\r\\n    type: \'VACATION\' | \'SICK_LEAVE\' | \'OTHER\';\\r\\n    // Flexible: Timestamp (si viene de otro servicio) o Date (si viene de JSON serializado)\\r\\n    startDate: admin.firestore.Timestamp | Date; \\r\\n    endDate: admin.firestore.Timestamp | Date;\\r\\n    reason: string;\\r\\n}\\n\\n\\n\\n"},{"id":"f7gnhlpyk","name":"absence.service.ts","path":"apps\\\\functions\\\\src\\\\data-management\\\\absence.service.ts","area":"BACKEND","content":"import { Injectable } from \'@nestjs/common\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { WorkloadService } from \'../scheduling/workload.service\';\\r\\nimport { IAbsence, IAbsencePayload } from \'../common/interfaces/absence.interface\';\\r\\nimport { IShift } from \'../common/interfaces/shift.interface\';\\r\\n\\r\\n@Injectable()\\r\\nexport class AbsenceService {\\r\\n    private getDb = () => admin.app().firestore();\\r\\n    private readonly absencesCollection = \'ausencias\';\\r\\n    private readonly shiftsCollection = \'turnos\';\\r\\n    \\r\\n    constructor(private readonly workloadService: WorkloadService) {}\\r\\n\\r\\n    private toDate(val: any): Date {\\r\\n        if (!val) return new Date();\\r\\n        if (val instanceof admin.firestore.Timestamp) return val.toDate();\\r\\n        if (val._seconds) return new Date(val._seconds * 1000);\\r\\n        if (typeof val === \'string\') return new Date(val);\\r\\n        return new Date(val);\\r\\n    }\\r\\n\\r\\n    async createAbsence(payload: IAbsencePayload): Promise<IAbsence & { impactedShiftsCount: number }> {\\r\\n        \\r\\n        // 1. Parsing y FIX de Fechas (D铆a Completo)\\r\\n        const startDateObj = this.toDate(payload.startDate);\\r\\n        const endDateObj = this.toDate(payload.endDate);\\r\\n\\r\\n        if (isNaN(startDateObj.getTime()) || isNaN(endDateObj.getTime())) {\\r\\n            throw new Error(\'Fechas inv谩lidas.\');\\r\\n        }\\r\\n\\r\\n        // FIX CRTICO: Forzar cobertura de D铆a Completo (00:00 a 23:59:59.999)\\r\\n        startDateObj.setHours(0, 0, 0, 0);\\r\\n        endDateObj.setHours(23, 59, 59, 999);\\r\\n\\r\\n        // 2. DETECCIN DE CONFLICTOS\\r\\n        const conflictingShifts = await this.workloadService.checkShiftOverlap(\\r\\n            payload.employeeId,\\r\\n            startDateObj, \\r\\n            endDateObj    \\r\\n        );\\r\\n\\r\\n        const db = this.getDb();\\r\\n        const batch = db.batch(); \\r\\n        \\r\\n        const typeReason = payload.type === \'SICK_LEAVE\' ? \'Licencia M茅dica\' : \\r\\n                           payload.type === \'VACATION\' ? \'Vacaciones\' : \'Ausencia\';\\r\\n        let shiftsConvertedToVacancy = 0;\\r\\n\\r\\n        //  LGICA DE CONVERSIN A VACANTE (FIX de Mauro)\\r\\n        if (conflictingShifts.length > 0) {\\r\\n            console.log(`[AbsenceService] Liberando ${conflictingShifts.length} turnos de ${payload.employeeName}...`);\\r\\n            \\r\\n            conflictingShifts.forEach((shift: IShift) => {\\r\\n                // Solo liberamos turnos que est谩n asignados, y no completados o cancelados\\r\\n                if (shift.employeeId !== \'VACANTE\' && shift.status !== \'Canceled\' && shift.status !== \'Completed\') {\\r\\n                    const shiftRef = db.collection(this.shiftsCollection).doc(shift.id);\\r\\n                    \\r\\n                    batch.update(shiftRef, {\\r\\n                        employeeId: \'VACANTE\',\\r\\n                        employeeName: \'VACANTE\', \\r\\n                        status: \'Assigned\', \\r\\n                        description: `Turno liberado por: ${typeReason} de ${payload.employeeName}.`, \\r\\n                        isOvertime: false, \\r\\n                        updatedAt: admin.firestore.Timestamp.now()\\r\\n                    });\\r\\n                    shiftsConvertedToVacancy++;\\r\\n                }\\r\\n            });\\r\\n        }\\r\\n\\r\\n        // 3. Crear la Ausencia\\r\\n        const startTimestamp = admin.firestore.Timestamp.fromDate(startDateObj);\\r\\n        const endTimestamp = admin.firestore.Timestamp.fromDate(endDateObj);\\r\\n\\r\\n        const newAbsence: any = { \\r\\n            employeeId: payload.employeeId,\\r\\n            employeeName: payload.employeeName,\\r\\n            clientId: payload.clientId,\\r\\n            type: payload.type,\\r\\n            startDate: startTimestamp,\\r\\n            endDate: endTimestamp,     \\r\\n            reason: payload.reason,\\r\\n            status: \'APPROVED\', \\r\\n            createdAt: admin.firestore.Timestamp.now(), \\r\\n            impactedShiftsCount: shiftsConvertedToVacancy \\r\\n        };\\r\\n\\r\\n        const newAbsenceRef = db.collection(this.absencesCollection).doc();\\r\\n        batch.set(newAbsenceRef, newAbsence);\\r\\n\\r\\n        await batch.commit();\\r\\n\\r\\n        return { id: newAbsenceRef.id, ...newAbsence, impactedShiftsCount: shiftsConvertedToVacancy };\\r\\n    }\\r\\n}\\n\\n\\n\\n"},{"id":"g1p8ig743","name":"client.service.ts","path":"apps\\\\functions\\\\src\\\\data-management\\\\client.service.ts","area":"BACKEND","content":"import { Injectable, NotFoundException, InternalServerErrorException } from \'@nestjs/common\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { \\r\\n  IClient, \\r\\n  IObjective, \\r\\n  IServiceContract, \\r\\n  IShiftType \\r\\n} from \'../common/interfaces/client.interface\';\\r\\n\\r\\nconst COLL_CLIENTS = \'clientes\';\\r\\nconst COLL_OBJECTIVES = \'objetivos\';\\r\\nconst COLL_CONTRACTS = \'contratos_servicio\';\\r\\nconst COLL_SHIFT_TYPES = \'tipos_turno\';\\r\\n\\r\\n@Injectable()\\r\\nexport class ClientService {\\r\\n\\r\\n  private getDb = () => admin.app().firestore();\\r\\n\\r\\n  // ==========================================\\r\\n  // 1. GESTIN DE CLIENTES\\r\\n  // ==========================================\\r\\n\\r\\n  async createClient(data: Omit<IClient, \'id\' | \'createdAt\'>): Promise<IClient> {\\r\\n    const db = this.getDb();\\r\\n    const ref = db.collection(COLL_CLIENTS).doc();\\r\\n    \\r\\n    const newClient: IClient = {\\r\\n      ...data,\\r\\n      id: ref.id,\\r\\n      createdAt: admin.firestore.Timestamp.now(),\\r\\n    };\\r\\n    await ref.set(newClient);\\r\\n    return newClient;\\r\\n  }\\r\\n\\r\\n  async getClient(id: string): Promise<IClient> {\\r\\n    const doc = await this.getDb().collection(COLL_CLIENTS).doc(id).get();\\r\\n    if (!doc.exists) throw new NotFoundException(\'Cliente no encontrado\');\\r\\n    return { id: doc.id, ...doc.data() } as IClient;\\r\\n  }\\r\\n\\r\\n  async findAllClients(): Promise<IClient[]> {\\r\\n    try {\\r\\n      const snapshot = await this.getDb().collection(COLL_CLIENTS).get();\\r\\n      if (snapshot.empty) return [];\\r\\n\\r\\n      return snapshot.docs.map(doc => ({\\r\\n          id: doc.id,\\r\\n          ...doc.data()\\r\\n      } as IClient));\\r\\n    } catch (error) {\\r\\n      console.error(\'[ERROR_FIND_CLIENTS]\', error);\\r\\n      throw new InternalServerErrorException(\'Error al consultar clientes.\');\\r\\n    }\\r\\n  }\\r\\n\\r\\n  async updateClient(id: string, data: Partial<IClient>): Promise<void> {\\r\\n    const ref = this.getDb().collection(COLL_CLIENTS).doc(id);\\r\\n    const updateData = { ...data };\\r\\n    delete (updateData as any).id;\\r\\n    delete (updateData as any).createdAt;\\r\\n    await ref.update(updateData);\\r\\n  }\\r\\n\\r\\n  async deleteClient(id: string): Promise<void> {\\r\\n    await this.getDb().collection(COLL_CLIENTS).doc(id).delete();\\r\\n  }\\r\\n\\r\\n  // ==========================================\\r\\n  // 2. GESTIN DE OBJETIVOS\\r\\n  // ==========================================\\r\\n\\r\\n  async createObjective(data: Omit<IObjective, \'id\'>): Promise<IObjective> {\\r\\n    await this.getClient(data.clientId); \\r\\n    const db = this.getDb();\\r\\n    const ref = db.collection(COLL_OBJECTIVES).doc();\\r\\n    const newObjective: IObjective = {\\r\\n      ...data,\\r\\n      id: ref.id,\\r\\n    };\\r\\n    await ref.set(newObjective);\\r\\n    return newObjective;\\r\\n  }\\r\\n\\r\\n  async getObjectivesByClient(clientId: string): Promise<IObjective[]> {\\r\\n    const snapshot = await this.getDb().collection(COLL_OBJECTIVES)\\r\\n      .where(\'clientId\', \'==\', clientId)\\r\\n      .get();\\r\\n    return snapshot.docs.map(d => ({ id: d.id, ...d.data() }) as IObjective);\\r\\n  }\\r\\n\\r\\n  //  NUEVO: Actualizar Objetivo\\r\\n  async updateObjective(id: string, data: Partial<IObjective>): Promise<void> {\\r\\n    const db = this.getDb();\\r\\n    const updateData = { ...data };\\r\\n    delete (updateData as any).id; \\r\\n    \\r\\n    // Asegurar tipos num茅ricos en location\\r\\n    if (updateData.location) {\\r\\n        updateData.location.latitude = Number(updateData.location.latitude);\\r\\n        updateData.location.longitude = Number(updateData.location.longitude);\\r\\n    }\\r\\n\\r\\n    await db.collection(COLL_OBJECTIVES).doc(id).update(updateData);\\r\\n  }\\r\\n\\r\\n  public async getClientById(clientId: string): Promise<IClient> {\\r\\n      return this.getClient(clientId);\\r\\n  }\\r\\n  \\r\\n  public async getObjectiveById(objectiveId: string): Promise<IObjective> {\\r\\n      const doc = await this.getDb().collection(COLL_OBJECTIVES).doc(objectiveId).get();\\r\\n      if (!doc.exists) {\\r\\n          throw new NotFoundException(`Objective with ID ${objectiveId} not found.`);\\r\\n      }\\r\\n      return { id: doc.id, ...doc.data() } as IObjective;\\r\\n  }\\r\\n\\r\\n  // ==========================================\\r\\n  // 3. GESTIN DE CONTRATOS (SERVICIOS)\\r\\n  // ==========================================\\r\\n\\r\\n  async createServiceContract(data: Omit<IServiceContract, \'id\'>): Promise<IServiceContract> {\\r\\n    const db = this.getDb();\\r\\n    const ref = db.collection(COLL_CONTRACTS).doc();\\r\\n    \\r\\n    let startDate: admin.firestore.Timestamp;\\r\\n    \\r\\n    if (data.startDate instanceof admin.firestore.Timestamp) {\\r\\n        startDate = data.startDate;\\r\\n    } else if ((data.startDate as any)._seconds) {\\r\\n        startDate = new admin.firestore.Timestamp((data.startDate as any)._seconds, (data.startDate as any)._nanoseconds);\\r\\n    } else {\\r\\n        startDate = admin.firestore.Timestamp.fromDate(new Date(data.startDate as any));\\r\\n    }\\r\\n\\r\\n    const newContract: IServiceContract = {\\r\\n      ...data,\\r\\n      id: ref.id,\\r\\n      startDate: startDate,\\r\\n    };\\r\\n    await ref.set(newContract);\\r\\n    return newContract;\\r\\n  }\\r\\n\\r\\n  //  NUEVO: Actualizar Contrato\\r\\n  async updateServiceContract(id: string, data: Partial<IServiceContract>): Promise<void> {\\r\\n    const db = this.getDb();\\r\\n    const updateData = { ...data };\\r\\n    delete (updateData as any).id; \\r\\n    await db.collection(COLL_CONTRACTS).doc(id).update(updateData);\\r\\n  }\\r\\n\\r\\n  //  NUEVO: Eliminar Contrato\\r\\n  async deleteServiceContract(id: string): Promise<void> {\\r\\n    const db = this.getDb();\\r\\n    await db.collection(COLL_CONTRACTS).doc(id).delete();\\r\\n  }\\r\\n\\r\\n  // ==========================================\\r\\n  // 4. GESTIN DE MODALIDADES (TIPOS DE TURNO)\\r\\n  // ==========================================\\r\\n\\r\\n  async createShiftType(data: Omit<IShiftType, \'id\'>): Promise<IShiftType> {\\r\\n    const db = this.getDb();\\r\\n    const ref = db.collection(COLL_SHIFT_TYPES).doc();\\r\\n\\r\\n    const newType: IShiftType = {\\r\\n      ...data,\\r\\n      id: ref.id,\\r\\n    };\\r\\n    await ref.set(newType);\\r\\n    return newType;\\r\\n  }\\r\\n\\r\\n  async getShiftTypesByContract(contractId: string): Promise<IShiftType[]> {\\r\\n    const snapshot = await this.getDb().collection(COLL_SHIFT_TYPES)\\r\\n      .where(\'contractId\', \'==\', contractId)\\r\\n      .get();\\r\\n    return snapshot.docs.map(d => ({ id: d.id, ...d.data() }) as IShiftType);\\r\\n  }\\r\\n\\r\\n  //  NUEVO: Actualizar Modalidad\\r\\n  async updateShiftType(id: string, data: Partial<IShiftType>): Promise<void> {\\r\\n    const db = this.getDb();\\r\\n    const updateData = { ...data };\\r\\n    delete (updateData as any).id; \\r\\n    await db.collection(COLL_SHIFT_TYPES).doc(id).update(updateData);\\r\\n  }\\r\\n\\r\\n  //  NUEVO: Eliminar Modalidad\\r\\n  async deleteShiftType(id: string): Promise<void> {\\r\\n    const db = this.getDb();\\r\\n    await db.collection(COLL_SHIFT_TYPES).doc(id).delete();\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"t7ks30thc","name":"data-management.module.ts","path":"apps\\\\functions\\\\src\\\\data-management\\\\data-management.module.ts","area":"BACKEND","content":"import { Module, forwardRef } from \'@nestjs/common\';\\r\\nimport { DataManagementService } from \'./data-management.service\';\\r\\nimport { ClientService } from \'./client.service\';\\r\\nimport { EmployeeService } from \'./employee.service\';\\r\\nimport { SystemUserService } from \'./system-user.service\';\\r\\nimport { AbsenceService } from \'./absence.service\';\\r\\nimport { LaborAgreementService } from \'./labor-agreement.service\'; //  NUEVO SERVICIO\\r\\n// Importamos el m贸dulo de agendamiento\\r\\nimport { SchedulingModule } from \'../scheduling/scheduling.module\';\\r\\n\\r\\n@Module({\\r\\n  imports: [\\r\\n    // Usamos forwardRef para romper el ciclo con Scheduling\\r\\n    forwardRef(() => SchedulingModule)\\r\\n  ],\\r\\n  providers: [\\r\\n    DataManagementService,\\r\\n    ClientService,\\r\\n    EmployeeService,\\r\\n    SystemUserService,\\r\\n    AbsenceService,\\r\\n    LaborAgreementService //  REGISTRADO\\r\\n  ],\\r\\n  exports: [\\r\\n    DataManagementService,\\r\\n    ClientService,\\r\\n    EmployeeService,\\r\\n    SystemUserService,\\r\\n    AbsenceService,\\r\\n    LaborAgreementService //  EXPORTADO\\r\\n  ],\\r\\n})\\r\\nexport class DataManagementModule {}\\n\\n\\n\\n"},{"id":"2mnc34gia","name":"data-management.service.ts","path":"apps\\\\functions\\\\src\\\\data-management\\\\data-management.service.ts","area":"BACKEND","content":"import { Injectable, NotFoundException } from \'@nestjs/common\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { IClient, IObjective } from \'../common/interfaces/client.interface\'; // RUTA RELATIVA FINAL\\r\\nimport { IShift } from \'../common/interfaces/shift.interface\'; // RUTA RELATIVA FINAL (Aunque IShift no se usa directamente aqu铆, la mantenemos si es necesario)\\r\\n\\r\\nconst CLIENTS_COLLECTION = \'clientes\';\\r\\nconst OBJECTIVES_COLLECTION = \'objetivos\';\\r\\n//  ELIMINADO: const db = admin.firestore(); // Eliminado para resolver el error \'app/no-app\'\\r\\n\\r\\n/**\\r\\n * @class DataManagementService\\r\\n * @description Servicio CRUD para las entidades Cliente y Objetivo (P1). \\r\\n */\\r\\n@Injectable()\\r\\nexport class DataManagementService {\\r\\n  \\r\\n  //  FIX: Getter para asegurar que Firestore solo se accede despu茅s de initializeApp()\\r\\n  private getDb = () => admin.app().firestore();\\r\\n\\r\\n  // --- CRUD para Objetivos (Sucursales/Puestos) ---\\r\\n\\r\\n  async createObjective(objectiveData: Omit<IObjective, \'id\'>): Promise<IObjective> {\\r\\n    const dbInstance = this.getDb();\\r\\n    const newRef = dbInstance.collection(OBJECTIVES_COLLECTION).doc();\\r\\n    const objective: IObjective = {\\r\\n      ...objectiveData,\\r\\n      id: newRef.id,\\r\\n    };\\r\\n    await newRef.set(objective);\\r\\n    return objective;\\r\\n  }\\r\\n\\r\\n  async findAllObjectives(clientId?: string): Promise<IObjective[]> {\\r\\n    const dbInstance = this.getDb();\\r\\n    let query: admin.firestore.Query = dbInstance.collection(OBJECTIVES_COLLECTION);\\r\\n    \\r\\n    if (clientId) {\\r\\n      query = query.where(\'clientId\', \'==\', clientId);\\r\\n    }\\r\\n\\r\\n    const snapshot = await query.get();\\r\\n    if (snapshot.empty) {\\r\\n        return [];\\r\\n    }\\r\\n\\r\\n    return snapshot.docs.map(doc => doc.data() as IObjective);\\r\\n  }\\r\\n  \\r\\n  // --- M茅todos de Lectura (Cr铆ticos para el Check-In) ---\\r\\n  \\r\\n  public async getClientById(clientId: string): Promise<IClient> {\\r\\n      const dbInstance = this.getDb();\\r\\n      const doc = await dbInstance.collection(CLIENTS_COLLECTION).doc(clientId).get();\\r\\n      if (!doc.exists) {\\r\\n          throw new NotFoundException(`Client with ID ${clientId} not found.`);\\r\\n      }\\r\\n      return doc.data() as IClient;\\r\\n  }\\r\\n  \\r\\n  public async getObjectiveById(objectiveId: string): Promise<IObjective> {\\r\\n      const dbInstance = this.getDb();\\r\\n      const doc = await dbInstance.collection(OBJECTIVES_COLLECTION).doc(objectiveId).get();\\r\\n      if (!doc.exists) {\\r\\n          throw new NotFoundException(`Objective with ID ${objectiveId} not found.`);\\r\\n      }\\r\\n      return doc.data() as IObjective;\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"i59myzj1y","name":"employee.service.ts","path":"apps\\\\functions\\\\src\\\\data-management\\\\employee.service.ts","area":"BACKEND","content":"import { Injectable, NotFoundException, InternalServerErrorException } from \'@nestjs/common\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { IEmployee } from \'../common/interfaces/employee.interface\';\\r\\nimport { WorkloadService } from \'../scheduling/workload.service\';\\r\\n\\r\\nconst COLL_EMPLOYEES = \'empleados\';\\r\\n\\r\\n@Injectable()\\r\\nexport class EmployeeService {\\r\\n\\r\\n  private getDb = () => admin.app().firestore();\\r\\n  private getAuth = () => admin.app().auth();\\r\\n\\r\\n  constructor(\\r\\n      private readonly workloadService: WorkloadService, \\r\\n  ) {}\\r\\n\\r\\n  async findAllEmployees(clientId?: string): Promise<IEmployee[]> {\\r\\n    try {\\r\\n      let query: admin.firestore.Query = this.getDb().collection(COLL_EMPLOYEES);\\r\\n      if (clientId) {\\r\\n        query = query.where(\'clientId\', \'==\', clientId);\\r\\n      }\\r\\n      const snapshot = await query.get();\\r\\n      return snapshot.docs.map(doc => doc.data() as IEmployee);\\r\\n    } catch (error) {\\r\\n      console.error(\'[GET_EMPLOYEES_ERROR]\', error);\\r\\n      throw new InternalServerErrorException(\'Error al obtener la lista de empleados.\');\\r\\n    }\\r\\n  }\\r\\n\\r\\n  async getEmployeeWorkload(uid: string, month: number, year: number): Promise<any> {\\r\\n    const report = await this.workloadService.getWorkloadReport(uid, month, year);\\r\\n    return report;\\r\\n  }\\r\\n\\r\\n  async updateEmployee(uid: string, data: Partial<IEmployee>): Promise<void> {\\r\\n      const db = this.getDb();\\r\\n      const auth = this.getAuth();\\r\\n      const ref = db.collection(COLL_EMPLOYEES).doc(uid);\\r\\n      const doc = await ref.get();\\r\\n      if (!doc.exists) {\\r\\n          throw new NotFoundException(\'Empleado no encontrado.\');\\r\\n      }\\r\\n\\r\\n      const updateData: any = { ...data };\\r\\n      if (updateData.payrollCycleStartDay !== undefined) updateData.payrollCycleStartDay = Number(updateData.payrollCycleStartDay);\\r\\n      if (updateData.payrollCycleEndDay !== undefined) updateData.payrollCycleEndDay = Number(updateData.payrollCycleEndDay);\\r\\n\\r\\n      delete updateData.uid;\\r\\n      delete updateData.email;\\r\\n      await ref.update(updateData);\\r\\n\\r\\n      if (data.role) {\\r\\n          try {\\r\\n              await auth.setCustomUserClaims(uid, { role: data.role });\\r\\n          } catch (e) {\\r\\n              console.error(`Error actualizando claims para ${uid}`, e);\\r\\n          }\\r\\n      }\\r\\n  }\\r\\n\\r\\n  async deleteEmployee(uid: string): Promise<void> {\\r\\n    try {\\r\\n        await this.getAuth().deleteUser(uid);\\r\\n        await this.getDb().collection(COLL_EMPLOYEES).doc(uid).delete();\\r\\n    } catch (error) {\\r\\n        console.error(\'[DELETE_EMPLOYEE_ERROR]\', error);\\r\\n        throw new InternalServerErrorException(\'Error al eliminar el empleado.\');\\r\\n    }\\r\\n  }\\r\\n\\r\\n  //  NUEVO: IMPORTACIN MASIVA\\r\\n  async importEmployees(rows: any[], adminUid: string): Promise<{ success: number, errors: any[] }> {\\r\\n      const db = this.getDb();\\r\\n      const auth = this.getAuth();\\r\\n      const errors = [];\\r\\n      let successCount = 0;\\r\\n\\r\\n      for (const row of rows) {\\r\\n          try {\\r\\n              if (!row.email || !row.dni || !row.name) {\\r\\n                  throw new Error(`Faltan datos (email, dni, nombre) para: ${row.name || \'Fila desconocida\'}`);\\r\\n              }\\r\\n\\r\\n              const email = row.email.trim().toLowerCase();\\r\\n              //  La contrase帽a inicial es el DNI\\r\\n              const password = row.dni.trim(); \\r\\n              \\r\\n              let uid = \'\';\\r\\n              \\r\\n              // 1. Crear o Recuperar Usuario en Auth\\r\\n              try {\\r\\n                  const userRecord = await auth.createUser({\\r\\n                      email,\\r\\n                      password,\\r\\n                      displayName: row.name,\\r\\n                      emailVerified: true\\r\\n                  });\\r\\n                  uid = userRecord.uid;\\r\\n              } catch (e: any) {\\r\\n                  if (e.code === \'auth/email-already-exists\') {\\r\\n                      const existingUser = await auth.getUserByEmail(email);\\r\\n                      uid = existingUser.uid;\\r\\n                  } else {\\r\\n                      throw e;\\r\\n                  }\\r\\n              }\\r\\n\\r\\n              // 2. Asignar Rol\\r\\n              await auth.setCustomUserClaims(uid, { role: \'employee\' });\\r\\n\\r\\n              // 3. Preparar Datos para Firestore\\r\\n              const employeeData: any = {\\r\\n                  uid,\\r\\n                  name: row.name,\\r\\n                  email: email,\\r\\n                  dni: row.dni,\\r\\n                  fileNumber: row.legajo || \'\',\\r\\n                  address: row.direccion || \'\',\\r\\n                  role: \'employee\',\\r\\n                  isAvailable: true,\\r\\n                  \\r\\n                  // Asignaci贸n de Reglas (con defaults)\\r\\n                  laborAgreement: row.convenio || \'SUVICO\',\\r\\n                  contractType: row.modalidad || \'FullTime\',\\r\\n                  maxHoursPerMonth: Number(row.horas_mensuales) || 176,\\r\\n                  \\r\\n                  // Ciclo de N贸mina\\r\\n                  payrollCycleStartDay: Number(row.inicio_ciclo) || 1,\\r\\n                  payrollCycleEndDay: 0, // 0 = fin de mes autom谩tico, o calcular si es necesario\\r\\n\\r\\n                  createdAt: admin.firestore.Timestamp.now(),\\r\\n                  importedBy: adminUid\\r\\n              };\\r\\n\\r\\n              // 4. Guardar Ficha (Merge para no borrar datos si ya exist铆a)\\r\\n              await db.collection(COLL_EMPLOYEES).doc(uid).set(employeeData, { merge: true });\\r\\n              successCount++;\\r\\n\\r\\n          } catch (error: any) {\\r\\n              console.error(`Error importando ${row.email}:`, error.message);\\r\\n              errors.push({ email: row.email, error: error.message });\\r\\n          }\\r\\n      }\\r\\n\\r\\n      return { success: successCount, errors };\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"xk981fzn2","name":"labor-agreement.service.ts","path":"apps\\\\functions\\\\src\\\\data-management\\\\labor-agreement.service.ts","area":"BACKEND","content":"import { Injectable } from \'@nestjs/common\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { ILaborAgreement } from \'../common/interfaces/labor-agreement.interface\';\\r\\nimport { LABOR_RULES } from \'../common/constants/labor-rules\'; //  Importamos las reglas base\\r\\n\\r\\nconst COLL_AGREEMENTS = \'convenios_colectivos\';\\r\\n\\r\\n@Injectable()\\r\\nexport class LaborAgreementService {\\r\\n    private getDb = () => admin.app().firestore();\\r\\n\\r\\n    async create(data: Partial<ILaborAgreement>): Promise<ILaborAgreement> {\\r\\n        const ref = this.getDb().collection(COLL_AGREEMENTS).doc();\\r\\n        const newItem: any = {\\r\\n            ...data,\\r\\n            id: ref.id,\\r\\n            createdAt: admin.firestore.Timestamp.now(),\\r\\n            isActive: true\\r\\n        };\\r\\n        await ref.set(newItem);\\r\\n        return newItem;\\r\\n    }\\r\\n\\r\\n    async findAll(): Promise<ILaborAgreement[]> {\\r\\n        const snap = await this.getDb().collection(COLL_AGREEMENTS).where(\'isActive\', \'==\', true).get();\\r\\n        return snap.docs.map(doc => doc.data() as ILaborAgreement);\\r\\n    }\\r\\n\\r\\n    async update(id: string, data: Partial<ILaborAgreement>): Promise<void> {\\r\\n        await this.getDb().collection(COLL_AGREEMENTS).doc(id).update(data);\\r\\n    }\\r\\n    \\r\\n    async delete(id: string): Promise<void> {\\r\\n        await this.getDb().collection(COLL_AGREEMENTS).doc(id).delete();\\r\\n    }\\r\\n\\r\\n    //  NUEVO: Migrar reglas de c贸digo a base de datos\\r\\n    async initializeDefaults(): Promise<string> {\\r\\n        const db = this.getDb();\\r\\n        const batch = db.batch();\\r\\n        const collectionRef = db.collection(COLL_AGREEMENTS);\\r\\n        let count = 0;\\r\\n\\r\\n        // Recorremos las reglas est谩ticas\\r\\n        for (const [code, rule] of Object.entries(LABOR_RULES)) {\\r\\n            // Verificamos si ya existe para no duplicar\\r\\n            const snapshot = await collectionRef.where(\'code\', \'==\', code).get();\\r\\n            \\r\\n            if (snapshot.empty) {\\r\\n                const newDoc = collectionRef.doc();\\r\\n                batch.set(newDoc, {\\r\\n                    id: newDoc.id,\\r\\n                    code: code,\\r\\n                    name: rule.name,\\r\\n                    maxHoursWeekly: rule.maxHoursWeekly || 48,\\r\\n                    maxHoursMonthly: rule.maxHoursMonthly,\\r\\n                    overtimeThresholdDaily: rule.overtimeThresholdDaily || 0,\\r\\n                    saturdayCutoffHour: rule.saturdayCutoffHour,\\r\\n                    nightShiftStart: rule.nightShiftStart,\\r\\n                    nightShiftEnd: rule.nightShiftEnd,\\r\\n                    isActive: true,\\r\\n                    createdAt: admin.firestore.Timestamp.now()\\r\\n                });\\r\\n                count++;\\r\\n            }\\r\\n        }\\r\\n\\r\\n        if (count > 0) {\\r\\n            await batch.commit();\\r\\n            return `Se importaron ${count} convenios correctamente.`;\\r\\n        } else {\\r\\n            return \'Los convenios ya estaban cargados.\';\\r\\n        }\\r\\n    }\\r\\n\\r\\n    async getAgreementByCode(code: string): Promise<ILaborAgreement | null> {\\r\\n        const snap = await this.getDb().collection(COLL_AGREEMENTS).where(\'code\', \'==\', code).limit(1).get();\\r\\n        if (snap.empty) return null;\\r\\n        return snap.docs[0].data() as ILaborAgreement;\\r\\n    }\\r\\n}\\n\\n\\n\\n"},{"id":"8nzw4a5pd","name":"system-audit.service.ts","path":"apps\\\\functions\\\\src\\\\data-management\\\\system-audit.service.ts","area":"BACKEND","content":"import { Injectable } from \'@nestjs/common\';\\nimport * as admin from \'firebase-admin\';\\n\\nexport type AuditModule = \'CLIENTS\' | \'EMPLOYEES\' | \'SYSTEM\' | \'SCHEDULING\' | \'ABSENCE\' | \'OVERTIME\';\\nexport type AuditAction = \'CREATE\' | \'UPDATE\' | \'DELETE\' | \'LOGIN\' | \'EXPORT\' | \'PUBLISH\' | \'APPROVE\' | \'REJECT\';\\n\\nexport interface ISystemLog {\\n  id: string; actorUid: string; actorName: string; action: AuditAction; module: AuditModule;\\n  details: string; metadata?: any; timestamp: admin.firestore.Timestamp; ip?: string;\\n}\\n\\n@Injectable()\\nexport class SystemAuditService {\\n  private getDb = () => admin.app().firestore();\\n  private readonly COLLECTION_NAME = \'system_audit_logs\';\\n\\n  async logAction(actorUid: string, actorName: string, action: AuditAction, module: AuditModule, details: string, metadata?: any): Promise<void> {\\n    try {\\n      const db = this.getDb();\\n      const ref = db.collection(this.COLLECTION_NAME).doc();\\n      const entry: ISystemLog = {\\n        id: ref.id, actorUid: actorUid || \'SYSTEM\', actorName: actorName || \'Sistema\', action, module, details, metadata: metadata || {}, timestamp: admin.firestore.Timestamp.now()\\n      };\\n      ref.set(entry).catch(err => console.error(\\"锔 Error audit log:\\", err));\\n    } catch (e) { console.error(\\" Error SystemAuditService:\\", e); }\\n  }\\n\\n  async getLogs(limit: number = 50, moduleFilter?: string): Promise<ISystemLog[]> {\\n    const db = this.getDb();\\n    let query = db.collection(this.COLLECTION_NAME).orderBy(\'timestamp\', \'desc\').limit(limit);\\n    if (moduleFilter && moduleFilter !== \'ALL\') query = query.where(\'module\', \'==\', moduleFilter);\\n    const snapshot = await query.get();\\n    return snapshot.docs.map(doc => ({ ...doc.data(), timestamp: doc.data().timestamp } as ISystemLog));\\n  }\\n\\n  async getSystemStats() {\\n    const db = this.getDb();\\n    const [clientsSnap, activeEmpsSnap, logsSnap] = await Promise.all([\\n        db.collection(\'clientes\').count().get(),\\n        db.collection(\'empleados\').where(\'isAvailable\', \'==\', true).count().get(),\\n        db.collection(this.COLLECTION_NAME).count().get()\\n    ]);\\n    return {\\n      totalClients: clientsSnap.data().count,\\n      activeEmployees: activeEmpsSnap.data().count,\\n      totalAuditLogs: logsSnap.data().count\\n    };\\n  }\\n}"},{"id":"u1i39nizu","name":"system-user.service.ts","path":"apps\\\\functions\\\\src\\\\data-management\\\\system-user.service.ts","area":"BACKEND","content":"import { Injectable, InternalServerErrorException, ConflictException, NotFoundException } from \'@nestjs/common\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { ISystemUser, SystemRole } from \'../common/interfaces/system-user.interface\';\\r\\n\\r\\nconst COLL_SYSTEM_USERS = \'system_users\';\\r\\n\\r\\n@Injectable()\\r\\nexport class SystemUserService {\\r\\n\\r\\n  // Inicializaci贸n diferida\\r\\n  private getAuth = () => admin.app().auth();\\r\\n  private getDb = () => admin.app().firestore();\\r\\n\\r\\n  /**\\r\\n   * Crea un nuevo usuario administrativo.\\r\\n   */\\r\\n  async createSystemUser(data: { email: string, password: string, displayName: string, role: SystemRole }): Promise<ISystemUser> {\\r\\n    const auth = this.getAuth();\\r\\n    const db = this.getDb();\\r\\n\\r\\n    // 1. Crear en Auth\\r\\n    const userRecord = await auth.createUser({\\r\\n      email: data.email,\\r\\n      password: data.password,\\r\\n      displayName: data.displayName,\\r\\n      emailVerified: true,\\r\\n    }).catch(error => {\\r\\n      if (error.code === \'auth/email-already-exists\') throw new ConflictException(\'El email ya est谩 registrado.\');\\r\\n      throw new InternalServerErrorException(\'Error al crear usuario en Auth.\');\\r\\n    });\\r\\n\\r\\n    // 2. Asignar Claims (Rol)\\r\\n    // Nota: Agregamos un claim \'type: admin\' para diferenciarlo de empleados\\r\\n    await auth.setCustomUserClaims(userRecord.uid, { role: data.role, type: \'system_user\' });\\r\\n\\r\\n    // 3. Crear Perfil en Firestore\\r\\n    const newUser: ISystemUser = {\\r\\n      uid: userRecord.uid,\\r\\n      email: data.email,\\r\\n      displayName: data.displayName,\\r\\n      role: data.role,\\r\\n      status: \'Active\',\\r\\n      createdAt: admin.firestore.Timestamp.now()\\r\\n    };\\r\\n\\r\\n    await db.collection(COLL_SYSTEM_USERS).doc(userRecord.uid).set(newUser);\\r\\n    \\r\\n    return newUser;\\r\\n  }\\r\\n\\r\\n  /**\\r\\n   * Obtener todos los administradores.\\r\\n   */\\r\\n  async findAll(): Promise<ISystemUser[]> {\\r\\n    const snapshot = await this.getDb().collection(COLL_SYSTEM_USERS).get();\\r\\n    return snapshot.docs.map(doc => doc.data() as ISystemUser);\\r\\n  }\\r\\n\\r\\n  /**\\r\\n   * Actualizar datos (Rol o Estado).\\r\\n   */\\r\\n  async updateSystemUser(uid: string, data: Partial<ISystemUser>): Promise<void> {\\r\\n    const auth = this.getAuth();\\r\\n    const db = this.getDb();\\r\\n\\r\\n    // Si cambia el rol, actualizar Auth\\r\\n    if (data.role) {\\r\\n        await auth.setCustomUserClaims(uid, { role: data.role, type: \'system_user\' });\\r\\n    }\\r\\n\\r\\n    // Si se desactiva, deshabilitar en Auth\\r\\n    if (data.status) {\\r\\n        await auth.updateUser(uid, { disabled: data.status === \'Inactive\' });\\r\\n    }\\r\\n\\r\\n    // Actualizar Firestore\\r\\n    const safeData = { ...data };\\r\\n    delete (safeData as any).uid;\\r\\n    delete (safeData as any).email; // No cambiamos email por aqu铆\\r\\n    \\r\\n    await db.collection(COLL_SYSTEM_USERS).doc(uid).update(safeData);\\r\\n  }\\r\\n\\r\\n  /**\\r\\n   * Eliminar administrador.\\r\\n   */\\r\\n  async deleteSystemUser(uid: string): Promise<void> {\\r\\n    await this.getAuth().deleteUser(uid);\\r\\n    await this.getDb().collection(COLL_SYSTEM_USERS).doc(uid).delete();\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"adzkzurky","name":"index.ts","path":"apps\\\\functions\\\\src\\\\index.ts","area":"BACKEND","content":"import * as functions from \'firebase-functions\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { createNestApp } from \'./main\';\\r\\nimport { INestApplicationContext } from \'@nestjs/common\';\\r\\n\\r\\n// Servicios expuestos por NestJS\\r\\nimport { SchedulingService } from \'./scheduling/scheduling.service\';\\r\\nimport { AuthService } from \'./auth/auth.service\';\\r\\nimport { DataManagementService } from \'./data-management/data-management.service\';\\r\\nimport { AuditService } from \'./scheduling/audit.service\';\\r\\nimport { ClientService } from \'./data-management/client.service\';\\r\\nimport { EmployeeService } from \'./data-management/employee.service\';\\r\\nimport { SystemUserService } from \'./data-management/system-user.service\';\\r\\nimport { AbsenceService } from \'./data-management/absence.service\';\\r\\nimport { PatternService } from \'./scheduling/pattern.service\';\\r\\nimport { LaborAgreementService } from \'./data-management/labor-agreement.service\';\\r\\n\\r\\n// Interfaces\\r\\nimport { EmployeeRole } from \'./common/interfaces/employee.interface\';\\r\\n\\r\\n// Inicializaci贸n de Firebase Admin\\r\\nif (!admin.apps.length) {\\r\\n  admin.initializeApp();\\r\\n}\\r\\n\\r\\nlet nestApp: INestApplicationContext;\\r\\n\\r\\nasync function getService<T>(service: new (...args: any[]) => T): Promise<T> {\\r\\n  if (!nestApp) {\\r\\n    nestApp = await createNestApp();\\r\\n  }\\r\\n  return nestApp.get<T>(service); \\r\\n}\\r\\n\\r\\n// Roles Administrativos\\r\\nconst ADMIN_ROLES = [\'admin\', \'SuperAdmin\', \'Scheduler\', \'HR_Manager\', \'Manager\', \'Operator\', \'Supervisor\'];\\r\\nconst ALLOWED_ROLES: EmployeeRole[] = [\'admin\', \'employee\'];\\r\\n\\r\\n\\r\\n// =========================================================\\r\\n// 1. GESTIN DE USUARIOS (AUTH)\\r\\n// =========================================================\\r\\nexport const createUser = functions.https.onCall(async (data, context) => {\\r\\n  const callerAuth = context.auth;\\r\\n  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {\\r\\n    throw new functions.https.HttpsError(\'permission-denied\', \'Acceso denegado. Rol insuficiente.\');\\r\\n  }\\r\\n\\r\\n  try {\\r\\n    const authService = await getService(AuthService);\\r\\n    const { email, password, name, role: receivedRole, clientId, dni, fileNumber, address } = data;\\r\\n    \\r\\n    if (!ALLOWED_ROLES.includes(receivedRole as EmployeeRole)) {\\r\\n       throw new functions.https.HttpsError(\'invalid-argument\', \'Rol inv谩lido.\');\\r\\n    }\\r\\n\\r\\n    const validRole = receivedRole as EmployeeRole;\\r\\n\\r\\n    const newEmployee = await authService.createEmployeeProfile(\\r\\n        email, \\r\\n        password, \\r\\n        validRole, \\r\\n        name,\\r\\n        { clientId: clientId || \'\', dni, fileNumber, address }\\r\\n    );\\r\\n    return { success: true, uid: newEmployee.uid };\\r\\n  } catch (error: any) {\\r\\n    const err = error as Error;\\r\\n    if (error instanceof functions.https.HttpsError) throw error;\\r\\n    console.error(\'[CREATE_USER_FATAL]\', err.message);\\r\\n    throw new functions.https.HttpsError(\'internal\', \'Error al crear usuario.\');\\r\\n  }\\r\\n});\\r\\n\\r\\n// =========================================================\\r\\n// 2. MOTOR DE AGENDAMIENTO (CREAR TURNOS INDIVIDUALES)\\r\\n// =========================================================\\r\\nexport const scheduleShift = functions.https.onCall(async (data, context) => {\\r\\n  const callerAuth = context.auth;\\r\\n  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {\\r\\n    throw new functions.https.HttpsError(\'permission-denied\', \'Acceso denegado. Rol insuficiente.\');\\r\\n  }\\r\\n\\r\\n  try {\\r\\n    const schedulingService = await getService(SchedulingService);\\r\\n    const result = await schedulingService.assignShift(data, callerAuth.token);\\r\\n    return { success: true, shiftId: result.id };\\r\\n  } catch (error: any) {\\r\\n    const err = error as Error;\\r\\n    if (error instanceof functions.https.HttpsError) throw error;\\r\\n    \\r\\n    console.error(\'[SCHEDULE_SHIFT_FATAL]\', err.message);\\r\\n    throw new functions.https.HttpsError(\'internal\', `Error: ${err.message}`);\\r\\n  }\\r\\n});\\r\\n\\r\\n// =========================================================\\r\\n// 3. GESTIN DE TURNOS (EDITAR / ELIMINAR / REPLICAR)\\r\\n// =========================================================\\r\\nexport const manageShifts = functions.https.onCall(async (data, context) => {\\r\\n  const callerAuth = context.auth;\\r\\n  const ALLOWED_PLANNING_ROLES = [\'admin\', \'SuperAdmin\', \'Manager\', \'Scheduler\'];\\r\\n\\r\\n  if (!callerAuth || !ALLOWED_PLANNING_ROLES.includes(callerAuth.token.role as string)) {\\r\\n    throw new functions.https.HttpsError(\'permission-denied\', \'Acceso denegado.\');\\r\\n  }\\r\\n\\r\\n  const { action, payload } = data as { action: string, payload: any };\\r\\n\\r\\n  try {\\r\\n    const schedulingService = await getService(SchedulingService);\\r\\n\\r\\n    switch (action) {\\r\\n      case \'UPDATE_SHIFT\':\\r\\n        await schedulingService.updateShift(payload.id, payload.data);\\r\\n        return { success: true, message: \'Turno actualizado.\' };\\r\\n      \\r\\n      case \'DELETE_SHIFT\':\\r\\n        await schedulingService.deleteShift(payload.id);\\r\\n        return { success: true, message: \'Turno eliminado.\' };\\r\\n      \\r\\n      case \'REPLICATE_STRUCTURE\':\\r\\n        if (!payload.objectiveId || !payload.sourceDate || !payload.targetStartDate || !payload.targetEndDate) {\\r\\n            throw new functions.https.HttpsError(\'invalid-argument\', \'Faltan fechas para replicar.\');\\r\\n        }\\r\\n        const result = await schedulingService.replicateDailyStructure(\\r\\n            payload.objectiveId,\\r\\n            payload.sourceDate,\\r\\n            payload.targetStartDate,\\r\\n            payload.targetEndDate,\\r\\n            callerAuth.uid\\r\\n        );\\r\\n        return { \\r\\n            success: true, \\r\\n            data: result, \\r\\n            message: `Replicado: ${result.created} turnos. (Omitidos: ${result.skipped} d铆as)` \\r\\n        };\\r\\n      default:\\r\\n        throw new functions.https.HttpsError(\'invalid-argument\', `Acci贸n desconocida: ${action}`);\\r\\n    }\\r\\n  } catch (error: any) {\\r\\n    const err = error as Error;\\r\\n    console.error(`[SHIFT_ERROR] Action ${action} failed:`, err.message);\\r\\n    if (error instanceof functions.https.HttpsError) throw error;\\r\\n    throw new functions.https.HttpsError(\'internal\', err.message);\\r\\n  }\\r\\n});\\r\\n\\r\\n// =========================================================\\r\\n// 4. AUDITORA (GEOFENCING & MANUAL OVERRIDE)\\r\\n// =========================================================\\r\\nexport const auditShift = functions.https.onCall(async (data, context) => {\\r\\n  if (!context.auth) throw new functions.https.HttpsError(\'unauthenticated\', \'Requiere autenticaci贸n.\');\\r\\n\\r\\n  const { shiftId, action, coords, isManualOverride } = data;\\r\\n\\r\\n  try {\\r\\n    const auditService = await getService(AuditService);\\r\\n    \\r\\n    const result = await auditService.auditShiftAction(\\r\\n        shiftId, \\r\\n        action, \\r\\n        coords || null, \\r\\n        context.auth.uid,\\r\\n        context.auth.token.role as string, \\r\\n        isManualOverride || false          \\r\\n    );\\r\\n    \\r\\n    return { success: true, newStatus: result.status };\\r\\n  } catch (error: any) {\\r\\n    const err = error as Error;\\r\\n    if (error instanceof functions.https.HttpsError) throw error;\\r\\n    console.error(\'[AUDIT_SHIFT_FATAL]\', err.message);\\r\\n    throw new functions.https.HttpsError(\'internal\', err.message);\\r\\n  }\\r\\n});\\r\\n\\r\\n// =========================================================\\r\\n// 5. GESTIN DE DATOS BSICOS\\r\\n// =========================================================\\r\\nexport const manageData = functions.https.onCall(async (data, context) => {\\r\\n  const callerAuth = context.auth;\\r\\n  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {\\r\\n    throw new functions.https.HttpsError(\'permission-denied\', \'Acceso denegado.\');\\r\\n  }\\r\\n\\r\\n  const { action, payload } = data;\\r\\n  try {\\r\\n    const dmService = await getService(DataManagementService);\\r\\n    switch (action) {\\r\\n      case \'CREATE_OBJECTIVE\': return { success: true, data: await dmService.createObjective(payload) };\\r\\n      case \'GET_ALL_OBJECTIVES\': return { success: true, data: await dmService.findAllObjectives(payload?.clientId) };\\r\\n      case \'GET_CLIENT_BY_ID\': return { success: true, data: await dmService.getClientById(payload.clientId) };\\r\\n      default: throw new functions.https.HttpsError(\'invalid-argument\', `Acci贸n desconocida: ${action}`);\\r\\n    }\\r\\n  } catch (error: any) {\\r\\n    const err = error as Error;\\r\\n    if (error instanceof functions.https.HttpsError) throw error;\\r\\n    console.error(\'[DATA_MANAGEMENT_FATAL]\', err.message);\\r\\n    throw new functions.https.HttpsError(\'internal\', err.message);\\r\\n  }\\r\\n});\\r\\n\\r\\n// =========================================================\\r\\n// 6. GESTIN DE JERARQUA COMERCIAL\\r\\n// =========================================================\\r\\nexport const manageHierarchy = functions.https.onCall(async (data, context) => {\\r\\n  const callerAuth = context.auth;\\r\\n  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {\\r\\n    throw new functions.https.HttpsError(\'permission-denied\', \'Acceso denegado.\');\\r\\n  }\\r\\n  \\r\\n  const { action, payload } = data as { action: string, payload: any };\\r\\n\\r\\n  try {\\r\\n    const clientService = await getService(ClientService);\\r\\n\\r\\n    switch (action) {\\r\\n      case \'CREATE_CLIENT\': return { success: true, data: await clientService.createClient(payload) };\\r\\n      case \'GET_CLIENT\': return { success: true, data: await clientService.getClient(payload.id) };\\r\\n      case \'GET_ALL_CLIENTS\': return { success: true, data: await clientService.findAllClients() };\\r\\n      case \'UPDATE_CLIENT\': await clientService.updateClient(payload.id, payload.data); return { success: true, message: \'Cliente actualizado\' };\\r\\n      case \'DELETE_CLIENT\': await clientService.deleteClient(payload.id); return { success: true, message: \'Cliente eliminado\' };\\r\\n\\r\\n      case \'CREATE_OBJECTIVE\': return { success: true, data: await clientService.createObjective(payload) };\\r\\n      case \'UPDATE_OBJECTIVE\': await clientService.updateObjective(payload.id, payload.data); return { success: true, message: \'Objetivo actualizado correctamente\' };\\r\\n      \\r\\n      case \'CREATE_CONTRACT\': return { success: true, data: await clientService.createServiceContract(payload) };\\r\\n      case \'UPDATE_CONTRACT\': await clientService.updateServiceContract(payload.id, payload.data); return { success: true, message: \'Servicio actualizado\' };\\r\\n      case \'DELETE_CONTRACT\': await clientService.deleteServiceContract(payload.id); return { success: true, message: \'Servicio eliminado\' };\\r\\n\\r\\n      case \'CREATE_SHIFT_TYPE\': return { success: true, data: await clientService.createShiftType(payload) };\\r\\n      case \'GET_SHIFT_TYPES\': return { success: true, data: await clientService.getShiftTypesByContract(payload.contractId) };\\r\\n      case \'UPDATE_SHIFT_TYPE\': await clientService.updateShiftType(payload.id, payload.data); return { success: true, message: \'Modalidad actualizada\' };\\r\\n      case \'DELETE_SHIFT_TYPE\': await clientService.deleteShiftType(payload.id); return { success: true, message: \'Modalidad eliminada\' };\\r\\n      \\r\\n      default: throw new functions.https.HttpsError(\'invalid-argument\', `Acci贸n desconocida: ${action}`);\\r\\n    }\\r\\n  } catch (error: any) {\\r\\n    const err = error as Error;\\r\\n    console.error(`[HIERARCHY_ERROR] Action ${action} failed:`, err.message);\\r\\n    if (error instanceof functions.https.HttpsError) throw error;\\r\\n    throw new functions.https.HttpsError(\'internal\', `Error: ${err.message}`);\\r\\n  }\\r\\n});\\r\\n\\r\\n// =========================================================\\r\\n// 7. GESTIN DE EMPLEADOS (RRHH) - (INCLUYE REPORTE DE CARGA Y IMPORTACIN)\\r\\n// =========================================================\\r\\nexport const manageEmployees = functions.https.onCall(async (data, context) => {\\r\\n  const callerAuth = context.auth;\\r\\n  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {\\r\\n    throw new functions.https.HttpsError(\'permission-denied\', \'Acceso denegado.\');\\r\\n  }\\r\\n  \\r\\n  const { action, payload } = data as { action: string, payload: any };\\r\\n  try {\\r\\n    const employeeService = await getService(EmployeeService);\\r\\n    switch (action) {\\r\\n      case \'GET_ALL_EMPLOYEES\':\\r\\n        const employees = await employeeService.findAllEmployees(payload?.clientId);\\r\\n        return { success: true, data: employees };\\r\\n        \\r\\n      case \'GET_WORKLOAD_REPORT\':\\r\\n        if (!payload.uid || !payload.month || !payload.year) {\\r\\n            throw new functions.https.HttpsError(\'invalid-argument\', \'Faltan par谩metros (uid, month, year) para el reporte.\');\\r\\n        }\\r\\n        const report = await employeeService.getEmployeeWorkload(payload.uid, payload.month, payload.year);\\r\\n        return { success: true, data: report };\\r\\n        \\r\\n      case \'UPDATE_EMPLOYEE\':\\r\\n        await employeeService.updateEmployee(payload.uid, payload.data);\\r\\n        return { success: true, message: \'Datos actualizados.\' };\\r\\n        \\r\\n      case \'DELETE_EMPLOYEE\':\\r\\n        await employeeService.deleteEmployee(payload.uid);\\r\\n        return { success: true, message: \'Empleado eliminado.\' };\\r\\n\\r\\n      //  NUEVO: IMPORTACIN MASIVA\\r\\n      case \'IMPORT_EMPLOYEES\':\\r\\n        if (!payload.rows || !Array.isArray(payload.rows)) {\\r\\n             throw new functions.https.HttpsError(\'invalid-argument\', \'Formato de archivo inv谩lido. Se espera un array \\"rows\\".\');\\r\\n        }\\r\\n        const importResult = await employeeService.importEmployees(payload.rows, callerAuth.uid);\\r\\n        return { success: true, data: importResult };\\r\\n        \\r\\n      default: throw new functions.https.HttpsError(\'invalid-argument\', `Acci贸n desconocida: ${action}`);\\r\\n    }\\r\\n  } catch (error: any) {\\r\\n    const err = error as Error;\\r\\n    console.error(`[EMPLOYEE_ERROR] Action ${action} failed:`, err.message);\\r\\n    if (error instanceof functions.https.HttpsError) throw error;\\r\\n    throw new functions.https.HttpsError(\'internal\', err.message);\\r\\n  }\\r\\n});\\r\\n\\r\\n// =========================================================\\r\\n// 8. GESTIN DE USUARIOS DEL SISTEMA (ADMINS)\\r\\n// =========================================================\\r\\nexport const manageSystemUsers = functions.https.onCall(async (data, context) => {\\r\\n  const callerAuth = context.auth;\\r\\n  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {\\r\\n    throw new functions.https.HttpsError(\'permission-denied\', \'Acceso denegado.\');\\r\\n  }\\r\\n  \\r\\n  const { action, payload } = data as { action: string, payload: any };\\r\\n\\r\\n  try {\\r\\n    const sysUserService = await getService(SystemUserService);\\r\\n\\r\\n    switch (action) {\\r\\n      case \'CREATE_USER\':\\r\\n         await sysUserService.createSystemUser(payload);\\r\\n        return { success: true, message: \'Administrador creado exitosamente.\' };\\r\\n      case \'GET_ALL_USERS\':\\r\\n        const users = await sysUserService.findAll();\\r\\n        return { success: true, data: users };\\r\\n      case \'UPDATE_USER\':\\r\\n        await sysUserService.updateSystemUser(payload.uid, payload.data);\\r\\n        return { success: true, message: \'Administrador actualizado.\' };\\r\\n      case \'DELETE_USER\':\\r\\n        await sysUserService.deleteSystemUser(payload.uid);\\r\\n        return { success: true, message: \'Administrador eliminado.\' };\\r\\n      default:\\r\\n        throw new functions.https.HttpsError(\'invalid-argument\', `Acci贸n desconocida: ${action}`);\\r\\n    }\\r\\n  } catch (error: any) {\\r\\n    const err = error as Error;\\r\\n    console.error(`[SYS_USER_ERROR] ${action} failed:`, err.message);\\r\\n    if (error instanceof functions.https.HttpsError) throw error;\\r\\n    throw new functions.https.HttpsError(\'internal\', err.message);\\r\\n  }\\r\\n});\\r\\n\\r\\n// =========================================================\\r\\n// 9. GESTIN DE NOVEDADES (AUSENCIAS)\\r\\n// =========================================================\\r\\nexport const manageAbsences = functions.https.onCall(async (data, context) => {\\r\\n  const callerAuth = context.auth;\\r\\n  if (!callerAuth) {\\r\\n    throw new functions.https.HttpsError(\'unauthenticated\', \'Requiere autenticaci贸n.\');\\r\\n  }\\r\\n\\r\\n  const { action, payload } = data as { action: string, payload: any };\\r\\n\\r\\n  const isAdmin = ADMIN_ROLES.includes(callerAuth.token.role as string);\\r\\n  const isSelf = payload.employeeId === callerAuth.uid;\\r\\n\\r\\n  if (!isAdmin && !(isSelf && action === \'CREATE_ABSENCE\')) {\\r\\n      throw new functions.https.HttpsError(\'permission-denied\', \'Acceso denegado.\');\\r\\n  }\\r\\n\\r\\n  try {\\r\\n    const absenceService = await getService(AbsenceService);\\r\\n\\r\\n    switch (action) {\\r\\n      case \'CREATE_ABSENCE\':\\r\\n        return { success: true, data: await absenceService.createAbsence(payload) };\\r\\n      default:\\r\\n        throw new functions.https.HttpsError(\'invalid-argument\', `Acci贸n desconocida: ${action}`);\\r\\n    }\\r\\n  } catch (error: any) {\\r\\n    const err = error as Error;\\r\\n    console.error(`[ABSENCE_ERROR] Action ${action} failed:`, err.message);\\r\\n    if (error instanceof functions.https.HttpsError) throw error;\\r\\n    if (err.message.includes(\'Conflict\')) {\\r\\n        throw new functions.https.HttpsError(\'failed-precondition\', err.message);\\r\\n    }\\r\\n    throw new functions.https.HttpsError(\'internal\', err.message);\\r\\n  }\\r\\n});\\r\\n\\r\\n// =========================================================\\r\\n// 10. GESTIN DE PATRONES DE SERVICIO (AUTOMATIZACIN)\\r\\n// =========================================================\\r\\nexport const managePatterns = functions.https.onCall(async (data, context) => {\\r\\n  const callerAuth = context.auth;\\r\\n  if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {\\r\\n      throw new functions.https.HttpsError(\'permission-denied\', \'Acceso denegado.\');\\r\\n  }\\r\\n\\r\\n  const { action, payload } = data as { action: string, payload: any };\\r\\n\\r\\n  try {\\r\\n    const patternService = await getService(PatternService);\\r\\n\\r\\n    switch(action) {\\r\\n        case \'CREATE_PATTERN\': \\r\\n            return patternService.createPattern(payload, callerAuth.uid);\\r\\n        \\r\\n        case \'GET_PATTERNS\': \\r\\n            return patternService.getPatternsByContract(payload.contractId);\\r\\n        \\r\\n        case \'DELETE_PATTERN\': \\r\\n            await patternService.deletePattern(payload.id); \\r\\n            return { success: true };\\r\\n        case \'GENERATE_VACANCIES\': \\r\\n            return patternService.generateVacancies(\\r\\n                payload.contractId, \\r\\n                payload.month, \\r\\n                payload.year, \\r\\n                payload.objectiveId \\r\\n            );\\r\\n        case \'CLEAR_VACANCIES\':\\r\\n            return patternService.clearVacancies(\\r\\n                payload.objectiveId,\\r\\n                payload.month,\\r\\n                payload.year\\r\\n            );\\r\\n        default: throw new functions.https.HttpsError(\'invalid-argument\', \'Acci贸n inv谩lida\');\\r\\n    }\\r\\n  } catch (error: any) {\\r\\n      console.error(`[PATTERN_ERROR] Action ${action} failed:`, error.message);\\r\\n      throw new functions.https.HttpsError(\'internal\', error.message);\\r\\n  }\\r\\n});\\r\\n\\r\\n// =========================================================\\r\\n// 11. GESTIN DE CONVENIOS (NUEVO)\\r\\n// =========================================================\\r\\nexport const manageAgreements = functions.https.onCall(async (data, context) => {\\r\\n    const callerAuth = context.auth;\\r\\n    if (!callerAuth || !ADMIN_ROLES.includes(callerAuth.token.role as string)) {\\r\\n        throw new functions.https.HttpsError(\'permission-denied\', \'Acceso denegado.\');\\r\\n    }\\r\\n    \\r\\n    const { action, payload } = data as { action: string, payload: any };\\r\\n  \\r\\n    try {\\r\\n        const agreementService = await getService(LaborAgreementService);\\r\\n  \\r\\n        switch (action) {\\r\\n            case \'CREATE\': return { success: true, data: await agreementService.create(payload) };\\r\\n            case \'GET_ALL\': return { success: true, data: await agreementService.findAll() };\\r\\n            case \'UPDATE\': await agreementService.update(payload.id, payload.data); return { success: true };\\r\\n            case \'DELETE\': await agreementService.delete(payload.id); return { success: true };\\r\\n            // CARGA DE DATOS POR DEFECTO\\r\\n            case \'INITIALIZE_DEFAULTS\': \\r\\n                const msg = await agreementService.initializeDefaults();\\r\\n                return { success: true, message: msg };\\r\\n                \\r\\n            default: throw new functions.https.HttpsError(\'invalid-argument\', `Acci贸n desconocida: ${action}`);\\r\\n        }\\r\\n    } catch (error: any) {\\r\\n        console.error(`[AGREEMENT_ERROR] Action ${action} failed:`, error.message);\\r\\n        throw new functions.https.HttpsError(\'internal\', error.message);\\r\\n    }\\r\\n});\\r\\n\\r\\n// =========================================================\\r\\n// 12. DIAGNSTICO DE SISTEMA (HEALTH CHECK)\\r\\n// =========================================================\\r\\nexport const checkSystemHealth = functions.https.onCall(async (data, context) => {\\r\\n  if (!context.auth) {\\r\\n      throw new functions.https.HttpsError(\'unauthenticated\', \'Requiere autenticaci贸n.\');\\r\\n  }\\r\\n\\r\\n  const start = Date.now();\\r\\n  try {\\r\\n    await admin.firestore().listCollections();\\r\\n    const end = Date.now();\\r\\n\\r\\n    return {\\r\\n      status: \'ok\',\\r\\n      nodeVersion: process.version,\\r\\n      database: {\\r\\n        status: \'connected\',\\r\\n        latencyMs: end - start\\r\\n      }\\r\\n    };\\r\\n  } catch (error: any) {\\r\\n    console.error(\'[HEALTH_CHECK_ERROR]\', error);\\r\\n    return {\\r\\n      status: \'error\',\\r\\n      nodeVersion: process.version,\\r\\n      database: {\\r\\n        status: \'disconnected\',\\r\\n        latencyMs: -1,\\r\\n        error: error.message\\r\\n      }\\r\\n    };\\r\\n  }\\r\\n});\\n\\n\\n\\n\\n\\n// --- FUNCIONES DE SISTEMA INYECTADAS POR SCRIPT ---\\n\\n// 1. Crear Usuario de SISTEMA (Admin, RRHH, etc)\\nexport const crearUsuarioSistema = functions.https.onCall(async (data, context) => {\\n  if (!context.auth) throw new functions.https.HttpsError(\\"unauthenticated\\", \\"Sin permisos.\\");\\n  \\n  const { email, password, firstName, lastName, role } = data;\\n\\n  try {\\n    const userRecord = await admin.auth().createUser({\\n      email,\\n      password,\\n      displayName: `${firstName} ${lastName}`\\n    });\\n\\n    await admin.auth().setCustomUserClaims(userRecord.uid, { role, type: \'SYSTEM\' });\\n\\n    await admin.firestore().collection(\\"system_users\\").doc(userRecord.uid).set({\\n      uid: userRecord.uid,\\n      firstName,\\n      lastName,\\n      email,\\n      role,\\n      status: \'ACTIVE\',\\n      createdAt: admin.firestore.FieldValue.serverTimestamp()\\n    });\\n\\n    return { success: true };\\n  } catch (error: any) {\\n    throw new functions.https.HttpsError(\\"internal\\", error.message);\\n  }\\n});\\n\\n// 2. Limpieza Masiva (Zona de Peligro)\\nexport const limpiarBaseDeDatos = functions.runWith({ timeoutSeconds: 540 }).https.onCall(async (data, context) => {\\n    if (!context.auth) throw new functions.https.HttpsError(\\"unauthenticated\\", \\"Rechazado.\\");\\n    \\n    const { target } = data; \\n    const db = admin.firestore();\\n    let path = \\"\\";\\n\\n    if (target === \'AUDIT\') path = \'historial_operaciones\';\\n    else if (target === \'SHIFTS\') path = \'turnos\';\\n    else throw new functions.https.HttpsError(\\"invalid-argument\\", \\"Target inv谩lido\\");\\n\\n    await db.recursiveDelete(db.collection(path));\\n    return { success: true };\\n});\\n\\n\\n// --- OPERATIVA: FICHADAS MANUALES Y RRHH ---\\n\\n// 1. Fichada Manual (Operador de Radio / Supervisor)\\nexport const registrarFichadaManual = functions.https.onCall(async (data, context) => {\\n    if (!context.auth) throw new functions.https.HttpsError(\\"unauthenticated\\", \\"Sin permisos.\\");\\n    \\n    // data: { shiftId, notes, method: \'RADIO\' | \'PHONE\' }\\n    const { shiftId, notes, method } = data;\\n    const db = admin.firestore();\\n\\n    try {\\n        const shiftRef = db.collection(\'turnos\').doc(shiftId);\\n        const shiftDoc = await shiftRef.get();\\n\\n        if (!shiftDoc.exists) throw new Error(\\"Turno no encontrado\\");\\n\\n        // Actualizamos el turno a estado \\"PRESENT\\"\\n        await shiftRef.update({\\n            status: \'PRESENT\',\\n            checkInTime: admin.firestore.FieldValue.serverTimestamp(),\\n            checkInMethod: method || \'MANUAL\', // \'RADIO\', \'PHONE\', \'WHATSAPP\'\\n            checkInOperator: context.auth.uid, // Qui茅n valid贸 la fichada\\n            operatorNotes: notes || \'\'\\n        });\\n\\n        // Log de auditor铆a (opcional)\\n        await db.collection(\'audit_logs\').add({\\n            action: \'MANUAL_CHECKIN\',\\n            shiftId,\\n            operator: context.auth.uid,\\n            timestamp: admin.firestore.FieldValue.serverTimestamp()\\n        });\\n\\n        return { success: true };\\n    } catch (error: any) {\\n        throw new functions.https.HttpsError(\\"internal\\", error.message);\\n    }\\n});\\n\\n// 2. Reporte de Ausencia (RRHH / Operador)\\nexport const reportarAusencia = functions.https.onCall(async (data, context) => {\\n    if (!context.auth) throw new functions.https.HttpsError(\\"unauthenticated\\", \\"Sin permisos.\\");\\n\\n    // data: { shiftId, reason, type: \'SICK\' | \'NO_SHOW\' | \'LATE\' }\\n    const { shiftId, reason, type } = data;\\n    const db = admin.firestore();\\n\\n    try {\\n        const shiftRef = db.collection(\'turnos\').doc(shiftId);\\n        \\n        await shiftRef.update({\\n            status: \'ABSENT\',\\n            absenceType: type || \'NO_SHOW\', // Enfermedad, Faltazo, etc.\\n            absenceReason: reason || \'\',\\n            absenceReportedBy: context.auth.uid,\\n            absenceReportedAt: admin.firestore.FieldValue.serverTimestamp()\\n        });\\n\\n        return { success: true };\\n    } catch (error: any) {\\n        throw new functions.https.HttpsError(\\"internal\\", error.message);\\n    }\\n});\\n"},{"id":"n3ght5r94","name":"main.ts","path":"apps\\\\functions\\\\src\\\\main.ts","area":"BACKEND","content":"import { NestFactory } from \'@nestjs/core\';\\r\\nimport { AppModule } from \'./app.module\';\\r\\nimport { INestApplicationContext } from \'@nestjs/common\';\\r\\n\\r\\n/**\\r\\n * @async\\r\\n * @function createNestApp\\r\\n * @description Inicializa la aplicaci贸n NestJS y retorna el M贸dulo de Referencia.\\r\\n * @returns {Promise<INestApplicationContext>} El contexto de aplicaci贸n.\\r\\n */\\r\\nexport async function createNestApp(): Promise<INestApplicationContext> {\\r\\n  // Usamos createApplicationContext para obtener el contexto de DI sin listener HTTP\\r\\n  const app = await NestFactory.createApplicationContext(AppModule, { logger: false });\\r\\n  \\r\\n  await app.init();\\r\\n  return app;\\r\\n}\\n\\n\\n\\n"},{"id":"l2kd3zpyx","name":"audit.service.ts","path":"apps\\\\functions\\\\src\\\\scheduling\\\\audit.service.ts","area":"BACKEND","content":"import { Injectable, BadRequestException, ForbiddenException } from \'@nestjs/common\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { GeofencingService } from \'./geofencing.service\';\\r\\nimport { DataManagementService } from \'../data-management/data-management.service\'; \\r\\nimport { IShift } from \'../common/interfaces/shift.interface\';\\r\\nimport * as functions from \'firebase-functions\';\\r\\nimport { IObjective } from \'../common/interfaces/client.interface\'; \\r\\n\\r\\nconst SHIFTS_COLLECTION = \'turnos\';\\r\\n\\r\\n@Injectable()\\r\\nexport class AuditService {\\r\\n  \\r\\n  constructor(\\r\\n    private readonly geofencingService: GeofencingService,\\r\\n    private readonly dmService: DataManagementService,\\r\\n  ) {}\\r\\n\\r\\n  private getDb = () => admin.app().firestore();\\r\\n\\r\\n  /**\\r\\n   * Procesa el fichaje (Check-in/out) validando reglas de negocio, GPS y permisos.\\r\\n   * Soporta modo \\"Manual Override\\" para operadores.\\r\\n   */\\r\\n  async auditShiftAction(\\r\\n    shiftId: string,\\r\\n    action: \'CHECK_IN\' | \'CHECK_OUT\',\\r\\n    employeeCoords: { latitude: number, longitude: number } | null, // Puede ser null en manual\\r\\n    actorUid: string,\\r\\n    actorRole: string,          //  NUEVO: Rol de quien ejecuta\\r\\n    isManualOverride: boolean   //  NUEVO: Bandera de fuerza mayor\\r\\n  ): Promise<IShift> {\\r\\n    \\r\\n    const dbInstance = this.getDb();\\r\\n    const shiftRef = dbInstance.collection(SHIFTS_COLLECTION).doc(shiftId);\\r\\n\\r\\n    return dbInstance.runTransaction(async (transaction) => {\\r\\n      const shiftDoc = await transaction.get(shiftRef);\\r\\n\\r\\n      if (!shiftDoc.exists) {\\r\\n        throw new BadRequestException(\'El turno no existe.\');\\r\\n      }\\r\\n\\r\\n      const shift = shiftDoc.data() as IShift;\\r\\n      \\r\\n      // --- VALIDACIN DE PERMISOS ---\\r\\n      const isOwner = shift.employeeId === actorUid;\\r\\n      const isAdminOrOperator = [\'admin\', \'SuperAdmin\', \'Manager\', \'Operator\', \'Scheduler\', \'Supervisor\'].includes(actorRole);\\r\\n\\r\\n      // Si no es el due帽o y no es admin, fuera.\\r\\n      if (!isOwner && !isAdminOrOperator) {\\r\\n        throw new ForbiddenException(\'No tienes permiso para gestionar este turno.\');\\r\\n      }\\r\\n      \\r\\n      // --- REGLAS DE NEGOCIO ---\\r\\n      const now = admin.firestore.Timestamp.now();\\r\\n\\r\\n      if (!isManualOverride) {\\r\\n          // MODO ESTNDAR (Empleado con Celular)\\r\\n          \\r\\n          // 1. Identidad: Solo el asignado puede fichar normal\\r\\n          if (!isOwner) throw new ForbiddenException(\'Solo el empleado asignado puede fichar desde la app.\');\\r\\n          \\r\\n          // 2. Tiempo (Anti-Anticipaci贸n)\\r\\n          if (action === \'CHECK_IN\') {\\r\\n              const shiftStartMillis = shift.startTime.toMillis();\\r\\n              const diffMinutes = (shiftStartMillis - now.toMillis()) / (1000 * 60);\\r\\n              const TOLERANCE = 10; // minutos\\r\\n\\r\\n              if (diffMinutes > TOLERANCE) {\\r\\n                  throw new functions.https.HttpsError(\\r\\n                      \'failed-precondition\', \\r\\n                      ` Muy temprano. Fichaje habilitado ${TOLERANCE} min antes.`\\r\\n                  );\\r\\n              }\\r\\n          }\\r\\n\\r\\n          // 3. Ubicaci贸n (Geofence)\\r\\n          const objective = await this.dmService.getObjectiveById(shift.objectiveId) as IObjective; \\r\\n          \\r\\n          // Validamos que vengan coordenadas\\r\\n          if (!employeeCoords || !employeeCoords.latitude) {\\r\\n               throw new functions.https.HttpsError(\'invalid-argument\', \'Se requiere ubicaci贸n GPS.\');\\r\\n          }\\r\\n\\r\\n          if (!this.geofencingService.isInGeofence(employeeCoords, objective.location)) {\\r\\n            console.warn(`[GEOFENCE_FAIL] User ${actorUid} far from objective.`);\\r\\n            throw new functions.https.HttpsError(\\r\\n                \'failed-precondition\', \\r\\n                \' Est谩s demasiado lejos del objetivo. Ac茅rcate a la sede.\'\\r\\n            );\\r\\n          }\\r\\n\\r\\n      } else {\\r\\n          // MODO MANUAL (Operador desde Torre de Control)\\r\\n          \\r\\n          // 1. Permisos: Solo admins\\r\\n          if (!isAdminOrOperator) {\\r\\n              throw new ForbiddenException(\'Solo supervisores pueden forzar el fichaje manual.\');\\r\\n          }\\r\\n          \\r\\n          console.log(`[MANUAL_OVERRIDE] Turno ${shiftId} forzado por ${actorUid} (${actorRole})`);\\r\\n      }\\r\\n      \\r\\n      // --- TRANSICIN DE ESTADO ---\\r\\n      let newStatus: IShift[\'status\'];\\r\\n\\r\\n      if (action === \'CHECK_IN\') {\\r\\n        // Permitimos re-fichar si estaba en Assigned, o corregir si hubo error\\r\\n        if (shift.status !== \'Assigned\' && !isManualOverride) {\\r\\n            throw new BadRequestException(`Estado incorrecto para entrada: ${shift.status}`);\\r\\n        }\\r\\n        newStatus = \'InProgress\';\\r\\n        shift.checkInTime = now;\\r\\n\\r\\n      } else if (action === \'CHECK_OUT\') {\\r\\n        if (shift.status !== \'InProgress\' && !isManualOverride) {\\r\\n            throw new BadRequestException(`El turno no est谩 en curso (Estado: ${shift.status})`);\\r\\n        }\\r\\n        newStatus = \'Completed\';\\r\\n        shift.checkOutTime = now;\\r\\n\\r\\n      } else {\\r\\n        throw new BadRequestException(`Acci贸n inv谩lida: ${action}`);\\r\\n      }\\r\\n      \\r\\n      // --- ACTUALIZACIN ---\\r\\n      const updateData: any = {\\r\\n          status: newStatus,\\r\\n          updatedAt: now,\\r\\n          checkInTime: shift.checkInTime,\\r\\n          checkOutTime: shift.checkOutTime\\r\\n      };\\r\\n\\r\\n      // Si fue manual, dejamos marca de auditor铆a\\r\\n      if (isManualOverride) {\\r\\n          updateData.isManualRecord = true;\\r\\n          updateData.processedBy = actorUid; // Guardamos qui茅n lo forz贸\\r\\n          updateData.manualReason = \'Operador Torre de Control\';\\r\\n      }\\r\\n\\r\\n      transaction.update(shiftRef, updateData);\\r\\n\\r\\n      return { ...shift, ...updateData };\\r\\n    });\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"4l0nfb3ui","name":"geofencing.service.ts","path":"apps\\\\functions\\\\src\\\\scheduling\\\\geofencing.service.ts","area":"BACKEND","content":"import { Injectable } from \'@nestjs/common\';\\r\\n\\r\\n// Radio de la Tierra en kil贸metros (km)\\r\\nconst EARTH_RADIUS_KM = 6371;\\r\\n\\r\\n// Radio de tolerancia: El empleado debe estar a menos de 100 metros del objetivo.\\r\\nconst GEOFENCE_RADIUS_KM = 0.1; // 100 metros\\r\\n\\r\\ninterface Coordinates {\\r\\n  latitude: number;\\r\\n  longitude: number;\\r\\n}\\r\\n\\r\\n/**\\r\\n * @class GeofencingService\\r\\n * @description L贸gica pura para el c谩lculo de distancia y verificaci贸n de Geofence (SRP/D5).\\r\\n */\\r\\n@Injectable()\\r\\nexport class GeofencingService {\\r\\n\\r\\n  /**\\r\\n   * @function degreesToRadians\\r\\n   * @description Convierte grados decimales a radianes.\\r\\n   */\\r\\n  private degreesToRadians(degrees: number): number {\\r\\n    return degrees * (Math.PI / 180);\\r\\n  }\\r\\n\\r\\n  /**\\r\\n   * @function calculateDistance\\r\\n   * @description Calcula la distancia entre dos pares de coordenadas (F贸rmula del Haversine).\\r\\n   * @returns {number} Distancia en kil贸metros.\\r\\n   */\\r\\n  public calculateDistance(p1: Coordinates, p2: Coordinates): number {\\r\\n    const lat1 = this.degreesToRadians(p1.latitude);\\r\\n    const lon1 = this.degreesToRadians(p1.longitude);\\r\\n    const lat2 = this.degreesToRadians(p2.latitude);\\r\\n    const lon2 = this.degreesToRadians(p2.longitude);\\r\\n\\r\\n    const dLat = lat2 - lat1;\\r\\n    const dLon = lon2 - lon1;\\r\\n\\r\\n    // F贸rmula Haversine\\r\\n    const a = \\r\\n      Math.sin(dLat / 2) * Math.sin(dLat / 2) +\\r\\n      Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) * Math.sin(dLon / 2);\\r\\n\\r\\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\\r\\n\\r\\n    return EARTH_RADIUS_KM * c; // Distancia en KM\\r\\n  }\\r\\n\\r\\n  /**\\r\\n   * @function isInGeofence\\r\\n   * @description Verifica si el punto del empleado est谩 dentro del radio del objetivo.\\r\\n   * @param {Coordinates} employeeCoords - Coordenadas reportadas por el empleado.\\r\\n   * @param {Coordinates} objectiveCoords - Coordenadas registradas del objetivo.\\r\\n   * @returns {boolean} True si la distancia es menor al radio de tolerancia.\\r\\n   */\\r\\n  public isInGeofence(employeeCoords: Coordinates, objectiveCoords: Coordinates): boolean {\\r\\n    const distance = this.calculateDistance(employeeCoords, objectiveCoords);\\r\\n    return distance <= GEOFENCE_RADIUS_KM;\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"ggmqtev8e","name":"pattern.service.ts","path":"apps\\\\functions\\\\src\\\\scheduling\\\\pattern.service.ts","area":"BACKEND","content":"import { Injectable } from \'@nestjs/common\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { IServicePattern, IPatternPayload } from \'../common/interfaces/service-pattern.interface\';\\r\\nimport { IShiftType } from \'../common/interfaces/client.interface\';\\r\\n\\r\\nconst PATTERNS_COLLECTION = \'patrones_servicio\';\\r\\nconst SHIFTS_COLLECTION = \'turnos\';\\r\\nconst SHIFT_TYPES_COLLECTION = \'tipos_turno\';\\r\\n\\r\\n@Injectable()\\r\\nexport class PatternService {\\r\\n  \\r\\n  private getDb = () => admin.app().firestore();\\r\\n\\r\\n  // --- 1. GESTIN DE REGLAS ---\\r\\n\\r\\n  async createPattern(payload: IPatternPayload, userId: string): Promise<IServicePattern> {\\r\\n    const db = this.getDb();\\r\\n    \\r\\n    const existingSnap = await db.collection(PATTERNS_COLLECTION)\\r\\n        .where(\'contractId\', \'==\', payload.contractId)\\r\\n        .where(\'shiftTypeId\', \'==\', payload.shiftTypeId)\\r\\n        .where(\'active\', \'==\', true)\\r\\n        .limit(1)\\r\\n        .get();\\r\\n\\r\\n    const validFrom = admin.firestore.Timestamp.fromDate(new Date(payload.validFrom));\\r\\n    const validTo = payload.validTo ? admin.firestore.Timestamp.fromDate(new Date(payload.validTo)) : null;\\r\\n\\r\\n    const patternData = {\\r\\n        contractId: payload.contractId,\\r\\n        shiftTypeId: payload.shiftTypeId,\\r\\n        daysOfWeek: payload.daysOfWeek,\\r\\n        quantityPerDay: payload.quantity,\\r\\n        validFrom,\\r\\n        validTo,\\r\\n        active: true,\\r\\n        updatedAt: admin.firestore.Timestamp.now(),\\r\\n        updatedBy: userId\\r\\n    };\\r\\n\\r\\n    if (!existingSnap.empty) {\\r\\n        const docId = existingSnap.docs[0].id;\\r\\n        await db.collection(PATTERNS_COLLECTION).doc(docId).update(patternData);\\r\\n        return { id: docId, ...patternData } as unknown as IServicePattern;\\r\\n    } else {\\r\\n        const ref = db.collection(PATTERNS_COLLECTION).doc();\\r\\n        const newPattern = {\\r\\n            ...patternData,\\r\\n            id: ref.id,\\r\\n            createdAt: admin.firestore.Timestamp.now(),\\r\\n            createdBy: userId\\r\\n        };\\r\\n        await ref.set(newPattern);\\r\\n        return newPattern as any;\\r\\n    }\\r\\n  }\\r\\n\\r\\n  async getPatternsByContract(contractId: string): Promise<IServicePattern[]> {\\r\\n      const snapshot = await this.getDb().collection(PATTERNS_COLLECTION)\\r\\n        .where(\'contractId\', \'==\', contractId)\\r\\n        .where(\'active\', \'==\', true)\\r\\n        .get();\\r\\n      return snapshot.docs.map(d => d.data() as IServicePattern);\\r\\n  }\\r\\n\\r\\n  async deletePattern(id: string): Promise<void> {\\r\\n      await this.getDb().collection(PATTERNS_COLLECTION).doc(id).delete();\\r\\n  }\\r\\n\\r\\n  // --- 2. EL GENERADOR (CORREGIDO HUSO HORARIO ARGENTINA) ---\\r\\n\\r\\n  async generateVacancies(contractId: string, month: number, year: number, objectiveId: string): Promise<{ created: number, message: string }> {\\r\\n    const db = this.getDb();\\r\\n    const patterns = await this.getPatternsByContract(contractId);\\r\\n    if (patterns.length === 0) return { created: 0, message: \'No hay patrones definidos.\' };\\r\\n\\r\\n    const shiftTypesMap = new Map<string, IShiftType>();\\r\\n    const typesSnapshot = await db.collection(SHIFT_TYPES_COLLECTION).where(\'contractId\', \'==\', contractId).get();\\r\\n    typesSnapshot.forEach(doc => shiftTypesMap.set(doc.id, { id: doc.id, ...doc.data() } as IShiftType));\\r\\n\\r\\n    const startOfMonth = new Date(Date.UTC(year, month - 1, 1, 12, 0, 0));\\r\\n    const endOfMonth = new Date(Date.UTC(year, month, 0, 12, 0, 0)); \\r\\n    \\r\\n    const batch = db.batch();\\r\\n    let count = 0;\\r\\n    const MAX_BATCH_SIZE = 450; \\r\\n\\r\\n    for (let d = new Date(startOfMonth); d <= endOfMonth; d.setDate(d.getDate() + 1)) {\\r\\n        const currentDayOfWeek = d.getUTCDay();\\r\\n        const dateStr = d.toISOString().split(\'T\')[0]; \\r\\n\\r\\n        for (const pattern of patterns) {\\r\\n            const pStart = pattern.validFrom.toDate().toISOString().split(\'T\')[0];\\r\\n            if (dateStr < pStart) continue;\\r\\n            \\r\\n            if (pattern.validTo) {\\r\\n                const pEnd = pattern.validTo.toDate().toISOString().split(\'T\')[0];\\r\\n                if (dateStr > pEnd) continue;\\r\\n            }\\r\\n\\r\\n            if (pattern.daysOfWeek.includes(currentDayOfWeek)) {\\r\\n                const shiftType = shiftTypesMap.get(pattern.shiftTypeId);\\r\\n                if (!shiftType) continue;\\r\\n\\r\\n                for (let i = 0; i < pattern.quantityPerDay; i++) {\\r\\n                    const newShiftRef = db.collection(SHIFTS_COLLECTION).doc();\\r\\n\\r\\n                    //  FIX: Forzamos Zona Horaria -03:00 (Argentina)\\r\\n                    // Esto hace que \\"06:00\\" en el string se guarde como 09:00 UTC,\\r\\n                    // que al leerse en el navegador (Argentina) volver谩 a ser 06:00.\\r\\n                    const startISO = `${dateStr}T${shiftType.startTime}:00-03:00`;\\r\\n                    const startObj = new Date(startISO);\\r\\n                    \\r\\n                    const endObj = new Date(startObj.getTime() + (shiftType.durationHours * 60 * 60 * 1000));\\r\\n\\r\\n                    const vacancy = {\\r\\n                        id: newShiftRef.id,\\r\\n                        employeeId: \'VACANTE\', \\r\\n                        employeeName: \'VACANTE\',\\r\\n                        objectiveId: objectiveId,\\r\\n                        objectiveName: \'Sede\', \\r\\n                        startTime: admin.firestore.Timestamp.fromDate(startObj),\\r\\n                        endTime: admin.firestore.Timestamp.fromDate(endObj),\\r\\n                        status: \'Assigned\', \\r\\n                        shiftTypeId: shiftType.id,\\r\\n                        role: shiftType.requiredRole || \'Vigilador\',\\r\\n                        schedulerId: \'SYSTEM_GENERATOR\',\\r\\n                        updatedAt: admin.firestore.Timestamp.now()\\r\\n                    };\\r\\n                    \\r\\n                    batch.set(newShiftRef, vacancy);\\r\\n                    count++;\\r\\n                    if (count >= MAX_BATCH_SIZE) break;\\r\\n                }\\r\\n            }\\r\\n        }\\r\\n        if (count >= MAX_BATCH_SIZE) break;\\r\\n    }\\r\\n\\r\\n    if (count > 0) await batch.commit();\\r\\n    return { \\r\\n        created: count, \\r\\n        message: count >= MAX_BATCH_SIZE ? `L铆mite de lote. ${count} vacantes.` : `隆xito! ${count} vacantes generadas.` \\r\\n    };\\r\\n  }\\r\\n\\r\\n  // --- 3. LIMPIEZA DE ESTRUCTURA ---\\r\\n  async clearVacancies(objectiveId: string, month: number, year: number): Promise<{ deleted: number }> {\\r\\n      const db = this.getDb();\\r\\n      const startOfMonth = new Date(Date.UTC(year, month - 1, 1, 0, 0, 0));\\r\\n      const endOfMonth = new Date(Date.UTC(year, month, 0, 23, 59, 59));\\r\\n      \\r\\n      const snapshot = await db.collection(SHIFTS_COLLECTION)\\r\\n          .where(\'objectiveId\', \'==\', objectiveId)\\r\\n          .where(\'employeeId\', \'==\', \'VACANTE\')\\r\\n          .where(\'startTime\', \'>=\', admin.firestore.Timestamp.fromDate(startOfMonth))\\r\\n          .where(\'startTime\', \'<=\', admin.firestore.Timestamp.fromDate(endOfMonth))\\r\\n          .get();\\r\\n\\r\\n      if (snapshot.empty) return { deleted: 0 };\\r\\n\\r\\n      const batch = db.batch();\\r\\n      let count = 0;\\r\\n      snapshot.docs.forEach(doc => {\\r\\n          batch.delete(doc.ref);\\r\\n          count++;\\r\\n      });\\r\\n      await batch.commit();\\r\\n      return { deleted: count };\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"43k9r535u","name":"scheduling.module.ts","path":"apps\\\\functions\\\\src\\\\scheduling\\\\scheduling.module.ts","area":"BACKEND","content":"import { Module, forwardRef } from \'@nestjs/common\';\\r\\nimport { SchedulingService } from \'./scheduling.service\';\\r\\nimport { ShiftOverlapService } from \'./shift-overlap.service\';\\r\\nimport { WorkloadService } from \'./workload.service\'; //  Correcto: Importa la clase\\r\\nimport { AuditService } from \'./audit.service\';\\r\\nimport { GeofencingService } from \'./geofencing.service\';\\r\\nimport { PatternService } from \'./pattern.service\';\\r\\nimport { DataManagementModule } from \'../data-management/data-management.module\';\\r\\n\\r\\n@Module({\\r\\n  imports: [\\r\\n    forwardRef(() => DataManagementModule)\\r\\n  ],\\r\\n  providers: [\\r\\n    SchedulingService,\\r\\n    ShiftOverlapService,\\r\\n    WorkloadService,\\r\\n    AuditService,\\r\\n    GeofencingService,\\r\\n    PatternService \\r\\n  ],\\r\\n  exports: [\\r\\n    SchedulingService,\\r\\n    WorkloadService, //  CORRECTO: Exportado para que AbsenceService lo pueda inyectar\\r\\n    AuditService,\\r\\n    PatternService \\r\\n  ],\\r\\n})\\r\\nexport class SchedulingModule {}\\n\\n\\n\\n"},{"id":"5icczhqc6","name":"scheduling.service.ts","path":"apps\\\\functions\\\\src\\\\scheduling\\\\scheduling.service.ts","area":"BACKEND","content":"import { Injectable, BadRequestException } from \'@nestjs/common\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { IShift } from \'../common/interfaces/shift.interface\';\\r\\nimport { ShiftOverlapService } from \'./shift-overlap.service\';\\r\\nimport { WorkloadService } from \'./workload.service\';\\r\\nimport * as functions from \'firebase-functions\';\\r\\n\\r\\nconst SHIFTS_COLLECTION = \'turnos\';\\r\\nconst ABSENCES_COLLECTION = \'ausencias\'; \\r\\n\\r\\n@Injectable()\\r\\nexport class SchedulingService {\\r\\n  private getDb = () => admin.app().firestore();\\r\\n\\r\\n  constructor(\\r\\n    private readonly overlapService: ShiftOverlapService,\\r\\n    private readonly workloadService: WorkloadService\\r\\n  ) {}\\r\\n\\r\\n  private convertToDate(input: any): Date {\\r\\n    if (!input) return new Date();\\r\\n    if (input instanceof admin.firestore.Timestamp) return input.toDate();\\r\\n    if (typeof input.toDate === \'function\') return input.toDate();\\r\\n    if (input._seconds !== undefined) return new Date(input._seconds * 1000);\\r\\n    return new Date(input);\\r\\n  }\\r\\n\\r\\n  // 1. VALIDACIN DE AUSENCIAS (HARD BLOCK) - FIX: Evitar Bloqueo Persistente\\r\\n  private async checkAbsenceConflict(employeeId: string, shiftStart: Date, shiftEnd: Date): Promise<void> {\\r\\n      if (employeeId === \'VACANTE\') return;\\r\\n\\r\\n      const db = this.getDb();\\r\\n      // Traemos TODAS las ausencias activas para el empleado\\r\\n      const absencesSnap = await db.collection(ABSENCES_COLLECTION)\\r\\n          .where(\'employeeId\', \'==\', employeeId)\\r\\n          .where(\'status\', \'in\', [\'APPROVED\', \'PENDING\']) \\r\\n          .get();\\r\\n\\r\\n      if (absencesSnap.empty) return;\\r\\n\\r\\n      const conflict = absencesSnap.docs.find(doc => {\\r\\n          const data = doc.data();\\r\\n          if (data.status === \'REJECTED\' || data.status === \'CANCELLED\') return false;\\r\\n\\r\\n          const absStart = this.convertToDate(data.startDate);\\r\\n          const absEnd = this.convertToDate(data.endDate);\\r\\n\\r\\n          //  FIX: L贸gica de Overlap. Solo bloquea si el turno intersecta el rango de la licencia.\\r\\n          if (shiftStart.getTime() < absEnd.getTime() && shiftEnd.getTime() > absStart.getTime()) {\\r\\n              const type = data.type === \'SICK_LEAVE\' ? \'LICENCIA MDICA\' : \\r\\n                           data.type === \'VACATION\' ? \'VACACIONES\' : \'AUSENCIA\';\\r\\n              throw new functions.https.HttpsError(\\r\\n                  \'failed-precondition\', \\r\\n                  ` BLOQUEO: El empleado tiene una ${type} vigente en esa fecha.`\\r\\n              );\\r\\n          }\\r\\n          return false;\\r\\n      });\\r\\n  }\\r\\n\\r\\n  // --- CREAR TURNO INDIVIDUAL ---\\r\\n  async assignShift(shiftData: Partial<IShift> & { authorizeOvertime?: boolean }, userAuth: admin.auth.DecodedIdToken): Promise<IShift> {\\r\\n    const dbInstance = this.getDb();\\r\\n    const newShiftRef = dbInstance.collection(SHIFTS_COLLECTION).doc();\\r\\n\\r\\n    if (!shiftData.startTime || !shiftData.endTime || !shiftData.employeeId || !shiftData.objectiveId) {\\r\\n        throw new functions.https.HttpsError(\'invalid-argument\', \'Faltan datos requeridos.\');\\r\\n    }\\r\\n    \\r\\n    let newStart: Date;\\r\\n    let newEnd: Date;\\r\\n    try {\\r\\n        newStart = this.convertToDate(shiftData.startTime);\\r\\n        newEnd = this.convertToDate(shiftData.endTime);\\r\\n    } catch (e) { throw new functions.https.HttpsError(\'invalid-argument\', \'Fecha inv谩lida.\'); }\\r\\n    \\r\\n    const employeeId = shiftData.employeeId!;\\r\\n    if (newStart.getTime() >= newEnd.getTime()) throw new BadRequestException(\'Horario inv谩lido.\');\\r\\n\\r\\n    // 1. VALIDAR AUSENCIAS (Hard Block)\\r\\n    await this.checkAbsenceConflict(employeeId, newStart, newEnd);\\r\\n\\r\\n    // 2. VALIDAR CARGA HORARIA (Soft Block)\\r\\n    let isOvertime = false;\\r\\n    if (employeeId !== \'VACANTE\') {\\r\\n        try {\\r\\n            // Llama a la validaci贸n que suma correctamente las horas\\r\\n            await this.workloadService.validateAssignment(employeeId, newStart, newEnd);\\r\\n        } catch (error: any) {\\r\\n            if (error.message && (error.message.includes(\'LMITE EXCEDIDO\') || error.status === 409)) { \\r\\n                if (!shiftData.authorizeOvertime) {\\r\\n                    // Rebotamos con error espec铆fico para activar el di谩logo en el frontend\\r\\n                    throw new functions.https.HttpsError(\'resource-exhausted\', error.message);\\r\\n                }\\r\\n                isOvertime = true;\\r\\n                console.log(`锔 Overtime autorizado para ${employeeId}`);\\r\\n            } else {\\r\\n                throw error;\\r\\n            }\\r\\n        }\\r\\n    }\\r\\n\\r\\n    // 3. TRANSACCIN FINAL\\r\\n    try {\\r\\n      await dbInstance.runTransaction(async (transaction) => {\\r\\n        if (employeeId !== \'VACANTE\') {\\r\\n            const overlappingQuery = dbInstance.collection(SHIFTS_COLLECTION)\\r\\n              .where(\'employeeId\', \'==\', employeeId)\\r\\n              .where(\'endTime\', \'>\', newStart) \\r\\n              .limit(5); \\r\\n\\r\\n            const snapshot = await transaction.get(overlappingQuery);\\r\\n            const hasOverlap = snapshot.docs.some(doc => {\\r\\n                const data = doc.data();\\r\\n                if (data.status === \'Canceled\') return false;\\r\\n                const existStart = this.convertToDate(data.startTime);\\r\\n                const existEnd = this.convertToDate(data.endTime);\\r\\n                return this.overlapService.isOverlap(existStart, existEnd, newStart, newEnd);\\r\\n            });\\r\\n\\r\\n            if (hasOverlap) throw new functions.https.HttpsError(\'already-exists\', \' El empleado ya tiene OTRO TURNO asignado en este horario.\');\\r\\n        }\\r\\n        \\r\\n        const finalShift: IShift = {\\r\\n          id: newShiftRef.id,\\r\\n          employeeId,\\r\\n          objectiveId: shiftData.objectiveId!,\\r\\n          employeeName: shiftData.employeeName || \'S/D\', \\r\\n          objectiveName: shiftData.objectiveName || \'S/D\',\\r\\n          startTime: admin.firestore.Timestamp.fromDate(newStart), \\r\\n          endTime: admin.firestore.Timestamp.fromDate(newEnd),\\r\\n          status: \'Assigned\',\\r\\n          schedulerId: userAuth.uid,\\r\\n          updatedAt: admin.firestore.Timestamp.now(),\\r\\n          role: (shiftData as any).role || \'Vigilador\',\\r\\n          isOvertime \\r\\n        };\\r\\n\\r\\n        transaction.set(newShiftRef, finalShift);\\r\\n      });\\r\\n      \\r\\n      return { id: newShiftRef.id, ...shiftData } as IShift;\\r\\n\\r\\n    } catch (error: any) {\\r\\n        if (error instanceof functions.https.HttpsError) throw error;\\r\\n        throw new functions.https.HttpsError(\'internal\', error.message);\\r\\n    }\\r\\n  }\\r\\n\\r\\n  // --- EDITAR TURNO ---\\r\\n  async updateShift(shiftId: string, updateData: Partial<IShift> & { authorizeOvertime?: boolean }): Promise<void> {\\r\\n      const db = this.getDb();\\r\\n      const shiftRef = db.collection(SHIFTS_COLLECTION).doc(shiftId);\\r\\n      \\r\\n      const currentDoc = await shiftRef.get();\\r\\n      if (!currentDoc.exists) throw new functions.https.HttpsError(\'not-found\', \'Turno no encontrado\');\\r\\n      const currentShift = currentDoc.data() as IShift;\\r\\n\\r\\n      const effectiveEmployeeId = updateData.employeeId || currentShift.employeeId;\\r\\n      const effectiveStart = updateData.startTime ? this.convertToDate(updateData.startTime) : this.convertToDate(currentShift.startTime);\\r\\n      const effectiveEnd = updateData.endTime ? this.convertToDate(updateData.endTime) : this.convertToDate(currentShift.endTime);\\r\\n\\r\\n      const isRealEmployee = effectiveEmployeeId !== \'VACANTE\';\\r\\n      const hasChanged = updateData.employeeId !== undefined || updateData.startTime !== undefined || updateData.endTime !== undefined;\\r\\n\\r\\n      let isOvertime = currentShift.isOvertime || false;\\r\\n\\r\\n      if (isRealEmployee && hasChanged) {\\r\\n           // 1. Validar Ausencias\\r\\n           await this.checkAbsenceConflict(effectiveEmployeeId, effectiveStart, effectiveEnd);\\r\\n\\r\\n           // 2. Validar Carga\\r\\n           try {\\r\\n               await this.workloadService.validateAssignment(effectiveEmployeeId, effectiveStart, effectiveEnd, shiftId);\\r\\n               if (!updateData.authorizeOvertime) isOvertime = false; \\r\\n           } catch (e: any) {\\r\\n               if (e.message && (e.message.includes(\'LMITE EXCEDIDO\') || e.status === 409)) {\\r\\n                   if (!updateData.authorizeOvertime) {\\r\\n                       throw new functions.https.HttpsError(\'resource-exhausted\', e.message);\\r\\n                   }\\r\\n                   isOvertime = true;\\r\\n               } else {\\r\\n                   throw e;\\r\\n               }\\r\\n           }\\r\\n      }\\r\\n\\r\\n      const safeUpdate: any = { ...updateData };\\r\\n      delete safeUpdate.id; \\r\\n      delete safeUpdate.authorizeOvertime; \\r\\n\\r\\n      if (safeUpdate.startTime) safeUpdate.startTime = admin.firestore.Timestamp.fromDate(effectiveStart);\\r\\n      if (safeUpdate.endTime) safeUpdate.endTime = admin.firestore.Timestamp.fromDate(effectiveEnd);\\r\\n      \\r\\n      safeUpdate.updatedAt = admin.firestore.Timestamp.now();\\r\\n      safeUpdate.isOvertime = isOvertime;\\r\\n      \\r\\n      await shiftRef.update(safeUpdate);\\r\\n  }\\r\\n\\r\\n  // --- REPLICAR ESTRUCTURA (L贸gica Corregida) ---\\r\\n  async replicateDailyStructure(\\r\\n    objectiveId: string, \\r\\n    sourceDateStr: string, \\r\\n    targetStartDateStr: string, \\r\\n    targetEndDateStr: string, \\r\\n    schedulerId: string,\\r\\n    targetDays?: number[]\\r\\n  ): Promise<{ created: number, skipped: number }> {\\r\\n    const db = this.getDb();\\r\\n    \\r\\n    const TZ_OFFSET_HOURS = 3; \\r\\n    const sourceDate = new Date(sourceDateStr + \'T00:00:00\');\\r\\n    const startSource = new Date(sourceDate); startSource.setHours(startSource.getHours() + TZ_OFFSET_HOURS);\\r\\n    const endSource = new Date(startSource); endSource.setHours(startSource.getHours() + 23, 59, 59, 999);\\r\\n\\r\\n    const sourceShiftsSnap = await db.collection(SHIFTS_COLLECTION)\\r\\n        .where(\'objectiveId\', \'==\', objectiveId)\\r\\n        .where(\'startTime\', \'>=\', admin.firestore.Timestamp.fromDate(startSource))\\r\\n        .where(\'startTime\', \'<=\', admin.firestore.Timestamp.fromDate(endSource))\\r\\n        .get();\\r\\n\\r\\n    if (sourceShiftsSnap.empty) throw new functions.https.HttpsError(\'not-found\', \'El d铆a origen no tiene turnos.\');\\r\\n\\r\\n    const sourceShifts = sourceShiftsSnap.docs.map(doc => doc.data() as IShift).filter(s => s.status !== \'Canceled\');\\r\\n    \\r\\n    const batch = db.batch();\\r\\n    let opCount = 0;\\r\\n    let skipped = 0;\\r\\n    const MAX_BATCH_SIZE = 450; \\r\\n    const allowedDays = targetDays && targetDays.length > 0 ? targetDays : [0,1,2,3,4,5,6];\\r\\n\\r\\n    const startTarget = new Date(targetStartDateStr + \'T00:00:00\');\\r\\n    const endTarget = new Date(targetEndDateStr + \'T00:00:00\');\\r\\n    const loopStart = new Date(startTarget); \\r\\n    const loopEnd = new Date(endTarget);\\r\\n\\r\\n    for (let d = new Date(loopStart); d <= loopEnd; d.setDate(d.getDate() + 1)) {\\r\\n        if (!allowedDays.includes(d.getDay())) continue;\\r\\n\\r\\n        const dayStartUTC = new Date(d);\\r\\n        dayStartUTC.setHours(dayStartUTC.getHours() + TZ_OFFSET_HOURS);\\r\\n        const dayEndUTC = new Date(dayStartUTC);\\r\\n        dayEndUTC.setHours(dayStartUTC.getHours() + 23, 59, 59, 999);\\r\\n        \\r\\n        const existingCheck = await db.collection(SHIFTS_COLLECTION)\\r\\n            .where(\'objectiveId\', \'==\', objectiveId)\\r\\n            .where(\'startTime\', \'>=\', admin.firestore.Timestamp.fromDate(dayStartUTC))\\r\\n            .where(\'startTime\', \'<=\', admin.firestore.Timestamp.fromDate(dayEndUTC))\\r\\n            .get();\\r\\n\\r\\n        if (existingCheck.empty) { skipped++; continue; }\\r\\n\\r\\n        const existingShifts = existingCheck.docs.map(doc => ({ ref: doc.ref, data: doc.data() as IShift }));\\r\\n             \\r\\n        const hasRealEmployees = existingShifts.some(s => s.data.employeeId !== \'VACANTE\' && s.data.status !== \'Canceled\');\\r\\n        if (hasRealEmployees) { skipped++; continue; }\\r\\n\\r\\n        existingShifts.forEach(doc => { batch.delete(doc.ref); opCount++; });\\r\\n\\r\\n        for (const template of sourceShifts) {\\r\\n            const tStart = this.convertToDate(template.startTime);\\r\\n            const tEnd = this.convertToDate(template.endTime);\\r\\n            \\r\\n            const msFromStartOfDay = tStart.getTime() - startSource.getTime();\\r\\n            const durationMs = tEnd.getTime() - tStart.getTime();\\r\\n            \\r\\n            const newStart = new Date(dayStartUTC.getTime() + msFromStartOfDay);\\r\\n            const newEnd = new Date(newStart.getTime() + durationMs);\\r\\n\\r\\n            const newShiftRef = db.collection(SHIFTS_COLLECTION).doc();\\r\\n            const newShift: IShift = {\\r\\n                id: newShiftRef.id,\\r\\n                objectiveId: objectiveId,\\r\\n                objectiveName: template.objectiveName,\\r\\n                employeeId: template.employeeId, \\r\\n                employeeName: template.employeeName,\\r\\n                role: template.role || \'Vigilador\',\\r\\n                startTime: admin.firestore.Timestamp.fromDate(newStart),\\r\\n                endTime: admin.firestore.Timestamp.fromDate(newEnd),\\r\\n                status: \'Assigned\',\\r\\n                schedulerId: schedulerId,\\r\\n                updatedAt: admin.firestore.Timestamp.now()\\r\\n            };\\r\\n            \\r\\n            batch.set(newShiftRef, newShift);\\r\\n            opCount++;\\r\\n            if (opCount >= MAX_BATCH_SIZE) break;\\r\\n        }\\r\\n        if (opCount >= MAX_BATCH_SIZE) break;\\r\\n    }\\r\\n\\r\\n    if (opCount > 0) await batch.commit();\\r\\n    return { created: opCount, skipped };\\r\\n  }\\r\\n  \\r\\n  async deleteShift(shiftId: string): Promise<void> {\\r\\n      const db = this.getDb();\\r\\n      await db.collection(SHIFTS_COLLECTION).doc(shiftId).delete();\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"7zl8doxf6","name":"shift-overlap.service.spec.ts","path":"apps\\\\functions\\\\src\\\\scheduling\\\\shift-overlap.service.spec.ts","area":"BACKEND","content":"// D5: Unit Test que verifica la REGRA DE NEGOCIO m谩s importante.\\r\\nimport { ShiftOverlapService } from \'../../src/scheduling/shift-overlap.service\';\\r\\n\\r\\ndescribe(\'ShiftOverlapService (Core Logic D5)\', () => {\\r\\n  let service: ShiftOverlapService;\\r\\n\\r\\n  beforeEach(() => {\\r\\n    service = new ShiftOverlapService();\\r\\n  });\\r\\n\\r\\n  // Turno base: De 10:00 a 14:00 (4 horas)\\r\\n  const T_START = new Date(\'2025-11-20T10:00:00.000Z\');\\r\\n  const T_END = new Date(\'2025-11-20T14:00:00.000Z\');\\r\\n\\r\\n  // CASOS DE XITO (Solapamiento)\\r\\n  it(\'should return TRUE if the new shift starts inside and ends outside the existing shift\', () => {\\r\\n    // Nuevo turno: 12:00 a 16:00\\r\\n    const newStart = new Date(\'2025-11-20T12:00:00.000Z\');\\r\\n    const newEnd = new Date(\'2025-11-20T16:00:00.000Z\');\\r\\n    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);\\r\\n  });\\r\\n\\r\\n  it(\'should return TRUE if the new shift is entirely contained within the existing shift\', () => {\\r\\n    // Nuevo turno: 11:00 a 13:00\\r\\n    const newStart = new Date(\'2025-11-20T11:00:00.000Z\');\\r\\n    const newEnd = new Date(\'2025-11-20T13:00:00.000Z\');\\r\\n    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);\\r\\n  });\\r\\n  \\r\\n  it(\'should return TRUE if the new shift starts before and ends inside the existing shift\', () => {\\r\\n    // Nuevo turno: 09:00 a 11:00\\r\\n    const newStart = new Date(\'2025-11-20T09:00:00.000Z\');\\r\\n    const newEnd = new Date(\'2025-11-20T11:00:00.000Z\');\\r\\n    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(true);\\r\\n  });\\r\\n\\r\\n  // CASOS DE FRACASO (No Solapamiento)\\r\\n  it(\'should return FALSE if the new shift is adjacent (starts exactly when the other ends)\', () => {\\r\\n    // Nuevo turno: 14:00 a 18:00\\r\\n    const newStart = new Date(\'2025-11-20T14:00:00.000Z\');\\r\\n    const newEnd = new Date(\'2025-11-20T18:00:00.000Z\');\\r\\n    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);\\r\\n  });\\r\\n\\r\\n  it(\'should return FALSE if the new shift ends exactly when the other starts\', () => {\\r\\n    // Nuevo turno: 06:00 a 10:00\\r\\n    const newStart = new Date(\'2025-11-20T06:00:00.000Z\');\\r\\n    const newEnd = new Date(\'2025-11-20T10:00:00.000Z\');\\r\\n    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);\\r\\n  });\\r\\n\\r\\n  it(\'should return FALSE if the new shift is completely outside the range\', () => {\\r\\n    // Nuevo turno: 07:00 a 09:00\\r\\n    const newStart = new Date(\'2025-11-20T07:00:00.000Z\');\\r\\n    const newEnd = new Date(\'2025-11-20T09:00:00.000Z\');\\r\\n    expect(service.isOverlap(T_START, T_END, newStart, newEnd)).toBe(false);\\r\\n  });\\r\\n});\\n\\n\\n\\n"},{"id":"eldzvaysb","name":"shift-overlap.service.ts","path":"apps\\\\functions\\\\src\\\\scheduling\\\\shift-overlap.service.ts","area":"BACKEND","content":"import { Injectable } from \'@nestjs/common\';\\r\\n\\r\\n/**\\r\\n * @class ShiftOverlapService\\r\\n * @description Servicio que encapsula la l贸gica pura (matem谩tica) para determinar\\r\\n * si dos rangos de tiempo se cruzan. Cumple con SRP (SOLID).\\r\\n */\\r\\n@Injectable()\\r\\nexport class ShiftOverlapService {\\r\\n\\r\\n  /**\\r\\n   * @function isOverlap\\r\\n   * @description Verifica si un nuevo rango de tiempo se superpone con un rango existente.\\r\\n   * La f贸rmula evita solapamiento si los turnos son adyacentes (ej: uno termina a las 14:00 y el otro empieza a las 14:00).\\r\\n   * @param {Date} existingStart - Inicio del turno ya registrado.\\r\\n   * @param {Date} existingEnd - Fin del turno ya registrado.\\r\\n   * @param {Date} newStart - Inicio del nuevo turno.\\r\\n   * @param {Date} newEnd - Fin del nuevo turno.\\r\\n   * @returns {boolean} True si hay solapamiento.\\r\\n   */\\r\\n  public isOverlap(existingStart: Date, existingEnd: Date, newStart: Date, newEnd: Date): boolean {\\r\\n    // Si el nuevo empieza antes de que el existente termine Y el nuevo termina despues de que el existente empiece, S hay solapamiento.\\r\\n    return (\\r\\n      newStart.getTime() < existingEnd.getTime() && \\r\\n      newEnd.getTime() > existingStart.getTime()\\r\\n    );\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"cessi79i9","name":"workload.service.ts","path":"apps\\\\functions\\\\src\\\\scheduling\\\\workload.service.ts","area":"BACKEND","content":"import { Injectable, BadRequestException, ConflictException } from \'@nestjs/common\';\\r\\nimport * as admin from \'firebase-admin\';\\r\\nimport { IEmployee } from \'../common/interfaces/employee.interface\';\\r\\nimport { IAbsence } from \'../common/interfaces/absence.interface\';\\r\\nimport { IShift } from \'../common/interfaces/shift.interface\';\\r\\nimport { startOfWeek, endOfWeek, isSunday, isSaturday, getHours } from \'date-fns\';\\r\\n//  IMPORTANTE: Aseg煤rate de que este archivo exista en src/common/constants/labor-rules.ts\\r\\nimport { LABOR_RULES } from \'../common/constants/labor-rules\';\\r\\n\\r\\nconst EMPLOYEES_COLLECTION = \'empleados\';\\r\\nconst ABSENCES_COLLECTION = \'ausencias\';\\r\\nconst SHIFTS_COLLECTION = \'turnos\';\\r\\n\\r\\n@Injectable()\\r\\nexport class WorkloadService {\\r\\n  private getDb = () => admin.app().firestore();\\r\\n\\r\\n  /**\\r\\n   * Helper para normalizar fechas de cualquier formato a Date nativo.\\r\\n   */\\r\\n  private toDate(val: any): Date {\\r\\n      if (!val) return new Date();\\r\\n      if (val instanceof admin.firestore.Timestamp) return val.toDate();\\r\\n      if (val._seconds) return new Date(val._seconds * 1000);\\r\\n      if (typeof val === \'string\') return new Date(val);\\r\\n      return new Date(val);\\r\\n  }\\r\\n\\r\\n  /**\\r\\n   * Helper para calcular el rango de fechas del ciclo de n贸mina (ej: 26 al 25, o 1 al 30).\\r\\n   */\\r\\n  private getCycleDates(shiftDate: Date, startDay: number, endDay: number) {\\r\\n      const year = shiftDate.getFullYear();\\r\\n      const month = shiftDate.getMonth();\\r\\n      let cycleStart, cycleEnd;\\r\\n\\r\\n      // Validaci贸n b谩sica de configuraci贸n\\r\\n      if (startDay >= 1 && startDay <= 31 && (endDay >= 1 && endDay <= 31 || endDay === 0)) {\\r\\n          \\r\\n          if (startDay <= endDay || endDay === 0) {\\r\\n              // Ciclo dentro del mismo mes (Ej: 1 al 30, o 1 al ltimo d铆a)\\r\\n              cycleStart = new Date(year, month, startDay, 0, 0, 0);\\r\\n              cycleEnd = endDay === 0 \\r\\n                  ? new Date(year, month + 1, 0, 23, 59, 59, 999) \\r\\n                  : new Date(year, month, endDay, 23, 59, 59, 999);\\r\\n          } else {\\r\\n              // Ciclo cruzado entre meses (Ej: 26 al 25)\\r\\n              if (shiftDate.getDate() >= startDay) {\\r\\n                  // El turno pertenece al ciclo que termina el pr贸ximo mes\\r\\n                  cycleStart = new Date(year, month, startDay, 0, 0, 0);\\r\\n                  cycleEnd = new Date(year, month + 1, endDay, 23, 59, 59, 999);\\r\\n              } else {\\r\\n                  // El turno pertenece al ciclo que empez贸 el mes anterior\\r\\n                  cycleStart = new Date(year, month - 1, startDay, 0, 0, 0);\\r\\n                  cycleEnd = new Date(year, month, endDay, 23, 59, 59, 999);\\r\\n              }\\r\\n          }\\r\\n      } else {\\r\\n          // Fallback: Mes calendario (1 al 煤ltimo d铆a)\\r\\n          cycleStart = new Date(year, month, 1, 0, 0, 0);\\r\\n          cycleEnd = new Date(year, month + 1, 0, 23, 59, 59, 999);\\r\\n      }\\r\\n      return { cycleStart, cycleEnd };\\r\\n  }\\r\\n\\r\\n  /**\\r\\n   * PUNTO DE ENTRADA PRINCIPAL: Valida reglas y calcula costos.\\r\\n   */\\r\\n  async validateAssignment(employeeId: string, shiftStart: Date, shiftEnd: Date, excludeShiftId?: string): Promise<any> {\\r\\n    const db = this.getDb();\\r\\n    \\r\\n    // 1. Obtener Datos del Empleado\\r\\n    const empDoc = await db.collection(EMPLOYEES_COLLECTION).doc(employeeId).get();\\r\\n    if (!empDoc.exists) throw new BadRequestException(\'Empleado no encontrado\');\\r\\n    const employee = empDoc.data() as IEmployee;\\r\\n\\r\\n    console.log(` [Workload] Validando para: ${employee.name} (${employeeId}) | Convenio: ${employee.laborAgreement || \'SUVICO\'}`);\\r\\n\\r\\n    // 2. Validar Solapamiento (Conflictos de horario)\\r\\n    const conflicts = await this.checkShiftOverlap(employeeId, shiftStart, shiftEnd, excludeShiftId);\\r\\n    if (conflicts.length > 0) {\\r\\n        throw new ConflictException(`隆CONFLICTO! Ya tiene un turno asignado en ese horario.`);\\r\\n    }\\r\\n\\r\\n    // 3. Validar Disponibilidad (Ausencias / Licencias)\\r\\n    await this.checkAvailability(employeeId, shiftStart, shiftEnd);\\r\\n\\r\\n    // 4. Validar L铆mite Mensual de Horas (Soft Block con Ciclo)\\r\\n    await this.checkMonthlyLimit(employee, shiftStart, shiftEnd, excludeShiftId);\\r\\n\\r\\n    // 5. CLCULO DE NMINA (Reglas de Convenio)\\r\\n    const breakdown = await this.calculateShiftBreakdown(employee, shiftStart, shiftEnd, excludeShiftId);\\r\\n    \\r\\n    return breakdown;\\r\\n  }\\r\\n\\r\\n  /**\\r\\n   * MOTOR DE REGLAS LABORALES: Calcula horas normales, extras 50%, 100% seg煤n convenio.\\r\\n   */\\r\\n  async calculateShiftBreakdown(employee: IEmployee, start: Date, end: Date, excludeShiftId?: string) {\\r\\n      // Switch de Convenios\\r\\n      const agreement = employee.laborAgreement || \'SUVICO\';\\r\\n      \\r\\n      switch (agreement) {\\r\\n          case \'SUVICO\':\\r\\n              return this.calculateSuvicoRules(employee.uid, start, end, excludeShiftId);\\r\\n          case \'COMERCIO\':\\r\\n              return this.calculateStandardRules(start, end); \\r\\n          case \'UOCRA\':\\r\\n              return this.calculateStandardRules(start, end); \\r\\n          case \'FUERA_CONVENIO\':\\r\\n              return this.calculateStandardRules(start, end);\\r\\n          default:\\r\\n              return this.calculateStandardRules(start, end);\\r\\n      }\\r\\n  }\\r\\n\\r\\n  /**\\r\\n   * Reglas Espec铆ficas para Seguridad Privada (CCT 422/05)\\r\\n   */\\r\\n  private async calculateSuvicoRules(employeeId: string, start: Date, end: Date, excludeShiftId?: string) {\\r\\n      const db = this.getDb();\\r\\n      const rules = LABOR_RULES[\'SUVICO\'];\\r\\n\\r\\n      // 1. Calcular acumulado de la SEMANA (Lunes a Domingo) para regla de 48hs\\r\\n      const weekStart = startOfWeek(start, { weekStartsOn: 1 });\\r\\n      const weekEnd = endOfWeek(start, { weekStartsOn: 1 });\\r\\n\\r\\n      const shiftsSnap = await db.collection(SHIFTS_COLLECTION)\\r\\n          .where(\'employeeId\', \'==\', employeeId)\\r\\n          .where(\'startTime\', \'>=\', admin.firestore.Timestamp.fromDate(weekStart))\\r\\n          .where(\'startTime\', \'<=\', admin.firestore.Timestamp.fromDate(weekEnd))\\r\\n          .get();\\r\\n\\r\\n      let weeklyHours = 0;\\r\\n      shiftsSnap.forEach(doc => {\\r\\n          if (doc.id === excludeShiftId) return;\\r\\n          const data = doc.data();\\r\\n          if (data.status === \'Canceled\') return;\\r\\n          const s = this.toDate(data.startTime);\\r\\n          const e = this.toDate(data.endTime);\\r\\n          weeklyHours += (e.getTime() - s.getTime()) / (1000 * 60 * 60);\\r\\n      });\\r\\n\\r\\n      // Duraci贸n del nuevo turno\\r\\n      const duration = (end.getTime() - start.getTime()) / (1000 * 60 * 60);\\r\\n      const newWeeklyTotal = weeklyHours + duration;\\r\\n\\r\\n      let normal = duration;\\r\\n      let hours50 = 0;\\r\\n      let hours100 = 0;\\r\\n\\r\\n      // 2. Aplicar Regla de Exceso Semanal (>48hs)\\r\\n      if (newWeeklyTotal > rules.maxHoursWeekly!) {\\r\\n          const previousExcess = Math.max(0, weeklyHours - rules.maxHoursWeekly!);\\r\\n          const currentExcess = Math.max(0, newWeeklyTotal - rules.maxHoursWeekly!);\\r\\n          const overtime = currentExcess - previousExcess;\\r\\n          \\r\\n          normal = Math.max(0, duration - overtime);\\r\\n\\r\\n          // 3. Clasificar Extras (50 vs 100)\\r\\n          const isSun = isSunday(start);\\r\\n          const isSat = isSaturday(start);\\r\\n          const startH = getHours(start);\\r\\n\\r\\n          // Regla: Domingo o S谩bado despu茅s de la hora de corte (13hs)\\r\\n          if (isSun || (isSat && startH >= rules.saturdayCutoffHour)) {\\r\\n              hours100 = overtime;\\r\\n          } else {\\r\\n              hours50 = overtime;\\r\\n          }\\r\\n      }\\r\\n\\r\\n      return {\\r\\n          totalDuration: duration,\\r\\n          weeklyTotal: newWeeklyTotal,\\r\\n          breakdown: {\\r\\n              normal: parseFloat(normal.toFixed(2)),\\r\\n              fifty: parseFloat(hours50.toFixed(2)),\\r\\n              hundred: parseFloat(hours100.toFixed(2)),\\r\\n              night: 0 // Pendiente: Implementar c谩lculo exacto de minutos nocturnos\\r\\n          },\\r\\n          agreementUsed: \'SUVICO\'\\r\\n      };\\r\\n  }\\r\\n\\r\\n  /**\\r\\n   * Reglas Gen茅ricas (Sin c谩lculo de extras complejo)\\r\\n   */\\r\\n  private calculateStandardRules(start: Date, end: Date) {\\r\\n      const duration = (end.getTime() - start.getTime()) / (1000 * 60 * 60);\\r\\n      return {\\r\\n          totalDuration: duration,\\r\\n          weeklyTotal: duration,\\r\\n          breakdown: { normal: duration, fifty: 0, hundred: 0, night: 0 },\\r\\n          agreementUsed: \'STANDARD\'\\r\\n      };\\r\\n  }\\r\\n\\r\\n  // --- VALIDACIONES ---\\r\\n\\r\\n  async checkShiftOverlap(employeeId: string, start: Date, end: Date, excludeShiftId?: string): Promise<IShift[]> {\\r\\n    const db = this.getDb();\\r\\n    const shiftsQuery = db.collection(SHIFTS_COLLECTION)\\r\\n        .where(\'employeeId\', \'==\', employeeId)\\r\\n        .where(\'endTime\', \'>\', admin.firestore.Timestamp.fromDate(start)); \\r\\n\\r\\n    const snapshot = await shiftsQuery.get();\\r\\n    const conflictingShifts: IShift[] = [];\\r\\n\\r\\n    snapshot.forEach(doc => {\\r\\n        if (excludeShiftId && doc.id === excludeShiftId) return;\\r\\n        const shift = doc.data(); \\r\\n        if (shift.status === \'Canceled\') return;\\r\\n\\r\\n        const sStart = this.toDate(shift.startTime);\\r\\n        \\r\\n        // Verificamos intersecci贸n real: (StartA < EndB) && (EndA > StartB)\\r\\n        if (sStart.getTime() < end.getTime()) {\\r\\n             conflictingShifts.push({ id: doc.id, ...shift } as unknown as IShift);\\r\\n        }\\r\\n    });\\r\\n    return conflictingShifts;\\r\\n  }\\r\\n\\r\\n  private async checkAvailability(employeeId: string, start: Date, end: Date): Promise<void> {\\r\\n    const db = this.getDb();\\r\\n    const absencesSnapshot = await db.collection(ABSENCES_COLLECTION)\\r\\n      .where(\'employeeId\', \'==\', employeeId)\\r\\n      .where(\'status\', \'in\', [\'APPROVED\', \'PENDING\'])\\r\\n      .get();\\r\\n\\r\\n    absencesSnapshot.forEach(doc => {\\r\\n      const absence = doc.data() as IAbsence;\\r\\n      const absStart = this.toDate(absence.startDate);\\r\\n      const absEnd = this.toDate(absence.endDate);\\r\\n\\r\\n      // Verificamos superposici贸n\\r\\n      if (start.getTime() < absEnd.getTime() && end.getTime() > absStart.getTime()) {\\r\\n        throw new ConflictException(` BLOQUEO: Licencia activa (${absence.type}).`);\\r\\n      }\\r\\n    });\\r\\n  }\\r\\n\\r\\n  private async checkMonthlyLimit(employee: IEmployee, newShiftStart: Date, newShiftEnd: Date, excludeShiftId?: string): Promise<void> {\\r\\n    const db = this.getDb();\\r\\n    const newDurationHours = (newShiftEnd.getTime() - newShiftStart.getTime()) / (1000 * 60 * 60);\\r\\n    \\r\\n    // Usar ciclo configurado (din谩mico)\\r\\n    const { cycleStart, cycleEnd } = this.getCycleDates(\\r\\n        newShiftStart, \\r\\n        employee.payrollCycleStartDay || 1, \\r\\n        employee.payrollCycleEndDay || 0\\r\\n    );\\r\\n\\r\\n    console.log(` [Workload] Calculando ciclo para Soft Block: ${cycleStart.toISOString()} - ${cycleEnd.toISOString()}`);\\r\\n\\r\\n    const shiftsSnapshot = await db.collection(SHIFTS_COLLECTION)\\r\\n      .where(\'employeeId\', \'==\', employee.uid)\\r\\n      .where(\'startTime\', \'>=\', admin.firestore.Timestamp.fromDate(cycleStart))\\r\\n      .where(\'startTime\', \'<=\', admin.firestore.Timestamp.fromDate(cycleEnd))\\r\\n      .get();\\r\\n\\r\\n    let accumulatedHours = 0;\\r\\n\\r\\n    shiftsSnapshot.forEach(doc => {\\r\\n      if (excludeShiftId && doc.id === excludeShiftId) return;\\r\\n      const shift = doc.data();\\r\\n      // Solo sumamos turnos v谩lidos\\r\\n      if (shift.status !== \'Canceled\' && shift.status !== \'Completed\') {\\r\\n          const sStart = this.toDate(shift.startTime);\\r\\n          const sEnd = this.toDate(shift.endTime);\\r\\n          accumulatedHours += (sEnd.getTime() - sStart.getTime()) / (1000 * 60 * 60);\\r\\n      }\\r\\n    });\\r\\n\\r\\n    const totalProjected = accumulatedHours + newDurationHours;\\r\\n    const maxHours = Number(employee.maxHoursPerMonth) || 176; \\r\\n\\r\\n    if (totalProjected > maxHours) {\\r\\n      const exceeded = (totalProjected - maxHours).toFixed(1);\\r\\n      throw new ConflictException(`LMITE EXCEDIDO: ${employee.name} llega a ${totalProjected.toFixed(1)}h (M谩x: ${maxHours}h). Exceso: ${exceeded}h.`);\\r\\n    }\\r\\n  }\\r\\n\\r\\n  // --- REPORTE PARA RRHH (Auditor铆a) ---\\r\\n  async getWorkloadReport(employeeId: string, month: number, year: number): Promise<any> {\\r\\n    const db = this.getDb();\\r\\n\\r\\n    // Usamos una fecha intermedia (d铆a 15) para determinar en qu茅 ciclo cae\\r\\n    const dateForCycle = new Date(year, month - 1, 15); \\r\\n    \\r\\n    const empDoc = await db.collection(EMPLOYEES_COLLECTION).doc(employeeId).get();\\r\\n    const employee = empDoc.exists ? empDoc.data() as IEmployee : null;\\r\\n    const maxHours = Number(employee?.maxHoursPerMonth) || 176;\\r\\n\\r\\n    // Calcular ciclo usando la configuraci贸n del empleado\\r\\n    const { cycleStart, cycleEnd } = this.getCycleDates(\\r\\n        dateForCycle, \\r\\n        employee?.payrollCycleStartDay || 1, \\r\\n        employee?.payrollCycleEndDay || 0 \\r\\n    );\\r\\n    \\r\\n    // Consulta con Timestamp (FIX)\\r\\n    const shiftsSnapshot = await db.collection(SHIFTS_COLLECTION)\\r\\n      .where(\'employeeId\', \'==\', employeeId)\\r\\n      .where(\'startTime\', \'>=\', admin.firestore.Timestamp.fromDate(cycleStart))\\r\\n      .where(\'startTime\', \'<=\', admin.firestore.Timestamp.fromDate(cycleEnd))\\r\\n      .get();\\r\\n\\r\\n    let assignedHours = 0;\\r\\n    let completedHours = 0;\\r\\n    const details = [];\\r\\n\\r\\n    shiftsSnapshot.forEach(doc => {\\r\\n      const shift = doc.data() as IShift;\\r\\n      const sStart = this.toDate(shift.startTime);\\r\\n      const sEnd = this.toDate(shift.endTime);\\r\\n      const duration = (sEnd.getTime() - sStart.getTime()) / (1000 * 60 * 60);\\r\\n      const status = shift.status;\\r\\n\\r\\n      // Asignadas: Todo lo que no est谩 cancelado ni completado (pendiente o en curso)\\r\\n      if (status !== \'Canceled\' && status !== \'Completed\') assignedHours += duration;\\r\\n      // Trabajadas: Solo lo completado\\r\\n      if (status === \'Completed\') completedHours += duration;\\r\\n      \\r\\n      details.push({\\r\\n        shiftId: doc.id,\\r\\n        objectiveName: shift.objectiveName,\\r\\n        duration: parseFloat(duration.toFixed(1)),\\r\\n        status: status,\\r\\n        date: sStart.toLocaleDateString(\'es-AR\'),\\r\\n        startTime: sStart.toLocaleTimeString(\'es-AR\', { hour: \'2-digit\', minute: \'2-digit\' }),\\r\\n      });\\r\\n    });\\r\\n\\r\\n    return {\\r\\n      assignedHours: parseFloat(assignedHours.toFixed(1)),\\r\\n      completedHours: parseFloat(completedHours.toFixed(1)),\\r\\n      maxHours,\\r\\n      cycleStart: cycleStart.toLocaleDateString(\'es-AR\'),\\r\\n      cycleEnd: cycleEnd.toLocaleDateString(\'es-AR\'),\\r\\n      details: details.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()),\\r\\n    };\\r\\n  }\\r\\n}\\n\\n\\n\\n"},{"id":"1osfhxu5r","name":"client.interface.ts","path":"apps\\\\web\\\\src\\\\common\\\\interfaces\\\\client.interface.ts","area":"FRONTEND","content":"import { Timestamp } from \'firebase/firestore\';\\r\\nimport { ReactNode } from \'react\';\\r\\n\\r\\nexport interface IClient {\\r\\n  id: string;\\r\\n  businessName: ReactNode;\\r\\n  cuit: ReactNode;\\r\\n  contactName: string;\\r\\n  contactEmail: ReactNode;\\r\\n  name: string;\\r\\n  status: \'Active\' | \'Inactive\';\\r\\n  createdAt: Timestamp;\\r\\n}\\r\\n\\r\\nexport interface IObjective {\\r\\n  id: string;\\r\\n  clientId: string;\\r\\n  name: string;\\r\\n  address: string;\\r\\n  location: { latitude: number; longitude: number; };\\r\\n  type: string;\\r\\n}\\r\\n\\r\\n//  CLAVE: IServiceContract con campos operativos\\r\\nexport interface IServiceContract {\\r\\n  id: string;\\r\\n  objectiveId: string;\\r\\n  name: string;        \\r\\n  totalHoursPerMonth: number;\\r\\n  isActive: boolean;\\r\\n  startDate: any; \\r\\n  endDate?: any;\\r\\n  quantity?: number;      // Dotaci贸n (Personas)\\r\\n  daysOfWeek?: number[];  // D铆as [0-6]\\r\\n}\\r\\n\\r\\nexport interface IShiftType {\\r\\n  id: string;\\r\\n  contractId: string;\\r\\n  name: string;       \\r\\n  code: string;       \\r\\n  color: string;\\r\\n  startTime: string;  \\r\\n  durationHours: number; \\r\\n  requiredRole?: string;\\r\\n}\\n\\n\\n\\n"},{"id":"5rbmjp90b","name":"employee.interface.ts","path":"apps\\\\web\\\\src\\\\common\\\\interfaces\\\\employee.interface.ts","area":"FRONTEND","content":"import { Timestamp } from \'firebase/firestore\'; \\r\\n// NOTA: En el backend (functions) cambia esta l铆nea por: import * as admin from \'firebase-admin\'; y usa admin.firestore.Timestamp\\r\\n\\r\\n/**\\r\\n * @description Define los roles de usuario dentro del sistema.\\r\\n */\\r\\nexport type EmployeeRole = \'admin\' | \'employee\';\\r\\n\\r\\n/**\\r\\n * @description Define los tipos de contrato laboral soportados.\\r\\n */\\r\\nexport type ContractType = \'FullTime\' | \'PartTime\' | \'Eventual\';\\r\\n\\r\\n/**\\r\\n *  NUEVO: Convenios Colectivos soportados para reglas de negocio.\\r\\n */\\r\\nexport type LaborAgreement = \'SUVICO\' | \'COMERCIO\' | \'UOCRA\' | \'FUERA_CONVENIO\';\\r\\n\\r\\n/**\\r\\n * @description Interfaz principal para la entidad Colaborador (Employee).\\r\\n */\\r\\nexport interface IEmployee {\\r\\n    uid: string; // Firebase Auth UID / Document ID\\r\\n    name: string;\\r\\n    role: EmployeeRole;\\r\\n    email: string;\\r\\n    \\r\\n    // Estado de disponibilidad general\\r\\n    isAvailable: boolean;\\r\\n    \\r\\n    // Configuraci贸n Laboral\\r\\n    maxHoursPerMonth: number; // L铆mite de horas contractuales (Soft Block)\\r\\n    contractType: ContractType;\\r\\n    \\r\\n    //  NUEVO CAMPO: Convenio Colectivo\\r\\n    laborAgreement: LaborAgreement; \\r\\n\\r\\n    // Campos para el Ciclo de N贸mina (RRHH)\\r\\n    payrollCycleStartDay?: number; // D铆a del mes en que comienza el ciclo (Ej: 15)\\r\\n    payrollCycleEndDay?: number;   // D铆a del mes en que finaliza el ciclo (Ej: 14)\\r\\n    \\r\\n    // Ubicaci贸n Organizacional\\r\\n    clientId?: string;       // Cliente asignado actualmente (Opcional)\\r\\n    businessUnitId?: string; // Unidad de Negocio\\r\\n\\r\\n    // Datos Personales\\r\\n    dni: string; \\r\\n    fileNumber: string; // Legajo\\r\\n    address: string; \\r\\n    phone?: string;     \\r\\n}\\r\\n\\r\\nexport interface IAbsence {\\r\\n    id: string;\\r\\n    employeeId: string;\\r\\n    employeeName: string;\\r\\n    clientId: string;\\r\\n    type: \'VACATION\' | \'SICK_LEAVE\' | \'OTHER\';\\r\\n    startDate: any; // Timestamp o Date\\r\\n    endDate: any;   // Timestamp o Date\\r\\n    reason: string;\\r\\n    status: \'PENDING\' | \'APPROVED\' | \'REJECTED\';\\r\\n    createdAt: any;\\r\\n}\\r\\n\\r\\nexport interface IAbsencePayload {\\r\\n    employeeId: string;\\r\\n    employeeName: string;\\r\\n    clientId: string;\\r\\n    type: \'VACATION\' | \'SICK_LEAVE\' | \'OTHER\';\\r\\n    startDate: Date; \\r\\n    endDate: Date;\\r\\n    reason: string;\\r\\n}\\n\\n\\n\\n"},{"id":"3cy6u2vd5","name":"service-pattern.interface.ts","path":"apps\\\\web\\\\src\\\\common\\\\interfaces\\\\service-pattern.interface.ts","area":"FRONTEND","content":"import * as admin from \'firebase-admin\';\\r\\n\\r\\n/**\\r\\n * @interface IServicePattern (El \\"Molde\\" Inteligente)\\r\\n * @description Define una regla de recurrencia para generar turnos autom谩ticamente.\\r\\n * Ej: \\"Necesito 2 Vigiladores (Turno Noche) todos los Lunes, Mi茅rcoles y Viernes\\".\\r\\n */\\r\\nexport interface IServicePattern {\\r\\n  id: string;\\r\\n  contractId: string;      // Vinculado al contrato \\"Seguridad Planta 2025\\"\\r\\n  shiftTypeId: string;     // Usa la modalidad \\"Turno Noche 12hs\\"\\r\\n  \\r\\n  // Configuraci贸n de Recurrencia\\r\\n  // 0=Dom, 1=Lun, ..., 6=Sab. Ej: [1,2,3,4,5] para Lun-Vie.\\r\\n  daysOfWeek: number[];    \\r\\n  \\r\\n  // Cantidad de recursos requeridos simult谩neamente\\r\\n  quantityPerDay: number;  \\r\\n  \\r\\n  // Vigencia de la regla\\r\\n  validFrom: admin.firestore.Timestamp;\\r\\n  validTo?: admin.firestore.Timestamp; // Si es null, es indefinido\\r\\n  \\r\\n  // Metadatos\\r\\n  createdAt: admin.firestore.Timestamp;\\r\\n  createdBy: string; // UID del planificador\\r\\n  active: boolean;\\r\\n}\\r\\n\\r\\n/**\\r\\n * Payload para crear/editar un patr贸n desde el Frontend\\r\\n */\\r\\nexport interface IPatternPayload {\\r\\n  contractId: string;\\r\\n  shiftTypeId: string;\\r\\n  daysOfWeek: number[];\\r\\n  quantity: number;\\r\\n  validFrom: string; // ISO String\\r\\n  validTo?: string;  // ISO String\\r\\n}\\n\\n\\n\\n"},{"id":"9ynsykry7","name":"shift.interface.ts","path":"apps\\\\web\\\\src\\\\common\\\\interfaces\\\\shift.interface.ts","area":"FRONTEND","content":"import { Timestamp } from \'firebase/firestore\';\\r\\n\\r\\n/**\\r\\n * @file shift.interface.ts\\r\\n * @description Definici贸n de la estructura de un Turno (Shift) compartido entre Frontend y Backend.\\r\\n */\\r\\n\\r\\n// Definimos un tipo flexible para las fechas para soportar:\\r\\n// 1. admin.firestore.Timestamp (Backend)\\r\\n// 2. firebase.firestore.Timestamp (Frontend SDK)\\r\\n// 3. Date (Objetos JS nativos tras conversi贸n)\\r\\n// 4. { seconds: number, nanoseconds: number } (JSON serializado)\\r\\nexport type FirestoreDate = any;\\r\\n\\r\\nexport type ShiftStatus = \'Assigned\' | \'Confirmed\' | \'InProgress\' | \'Completed\' | \'Canceled\';\\r\\n\\r\\nexport interface IShift {\\r\\n    id: string; // ID del documento en Firestore\\r\\n    \\r\\n    // Relaci贸n con Empleado\\r\\n    employeeId: string;\\r\\n    employeeName: string;\\r\\n    \\r\\n    // Relaci贸n con Objetivo (Cliente/Sede)\\r\\n    objectiveId: string;\\r\\n    objectiveName: string;\\r\\n    \\r\\n    // Tiempos\\r\\n    startTime: FirestoreDate;\\r\\n    endTime: FirestoreDate;\\r\\n    \\r\\n    // Estado del ciclo de vida\\r\\n    status: ShiftStatus;\\r\\n\\r\\n    // Datos opcionales de auditor铆a en el mismo documento (si aplica)\\r\\n    checkInTime?: FirestoreDate;\\r\\n    checkOutTime?: FirestoreDate;\\r\\n\\r\\n    // Metadatos\\r\\n    schedulerId: string;\\r\\n    updatedAt: FirestoreDate;\\r\\n\\r\\n    // Roles y Flags Visuales\\r\\n    role?: string;           // Ej: \'Vigilador\'\\r\\n    isOvertime?: boolean;    //  NUEVO: Indica si el turno excede horas (Visualizaci贸n mbar)\\r\\n}\\n\\n\\n\\n"},{"id":"asm2o4rln","name":"system-user.interface.ts","path":"apps\\\\web\\\\src\\\\common\\\\interfaces\\\\system-user.interface.ts","area":"FRONTEND","content":"import { Timestamp } from \'firebase/firestore\'; //  SDK CLIENTE (Importante para la Web)\\r\\n\\r\\n/**\\r\\n * Roles Jer谩rquicos del Sistema (RBAC):\\r\\n * - SuperAdmin: IT / Due帽o del SaaS. Acceso total.\\r\\n * - Manager: Gerente de Unidad. Ve todo dentro de su unidad.\\r\\n * - Scheduler: Planificador. Gestiona turnos y asignaciones.\\r\\n * - Supervisor: Campo. Gestiona incidencias y personal.\\r\\n * - Operator: Monitoreo. Solo lectura o vista de tablero en vivo.\\r\\n */\\r\\nexport type SystemRole = \\r\\n  | \'SuperAdmin\' \\r\\n  | \'Manager\' \\r\\n  | \'Scheduler\' \\r\\n  | \'Supervisor\' \\r\\n  | \'Operator\';\\r\\n\\r\\n/**\\r\\n * Interfaz de Usuario del Sistema (Frontend).\\r\\n * Define la estructura de los administradores que acceden al Back-Office.\\r\\n */\\r\\nexport interface ISystemUser {\\r\\n  uid: string;\\r\\n  email: string;\\r\\n  displayName: string;\\r\\n  role: SystemRole;\\r\\n  \\r\\n  // ID de la Unidad de Negocio a la que pertenece\\r\\n  // Si es undefined y el rol es SuperAdmin, tiene acceso global.\\r\\n  businessUnitId?: string; \\r\\n  \\r\\n  status: \'Active\' | \'Inactive\';\\r\\n  \\r\\n  // Fechas usando el tipo compatible con el SDK de Cliente\\r\\n  createdAt: Timestamp;\\r\\n  lastLogin?: Timestamp;\\r\\n}\\n\\n\\n\\n"},{"id":"gsdnjb4xi","name":"labor-agreement.interface.ts","path":"apps\\\\web\\\\src\\\\common\\\\labor-agreement.interface.ts","area":"FRONTEND","content":"import { Timestamp } from \'firebase/firestore\'; \\r\\n// En backend: import * as admin from \'firebase-admin\';\\r\\n\\r\\nexport interface ILaborAgreement {\\r\\n    id: string;\\r\\n    code: string;       // Ej: \'SUVICO\', \'UOCRA\'\\r\\n    name: string;       // Ej: \'Seguridad Privada 422/05\'\\r\\n    \\r\\n    // Reglas de Negocio (Lo que antes estaba fijo en c贸digo)\\r\\n    maxHoursWeekly: number;       // 48\\r\\n    maxHoursMonthly: number;      // 204\\r\\n    overtimeThresholdDaily: number; // 12\\r\\n    \\r\\n    // Configuraci贸n de Extras\\r\\n    saturdayCutoffHour: number;   // 13 (S谩bado Ingl茅s)\\r\\n    nightShiftStart: number;      // 21\\r\\n    nightShiftEnd: number;        // 6\\r\\n    \\r\\n    isActive: boolean;\\r\\n    createdAt?: any;\\r\\n}\\r\\n\\n\\n\\n\\n"},{"id":"q1gh0dedu","name":"AbsenceManagementPage.test.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\AbsenceManagementPage.test.tsx","area":"FRONTEND","content":"//  FIX 1: Importar jest-dom para habilitar los matchers del DOM\\r\\nimport \'@testing-library/jest-dom\';\\r\\nimport { render, screen, waitFor, fireEvent } from \'@testing-library/react\';\\r\\nimport { AbsenceManagementPage } from \'./AbsenceManagementPage\'; \\r\\nimport { useClient } from \'@/context/ClientContext\';\\r\\nimport { callCreateAbsence, callManageEmployees } from \'@/services/firebase-client.service\'; \\r\\nimport toast from \'react-hot-toast\';\\r\\n\\r\\n// Mocks de UI\\r\\njest.mock(\'../common/InputField\', () => ({\\r\\n    __esModule: true,\\r\\n    default: ({ label, onChange, value, type }: any) => (\\r\\n        <input aria-label={label} type={type || \'text\'} value={value} onChange={onChange} />\\r\\n    ),\\r\\n}));\\r\\n\\r\\njest.mock(\'../common/SelectField\', () => ({\\r\\n    __esModule: true,\\r\\n    default: ({ label, onChange, value, children }: any) => (\\r\\n        <select aria-label={label} value={value} onChange={onChange}>{children}</select>\\r\\n    ),\\r\\n}));\\r\\n\\r\\njest.mock(\'../common/Button\', () => ({\\r\\n    __esModule: true,\\r\\n    default: ({ children, disabled, type, onClick }: any) => (\\r\\n        <button disabled={disabled} type={type} onClick={onClick} data-testid=\\"submit-button\\">{children}</button>\\r\\n    ),\\r\\n}));\\r\\n\\r\\n// Mocks de servicios\\r\\njest.mock(\'@/context/ClientContext\', () => ({ useClient: jest.fn(), }));\\r\\njest.mock(\'@/services/firebase-client.service\', () => ({\\r\\n    callManageEmployees: jest.fn(),\\r\\n    callCreateAbsence: jest.fn(), \\r\\n}));\\r\\njest.mock(\'react-hot-toast\', () => ({\\r\\n    error: jest.fn(),\\r\\n    success: jest.fn(),\\r\\n    loading: jest.fn().mockReturnValue(\'toast-id-mock\'),\\r\\n}));\\r\\n\\r\\nconst mockEmployees = [\\r\\n    { uid: \'emp1\', name: \'Juan P茅rez\', role: \'Vigilador\' },\\r\\n];\\r\\n\\r\\nconst mockUseClient = (selectedClientId: string | null) => (\\r\\n    (useClient as jest.Mock).mockReturnValue({ selectedClientId })\\r\\n);\\r\\n\\r\\ndescribe(\'AbsenceManagementPage\', () => {\\r\\n    beforeEach(() => {\\r\\n        jest.clearAllMocks();\\r\\n        \\r\\n        //  FIX 2: Doble casting para silenciar a TypeScript\\r\\n        (callManageEmployees as unknown as jest.Mock).mockResolvedValue({\\r\\n            data: { data: mockEmployees },\\r\\n        });\\r\\n        (callCreateAbsence as unknown as jest.Mock).mockResolvedValue({\\r\\n            data: { success: true },\\r\\n        });\\r\\n        \\r\\n        mockUseClient(\'client_abc\'); \\r\\n    });\\r\\n\\r\\n    it(\'should render and fetch employees successfully\', async () => {\\r\\n        render(<AbsenceManagementPage />);\\r\\n        await waitFor(() => {\\r\\n            expect(callManageEmployees).toHaveBeenCalled();\\r\\n        });\\r\\n        // FIX 3: Usamos el matcher que ahora s铆 est谩 importado\\r\\n        expect(screen.getByLabelText(/Colaborador/i)).toBeInTheDocument();\\r\\n    });\\r\\n\\r\\n    it(\'should validate form dates\', async () => {\\r\\n        render(<AbsenceManagementPage />);\\r\\n        await waitFor(() => { expect(callManageEmployees).toHaveBeenCalled(); });\\r\\n\\r\\n        fireEvent.change(screen.getByLabelText(/Colaborador/i), { target: { value: \'emp1\' } });\\r\\n        fireEvent.change(screen.getByLabelText(/Raz贸n \\\\/ Comentarios/i), { target: { value: \'Test Reason\' } });\\r\\n        fireEvent.change(screen.getByLabelText(/Fecha de Inicio/i), { target: { value: \'2025-01-10\' } });\\r\\n        fireEvent.change(screen.getByLabelText(/Fecha de Fin/i), { target: { value: \'2025-01-01\' } });\\r\\n\\r\\n        fireEvent.click(screen.getByTestId(\'submit-button\'));\\r\\n\\r\\n        await waitFor(() => {\\r\\n            expect(toast.error).toHaveBeenCalled();\\r\\n        });\\r\\n        expect(callCreateAbsence).not.toHaveBeenCalled();\\r\\n    });\\r\\n\\r\\n    it(\'should submit successfully\', async () => {\\r\\n        render(<AbsenceManagementPage />);\\r\\n        await waitFor(() => { expect(callManageEmployees).toHaveBeenCalled(); });\\r\\n\\r\\n        fireEvent.change(screen.getByLabelText(/Colaborador/i), { target: { value: \'emp1\' } });\\r\\n        fireEvent.change(screen.getByLabelText(/Tipo de Novedad/i), { target: { value: \'SICK_LEAVE\' } });\\r\\n        fireEvent.change(screen.getByLabelText(/Fecha de Inicio/i), { target: { value: \'2025-01-01\' } });\\r\\n        fireEvent.change(screen.getByLabelText(/Fecha de Fin/i), { target: { value: \'2025-01-05\' } });\\r\\n        fireEvent.change(screen.getByLabelText(/Raz贸n \\\\/ Comentarios/i), { target: { value: \'Test Sick Leave\' } });\\r\\n\\r\\n        fireEvent.click(screen.getByTestId(\'submit-button\'));\\r\\n\\r\\n        await waitFor(() => {\\r\\n            expect(callCreateAbsence).toHaveBeenCalled();\\r\\n        });\\r\\n        expect(toast.success).toHaveBeenCalled();\\r\\n    });\\r\\n});\\n\\n\\n\\n"},{"id":"tn0uir3yd","name":"AbsenceManagementPage.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\AbsenceManagementPage.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport toast from \'react-hot-toast\';\\r\\nimport { useClient } from \'@/context/ClientContext\';\\r\\nimport { IAbsencePayload, IEmployee } from \'@/common/interfaces/employee.interface\';\\r\\nimport { createAbsence, callManageEmployees } from \'@/services/firebase-client.service\';\\r\\nimport InputField from \'@/components/common/InputField\'; \\r\\nimport SelectField from \'@/components/common/SelectField\';\\r\\nimport Button from \'@/components/common/Button\';\\r\\n\\r\\nconst ABSENCE_TYPES = [\\r\\n    { value: \'VACATION\', label: \'Vacaciones\' },\\r\\n    { value: \'SICK_LEAVE\', label: \'Licencia M茅dica\' },\\r\\n    { value: \'OTHER\', label: \'Otro / Personal\' },\\r\\n];\\r\\n\\r\\nexport function AbsenceManagementPage() {\\r\\n    const { selectedClientId, selectedClient } = useClient();\\r\\n    const [employees, setEmployees] = useState<IEmployee[]>([]);\\r\\n    const [isLoadingEmployees, setIsLoadingEmployees] = useState<boolean>(false);\\r\\n    const [isSubmitting, setIsSubmitting] = useState<boolean>(false);\\r\\n\\r\\n    // Estado inicial del formulario\\r\\n    const [formData, setFormData] = useState<IAbsencePayload>({\\r\\n        employeeId: \'\',\\r\\n        employeeName: \'\',\\r\\n        clientId: selectedClientId || \'\',\\r\\n        type: \'VACATION\',\\r\\n        startDate: new Date(),\\r\\n        endDate: new Date(),\\r\\n        reason: \'\',\\r\\n    });\\r\\n\\r\\n    // Sincronizar clientId cuando cambia la selecci贸n en el men煤\\r\\n    useEffect(() => {\\r\\n        setFormData(prev => ({ \\r\\n            ...prev, \\r\\n            clientId: selectedClientId || \'\', \\r\\n            employeeId: \'\', \\r\\n            employeeName: \'\' \\r\\n        }));\\r\\n    }, [selectedClientId]);\\r\\n\\r\\n    // Cargar Empleados (Filtrados por Empresa)\\r\\n    useEffect(() => {\\r\\n        const fetchEmployees = async () => {\\r\\n            if (!selectedClientId) {\\r\\n                setEmployees([]);\\r\\n                return;\\r\\n            }\\r\\n\\r\\n            setIsLoadingEmployees(true);\\r\\n            try {\\r\\n                const empRes = await callManageEmployees({ \\r\\n                    action: \'GET_ALL_EMPLOYEES\', \\r\\n                    payload: { clientId: selectedClientId } \\r\\n                });\\r\\n                \\r\\n                setEmployees((empRes.data as any).data || []); \\r\\n            } catch (error) {\\r\\n                console.error(\\"Error fetching employees:\\", error);\\r\\n                toast.error(\\"No se pudo cargar la lista de empleados.\\");\\r\\n            } finally {\\r\\n                setIsLoadingEmployees(false);\\r\\n            }\\r\\n        };\\r\\n        fetchEmployees();\\r\\n    }, [selectedClientId]);\\r\\n\\r\\n    const handleEmployeeChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\\r\\n        const selectedId = e.target.value;\\r\\n        const selectedEmployee = employees.find(emp => emp.uid === selectedId);\\r\\n\\r\\n        setFormData(prev => ({\\r\\n            ...prev,\\r\\n            employeeId: selectedId,\\r\\n            employeeName: selectedEmployee ? selectedEmployee.name : \'\'\\r\\n        }));\\r\\n    };\\r\\n\\r\\n    const handleDateChange = (name: keyof IAbsencePayload, value: string) => {\\r\\n        //  FIX CRTICO DE FECHAS:\\r\\n        // Al crear la fecha desde el string YYYY-MM-DD del input, agregamos T12:00:00.\\r\\n        // Esto evita que, por diferencias de zona horaria (UTC-3), la fecha \\"retroceda\\" un d铆a\\r\\n        // al guardarse. El backend luego forzar谩 00:00 y 23:59.\\r\\n        const dateValue = new Date(value + \'T12:00:00\'); \\r\\n        \\r\\n        setFormData(prev => ({\\r\\n            ...prev,\\r\\n            [name]: dateValue,\\r\\n        }));\\r\\n    };\\r\\n\\r\\n    const validateForm = (data: IAbsencePayload): boolean => {\\r\\n        if (!data.employeeId || !data.clientId || !data.type) {\\r\\n            toast.error(\\"Complete los campos obligatorios (Empleado, Tipo).\\");\\r\\n            return false;\\r\\n        }\\r\\n        if (data.startDate.getTime() > data.endDate.getTime()) {\\r\\n            toast.error(\\"La fecha de inicio no puede ser posterior a la de fin.\\");\\r\\n            return false;\\r\\n        }\\r\\n        if (!data.reason.trim()) {\\r\\n            toast.error(\\"Debe proporcionar una raz贸n o comentario.\\");\\r\\n            return false;\\r\\n        }\\r\\n        return true;\\r\\n    };\\r\\n\\r\\n    const handleSubmit = async (e: React.FormEvent) => {\\r\\n        e.preventDefault();\\r\\n        if (!validateForm(formData)) return;\\r\\n\\r\\n        setIsSubmitting(true);\\r\\n        const toastId = toast.loading(`Registrando ${formData.type}...`);\\r\\n\\r\\n        try {\\r\\n            // Enviamos al servicio (que llama a la Cloud Function)\\r\\n            // El backend se encarga de verificar conflictos y generar vacantes si es necesario\\r\\n            const res = await createAbsence({ action: \'CREATE_ABSENCE\', payload: formData });\\r\\n            \\r\\n            // Feedback Inteligente: Avisamos si hubo impacto operativo\\r\\n            if (res.impactedShiftsCount && res.impactedShiftsCount > 0) {\\r\\n                toast.success(\\r\\n                    `Novedad registrada.\\\\n锔 Se liberaron ${res.impactedShiftsCount} turnos que ahora son VACANTES.`,\\r\\n                    { id: toastId, duration: 6000, icon: \'锔\' }\\r\\n                );\\r\\n            } else {\\r\\n                toast.success(\\"Novedad registrada exitosamente.\\", { id: toastId });\\r\\n            }\\r\\n            \\r\\n            // Reset del formulario (mantenemos fechas hoy para agilidad)\\r\\n            setFormData(prev => ({ \\r\\n                ...prev, \\r\\n                type: \'VACATION\', \\r\\n                startDate: new Date(), \\r\\n                endDate: new Date(), \\r\\n                reason: \'\' \\r\\n            }));\\r\\n\\r\\n        } catch (error: any) {\\r\\n            console.error(\\"Absence creation failed:\\", error);\\r\\n            const message = error.message.includes(\'Conflicto\') || error.message.includes(\'BLOQUEO\')\\r\\n                ? error.message \\r\\n                : \\"Error al registrar la novedad. Intente nuevamente.\\";\\r\\n            toast.error(message, { id: toastId, duration: 5000 });\\r\\n        } finally {\\r\\n            setIsSubmitting(false);\\r\\n        }\\r\\n    };\\r\\n\\r\\n    if (!selectedClientId) {\\r\\n        return (\\r\\n            <div className=\\"flex flex-col items-center justify-center h-64 bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center\\">\\r\\n                <div className=\\"bg-orange-100 p-3 rounded-full mb-4\\">\\r\\n                    <svg className=\\"w-8 h-8 text-orange-500\\" fill=\\"none\\" stroke=\\"currentColor\\" viewBox=\\"0 0 24 24\\"><path strokeLinecap=\\"round\\" strokeLinejoin=\\"round\\" strokeWidth={2} d=\\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\\" /></svg>\\r\\n                </div>\\r\\n                <h3 className=\\"text-lg font-bold text-gray-800\\">Selecci贸n Requerida</h3>\\r\\n                <p className=\\"text-gray-500 mt-2\\">Por favor, seleccione una empresa en el men煤 lateral para gestionar las novedades de su personal.</p>\\r\\n            </div>\\r\\n        );\\r\\n    }\\r\\n\\r\\n    return (\\r\\n        <div className=\\"max-w-4xl mx-auto\\">\\r\\n            <div className=\\"mb-6 flex items-center justify-between\\">\\r\\n                <div>\\r\\n                    <h2 className=\\"text-2xl font-bold text-slate-800\\">Gesti贸n de Novedades</h2>\\r\\n                    <p className=\\"text-slate-500\\">Registrar licencias y vacaciones para <span className=\\"font-semibold text-indigo-600\\">{selectedClient?.businessName}</span>.</p>\\r\\n                </div>\\r\\n            </div>\\r\\n\\r\\n            <div className=\\"bg-white p-8 rounded-xl shadow-lg border border-slate-200\\">\\r\\n                <form onSubmit={handleSubmit} className=\\"space-y-6\\">\\r\\n                    \\r\\n                    <SelectField\\r\\n                        label=\\"Colaborador\\"\\r\\n                        id=\\"employeeId\\"\\r\\n                        value={formData.employeeId}\\r\\n                        onChange={handleEmployeeChange}\\r\\n                        disabled={isLoadingEmployees || isSubmitting}\\r\\n                        required\\r\\n                    >\\r\\n                        <option value=\\"\\" disabled>{isLoadingEmployees ? \'Cargando...\' : \'Seleccione un colaborador\'}</option>\\r\\n                        {employees.map(emp => (\\r\\n                            <option key={emp.uid} value={emp.uid}>\\r\\n                                {emp.name} (Leg: {emp.fileNumber || \'S/N\'})\\r\\n                            </option>\\r\\n                        ))}\\r\\n                    </SelectField>\\r\\n\\r\\n                    <SelectField\\r\\n                        label=\\"Tipo de Novedad\\"\\r\\n                        id=\\"type\\"\\r\\n                        value={formData.type}\\r\\n                        onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value as IAbsencePayload[\'type\'] }))}\\r\\n                        disabled={isSubmitting}\\r\\n                        required\\r\\n                    >\\r\\n                        {ABSENCE_TYPES.map(type => (\\r\\n                            <option key={type.value} value={type.value}>{type.label}</option>\\r\\n                        ))}\\r\\n                    </SelectField>\\r\\n\\r\\n                    <div className=\\"grid grid-cols-1 md:grid-cols-2 gap-6\\">\\r\\n                        <InputField\\r\\n                            label=\\"Fecha de Inicio\\"\\r\\n                            id=\\"startDate\\"\\r\\n                            type=\\"date\\"\\r\\n                            // .slice(0, 10) asegura formato YYYY-MM-DD\\r\\n                            value={formData.startDate.toISOString().slice(0, 10)}\\r\\n                            onChange={(e) => handleDateChange(\'startDate\', e.target.value)}\\r\\n                            disabled={isSubmitting}\\r\\n                            required\\r\\n                        />\\r\\n                        <InputField\\r\\n                            label=\\"Fecha de Fin\\"\\r\\n                            id=\\"endDate\\"\\r\\n                            type=\\"date\\"\\r\\n                            value={formData.endDate.toISOString().slice(0, 10)}\\r\\n                            onChange={(e) => handleDateChange(\'endDate\', e.target.value)}\\r\\n                            disabled={isSubmitting}\\r\\n                            required\\r\\n                        />\\r\\n                    </div>\\r\\n\\r\\n                    <InputField\\r\\n                        label=\\"Raz贸n / Comentarios\\"\\r\\n                        id=\\"reason\\"\\r\\n                        type=\\"textarea\\"\\r\\n                        value={formData.reason}\\r\\n                        onChange={(e) => setFormData(prev => ({ ...prev, reason: e.target.value }))}\\r\\n                        rows={3}\\r\\n                        disabled={isSubmitting}\\r\\n                        required\\r\\n                        placeholder=\\"Detalle el motivo de la ausencia...\\"\\r\\n                    />\\r\\n                    \\r\\n                    <div className=\\"flex justify-end pt-4 border-t border-gray-100\\">\\r\\n                        <Button type=\\"submit\\" disabled={isSubmitting || !formData.employeeId} primary className=\\"w-full md:w-auto\\">\\r\\n                            {isSubmitting ? (\\r\\n                                <span className=\\"flex items-center\\">\\r\\n                                    <svg className=\\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\\" fill=\\"none\\" viewBox=\\"0 0 24 24\\"><circle className=\\"opacity-25\\" cx=\\"12\\" cy=\\"12\\" r=\\"10\\" stroke=\\"currentColor\\" strokeWidth=\\"4\\"></circle><path className=\\"opacity-75\\" fill=\\"currentColor\\" d=\\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\\"></path></svg>\\r\\n                                    Validando y Registrando...\\r\\n                                </span>\\r\\n                            ) : \'Registrar Novedad\'}\\r\\n                        </Button>\\r\\n                    </div>\\r\\n                </form>\\r\\n            </div>\\r\\n        </div>\\r\\n    );\\r\\n}\\n\\n\\n\\n"},{"id":"nkaax97rt","name":"client-management.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\client-management.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport toast from \'react-hot-toast\';\\r\\nimport { callManageHierarchy } from \'@/services/firebase-client.service\';\\r\\nimport { IClient } from \'@/common/interfaces/client.interface\';\\r\\nimport InputField from \'@/components/common/InputField\';\\r\\nimport SelectField from \'@/components/common/SelectField\';\\r\\nimport Button from \'@/components/common/Button\';\\r\\nimport { useClient } from \'@/context/ClientContext\'; // Para recargar el contexto global al cambiar algo\\r\\n\\r\\nexport function ClientManagement() {\\r\\n  const { setClient } = useClient(); // Usamos esto para forzar recarga si es necesario\\r\\n  const [clients, setClients] = useState<IClient[]>([]);\\r\\n  const [loading, setLoading] = useState(true);\\r\\n  const [showModal, setShowModal] = useState(false);\\r\\n  const [isEditing, setIsEditing] = useState(false);\\r\\n  const [isSubmitting, setIsSubmitting] = useState(false);\\r\\n\\r\\n  // Estado del Formulario\\r\\n  const [formData, setFormData] = useState({\\r\\n    id: \'\',\\r\\n    businessName: \'\',\\r\\n    cuit: \'\',\\r\\n    contactName: \'\',\\r\\n    contactEmail: \'\',\\r\\n    status: \'Active\' as \'Active\' | \'Inactive\'\\r\\n  });\\r\\n\\r\\n  // 1. Cargar Clientes\\r\\n  const fetchClients = async () => {\\r\\n    setLoading(true);\\r\\n    try {\\r\\n      const res = await callManageHierarchy({ action: \'GET_ALL_CLIENTS\', payload: {} });\\r\\n      const data = (res.data as any).data || [];\\r\\n      setClients(data);\\r\\n    } catch (error) {\\r\\n      console.error(error);\\r\\n      toast.error(\\"Error al cargar la cartera de clientes.\\");\\r\\n    } finally {\\r\\n      setLoading(false);\\r\\n    }\\r\\n  };\\r\\n\\r\\n  useEffect(() => {\\r\\n    fetchClients();\\r\\n  }, []);\\r\\n\\r\\n  // 2. Manejadores del Modal\\r\\n  const handleOpenCreate = () => {\\r\\n    setFormData({ id: \'\', businessName: \'\', cuit: \'\', contactName: \'\', contactEmail: \'\', status: \'Active\' });\\r\\n    setIsEditing(false);\\r\\n    setShowModal(true);\\r\\n  };\\r\\n\\r\\n  const handleOpenEdit = (client: IClient) => {\\r\\n    setFormData({\\r\\n      id: client.id,\\r\\n      businessName: String(client.businessName),\\r\\n      cuit: String(client.cuit),\\r\\n      contactName: client.contactName || \'\',\\r\\n      contactEmail: String(client.contactEmail || \'\'),\\r\\n      status: client.status\\r\\n    });\\r\\n    setIsEditing(true);\\r\\n    setShowModal(true);\\r\\n  };\\r\\n\\r\\n  // 3. Guardar (Crear o Editar)\\r\\n  const handleSave = async (e: React.FormEvent) => {\\r\\n    e.preventDefault();\\r\\n    setIsSubmitting(true);\\r\\n    const toastId = toast.loading(isEditing ? \\"Actualizando...\\" : \\"Creando empresa...\\");\\r\\n\\r\\n    try {\\r\\n      if (isEditing) {\\r\\n        // UPDATE\\r\\n        await callManageHierarchy({ \\r\\n            action: \'UPDATE_CLIENT\', \\r\\n            payload: { \\r\\n                id: formData.id, \\r\\n                data: {\\r\\n                    businessName: formData.businessName,\\r\\n                    cuit: formData.cuit,\\r\\n                    contactName: formData.contactName,\\r\\n                    contactEmail: formData.contactEmail,\\r\\n                    status: formData.status\\r\\n                }\\r\\n            } \\r\\n        });\\r\\n        toast.success(\\"Empresa actualizada\\", { id: toastId });\\r\\n      } else {\\r\\n        // CREATE\\r\\n        await callManageHierarchy({ \\r\\n            action: \'CREATE_CLIENT\', \\r\\n            payload: {\\r\\n                businessName: formData.businessName,\\r\\n                cuit: formData.cuit,\\r\\n                contactName: formData.contactName,\\r\\n                contactEmail: formData.contactEmail,\\r\\n                status: formData.status\\r\\n            }\\r\\n        });\\r\\n        toast.success(\\"Empresa creada exitosamente\\", { id: toastId });\\r\\n      }\\r\\n      \\r\\n      setShowModal(false);\\r\\n      fetchClients(); // Recargar lista local\\r\\n      // Opcional: Recargar contexto global si fuera necesario\\r\\n      // setClient(\'\'); \\r\\n\\r\\n    } catch (error: any) {\\r\\n      console.error(error);\\r\\n      toast.error(`Error: ${error.message}`, { id: toastId });\\r\\n    } finally {\\r\\n        setIsSubmitting(false);\\r\\n    }\\r\\n  };\\r\\n\\r\\n  // 4. Eliminar\\r\\n  const handleDelete = async (id: string, name: string) => {\\r\\n    if (!confirm(`驴Est谩s seguro de eliminar a ${name}? Esto podr铆a romper datos hist贸ricos.`)) return;\\r\\n    \\r\\n    const toastId = toast.loading(\\"Eliminando...\\");\\r\\n    try {\\r\\n        await callManageHierarchy({ action: \'DELETE_CLIENT\', payload: { id } });\\r\\n        toast.success(\\"Empresa eliminada\\", { id: toastId });\\r\\n        fetchClients();\\r\\n    } catch (error: any) {\\r\\n        toast.error(`Error: ${error.message}`, { id: toastId });\\r\\n    }\\r\\n  };\\r\\n\\r\\n  return (\\r\\n    <div className=\\"space-y-6\\">\\r\\n      {/* Header de Secci贸n */}\\r\\n      <div className=\\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\\">\\r\\n        <div>\\r\\n            <h2 className=\\"text-2xl font-bold text-slate-800\\">Cartera de Clientes</h2>\\r\\n            <p className=\\"text-sm text-slate-500\\">Gestione las empresas contratantes.</p>\\r\\n        </div>\\r\\n        <Button onClick={handleOpenCreate} primary className=\\"flex items-center shadow-sm\\">\\r\\n            <svg className=\\"w-5 h-5 mr-2\\" fill=\\"none\\" viewBox=\\"0 0 24 24\\" stroke=\\"currentColor\\"><path strokeLinecap=\\"round\\" strokeLinejoin=\\"round\\" strokeWidth={2} d=\\"M12 4v16m8-8H4\\" /></svg>\\r\\n            Nueva Empresa\\r\\n        </Button>\\r\\n      </div>\\r\\n\\r\\n      {/* Tabla Responsiva */}\\r\\n      <div className=\\"bg-white shadow-sm rounded-xl border border-slate-200 overflow-hidden\\">\\r\\n        {loading ? (\\r\\n            <div className=\\"p-12 text-center text-slate-500 animate-pulse\\">Cargando cartera...</div>\\r\\n        ) : (\\r\\n            <div className=\\"overflow-x-auto\\">\\r\\n                <table className=\\"min-w-full divide-y divide-slate-200\\">\\r\\n                    <thead className=\\"bg-slate-50\\">\\r\\n                        <tr>\\r\\n                            <th className=\\"px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider\\">Raz贸n Social</th>\\r\\n                            <th className=\\"px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider\\">CUIT / ID</th>\\r\\n                            <th className=\\"px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider\\">Contacto</th>\\r\\n                            <th className=\\"px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider\\">Estado</th>\\r\\n                            <th className=\\"px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider\\">Acciones</th>\\r\\n                        </tr>\\r\\n                    </thead>\\r\\n                    <tbody className=\\"bg-white divide-y divide-slate-200\\">\\r\\n                        {clients.length === 0 && (\\r\\n                            <tr><td colSpan={5} className=\\"px-6 py-8 text-center text-slate-500 italic\\">No hay clientes registrados.</td></tr>\\r\\n                        )}\\r\\n                        {clients.map((client) => (\\r\\n                            <tr key={client.id} className=\\"hover:bg-slate-50 transition duration-150\\">\\r\\n                                <td className=\\"px-6 py-4 whitespace-nowrap\\">\\r\\n                                    <div className=\\"flex items-center\\">\\r\\n                                        <div className=\\"h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-sm mr-3\\">\\r\\n                                            {String(client.businessName).charAt(0)}\\r\\n                                        </div>\\r\\n                                        <div className=\\"text-sm font-bold text-slate-900\\">{client.businessName}</div>\\r\\n                                    </div>\\r\\n                                </td>\\r\\n                                <td className=\\"px-6 py-4 whitespace-nowrap text-sm text-slate-600 font-mono\\">\\r\\n                                    {client.cuit}<br/>\\r\\n                                    <span className=\\"text-[10px] text-slate-400\\">{client.id.substring(0,8)}...</span>\\r\\n                                </td>\\r\\n                                <td className=\\"px-6 py-4 whitespace-nowrap\\">\\r\\n                                    <div className=\\"text-sm text-slate-900\\">{client.contactName}</div>\\r\\n                                    <div className=\\"text-xs text-slate-500\\">{client.contactEmail}</div>\\r\\n                                </td>\\r\\n                                <td className=\\"px-6 py-4 whitespace-nowrap\\">\\r\\n                                    <span className={`px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${\\r\\n                                        client.status === \'Active\' ? \'bg-green-100 text-green-800\' : \'bg-red-100 text-red-800\'\\r\\n                                    }`}>\\r\\n                                        {client.status === \'Active\' ? \'Activo\' : \'Inactivo\'}\\r\\n                                    </span>\\r\\n                                </td>\\r\\n                                <td className=\\"px-6 py-4 whitespace-nowrap text-right text-sm font-medium\\">\\r\\n                                    <button onClick={() => handleOpenEdit(client)} className=\\"text-indigo-600 hover:text-indigo-900 mr-4 font-semibold\\">Editar</button>\\r\\n                                    <button onClick={() => handleDelete(client.id, String(client.businessName))} className=\\"text-rose-600 hover:text-rose-900 font-semibold\\">Eliminar</button>\\r\\n                                </td>\\r\\n                            </tr>\\r\\n                        ))}\\r\\n                    </tbody>\\r\\n                </table>\\r\\n            </div>\\r\\n        )}\\r\\n      </div>\\r\\n\\r\\n      {/* Modal CRUD */}\\r\\n      {showModal && (\\r\\n        <div className=\\"fixed inset-0 z-50 overflow-y-auto bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4\\">\\r\\n            <div className=\\"bg-white rounded-2xl shadow-xl max-w-lg w-full p-6 border border-slate-100 transform transition-all\\">\\r\\n                <div className=\\"flex justify-between items-center mb-6\\">\\r\\n                    <h3 className=\\"text-xl font-bold text-slate-800\\">{isEditing ? \'Editar Empresa\' : \'Nueva Empresa\'}</h3>\\r\\n                    <button onClick={() => setShowModal(false)} className=\\"text-slate-400 hover:text-slate-600\\">\\r\\n                        <svg className=\\"w-6 h-6\\" fill=\\"none\\" viewBox=\\"0 0 24 24\\" stroke=\\"currentColor\\"><path strokeLinecap=\\"round\\" strokeLinejoin=\\"round\\" strokeWidth={2} d=\\"M6 18L18 6M6 6l12 12\\" /></svg>\\r\\n                    </button>\\r\\n                </div>\\r\\n                \\r\\n                <form onSubmit={handleSave} className=\\"space-y-4\\">\\r\\n                    <InputField \\r\\n                        label=\\"Raz贸n Social\\" \\r\\n                        id=\\"businessName\\" \\r\\n                        value={formData.businessName} \\r\\n                        onChange={e => setFormData({...formData, businessName: e.target.value})} \\r\\n                        placeholder=\\"Ej: Seguridad Integral S.A.\\"\\r\\n                        required \\r\\n                    />\\r\\n                    \\r\\n                    <div className=\\"grid grid-cols-2 gap-4\\">\\r\\n                        <InputField \\r\\n                            label=\\"CUIT\\" \\r\\n                            id=\\"cuit\\" \\r\\n                            value={formData.cuit} \\r\\n                            onChange={e => setFormData({...formData, cuit: e.target.value})} \\r\\n                            placeholder=\\"30-12345678-9\\"\\r\\n                            required \\r\\n                        />\\r\\n                        <SelectField \\r\\n                            label=\\"Estado\\" \\r\\n                            id=\\"status\\" \\r\\n                            value={formData.status} \\r\\n                            onChange={e => setFormData({...formData, status: e.target.value as any})}\\r\\n                        >\\r\\n                            <option value=\\"Active\\">Activo</option>\\r\\n                            <option value=\\"Inactive\\">Inactivo</option>\\r\\n                        </SelectField>\\r\\n                    </div>\\r\\n\\r\\n                    <div className=\\"pt-4 border-t border-slate-100\\">\\r\\n                        <h4 className=\\"text-sm font-semibold text-slate-500 uppercase mb-3\\">Datos de Contacto</h4>\\r\\n                        <div className=\\"space-y-4\\">\\r\\n                            <InputField \\r\\n                                label=\\"Nombre Contacto\\" \\r\\n                                id=\\"contactName\\" \\r\\n                                value={formData.contactName} \\r\\n                                onChange={e => setFormData({...formData, contactName: e.target.value})} \\r\\n                                placeholder=\\"Ej: Juan Gerente\\"\\r\\n                            />\\r\\n                            <InputField \\r\\n                                label=\\"Email Contacto\\" \\r\\n                                id=\\"contactEmail\\" \\r\\n                                type=\\"email\\"\\r\\n                                value={formData.contactEmail} \\r\\n                                onChange={e => setFormData({...formData, contactEmail: e.target.value})} \\r\\n                                placeholder=\\"contacto@empresa.com\\"\\r\\n                            />\\r\\n                        </div>\\r\\n                    </div>\\r\\n\\r\\n                    <div className=\\"flex justify-end space-x-3 mt-8 pt-2\\">\\r\\n                        <button type=\\"button\\" onClick={() => setShowModal(false)} className=\\"px-4 py-2 text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 font-medium transition-colors\\">\\r\\n                            Cancelar\\r\\n                        </button>\\r\\n                        <Button type=\\"submit\\" primary disabled={isSubmitting}>\\r\\n                            {isSubmitting ? \'Guardando...\' : \'Guardar Empresa\'}\\r\\n                        </Button>\\r\\n                    </div>\\r\\n                </form>\\r\\n            </div>\\r\\n        </div>\\r\\n      )}\\r\\n    </div>\\r\\n  );\\r\\n}\\n\\n\\n\\n"},{"id":"q12wptj4f","name":"client-setup-wizard.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\client-setup-wizard.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport { useRouter } from \'next/router\';\\r\\nimport { callManageHierarchy, createPattern } from \'@/services/firebase-client.service\';\\r\\nimport toast from \'react-hot-toast\';\\r\\nimport { \\r\\n    Building2, MapPin, FileText, Clock, CheckCircle2, \\r\\n    ArrowRight, Plus, Calendar, Calculator, AlertTriangle\\r\\n} from \'lucide-react\';\\r\\n\\r\\ninterface ShiftTypeUI {\\r\\n  name: string;\\r\\n  code: string;\\r\\n  startTime: string;\\r\\n  durationHours: number;\\r\\n}\\r\\n\\r\\nexport function ClientSetupWizard() {\\r\\n  const router = useRouter();\\r\\n  const [step, setStep] = useState(1);\\r\\n  const [loading, setLoading] = useState(false);\\r\\n  \\r\\n  const [ids, setIds] = useState({ clientId: \'\', objectiveId: \'\', contractId: \'\' });\\r\\n  const [addedShifts, setAddedShifts] = useState<ShiftTypeUI[]>([]);\\r\\n\\r\\n  // STATES\\r\\n  const [clientData, setClientData] = useState({ businessName: \'\', cuit: \'\', contactName: \'\', contactEmail: \'\' });\\r\\n  const [objData, setObjData] = useState({ name: \'\', address: \'\', latitude: \'\', longitude: \'\' });\\r\\n  \\r\\n  //  FIX: Estado extendido para el contrato (D铆as y Fechas)\\r\\n  const [contractData, setContractData] = useState({ \\r\\n      name: \'\', \\r\\n      totalHoursPerMonth: 720,\\r\\n      startDate: new Date().toISOString().split(\'T\')[0], // Default Hoy YYYY-MM-DD\\r\\n      endDate: \'\',\\r\\n      daysOfWeek: [1, 2, 3, 4, 5] // Default Lunes a Viernes\\r\\n  });\\r\\n  \\r\\n  const [shiftData, setShiftData] = useState<ShiftTypeUI>({ \\r\\n    name: \'Turno Ma帽ana\', \\r\\n    code: \'TM\', \\r\\n    startTime: \'06:00\', \\r\\n    durationHours: 8 \\r\\n  });\\r\\n\\r\\n  // --- CALCULADORA EN TIEMPO REAL ---\\r\\n  const [metrics, setMetrics] = useState({ totalVacancies: 0, totalHours: 0 });\\r\\n\\r\\n  useEffect(() => {\\r\\n      // Calculamos proyecci贸n solo si hay fechas y turnos\\r\\n      if (!contractData.startDate || addedShifts.length === 0) return;\\r\\n      \\r\\n      const start = new Date(contractData.startDate);\\r\\n      // Si hay fecha fin la usamos, sino proyectamos a fin de mes de la fecha de inicio\\r\\n      const end = contractData.endDate \\r\\n          ? new Date(contractData.endDate) \\r\\n          : new Date(start.getFullYear(), start.getMonth() + 1, 0);\\r\\n\\r\\n      let workingDaysCount = 0;\\r\\n      \\r\\n      // Iterar d铆as para contar h谩biles seg煤n configuraci贸n\\r\\n      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {\\r\\n          // getDay(): 0=Dom, 1=Lun...\\r\\n          if (contractData.daysOfWeek.includes(d.getDay())) {\\r\\n              workingDaysCount++;\\r\\n          }\\r\\n      }\\r\\n\\r\\n      // Total Turnos Diarios (Suma de todas las modalidades)\\r\\n      // Asumimos 1 persona por modalidad (si fueran m谩s, habr铆a que agregar campo \'quantity\' al shiftData)\\r\\n      const shiftsPerDay = addedShifts.length; \\r\\n      const totalHoursPerDay = addedShifts.reduce((acc, curr) => acc + curr.durationHours, 0);\\r\\n\\r\\n      setMetrics({\\r\\n          totalVacancies: workingDaysCount * shiftsPerDay,\\r\\n          totalHours: workingDaysCount * totalHoursPerDay\\r\\n      });\\r\\n\\r\\n  }, [contractData, addedShifts]);\\r\\n\\r\\n  // --- HANDLERS ---\\r\\n\\r\\n  const handleCreateClient = async (e: React.FormEvent) => {\\r\\n    e.preventDefault();\\r\\n    setLoading(true);\\r\\n    try {\\r\\n      const res = await callManageHierarchy({ action: \'CREATE_CLIENT\', payload: { ...clientData, status: \'Active\' } });\\r\\n      const data = res.data as any;\\r\\n      setIds(prev => ({ ...prev, clientId: data.data.id }));\\r\\n      toast.success(\\"Empresa registrada\\");\\r\\n      setStep(2);\\r\\n    } catch (error: any) { toast.error(error.message); } \\r\\n    finally { setLoading(false); }\\r\\n  };\\r\\n\\r\\n  const handleCreateObjective = async (e: React.FormEvent) => {\\r\\n    e.preventDefault();\\r\\n    setLoading(true);\\r\\n    try {\\r\\n      const payload = {\\r\\n        ...objData,\\r\\n        clientId: ids.clientId,\\r\\n        location: { latitude: Number(objData.latitude), longitude: Number(objData.longitude) },\\r\\n        type: \'Sede\'\\r\\n      };\\r\\n      const res = await callManageHierarchy({ action: \'CREATE_OBJECTIVE\', payload });\\r\\n      const data = res.data as any;\\r\\n      setIds(prev => ({ ...prev, objectiveId: data.data.id }));\\r\\n      toast.success(\\"Sede creada\\");\\r\\n      setStep(3);\\r\\n    } catch (error: any) { toast.error(error.message); } \\r\\n    finally { setLoading(false); }\\r\\n  };\\r\\n\\r\\n  //  PASO 3 CORREGIDO: Env铆a fechas y d铆as reales\\r\\n  const handleCreateContract = async (e: React.FormEvent) => {\\r\\n    e.preventDefault();\\r\\n    setLoading(true);\\r\\n    try {\\r\\n      const payload = {\\r\\n        objectiveId: ids.objectiveId,\\r\\n        name: contractData.name,\\r\\n        totalHoursPerMonth: contractData.totalHoursPerMonth,\\r\\n        startDate: new Date(contractData.startDate).toISOString(),\\r\\n        endDate: contractData.endDate ? new Date(contractData.endDate).toISOString() : undefined,\\r\\n        daysOfWeek: contractData.daysOfWeek, // Enviamos el array elegido\\r\\n        quantity: 1, // Dotaci贸n base por turno (simplificado)\\r\\n        isActive: true\\r\\n      };\\r\\n      \\r\\n      const res = await callManageHierarchy({ action: \'CREATE_CONTRACT\', payload });\\r\\n      const data = res.data as any;\\r\\n      setIds(prev => ({ ...prev, contractId: data.data.id }));\\r\\n      \\r\\n      toast.success(\\"Contrato configurado\\");\\r\\n      setStep(4);\\r\\n    } catch (error: any) { toast.error(error.message); } \\r\\n    finally { setLoading(false); }\\r\\n  };\\r\\n\\r\\n  const handleCreateShiftType = async (e: React.FormEvent) => {\\r\\n    e.preventDefault();\\r\\n    setLoading(true);\\r\\n    try {\\r\\n      // 1. Crear Tipo de Turno\\r\\n      const payload = { ...shiftData, contractId: ids.contractId, color: \'#3B82F6\' };\\r\\n      const resShift = await callManageHierarchy({ action: \'CREATE_SHIFT_TYPE\', payload });\\r\\n      const shiftTypeData = (resShift.data as any).data;\\r\\n\\r\\n      // 2.  Crear Patr贸n Autom谩tico usando la configuraci贸n del contrato (Paso 3)\\r\\n      await createPattern({\\r\\n          contractId: ids.contractId,\\r\\n          shiftTypeId: shiftTypeData.id,\\r\\n          daysOfWeek: contractData.daysOfWeek, // Usamos los d铆as elegidos en Paso 3\\r\\n          quantity: 1, \\r\\n          validFrom: new Date(contractData.startDate).toISOString(), // Fecha inicio real\\r\\n          validTo: contractData.endDate ? new Date(contractData.endDate).toISOString() : undefined\\r\\n      });\\r\\n      \\r\\n      toast.success(\\"Modalidad y Regla agregadas\\");\\r\\n      setAddedShifts(prev => [...prev, shiftData]);\\r\\n      \\r\\n      // Reset form sugerido\\r\\n      let nextTime = \'06:00\';\\r\\n      if (shiftData.startTime === \'06:00\') nextTime = \'14:00\';\\r\\n      if (shiftData.startTime === \'14:00\') nextTime = \'22:00\';\\r\\n\\r\\n      setShiftData({ \\r\\n        name: \'\', \\r\\n        code: \'\', \\r\\n        startTime: nextTime, \\r\\n        durationHours: 8 \\r\\n      });\\r\\n\\r\\n    } catch (error: any) { toast.error(error.message); } \\r\\n    finally { setLoading(false); }\\r\\n  };\\r\\n\\r\\n  const handleFinish = () => {\\r\\n    toast.success(\\"隆Configuraci贸n lista!\\");\\r\\n    router.push(\'/admin/dashboard\');\\r\\n  };\\r\\n\\r\\n  // Helper para toggle de d铆as\\r\\n  const toggleDay = (dayIndex: number) => {\\r\\n      setContractData(prev => {\\r\\n          const exists = prev.daysOfWeek.includes(dayIndex);\\r\\n          const newDays = exists \\r\\n              ? prev.daysOfWeek.filter(d => d !== dayIndex)\\r\\n              : [...prev.daysOfWeek, dayIndex].sort();\\r\\n          return { ...prev, daysOfWeek: newDays };\\r\\n      });\\r\\n  };\\r\\n\\r\\n  const inputClass = \\"w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2.5 px-3 border mt-1 text-sm\\";\\r\\n  const labelClass = \\"block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1\\";\\r\\n  const btnClass = \\"w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-bold shadow-md flex justify-center items-center gap-2 disabled:opacity-50\\";\\r\\n\\r\\n  return (\\r\\n    <div className=\\"max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-100 my-8\\">\\r\\n      \\r\\n      <div className=\\"flex justify-between mb-8 relative px-4\\">\\r\\n        <div className=\\"absolute top-1/2 left-0 w-full h-0.5 bg-slate-100 -z-10 rounded\\"></div>\\r\\n        {[\'Empresa\', \'Sede\', \'Contrato\', \'Turnos\'].map((label, i) => {\\r\\n            const num = i + 1;\\r\\n            return (\\r\\n                <div key={num} className=\\"flex flex-col items-center gap-2 bg-white px-2\\">\\r\\n                    <div className={`w-8 h-8 rounded-full flex items-center justify-center border-2 transition-colors ${step >= num ? \'bg-indigo-600 border-indigo-600 text-white\' : \'border-slate-200 text-slate-300\'}`}>\\r\\n                        {step > num ? <CheckCircle2 size={16}/> : num}\\r\\n                    </div>\\r\\n                    <span className=\\"text-[10px] uppercase font-bold text-slate-400\\">{label}</span>\\r\\n                </div>\\r\\n            )\\r\\n        })}\\r\\n      </div>\\r\\n\\r\\n      <div className=\\"min-h-[300px]\\">\\r\\n          {step === 1 && (\\r\\n            <form onSubmit={handleCreateClient} className=\\"space-y-4 animate-fadeIn\\">\\r\\n                <h2 className=\\"text-xl font-bold text-slate-800\\">Datos de la Empresa</h2>\\r\\n                <div><label className={labelClass}>Raz贸n Social</label><input className={inputClass} value={clientData.businessName} onChange={e => setClientData({...clientData, businessName: e.target.value})} required autoFocus /></div>\\r\\n                <div><label className={labelClass}>CUIT</label><input className={inputClass} value={clientData.cuit} onChange={e => setClientData({...clientData, cuit: e.target.value})} required /></div>\\r\\n                <button type=\\"submit\\" disabled={loading} className={btnClass}>{loading ? \'...\' : \'Siguiente\'}</button>\\r\\n            </form>\\r\\n          )}\\r\\n\\r\\n          {step === 2 && (\\r\\n            <form onSubmit={handleCreateObjective} className=\\"space-y-4 animate-fadeIn\\">\\r\\n                <h2 className=\\"text-xl font-bold text-slate-800\\">Ubicaci贸n del Servicio</h2>\\r\\n                <div><label className={labelClass}>Nombre Sede</label><input className={inputClass} value={objData.name} onChange={e => setObjData({...objData, name: e.target.value})} required /></div>\\r\\n                <div><label className={labelClass}>Direcci贸n</label><input className={inputClass} value={objData.address} onChange={e => setObjData({...objData, address: e.target.value})} required /></div>\\r\\n                <div className=\\"grid grid-cols-2 gap-4\\">\\r\\n                    <div><label className={labelClass}>Latitud</label><input type=\\"number\\" className={inputClass} value={objData.latitude} onChange={e => setObjData({...objData, latitude: e.target.value})} step=\\"any\\" required/></div>\\r\\n                    <div><label className={labelClass}>Longitud</label><input type=\\"number\\" className={inputClass} value={objData.longitude} onChange={e => setObjData({...objData, longitude: e.target.value})} step=\\"any\\" required/></div>\\r\\n                </div>\\r\\n                <button type=\\"submit\\" disabled={loading} className={btnClass}>{loading ? \'...\' : \'Siguiente\'}</button>\\r\\n            </form>\\r\\n          )}\\r\\n\\r\\n          {/*  PASO 3: CONFIGURACIN CRTICA DE FECHAS Y DAS */}\\r\\n          {step === 3 && (\\r\\n            <form onSubmit={handleCreateContract} className=\\"space-y-5 animate-fadeIn\\">\\r\\n                <h2 className=\\"text-xl font-bold text-slate-800\\">Definici贸n del Acuerdo</h2>\\r\\n                \\r\\n                <div className=\\"grid grid-cols-2 gap-4\\">\\r\\n                    <div className=\\"col-span-2\\"><label className={labelClass}>Nombre Servicio</label><input className={inputClass} value={contractData.name} onChange={e => setContractData({...contractData, name: e.target.value})} required /></div>\\r\\n                    <div><label className={labelClass}>Horas Mensuales (Vendidas)</label><input type=\\"number\\" className={inputClass} value={contractData.totalHoursPerMonth} onChange={e => setContractData({...contractData, totalHoursPerMonth: +e.target.value})} required /></div>\\r\\n                </div>\\r\\n\\r\\n                <div className=\\"bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-4\\">\\r\\n                    <div className=\\"flex items-center gap-2 text-indigo-700 text-sm font-bold border-b border-slate-200 pb-2 mb-2\\">\\r\\n                        <Calendar size={16}/> Vigencia y Cobertura\\r\\n                    </div>\\r\\n                    <div className=\\"grid grid-cols-2 gap-4\\">\\r\\n                        <div><label className={labelClass}>Fecha Inicio</label><input type=\\"date\\" className={inputClass} value={contractData.startDate} onChange={e => setContractData({...contractData, startDate: e.target.value})} required /></div>\\r\\n                        <div><label className={labelClass}>Fecha Fin (Opcional)</label><input type=\\"date\\" className={inputClass} value={contractData.endDate} onChange={e => setContractData({...contractData, endDate: e.target.value})} /></div>\\r\\n                    </div>\\r\\n                    \\r\\n                    <div>\\r\\n                        <label className={labelClass}>D铆as de Cobertura</label>\\r\\n                        <div className=\\"flex justify-between mt-2\\">\\r\\n                            {[\'D\',\'L\',\'M\',\'M\',\'J\',\'V\',\'S\'].map((day, i) => (\\r\\n                                <button \\r\\n                                    key={i} \\r\\n                                    type=\\"button\\"\\r\\n                                    onClick={() => toggleDay(i)}\\r\\n                                    className={`w-9 h-9 rounded-lg text-xs font-bold transition-all ${contractData.daysOfWeek.includes(i) ? \'bg-indigo-600 text-white shadow-md scale-110\' : \'bg-white border border-slate-200 text-slate-400\'}`}\\r\\n                                >\\r\\n                                    {day}\\r\\n                                </button>\\r\\n                            ))}\\r\\n                        </div>\\r\\n                    </div>\\r\\n                </div>\\r\\n\\r\\n                <button type=\\"submit\\" disabled={loading} className={btnClass}>{loading ? \'Guardando...\' : \'Confirmar Configuraci贸n\'}</button>\\r\\n            </form>\\r\\n          )}\\r\\n\\r\\n          {step === 4 && (\\r\\n            <div className=\\"space-y-6 animate-fadeIn\\">\\r\\n                \\r\\n                {/*  CALCULADORA PREDICTIVA */}\\r\\n                <div className=\\"bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl p-5 text-white shadow-lg relative overflow-hidden\\">\\r\\n                    <div className=\\"relative z-10 flex justify-between items-center\\">\\r\\n                        <div>\\r\\n                            <p className=\\"text-xs text-slate-400 font-bold uppercase flex items-center gap-2\\"><Calculator size={14}/> Proyecci贸n Mensual</p>\\r\\n                            <div className=\\"mt-1 flex items-baseline gap-2\\">\\r\\n                                <span className={`text-2xl font-bold ${metrics.totalHours > contractData.totalHoursPerMonth ? \'text-red-400\' : \'text-emerald-400\'}`}>\\r\\n                                    {metrics.totalHours} hs\\r\\n                                </span>\\r\\n                                <span className=\\"text-slate-500\\">/ {contractData.totalHoursPerMonth} hs</span>\\r\\n                            </div>\\r\\n                            <p className=\\"text-xs text-slate-400 mt-1\\">\\r\\n                                {metrics.totalVacancies} Vacantes totales ({addedShifts.length} turnos x {metrics.totalVacancies / (addedShifts.length || 1)} d铆as)\\r\\n                            </p>\\r\\n                        </div>\\r\\n                        {metrics.totalHours > contractData.totalHoursPerMonth && (\\r\\n                            <div className=\\"bg-red-500/20 p-2 rounded-lg border border-red-500/50 text-red-300\\">\\r\\n                                <AlertTriangle size={20} />\\r\\n                            </div>\\r\\n                        )}\\r\\n                    </div>\\r\\n                </div>\\r\\n\\r\\n                <div className=\\"bg-white p-5 rounded-xl border border-slate-200 shadow-sm\\">\\r\\n                    <h3 className=\\"text-sm font-bold text-slate-700 mb-3 uppercase\\">Agregar Modalidad</h3>\\r\\n                    <div className=\\"grid grid-cols-2 gap-4 mb-4\\">\\r\\n                        <input className={inputClass} value={shiftData.name} onChange={e => setShiftData({...shiftData, name: e.target.value})} placeholder=\\"Nombre (ej: Ma帽ana)\\" />\\r\\n                        <input className={inputClass} value={shiftData.code} onChange={e => setShiftData({...shiftData, code: e.target.value})} placeholder=\\"C贸digo (ej: TM)\\" />\\r\\n                        <input type=\\"time\\" className={inputClass} value={shiftData.startTime} onChange={e => setShiftData({...shiftData, startTime: e.target.value})} />\\r\\n                        <input type=\\"number\\" className={inputClass} value={shiftData.durationHours} onChange={e => setShiftData({...shiftData, durationHours: +e.target.value})} placeholder=\\"Horas\\" />\\r\\n                    </div>\\r\\n                    <button onClick={handleCreateShiftType} disabled={loading || !shiftData.name} className=\\"w-full bg-slate-100 text-slate-700 py-2.5 rounded-lg hover:bg-slate-200 font-bold transition flex justify-center items-center gap-2 border border-slate-200\\">\\r\\n                        <Plus size={16}/> Agregar Turno\\r\\n                    </button>\\r\\n                </div>\\r\\n\\r\\n                {addedShifts.length > 0 && (\\r\\n                    <div className=\\"space-y-2\\">\\r\\n                        {addedShifts.map((shift, i) => (\\r\\n                            <div key={i} className=\\"flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100 text-sm\\">\\r\\n                                <span className=\\"font-bold text-slate-700\\">{shift.name}</span>\\r\\n                                <span className=\\"font-mono text-xs bg-white px-2 py-1 rounded border\\">{shift.startTime} ({shift.durationHours}h)</span>\\r\\n                            </div>\\r\\n                        ))}\\r\\n                    </div>\\r\\n                )}\\r\\n                \\r\\n                <button onClick={handleFinish} className=\\"w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-bold shadow-md\\">\\r\\n                    Finalizar y Ver Planificador\\r\\n                </button>\\r\\n            </div>\\r\\n          )}\\r\\n      </div>\\r\\n    </div>\\r\\n  );\\r\\n}\\n\\n\\n\\n"},{"id":"hf0cspacr","name":"employee-management.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\employee-management.tsx","area":"FRONTEND","content":"import React, { useState, useEffect, useRef } from \'react\';\\r\\nimport { callManageEmployees, callCreateUser } from \'@/services/firebase-client.service\';\\r\\nimport { IEmployee, LaborAgreement } from \'@/common/interfaces/employee.interface\';\\r\\nimport toast from \'react-hot-toast\';\\r\\nimport { useClient } from \'@/context/ClientContext\'; \\r\\nimport InputField from \'@/components/common/InputField\';\\r\\nimport SelectField from \'@/components/common/SelectField\';\\r\\nimport Button from \'@/components/common/Button\'; \\r\\nimport { Clock, AlertTriangle, Edit2, Trash2, Briefcase, FileText, Upload, Download, FileSpreadsheet, PieChart } from \'lucide-react\';\\r\\n\\r\\ninterface WorkloadReport {\\r\\n    assignedHours: number;\\r\\n    completedHours: number;\\r\\n    maxHours: number;\\r\\n    cycleStart: string;\\r\\n    cycleEnd: string;\\r\\n    details: Array<{ shiftId: string, objectiveName: string, duration: number, status: string, date: string, startTime: string }>;\\r\\n}\\r\\n\\r\\nexport function EmployeeManagement() {\\r\\n  const { clients, selectedClientId } = useClient();\\r\\n  const [employees, setEmployees] = useState<IEmployee[]>([]);\\r\\n  const [loading, setLoading] = useState(true);\\r\\n  \\r\\n  // Estados de Modales\\r\\n  const [showModal, setShowModal] = useState(false);\\r\\n  const [showImportModal, setShowImportModal] = useState(false); //  MODAL NUEVO\\r\\n  \\r\\n  // Estados de Edici贸n\\r\\n  const [isEditing, setIsEditing] = useState(false);\\r\\n  const [isSubmitting, setIsSubmitting] = useState(false);\\r\\n  const fileInputRef = useRef<HTMLInputElement>(null);\\r\\n\\r\\n  // Estados del Reporte de Auditor铆a\\r\\n  const [showWorkloadModal, setShowWorkloadModal] = useState(false);\\r\\n  const [selectedEmployeeReport, setSelectedEmployeeReport] = useState<IEmployee | null>(null);\\r\\n  const [workloadReport, setWorkloadReport] = useState<WorkloadReport | null>(null);\\r\\n  const [reportLoading, setReportLoading] = useState(false);\\r\\n\\r\\n  // Estado del Formulario\\r\\n  const [formData, setFormData] = useState({\\r\\n    uid: \'\',\\r\\n    name: \'\',\\r\\n    email: \'\',\\r\\n    password: \'\',\\r\\n    role: \'employee\',\\r\\n    maxHoursPerMonth: 176,\\r\\n    contractType: \'FullTime\',\\r\\n    laborAgreement: \'SUVICO\' as LaborAgreement, //  NUEVO CAMPO\\r\\n    isAvailable: true,\\r\\n    clientId: \'\', \\r\\n    dni: \'\',\\r\\n    fileNumber: \'\',\\r\\n    address: \'\',\\r\\n    payrollCycleStartDay: 1,\\r\\n    payrollCycleEndDay: 0,\\r\\n  });\\r\\n\\r\\n  // --- CARGA DE DATOS ---\\r\\n  const fetchEmployees = async () => {\\r\\n    setLoading(true);\\r\\n    try {\\r\\n      const res = await callManageEmployees({ action: \'GET_ALL_EMPLOYEES\', payload: {} });\\r\\n      const data = (res.data as any).data || [];\\r\\n      setEmployees(data);\\r\\n    } catch (error) {\\r\\n      console.error(error);\\r\\n      toast.error(\\"Error al cargar la n贸mina.\\");\\r\\n    } finally {\\r\\n      setLoading(false);\\r\\n    }\\r\\n  };\\r\\n\\r\\n  useEffect(() => {\\r\\n    fetchEmployees();\\r\\n  }, []);\\r\\n\\r\\n  const getClientName = (id?: string) => {\\r\\n      if (!id) return <span className=\\"text-gray-400 italic\\">Sin Asignaci贸n (Pool)</span>;\\r\\n      const client = clients.find(c => c.id === id);\\r\\n      return client ? (\\r\\n          <span className=\\"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-100\\">\\r\\n              {client.businessName}\\r\\n          </span>\\r\\n      ) : <span className=\\"text-red-400\\">Cliente desconocido</span>;\\r\\n  };\\r\\n\\r\\n  // --- LGICA DE IMPORTACIN MASIVA (NUEVA) ---\\r\\n  const handleDownloadTemplate = () => {\\r\\n      const headers = \\"nombre,email,dni,legajo,direccion,convenio,modalidad,horas_mensuales,inicio_ciclo\\\\n\\";\\r\\n      const example = \\"Juan Perez,juan@mail.com,12345678,L-100,Av Colon 500,SUVICO,FullTime,176,1\\";\\r\\n      const blob = new Blob([headers + example], { type: \'text/csv\' });\\r\\n      const url = window.URL.createObjectURL(blob);\\r\\n      const a = document.createElement(\'a\');\\r\\n      a.href = url;\\r\\n      a.download = \'plantilla_empleados.csv\';\\r\\n      a.click();\\r\\n  };\\r\\n\\r\\n  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\\r\\n      const file = e.target.files?.[0];\\r\\n      if (!file) return;\\r\\n\\r\\n      const reader = new FileReader();\\r\\n      reader.onload = async (event) => {\\r\\n          const text = event.target?.result as string;\\r\\n          const rows = text.split(\'\\\\n\').slice(1); // Ignorar header\\r\\n          \\r\\n          const parsedData = rows.map(row => {\\r\\n              const [name, email, dni, legajo, direccion, convenio, modalidad, horas, ciclo] = row.split(\',\');\\r\\n              if (!email || !dni) return null; // Filtrar filas vac铆as\\r\\n              return {\\r\\n                  name: name?.trim(),\\r\\n                  email: email?.trim(),\\r\\n                  dni: dni?.trim(),\\r\\n                  legajo: legajo?.trim(),\\r\\n                  direccion: direccion?.trim(),\\r\\n                  convenio: convenio?.trim(),\\r\\n                  modalidad: modalidad?.trim(),\\r\\n                  horas_mensuales: horas?.trim(),\\r\\n                  inicio_ciclo: ciclo?.trim()\\r\\n              };\\r\\n          }).filter(Boolean);\\r\\n\\r\\n          if (parsedData.length === 0) {\\r\\n              toast.error(\\"El archivo parece estar vac铆o o tiene formato incorrecto.\\");\\r\\n              return;\\r\\n          }\\r\\n\\r\\n          if(!confirm(`Se encontraron ${parsedData.length} registros v谩lidos.\\\\n驴Proceder con la importaci贸n?\\\\n\\\\nNota: La contrase帽a inicial ser谩 el DNI.`)) return;\\r\\n\\r\\n          const toastId = toast.loading(`Importando ${parsedData.length} empleados...`);\\r\\n          try {\\r\\n              const res = await callManageEmployees({ \\r\\n                  action: \'IMPORT_EMPLOYEES\', \\r\\n                  payload: { rows: parsedData } \\r\\n              });\\r\\n              const result = (res.data as any).data;\\r\\n              toast.success(`Importaci贸n finalizada.\\\\n xitos: ${result.success}`, { id: toastId, duration: 5000 });\\r\\n              \\r\\n              if(result.errors.length > 0) {\\r\\n                  console.warn(\\"Errores de importaci贸n:\\", result.errors);\\r\\n                  toast(\\"Hubo algunos errores, revise la consola.\\", { icon: \'锔\' });\\r\\n              }\\r\\n              \\r\\n              setShowImportModal(false);\\r\\n              fetchEmployees();\\r\\n          } catch (error: any) {\\r\\n              toast.error(\\"Error cr铆tico en importaci贸n: \\" + error.message, { id: toastId });\\r\\n          }\\r\\n          \\r\\n          // Limpiar input\\r\\n          if (fileInputRef.current) fileInputRef.current.value = \'\';\\r\\n      };\\r\\n      reader.readAsText(file);\\r\\n  };\\r\\n\\r\\n  // --- LGICA DE REPORTES ---\\r\\n  const handleOpenWorkloadReport = async (emp: IEmployee) => {\\r\\n      setSelectedEmployeeReport(emp);\\r\\n      setShowWorkloadModal(true);\\r\\n      setReportLoading(true);\\r\\n      setWorkloadReport(null);\\r\\n\\r\\n      try {\\r\\n          const today = new Date();\\r\\n          const res = await callManageEmployees({\\r\\n              action: \'GET_WORKLOAD_REPORT\',\\r\\n              payload: { \\r\\n                  uid: emp.uid, \\r\\n                  month: today.getMonth() + 1, \\r\\n                  year: today.getFullYear()\\r\\n              }\\r\\n          });\\r\\n          setWorkloadReport((res.data as any).data as WorkloadReport);\\r\\n      } catch (e: any) {\\r\\n          toast.error(\\"Error al cargar reporte: \\" + e.message);\\r\\n      } finally {\\r\\n          setReportLoading(false);\\r\\n      }\\r\\n  };\\r\\n\\r\\n  // --- LGICA DE CRUD (FORMULARIO) ---\\r\\n  const handleOpenCreate = () => {\\r\\n    setFormData({ \\r\\n        uid: \'\', name: \'\', email: \'\', password: \'\', role: \'employee\', \\r\\n        maxHoursPerMonth: 176, contractType: \'FullTime\', laborAgreement: \'SUVICO\', isAvailable: true,\\r\\n        clientId: selectedClientId || \'\', \\r\\n        dni: \'\', fileNumber: \'\', address: \'\',\\r\\n        payrollCycleStartDay: 1, \\r\\n        payrollCycleEndDay: 0,\\r\\n    });\\r\\n    setIsEditing(false);\\r\\n    setShowModal(true);\\r\\n  };\\r\\n\\r\\n  const handleOpenEdit = (emp: IEmployee) => {\\r\\n    setFormData({\\r\\n        uid: emp.uid,\\r\\n        name: emp.name,\\r\\n        email: emp.email,\\r\\n        password: \'\', \\r\\n        role: emp.role as string,\\r\\n        maxHoursPerMonth: emp.maxHoursPerMonth || 176,\\r\\n        contractType: emp.contractType || \'FullTime\',\\r\\n        laborAgreement: emp.laborAgreement || \'SUVICO\',\\r\\n        isAvailable: emp.isAvailable,\\r\\n        clientId: emp.clientId || \'\',\\r\\n        dni: emp.dni || \'\',\\r\\n        fileNumber: emp.fileNumber || \'\',\\r\\n        address: emp.address || \'\',\\r\\n        payrollCycleStartDay: emp.payrollCycleStartDay || 1,\\r\\n        payrollCycleEndDay: emp.payrollCycleEndDay || 0,\\r\\n    });\\r\\n    setIsEditing(true);\\r\\n    setShowModal(true);\\r\\n  };\\r\\n\\r\\n  const handleSave = async (e: React.FormEvent) => {\\r\\n    e.preventDefault();\\r\\n    setIsSubmitting(true);\\r\\n    const toastId = toast.loading(isEditing ? \\"Actualizando...\\" : \\"Creando recurso...\\");\\r\\n\\r\\n    try {\\r\\n      if (isEditing) {\\r\\n        const updatePayload = {\\r\\n            name: formData.name,\\r\\n            role: formData.role,\\r\\n            maxHoursPerMonth: Number(formData.maxHoursPerMonth),\\r\\n            contractType: formData.contractType,\\r\\n            laborAgreement: formData.laborAgreement,\\r\\n            isAvailable: formData.isAvailable,\\r\\n            clientId: formData.clientId,\\r\\n            dni: formData.dni,\\r\\n            fileNumber: formData.fileNumber,\\r\\n            address: formData.address,\\r\\n            payrollCycleStartDay: Number(formData.payrollCycleStartDay),\\r\\n            payrollCycleEndDay: Number(formData.payrollCycleEndDay),\\r\\n        };\\r\\n        await callManageEmployees({ action: \'UPDATE_EMPLOYEE\', payload: { uid: formData.uid, data: updatePayload } });\\r\\n        toast.success(\\"Ficha actualizada correctamente\\", { id: toastId });\\r\\n      } else {\\r\\n        await callCreateUser({ \\r\\n            email: formData.email, password: formData.password, name: formData.name, role: formData.role,\\r\\n            clientId: formData.clientId, dni: formData.dni, fileNumber: formData.fileNumber, address: formData.address,\\r\\n        });\\r\\n        toast.success(\\"Empleado creado exitosamente\\", { id: toastId });\\r\\n      }\\r\\n      \\r\\n      setShowModal(false);\\r\\n      fetchEmployees();\\r\\n\\r\\n    } catch (error: any) {\\r\\n      console.error(error);\\r\\n      toast.error(`Error: ${error.message}`, { id: toastId });\\r\\n    } finally {\\r\\n      setIsSubmitting(false);\\r\\n    }\\r\\n  };\\r\\n\\r\\n  const handleDelete = async (uid: string) => {\\r\\n    if (!confirm(\\"驴Eliminar este empleado? Esta acci贸n borrar谩 su acceso.\\")) return;\\r\\n    try {\\r\\n        await callManageEmployees({ action: \'DELETE_EMPLOYEE\', payload: { uid } });\\r\\n        toast.success(\\"Empleado eliminado\\");\\r\\n        fetchEmployees();\\r\\n    } catch (error) {\\r\\n        toast.error(\\"Error al eliminar\\");\\r\\n    }\\r\\n  };\\r\\n\\r\\n  //  HELPER VISUAL: Agrupa horas por objetivo para el reporte\\r\\n  const getHoursByObjective = (details: any[]) => {\\r\\n      const summary: Record<string, number> = {};\\r\\n      details.forEach(d => {\\r\\n          const name = d.objectiveName === \'Sede\' ? \'Sede (Gen茅rico)\' : d.objectiveName;\\r\\n          summary[name] = (summary[name] || 0) + d.duration;\\r\\n      });\\r\\n      return Object.entries(summary).map(([name, hours]) => ({ name, hours }));\\r\\n  };\\r\\n\\r\\n  return (\\r\\n    <div className=\\"space-y-6\\">\\r\\n      \\r\\n      {/* 1. HEADER CON BOTONES DE ACCIN */}\\r\\n      <div className=\\"flex justify-between items-center bg-white p-4 rounded-xl border border-gray-200 shadow-sm\\">\\r\\n        <div>\\r\\n            <h2 className=\\"text-xl font-bold text-gray-800\\">N贸mina Global de Personal</h2>\\r\\n            <p className=\\"text-sm text-gray-500\\">Gesti贸n del pool de recursos de la agencia.</p>\\r\\n        </div>\\r\\n        <div className=\\"flex gap-3\\">\\r\\n            {/*  BOTN DE IMPORTACIN (NUEVO) */}\\r\\n            <Button \\r\\n                onClick={() => setShowImportModal(true)} \\r\\n                className=\\"bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 flex items-center gap-2 shadow-sm\\"\\r\\n            >\\r\\n                <Upload size={18} className=\\"text-green-600\\"/> Importar CSV\\r\\n            </Button>\\r\\n            \\r\\n            {/* Bot贸n Nuevo Recurso */}\\r\\n            <Button onClick={handleOpenCreate} primary className=\\"flex items-center gap-2 shadow-sm\\">\\r\\n                <span className=\\"text-lg font-bold\\">+</span> Nuevo Recurso\\r\\n            </Button>\\r\\n        </div>\\r\\n      </div>\\r\\n\\r\\n      {/* 2. TABLA DE EMPLEADOS */}\\r\\n      <div className=\\"bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden\\">\\r\\n        <div className=\\"overflow-x-auto\\">\\r\\n            <table className=\\"min-w-full divide-y divide-gray-200\\">\\r\\n                <thead className=\\"bg-gray-50\\">\\r\\n                    <tr>\\r\\n                        <th className=\\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase\\">Legajo / Nombre</th>\\r\\n                        <th className=\\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase\\">Asignaci贸n</th>\\r\\n                        <th className=\\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase\\">Convenio</th>\\r\\n                        <th className=\\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase\\">Estado</th>\\r\\n                        <th className=\\"px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase\\">Acciones</th>\\r\\n                    </tr>\\r\\n                </thead>\\r\\n                <tbody className=\\"bg-white divide-y divide-gray-200\\">\\r\\n                    {employees.map((emp) => (\\r\\n                        <tr key={emp.uid} className=\\"hover:bg-gray-50 transition-colors\\">\\r\\n                            <td \\r\\n                                onClick={() => handleOpenWorkloadReport(emp)}\\r\\n                                className=\\"px-6 py-4 whitespace-nowrap cursor-pointer hover:bg-indigo-50/50\\"\\r\\n                                title=\\"Ver auditor铆a de horas\\"\\r\\n                            >\\r\\n                                <div className=\\"text-xs text-gray-400 font-mono mb-0.5\\">#{emp.fileNumber || \'S/N\'}</div>\\r\\n                                <div className=\\"text-sm font-bold text-gray-900\\">{emp.name}</div>\\r\\n                                <div className=\\"text-xs text-indigo-600 capitalize\\">{emp.role}</div>\\r\\n                            </td>\\r\\n                            <td className=\\"px-6 py-4 whitespace-nowrap\\">\\r\\n                                {getClientName(emp.clientId)}\\r\\n                            </td>\\r\\n                            <td className=\\"px-6 py-4 whitespace-nowrap\\">\\r\\n                                <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${\\r\\n                                    emp.laborAgreement === \'SUVICO\' ? \'bg-blue-50 text-blue-700 border-blue-200\' :\\r\\n                                    emp.laborAgreement === \'UOCRA\' ? \'bg-orange-50 text-orange-700 border-orange-200\' :\\r\\n                                    \'bg-slate-100 text-slate-600 border-slate-200\'\\r\\n                                }`}>\\r\\n                                    <FileText size={10} className=\\"mr-1.5\\"/>\\r\\n                                    {emp.laborAgreement || \'SUVICO\'}\\r\\n                                </span>\\r\\n                            </td>\\r\\n                            <td className=\\"px-6 py-4 whitespace-nowrap text-sm\\">\\r\\n                                {emp.isAvailable ? \\r\\n                                <span className=\\"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800\\">Activo</span> : \\r\\n                                    <span className=\\"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800\\">Inactivo</span>\\r\\n                                }\\r\\n                            </td>\\r\\n                            <td className=\\"px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-end items-center gap-2\\">\\r\\n                                <button onClick={() => handleOpenWorkloadReport(emp)} className=\\"text-blue-600 hover:text-blue-900 mr-2 font-semibold flex items-center bg-blue-50 px-2 py-1.5 rounded hover:bg-blue-100 transition-colors\\" title=\\"Ver Horas\\">\\r\\n                                    <Clock size={14} className=\\"mr-1\\"/> Horas\\r\\n                                </button>\\r\\n                                <button onClick={() => handleOpenEdit(emp)} className=\\"text-gray-500 hover:text-indigo-600 p-1.5 hover:bg-gray-100 rounded-lg transition-colors\\" title=\\"Editar\\">\\r\\n                                    <Edit2 size={18}/>\\r\\n                                </button>\\r\\n                                <button onClick={() => handleDelete(emp.uid)} className=\\"text-gray-400 hover:text-red-600 p-1.5 hover:bg-gray-100 rounded-lg transition-colors\\" title=\\"Eliminar\\">\\r\\n                                    <Trash2 size={18}/>\\r\\n                                </button>\\r\\n                            </td>\\r\\n                        </tr>\\r\\n                    ))}\\r\\n                </tbody>\\r\\n            </table>\\r\\n            {!loading && employees.length === 0 && (\\r\\n                <div className=\\"p-12 text-center text-gray-500 flex flex-col items-center\\">\\r\\n                    <Briefcase size={48} className=\\"text-gray-300 mb-3\\"/>\\r\\n                    <p>No hay empleados registrados en el sistema.</p>\\r\\n                    <p className=\\"text-sm mt-2\\">Utilice el bot贸n \\"Nuevo\\" o \\"Importar CSV\\".</p>\\r\\n                </div>\\r\\n            )}\\r\\n        </div>\\r\\n      </div>\\r\\n\\r\\n      {/* 3. MODAL DE IMPORTACIN (NUEVO) */}\\r\\n      {showImportModal && (\\r\\n        <div className=\\"fixed inset-0 z-50 overflow-y-auto bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200\\">\\r\\n            <div className=\\"bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 border border-gray-100 transform scale-100 transition-all\\">\\r\\n                <div className=\\"flex justify-between items-center mb-6 border-b pb-4\\">\\r\\n                    <h3 className=\\"text-xl font-bold text-gray-800 flex items-center gap-2\\">\\r\\n                        <FileSpreadsheet className=\\"text-green-600\\"/> Importaci贸n Masiva\\r\\n                    </h3>\\r\\n                    <button onClick={() => setShowImportModal(false)} className=\\"text-gray-400 hover:text-gray-600 transition-colors\\"></button>\\r\\n                </div>\\r\\n                \\r\\n                <div className=\\"space-y-6\\">\\r\\n                    <div className=\\"bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800\\">\\r\\n                        <p className=\\"font-bold mb-2 flex items-center gap-2\\"><Briefcase size={16}/> Instrucciones:</p>\\r\\n                        <ul className=\\"list-disc list-inside space-y-1 ml-1 text-blue-700\\">\\r\\n                            <li>Descargue la plantilla CSV modelo.</li>\\r\\n                            <li>Complete los datos respetando las columnas.</li>\\r\\n                            <li>La <strong>contrase帽a inicial</strong> ser谩 el DNI del empleado.</li>\\r\\n                        </ul>\\r\\n                    </div>\\r\\n\\r\\n                    <div className=\\"flex gap-4\\">\\r\\n                        <button \\r\\n                            onClick={handleDownloadTemplate} \\r\\n                            className=\\"flex-1 flex items-center justify-center gap-2 py-3 border-2 border-dashed border-gray-300 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition-colors text-gray-600 font-medium\\"\\r\\n                        >\\r\\n                            <Download size={20}/> Descargar Plantilla\\r\\n                        </button>\\r\\n                        \\r\\n                        <label className=\\"flex-1 flex items-center justify-center gap-2 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-bold cursor-pointer shadow-md active:scale-95\\">\\r\\n                            <Upload size={20}/> Subir Archivo\\r\\n                            <input \\r\\n                                type=\\"file\\" \\r\\n                                accept=\\".csv\\" \\r\\n                                className=\\"hidden\\" \\r\\n                                ref={fileInputRef} \\r\\n                                onChange={handleFileUpload} \\r\\n                            />\\r\\n                        </label>\\r\\n                    </div>\\r\\n                </div>\\r\\n            </div>\\r\\n        </div>\\r\\n      )}\\r\\n\\r\\n      {/* 4. MODAL DE FORMULARIO (CREAR/EDITAR) */}\\r\\n      {showModal && (\\r\\n        <div className=\\"fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 backdrop-blur-sm\\">\\r\\n            <div className=\\"bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 border border-gray-100 transform transition-all\\">\\r\\n                <div className=\\"flex justify-between items-center mb-6 border-b border-gray-100 pb-4\\">\\r\\n                    <h3 className=\\"text-xl font-bold text-gray-800\\">{isEditing ? \'Editar Ficha\' : \'Alta de Personal\'}</h3>\\r\\n                    <button onClick={() => setShowModal(false)} className=\\"text-gray-400 hover:text-gray-600\\"></button>\\r\\n                </div>\\r\\n                \\r\\n                <form onSubmit={handleSave} className=\\"grid grid-cols-1 md:grid-cols-2 gap-5\\">\\r\\n                    <div className=\\"md:col-span-2\\">\\r\\n                        <h4 className=\\"text-xs font-bold text-indigo-600 uppercase tracking-wider mb-3\\">Informaci贸n Personal</h4>\\r\\n                    </div>\\r\\n\\r\\n                    <InputField label=\\"Nombre Completo\\" id=\\"name\\" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required />\\r\\n                    <InputField label=\\"DNI\\" id=\\"dni\\" value={formData.dni} onChange={e => setFormData({...formData, dni: e.target.value})} required placeholder=\\"Sin puntos\\" />\\r\\n                    <div className=\\"md:col-span-2\\">\\r\\n                        <InputField label=\\"Direcci贸n Real\\" id=\\"address\\" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} required />\\r\\n                    </div>\\r\\n\\r\\n                    {!isEditing && (\\r\\n                        <>\\r\\n                            <div className=\\"md:col-span-2 mt-2\\">\\r\\n                                <h4 className=\\"text-xs font-bold text-indigo-600 uppercase tracking-wider mb-3\\">Acceso al Sistema</h4>\\r\\n                            </div>\\r\\n                            <InputField label=\\"Email\\" id=\\"email\\" type=\\"email\\" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required />\\r\\n                            <InputField label=\\"Contrase帽a Inicial\\" id=\\"password\\" type=\\"password\\" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} required />\\r\\n                        </>\\r\\n                    )}\\r\\n\\r\\n                    <div className=\\"md:col-span-2 mt-2\\">\\r\\n                        <h4 className=\\"text-xs font-bold text-indigo-600 uppercase tracking-wider mb-3\\">Contrataci贸n y Asignaci贸n</h4>\\r\\n                    </div>\\r\\n\\r\\n                    <InputField label=\\"Nro. Legajo\\" id=\\"fileNumber\\" value={formData.fileNumber} onChange={e => setFormData({...formData, fileNumber: e.target.value})} required />\\r\\n\\r\\n                    <SelectField label=\\"Empresa Principal (Opcional)\\" id=\\"clientId\\" value={formData.clientId} onChange={e => setFormData({...formData, clientId: e.target.value})}>\\r\\n                        <option value=\\"\\">-- Sin Asignaci贸n (Pool) --</option>\\r\\n                        {clients.map(c => <option key={c.id} value={c.id}>{c.businessName}</option>)}\\r\\n                    </SelectField>\\r\\n\\r\\n                    <SelectField label=\\"Convenio Colectivo\\" id=\\"laborAgreement\\" value={formData.laborAgreement} onChange={e => setFormData({...formData, laborAgreement: e.target.value as any})}>\\r\\n                        <option value=\\"SUVICO\\">Seguridad (SUVICO)</option>\\r\\n                        <option value=\\"COMERCIO\\">Administrativos (Comercio)</option>\\r\\n                        <option value=\\"UOCRA\\">Construcci贸n (UOCRA)</option>\\r\\n                        <option value=\\"FUERA_CONVENIO\\">Fuera de Convenio</option>\\r\\n                    </SelectField>\\r\\n\\r\\n                    <SelectField label=\\"Modalidad\\" id=\\"contract\\" value={formData.contractType} onChange={e => setFormData({...formData, contractType: e.target.value})}>\\r\\n                        <option value=\\"FullTime\\">Full Time</option>\\r\\n                        <option value=\\"PartTime\\">Part Time</option>\\r\\n                        <option value=\\"Eventual\\">Eventual</option>\\r\\n                    </SelectField>\\r\\n\\r\\n                    <InputField label=\\"L铆mite Horas Mensual\\" id=\\"maxHours\\" type=\\"number\\" value={formData.maxHoursPerMonth} onChange={e => setFormData({...formData, maxHoursPerMonth: Number(e.target.value)})} required />\\r\\n\\r\\n                    <div className=\\"md:col-span-2 border p-3 rounded-lg bg-yellow-50/50 border-yellow-200\\">\\r\\n                        <h5 className=\\"text-xs font-bold text-yellow-800 mb-2\\">Ciclo de N贸mina</h5>\\r\\n                        <div className=\\"grid grid-cols-2 gap-4\\">\\r\\n                            <SelectField label=\\"D铆a Inicio de Ciclo\\" id=\\"cycleStart\\" value={formData.payrollCycleStartDay} onChange={e => setFormData({...formData, payrollCycleStartDay: Number(e.target.value)})}>\\r\\n                                <option value={1}>D铆a 1 (Calendario Est谩ndar)</option>\\r\\n                                {Array.from({ length: 31 }, (_, i) => i + 1).map(day => <option key={day} value={day}>D铆a {day}</option>)}\\r\\n                            </SelectField>\\r\\n                            <SelectField label=\\"D铆a Fin de Ciclo\\" id=\\"cycleEnd\\" value={formData.payrollCycleEndDay} onChange={e => setFormData({...formData, payrollCycleEndDay: Number(e.target.value)})}>\\r\\n                                <option value={0}>ltimo D铆a del Mes (Est谩ndar)</option>\\r\\n                                {Array.from({ length: 31 }, (_, i) => i + 1).map(day => <option key={day} value={day}>D铆a {day}</option>)}\\r\\n                            </SelectField>\\r\\n                        </div>\\r\\n                    </div>\\r\\n                    \\r\\n                    <div className=\\"md:col-span-2 flex justify-end space-x-3 mt-6 border-t pt-4\\">\\r\\n                        <button type=\\"button\\" onClick={() => setShowModal(false)} className=\\"px-5 py-2.5 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium transition\\">\\r\\n                            Cancelar\\r\\n                        </button>\\r\\n                        <Button type=\\"submit\\" primary disabled={isSubmitting}>\\r\\n                            {isSubmitting ? \'Guardando...\' : \'Guardar Ficha\'}\\r\\n                        </Button>\\r\\n                    </div>\\r\\n                </form>\\r\\n            </div>\\r\\n        </div>\\r\\n      )}\\r\\n\\r\\n      {/* 5. MODAL DE REPORTE (AUDITORA DE HORAS) */}\\r\\n      {showWorkloadModal && selectedEmployeeReport && (\\r\\n          <div className=\\"fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200\\">\\r\\n              <div className=\\"bg-white rounded-xl shadow-2xl max-w-3xl w-full p-6 border border-gray-100 transform transition-all scale-100\\">\\r\\n                  <div className=\\"flex justify-between items-center mb-6 border-b border-gray-100 pb-4\\">\\r\\n                      <h3 className=\\"text-xl font-bold text-gray-800\\">Ficha de Recurso y Auditor铆a de Horas</h3>\\r\\n                      <button onClick={() => setShowWorkloadModal(false)} className=\\"text-gray-400 hover:text-gray-600 transition-colors\\"></button>\\r\\n                  </div>\\r\\n                  \\r\\n                  <h4 className=\\"text-lg font-bold text-indigo-700 mb-4\\">{selectedEmployeeReport.name} ({selectedEmployeeReport.dni})</h4>\\r\\n\\r\\n                  {reportLoading ? (\\r\\n                      <div className=\\"p-10 text-center text-gray-500 animate-pulse\\">Calculando reporte del mes...</div>\\r\\n                  ) : workloadReport ? (\\r\\n                      <div className=\\"space-y-6\\">\\r\\n                          \\r\\n                          {/* Info General */}\\r\\n                          <div className=\'grid grid-cols-2 gap-4 text-sm\'>\\r\\n                              <div className=\'p-3 bg-gray-50 rounded\'>\\r\\n                                  <p className=\'text-xs text-gray-500 font-bold uppercase\'>Legajo / Email</p>\\r\\n                                  <p>{selectedEmployeeReport.fileNumber || \'S/N\'} / {selectedEmployeeReport.email}</p>\\r\\n                              </div>\\r\\n                              <div className=\'p-3 bg-gray-50 rounded\'>\\r\\n                                  <p className=\'text-xs text-gray-500 font-bold uppercase\'>Direcci贸n</p>\\r\\n                                  <p>{selectedEmployeeReport.address || \'N/A\'}</p>\\r\\n                              </div>\\r\\n                          </div>\\r\\n\\r\\n                          {/* Periodo y Ciclo */}\\r\\n                          <div className=\'p-3 bg-indigo-50 rounded-xl border border-indigo-100\'>\\r\\n                             <p className=\'text-xs font-bold text-indigo-600 uppercase\'>Per铆odo de C谩lculo</p>\\r\\n                             <p className=\'text-sm mt-1\'>\\r\\n                                 {workloadReport.cycleStart} al {workloadReport.cycleEnd}\\r\\n                                 <span className=\'text-xs text-gray-500 ml-2\'>(Definido por Ciclo de N贸mina)</span>\\r\\n                             </p>\\r\\n                          </div>\\r\\n                          \\r\\n                          {/* KPIs Principales */}\\r\\n                          <div className=\\"grid grid-cols-3 gap-4\\">\\r\\n                              <div className=\\"p-4 bg-indigo-50 rounded-xl border border-indigo-100\\">\\r\\n                                  <p className=\\"text-xs font-bold text-indigo-600 uppercase\\">L铆mite Contratado</p>\\r\\n                                  <p className=\\"text-2xl font-bold mt-1\\">{workloadReport.maxHours} hs</p>\\r\\n                              </div>\\r\\n                              <div className=\\"p-4 bg-yellow-50 rounded-xl border border-yellow-100\\">\\r\\n                                  <p className=\\"text-xs font-bold text-yellow-600 uppercase\\">Horas Asignadas</p>\\r\\n                                  <p className=\\"text-2xl font-bold mt-1\\">{workloadReport.assignedHours} hs</p>\\r\\n                                  {workloadReport.assignedHours > workloadReport.maxHours ? (\\r\\n                                      <p className=\\"text-[10px] text-red-600 font-bold mt-1 flex items-center\\"><AlertTriangle size={12}/> 隆EXCESO DETECTADO!</p>\\r\\n                                  ) : (\\r\\n                                      <p className=\\"text-[10px] text-green-600 font-bold mt-1\\">Dentro de l铆mite</p>\\r\\n                                  )}\\r\\n                              </div>\\r\\n                              <div className=\\"p-4 bg-green-50 rounded-xl border border-green-100\\">\\r\\n                                  <p className=\\"text-xs font-bold text-green-600 uppercase\\">Horas Trabajadas (Completed)</p>\\r\\n                                  <p className=\\"text-2xl font-bold mt-1\\">{workloadReport.completedHours} hs</p>\\r\\n                              </div>\\r\\n                          </div>\\r\\n\\r\\n                          {/*  NUEVO GRFICO: RESUMEN POR OBJETIVO */}\\r\\n                          <div className=\\"bg-slate-50 p-4 rounded-xl border border-slate-200\\">\\r\\n                              <h5 className=\\"text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2\\"><PieChart size={14}/> Distribuci贸n por Objetivo</h5>\\r\\n                              <div className=\\"grid grid-cols-2 md:grid-cols-3 gap-3\\">\\r\\n                                  {getHoursByObjective(workloadReport.details).map((item, idx) => (\\r\\n                                      <div key={idx} className=\\"bg-white p-3 rounded-lg border border-slate-100 shadow-sm flex justify-between items-center\\">\\r\\n                                          <span className=\\"text-xs font-bold text-slate-700 truncate max-w-[100px]\\" title={item.name}>{item.name}</span>\\r\\n                                          <span className=\\"text-sm font-mono font-bold text-indigo-600\\">{item.hours}h</span>\\r\\n                                      </div>\\r\\n                                  ))}\\r\\n                                  {workloadReport.details.length === 0 && <span className=\\"text-xs text-gray-400 italic col-span-3\\">Sin actividad registrada.</span>}\\r\\n                              </div>\\r\\n                          </div>\\r\\n\\r\\n                          {/* Detalle Diario */}\\r\\n                          <div>\\r\\n                              <h5 className=\\"text-sm font-bold text-gray-700 mb-3 border-b pb-1\\">Detalle Diario de Asignaciones</h5>\\r\\n                              <div className=\\"h-48 overflow-y-auto border border-gray-200 rounded-lg\\">\\r\\n                                  <table className=\\"min-w-full divide-y divide-gray-200\\">\\r\\n                                      <thead className=\\"bg-gray-50 sticky top-0\\">\\r\\n                                          <tr>\\r\\n                                              <th className=\\"px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase\\">Fecha</th>\\r\\n                                              <th className=\\"px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase\\">Duraci贸n</th>\\r\\n                                              <th className=\\"px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase\\">Objetivo</th>\\r\\n                                              <th className=\\"px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase\\">Estado</th>\\r\\n                                          </tr>\\r\\n                                      </thead>\\r\\n                                      <tbody className=\\"bg-white divide-y divide-gray-200\\">\\r\\n                                          {workloadReport.details.map((d, index) => (\\r\\n                                              <tr key={index} className={d.status === \'Completed\' ? \'text-gray-600 bg-gray-50\' : \'font-medium hover:bg-slate-50\'}>\\r\\n                                                  <td className=\\"px-4 py-2 whitespace-nowrap text-xs\\">{d.date} ({d.startTime})</td>\\r\\n                                                  <td className=\\"px-4 py-2 whitespace-nowrap text-xs\\">{d.duration} hs</td>\\r\\n                                                  <td className=\\"px-4 py-2 whitespace-nowrap text-xs font-bold text-slate-700\\">{d.objectiveName}</td>\\r\\n                                                  <td className=\\"px-4 py-2 whitespace-nowrap\\">\\r\\n                                                      <span className={`px-2 inline-flex text-[10px] leading-5 font-semibold rounded-full ${d.status === \'Assigned\' ? \'bg-blue-100 text-blue-800\' : \'bg-green-100 text-green-800\'}`}>\\r\\n                                                          {d.status}\\r\\n                                                      </span>\\r\\n                                                  </td>\\r\\n                                              </tr>\\r\\n                                          ))}\\r\\n                                      </tbody>\\r\\n                                  </table>\\r\\n                              </div>\\r\\n                          </div>\\r\\n                      </div>\\r\\n                  ) : null}\\r\\n                  \\r\\n                  <div className=\\"mt-6 flex justify-end\\">\\r\\n                      <button onClick={() => setShowWorkloadModal(false)} className=\\"px-4 py-2 text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 font-medium transition-colors\\">\\r\\n                          Cerrar Ficha\\r\\n                      </button>\\r\\n                  </div>\\r\\n              </div>\\r\\n          </div>\\r\\n      )}\\r\\n    </div>\\r\\n  );\\r\\n}\\n\\n\\n\\n"},{"id":"vleclerpn","name":"GeocodingSelector.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\GeocodingSelector.tsx","area":"FRONTEND","content":"import React, { useState } from \'react\';\\r\\nimport toast from \'react-hot-toast\';\\r\\n\\r\\ninterface GeocodingSelectorProps {\\r\\n  address: string;\\r\\n  onCoordinatesSelected: (lat: string, lng: string) => void;\\r\\n  onClose: () => void;\\r\\n  isOpen: boolean;\\r\\n}\\r\\n\\r\\n/**\\r\\n * Componente Modal para buscar coordenadas geogr谩ficas a partir de una direcci贸n.\\r\\n * Utiliza la API de Geocodificaci贸n de Google Maps.\\r\\n */\\r\\nexport const GeocodingSelector: React.FC<GeocodingSelectorProps> = ({ address, onCoordinatesSelected, onClose, isOpen }) => {\\r\\n  const [loading, setLoading] = useState(false);\\r\\n  // Acceso seguro a la clave de API configurada en .env.local\\r\\n  const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY; \\r\\n\\r\\n  if (!isOpen) return null;\\r\\n\\r\\n  /**\\r\\n   * Fetches coordinates for the given address using Google\'s Geocoding API.\\r\\n   */\\r\\n  const fetchCoordinates = async () => {\\r\\n    if (!address.trim()) {\\r\\n      toast.error(\\"Ingrese una direcci贸n v谩lida para buscar.\\");\\r\\n      return;\\r\\n    }\\r\\n    // Verificaci贸n de seguridad\\r\\n    if (!apiKey || apiKey.trim() === \'\') {\\r\\n      toast.error(\\"Error: Falta la clave de Google Maps (NEXT_PUBLIC_GOOGLE_MAPS_API_KEY).\\");\\r\\n      console.error(\\"GeocodingSelector: Missing Google Maps API Key.\\");\\r\\n      return;\\r\\n    }\\r\\n\\r\\n    setLoading(true);\\r\\n    const encodedAddress = encodeURIComponent(address);\\r\\n    const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${apiKey}`;\\r\\n\\r\\n    try {\\r\\n      const response = await fetch(url);\\r\\n      const data = await response.json();\\r\\n\\r\\n      if (data.status === \'OK\' && data.results.length > 0) {\\r\\n        const { lat, lng } = data.results[0].geometry.location;\\r\\n        \\r\\n        // Mantenemos la alta precisi贸n para el estado del formulario\\r\\n        const latString = lat.toFixed(6); \\r\\n        const lngString = lng.toFixed(6);\\r\\n\\r\\n        onCoordinatesSelected(latString, lngString);\\r\\n        toast.success(`Coordenadas asignadas a: ${address}`);\\r\\n        onClose();\\r\\n      } else {\\r\\n        toast.error(\\"No se encontraron coordenadas para la direcci贸n proporcionada.\\");\\r\\n      }\\r\\n    } catch (error) {\\r\\n      console.error(\\"Error al consultar la API de Google:\\", error);\\r\\n      toast.error(\\"Error de red al buscar coordenadas.\\");\\r\\n    } finally {\\r\\n      setLoading(false);\\r\\n    }\\r\\n  };\\r\\n  \\r\\n  // Estructura del Modal (usando Tailwind)\\r\\n  return (\\r\\n    <div className=\\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\\">\\r\\n      <div className=\\"bg-white p-6 rounded-lg shadow-xl w-full max-w-md\\">\\r\\n        <h3 className=\\"text-xl font-bold mb-4 text-gray-800\\">Buscar Coordenadas</h3>\\r\\n        <p className=\\"text-sm text-gray-600 mb-4\\">\\r\\n          Direcci贸n a buscar: <span className=\\"font-semibold text-indigo-600\\">{address}</span>\\r\\n        </p>\\r\\n        \\r\\n        <button\\r\\n          onClick={fetchCoordinates}\\r\\n          disabled={loading || !address.trim()}\\r\\n          className={`w-full py-2 px-4 rounded-md text-white font-medium transition duration-200 ${\\r\\n            loading || !address.trim() ? \'bg-indigo-400 cursor-not-allowed\' : \'bg-indigo-600 hover:bg-indigo-700\'\\r\\n          }`}\\r\\n        >\\r\\n          {loading ? \'Buscando...\' : \'Confirmar B煤squeda en Mapa\'}\\r\\n        </button>\\r\\n        \\r\\n        <button\\r\\n          onClick={onClose}\\r\\n          className=\\"mt-3 w-full py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-200\\"\\r\\n        >\\r\\n          Cancelar\\r\\n        </button>\\r\\n      </div>\\r\\n    </div>\\r\\n  );\\r\\n};\\n\\n\\n\\n"},{"id":"wi5qyasoy","name":"labor-agreements-manager.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\labor-agreements-manager.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport { httpsCallable } from \'firebase/functions\'; \\r\\nimport { functions } from \'@/services/firebase-client.service\';\\r\\nimport InputField from \'@/components/common/InputField\';\\r\\nimport Button from \'@/components/common/Button\';\\r\\nimport toast from \'react-hot-toast\';\\r\\nimport { Edit2, Trash2, Plus, Briefcase, Clock, Moon, DownloadCloud } from \'lucide-react\';\\r\\n\\r\\nconst callManageAgreements = httpsCallable(functions, \'manageAgreements\');\\r\\n\\r\\nexport function LaborAgreementsManager() {\\r\\n    const [agreements, setAgreements] = useState<any[]>([]);\\r\\n    const [showModal, setShowModal] = useState(false);\\r\\n    const [isEditing, setIsEditing] = useState(false);\\r\\n    const [loading, setLoading] = useState(false);\\r\\n    \\r\\n    const [formData, setFormData] = useState({\\r\\n        id: \'\',\\r\\n        name: \'\', code: \'\', \\r\\n        maxHoursWeekly: 48, maxHoursMonthly: 204, overtimeThresholdDaily: 12,\\r\\n        saturdayCutoffHour: 13, nightShiftStart: 21, nightShiftEnd: 6\\r\\n    });\\r\\n\\r\\n    const loadData = async () => {\\r\\n        setLoading(true);\\r\\n        try {\\r\\n            const res = await callManageAgreements({ action: \'GET_ALL\', payload: {} });\\r\\n            setAgreements((res.data as any).data || []);\\r\\n        } catch (e) { console.error(e); toast.error(\\"Error cargando convenios\\"); }\\r\\n        finally { setLoading(false); }\\r\\n    };\\r\\n\\r\\n    useEffect(() => { loadData(); }, []);\\r\\n\\r\\n    //  FUNCIN DE IMPORTACIN\\r\\n    const handleInitialize = async () => {\\r\\n        const toastId = toast.loading(\\"Importando convenios est谩ndar...\\");\\r\\n        try {\\r\\n            const res = await callManageAgreements({ action: \'INITIALIZE_DEFAULTS\', payload: {} });\\r\\n            toast.success((res.data as any).message, { id: toastId });\\r\\n            loadData();\\r\\n        } catch (e: any) {\\r\\n            toast.error(e.message, { id: toastId });\\r\\n        }\\r\\n    };\\r\\n\\r\\n    const handleSubmit = async (e: React.FormEvent) => {\\r\\n        e.preventDefault();\\r\\n        const toastId = toast.loading(\\"Guardando...\\");\\r\\n        try {\\r\\n            if (isEditing) {\\r\\n                await callManageAgreements({ action: \'UPDATE\', payload: { id: formData.id, data: formData } });\\r\\n            } else {\\r\\n                await callManageAgreements({ action: \'CREATE\', payload: formData });\\r\\n            }\\r\\n            toast.success(\\"Guardado correctamente\\", { id: toastId });\\r\\n            setShowModal(false);\\r\\n            loadData();\\r\\n        } catch (e: any) { toast.error(e.message, { id: toastId }); }\\r\\n    };\\r\\n\\r\\n    const handleEdit = (item: any) => {\\r\\n        setFormData(item);\\r\\n        setIsEditing(true);\\r\\n        setShowModal(true);\\r\\n    };\\r\\n\\r\\n    const handleDelete = async (id: string) => {\\r\\n        if(!confirm(\\"驴Eliminar convenio?\\")) return;\\r\\n        try {\\r\\n            await callManageAgreements({ action: \'DELETE\', payload: { id } });\\r\\n            toast.success(\\"Eliminado\\");\\r\\n            loadData();\\r\\n        } catch(e: any) { toast.error(e.message); }\\r\\n    }\\r\\n\\r\\n    const handleNew = () => {\\r\\n        setFormData({ id: \'\', name: \'\', code: \'\', maxHoursWeekly: 48, maxHoursMonthly: 204, overtimeThresholdDaily: 12, saturdayCutoffHour: 13, nightShiftStart: 21, nightShiftEnd: 6 });\\r\\n        setIsEditing(false);\\r\\n        setShowModal(true);\\r\\n    }\\r\\n\\r\\n    return (\\r\\n        <div className=\\"space-y-6\\">\\r\\n            <div className=\\"flex justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-gray-200\\">\\r\\n                <div>\\r\\n                    <h3 className=\\"font-bold text-xl text-gray-800\\">Reglas Laborales Activas</h3>\\r\\n                    <p className=\\"text-sm text-gray-500\\">Define los l铆mites y par谩metros de liquidaci贸n.</p>\\r\\n                </div>\\r\\n                <div className=\\"flex gap-3\\">\\r\\n                    {/* Bot贸n de Carga Inicial si est谩 vac铆o */}\\r\\n                    {agreements.length === 0 && !loading && (\\r\\n                        <Button onClick={handleInitialize} className=\\"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 flex items-center gap-2\\">\\r\\n                            <DownloadCloud size={16}/> Cargar Est谩ndares\\r\\n                        </Button>\\r\\n                    )}\\r\\n                    <Button onClick={handleNew} primary className=\\"flex items-center gap-2\\"><Plus size={16}/> Nuevo Convenio</Button>\\r\\n                </div>\\r\\n            </div>\\r\\n            \\r\\n            <div className=\\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\\">\\r\\n                {agreements.map(a => (\\r\\n                    <div key={a.id} className=\\"bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all relative overflow-hidden group\\">\\r\\n                        <div className=\\"p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-start\\">\\r\\n                            <div>\\r\\n                                <h4 className=\\"font-bold text-lg text-indigo-700\\">{a.name}</h4>\\r\\n                                <span className=\\"text-xs font-mono bg-white border px-2 py-0.5 rounded text-slate-500\\">{a.code}</span>\\r\\n                            </div>\\r\\n                            <div className=\\"flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity\\">\\r\\n                                <button onClick={() => handleEdit(a)} className=\\"text-gray-400 hover:text-indigo-600\\"><Edit2 size={16}/></button>\\r\\n                                <button onClick={() => handleDelete(a.id)} className=\\"text-gray-400 hover:text-red-600\\"><Trash2 size={16}/></button>\\r\\n                            </div>\\r\\n                        </div>\\r\\n                        \\r\\n                        <div className=\\"p-5 space-y-3\\">\\r\\n                            <div className=\\"flex items-center justify-between text-sm\\">\\r\\n                                <span className=\\"text-gray-500 flex items-center gap-2\\"><Briefcase size={14}/> Semanal</span>\\r\\n                                <span className=\\"font-bold text-gray-800\\">{a.maxHoursWeekly} hs</span>\\r\\n                            </div>\\r\\n                            <div className=\\"flex items-center justify-between text-sm\\">\\r\\n                                <span className=\\"text-gray-500 flex items-center gap-2\\"><Clock size={14}/> Mensual</span>\\r\\n                                <span className=\\"font-bold text-gray-800\\">{a.maxHoursMonthly} hs</span>\\r\\n                            </div>\\r\\n                            <div className=\\"flex items-center justify-between text-sm\\">\\r\\n                                <span className=\\"text-gray-500 flex items-center gap-2\\"><Moon size={14}/> Nocturnidad</span>\\r\\n                                <span className=\\"font-bold text-gray-800\\">{a.nightShiftStart}:00 - {a.nightShiftEnd}:00</span>\\r\\n                            </div>\\r\\n                        </div>\\r\\n                    </div>\\r\\n                ))}\\r\\n                \\r\\n                {agreements.length === 0 && !loading && (\\r\\n                    <div className=\\"col-span-full p-12 text-center text-gray-400 border-2 border-dashed rounded-xl\\">\\r\\n                        No hay convenios cargados. Usa el bot贸n \\"Cargar Est谩ndares\\" para iniciar.\\r\\n                    </div>\\r\\n                )}\\r\\n            </div>\\r\\n\\r\\n            {/* Modal de Edici贸n (Igual al anterior) */}\\r\\n            {showModal && (\\r\\n                <div className=\\"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 backdrop-blur-sm\\">\\r\\n                    <div className=\\"bg-white p-8 rounded-2xl w-full max-w-lg shadow-2xl\\">\\r\\n                        <h3 className=\\"text-xl font-bold mb-6 text-gray-800\\">{isEditing ? \'Editar Regla\' : \'Nueva Regla Laboral\'}</h3>\\r\\n                        <form onSubmit={handleSubmit} className=\\"space-y-4\\">\\r\\n                            <div className=\\"grid grid-cols-2 gap-4\\">\\r\\n                                <div className=\\"col-span-2\\">\\r\\n                                    <InputField label=\\"Nombre (Ej: Seguridad Privada)\\" id=\\"name\\" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required />\\r\\n                                </div>\\r\\n                                <InputField label=\\"C贸digo (Ej: SUVICO)\\" id=\\"code\\" value={formData.code} onChange={e => setFormData({...formData, code: e.target.value})} required />\\r\\n                                <InputField label=\\"L铆mite Diario (Ej: 12)\\" type=\\"number\\" id=\\"daily\\" value={formData.overtimeThresholdDaily} onChange={e => setFormData({...formData, overtimeThresholdDaily: +e.target.value})} required />\\r\\n                                <InputField label=\\"Max Semanal (Ej: 48)\\" type=\\"number\\" id=\\"weekly\\" value={formData.maxHoursWeekly} onChange={e => setFormData({...formData, maxHoursWeekly: +e.target.value})} required />\\r\\n                                <InputField label=\\"Max Mensual (Ej: 204)\\" type=\\"number\\" id=\\"monthly\\" value={formData.maxHoursMonthly} onChange={e => setFormData({...formData, maxHoursMonthly: +e.target.value})} required />\\r\\n                                \\r\\n                                <div className=\\"col-span-2 border-t pt-4 mt-2\\">\\r\\n                                    <h4 className=\\"text-xs font-bold text-gray-500 uppercase mb-3\\">Extras y Nocturnidad</h4>\\r\\n                                    <div className=\\"grid grid-cols-3 gap-3\\">\\r\\n                                        <InputField label=\\"Corte S谩b.\\" type=\\"number\\" id=\\"sat\\" value={formData.saturdayCutoffHour} onChange={e => setFormData({...formData, saturdayCutoffHour: +e.target.value})} required />\\r\\n                                        <InputField label=\\"Inicio Noche\\" type=\\"number\\" id=\\"ns\\" value={formData.nightShiftStart} onChange={e => setFormData({...formData, nightShiftStart: +e.target.value})} required />\\r\\n                                        <InputField label=\\"Fin Noche\\" type=\\"number\\" id=\\"ne\\" value={formData.nightShiftEnd} onChange={e => setFormData({...formData, nightShiftEnd: +e.target.value})} required />\\r\\n                                    </div>\\r\\n                                </div>\\r\\n                            </div>\\r\\n                            \\r\\n                            <div className=\\"flex justify-end gap-3 mt-8\\">\\r\\n                                <button type=\\"button\\" onClick={() => setShowModal(false)} className=\\"px-5 py-2.5 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 font-medium\\">Cancelar</button>\\r\\n                                <Button type=\\"submit\\" primary>Guardar Regla</Button>\\r\\n                            </div>\\r\\n                        </form>\\r\\n                    </div>\\r\\n                </div>\\r\\n            )}\\r\\n        </div>\\r\\n    );\\r\\n}\\n\\n\\n\\n"},{"id":"e8hmliqzy","name":"login-form.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\login-form.tsx","area":"FRONTEND","content":"import React, { useState } from \'react\';\\r\\nimport { useRouter } from \'next/router\';\\r\\nimport { signInWithEmailAndPassword } from \'firebase/auth\';\\r\\nimport { auth } from \'@/services/firebase-client.service\';\\r\\n\\r\\nexport function LoginForm() {\\r\\n  const [email, setEmail] = useState(\'\');\\r\\n  const [password, setPassword] = useState(\'\');\\r\\n  const [error, setError] = useState(\'\');\\r\\n  const [loading, setLoading] = useState(false);\\r\\n  const router = useRouter();\\r\\n\\r\\n  // Colores personalizados basados en la imagen de referencia (Rojo ATM)\\r\\n  const colors = {\\r\\n    primary: \'#a81d1d\', // Rojo intenso\\r\\n    primaryHover: \'#8c1818\',\\r\\n    bgInput: \'#eff4fc\', // Fondo azul muy claro de los inputs\\r\\n    textGray: \'#6b7280\',\\r\\n  };\\r\\n\\r\\n  const handleSubmit = async (e: React.FormEvent) => {\\r\\n    e.preventDefault();\\r\\n    setError(\'\');\\r\\n    setLoading(true);\\r\\n\\r\\n    try {\\r\\n      await signInWithEmailAndPassword(auth, email, password);\\r\\n      router.push(\'/admin/dashboard\');\\r\\n    } catch (err: any) {\\r\\n        console.error(err);\\r\\n        if (err.code === \'auth/invalid-credential\' || err.code === \'auth/user-not-found\' || err.code === \'auth/wrong-password\') {\\r\\n            setError(\'Credenciales incorrectas. Verifique email y contrase帽a.\');\\r\\n        } else if (err.code === \'auth/too-many-requests\') {\\r\\n            setError(\'Demasiados intentos. Por favor espere unos minutos.\');\\r\\n        } else {\\r\\n            setError(\'Error al iniciar sesi贸n. Intente nuevamente.\');\\r\\n        }\\r\\n    } finally {\\r\\n      setLoading(false);\\r\\n    }\\r\\n  };\\r\\n\\r\\n  return (\\r\\n    <div className=\\"w-full max-w-md mx-auto\\">\\r\\n      {/* Tarjeta de Login con sombra suave y bordes redondeados */}\\r\\n      <div className=\\"bg-white shadow-xl rounded-3xl px-8 pt-10 pb-12 mb-4 border border-gray-50 relative overflow-hidden\\">\\r\\n        \\r\\n        {/* Logo (Placeholder textual, puedes reemplazar por una etiqueta <img> si tienes el logo en /public) */}\\r\\n        <div className=\\"text-center mb-8\\">\\r\\n            <div className=\\"inline-flex flex-col items-center justify-center mb-4\\">\\r\\n                {/* Icono/Logo Simulado en Rojo */}\\r\\n                <div className=\\"bg-red-50 p-3 rounded-full\\">\\r\\n                  <svg xmlns=\\"http://www.w3.org/2000/svg\\" className=\\"h-10 w-10\\" style={{ color: colors.primary }} fill=\\"none\\" viewBox=\\"0 0 24 24\\" stroke=\\"currentColor\\">\\r\\n                    <path strokeLinecap=\\"round\\" strokeLinejoin=\\"round\\" strokeWidth={2} d=\\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\\" />\\r\\n                  </svg>\\r\\n                </div>\\r\\n                <h2 className=\\"text-2xl font-extrabold text-gray-900 mt-4\\">Sistema de Gesti贸n</h2>\\r\\n            </div>\\r\\n            <p className=\\"text-sm text-gray-500\\">Inicia sesi贸n para acceder al panel.</p>\\r\\n        </div>\\r\\n        \\r\\n        <form onSubmit={handleSubmit}>\\r\\n            {/* Banner de Error Estilizado */}\\r\\n            {error && (\\r\\n                <div className=\\"bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r-md animate-pulse\\">\\r\\n                    <div className=\\"flex items-center\\">\\r\\n                        <svg className=\\"h-5 w-5 text-red-500 mr-3\\" viewBox=\\"0 0 20 20\\" fill=\\"currentColor\\">\\r\\n                            <path fillRule=\\"evenodd\\" d=\\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z\\" clipRule=\\"evenodd\\" />\\r\\n                        </svg>\\r\\n                        <p className=\\"text-sm text-red-700 font-medium\\">{error}</p>\\r\\n                    </div>\\r\\n                </div>\\r\\n            )}\\r\\n            \\r\\n            {/* Input Email con Icono */}\\r\\n            <div className=\\"mb-5 relative\\">\\r\\n              <div className=\\"absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none\\">\\r\\n                <svg className=\\"h-5 w-5 text-gray-400\\" xmlns=\\"http://www.w3.org/2000/svg\\" viewBox=\\"0 0 20 20\\" fill=\\"currentColor\\">\\r\\n                  <path d=\\"M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z\\" />\\r\\n                  <path d=\\"M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z\\" />\\r\\n                </svg>\\r\\n              </div>\\r\\n              <input\\r\\n                className=\\"appearance-none rounded-xl w-full py-4 pl-12 pr-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-200 transition duration-200 font-medium placeholder-gray-400\\"\\r\\n                style={{ backgroundColor: colors.bgInput, border: \'1px solid transparent\' }}\\r\\n                id=\\"email\\"\\r\\n                type=\\"email\\"\\r\\n                placeholder=\\"admin@bacarsa.com.ar\\"\\r\\n                value={email}\\r\\n                onChange={(e) => setEmail(e.target.value)}\\r\\n                required\\r\\n              />\\r\\n            </div>\\r\\n\\r\\n            {/* Input Password con Icono */}\\r\\n            <div className=\\"mb-8 relative\\">\\r\\n              <div className=\\"absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none\\">\\r\\n                 <svg className=\\"h-5 w-5 text-gray-400\\" xmlns=\\"http://www.w3.org/2000/svg\\" viewBox=\\"0 0 20 20\\" fill=\\"currentColor\\">\\r\\n                    <path fillRule=\\"evenodd\\" d=\\"M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z\\" clipRule=\\"evenodd\\" />\\r\\n                  </svg>\\r\\n              </div>\\r\\n              <input\\r\\n                className=\\"appearance-none rounded-xl w-full py-4 pl-12 pr-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-200 transition duration-200 font-medium placeholder-gray-400 tracking-widest\\"\\r\\n                style={{ backgroundColor: colors.bgInput, border: \'1px solid transparent\' }}\\r\\n                id=\\"password\\"\\r\\n                type=\\"password\\"\\r\\n                placeholder=\\"⑩⑩⑩⑩⑩⑩⑩\\"\\r\\n                value={password}\\r\\n                onChange={(e) => setPassword(e.target.value)}\\r\\n                required\\r\\n              />\\r\\n            </div>\\r\\n\\r\\n            {/* Bot贸n Submit */}\\r\\n            <button\\r\\n                className={`w-full text-white font-bold py-4 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-300 flex justify-center items-center text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 ${loading ? \'opacity-70 cursor-not-allowed\' : \'\'}`}\\r\\n                style={{ backgroundColor: loading ? colors.primaryHover : colors.primary }}\\r\\n                type=\\"submit\\"\\r\\n                disabled={loading}\\r\\n            >\\r\\n                {loading ? (\\r\\n                    <>\\r\\n                        <svg className=\\"animate-spin -ml-1 mr-3 h-6 w-6 text-white\\" xmlns=\\"http://www.w3.org/2000/svg\\" fill=\\"none\\" viewBox=\\"0 0 24 24\\">\\r\\n                            <circle className=\\"opacity-25\\" cx=\\"12\\" cy=\\"12\\" r=\\"10\\" stroke=\\"currentColor\\" strokeWidth=\\"4\\"></circle>\\r\\n                            <path className=\\"opacity-75\\" fill=\\"currentColor\\" d=\\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\\"></path>\\r\\n                        </svg>\\r\\n                        Accediendo...\\r\\n                    </>\\r\\n                ) : \'Acceder al Sistema\'}\\r\\n            </button>\\r\\n        </form>\\r\\n      </div>\\r\\n      \\r\\n      <p className=\\"text-center text-gray-400 text-sm mt-6 font-medium\\">\\r\\n        Ver 3.0 Beta\\r\\n      </p>\\r\\n    </div>\\r\\n  );\\r\\n}\\n\\n\\n\\n"},{"id":"5gw9qke3g","name":"new.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\new.tsx","area":"FRONTEND","content":"// Archivo: ./src/components/admin/new.tsx (o la p谩gina asociada)\\r\\n\\r\\nimport React from \'react\';\\r\\nimport { withAuthGuard } from \'@/components/common/withAuthGuard\';\\r\\n//  FIX CRTICO: Importamos DashboardLayout por defecto (SIN LLAVES)\\r\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\'; \\r\\nimport { ClientSetupWizard } from \'@/components/admin/client-setup-wizard\';\\r\\n\\r\\nfunction NewClientPage() {\\r\\n    return (\\r\\n        <DashboardLayout title=\\"Alta de Cliente y Servicio\\">\\r\\n            <div className=\\"py-6\\">\\r\\n                <ClientSetupWizard />\\r\\n            </div>\\r\\n        </DashboardLayout>\\r\\n    );\\r\\n}\\r\\n\\r\\n// Exportaci贸n protegida (asumo roles de administraci贸n)\\r\\nexport default withAuthGuard(NewClientPage, [\'admin\']);\\n\\n\\n\\n"},{"id":"w4dbtvzc9","name":"objective-management.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\objective-management.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport { useRouter } from \'next/router\'; //  NECESARIO para la navegaci贸n de la tabla\\r\\nimport { callManageData } from \'@/services/firebase-client.service\';\\r\\nimport { IObjective } from \'@/common/interfaces/client.interface\';\\r\\nimport { useClient } from \'@/context/ClientContext\';\\r\\nimport toast from \'react-hot-toast\';\\r\\nimport { GeocodingSelector } from \'./GeocodingSelector\'; \\r\\nimport styles from \'./ObjectiveManagement.module.css\'; // Para cumplir con Next.js\\r\\n\\r\\n\\r\\n// -- 1. INTERFACES Y CONSTANTES (Sin cambios) --\\r\\ninterface ObjectiveFormState {\\r\\n  name: string;\\r\\n  address: string;\\r\\n  latitude: string; \\r\\n  longitude: string;\\r\\n}\\r\\n\\r\\nconst STYLES = {\\r\\n    inputClass: \\"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-200\\",\\r\\n    readOnlyInputClass: \\"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none bg-gray-50 text-gray-500 cursor-not-allowed sm:text-sm transition duration-200\\",\\r\\n    labelClass: \\"block text-sm font-medium text-gray-700\\",\\r\\n    buttonDisabled: \\"opacity-70 cursor-not-allowed\\",\\r\\n    buttonActive: \\"hover:bg-indigo-700\\",\\r\\n};\\r\\n\\r\\nconst cleanAndParseCoordinate = (coordString: string): number => {\\r\\n    const cleanedString = coordString.trim().replace(\',\', \'.\'); \\r\\n    return parseFloat(cleanedString);\\r\\n};\\r\\n\\r\\n\\r\\nexport function ObjectiveManagement() {\\r\\n  const router = useRouter(); //  Instancia del router\\r\\n  const { selectedClientId, selectedClient } = useClient();\\r\\n\\r\\n  const [objectives, setObjectives] = useState<IObjective[]>([]);\\r\\n  const [isSelectorOpen, setIsSelectorOpen] = useState(false); \\r\\n  \\r\\n  const [formData, setFormData] = useState<ObjectiveFormState>({\\r\\n    name: \'\', address: \'\', latitude: \'\', longitude: \'\',\\r\\n  });\\r\\n  \\r\\n  const [loading, setLoading] = useState(false);\\r\\n  const [submitting, setSubmitting] = useState(false);\\r\\n\\r\\n  /**\\r\\n   * Carga de objetivos.\\r\\n   */\\r\\n  const fetchObjectives = async () => {\\r\\n    if (!selectedClientId) {\\r\\n        setObjectives([]);\\r\\n        return;\\r\\n    }\\r\\n    setLoading(true);\\r\\n    try {\\r\\n      const result = await callManageData({ \\r\\n          action: \'GET_ALL_OBJECTIVES\', \\r\\n          payload: { clientId: selectedClientId } \\r\\n      });\\r\\n      const response = result.data as { success: boolean, data: IObjective[] };\\r\\n      setObjectives(response.data || []);\\r\\n      \\r\\n    } catch (error) {\\r\\n      console.error(\'[ObjectiveManagement] Fetch Error:\', error);\\r\\n      toast.error(\\"Error al cargar objetivos\\");\\r\\n    } finally { \\r\\n      setLoading(false); \\r\\n    }\\r\\n  };\\r\\n\\r\\n  useEffect(() => {\\r\\n    fetchObjectives();\\r\\n    // eslint-disable-next-line react-hooks/exhaustive-deps\\r\\n  }, [selectedClientId]);\\r\\n\\r\\n  /**\\r\\n   * Maneja el cambio en los inputs name y address.\\r\\n   */\\r\\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {\\r\\n    const { name, value } = e.target;\\r\\n    if (name === \'name\' || name === \'address\') {\\r\\n        setFormData(prev => ({ ...prev, [name]: value }));\\r\\n    }\\r\\n  };\\r\\n\\r\\n  /**\\r\\n   * Callback que recibe las coordenadas desde el GeocodingSelector y actualiza el estado.\\r\\n   */\\r\\n  const handleCoordinatesSelected = (lat: string, lng: string) => {\\r\\n      setFormData(prev => ({\\r\\n          ...prev,\\r\\n          latitude: lat,\\r\\n          longitude: lng,\\r\\n      }));\\r\\n      setIsSelectorOpen(false); // Cerramos el modal\\r\\n  };\\r\\n\\r\\n  /**\\r\\n   * Valida y env铆a la creaci贸n del objetivo.\\r\\n   */\\r\\n  const handleCreateObjective = async (e: React.FormEvent) => {\\r\\n    e.preventDefault();\\r\\n    \\r\\n    // 1. Pre-Submission Checks\\r\\n    if (!selectedClientId) {\\r\\n        toast.error(\\"锔 Debe seleccionar una empresa en el men煤 lateral.\\");\\r\\n        return;\\r\\n    }\\r\\n    \\r\\n    // Chequeo estricto de todos los campos obligatorios\\r\\n    if (!formData.name.trim() || \\r\\n        !formData.address.trim() ||\\r\\n        !formData.latitude.trim() || \\r\\n        !formData.longitude.trim() \\r\\n    ) {\\r\\n        toast.error(\\"Complete todos los campos obligatorios: Nombre, Direcci贸n y Coordenadas.\\");\\r\\n        return;\\r\\n    }\\r\\n    \\r\\n    // 2. Parsing y Validaci贸n\\r\\n    const lat = cleanAndParseCoordinate(formData.latitude);\\r\\n    const lng = cleanAndParseCoordinate(formData.longitude);\\r\\n\\r\\n    if (isNaN(lat) || isNaN(lng)) { \\r\\n        toast.error(\\"Las coordenadas deben ser n煤meros v谩lidos (ej: -34.60).\\"); \\r\\n        return; \\r\\n    }\\r\\n\\r\\n    // 3. Submission Logic\\r\\n    setSubmitting(true);\\r\\n    try {\\r\\n      const payload = { \\r\\n          name: formData.name.trim(),\\r\\n          address: formData.address.trim(),\\r\\n          clientId: selectedClientId,\\r\\n          location: { latitude: lat, longitude: lng } \\r\\n      };\\r\\n      \\r\\n      await callManageData({ action: \'CREATE_OBJECTIVE\', payload });\\r\\n      \\r\\n      toast.success(`Objetivo \\"${formData.name}\\" creado para ${selectedClient?.businessName}`);\\r\\n      setFormData({ name: \'\', address: \'\', latitude: \'\', longitude: \'\' });\\r\\n      fetchObjectives();\\r\\n\\r\\n    } catch (error) { \\r\\n        console.error(\'[ObjectiveManagement] Create Error:\', error);\\r\\n        toast.error(\\"Error al crear el objetivo.\\"); \\r\\n    } finally { \\r\\n        setSubmitting(false); \\r\\n    }\\r\\n  };\\r\\n\\r\\n\\r\\n  return (\\r\\n    <div className=\\"space-y-8\\">\\r\\n      {/* --- FORMULARIO (Secci贸n 1) --- */}\\r\\n      <div className=\\"bg-white shadow-lg rounded-2xl p-6 border border-gray-200\\">\\r\\n        {/* ... Header del formulario ... */}\\r\\n        \\r\\n        <form onSubmit={handleCreateObjective} noValidate className=\\"space-y-4\\">\\r\\n          <div>\\r\\n            <label className={STYLES.labelClass}>Nombre de la Sucursal/Puesto</label>\\r\\n            <input \\r\\n                type=\\"text\\" \\r\\n                name=\\"name\\" \\r\\n                value={formData.name} \\r\\n                onChange={handleInputChange} \\r\\n                className={STYLES.inputClass} \\r\\n                placeholder=\\"Ej: Casa Central\\" \\r\\n            />\\r\\n          </div>\\r\\n          <div>\\r\\n            <label className={STYLES.labelClass}>Direcci贸n F铆sica</label>\\r\\n            <input \\r\\n                type=\\"text\\" \\r\\n                name=\\"address\\" \\r\\n                value={formData.address} \\r\\n                onChange={handleInputChange} \\r\\n                className={STYLES.inputClass} \\r\\n                placeholder=\\"Av. Siempreviva 742\\" \\r\\n            />\\r\\n          </div>\\r\\n          <div className=\\"grid grid-cols-2 gap-4\\">\\r\\n            <div>\\r\\n                <label className={STYLES.labelClass}>Latitud</label>\\r\\n                <input \\r\\n                    type=\\"number\\" \\r\\n                    name=\\"latitude\\" \\r\\n                    value={formData.latitude} \\r\\n                    onChange={handleInputChange} \\r\\n                    className={STYLES.readOnlyInputClass} \\r\\n                    readOnly={true} // Deshabilitar escritura manual\\r\\n                    step=\\"any\\" \\r\\n                    placeholder=\\"Asignar con el bot贸n\\" \\r\\n                />\\r\\n            </div>\\r\\n            <div>\\r\\n                <label className={STYLES.labelClass}>Longitud</label>\\r\\n                <input \\r\\n                    type=\\"number\\" \\r\\n                    name=\\"longitude\\" \\r\\n                    value={formData.longitude} \\r\\n                    onChange={handleInputChange} \\r\\n                    className={STYLES.readOnlyInputClass} \\r\\n                    readOnly={true} // Deshabilitar escritura manual\\r\\n                    step=\\"any\\" \\r\\n                    placeholder=\\"Asignar con el bot贸n\\" \\r\\n                />\\r\\n            </div>\\r\\n          </div>\\r\\n          \\r\\n          {/* Bot贸n para Activar la B煤squeda de Coordenadas */}\\r\\n          <button \\r\\n              type=\\"button\\" \\r\\n              onClick={() => setIsSelectorOpen(true)}\\r\\n              disabled={!formData.address.trim()} \\r\\n              className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none transition duration-200 \\r\\n                  ${!formData.address.trim() ? \'opacity-70 cursor-not-allowed\' : \'\'}`}\\r\\n          >\\r\\n              Buscar/Asignar Coordenadas (Paso 1)\\r\\n          </button>\\r\\n\\r\\n          {/* Bot贸n Final de Creaci贸n */}\\r\\n          <button \\r\\n            type=\\"submit\\" \\r\\n            disabled={submitting || !selectedClientId || !formData.latitude.trim()} \\r\\n            className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 focus:outline-none transition duration-200 \\r\\n                ${submitting || !selectedClientId || !formData.latitude.trim() ? STYLES.buttonDisabled : STYLES.buttonActive}`}\\r\\n          >\\r\\n            {submitting ? \'Guardando...\' : \'Crear Objetivo (Paso 2)\'}\\r\\n          </button>\\r\\n        </form>\\r\\n      </div>\\r\\n\\r\\n      {/* INTEGRACIN DEL MODAL DE GEOCODIFICACIN */}\\r\\n      <GeocodingSelector \\r\\n          address={formData.address}\\r\\n          isOpen={isSelectorOpen}\\r\\n          onClose={() => setIsSelectorOpen(false)}\\r\\n          onCoordinatesSelected={handleCoordinatesSelected}\\r\\n      />\\r\\n      \\r\\n      {/* --- LISTADO DE OBJETIVOS (Secci贸n 2) --- */}\\r\\n      <div className={`${styles.objectiveListCard} bg-white shadow-lg rounded-2xl overflow-hidden border border-gray-200`}>\\r\\n        <div className=\\"px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center\\">\\r\\n            <h3 className=\\"text-lg font-bold text-gray-800\\">\\r\\n                Objetivos de {selectedClient?.businessName || \'...\'}\\r\\n            </h3>\\r\\n            <span className=\\"bg-gray-100 text-gray-600 py-1 px-3 rounded-full text-xs font-bold\\">{objectives.length}</span>\\r\\n        </div>\\r\\n        {loading ? <div className=\\"p-6 text-center text-gray-500\\">Cargando datos...</div> : (\\r\\n          <div className=\\"overflow-x-auto\\">\\r\\n            <table className=\\"min-w-full divide-y divide-gray-200\\">\\r\\n              <thead className=\\"bg-gray-100\\">\\r\\n                <tr>\\r\\n                  <th className=\\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider\\">Nombre y Ubicaci贸n</th>\\r\\n                </tr>\\r\\n              </thead>\\r\\n              <tbody className=\\"bg-white divide-y divide-gray-200\\">\\r\\n                {objectives.length === 0 ? (\\r\\n                    <tr><td className=\\"px-6 py-8 text-center text-sm text-gray-500 italic\\">No hay objetivos registrados para esta empresa.</td></tr>\\r\\n                ) : (\\r\\n                    objectives.map((obj) => (\\r\\n                    <tr \\r\\n                        key={obj.id} \\r\\n                        //  FIX DE NAVEGACIN: Hace la fila clickeable para ver detalles\\r\\n                        className=\\"hover:bg-gray-50 transition duration-150 cursor-pointer\\" \\r\\n                        onClick={() => router.push(`/admin/objective-detail/${obj.id}`)} \\r\\n                    >\\r\\n                        <td className=\\"px-6 py-4 whitespace-nowrap\\">\\r\\n                        <div className=\\"flex items-center\\">\\r\\n                            <div className=\\"flex-shrink-0 h-10 w-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center\\">\\r\\n                                <span className=\\"font-bold text-lg\\">{obj.name.charAt(0).toUpperCase()}</span>\\r\\n                            </div>\\r\\n                            <div className=\\"ml-4\\">\\r\\n                            <div className=\\"text-sm font-bold text-gray-900\\">{obj.name}</div>\\r\\n                            <div className=\\"text-sm text-gray-500\\">{obj.address}</div>\\r\\n                            <div className=\\"text-xs text-indigo-400 font-mono mt-1\\">\\r\\n                                ({obj.location?.latitude?.toFixed(4) || \'N/A\'}, {obj.location?.longitude?.toFixed(4) || \'N/A\'})\\r\\n                            </div>\\r\\n                            </div>\\r\\n                        </div>\\r\\n                        </td>\\r\\n                    </tr>\\r\\n                    ))\\r\\n                )}\\r\\n              </tbody>\\r\\n            </table>\\r\\n          </div>\\r\\n        )}\\r\\n      </div>\\r\\n    </div>\\r\\n  );\\r\\n}\\r\\n\\r\\nexport default ObjectiveManagement;\\n\\n\\n\\n"},{"id":"ndh9w67um","name":"ObjectiveManagement.module.css","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\ObjectiveManagement.module.css","area":"FRONTEND","content":"/* Archivo: ObjectiveManagement.module.css\\r\\n\\r\\nESTE ARCHIVO DEBE CONTENER EXCLUSIVAMENTE CLASES LOCALES (INICIADAS CON \'.\')\\r\\nPARA CUMPLIR CON LAS REGLAS DE CSS MODULES DE NEXT.JS. \\r\\nNO INCLUYE SELECTORES DE ELEMENTOS (h1, p, div) NI SELECTORES GLOBALES (:global()).\\r\\n*/\\r\\n\\r\\n/* EJEMPLO DE CLASE NICA:\\r\\nSolo usamos esta clase para que la compilaci贸n de Next.js/Turbopack\\r\\nconfirme que el archivo module.css es v谩lido y no global.\\r\\n*/\\r\\n.objectiveListCard {\\r\\n    /* Aqu铆 podr铆as a帽adir estilos locales que no puedes lograr con Tailwind, \\r\\n       como animaciones complejas o variables CSS */\\r\\n    padding: 1px; /* Espaciado m铆nimo o ajuste local */\\r\\n    transition: box-shadow 0.3s ease-in-out;\\r\\n}\\r\\n\\r\\n/* SI NECESITAS ESTILOS ESPECFICOS DE LA LISTA:\\r\\n.listItem {\\r\\n    border-left: 5px solid #4f46e5;\\r\\n}\\r\\n*/"},{"id":"lpknm8b9s","name":"GanttPlanningView.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\planning\\\\GanttPlanningView.tsx","area":"FRONTEND","content":"import React, { useState, useEffect, useCallback } from \'react\';\\r\\nimport { \\r\\n    format, addDays, \\r\\n    eachDayOfInterval, isSameDay, differenceInMinutes, \\r\\n    startOfDay \\r\\n} from \'date-fns\';\\r\\nimport { es } from \'date-fns/locale\';\\r\\nimport { \\r\\n    ChevronLeft, ChevronRight, Search, Zap, Loader2, \\r\\n    ZoomIn, ZoomOut, X, Clock, User, MapPin, CheckCircle2 \\r\\n} from \'lucide-react\';\\r\\nimport { collection, query, where, getDocs, Timestamp } from \'firebase/firestore\';\\r\\nimport { db, callManageData } from \'@/services/firebase-client.service\';\\r\\nimport { useClient } from \'@/context/ClientContext\';\\r\\nimport { IObjective } from \'@/common/interfaces/client.interface\';\\r\\nimport { IShift } from \'@/common/interfaces/shift.interface\';\\r\\n\\r\\nexport function GanttPlanningView() {\\r\\n    const { selectedClientId } = useClient();\\r\\n    \\r\\n    // Estado de Datos\\r\\n    const [currentDate, setCurrentDate] = useState(new Date());\\r\\n    const [objectives, setObjectives] = useState<IObjective[]>([]);\\r\\n    const [shifts, setShifts] = useState<IShift[]>([]);\\r\\n    const [loading, setLoading] = useState(false);\\r\\n    const [searchTerm, setSearchTerm] = useState(\'\');\\r\\n\\r\\n    // Estado de UI (Zoom y Modal)\\r\\n    const [cellWidth, setCellWidth] = useState(180); // Ancho base m谩s grande por d铆a\\r\\n    const [selectedShift, setSelectedShift] = useState<IShift | null>(null);\\r\\n\\r\\n    // Constantes\\r\\n    const DAYS_TO_SHOW = 14; \\r\\n\\r\\n    // Helper de fechas\\r\\n    const safeDate = (val: any): Date => {\\r\\n        if (!val) return new Date();\\r\\n        if (val.toDate && typeof val.toDate === \'function\') return val.toDate();\\r\\n        if (val.seconds) return new Date(val.seconds * 1000);\\r\\n        if (typeof val === \'string\') return new Date(val);\\r\\n        return new Date(val);\\r\\n    };\\r\\n\\r\\n    // 1. Cargar Datos\\r\\n    const fetchData = useCallback(async () => {\\r\\n        setLoading(true);\\r\\n        try {\\r\\n            const payload = selectedClientId ? { clientId: selectedClientId } : {};\\r\\n            const objRes = await callManageData({ action: \'GET_ALL_OBJECTIVES\', payload });\\r\\n            const loadedObjs = (objRes.data as any).data as IObjective[];\\r\\n            setObjectives(loadedObjs || []);\\r\\n\\r\\n            if (loadedObjs && loadedObjs.length > 0) {\\r\\n                const startDate = startOfDay(currentDate);\\r\\n                const endDate = addDays(startDate, DAYS_TO_SHOW);\\r\\n                \\r\\n                // Limitamos query para evitar errores, idealmente paginar o filtrar por zona\\r\\n                const targetIds = loadedObjs.slice(0, 15).map(o => o.id);\\r\\n                \\r\\n                if (targetIds.length > 0) {\\r\\n                    const shiftsRef = collection(db, \'turnos\');\\r\\n                    const q = query(\\r\\n                        shiftsRef,\\r\\n                        where(\'objectiveId\', \'in\', targetIds),\\r\\n                        where(\'startTime\', \'>=\', Timestamp.fromDate(startDate)),\\r\\n                        where(\'startTime\', \'<=\', Timestamp.fromDate(endDate))\\r\\n                    );\\r\\n\\r\\n                    const snapshot = await getDocs(q);\\r\\n                    const loadedShifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) as IShift[];\\r\\n                    setShifts(loadedShifts);\\r\\n                }\\r\\n            } else {\\r\\n                setShifts([]);\\r\\n            }\\r\\n        } catch (error) {\\r\\n            console.error(\\"Error cargando Gantt:\\", error);\\r\\n        } finally {\\r\\n            setLoading(false);\\r\\n        }\\r\\n    }, [selectedClientId, currentDate]);\\r\\n\\r\\n    useEffect(() => { fetchData(); }, [fetchData]);\\r\\n\\r\\n    // 2. Generar D铆as\\r\\n    const days = eachDayOfInterval({\\r\\n        start: startOfDay(currentDate),\\r\\n        end: addDays(startOfDay(currentDate), DAYS_TO_SHOW - 1)\\r\\n    });\\r\\n\\r\\n    const filteredObjectives = objectives.filter(o => \\r\\n        o.name.toLowerCase().includes(searchTerm.toLowerCase())\\r\\n    );\\r\\n\\r\\n    // 3. Estilos Din谩micos (Zoom)\\r\\n    const getShiftStyle = (shift: IShift) => {\\r\\n        const start = safeDate(shift.startTime);\\r\\n        const end = safeDate(shift.endTime);\\r\\n        const viewStart = startOfDay(currentDate);\\r\\n\\r\\n        if (isNaN(start.getTime()) || isNaN(end.getTime())) return null;\\r\\n\\r\\n        const startDiffMins = differenceInMinutes(start, viewStart);\\r\\n        const durationMins = differenceInMinutes(end, start);\\r\\n        \\r\\n        // Factor de Zoom: cellWidth px por 1440 minutos (1 d铆a)\\r\\n        const pixelsPerMinute = cellWidth / 1440;\\r\\n        \\r\\n        const left = startDiffMins * pixelsPerMinute;\\r\\n        const width = durationMins * pixelsPerMinute;\\r\\n\\r\\n        if (left + width < 0) return null;\\r\\n\\r\\n        return {\\r\\n            left: `${left}px`,\\r\\n            width: `${Math.max(width, 4)}px`\\r\\n        };\\r\\n    };\\r\\n\\r\\n    // Controladores de Zoom\\r\\n    const handleZoomIn = () => setCellWidth(prev => Math.min(prev + 50, 600)); // M谩x 600px por d铆a\\r\\n    const handleZoomOut = () => setCellWidth(prev => Math.max(prev - 50, 60));  // M铆n 60px por d铆a\\r\\n\\r\\n    return (\\r\\n        <div className=\\"flex flex-col h-[calc(100vh-140px)] bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden relative\\">\\r\\n            \\r\\n            {/* Header Herramientas */}\\r\\n            <div className=\\"flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50\\">\\r\\n                <div className=\\"flex items-center gap-4\\">\\r\\n                    <h2 className=\\"text-lg font-bold text-gray-700 flex items-center gap-2\\">\\r\\n                        <Zap className=\\"text-indigo-600\\" size={20} />\\r\\n                        Cronograma Lineal\\r\\n                    </h2>\\r\\n                    \\r\\n                    {/* Navegaci贸n Fechas */}\\r\\n                    <div className=\\"flex bg-white rounded-lg border border-gray-300 p-1 shadow-sm items-center\\">\\r\\n                        <button onClick={() => setCurrentDate(addDays(currentDate, -7))} className=\\"p-1.5 hover:bg-gray-100 rounded text-gray-600\\"><ChevronLeft size={18}/></button>\\r\\n                        <span className=\\"px-4 text-sm font-bold flex items-center text-gray-700 min-w-[140px] justify-center\\">\\r\\n                            {format(currentDate, \'d MMM\', { locale: es })} - {format(addDays(currentDate, DAYS_TO_SHOW - 1), \'d MMM\', { locale: es })}\\r\\n                        </span>\\r\\n                        <button onClick={() => setCurrentDate(addDays(currentDate, 7))} className=\\"p-1.5 hover:bg-gray-100 rounded text-gray-600\\"><ChevronRight size={18}/></button>\\r\\n                    </div>\\r\\n\\r\\n                    {/* Controles de Zoom */}\\r\\n                    <div className=\\"flex bg-white rounded-lg border border-gray-300 p-1 shadow-sm items-center ml-2\\">\\r\\n                        <button onClick={handleZoomOut} className=\\"p-1.5 hover:bg-gray-100 rounded text-gray-600\\" title=\\"Alejar\\"><ZoomOut size={16}/></button>\\r\\n                        <span className=\\"text-xs font-mono px-2 text-gray-400\\">Zoom</span>\\r\\n                        <button onClick={handleZoomIn} className=\\"p-1.5 hover:bg-gray-100 rounded text-gray-600\\" title=\\"Acercar\\"><ZoomIn size={16}/></button>\\r\\n                    </div>\\r\\n                </div>\\r\\n                \\r\\n                <div className=\\"flex items-center gap-3\\">\\r\\n                    {loading && <span className=\\"text-xs text-indigo-500 flex items-center animate-pulse\\"><Loader2 size={14} className=\\"mr-1 animate-spin\\"/> Cargando...</span>}\\r\\n                    <div className=\\"relative\\">\\r\\n                        <Search className=\\"absolute left-3 top-2 text-gray-400\\" size={16} />\\r\\n                        <input \\r\\n                            type=\\"text\\" \\r\\n                            placeholder=\\"Buscar sede...\\" \\r\\n                            className=\\"pl-9 pr-4 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none w-64\\"\\r\\n                            value={searchTerm}\\r\\n                            onChange={(e) => setSearchTerm(e.target.value)}\\r\\n                        />\\r\\n                    </div>\\r\\n                </div>\\r\\n            </div>\\r\\n\\r\\n            <div className=\\"flex flex-1 overflow-hidden relative\\">\\r\\n                {/* Columna Izquierda: Objetivos */}\\r\\n                <div className=\\"w-64 flex-shrink-0 border-r border-gray-200 bg-white z-20 shadow-md flex flex-col h-full\\">\\r\\n                    <div className=\\"h-10 border-b border-gray-200 bg-gray-100/50 flex items-center px-4 text-[10px] font-bold text-gray-500 uppercase tracking-wider\\">\\r\\n                        Sede / Objetivo\\r\\n                    </div>\\r\\n                    <div className=\\"overflow-hidden bg-white\\">\\r\\n                        {filteredObjectives.map((obj) => (\\r\\n                            <div key={obj.id} className=\\"h-16 border-b border-gray-100 flex items-center px-4 hover:bg-gray-50 transition-colors group\\">\\r\\n                                <div className=\\"flex items-center gap-3 w-full\\">\\r\\n                                    <div className=\\"w-8 h-8 rounded-lg bg-slate-100 text-slate-600 flex items-center justify-center font-bold text-xs group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors\\">\\r\\n                                        {obj.name.charAt(0)}\\r\\n                                    </div>\\r\\n                                    <div className=\\"min-w-0\\">\\r\\n                                        <p className=\\"text-sm font-bold text-gray-700 truncate\\">{obj.name}</p>\\r\\n                                        <p className=\\"text-[10px] text-gray-400 truncate\\">{obj.address}</p>\\r\\n                                    </div>\\r\\n                                </div>\\r\\n                            </div>\\r\\n                        ))}\\r\\n                    </div>\\r\\n                </div>\\r\\n\\r\\n                {/* rea del Gr谩fico */}\\r\\n                <div className=\\"flex-1 overflow-auto bg-slate-50 relative\\">\\r\\n                    <div className=\\"min-w-max\\">\\r\\n                        {/* Cabecera de D铆as */}\\r\\n                        <div className=\\"flex border-b border-gray-200 sticky top-0 z-10 bg-white/95 backdrop-blur shadow-sm h-10\\">\\r\\n                            {days.map(d => {\\r\\n                                const isToday = isSameDay(d, new Date());\\r\\n                                return (\\r\\n                                    <div key={d.toISOString()} className={`flex-shrink-0 border-r border-gray-100 flex flex-col justify-center items-center ${isToday ? \'bg-indigo-50/50\' : \'\'}`} style={{ width: cellWidth }}>\\r\\n                                        <div className=\\"flex gap-1 items-baseline\\">\\r\\n                                            <span className={`text-[10px] font-bold uppercase ${isToday ? \'text-indigo-600\' : \'text-gray-400\'}`}>\\r\\n                                                {format(d, \'EEE\', { locale: es })}\\r\\n                                            </span>\\r\\n                                            <span className={`text-xs font-bold leading-none ${isToday ? \'text-indigo-700\' : \'text-gray-700\'}`}>\\r\\n                                                {format(d, \'d\')}\\r\\n                                            </span>\\r\\n                                        </div>\\r\\n                                    </div>\\r\\n                                );\\r\\n                            })}\\r\\n                        </div>\\r\\n\\r\\n                        {/* Cuerpo del Gr谩fico */}\\r\\n                        <div className=\\"relative\\">\\r\\n                            {/* L铆neas de gu铆a verticales (D铆as y Sub-divisiones horarias) */}\\r\\n                            <div className=\\"absolute inset-0 flex pointer-events-none h-full\\">\\r\\n                                {days.map(d => (\\r\\n                                    <div key={d.toISOString()} className=\\"border-r border-gray-300 h-full relative\\" style={{ width: cellWidth }}>\\r\\n                                        {/* L铆neas tenues cada 6 horas (00, 06, 12, 18) si hay suficiente zoom */}\\r\\n                                        {cellWidth > 150 && (\\r\\n                                            <>\\r\\n                                                <div className=\\"absolute left-[25%] top-0 bottom-0 border-r border-gray-100 border-dashed w-0\\"></div>\\r\\n                                                <div className=\\"absolute left-[50%] top-0 bottom-0 border-r border-gray-100 border-dashed w-0\\"></div>\\r\\n                                                <div className=\\"absolute left-[75%] top-0 bottom-0 border-r border-gray-100 border-dashed w-0\\"></div>\\r\\n                                            </>\\r\\n                                        )}\\r\\n                                    </div>\\r\\n                                ))}\\r\\n                            </div>\\r\\n\\r\\n                            {/* Filas de Datos */}\\r\\n                            {filteredObjectives.map((obj) => {\\r\\n                                const objShifts = shifts.filter(s => s.objectiveId === obj.id);\\r\\n\\r\\n                                return (\\r\\n                                    <div key={obj.id} className=\\"h-16 border-b border-gray-200/50 relative hover:bg-white/50 transition-colors\\">\\r\\n                                        {objShifts.map(shift => {\\r\\n                                            const style = getShiftStyle(shift);\\r\\n                                            if (!style) return null;\\r\\n                                            \\r\\n                                            const isVacant = shift.employeeId === \'VACANTE\';\\r\\n                                            const start = safeDate(shift.startTime);\\r\\n                                            const end = safeDate(shift.endTime);\\r\\n\\r\\n                                            return (\\r\\n                                                <div \\r\\n                                                    key={shift.id}\\r\\n                                                    onClick={() => setSelectedShift(shift)} //  ABRIR MODAL\\r\\n                                                    className={`absolute top-3 h-10 rounded-md shadow-sm border text-[10px] flex flex-col justify-center px-2 cursor-pointer transition-all hover:brightness-110 hover:shadow-md hover:scale-[1.01] hover:z-30 overflow-hidden whitespace-nowrap\\r\\n                                                        ${isVacant \\r\\n                                                            ? \'bg-gray-100 border-gray-300 text-gray-400 border-dashed\' \\r\\n                                                            : shift.isOvertime \\r\\n                                                                ? \'bg-amber-500 border-amber-600 text-white\'\\r\\n                                                                : \'bg-indigo-600 border-indigo-700 text-white\'\\r\\n                                                        }\\r\\n                                                    `}\\r\\n                                                    style={style}\\r\\n                                                    title={`${shift.employeeName} (${format(start, \'HH:mm\')} - ${format(end, \'HH:mm\')})`}\\r\\n                                                >\\r\\n                                                    <span className=\\"font-bold truncate\\">{isVacant ? \'VACANTE\' : shift.employeeName}</span>\\r\\n                                                    {cellWidth > 80 && (\\r\\n                                                        <span className=\\"opacity-90 text-[9px] font-mono\\">{format(start, \'HH:mm\')} - {format(end, \'HH:mm\')}</span>\\r\\n                                                    )}\\r\\n                                                </div>\\r\\n                                            );\\r\\n                                        })}\\r\\n                                    </div>\\r\\n                                );\\r\\n                            })}\\r\\n                        </div>\\r\\n                    </div>\\r\\n                </div>\\r\\n            </div>\\r\\n\\r\\n            {/*  MODAL DE DETALLE DEL TURNO */}\\r\\n            {selectedShift && (\\r\\n                <div className=\\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-in fade-in duration-200\\">\\r\\n                    <div className=\\"bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100\\">\\r\\n                        <div className=\\"bg-gray-50 px-5 py-4 border-b border-gray-100 flex justify-between items-center\\">\\r\\n                            <h3 className=\\"font-bold text-gray-800 flex items-center gap-2\\">\\r\\n                                <Clock size={16} className=\\"text-indigo-600\\"/> Detalle de Turno\\r\\n                            </h3>\\r\\n                            <button onClick={() => setSelectedShift(null)} className=\\"text-gray-400 hover:text-gray-600 transition-colors\\"><X size={20}/></button>\\r\\n                        </div>\\r\\n                        <div className=\\"p-6 space-y-4\\">\\r\\n                            \\r\\n                            {/* Empleado */}\\r\\n                            <div>\\r\\n                                <label className=\\"text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block\\">Colaborador</label>\\r\\n                                <div className=\\"flex items-center gap-3\\">\\r\\n                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${selectedShift.employeeId === \'VACANTE\' ? \'bg-gray-100 text-gray-400\' : \'bg-indigo-100 text-indigo-700\'}`}>\\r\\n                                        {selectedShift.employeeName === \'VACANTE\' ? \'V\' : selectedShift.employeeName.charAt(0)}\\r\\n                                    </div>\\r\\n                                    <div>\\r\\n                                        <p className=\\"font-bold text-gray-800 text-sm\\">{selectedShift.employeeName}</p>\\r\\n                                        <p className=\\"text-xs text-gray-500\\">{selectedShift.employeeId === \'VACANTE\' ? \'Posici贸n vacante\' : \'Asignado\'}</p>\\r\\n                                    </div>\\r\\n                                </div>\\r\\n                            </div>\\r\\n\\r\\n                            {/* Horario y Lugar */}\\r\\n                            <div className=\\"grid grid-cols-2 gap-4 pt-2\\">\\r\\n                                <div className=\\"bg-slate-50 p-3 rounded-lg border border-slate-100\\">\\r\\n                                    <label className=\\"text-[10px] font-bold text-gray-400 uppercase block mb-1\\">Horario</label>\\r\\n                                    <p className=\\"font-mono text-sm text-indigo-700 font-bold\\">\\r\\n                                        {format(safeDate(selectedShift.startTime), \'HH:mm\')} - {format(safeDate(selectedShift.endTime), \'HH:mm\')}\\r\\n                                    </p>\\r\\n                                    <p className=\\"text-[10px] text-gray-400 mt-1\\">{differenceInMinutes(safeDate(selectedShift.endTime), safeDate(selectedShift.startTime)) / 60} horas</p>\\r\\n                                </div>\\r\\n                                <div className=\\"bg-slate-50 p-3 rounded-lg border border-slate-100\\">\\r\\n                                    <label className=\\"text-[10px] font-bold text-gray-400 uppercase block mb-1\\">Objetivo</label>\\r\\n                                    <p className=\\"text-xs font-bold text-gray-700 line-clamp-2\\">{selectedShift.objectiveName}</p>\\r\\n                                </div>\\r\\n                            </div>\\r\\n\\r\\n                            {/* Estado */}\\r\\n                            <div className=\\"pt-2\\">\\r\\n                                <div className={`flex items-center gap-2 p-2 rounded-lg text-xs font-bold ${\\r\\n                                    selectedShift.status === \'Completed\' ? \'bg-green-50 text-green-700 border border-green-100\' :\\r\\n                                    selectedShift.status === \'InProgress\' ? \'bg-blue-50 text-blue-700 border border-blue-100 animate-pulse\' :\\r\\n                                    \'bg-gray-50 text-gray-500 border border-gray-200\'\\r\\n                                }`}>\\r\\n                                    <CheckCircle2 size={14} /> \\r\\n                                    Estado: {selectedShift.status === \'Assigned\' ? \'Programado\' : selectedShift.status}\\r\\n                                </div>\\r\\n                            </div>\\r\\n\\r\\n                        </div>\\r\\n                        <div className=\\"bg-gray-50 px-5 py-3 flex justify-end\\">\\r\\n                            <button onClick={() => setSelectedShift(null)} className=\\"px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors shadow-sm\\">\\r\\n                                Cerrar\\r\\n                            </button>\\r\\n                        </div>\\r\\n                    </div>\\r\\n                </div>\\r\\n            )}\\r\\n\\r\\n        </div>\\r\\n    );\\r\\n}\\n\\n\\n\\n"},{"id":"uw7lqcivk","name":"ObjectiveMatrixView.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\planning\\\\ObjectiveMatrixView.tsx","area":"FRONTEND","content":"import React, { useState, useEffect, useMemo } from \'react\';\\r\\nimport { startOfMonth, endOfMonth, eachDayOfInterval, format, getDay } from \'date-fns\';\\r\\nimport { es } from \'date-fns/locale\';\\r\\nimport { IShift } from \'@/common/interfaces/shift.interface\';\\r\\nimport { IEmployee } from \'@/common/interfaces/employee.interface\';\\r\\nimport { IObjective } from \'@/common/interfaces/client.interface\';\\r\\nimport { callManageData, callManageEmployees, db } from \'@/services/firebase-client.service\';\\r\\nimport { collection, query, where, getDocs, Timestamp } from \'firebase/firestore\';\\r\\nimport { RefreshCw, FileSpreadsheet, MapPin, FileDown, Printer } from \'lucide-react\'; // Iconos nuevos\\r\\nimport Button from \'@/components/common/Button\';\\r\\nimport toast from \'react-hot-toast\';\\r\\n\\r\\n// Librer铆as de Exportaci贸n\\r\\nimport * as XLSX from \'xlsx\';\\r\\nimport { saveAs } from \'file-saver\';\\r\\nimport jsPDF from \'jspdf\';\\r\\nimport autoTable from \'jspdf-autotable\';\\r\\n\\r\\nexport function ObjectiveMatrixView() {\\r\\n    const [loading, setLoading] = useState(false);\\r\\n    const [objectives, setObjectives] = useState<IObjective[]>([]);\\r\\n    const [selectedObjectiveId, setSelectedObjectiveId] = useState(\'\');\\r\\n    \\r\\n    const [currentDate, setCurrentDate] = useState(new Date());\\r\\n    const [shifts, setShifts] = useState<IShift[]>([]);\\r\\n    const [employees, setEmployees] = useState<IEmployee[]>([]);\\r\\n\\r\\n    // 1. Cargar Objetivos\\r\\n    useEffect(() => {\\r\\n        const loadObj = async () => {\\r\\n            try {\\r\\n                const res = await callManageData({ action: \'GET_ALL_OBJECTIVES\', payload: {} });\\r\\n                const data = (res.data as any).data || [];\\r\\n                setObjectives(data);\\r\\n                if (data.length > 0) setSelectedObjectiveId(data[0].id);\\r\\n            } catch (e) { console.error(e); }\\r\\n        };\\r\\n        loadObj();\\r\\n    }, []);\\r\\n\\r\\n    // 2. Cargar Datos\\r\\n    const loadMatrixData = async () => {\\r\\n        if (!selectedObjectiveId) return;\\r\\n        setLoading(true);\\r\\n        try {\\r\\n            const start = startOfMonth(currentDate);\\r\\n            const end = endOfMonth(currentDate);\\r\\n\\r\\n            // A. Turnos\\r\\n            const shiftsRef = collection(db, \'turnos\');\\r\\n            const q = query(\\r\\n                shiftsRef,\\r\\n                where(\'objectiveId\', \'==\', selectedObjectiveId),\\r\\n                where(\'startTime\', \'>=\', Timestamp.fromDate(start)),\\r\\n                where(\'startTime\', \'<=\', Timestamp.fromDate(end))\\r\\n            );\\r\\n            const snap = await getDocs(q);\\r\\n            const loadedShifts = snap.docs.map(d => ({ id: d.id, ...d.data() } as IShift));\\r\\n            setShifts(loadedShifts);\\r\\n\\r\\n            // B. Empleados\\r\\n            const uniqueEmpIds = Array.from(new Set(loadedShifts.map(s => s.employeeId).filter(id => id !== \'VACANTE\')));\\r\\n            \\r\\n            if (uniqueEmpIds.length > 0) {\\r\\n                const obj = objectives.find(o => o.id === selectedObjectiveId);\\r\\n                const empRes = await callManageEmployees({ action: \'GET_ALL_EMPLOYEES\', payload: { clientId: obj?.clientId } });\\r\\n                const allEmps = (empRes.data as any).data as IEmployee[];\\r\\n                setEmployees(allEmps.filter(e => uniqueEmpIds.includes(e.uid)));\\r\\n            } else {\\r\\n                setEmployees([]);\\r\\n            }\\r\\n\\r\\n        } catch (e: any) {\\r\\n            toast.error(\\"Error cargando matriz: \\" + e.message);\\r\\n        } finally {\\r\\n            setLoading(false);\\r\\n        }\\r\\n    };\\r\\n\\r\\n    useEffect(() => {\\r\\n        loadMatrixData();\\r\\n    }, [selectedObjectiveId, currentDate]);\\r\\n\\r\\n    const daysInMonth = useMemo(() => {\\r\\n        return eachDayOfInterval({\\r\\n            start: startOfMonth(currentDate),\\r\\n            end: endOfMonth(currentDate)\\r\\n        });\\r\\n    }, [currentDate]);\\r\\n\\r\\n    // 3. Helper Visual (M, T, N, F)\\r\\n    const getShiftVisual = (shift?: IShift) => {\\r\\n        if (!shift) return { code: \'\', color: \'bg-white\' };\\r\\n\\r\\n        // Detecci贸n de Franco\\r\\n        if ((shift.role && shift.role.toLowerCase().includes(\'franco\')) || \\r\\n            (shift.employeeName && shift.employeeName.toLowerCase().includes(\'franco\'))) {\\r\\n            return { code: \'F\', color: \'bg-slate-800 text-white font-bold\' }; \\r\\n        }\\r\\n\\r\\n        const startHour = shift.startTime instanceof Timestamp ? shift.startTime.toDate().getHours() : new Date(shift.startTime).getHours();\\r\\n\\r\\n        if (startHour >= 6 && startHour < 14) return { code: \'M\', color: \'bg-sky-200 text-sky-800 font-bold\' };\\r\\n        if (startHour >= 14 && startHour < 22) return { code: \'T\', color: \'bg-amber-100 text-amber-800 font-bold\' };\\r\\n        if (startHour >= 22 || startHour < 6) return { code: \'N\', color: \'bg-slate-700 text-white font-bold\' };\\r\\n\\r\\n        return { code: \'X\', color: \'bg-gray-100\' };\\r\\n    };\\r\\n\\r\\n    // --- 4. EXPORTAR EXCEL ---\\r\\n    const handleExportExcel = () => {\\r\\n        const objName = objectives.find(o => o.id === selectedObjectiveId)?.name || \'Cronograma\';\\r\\n        const monthStr = format(currentDate, \'MMMM_yyyy\', { locale: es });\\r\\n        \\r\\n        // Encabezados\\r\\n        const headers = [\'Legajo\', \'Apellido y Nombre\', ...daysInMonth.map(d => format(d, \'dd\')), \'Total Hs\'];\\r\\n        \\r\\n        // Filas\\r\\n        const dataRows = employees.map(emp => {\\r\\n            let totalHours = 0;\\r\\n            const daysData = daysInMonth.map(day => {\\r\\n                const dayKey = format(day, \'yyyy-MM-dd\'); //  FIX ZONA HORARIA LOCAL\\r\\n                const shift = shifts.find(s => {\\r\\n                    const sDate = s.startTime instanceof Timestamp ? s.startTime.toDate() : new Date(s.startTime);\\r\\n                    return format(sDate, \'yyyy-MM-dd\') === dayKey && s.employeeId === emp.uid && s.status !== \'Canceled\';\\r\\n                });\\r\\n\\r\\n                if (!shift) return \'\';\\r\\n                const visual = getShiftVisual(shift);\\r\\n                \\r\\n                // Sumar horas si no es franco\\r\\n                if (visual.code !== \'F\') {\\r\\n                    const start = shift.startTime instanceof Timestamp ? shift.startTime.toDate() : new Date(shift.startTime);\\r\\n                    const end = shift.endTime instanceof Timestamp ? shift.endTime.toDate() : new Date(shift.endTime);\\r\\n                    totalHours += (end.getTime() - start.getTime()) / 3600000;\\r\\n                }\\r\\n                return visual.code;\\r\\n            });\\r\\n\\r\\n            return [emp.fileNumber || \'\', emp.name, ...daysData, Math.round(totalHours)];\\r\\n        });\\r\\n\\r\\n        // Crear Libro\\r\\n        const wb = XLSX.utils.book_new();\\r\\n        const ws = XLSX.utils.aoa_to_sheet([\\r\\n            [`CRONOGRAMA: ${objName.toUpperCase()} - ${monthStr.toUpperCase()}`], // T铆tulo\\r\\n            [], \\r\\n            headers, \\r\\n            ...dataRows\\r\\n        ]);\\r\\n\\r\\n        XLSX.utils.book_append_sheet(wb, ws, \\"Cronograma\\");\\r\\n        const excelBuffer = XLSX.write(wb, { bookType: \'xlsx\', type: \'array\' });\\r\\n        const data = new Blob([excelBuffer], { type: \'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8\' });\\r\\n        saveAs(data, `Cronograma_${objName}_${monthStr}.xlsx`);\\r\\n    };\\r\\n\\r\\n    // --- 5. EXPORTAR PDF ---\\r\\n    const handleExportPDF = () => {\\r\\n        const doc = new jsPDF({ orientation: \'landscape\' });\\r\\n        const objName = objectives.find(o => o.id === selectedObjectiveId)?.name || \'Cronograma\';\\r\\n        const monthStr = format(currentDate, \'MMMM yyyy\', { locale: es }).toUpperCase();\\r\\n\\r\\n        doc.setFontSize(14);\\r\\n        doc.text(`CRONOGRAMA: ${objName} - ${monthStr}`, 14, 15);\\r\\n\\r\\n        const head = [[\'Legajo\', \'Nombre\', ...daysInMonth.map(d => format(d, \'dd\')), \'Hs\']];\\r\\n        \\r\\n        const body = employees.map(emp => {\\r\\n            let totalHours = 0;\\r\\n            const row = [\\r\\n                emp.fileNumber || \'\',\\r\\n                emp.name,\\r\\n                ...daysInMonth.map(day => {\\r\\n                    const dayKey = format(day, \'yyyy-MM-dd\'); //  FIX ZONA HORARIA LOCAL\\r\\n                    const shift = shifts.find(s => {\\r\\n                        const sDate = s.startTime instanceof Timestamp ? s.startTime.toDate() : new Date(s.startTime);\\r\\n                        return format(sDate, \'yyyy-MM-dd\') === dayKey && s.employeeId === emp.uid && s.status !== \'Canceled\';\\r\\n                    });\\r\\n                    \\r\\n                    if (!shift) return \'\';\\r\\n                    const visual = getShiftVisual(shift);\\r\\n                    if (visual.code !== \'F\') {\\r\\n                        const start = shift.startTime instanceof Timestamp ? shift.startTime.toDate() : new Date(shift.startTime);\\r\\n                        const end = shift.endTime instanceof Timestamp ? shift.endTime.toDate() : new Date(shift.endTime);\\r\\n                        totalHours += (end.getTime() - start.getTime()) / 3600000;\\r\\n                    }\\r\\n                    return visual.code;\\r\\n                }),\\r\\n                String(Math.round(totalHours)) // Convertir a string para autoTable\\r\\n            ];\\r\\n            // Push the totalHours as the last element of the row, correctly typed.\\r\\n            row[row.length - 1] = String(Math.round(totalHours));\\r\\n            return row;\\r\\n        });\\r\\n\\r\\n        autoTable(doc, {\\r\\n            head: head,\\r\\n            body: body,\\r\\n            startY: 20,\\r\\n            styles: { fontSize: 6, cellPadding: 1, halign: \'center\', valign: \'middle\' }, // Letra chica para que entre\\r\\n            headStyles: { fillColor: [30, 41, 59] }, // Slate-800\\r\\n            columnStyles: {\\r\\n                0: { cellWidth: 15 }, // Legajo\\r\\n                1: { cellWidth: 40, halign: \'left\' }, // Nombre\\r\\n                // El resto autom谩tico\\r\\n            },\\r\\n            theme: \'grid\'\\r\\n        });\\r\\n\\r\\n        doc.save(`Cronograma_${objName}_${monthStr}.pdf`);\\r\\n    };\\r\\n\\r\\n    return (\\r\\n        <div className=\\"space-y-4\\">\\r\\n            \\r\\n            {/* Header */}\\r\\n            <div className=\\"bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-wrap gap-4 justify-between items-center\\">\\r\\n                <div className=\\"flex items-center gap-4\\">\\r\\n                    <div className=\\"p-2 bg-indigo-50 rounded-lg text-indigo-600\\"><FileSpreadsheet size={24}/></div>\\r\\n                    <div>\\r\\n                        <h2 className=\\"text-lg font-bold text-gray-800\\">Matriz de Turnos</h2>\\r\\n                        <p className=\\"text-xs text-gray-500\\">Vista compacta mensual por objetivo.</p>\\r\\n                    </div>\\r\\n                </div>\\r\\n\\r\\n                <div className=\\"flex gap-3 items-center\\">\\r\\n                    <input \\r\\n                        type=\\"month\\" \\r\\n                        className=\\"border p-2 rounded-lg text-sm font-bold text-gray-700\\"\\r\\n                        value={format(currentDate, \'yyyy-MM\')}\\r\\n                        onChange={(e) => setCurrentDate(new Date(e.target.value + \'-01\'))}\\r\\n                    />\\r\\n\\r\\n                    <div className=\\"relative min-w-[250px]\\">\\r\\n                        <select \\r\\n                            className=\\"w-full appearance-none border border-gray-300 rounded-lg p-2 pl-3 pr-8 text-sm font-bold text-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none\\"\\r\\n                            value={selectedObjectiveId}\\r\\n                            onChange={(e) => setSelectedObjectiveId(e.target.value)}\\r\\n                        >\\r\\n                            {objectives.map(o => <option key={o.id} value={o.id}>{o.name}</option>)}\\r\\n                        </select>\\r\\n                        <MapPin size={16} className=\\"absolute right-3 top-2.5 text-gray-400 pointer-events-none\\"/>\\r\\n                    </div>\\r\\n\\r\\n                    <Button onClick={loadMatrixData} className=\\"bg-white border hover:bg-gray-50 text-gray-600 p-2\\"><RefreshCw size={18} className={loading ? \'animate-spin\' : \'\'}/></Button>\\r\\n                    \\r\\n                    {/* BOTONES DE EXPORTACIN */}\\r\\n                    <div className=\\"h-8 w-px bg-gray-300 mx-1\\"></div>\\r\\n                    <Button onClick={handleExportExcel} className=\\"bg-emerald-600 text-white hover:bg-emerald-700 flex gap-2 items-center\\" title=\\"Descargar Excel\\">\\r\\n                        <FileDown size={18}/> Excel\\r\\n                    </Button>\\r\\n                    <Button onClick={handleExportPDF} className=\\"bg-rose-600 text-white hover:bg-rose-700 flex gap-2 items-center\\" title=\\"Imprimir PDF\\">\\r\\n                        <Printer size={18}/> PDF\\r\\n                    </Button>\\r\\n                </div>\\r\\n            </div>\\r\\n\\r\\n            {/* TABLA MATRIZ */}\\r\\n            <div className=\\"bg-white rounded-xl shadow-lg border border-gray-300 overflow-x-auto\\">\\r\\n                <table className=\\"min-w-full border-collapse\\">\\r\\n                    <thead>\\r\\n                        <tr className=\\"bg-slate-800 text-white text-xs uppercase\\">\\r\\n                            <th className=\\"p-3 text-left w-48 font-bold border-r border-slate-600 sticky left-0 z-10 bg-slate-800\\">\\r\\n                                {format(currentDate, \'MMMM yyyy\', { locale: es }).toUpperCase()}\\r\\n                            </th>\\r\\n                            {daysInMonth.map(d => (\\r\\n                                <th key={d.toString()} className={`w-8 border-r border-slate-600 text-center ${[0,6].includes(getDay(d)) ? \'bg-slate-700\' : \'\'}`}>\\r\\n                                    {format(d, \'EEEEE\', { locale: es })}\\r\\n                                </th>\\r\\n                            ))}\\r\\n                            <th className=\\"w-16 text-center bg-slate-900 font-bold\\">TOT</th>\\r\\n                        </tr>\\r\\n                        <tr className=\\"bg-gray-100 text-gray-600 text-xs font-mono\\">\\r\\n                            <th className=\\"p-2 text-left border-r border-gray-300 sticky left-0 z-10 bg-gray-100 font-normal italic\\">\\r\\n                                Legajo / Guardia\\r\\n                            </th>\\r\\n                            {daysInMonth.map(d => (\\r\\n                                <th key={d.toString()} className=\\"border-r border-gray-300 text-center border-b font-bold\\">\\r\\n                                    {format(d, \'d\')}\\r\\n                                </th>\\r\\n                            ))}\\r\\n                            <th className=\\"border-b bg-gray-200\\">Hs</th>\\r\\n                        </tr>\\r\\n                    </thead>\\r\\n                    <tbody className=\\"text-xs\\">\\r\\n                        {employees.length === 0 && (\\r\\n                            <tr><td colSpan={daysInMonth.length + 2} className=\\"p-8 text-center text-gray-400 italic\\">No hay personal asignado en este per铆odo.</td></tr>\\r\\n                        )}\\r\\n                        \\r\\n                        {/* Filas de Empleados */}\\r\\n                        {employees.map(emp => {\\r\\n                            let totalHours = 0;\\r\\n                            return (\\r\\n                                <tr key={emp.uid} className=\\"border-b border-gray-200 hover:bg-indigo-50/30 transition-colors\\">\\r\\n                                    <td className=\\"p-2 border-r border-gray-200 font-medium text-gray-700 sticky left-0 z-10 bg-white\\">\\r\\n                                        <div className=\\"font-bold text-indigo-900 truncate max-w-[180px]\\">{emp.name}</div>\\r\\n                                        <div className=\\"text-[10px] text-gray-400\\">{emp.fileNumber || \'S/L\'}</div>\\r\\n                                    </td>\\r\\n                                    {daysInMonth.map(day => {\\r\\n                                        //  FIX: Usar format para evitar cambio de d铆a por UTC\\r\\n                                        const dayKey = format(day, \'yyyy-MM-dd\');\\r\\n                                        \\r\\n                                        const shift = shifts.find(s => {\\r\\n                                            const sDate = s.startTime instanceof Timestamp ? s.startTime.toDate() : new Date(s.startTime);\\r\\n                                            // Comparamos strings locales\\r\\n                                            return format(sDate, \'yyyy-MM-dd\') === dayKey && s.employeeId === emp.uid && s.status !== \'Canceled\';\\r\\n                                        });\\r\\n\\r\\n                                        const visual = getShiftVisual(shift);\\r\\n                                        \\r\\n                                        if (shift && visual.code !== \'F\') {\\r\\n                                            const start = shift.startTime instanceof Timestamp ? shift.startTime.toDate() : new Date(shift.startTime);\\r\\n                                            const end = shift.endTime instanceof Timestamp ? shift.endTime.toDate() : new Date(shift.endTime);\\r\\n                                            totalHours += (end.getTime() - start.getTime()) / 3600000;\\r\\n                                        }\\r\\n\\r\\n                                        return (\\r\\n                                            <td key={dayKey} className=\\"border-r border-gray-200 p-0 h-10 relative\\">\\r\\n                                                {shift ? (\\r\\n                                                    <div className={`w-full h-full flex items-center justify-center text-[10px] border-b border-white ${visual.color}`} title={`${visual.code}`}>\\r\\n                                                        {visual.code}\\r\\n                                                    </div>\\r\\n                                                ) : null}\\r\\n                                            </td>\\r\\n                                        );\\r\\n                                    })}\\r\\n                                    <td className=\\"border-l border-gray-300 bg-gray-50 text-center font-bold text-indigo-700\\">\\r\\n                                        {Math.round(totalHours)}\\r\\n                                    </td>\\r\\n                                </tr>\\r\\n                            );\\r\\n                        })}\\r\\n                    </tbody>\\r\\n                </table>\\r\\n            </div>\\r\\n\\r\\n            {/* Referencias */}\\r\\n            <div className=\\"bg-white p-4 rounded-lg border border-gray-200 flex gap-6 text-xs\\">\\r\\n                <span className=\\"font-bold text-gray-500 uppercase\\">Referencias:</span>\\r\\n                <div className=\\"flex items-center gap-2\\"><span className=\\"w-4 h-4 bg-sky-200 block border\\"></span> Ma帽ana (06-14)</div>\\r\\n                <div className=\\"flex items-center gap-2\\"><span className=\\"w-4 h-4 bg-amber-100 block border\\"></span> Tarde (14-22)</div>\\r\\n                <div className=\\"flex items-center gap-2\\"><span className=\\"w-4 h-4 bg-slate-700 block border\\"></span> Noche (22-06)</div>\\r\\n                <div className=\\"flex items-center gap-2\\"><span className=\\"w-4 h-4 bg-slate-800 block border\\"></span> Franco</div>\\r\\n            </div>\\r\\n        </div>\\r\\n    );\\r\\n}\\n\\n"},{"id":"1meofmwke","name":"scheduler.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\scheduler.tsx","area":"FRONTEND","content":"import React, { useReducer, useMemo, useEffect, useState } from \'react\';\\r\\nimport { \\r\\n  format, \\r\\n  addMonths, \\r\\n  subMonths, \\r\\n  startOfMonth, \\r\\n  endOfMonth, \\r\\n  startOfWeek, \\r\\n  endOfWeek, \\r\\n  isSameDay, \\r\\n  addDays, \\r\\n  parseISO, \\r\\n  setHours, \\r\\n  setMinutes,\\r\\n  differenceInMinutes,\\r\\n  addMinutes,\\r\\n  startOfDay,\\r\\n  endOfDay,\\r\\n  isBefore,\\r\\n  isAfter,\\r\\n  max,\\r\\n  min\\r\\n} from \'date-fns\';\\r\\nimport { es } from \'date-fns/locale\';\\r\\nimport { \\r\\n  ChevronLeft, \\r\\n  ChevronRight, \\r\\n  Clock,\\r\\n  Lock,\\r\\n  ZoomIn,\\r\\n  ZoomOut\\r\\n} from \'lucide-react\';\\r\\nimport { clsx, type ClassValue } from \'clsx\';\\r\\nimport { twMerge } from \'tailwind-merge\';\\r\\n\\r\\nfunction cn(...inputs: ClassValue[]) {\\r\\n  return twMerge(clsx(inputs));\\r\\n}\\r\\n\\r\\nexport type ViewType = \'month\' | \'week\' | \'day\';\\r\\n\\r\\nexport interface SchedulerEvent {\\r\\n  id: string;\\r\\n  title: string;\\r\\n  description?: string;\\r\\n  start: Date | string;\\r\\n  end: Date | string;\\r\\n  color?: string;\\r\\n  originalData?: any;\\r\\n}\\r\\n\\r\\ninterface SchedulerState {\\r\\n  currentDate: Date;\\r\\n  view: ViewType;\\r\\n}\\r\\n\\r\\ntype SchedulerAction = \\r\\n  | { type: \'SET_VIEW\'; payload: ViewType }\\r\\n  | { type: \'NAVIGATE_NEXT\' }\\r\\n  | { type: \'NAVIGATE_PREV\' }\\r\\n  | { type: \'NAVIGATE_TODAY\' }\\r\\n  | { type: \'SET_DATE\'; payload: Date };\\r\\n\\r\\ninterface SchedulerProps {\\r\\n  events: SchedulerEvent[];\\r\\n  isLoading?: boolean;\\r\\n  onEventClick?: (event: SchedulerEvent) => void;\\r\\n  onDropInfo?: (data: { employeeId: string, employeeName: string, start?: Date, end?: Date, targetShiftId?: string }) => void;\\r\\n  onEventMove?: (event: SchedulerEvent, newStart: Date, newEnd: Date) => void;\\r\\n  onDateChange?: (date: Date) => void;\\r\\n  onViewChange?: (view: ViewType) => void;\\r\\n  startHour?: number;\\r\\n  endHour?: number;\\r\\n  readOnly?: boolean;\\r\\n}\\r\\n\\r\\nconst schedulerReducer = (state: SchedulerState, action: SchedulerAction): SchedulerState => {\\r\\n  switch (action.type) {\\r\\n    case \'SET_VIEW\': return { ...state, view: action.payload };\\r\\n    case \'NAVIGATE_NEXT\': {\\r\\n      const { view, currentDate } = state;\\r\\n      let nextDate = view === \'month\' ? addMonths(currentDate, 1) : addDays(currentDate, view === \'week\' ? 7 : 1);\\r\\n      return { ...state, currentDate: nextDate };\\r\\n    }\\r\\n    case \'NAVIGATE_PREV\': {\\r\\n      const { view, currentDate } = state;\\r\\n      let prevDate = view === \'month\' ? subMonths(currentDate, 1) : addDays(currentDate, view === \'week\' ? -7 : -1);\\r\\n      return { ...state, currentDate: prevDate };\\r\\n    }\\r\\n    case \'NAVIGATE_TODAY\': return { ...state, currentDate: new Date() };\\r\\n    case \'SET_DATE\': return { ...state, currentDate: action.payload };\\r\\n    default: return state;\\r\\n  }\\r\\n};\\r\\n\\r\\nconst Scheduler: React.FC<SchedulerProps> = ({ \\r\\n  events = [], \\r\\n  isLoading = false, \\r\\n  onEventClick, \\r\\n  onDropInfo, \\r\\n  onEventMove,\\r\\n  onDateChange,\\r\\n  onViewChange,\\r\\n  startHour = 0, \\r\\n  endHour = 24,\\r\\n  readOnly = false\\r\\n}) => {\\r\\n  \\r\\n  const [state, dispatch] = useReducer(schedulerReducer, { currentDate: new Date(), view: \'week\' });\\r\\n  \\r\\n  //  NUEVO: Estado para el Zoom (Altura de celda din谩mica)\\r\\n  const [cellHeight, setCellHeight] = useState(60); \\r\\n\\r\\n  useEffect(() => { if (onDateChange) onDateChange(state.currentDate); }, [state.currentDate, onDateChange]);\\r\\n  useEffect(() => { if (onViewChange) onViewChange(state.view); }, [state.view, onViewChange]);\\r\\n\\r\\n  const normalizedEvents = useMemo(() => {\\r\\n    return events.map(evt => ({\\r\\n      ...evt,\\r\\n      start: typeof evt.start === \'string\' ? parseISO(evt.start) : evt.start,\\r\\n      end: typeof evt.end === \'string\' ? parseISO(evt.end) : evt.end,\\r\\n    }));\\r\\n  }, [events]);\\r\\n\\r\\n  // --- HANDLERS ---\\r\\n\\r\\n  const handleSlotDrop = (e: React.DragEvent, day: Date, hour: number) => {\\r\\n      e.preventDefault();\\r\\n      if (readOnly) return;\\r\\n\\r\\n      const rect = (e.currentTarget as HTMLElement).getBoundingClientRect();\\r\\n      const offsetY = e.clientY - rect.top;\\r\\n      const minutesAdded = Math.floor((offsetY / cellHeight) * 60);\\r\\n      const roundedMinutes = Math.round(minutesAdded / 15) * 15; \\r\\n\\r\\n      const newStart = new Date(day);\\r\\n      newStart.setHours(hour, roundedMinutes, 0, 0);\\r\\n\\r\\n      const movedShiftId = e.dataTransfer.getData(\\"shiftId\\");\\r\\n      if (movedShiftId && onEventMove) {\\r\\n          const shift = normalizedEvents.find(s => s.id === movedShiftId);\\r\\n          if (shift) {\\r\\n              const durationMs = (shift.end as Date).getTime() - (shift.start as Date).getTime();\\r\\n              const newEnd = new Date(newStart.getTime() + durationMs);\\r\\n              onEventMove(shift, newStart, newEnd);\\r\\n          }\\r\\n          return;\\r\\n      }\\r\\n\\r\\n      const employeeId = e.dataTransfer.getData(\\"employeeId\\");\\r\\n      const employeeName = e.dataTransfer.getData(\\"employeeName\\");\\r\\n      if (employeeId && onDropInfo) {\\r\\n          const end = addMinutes(newStart, 480); \\r\\n          onDropInfo({ employeeId, employeeName, start: newStart, end });\\r\\n      }\\r\\n  };\\r\\n\\r\\n  const handleEventDrop = (e: React.DragEvent, targetEvent: SchedulerEvent) => {\\r\\n      e.preventDefault();\\r\\n      e.stopPropagation(); \\r\\n      if (readOnly) return;\\r\\n\\r\\n      const employeeId = e.dataTransfer.getData(\\"employeeId\\");\\r\\n      const employeeName = e.dataTransfer.getData(\\"employeeName\\");\\r\\n\\r\\n      if (employeeId && onDropInfo) {\\r\\n          onDropInfo({ \\r\\n              employeeId, \\r\\n              employeeName, \\r\\n              targetShiftId: targetEvent.id \\r\\n          });\\r\\n      }\\r\\n  };\\r\\n\\r\\n  const renderMonthView = () => {\\r\\n    const monthStart = startOfMonth(state.currentDate);\\r\\n    const monthEnd = endOfMonth(monthStart);\\r\\n    const startDate = startOfWeek(monthStart, { weekStartsOn: 1 });\\r\\n    const endDate = endOfWeek(monthEnd, { weekStartsOn: 1 });\\r\\n    \\r\\n    let days: React.ReactNode[] = []; \\r\\n    let day = startDate;\\r\\n    const rows = [];\\r\\n\\r\\n    while (day <= endDate) {\\r\\n        for (let i = 0; i < 7; i++) {\\r\\n            const cloneDay = day;\\r\\n            const isToday = isSameDay(day, new Date());\\r\\n            const dayEvents = normalizedEvents\\r\\n                .filter(e => isSameDay(e.start as Date, cloneDay))\\r\\n                .sort((a, b) => (a.start as Date).getTime() - (b.start as Date).getTime());\\r\\n            \\r\\n            days.push(\\r\\n                <div \\r\\n                    key={day.toISOString()} \\r\\n                    className={cn(\\r\\n                        \\"min-h-[120px] border-b border-r border-gray-100 p-1 relative transition-colors\\", //  Aument茅 altura m铆nima\\r\\n                        !isSameDay(day, monthStart) && day.getMonth() !== monthStart.getMonth() ? \\"bg-gray-50/30 text-gray-400\\" : \\"\\",\\r\\n                        !readOnly && \\"hover:bg-gray-50\\"\\r\\n                    )}\\r\\n                    onClick={() => dispatch({ type: \'SET_DATE\', payload: cloneDay })}\\r\\n                    onDragOver={!readOnly ? (e) => e.preventDefault() : undefined}\\r\\n                    onDrop={!readOnly ? (e) => {\\r\\n                        const employeeId = e.dataTransfer.getData(\\"employeeId\\");\\r\\n                        const employeeName = e.dataTransfer.getData(\\"employeeName\\");\\r\\n                        if (employeeId && onDropInfo) {\\r\\n                            const start = setHours(cloneDay, 9);\\r\\n                            const end = setHours(cloneDay, 17);\\r\\n                            onDropInfo({ employeeId, employeeName, start, end });\\r\\n                        }\\r\\n                    } : undefined}\\r\\n                >\\r\\n                    <div className=\\"flex justify-between items-center mb-1\\">\\r\\n                       <span className={cn(\\"text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full\\", isToday ? \\"bg-indigo-600 text-white\\" : \\"\\")}>\\r\\n                         {format(day, \'d\')}\\r\\n                       </span>\\r\\n                    </div>\\r\\n                    <div className=\\"flex flex-col gap-1 overflow-y-auto max-h-[90px] scrollbar-hide\\"> {/*  Scroll si hay muchos */}\\r\\n                        {dayEvents.map(evt => (\\r\\n                            <div \\r\\n                                key={evt.id} \\r\\n                                onClick={(e) => { e.stopPropagation(); onEventClick?.(evt); }} \\r\\n                                className={cn(\\"text-[10px] px-1 rounded truncate cursor-pointer flex items-center gap-1 shadow-sm\\", evt.color || \\"bg-blue-100 text-blue-800\\")}\\r\\n                                title={evt.title}\\r\\n                                draggable={!readOnly}\\r\\n                                onDragStart={!readOnly ? (e) => {\\r\\n                                    e.dataTransfer.setData(\\"shiftId\\", evt.id);\\r\\n                                    e.dataTransfer.effectAllowed = \\"move\\";\\r\\n                                } : undefined}\\r\\n                                onDragOver={!readOnly ? (e) => e.preventDefault() : undefined}\\r\\n                                onDrop={!readOnly ? (e) => handleEventDrop(e, evt) : undefined}\\r\\n                            >\\r\\n                                {readOnly && <Lock size={8} className=\\"opacity-50\\"/>}\\r\\n                                <span className=\\"font-bold\\">{format(evt.start as Date, \'HH:mm\')}</span> {evt.title}\\r\\n                            </div>\\r\\n                        ))}\\r\\n                    </div>\\r\\n                </div>\\r\\n            );\\r\\n            day = addDays(day, 1);\\r\\n        }\\r\\n        rows.push(<div className=\\"grid grid-cols-7\\" key={day.toISOString()}>{days}</div>);\\r\\n        days = []; \\r\\n    }\\r\\n    return <div className=\\"border-l border-t border-gray-200\\">{rows}</div>;\\r\\n  };\\r\\n\\r\\n  const renderTimeGrid = () => {\\r\\n    let daysToShow = state.view === \'week\' \\r\\n        ? Array.from({ length: 7 }).map((_, i) => addDays(startOfWeek(state.currentDate, { weekStartsOn: 1 }), i))\\r\\n        : [state.currentDate];\\r\\n\\r\\n    const hours = Array.from({ length: endHour - startHour }).map((_, i) => startHour + i);\\r\\n\\r\\n    return (\\r\\n      <div className=\\"flex flex-col h-full bg-white relative overflow-hidden\\">\\r\\n        <div className=\\"flex border-b border-gray-200 ml-14\\">\\r\\n          {daysToShow.map(day => {\\r\\n            const isToday = isSameDay(day, new Date());\\r\\n            return (\\r\\n              <div key={day.toISOString()} className=\\"flex-1 py-2 text-center border-r border-gray-100\\">\\r\\n                <div className={cn(\\"text-xs uppercase font-bold\\", isToday ? \\"text-indigo-600\\" : \\"text-gray-500\\")}>{format(day, \'EEE\', { locale: es })}</div>\\r\\n                <div className={cn(\\"text-lg font-bold\\", isToday ? \\"text-indigo-600\\" : \\"text-gray-800\\")}>{format(day, \'d\')}</div>\\r\\n              </div>\\r\\n            );\\r\\n          })}\\r\\n        </div>\\r\\n\\r\\n        <div className=\\"flex-1 overflow-y-auto relative flex\\">\\r\\n          <div className=\\"w-14 flex-shrink-0 bg-gray-50 border-r border-gray-200 sticky left-0 z-10 select-none bg-white\\">\\r\\n            {hours.map(h => {\\r\\n              const timeLabel = setMinutes(setHours(new Date(), h), 0);\\r\\n              return (\\r\\n                <div key={h} className=\\"border-b border-gray-100 text-[10px] text-gray-400 text-right pr-2 pt-1 relative box-border\\" style={{ height: cellHeight }}>\\r\\n                  <span className=\\"-top-2 relative\\">{format(timeLabel, \'HH:mm\')}</span>\\r\\n                </div>\\r\\n              );\\r\\n            })}\\r\\n          </div>\\r\\n\\r\\n          <div className=\\"flex-1 flex relative min-w-[600px]\\">\\r\\n            <div className=\\"absolute inset-0 flex flex-col z-0\\">\\r\\n               {hours.map(h => <div key={h} className=\\"w-full border-b border-gray-100 box-border\\" style={{ height: cellHeight }}></div>)}\\r\\n            </div>\\r\\n\\r\\n            {daysToShow.map(day => {\\r\\n              //  FIX NOCTURNIDAD: Definimos el rango del d铆a actual (00:00 a 23:59)\\r\\n              const columnStart = startOfDay(day);\\r\\n              const columnEnd = endOfDay(day);\\r\\n\\r\\n              // Filtramos eventos que se superponen con este d铆a (aunque hayan empezado ayer)\\r\\n              const dayEvents = normalizedEvents.filter(evt => {\\r\\n                  const s = evt.start as Date;\\r\\n                  const e = evt.end as Date;\\r\\n                  return isBefore(s, columnEnd) && isAfter(e, columnStart);\\r\\n              });\\r\\n\\r\\n              return (\\r\\n                <div key={day.toISOString()} className=\\"flex-1 border-r border-gray-100 relative h-full group/col\\">\\r\\n                  \\r\\n                  {!readOnly && (\\r\\n                      <div className=\\"absolute inset-0 z-0 flex flex-col opacity-0 group-hover/col:opacity-100 transition-opacity\\">\\r\\n                          {hours.map(h => (\\r\\n                              <div \\r\\n                                key={h} \\r\\n                                style={{ height: cellHeight }} \\r\\n                                className=\\"w-full hover:bg-indigo-50/30 border-b border-transparent box-border\\"\\r\\n                                onDragOver={(e) => { e.preventDefault(); e.dataTransfer.dropEffect = \\"move\\"; }}\\r\\n                                onDrop={(e) => handleSlotDrop(e, day, h)}\\r\\n                              />\\r\\n                          ))}\\r\\n                      </div>\\r\\n                  )}\\r\\n\\r\\n                  {dayEvents.map(evt => {\\r\\n                    const originalStart = evt.start as Date;\\r\\n                    const originalEnd = evt.end as Date;\\r\\n\\r\\n                    //  FIX: Recortamos visualmente el evento para que quepa en este d铆a\\r\\n                    // Si empieza ayer, visualmente empieza a las 00:00 de hoy\\r\\n                    const visualStart = isBefore(originalStart, columnStart) ? columnStart : originalStart;\\r\\n                    // Si termina ma帽ana, visualmente termina a las 23:59 de hoy\\r\\n                    const visualEnd = isAfter(originalEnd, columnEnd) ? columnEnd : originalEnd;\\r\\n                    \\r\\n                    const startH = visualStart.getHours();\\r\\n                    const startM = visualStart.getMinutes();\\r\\n                    \\r\\n                    // Si el fragmento termina antes de la hora de inicio de la vista, ignorar\\r\\n                    if (visualEnd.getHours() < startHour) return null; \\r\\n                    \\r\\n                    const minsFromTop = (Math.max(startH, startHour) - startHour) * 60 + startM;\\r\\n                    const top = Math.max(0, (minsFromTop / 60) * cellHeight);\\r\\n                    \\r\\n                    const durationMins = differenceInMinutes(visualEnd, visualStart);\\r\\n                    const height = (durationMins / 60) * cellHeight;\\r\\n\\r\\n                    // Ajuste m铆nimo para que se vea\\r\\n                    const displayHeight = Math.max(height, 20);\\r\\n\\r\\n                    return (\\r\\n                      <div\\r\\n                        key={`${evt.id}-${day.toISOString()}`} // Key 煤nica para fragmentos\\r\\n                        onClick={(e) => { e.stopPropagation(); onEventClick?.(evt); }}\\r\\n                        draggable={!readOnly}\\r\\n                        onDragStart={!readOnly ? (e) => {\\r\\n                            e.dataTransfer.setData(\\"shiftId\\", evt.id);\\r\\n                            e.dataTransfer.effectAllowed = \\"move\\";\\r\\n                        } : undefined}\\r\\n                        onDragOver={!readOnly ? (e) => { \\r\\n                            e.preventDefault(); \\r\\n                            e.stopPropagation(); \\r\\n                            e.dataTransfer.dropEffect = \\"copy\\"; \\r\\n                        } : undefined} \\r\\n                        onDrop={!readOnly ? (e) => handleEventDrop(e, evt) : undefined} \\r\\n                        \\r\\n                        className={cn(\\r\\n                            \\"absolute left-1 right-1 rounded border-l-4 p-1 shadow-sm cursor-pointer transition-all text-xs overflow-hidden group z-10\\", \\r\\n                            !readOnly && \\"hover:z-50 hover:brightness-95 hover:shadow-md\\", \\r\\n                            readOnly && \\"opacity-90\\", \\r\\n                            evt.color || \\"bg-indigo-50 border-indigo-500\\"\\r\\n                        )}\\r\\n                        style={{ top: `${top}px`, height: `${displayHeight}px` }}\\r\\n                        title={`${evt.title}\\\\n${format(originalStart, \'HH:mm\')} - ${format(originalEnd, \'HH:mm\')}`}\\r\\n                      >\\r\\n                        {readOnly && <Lock size={10} className=\\"absolute top-1 right-1 text-gray-500 opacity-50\\"/>}\\r\\n                        <div className=\\"font-bold truncate group-hover:whitespace-normal\\">{evt.title}</div>\\r\\n                        <div className=\\"opacity-80 truncate text-[10px] flex items-center gap-1\\">\\r\\n                           <Clock size={10}/> \\r\\n                           {/* Mostramos horario real, aunque visualmente est茅 cortado */}\\r\\n                           {format(originalStart, \'HH:mm\')} - {format(originalEnd, \'HH:mm\')}\\r\\n                        </div>\\r\\n                      </div>\\r\\n                    );\\r\\n                  })}\\r\\n                </div>\\r\\n              );\\r\\n            })}\\r\\n          </div>\\r\\n        </div>\\r\\n      </div>\\r\\n    );\\r\\n  };\\r\\n\\r\\n  return (\\r\\n    <div className=\\"flex flex-col h-full bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden\\">\\r\\n      <header className=\\"flex items-center justify-between px-4 py-3 border-b border-gray-100 bg-white\\">\\r\\n        <div className=\\"flex items-center gap-4\\">\\r\\n          <div className=\\"flex items-center bg-gray-100 rounded-lg p-1\\">\\r\\n            <button onClick={() => dispatch({ type: \'NAVIGATE_PREV\' })} className=\\"p-1 hover:bg-white rounded\\"><ChevronLeft size={18}/></button>\\r\\n            <button onClick={() => dispatch({ type: \'NAVIGATE_TODAY\' })} className=\\"px-3 text-xs font-bold hover:bg-white rounded\\">Hoy</button>\\r\\n            <button onClick={() => dispatch({ type: \'NAVIGATE_NEXT\' })} className=\\"p-1 hover:bg-white rounded\\"><ChevronRight size={18}/></button>\\r\\n          </div>\\r\\n          <h2 className=\\"text-lg font-bold text-gray-800 capitalize min-w-[150px] text-center\\">{format(state.currentDate, \'MMMM yyyy\', { locale: es })}</h2>\\r\\n        </div>\\r\\n        \\r\\n        <div className=\\"flex gap-2 items-center\\">\\r\\n            {/*  CONTROLES DE ZOOM */}\\r\\n            {(state.view === \'week\' || state.view === \'day\') && (\\r\\n                <div className=\\"flex items-center bg-gray-50 rounded-lg p-1 border border-gray-200 mr-2\\">\\r\\n                    <button onClick={() => setCellHeight(h => Math.max(30, h - 10))} className=\\"p-1 hover:bg-white rounded text-gray-500\\" title=\\"Alejar\\"><ZoomOut size={14}/></button>\\r\\n                    <span className=\\"text-[10px] font-mono w-8 text-center text-gray-400\\">{Math.round((cellHeight/60)*100)}%</span>\\r\\n                    <button onClick={() => setCellHeight(h => Math.min(150, h + 10))} className=\\"p-1 hover:bg-white rounded text-gray-500\\" title=\\"Acercar\\"><ZoomIn size={14}/></button>\\r\\n                </div>\\r\\n            )}\\r\\n\\r\\n            {readOnly && <span className=\\"text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-md font-bold flex items-center gap-1\\"><Lock size={12}/> Lectura</span>}\\r\\n            {isLoading && <span className=\\"text-xs text-blue-500 animate-pulse self-center\\">Cargando...</span>}\\r\\n            <div className=\\"flex bg-gray-100 rounded-lg p-1\\">\\r\\n                {([\'month\', \'week\', \'day\'] as ViewType[]).map(v => (\\r\\n                    <button key={v} onClick={() => dispatch({ type: \'SET_VIEW\', payload: v })} className={cn(\\"px-3 py-1 text-xs font-medium rounded capitalize\\", state.view === v ? \\"bg-white shadow text-indigo-600\\" : \\"text-gray-500\\")}>\\r\\n                        {v === \'month\' ? \'Mes\' : v === \'week\' ? \'Sem\' : \'D铆a\'}\\r\\n                    </button>\\r\\n                ))}\\r\\n            </div>\\r\\n        </div>\\r\\n      </header>\\r\\n      <div className=\\"flex-1 overflow-hidden relative\\">\\r\\n        {state.view === \'month\' ? renderMonthView() : renderTimeGrid()}\\r\\n      </div>\\r\\n    </div>\\r\\n  );\\r\\n};\\r\\n\\r\\nexport const DragAndDropScheduler = React.memo(Scheduler);\\r\\nexport default DragAndDropScheduler;\\n\\n\\n\\n"},{"id":"brhawzslj","name":"scheduler_old.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\scheduler_old.tsx","area":"FRONTEND","content":"import React, { useReducer, useMemo, useEffect } from \'react\';\\r\\nimport { \\r\\n  format, \\r\\n  addMonths, \\r\\n  subMonths, \\r\\n  startOfMonth, \\r\\n  endOfMonth, \\r\\n  startOfWeek, \\r\\n  endOfWeek, \\r\\n  isSameDay, \\r\\n  addDays, \\r\\n  parseISO, \\r\\n  setHours, \\r\\n  setMinutes,\\r\\n  differenceInMinutes,\\r\\n  addMinutes\\r\\n} from \'date-fns\';\\r\\nimport { es } from \'date-fns/locale\';\\r\\nimport { \\r\\n  ChevronLeft, \\r\\n  ChevronRight, \\r\\n  Clock,\\r\\n  Lock\\r\\n} from \'lucide-react\';\\r\\nimport { clsx, type ClassValue } from \'clsx\';\\r\\nimport { twMerge } from \'tailwind-merge\';\\r\\n\\r\\nfunction cn(...inputs: ClassValue[]) {\\r\\n  return twMerge(clsx(inputs));\\r\\n}\\r\\n\\r\\nexport type ViewType = \'month\' | \'week\' | \'day\';\\r\\n\\r\\nexport interface SchedulerEvent {\\r\\n  id: string;\\r\\n  title: string;\\r\\n  description?: string;\\r\\n  start: Date | string;\\r\\n  end: Date | string;\\r\\n  color?: string;\\r\\n  originalData?: any;\\r\\n}\\r\\n\\r\\ninterface SchedulerState {\\r\\n  currentDate: Date;\\r\\n  view: ViewType;\\r\\n}\\r\\n\\r\\ntype SchedulerAction = \\r\\n  | { type: \'SET_VIEW\'; payload: ViewType }\\r\\n  | { type: \'NAVIGATE_NEXT\' }\\r\\n  | { type: \'NAVIGATE_PREV\' }\\r\\n  | { type: \'NAVIGATE_TODAY\' }\\r\\n  | { type: \'SET_DATE\'; payload: Date };\\r\\n\\r\\ninterface SchedulerProps {\\r\\n  events: SchedulerEvent[];\\r\\n  isLoading?: boolean;\\r\\n  onEventClick?: (event: SchedulerEvent) => void;\\r\\n  onDropInfo?: (data: { employeeId: string, employeeName: string, start?: Date, end?: Date, targetShiftId?: string }) => void;\\r\\n  onEventMove?: (event: SchedulerEvent, newStart: Date, newEnd: Date) => void;\\r\\n  onDateChange?: (date: Date) => void;\\r\\n  onViewChange?: (view: ViewType) => void;\\r\\n  startHour?: number;\\r\\n  endHour?: number;\\r\\n  readOnly?: boolean;\\r\\n}\\r\\n\\r\\nconst CELL_HEIGHT = 60; \\r\\n\\r\\nconst schedulerReducer = (state: SchedulerState, action: SchedulerAction): SchedulerState => {\\r\\n  switch (action.type) {\\r\\n    case \'SET_VIEW\': return { ...state, view: action.payload };\\r\\n    case \'NAVIGATE_NEXT\': {\\r\\n      const { view, currentDate } = state;\\r\\n      let nextDate = view === \'month\' ? addMonths(currentDate, 1) : addDays(currentDate, view === \'week\' ? 7 : 1);\\r\\n      return { ...state, currentDate: nextDate };\\r\\n    }\\r\\n    case \'NAVIGATE_PREV\': {\\r\\n      const { view, currentDate } = state;\\r\\n      let prevDate = view === \'month\' ? subMonths(currentDate, 1) : addDays(currentDate, view === \'week\' ? -7 : -1);\\r\\n      return { ...state, currentDate: prevDate };\\r\\n    }\\r\\n    case \'NAVIGATE_TODAY\': return { ...state, currentDate: new Date() };\\r\\n    case \'SET_DATE\': return { ...state, currentDate: action.payload };\\r\\n    default: return state;\\r\\n  }\\r\\n};\\r\\n\\r\\nconst Scheduler: React.FC<SchedulerProps> = ({ \\r\\n  events = [], \\r\\n  isLoading = false, \\r\\n  onEventClick, \\r\\n  onDropInfo, \\r\\n  onEventMove,\\r\\n  onDateChange,\\r\\n  onViewChange,\\r\\n  startHour = 0, \\r\\n  endHour = 24,\\r\\n  readOnly = false\\r\\n}) => {\\r\\n  \\r\\n  const [state, dispatch] = useReducer(schedulerReducer, { currentDate: new Date(), view: \'week\' });\\r\\n\\r\\n  useEffect(() => { if (onDateChange) onDateChange(state.currentDate); }, [state.currentDate, onDateChange]);\\r\\n  useEffect(() => { if (onViewChange) onViewChange(state.view); }, [state.view, onViewChange]);\\r\\n\\r\\n  const normalizedEvents = useMemo(() => {\\r\\n    return events.map(evt => ({\\r\\n      ...evt,\\r\\n      start: typeof evt.start === \'string\' ? parseISO(evt.start) : evt.start,\\r\\n      end: typeof evt.end === \'string\' ? parseISO(evt.end) : evt.end,\\r\\n    }));\\r\\n  }, [events]);\\r\\n\\r\\n  // --- HANDLERS ---\\r\\n\\r\\n  const handleSlotDrop = (e: React.DragEvent, day: Date, hour: number) => {\\r\\n      e.preventDefault();\\r\\n      if (readOnly) return;\\r\\n\\r\\n      const rect = (e.currentTarget as HTMLElement).getBoundingClientRect();\\r\\n      const offsetY = e.clientY - rect.top;\\r\\n      const minutesAdded = Math.floor((offsetY / CELL_HEIGHT) * 60);\\r\\n      const roundedMinutes = Math.round(minutesAdded / 15) * 15; \\r\\n\\r\\n      const newStart = new Date(day);\\r\\n      newStart.setHours(hour, roundedMinutes, 0, 0);\\r\\n\\r\\n      const movedShiftId = e.dataTransfer.getData(\\"shiftId\\");\\r\\n      if (movedShiftId && onEventMove) {\\r\\n          const shift = normalizedEvents.find(s => s.id === movedShiftId);\\r\\n          if (shift) {\\r\\n              const durationMs = (shift.end as Date).getTime() - (shift.start as Date).getTime();\\r\\n              const newEnd = new Date(newStart.getTime() + durationMs);\\r\\n              onEventMove(shift, newStart, newEnd);\\r\\n          }\\r\\n          return;\\r\\n      }\\r\\n\\r\\n      const employeeId = e.dataTransfer.getData(\\"employeeId\\");\\r\\n      const employeeName = e.dataTransfer.getData(\\"employeeName\\");\\r\\n      if (employeeId && onDropInfo) {\\r\\n          const end = addMinutes(newStart, 480); \\r\\n          onDropInfo({ employeeId, employeeName, start: newStart, end });\\r\\n      }\\r\\n  };\\r\\n\\r\\n  const handleEventDrop = (e: React.DragEvent, targetEvent: SchedulerEvent) => {\\r\\n      e.preventDefault();\\r\\n      e.stopPropagation(); \\r\\n      if (readOnly) return;\\r\\n\\r\\n      const employeeId = e.dataTransfer.getData(\\"employeeId\\");\\r\\n      const employeeName = e.dataTransfer.getData(\\"employeeName\\");\\r\\n\\r\\n      if (employeeId && onDropInfo) {\\r\\n          onDropInfo({ \\r\\n              employeeId, \\r\\n              employeeName, \\r\\n              targetShiftId: targetEvent.id \\r\\n          });\\r\\n      }\\r\\n  };\\r\\n\\r\\n  const renderMonthView = () => {\\r\\n    const monthStart = startOfMonth(state.currentDate);\\r\\n    const monthEnd = endOfMonth(monthStart);\\r\\n    const startDate = startOfWeek(monthStart, { weekStartsOn: 1 });\\r\\n    const endDate = endOfWeek(monthEnd, { weekStartsOn: 1 });\\r\\n    \\r\\n    let days: React.ReactNode[] = []; \\r\\n    let day = startDate;\\r\\n    const rows = [];\\r\\n\\r\\n    while (day <= endDate) {\\r\\n        for (let i = 0; i < 7; i++) {\\r\\n            const cloneDay = day;\\r\\n            const isToday = isSameDay(day, new Date());\\r\\n            const dayEvents = normalizedEvents\\r\\n                .filter(e => isSameDay(e.start as Date, cloneDay))\\r\\n                .sort((a, b) => (a.start as Date).getTime() - (b.start as Date).getTime());\\r\\n            \\r\\n            days.push(\\r\\n                <div \\r\\n                    key={day.toISOString()} \\r\\n                    className={cn(\\r\\n                        \\"min-h-[100px] border-b border-r border-gray-100 p-1 relative transition-colors\\",\\r\\n                        !isSameDay(day, monthStart) && day.getMonth() !== monthStart.getMonth() ? \\"bg-gray-50/30 text-gray-400\\" : \\"\\",\\r\\n                        !readOnly && \\"hover:bg-gray-50\\"\\r\\n                    )}\\r\\n                    onClick={() => dispatch({ type: \'SET_DATE\', payload: cloneDay })}\\r\\n                    onDragOver={!readOnly ? (e) => e.preventDefault() : undefined}\\r\\n                    onDrop={!readOnly ? (e) => {\\r\\n                        const employeeId = e.dataTransfer.getData(\\"employeeId\\");\\r\\n                        const employeeName = e.dataTransfer.getData(\\"employeeName\\");\\r\\n                        if (employeeId && onDropInfo) {\\r\\n                            const start = setHours(cloneDay, 9);\\r\\n                            const end = setHours(cloneDay, 17);\\r\\n                            onDropInfo({ employeeId, employeeName, start, end });\\r\\n                        }\\r\\n                    } : undefined}\\r\\n                >\\r\\n                    <div className=\\"flex justify-between items-center mb-1\\">\\r\\n                       <span className={cn(\\"text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full\\", isToday ? \\"bg-indigo-600 text-white\\" : \\"\\")}>\\r\\n                         {format(day, \'d\')}\\r\\n                       </span>\\r\\n                    </div>\\r\\n                    <div className=\\"flex flex-col gap-1 overflow-hidden max-h-[80px]\\">\\r\\n                        {dayEvents.slice(0, 4).map(evt => (\\r\\n                            <div \\r\\n                                key={evt.id} \\r\\n                                onClick={(e) => { e.stopPropagation(); onEventClick?.(evt); }} \\r\\n                                className={cn(\\"text-[10px] px-1 rounded truncate cursor-pointer flex items-center gap-1\\", evt.color || \\"bg-blue-100 text-blue-800\\")}\\r\\n                                title={evt.title}\\r\\n                                draggable={!readOnly}\\r\\n                                onDragStart={!readOnly ? (e) => {\\r\\n                                    e.dataTransfer.setData(\\"shiftId\\", evt.id);\\r\\n                                    e.dataTransfer.effectAllowed = \\"move\\";\\r\\n                                } : undefined}\\r\\n                                onDragOver={!readOnly ? (e) => e.preventDefault() : undefined}\\r\\n                                onDrop={!readOnly ? (e) => handleEventDrop(e, evt) : undefined}\\r\\n                            >\\r\\n                                {readOnly && <Lock size={8} className=\\"opacity-50\\"/>}\\r\\n                                {format(evt.start as Date, \'HH:mm\')} {evt.title}\\r\\n                            </div>\\r\\n                        ))}\\r\\n                    </div>\\r\\n                </div>\\r\\n            );\\r\\n            day = addDays(day, 1);\\r\\n        }\\r\\n        rows.push(<div className=\\"grid grid-cols-7\\" key={day.toISOString()}>{days}</div>);\\r\\n        days = []; \\r\\n    }\\r\\n    return <div className=\\"border-l border-t border-gray-200\\">{rows}</div>;\\r\\n  };\\r\\n\\r\\n  const renderTimeGrid = () => {\\r\\n    let daysToShow = state.view === \'week\' \\r\\n        ? Array.from({ length: 7 }).map((_, i) => addDays(startOfWeek(state.currentDate, { weekStartsOn: 1 }), i))\\r\\n        : [state.currentDate];\\r\\n\\r\\n    const hours = Array.from({ length: endHour - startHour }).map((_, i) => startHour + i);\\r\\n\\r\\n    return (\\r\\n      <div className=\\"flex flex-col h-full bg-white relative overflow-hidden\\">\\r\\n        <div className=\\"flex border-b border-gray-200 ml-14\\">\\r\\n          {daysToShow.map(day => {\\r\\n            const isToday = isSameDay(day, new Date());\\r\\n            return (\\r\\n              <div key={day.toISOString()} className=\\"flex-1 py-2 text-center border-r border-gray-100\\">\\r\\n                <div className={cn(\\"text-xs uppercase font-bold\\", isToday ? \\"text-indigo-600\\" : \\"text-gray-500\\")}>{format(day, \'EEE\', { locale: es })}</div>\\r\\n                <div className={cn(\\"text-lg font-bold\\", isToday ? \\"text-indigo-600\\" : \\"text-gray-800\\")}>{format(day, \'d\')}</div>\\r\\n              </div>\\r\\n            );\\r\\n          })}\\r\\n        </div>\\r\\n\\r\\n        <div className=\\"flex-1 overflow-y-auto relative flex\\">\\r\\n          <div className=\\"w-14 flex-shrink-0 bg-gray-50 border-r border-gray-200 sticky left-0 z-10 select-none\\">\\r\\n            {hours.map(h => {\\r\\n              const timeLabel = setMinutes(setHours(new Date(), h), 0);\\r\\n              return (\\r\\n                <div key={h} className=\\"border-b border-gray-100 text-[10px] text-gray-400 text-right pr-2 pt-1 relative\\" style={{ height: CELL_HEIGHT }}>\\r\\n                  <span className=\\"-top-2 relative\\">{format(timeLabel, \'HH:mm\')}</span>\\r\\n                </div>\\r\\n              );\\r\\n            })}\\r\\n          </div>\\r\\n\\r\\n          <div className=\\"flex-1 flex relative min-w-[600px]\\">\\r\\n            <div className=\\"absolute inset-0 flex flex-col z-0\\">\\r\\n               {hours.map(h => <div key={h} className=\\"w-full border-b border-gray-100\\" style={{ height: CELL_HEIGHT }}></div>)}\\r\\n            </div>\\r\\n\\r\\n            {daysToShow.map(day => {\\r\\n              const dayEvents = normalizedEvents.filter(e => isSameDay(e.start as Date, day));\\r\\n              return (\\r\\n                <div key={day.toISOString()} className=\\"flex-1 border-r border-gray-100 relative h-full\\">\\r\\n                  \\r\\n                  {!readOnly && (\\r\\n                      <div className=\\"absolute inset-0 z-0 flex flex-col\\">\\r\\n                          {hours.map(h => (\\r\\n                              <div \\r\\n                                key={h} \\r\\n                                style={{ height: CELL_HEIGHT }} \\r\\n                                className=\\"w-full transition-colors hover:bg-indigo-50/20\\"\\r\\n                                onDragOver={(e) => { e.preventDefault(); e.dataTransfer.dropEffect = \\"move\\"; }}\\r\\n                                onDrop={(e) => handleSlotDrop(e, day, h)}\\r\\n                              />\\r\\n                          ))}\\r\\n                      </div>\\r\\n                  )}\\r\\n\\r\\n                  {dayEvents.map(evt => {\\r\\n                    const start = evt.start as Date;\\r\\n                    const end = evt.end as Date;\\r\\n                    \\r\\n                    const startH = start.getHours();\\r\\n                    const startM = start.getMinutes();\\r\\n                    \\r\\n                    if (end.getHours() < startHour) return null; \\r\\n                    \\r\\n                    const minsFromTop = (Math.max(startH, startHour) - startHour) * 60 + startM;\\r\\n                    const top = Math.max(0, (minsFromTop / 60) * CELL_HEIGHT);\\r\\n                    const durationMins = differenceInMinutes(end, start);\\r\\n                    const height = (durationMins / 60) * CELL_HEIGHT;\\r\\n\\r\\n                    return (\\r\\n                      <div\\r\\n                        key={evt.id}\\r\\n                        onClick={(e) => { e.stopPropagation(); onEventClick?.(evt); }}\\r\\n                        draggable={!readOnly}\\r\\n                        onDragStart={!readOnly ? (e) => {\\r\\n                            e.dataTransfer.setData(\\"shiftId\\", evt.id);\\r\\n                            e.dataTransfer.effectAllowed = \\"move\\";\\r\\n                        } : undefined}\\r\\n                        onDragOver={!readOnly ? (e) => { \\r\\n                            e.preventDefault(); \\r\\n                            e.stopPropagation(); \\r\\n                            e.dataTransfer.dropEffect = \\"copy\\"; \\r\\n                        } : undefined} \\r\\n                        onDrop={!readOnly ? (e) => handleEventDrop(e, evt) : undefined} \\r\\n                        \\r\\n                        className={cn(\\r\\n                            \\"absolute left-1 right-1 rounded border-l-4 p-1 shadow-sm cursor-pointer transition-all text-xs overflow-hidden group\\", \\r\\n                            !readOnly && \\"hover:z-50 hover:brightness-95\\", \\r\\n                            readOnly && \\"opacity-90\\", \\r\\n                            evt.color || \\"bg-indigo-50 border-indigo-500\\"\\r\\n                        )}\\r\\n                        style={{ top: `${top}px`, height: `${Math.max(height, 24)}px` }}\\r\\n                        title={`${evt.title}`}\\r\\n                      >\\r\\n                        {readOnly && <Lock size={10} className=\\"absolute top-1 right-1 text-gray-500 opacity-50\\"/>}\\r\\n                        <div className=\\"font-bold truncate group-hover:whitespace-normal\\">{evt.title}</div>\\r\\n                        <div className=\\"opacity-80 truncate text-[10px] flex items-center gap-1\\">\\r\\n                           <Clock size={10}/> {format(start, \'HH:mm\')} - {format(end, \'HH:mm\')}\\r\\n                        </div>\\r\\n                      </div>\\r\\n                    );\\r\\n                  })}\\r\\n                </div>\\r\\n              );\\r\\n            })}\\r\\n          </div>\\r\\n        </div>\\r\\n      </div>\\r\\n    );\\r\\n  };\\r\\n\\r\\n  return (\\r\\n    <div className=\\"flex flex-col h-full bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden\\">\\r\\n      <header className=\\"flex items-center justify-between px-4 py-3 border-b border-gray-100 bg-white\\">\\r\\n        <div className=\\"flex items-center gap-4\\">\\r\\n          <h2 className=\\"text-lg font-bold text-gray-800 capitalize w-40\\">{format(state.currentDate, \'MMMM yyyy\', { locale: es })}</h2>\\r\\n          <div className=\\"flex items-center bg-gray-100 rounded-lg p-1\\">\\r\\n            <button onClick={() => dispatch({ type: \'NAVIGATE_PREV\' })} className=\\"p-1 hover:bg-white rounded\\"><ChevronLeft size={18}/></button>\\r\\n            <button onClick={() => dispatch({ type: \'NAVIGATE_TODAY\' })} className=\\"px-3 text-xs font-bold hover:bg-white rounded\\">Hoy</button>\\r\\n            <button onClick={() => dispatch({ type: \'NAVIGATE_NEXT\' })} className=\\"p-1 hover:bg-white rounded\\"><ChevronRight size={18}/></button>\\r\\n          </div>\\r\\n        </div>\\r\\n        <div className=\\"flex gap-2 items-center\\">\\r\\n            {readOnly && <span className=\\"text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-md font-bold flex items-center gap-1\\"><Lock size={12}/> Modo Lectura</span>}\\r\\n            {isLoading && <span className=\\"text-xs text-blue-500 animate-pulse self-center\\">Cargando...</span>}\\r\\n            <div className=\\"flex bg-gray-100 rounded-lg p-1\\">\\r\\n                {([\'month\', \'week\', \'day\'] as ViewType[]).map(v => (\\r\\n                    <button key={v} onClick={() => dispatch({ type: \'SET_VIEW\', payload: v })} className={cn(\\"px-3 py-1 text-xs font-medium rounded capitalize\\", state.view === v ? \\"bg-white shadow text-indigo-600\\" : \\"text-gray-500\\")}>\\r\\n                        {v === \'month\' ? \'Mes\' : v === \'week\' ? \'Sem\' : \'D铆a\'}\\r\\n                    </button>\\r\\n                ))}\\r\\n            </div>\\r\\n        </div>\\r\\n      </header>\\r\\n      <div className=\\"flex-1 overflow-hidden relative\\">\\r\\n        {state.view === \'month\' ? renderMonthView() : renderTimeGrid()}\\r\\n      </div>\\r\\n    </div>\\r\\n  );\\r\\n};\\r\\n\\r\\nexport const DragAndDropScheduler = React.memo(Scheduler);\\r\\nexport default DragAndDropScheduler;\\n\\n\\n\\n"},{"id":"rq88gmpqq","name":"shift-assignment-form.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\shift-assignment-form.tsx","area":"FRONTEND","content":"import React, { useState } from \'react\';\\r\\nimport { callScheduleShift } from \'@/services/firebase-client.service\';\\r\\nimport { Timestamp } from \'firebase/firestore\'; \\r\\n\\r\\nexport function ShiftAssignmentForm() {\\r\\n  const [employeeId, setEmployeeId] = useState(\'user_id_cajero_001\'); // Placeholder\\r\\n  const [objectiveId, setObjectiveId] = useState(\'obj_id_sucursal_centro\'); // Placeholder\\r\\n  const [startTime, setStartTime] = useState(\'\'); \\r\\n  const [endTime, setEndTime] = useState(\'\');\\r\\n  const [message, setMessage] = useState<{ text: string, type: \'success\' | \'error\' } | null>(null);\\r\\n  const [loading, setLoading] = useState(false);\\r\\n\\r\\n  const handleSubmit = async (e: React.FormEvent) => {\\r\\n    e.preventDefault();\\r\\n    setMessage(null);\\r\\n    setLoading(true);\\r\\n\\r\\n    try {\\r\\n      const shiftData = {\\r\\n        employeeId,\\r\\n        objectiveId,\\r\\n        startTime: Timestamp.fromDate(new Date(startTime)), \\r\\n        endTime: Timestamp.fromDate(new Date(endTime)),\\r\\n      };\\r\\n\\r\\n      const result = await callScheduleShift(shiftData);\\r\\n      const data = result.data as { success: boolean, shiftId: string, message: string };\\r\\n      setMessage({ text: data.message || \\"Turno asignado correctamente\\", type: \'success\' });\\r\\n      \\r\\n    } catch (err: any) {\\r\\n      const errorMessage = err.details || err.message;\\r\\n      setMessage({ text: `Error: ${errorMessage}`, type: \'error\' });\\r\\n    } finally {\\r\\n      setLoading(false);\\r\\n    }\\r\\n  };\\r\\n\\r\\n  const inputClass = \\"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm\\";\\r\\n  const labelClass = \\"block text-sm font-medium text-gray-700\\";\\r\\n\\r\\n  return (\\r\\n    <div className=\\"space-y-6\\">\\r\\n      {message && (\\r\\n        <div className={`p-4 rounded-md ${message.type === \'success\' ? \'bg-green-50 text-green-700\' : \'bg-red-50 text-red-700\'}`}>\\r\\n          {message.text}\\r\\n        </div>\\r\\n      )}\\r\\n      \\r\\n      <form onSubmit={handleSubmit} className=\\"space-y-4\\">\\r\\n        <div className=\\"grid grid-cols-1 md:grid-cols-2 gap-4\\">\\r\\n            <div>\\r\\n                <label className={labelClass}>Inicio del Turno</label>\\r\\n                <input type=\\"datetime-local\\" value={startTime} onChange={(e) => setStartTime(e.target.value)} required className={inputClass} />\\r\\n            </div>\\r\\n            <div>\\r\\n                <label className={labelClass}>Fin del Turno</label>\\r\\n                <input type=\\"datetime-local\\" value={endTime} onChange={(e) => setEndTime(e.target.value)} required className={inputClass} />\\r\\n            </div>\\r\\n        </div>\\r\\n\\r\\n        <div className=\\"grid grid-cols-1 md:grid-cols-2 gap-4\\">\\r\\n            <div>\\r\\n                <label className={labelClass}>Empleado ID</label>\\r\\n                <input type=\\"text\\" value={employeeId} readOnly className={`${inputClass} bg-gray-100 cursor-not-allowed`} />\\r\\n            </div>\\r\\n            <div>\\r\\n                <label className={labelClass}>Objetivo ID</label>\\r\\n                <input type=\\"text\\" value={objectiveId} readOnly className={`${inputClass} bg-gray-100 cursor-not-allowed`} />\\r\\n            </div>\\r\\n        </div>\\r\\n\\r\\n        <button \\r\\n            type=\\"submit\\" \\r\\n            disabled={loading}\\r\\n            className={`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none transition duration-200 ${loading ? \'opacity-70\' : \'\'}`}\\r\\n        >\\r\\n          {loading ? \'Asignando...\' : \'Asignar Turno\'}\\r\\n        </button>\\r\\n      </form>\\r\\n    </div>\\r\\n  );\\r\\n}\\n\\n\\n\\n"},{"id":"2j94hos39","name":"system-user-management.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\system-user-management.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport { callManageSystemUsers } from \'@/services/firebase-client.service\';\\r\\nimport { ISystemUser } from \'@/common/interfaces/system-user.interface\';\\r\\nimport toast from \'react-hot-toast\';\\r\\n\\r\\nexport function SystemUserManagement() {\\r\\n  const [users, setUsers] = useState<ISystemUser[]>([]);\\r\\n  const [loading, setLoading] = useState(true);\\r\\n  const [showModal, setShowModal] = useState(false);\\r\\n  const [isEditing, setIsEditing] = useState(false);\\r\\n\\r\\n  // Formulario\\r\\n  const [formData, setFormData] = useState({\\r\\n    uid: \'\',\\r\\n    displayName: \'\',\\r\\n    email: \'\',\\r\\n    password: \'\',\\r\\n    role: \'Scheduler\',\\r\\n    status: \'Active\'\\r\\n  });\\r\\n\\r\\n  const fetchUsers = async () => {\\r\\n    setLoading(true);\\r\\n    try {\\r\\n      const res = await callManageSystemUsers({ action: \'GET_ALL_USERS\', payload: {} });\\r\\n      const data = (res.data as any).data || [];\\r\\n      setUsers(data);\\r\\n    } catch (error) {\\r\\n      console.error(error);\\r\\n      toast.error(\\"Error al cargar usuarios.\\");\\r\\n    } finally {\\r\\n      setLoading(false);\\r\\n    }\\r\\n  };\\r\\n\\r\\n  useEffect(() => {\\r\\n    fetchUsers();\\r\\n  }, []);\\r\\n\\r\\n  const handleOpenCreate = () => {\\r\\n    setFormData({ uid: \'\', displayName: \'\', email: \'\', password: \'\', role: \'Scheduler\', status: \'Active\' });\\r\\n    setIsEditing(false);\\r\\n    setShowModal(true);\\r\\n  };\\r\\n\\r\\n  const handleSave = async (e: React.FormEvent) => {\\r\\n    e.preventDefault();\\r\\n    const toastId = toast.loading(\\"Procesando...\\");\\r\\n\\r\\n    try {\\r\\n      if (isEditing) {\\r\\n        // Solo enviamos lo que cambia\\r\\n        const payload = {\\r\\n            uid: formData.uid,\\r\\n            data: {\\r\\n                role: formData.role,\\r\\n                status: formData.status,\\r\\n                displayName: formData.displayName\\r\\n            }\\r\\n        };\\r\\n        await callManageSystemUsers({ action: \'UPDATE_USER\', payload });\\r\\n        toast.success(\\"Usuario actualizado\\", { id: toastId });\\r\\n      } else {\\r\\n        await callManageSystemUsers({ \\r\\n            action: \'CREATE_USER\', \\r\\n            payload: {\\r\\n                email: formData.email,\\r\\n                password: formData.password,\\r\\n                displayName: formData.displayName,\\r\\n                role: formData.role\\r\\n            }\\r\\n        });\\r\\n        toast.success(\\"Administrador creado\\", { id: toastId });\\r\\n      }\\r\\n      setShowModal(false);\\r\\n      fetchUsers();\\r\\n    } catch (error: any) {\\r\\n      toast.error(`Error: ${error.message}`, { id: toastId });\\r\\n    }\\r\\n  };\\r\\n\\r\\n  const handleDelete = async (uid: string) => {\\r\\n    if (!confirm(\\"驴Eliminar este administrador? Perder谩 el acceso inmediatamente.\\")) return;\\r\\n    try {\\r\\n        await callManageSystemUsers({ action: \'DELETE_USER\', payload: { uid } });\\r\\n        toast.success(\\"Usuario eliminado\\");\\r\\n        fetchUsers();\\r\\n    } catch (error) {\\r\\n        toast.error(\\"Error al eliminar\\");\\r\\n    }\\r\\n  };\\r\\n\\r\\n  // Estilos\\r\\n  const inputClass = \\"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm\\";\\r\\n  const labelClass = \\"block text-sm font-medium text-gray-700\\";\\r\\n\\r\\n  return (\\r\\n    <div className=\\"space-y-6\\">\\r\\n      <div className=\\"flex justify-between items-center\\">\\r\\n        <div>\\r\\n            <h2 className=\\"text-xl font-bold text-gray-800\\">Usuarios del Sistema</h2>\\r\\n            <p className=\\"text-sm text-gray-500\\">Gestione el acceso al panel administrativo.</p>\\r\\n        </div>\\r\\n        <button onClick={handleOpenCreate} className=\\"bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 transition shadow-sm flex items-center\\">\\r\\n            <span className=\\"mr-2\\">+</span> Nuevo Admin\\r\\n        </button>\\r\\n      </div>\\r\\n\\r\\n      {/* Tabla */}\\r\\n      <div className=\\"bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden\\">\\r\\n        <table className=\\"min-w-full divide-y divide-gray-200\\">\\r\\n            <thead className=\\"bg-gray-50\\">\\r\\n                <tr>\\r\\n                    <th className=\\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase\\">Usuario</th>\\r\\n                    <th className=\\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase\\">Rol</th>\\r\\n                    <th className=\\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase\\">Estado</th>\\r\\n                    <th className=\\"px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase\\">Acciones</th>\\r\\n                </tr>\\r\\n            </thead>\\r\\n            <tbody className=\\"bg-white divide-y divide-gray-200\\">\\r\\n                {users.map((user) => (\\r\\n                    <tr key={user.uid} className=\\"hover:bg-gray-50\\">\\r\\n                        <td className=\\"px-6 py-4 whitespace-nowrap\\">\\r\\n                            <div className=\\"flex items-center\\">\\r\\n                                <div className=\\"h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-xs\\">\\r\\n                                    {user.displayName.charAt(0)}\\r\\n                                </div>\\r\\n                                <div className=\\"ml-3\\">\\r\\n                                    <div className=\\"text-sm font-medium text-gray-900\\">{user.displayName}</div>\\r\\n                                    <div className=\\"text-xs text-gray-500\\">{user.email}</div>\\r\\n                                </div>\\r\\n                            </div>\\r\\n                        </td>\\r\\n                        <td className=\\"px-6 py-4 whitespace-nowrap\\">\\r\\n                            <span className=\\"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800\\">\\r\\n                                {user.role}\\r\\n                            </span>\\r\\n                        </td>\\r\\n                        <td className=\\"px-6 py-4 whitespace-nowrap\\">\\r\\n                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === \'Active\' ? \'bg-green-100 text-green-800\' : \'bg-red-100 text-red-800\'}`}>\\r\\n                                {user.status}\\r\\n                            </span>\\r\\n                        </td>\\r\\n                        <td className=\\"px-6 py-4 whitespace-nowrap text-right text-sm font-medium\\">\\r\\n                            <button onClick={() => handleDelete(user.uid)} className=\\"text-red-600 hover:text-red-900\\">Eliminar</button>\\r\\n                        </td>\\r\\n                    </tr>\\r\\n                ))}\\r\\n            </tbody>\\r\\n        </table>\\r\\n      </div>\\r\\n\\r\\n      {/* Modal */}\\r\\n      {showModal && (\\r\\n        <div className=\\"fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50 flex items-center justify-center p-4\\">\\r\\n            <div className=\\"bg-white rounded-xl shadow-xl max-w-md w-full p-6\\">\\r\\n                <h3 className=\\"text-lg font-bold text-gray-900 mb-4\\">{isEditing ? \'Editar Usuario\' : \'Nuevo Administrador\'}</h3>\\r\\n                <form onSubmit={handleSave} className=\\"space-y-4\\">\\r\\n                    <div><label className={labelClass}>Nombre</label><input className={inputClass} value={formData.displayName} onChange={e => setFormData({...formData, displayName: e.target.value})} required /></div>\\r\\n                    {!isEditing && (\\r\\n                        <>\\r\\n                            <div><label className={labelClass}>Email</label><input type=\\"email\\" className={inputClass} value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required /></div>\\r\\n                            <div><label className={labelClass}>Contrase帽a</label><input type=\\"password\\" className={inputClass} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} required /></div>\\r\\n                        </>\\r\\n                    )}\\r\\n                    <div>\\r\\n                        <label className={labelClass}>Rol de Sistema</label>\\r\\n                        <select className={inputClass} value={formData.role} onChange={e => setFormData({...formData, role: e.target.value as any})}>\\r\\n                            <option value=\\"SuperAdmin\\">Super Admin (Total)</option>\\r\\n                            <option value=\\"Scheduler\\">Planificador (Turnos)</option>\\r\\n                            <option value=\\"HR_Manager\\">RRHH (Empleados)</option>\\r\\n                            <option value=\\"Viewer\\">Solo Lectura</option>\\r\\n                        </select>\\r\\n                    </div>\\r\\n                    <div className=\\"flex justify-end space-x-3 mt-6\\">\\r\\n                        <button type=\\"button\\" onClick={() => setShowModal(false)} className=\\"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg\\">Cancelar</button>\\r\\n                        <button type=\\"submit\\" className=\\"px-4 py-2 text-white bg-gray-900 rounded-lg hover:bg-black\\">Guardar</button>\\r\\n                    </div>\\r\\n                </form>\\r\\n            </div>\\r\\n        </div>\\r\\n      )}\\r\\n    </div>\\r\\n  );\\r\\n}\\n\\n\\n\\n"},{"id":"ycktywwxe","name":"SystemStatus.tsx","path":"apps\\\\web\\\\src\\\\components\\\\admin\\\\SystemStatus.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport { callManageHierarchy, callManageEmployees, callCheckSystemHealth, auth } from \'@/services/firebase-client.service\';\\r\\n\\r\\ninterface HealthMetric {\\r\\n    name: string;\\r\\n    status: \'pending\' | \'ok\' | \'warning\' | \'error\';\\r\\n    value?: string;\\r\\n    details?: string;\\r\\n}\\r\\n\\r\\nexport function SystemStatus() {\\r\\n    const [metrics, setMetrics] = useState<HealthMetric[]>([\\r\\n        { name: \'Conectividad Internet\', status: \'pending\' },\\r\\n        { name: \'Sesi贸n de Usuario (Auth)\', status: \'pending\' },\\r\\n        { name: \'Servidor (Cloud Functions)\', status: \'pending\' },\\r\\n        { name: \'Base de Datos (Firestore)\', status: \'pending\' },\\r\\n        { name: \'M贸dulo Jerarqu铆a\', status: \'pending\' },\\r\\n        { name: \'M贸dulo RRHH\', status: \'pending\' },\\r\\n    ]);\\r\\n    const [isRunning, setIsRunning] = useState(false);\\r\\n\\r\\n    useEffect(() => { runDiagnostics(); }, []);\\r\\n\\r\\n    const updateMetric = (index: number, status: HealthMetric[\'status\'], value: string, details: string = \'\') => {\\r\\n        setMetrics(prev => {\\r\\n            const newM = [...prev];\\r\\n            newM[index] = { ...newM[index], status, value, details };\\r\\n            return newM;\\r\\n        });\\r\\n    };\\r\\n\\r\\n    const runDiagnostics = async () => {\\r\\n        setIsRunning(true);\\r\\n        \\r\\n        // 1. Local Checks\\r\\n        const isOnline = navigator.onLine;\\r\\n        updateMetric(0, isOnline ? \'ok\' : \'error\', isOnline ? \'Online\' : \'Offline\');\\r\\n        if (!isOnline) { setIsRunning(false); return; }\\r\\n\\r\\n        const user = auth.currentUser;\\r\\n        updateMetric(1, user ? \'ok\' : \'error\', user ? \'Autenticado\' : \'Sin Sesi贸n\', user?.uid);\\r\\n\\r\\n        // 2. Health Check Real (Ping al servidor)\\r\\n        const startServer = Date.now();\\r\\n        try {\\r\\n            const healthRes = await callCheckSystemHealth({});\\r\\n            const endServer = Date.now();\\r\\n            const data = healthRes.data as any;\\r\\n\\r\\n            updateMetric(2, \'ok\', `${endServer - startServer}ms`, `Node ${data.nodeVersion}`);\\r\\n            \\r\\n            const dbLat = data.database.latencyMs;\\r\\n            updateMetric(3, data.database.status === \'connected\' ? \'ok\' : \'error\', `${dbLat}ms`);\\r\\n\\r\\n        } catch (error: any) {\\r\\n            updateMetric(2, \'error\', \'Fallo Cr铆tico\', error.message);\\r\\n            updateMetric(3, \'error\', \'Inaccesible\', \'Timeout o Error 500\');\\r\\n        }\\r\\n\\r\\n        // 3. Smoke Test de M贸dulos\\r\\n        await testModule(4, async () => callManageHierarchy({ action: \'GET_ALL_CLIENTS\', payload: {} }));\\r\\n        await testModule(5, async () => callManageEmployees({ action: \'GET_ALL_EMPLOYEES\', payload: {} }));\\r\\n\\r\\n        setIsRunning(false);\\r\\n    };\\r\\n\\r\\n    const testModule = async (index: number, call: () => Promise<any>) => {\\r\\n        const start = Date.now();\\r\\n        try {\\r\\n            await call();\\r\\n            updateMetric(index, \'ok\', `${Date.now() - start}ms`, \'Operativo\');\\r\\n        } catch (error: any) {\\r\\n            updateMetric(index, \'error\', \'Fallo\', error.message);\\r\\n        }\\r\\n    };\\r\\n\\r\\n    return (\\r\\n        <div className=\\"bg-white p-6 rounded-xl shadow-sm border border-slate-200\\">\\r\\n            <div className=\\"flex justify-between items-center mb-6\\">\\r\\n                <h3 className=\\"font-bold text-slate-800 text-lg\\">Monitor de Salud</h3>\\r\\n                <button onClick={runDiagnostics} disabled={isRunning} className=\\"px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-bold hover:bg-indigo-100 disabled:opacity-50\\">\\r\\n                    {isRunning ? \'Escaneando...\' : \'Re-escanear\'}\\r\\n                </button>\\r\\n            </div>\\r\\n            <div className=\\"grid grid-cols-1 md:grid-cols-2 gap-4\\">\\r\\n                {metrics.map((m, idx) => (\\r\\n                    <div key={idx} className={`p-4 rounded-lg border flex items-center justify-between ${m.status === \'ok\' ? \'bg-green-50 border-green-100\' : m.status === \'error\' ? \'bg-red-50 border-red-100\' : \'bg-gray-50\'}`}>\\r\\n                        <div>\\r\\n                            <p className=\\"text-xs font-bold text-gray-500 uppercase mb-1\\">{m.name}</p>\\r\\n                            <div className=\\"flex items-center gap-2\\">\\r\\n                                <div className={`w-2.5 h-2.5 rounded-full ${m.status === \'ok\' ? \'bg-green-500\' : m.status === \'error\' ? \'bg-red-500\' : \'bg-yellow-400 animate-pulse\'}`} />\\r\\n                                <span className=\\"font-bold text-slate-700\\">{m.status === \'pending\' ? \'...\' : m.value}</span>\\r\\n                            </div>\\r\\n                        </div>\\r\\n                        {m.details && <div className=\\"text-xs text-gray-500 text-right max-w-[120px] truncate\\" title={m.details}>{m.details}</div>}\\r\\n                    </div>\\r\\n                ))}\\r\\n            </div>\\r\\n        </div>\\r\\n    );\\r\\n}\\n\\n\\n\\n"},{"id":"2bze5is1w","name":"Button.tsx","path":"apps\\\\web\\\\src\\\\components\\\\common\\\\Button.tsx","area":"FRONTEND","content":"import React from \'react\';\\r\\n\\r\\ninterface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {\\r\\n    primary?: boolean;\\r\\n    children: React.ReactNode;\\r\\n}\\r\\n\\r\\n/**\\r\\n * @description Reusable button component with basic Tailwind styles.\\r\\n */\\r\\nexport default function Button({ primary = true, children, className, disabled, ...props }: ButtonProps) {\\r\\n    const baseStyle = \\"px-4 py-2 rounded-lg font-semibold transition-colors duration-150\\";\\r\\n    const primaryStyle = \\"bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-indigo-300\\";\\r\\n    const secondaryStyle = \\"bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:bg-gray-100\\";\\r\\n\\r\\n    return (\\r\\n        <button\\r\\n            className={`${baseStyle} ${primary ? primaryStyle : secondaryStyle} ${className || \'\'}`}\\r\\n            disabled={disabled}\\r\\n            {...props}\\r\\n        >\\r\\n            {children}\\r\\n        </button>\\r\\n    );\\r\\n}\\n\\n\\n\\n"},{"id":"12sivqjtx","name":"InputField.tsx","path":"apps\\\\web\\\\src\\\\components\\\\common\\\\InputField.tsx","area":"FRONTEND","content":"import React from \'react\';\\r\\n\\r\\ninterface InputFieldProps extends React.InputHTMLAttributes<HTMLInputElement | HTMLTextAreaElement> {\\r\\n    label: string;\\r\\n    id: string;\\r\\n    type?: \'text\' | \'email\' | \'password\' | \'number\' | \'date\' | \'textarea\';\\r\\n    rows?: number;\\r\\n}\\r\\n\\r\\n/**\\r\\n * @description Reusable input/textarea component.\\r\\n */\\r\\nexport default function InputField({ label, id, type = \'text\', rows = 1, className, ...props }: InputFieldProps) {\\r\\n    const inputStyle = \\"w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 text-sm\\";\\r\\n\\r\\n    return (\\r\\n        <div className={`space-y-1 ${className}`}>\\r\\n            <label htmlFor={id} className=\\"block text-sm font-medium text-gray-700\\">\\r\\n                {label}\\r\\n            </label>\\r\\n            {type === \'textarea\' ? (\\r\\n                <textarea\\r\\n                    id={id}\\r\\n                    className={inputStyle}\\r\\n                    rows={rows}\\r\\n                    {...props as React.TextareaHTMLAttributes<HTMLTextAreaElement>}\\r\\n                />\\r\\n            ) : (\\r\\n                <input\\r\\n                    id={id}\\r\\n                    type={type}\\r\\n                    className={inputStyle}\\r\\n                    {...props as React.InputHTMLAttributes<HTMLInputElement>}\\r\\n                />\\r\\n            )}\\r\\n        </div>\\r\\n    );\\r\\n}\\n\\n\\n\\n"},{"id":"xnnnpha6f","name":"SelectField.tsx","path":"apps\\\\web\\\\src\\\\components\\\\common\\\\SelectField.tsx","area":"FRONTEND","content":"import React from \'react\';\\r\\n\\r\\ninterface SelectFieldProps extends React.SelectHTMLAttributes<HTMLSelectElement> {\\r\\n    label: string;\\r\\n    id: string;\\r\\n    children: React.ReactNode;\\r\\n}\\r\\n\\r\\n/**\\r\\n * @description Reusable select (dropdown) component.\\r\\n */\\r\\nexport default function SelectField({ label, id, children, className, ...props }: SelectFieldProps) {\\r\\n    const selectStyle = \\"w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 text-sm\\";\\r\\n    \\r\\n    return (\\r\\n        <div className={`space-y-1 ${className}`}>\\r\\n            <label htmlFor={id} className=\\"block text-sm font-medium text-gray-700\\">\\r\\n                {label}\\r\\n            </label>\\r\\n            <select\\r\\n                id={id}\\r\\n                className={selectStyle}\\r\\n                {...props}\\r\\n            >\\r\\n                {children}\\r\\n            </select>\\r\\n        </div>\\r\\n    );\\r\\n}\\n\\n\\n\\n"},{"id":"vi45z547s","name":"shift.interface.ts","path":"apps\\\\web\\\\src\\\\components\\\\common\\\\shift.interface.ts","area":"FRONTEND","content":"/**\\r\\n * @file shift.interface.ts\\r\\n * @description Definici贸n de la estructura de un Turno (Shift) compartido entre Frontend y Backend.\\r\\n */\\r\\n\\r\\n// Definimos un tipo flexible para las fechas para soportar:\\r\\n// 1. admin.firestore.Timestamp (Backend)\\r\\n// 2. firebase.firestore.Timestamp (Frontend SDK)\\r\\n// 3. Date (Objetos JS nativos tras conversi贸n)\\r\\n// 4. { seconds: number, nanoseconds: number } (JSON serializado)\\r\\nexport type FirestoreDate = any; \\r\\n\\r\\nexport type ShiftStatus = \'Scheduled\' | \'In Progress\' | \'Completed\' | \'Absent\';\\r\\n\\r\\nexport interface IShift {\\r\\n    id: string; // ID del documento en Firestore\\r\\n    \\r\\n    // Relaci贸n con Empleado\\r\\n    employeeId: string;\\r\\n    employeeName: string;\\r\\n    \\r\\n    // Relaci贸n con Objetivo (Cliente/Sede)\\r\\n    objectiveId: string;\\r\\n    objectiveName: string; //  Requerido para mostrar en el Dashboard\\r\\n    \\r\\n    // Tiempos\\r\\n    startTime: FirestoreDate;\\r\\n    endTime: FirestoreDate;\\r\\n    \\r\\n    // Estado del ciclo de vida\\r\\n    status: ShiftStatus;\\r\\n    \\r\\n    // Datos opcionales de auditor铆a en el mismo documento (si aplica)\\r\\n    checkInTime?: FirestoreDate;\\r\\n    checkOutTime?: FirestoreDate;\\r\\n    \\r\\n    // Metadatos\\r\\n    role?: string; // Rol del empleado durante ese turno (ej: \'Vigilador\', \'Supervisor\')\\r\\n}\\n\\n\\n\\n"},{"id":"kphcewcgh","name":"Skeleton.tsx","path":"apps\\\\web\\\\src\\\\components\\\\common\\\\Skeleton.tsx","area":"FRONTEND","content":"import React from \'react\';\\r\\n\\r\\ninterface SkeletonProps {\\r\\n  className?: string;\\r\\n}\\r\\n\\r\\nexport const Skeleton: React.FC<SkeletonProps> = ({ className }) => {\\r\\n  return (\\r\\n    <div className={`animate-pulse bg-slate-200 rounded ${className}`} />\\r\\n  );\\r\\n};\\r\\n\\r\\nexport default Skeleton;\\n\\n"},{"id":"f5r05o9xb","name":"withAuthGuard.tsx","path":"apps\\\\web\\\\src\\\\components\\\\common\\\\withAuthGuard.tsx","area":"FRONTEND","content":"import React, { useEffect, useState } from \'react\';\\r\\nimport { useRouter } from \'next/router\';\\r\\nimport { User, onAuthStateChanged } from \'firebase/auth\';\\r\\nimport { auth } from \'../../services/firebase-client.service\'; \\r\\n\\r\\n// Roles administrativos globales (para referencia)\\r\\nconst ADMIN_ROLES = [\'admin\', \'SuperAdmin\', \'Scheduler\', \'HR_Manager\'];\\r\\n\\r\\n/**\\r\\n * Higher-Order Component para proteger rutas.\\r\\n * @param WrappedComponent El componente de p谩gina a proteger.\\r\\n * @param requiredRoles Un solo rol (string) o un array de roles permitidos (string[]).\\r\\n */\\r\\nexport const withAuthGuard = (\\r\\n    WrappedComponent: React.ComponentType<any>, \\r\\n    requiredRoles: string | string[] = [\'admin\'] //  FIX: Acepta string o array\\r\\n) => {\\r\\n  \\r\\n  // Normalizamos a array para facilitar la l贸gica\\r\\n  const rolesArray = Array.isArray(requiredRoles) ? requiredRoles : [requiredRoles];\\r\\n\\r\\n  console.log(`[DEBUG GUARD] Roles Requeridos:`, rolesArray);\\r\\n\\r\\n  const ComponentWithAuthGuard = (props: any) => {\\r\\n    const router = useRouter();\\r\\n    const [loading, setLoading] = useState(true);\\r\\n    const [currentUser, setCurrentUser] = useState<User | null>(null);\\r\\n\\r\\n    useEffect(() => {\\r\\n      const unsubscribe = onAuthStateChanged(auth, async (user) => {\\r\\n        if (!user) {\\r\\n          router.replace(\'/\'); \\r\\n          return;\\r\\n        }\\r\\n\\r\\n        setCurrentUser(user);\\r\\n        \\r\\n        try {\\r\\n          // Forzamos refresh del token para tener los claims actualizados\\r\\n          const tokenResult = await user.getIdTokenResult(true);\\r\\n          const userRole = tokenResult.claims.role as string;\\r\\n          \\r\\n          console.log(`[DEBUG GUARD] Usuario: ${user.email} | Rol: ${userRole}`);\\r\\n\\r\\n          //  LGICA DE AUTORIZACIN CORREGIDA\\r\\n          // Verificamos si el rol del usuario est谩 incluido en los roles permitidos\\r\\n          const isAuthorized = rolesArray.includes(userRole);\\r\\n\\r\\n          if (isAuthorized) {\\r\\n            setLoading(false);\\r\\n          } else {\\r\\n            console.warn(` [GUARD] Acceso Denegado. Rol \'${userRole}\' no autorizado.`);\\r\\n            router.replace(\'/\'); \\r\\n          }\\r\\n        } catch (error) {\\r\\n          console.error(\\" [GUARD] Error validando rol:\\", error);\\r\\n          router.replace(\'/\');\\r\\n        }\\r\\n      });\\r\\n\\r\\n      return () => unsubscribe();\\r\\n    }, [router]);\\r\\n\\r\\n    if (loading) {\\r\\n      return (\\r\\n        <div className=\\"min-h-screen flex flex-col items-center justify-center bg-gray-50\\">\\r\\n            <div className=\\"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4\\"></div>\\r\\n            <p className=\\"text-gray-500 font-medium animate-pulse\\">Verificando permisos...</p>\\r\\n        </div>\\r\\n      );\\r\\n    }\\r\\n\\r\\n    return <WrappedComponent {...props} currentUser={currentUser} />;\\r\\n  };\\r\\n\\r\\n  return ComponentWithAuthGuard;\\r\\n};\\n\\n\\n\\n"},{"id":"0rnm0uusc","name":"employee-dashboard.tsx","path":"apps\\\\web\\\\src\\\\components\\\\employee\\\\employee-dashboard.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport { User } from \'firebase/auth\';\\r\\nimport { getEmployeeShifts, callAuditShift, createAbsence } from \'@/services/firebase-client.service\';\\r\\nimport { IShift } from \'@/common/interfaces/shift.interface\';\\r\\nimport toast from \'react-hot-toast\';\\r\\nimport { getCurrentPosition } from \'@/utils/geolocation\'; \\r\\n\\r\\ninterface EmployeeDashboardProps {\\r\\n  currentUser: User; \\r\\n}\\r\\n\\r\\ntype ViewMode = \'day\' | \'week\' | \'month\';\\r\\n\\r\\nexport function EmployeeDashboard({ currentUser }: EmployeeDashboardProps) {\\r\\n  const [shifts, setShifts] = useState<IShift[]>([]);\\r\\n  const [loading, setLoading] = useState(true);\\r\\n  const [viewMode, setViewMode] = useState<ViewMode>(\'week\');\\r\\n  const [auditingId, setAuditingId] = useState<string | null>(null);\\r\\n  const [isAuditing, setIsAuditing] = useState(false);\\r\\n\\r\\n  // Estados Modal Ausencia\\r\\n  const [absenceModalOpen, setAbsenceModalOpen] = useState(false);\\r\\n  const [selectedShiftForAbsence, setSelectedShiftForAbsence] = useState<IShift | null>(null);\\r\\n  const [absenceReason, setAbsenceReason] = useState(\'\');\\r\\n\\r\\n  // --- 锔 HELPER DE FECHAS (El coraz贸n del arreglo) ---\\r\\n  // Convierte Timestamp, {seconds...}, String o Date a un objeto Date v谩lido de JS\\r\\n  const getDateObj = (timestamp: any): Date => {\\r\\n      if (!timestamp) return new Date();\\r\\n      // Caso 1: Firestore Timestamp (tiene .toDate())\\r\\n      if (typeof timestamp.toDate === \'function\') return timestamp.toDate();\\r\\n      // Caso 2: Objeto Date nativo\\r\\n      if (timestamp instanceof Date) return timestamp;\\r\\n      // Caso 3: Objeto serializado { seconds, nanoseconds }\\r\\n      if (timestamp.seconds !== undefined) return new Date(timestamp.seconds * 1000);\\r\\n      // Caso 4: String ISO\\r\\n      if (typeof timestamp === \'string\') return new Date(timestamp);\\r\\n      \\r\\n      return new Date(); // Fallback\\r\\n  };\\r\\n\\r\\n  // --- Carga de Datos ---\\r\\n  const loadShifts = async () => {\\r\\n    setLoading(true);\\r\\n    try {\\r\\n      const data = await getEmployeeShifts(currentUser.uid);\\r\\n      // Ordenamos cronol贸gicamente\\r\\n      const sorted = data.sort((a, b) => {\\r\\n         return getDateObj(a.startTime).getTime() - getDateObj(b.startTime).getTime();\\r\\n      });\\r\\n      setShifts(sorted);\\r\\n    } catch (err: any) {\\r\\n      console.error(err);\\r\\n      toast.error(\\"Error al cargar agenda.\\");\\r\\n    } finally {\\r\\n      setLoading(false);\\r\\n    }\\r\\n  };\\r\\n\\r\\n  useEffect(() => { if (currentUser) loadShifts(); }, [currentUser]);\\r\\n\\r\\n  // --- Filtros de Tiempo ---\\r\\n  const getFilteredShifts = () => {\\r\\n      const today = new Date();\\r\\n      return shifts.filter(shift => {\\r\\n          const date = getDateObj(shift.startTime);\\r\\n          \\r\\n          if (viewMode === \'day\') {\\r\\n              return date.getDate() === today.getDate() && \\r\\n                     date.getMonth() === today.getMonth() &&\\r\\n                     date.getFullYear() === today.getFullYear();\\r\\n          }\\r\\n          if (viewMode === \'week\') {\\r\\n              // L贸gica simple: Desde hoy hasta 7 d铆as adelante\\r\\n              const nextWeek = new Date();\\r\\n              nextWeek.setDate(today.getDate() + 7);\\r\\n              // Reseteamos horas para comparar d铆as completos\\r\\n              const d = new Date(date); d.setHours(0,0,0,0);\\r\\n              const t = new Date(today); t.setHours(0,0,0,0);\\r\\n              return d >= t && d <= nextWeek;\\r\\n          }\\r\\n          if (viewMode === \'month\') {\\r\\n              return date.getMonth() === today.getMonth() && \\r\\n                     date.getFullYear() === today.getFullYear();\\r\\n          }\\r\\n          return true;\\r\\n      });\\r\\n  };\\r\\n\\r\\n  // --- Formateadores Visuales ---\\r\\n  const formatTime = (ts: any) => getDateObj(ts).toLocaleTimeString(\'es-AR\', {hour: \'2-digit\', minute:\'2-digit\'});\\r\\n  const formatDate = (ts: any) => getDateObj(ts).toLocaleDateString(\'es-AR\', { weekday: \'long\', day: \'numeric\', month: \'long\' });\\r\\n\\r\\n  // --- Fichaje (Check-In/Out) ---\\r\\n  const handleAuditAction = async (shiftId: string, action: \'CHECK_IN\' | \'CHECK_OUT\') => {\\r\\n    if (isAuditing || auditingId) return;\\r\\n    \\r\\n    setAuditingId(shiftId); \\r\\n    setIsAuditing(true);\\r\\n    const toastId = toast.loading(action === \'CHECK_IN\' ? \\"Validando ubicaci贸n...\\" : \\"Cerrando servicio...\\");\\r\\n\\r\\n    try {\\r\\n        const coords = await getCurrentPosition();\\r\\n        await callAuditShift({ \\r\\n            shiftId, \\r\\n            action, \\r\\n            coords: { latitude: coords.latitude, longitude: coords.longitude } \\r\\n        });\\r\\n        \\r\\n        const msg = action === \'CHECK_IN\' ? \\" 隆Presente registrado!\\" : \\" 隆Servicio finalizado!\\";\\r\\n        toast.success(msg, { id: toastId });\\r\\n        await loadShifts(); \\r\\n    } catch (error: any) {\\r\\n        let msg = \\"Error al procesar.\\";\\r\\n        // Mensajes priorizados\\r\\n        if (error.message?.includes(\'temprano\')) msg = \\" Es muy temprano (10 min antes).\\";\\r\\n        else if (error.message?.includes(\'cerca\') || error.code === \'functions/failed-precondition\') msg = \\" Est谩s demasiado lejos.\\";\\r\\n        else if (error.message?.includes(\'Permiso\')) msg = \\"锔 Activa el GPS.\\";\\r\\n        \\r\\n        toast.error(msg, { id: toastId, duration: 5000 });\\r\\n    } finally {\\r\\n        setAuditingId(null); \\r\\n        setIsAuditing(false);\\r\\n    }\\r\\n  };\\r\\n\\r\\n  // --- Reporte Ausencia ---\\r\\n  const handleReportAbsence = async () => {\\r\\n      if (!selectedShiftForAbsence || !absenceReason.trim()) {\\r\\n          toast.error(\\"Por favor indique el motivo.\\"); return;\\r\\n      }\\r\\n      \\r\\n      const toastId = toast.loading(\\"Registrando ausencia...\\");\\r\\n      try {\\r\\n          //  FIX: Convertimos a Date nativo JS antes de enviar al servicio\\r\\n          // Esto evita el error \\"seconds is not valid\\"\\r\\n          const start = getDateObj(selectedShiftForAbsence.startTime);\\r\\n          const end = getDateObj(selectedShiftForAbsence.endTime);\\r\\n\\r\\n          await createAbsence({\\r\\n              action: \'CREATE_ABSENCE\',\\r\\n              payload: {\\r\\n                  employeeId: currentUser.uid,\\r\\n                  employeeName: currentUser.displayName || \'Empleado\',\\r\\n                  clientId: selectedShiftForAbsence.objectiveId || \'unknown\', \\r\\n                  type: \'SICK_LEAVE\', // Podr铆amos agregar un selector de tipo en el modal\\r\\n                  startDate: start, \\r\\n                  endDate: end,\\r\\n                  reason: `[App] ${absenceReason}`\\r\\n              }\\r\\n          });\\r\\n          toast.success(\\"Ausencia reportada correctamente.\\", { id: toastId });\\r\\n          setAbsenceModalOpen(false);\\r\\n          setAbsenceReason(\'\');\\r\\n          // Opcional: Recargar para reflejar cambios si el backend marca el turno\\r\\n          await loadShifts();\\r\\n      } catch (error: any) {\\r\\n          console.error(error);\\r\\n          toast.error(\\"Error: \\" + (error.message || \\"Fallo desconocido\\"), { id: toastId });\\r\\n      }\\r\\n  };\\r\\n\\r\\n  // --- Render ---\\r\\n  if (loading) return <div className=\\"p-10 text-center animate-pulse text-gray-500\\">Cargando agenda...</div>;\\r\\n\\r\\n  const filteredList = getFilteredShifts();\\r\\n  // Buscamos el pr贸ximo turno relevante para el Header Azul\\r\\n  const nextShift = shifts.find(s => s.status === \'Assigned\' || s.status === \'InProgress\');\\r\\n\\r\\n  return (\\r\\n    <div className=\\"max-w-2xl mx-auto pb-24 px-4 font-sans\\">\\r\\n      \\r\\n      {/* 1. HEADER AZUL (RESTAURADO) */}\\r\\n      <div className=\\"bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl p-6 text-white shadow-lg mb-6 mt-4 relative overflow-hidden transition-all hover:shadow-xl\\">\\r\\n          <div className=\\"relative z-10\\">\\r\\n              <h2 className=\\"text-2xl font-bold mb-1\\">\\r\\n                  Hola, {currentUser.displayName?.split(\' \')[0] || \'Colaborador\'}\\r\\n              </h2>\\r\\n              <p className=\\"text-indigo-100 text-sm mb-6\\">Panel de Operaciones</p>\\r\\n              \\r\\n              <div className=\\"flex gap-4\\">\\r\\n                  <div className=\\"bg-white/10 backdrop-blur-sm rounded-lg p-3 flex-1 border border-white/10\\">\\r\\n                      <p className=\\"text-xs text-indigo-200 uppercase font-bold\\">Pr贸ximo Turno</p>\\r\\n                      <p className=\\"text-lg font-bold mt-1 truncate\\">\\r\\n                          {nextShift ? getDateObj(nextShift.startTime).toLocaleDateString(\'es-AR\', {weekday:\'short\', day:\'numeric\'}) : \'Libre\'}\\r\\n                      </p>\\r\\n                  </div>\\r\\n                  <div className=\\"bg-white/10 backdrop-blur-sm rounded-lg p-3 flex-1 border border-white/10\\">\\r\\n                      <p className=\\"text-xs text-indigo-200 uppercase font-bold\\">Estado</p>\\r\\n                      <p className=\\"text-lg font-bold mt-1 flex items-center gap-2\\">\\r\\n                          {nextShift?.status === \'InProgress\' ? \\r\\n                            <><span className=\\"w-2 h-2 rounded-full bg-green-400 animate-pulse shadow-[0_0_8px_rgba(74,222,128,0.8)]\\"/> En Servicio</> : \\r\\n                            \'Disponible\'}\\r\\n                      </p>\\r\\n                  </div>\\r\\n              </div>\\r\\n          </div>\\r\\n          {/* Decoraci贸n de fondo */}\\r\\n          <div className=\\"absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 bg-white/10 rounded-full blur-2xl\\"></div>\\r\\n          <div className=\\"absolute bottom-0 left-0 -mb-4 -ml-4 w-24 h-24 bg-indigo-500/20 rounded-full blur-xl\\"></div>\\r\\n      </div>\\r\\n\\r\\n      {/* 2. FILTROS (TABS) */}\\r\\n      <div className=\\"flex bg-gray-100 p-1 rounded-xl mb-6 shadow-inner\\">\\r\\n          {([\'day\', \'week\', \'month\'] as ViewMode[]).map(m => (\\r\\n              <button \\r\\n                key={m} \\r\\n                onClick={() => setViewMode(m)} \\r\\n                className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all capitalize ${viewMode === m ? \'bg-white text-indigo-600 shadow-sm transform scale-[1.02]\' : \'text-gray-500 hover:text-gray-700\'}`}\\r\\n              >\\r\\n                  {m === \'day\' ? \'Hoy\' : m === \'week\' ? \'Semana\' : \'Mes\'}\\r\\n              </button>\\r\\n          ))}\\r\\n      </div>\\r\\n\\r\\n      {/* 3. LISTADO DE TARJETAS */}\\r\\n      <div className=\\"space-y-5\\">\\r\\n        {filteredList.length === 0 ? (\\r\\n            <div className=\\"flex flex-col items-center justify-center py-12 bg-white rounded-2xl border border-dashed border-gray-200 text-center\\">\\r\\n                <span className=\\"text-4xl mb-3\\"></span>\\r\\n                <p className=\\"text-gray-500 font-medium\\">No hay servicios programados.</p>\\r\\n                <p className=\\"text-sm text-gray-400\\">Selecciona otro filtro para ver m谩s.</p>\\r\\n            </div>\\r\\n        ) : (\\r\\n            filteredList.map((shift) => (\\r\\n            <div key={shift.id} className=\\"bg-white rounded-2xl shadow-md border border-slate-100 overflow-hidden hover:shadow-lg transition-all duration-300\\">\\r\\n                \\r\\n                {/* Header Tarjeta */}\\r\\n                <div className=\\"bg-slate-50 px-5 py-4 border-b border-slate-100 flex justify-between items-center\\">\\r\\n                    <div>\\r\\n                        <span className=\\"font-bold text-gray-800 block truncate max-w-[180px] sm:max-w-xs\\">{shift.objectiveName || \'Objetivo\'}</span>\\r\\n                        <span className=\\"text-xs text-gray-500 uppercase tracking-wider\\">{shift.role || \'Vigilador\'}</span>\\r\\n                    </div>\\r\\n                    <span className={`text-[10px] px-2.5 py-1 rounded-full font-bold uppercase border ${\\r\\n                        shift.status === \'InProgress\' ? \'bg-indigo-50 text-indigo-700 border-indigo-100 animate-pulse\' : \\r\\n                        shift.status === \'Completed\' ? \'bg-green-50 text-green-700 border-green-100\' : \'bg-white text-slate-500 border-slate-200\'\\r\\n                    }`}>\\r\\n                        {shift.status === \'Assigned\' ? \'Pendiente\' : shift.status}\\r\\n                    </span>\\r\\n                </div>\\r\\n\\r\\n                <div className=\\"p-5\\">\\r\\n                    {/* Info Tiempo */}\\r\\n                    <div className=\\"flex justify-between mb-5 text-sm\\">\\r\\n                        <div>\\r\\n                            <p className=\\"text-gray-400 text-[10px] font-bold uppercase mb-0.5\\">Fecha</p>\\r\\n                            <p className=\\"font-medium text-slate-700 capitalize\\">{formatDate(shift.startTime)}</p>\\r\\n                        </div>\\r\\n                        <div className=\\"text-right\\">\\r\\n                            <p className=\\"text-gray-400 text-[10px] font-bold uppercase mb-0.5\\">Horario</p>\\r\\n                            <p className=\\"font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded\\">{formatTime(shift.startTime)} - {formatTime(shift.endTime)}</p>\\r\\n                        </div>\\r\\n                    </div>\\r\\n\\r\\n                    <div className=\\"space-y-3\\">\\r\\n                        {/* Botones: PENDIENTE */}\\r\\n                        {shift.status === \'Assigned\' && (\\r\\n                            <div className=\\"flex gap-2\\">\\r\\n                                <button \\r\\n                                    onClick={() => handleAuditAction(shift.id, \'CHECK_IN\')}\\r\\n                                    disabled={!!auditingId}\\r\\n                                    className=\\"flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow-md hover:bg-emerald-700 transition active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2\\"\\r\\n                                >\\r\\n                                    {auditingId === shift.id ? \'Validando...\' : <><span></span> DAR PRESENTE</>}\\r\\n                                </button>\\r\\n                                <button \\r\\n                                    onClick={() => { setSelectedShiftForAbsence(shift); setAbsenceModalOpen(true); }}\\r\\n                                    disabled={!!auditingId}\\r\\n                                    className=\\"px-4 py-3 bg-red-50 text-red-600 border border-red-100 rounded-xl font-bold text-lg hover:bg-red-100 transition active:scale-95\\"\\r\\n                                    title=\\"Reportar Ausencia / Problema\\"\\r\\n                                >\\r\\n                                    \\r\\n                                </button>\\r\\n                            </div>\\r\\n                        )}\\r\\n\\r\\n                        {/* Botones: EN CURSO */}\\r\\n                        {shift.status === \'InProgress\' && (\\r\\n                            <button \\r\\n                                onClick={() => handleAuditAction(shift.id, \'CHECK_OUT\')}\\r\\n                                disabled={!!auditingId}\\r\\n                                className=\\"w-full bg-rose-600 text-white py-3 rounded-xl font-bold text-sm shadow-md hover:bg-rose-700 transition active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2\\"\\r\\n                            >\\r\\n                                {auditingId === shift.id ? \'Cerrando...\' : <><span></span> FIN DE SERVICIO</>}\\r\\n                            </button>\\r\\n                        )}\\r\\n                        \\r\\n                        {/* Botones: FINALIZADO */}\\r\\n                        {shift.status === \'Completed\' && (\\r\\n                            <div className=\\"w-full bg-slate-50 text-slate-500 py-3 rounded-xl text-center text-sm font-medium border border-slate-200 flex items-center justify-center gap-2 cursor-default\\">\\r\\n                                <svg className=\\"w-4 h-4 text-green-500\\" fill=\\"none\\" stroke=\\"currentColor\\" viewBox=\\"0 0 24 24\\"><path strokeLinecap=\\"round\\" strokeLinejoin=\\"round\\" strokeWidth={2} d=\\"M5 13l4 4L19 7\\" /></svg>\\r\\n                                Servicio Completado\\r\\n                            </div>\\r\\n                        )}\\r\\n                    </div>\\r\\n                </div>\\r\\n            </div>\\r\\n            ))\\r\\n        )}\\r\\n      </div>\\r\\n\\r\\n      {/* MODAL DE AUSENCIA */}\\r\\n      {absenceModalOpen && (\\r\\n          <div className=\\"fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm animate-fadeIn\\">\\r\\n              <div className=\\"bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all\\">\\r\\n                  <div className=\\"flex items-center gap-3 mb-4 text-red-600\\">\\r\\n                      <div className=\\"bg-red-100 p-2 rounded-full\\">\\r\\n                        <svg className=\\"w-6 h-6\\" fill=\\"none\\" viewBox=\\"0 0 24 24\\" stroke=\\"currentColor\\"><path strokeLinecap=\\"round\\" strokeLinejoin=\\"round\\" strokeWidth={2} d=\\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\\" /></svg>\\r\\n                      </div>\\r\\n                      <h3 className=\\"text-lg font-bold text-gray-800\\">Reportar Ausencia</h3>\\r\\n                  </div>\\r\\n                  \\r\\n                  <p className=\\"text-sm text-gray-500 mb-4\\">\\r\\n                      驴Por qu茅 no podr谩s asistir al turno en <strong>{selectedShiftForAbsence?.objectiveName}</strong>?\\r\\n                  </p>\\r\\n                  \\r\\n                  <textarea \\r\\n                      className=\\"w-full border-gray-300 rounded-xl shadow-sm focus:ring-red-500 focus:border-red-500 text-sm p-3 border mb-6\\"\\r\\n                      rows={3}\\r\\n                      placeholder=\\"Escribe el motivo aqu铆...\\"\\r\\n                      value={absenceReason}\\r\\n                      onChange={e => setAbsenceReason(e.target.value)}\\r\\n                  />\\r\\n\\r\\n                  <div className=\\"flex gap-3\\">\\r\\n                      <button onClick={() => setAbsenceModalOpen(false)} className=\\"flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-xl transition bg-gray-50\\">Cancelar</button>\\r\\n                      <button onClick={handleReportAbsence} className=\\"flex-1 py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 shadow-md transition active:scale-95\\">Confirmar</button>\\r\\n                  </div>\\r\\n              </div>\\r\\n          </div>\\r\\n      )}\\r\\n    </div>\\r\\n  );\\r\\n}\\n\\n\\n\\n"},{"id":"tgly42zxf","name":"home.tsx","path":"apps\\\\web\\\\src\\\\components\\\\employee\\\\home.tsx","area":"FRONTEND","content":"import React from \'react\';\\r\\nimport { withAuthGuard } from \'@/components/common/withAuthGuard\';\\r\\nimport { useAuth } from \'@/context/AuthContext\';\\r\\nimport { Calendar, LogOut, User } from \'lucide-react\';\\r\\n\\r\\nfunction EmployeeHome() {\\r\\n    const { user, logout } = useAuth();\\r\\n\\r\\n    return (\\r\\n        <div className=\\"min-h-screen bg-slate-50\\">\\r\\n            {/* Header Simple para M贸vil */}\\r\\n            <header className=\\"bg-indigo-900 text-white p-4 shadow-md flex justify-between items-center\\">\\r\\n                <div className=\\"flex items-center gap-3\\">\\r\\n                    <div className=\\"w-10 h-10 bg-indigo-700 rounded-full flex items-center justify-center font-bold\\">\\r\\n                        {user?.displayName?.charAt(0) || \'E\'}\\r\\n                    </div>\\r\\n                    <div>\\r\\n                        <h1 className=\\"font-bold text-sm\\">{user?.displayName || \'Colaborador\'}</h1>\\r\\n                        <p className=\\"text-[10px] text-indigo-200 uppercase\\">Portal del Empleado</p>\\r\\n                    </div>\\r\\n                </div>\\r\\n                <button onClick={logout} className=\\"p-2 bg-indigo-800 rounded-lg hover:bg-indigo-700\\">\\r\\n                    <LogOut size={18}/>\\r\\n                </button>\\r\\n            </header>\\r\\n\\r\\n            {/* Contenido */}\\r\\n            <main className=\\"p-4 space-y-4\\">\\r\\n                <div className=\\"bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center\\">\\r\\n                    <div className=\\"mx-auto w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mb-3\\">\\r\\n                        <Calendar size={32}/>\\r\\n                    </div>\\r\\n                    <h2 className=\\"text-xl font-bold text-gray-800\\">Mi Cronograma</h2>\\r\\n                    <p className=\\"text-gray-500 text-sm mb-4\\">Consulta tus turnos asignados.</p>\\r\\n                    <button className=\\"w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition\\">\\r\\n                        Ver Turnos\\r\\n                    </button>\\r\\n                </div>\\r\\n\\r\\n                <div className=\\"bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center\\">\\r\\n                    <div className=\\"mx-auto w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-3\\">\\r\\n                        <User size={32}/>\\r\\n                    </div>\\r\\n                    <h2 className=\\"text-xl font-bold text-gray-800\\">Mis Datos</h2>\\r\\n                    <p className=\\"text-gray-500 text-sm mb-4\\">Informaci贸n personal y legajo.</p>\\r\\n                    <button className=\\"w-full py-3 bg-white border border-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-50 transition\\">\\r\\n                        Ver Perfil\\r\\n                    </button>\\r\\n                </div>\\r\\n            </main>\\r\\n        </div>\\r\\n    );\\r\\n}\\r\\n\\r\\n//  SEGURIDAD: Esta p谩gina permite SOLO a \'employee\' (y admins si quieren verla)\\r\\nexport default withAuthGuard(EmployeeHome, [\'employee\', \'admin\', \'SuperAdmin\']);\\n\\n"},{"id":"9cbx9dj9l","name":"DashboardLayout.tsx","path":"apps\\\\web\\\\src\\\\components\\\\layout\\\\DashboardLayout.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport { useRouter } from \'next/router\';\\r\\nimport { useClient } from \'@/context/ClientContext\';\\r\\nimport { auth } from \'@/services/firebase-client.service\';\\r\\nimport { APP_INFO, MenuItem } from \'@/config/app.config\';\\r\\n// Importamos iconos\\r\\nimport { \\r\\n  LayoutDashboard, Building2, Target, Users, CalendarDays, ShieldCheck, \\r\\n  Activity, Menu, X, LogOut, ChevronDown, Settings, Map, Zap, \\r\\n  FileText, ChevronRight \\r\\n} from \'lucide-react\';\\r\\n\\r\\ninterface LayoutProps {\\r\\n  children: React.ReactNode;\\r\\n  title: string;\\r\\n}\\r\\n\\r\\n// Mapeo de iconos\\r\\nconst iconMap: any = {\\r\\n  LayoutDashboard: <LayoutDashboard size={20} />,\\r\\n  Building2: <Building2 size={20} />,\\r\\n  Target: <Target size={20} />,\\r\\n  Users: <Users size={20} />,\\r\\n  CalendarDays: <CalendarDays size={20} />,\\r\\n  ShieldCheck: <ShieldCheck size={20} />,\\r\\n  Activity: <Activity size={20} />,\\r\\n  Map: <Map size={20} />,\\r\\n  Zap: <Zap size={20} />,\\r\\n  Settings: <Settings size={20} />,\\r\\n  FileText: <FileText size={20} />\\r\\n};\\r\\n\\r\\nfunction DashboardLayout({ children, title }: LayoutProps) {\\r\\n  const router = useRouter();\\r\\n  const { clients, selectedClientId, setClient, loading } = useClient();\\r\\n  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);\\r\\n  \\r\\n  //  ESTADO PARA CONTROLAR LOS MENS ABIERTOS\\r\\n  const [openMenus, setOpenMenus] = useState<Record<string, boolean>>({});\\r\\n\\r\\n  // Efecto para abrir autom谩ticamente el men煤 donde est谩 la ruta actual\\r\\n  useEffect(() => {\\r\\n    const newOpenState = { ...openMenus };\\r\\n    APP_INFO.menuItems.forEach(item => {\\r\\n      if (item.children) {\\r\\n        // Si alguno de los hijos es la ruta actual, abrimos el padre\\r\\n        const isChildActive = item.children.some(child => child.path === router.pathname);\\r\\n        if (isChildActive) {\\r\\n          newOpenState[item.name] = true;\\r\\n        }\\r\\n      }\\r\\n    });\\r\\n    setOpenMenus(newOpenState);\\r\\n  }, []); // Se ejecuta solo al montar\\r\\n\\r\\n  const toggleMenu = (name: string) => {\\r\\n    setOpenMenus(prev => ({ ...prev, [name]: !prev[name] }));\\r\\n  };\\r\\n\\r\\n  const handleLogout = async () => {\\r\\n    try {\\r\\n      await auth.signOut();\\r\\n      window.location.href = \'/\'; \\r\\n    } catch (error) {\\r\\n      console.error(\\"Error al cerrar sesi贸n:\\", error);\\r\\n    }\\r\\n  };\\r\\n\\r\\n  // --- COMPONENTE DE RENDERIZADO DE ITEM DE MEN ---\\r\\n  const renderMenuItem = (item: MenuItem) => {\\r\\n    const hasChildren = item.children && item.children.length > 0;\\r\\n    const isOpen = openMenus[item.name];\\r\\n    \\r\\n    // Verificamos si este item (o sus hijos) est谩 activo\\r\\n    const isActiveParent = hasChildren && item.children?.some(child => child.path === router.pathname);\\r\\n    const isActive = router.pathname === item.path;\\r\\n\\r\\n    // 1. SI TIENE HIJOS (ES UN GRUPO)\\r\\n    if (hasChildren) {\\r\\n      return (\\r\\n        <div key={item.name} className=\\"mb-1\\">\\r\\n          <button\\r\\n            onClick={() => toggleMenu(item.name)}\\r\\n            className={`w-full flex items-center justify-between px-3 py-2.5 rounded-lg transition-all duration-200 group ${\\r\\n              isActiveParent \\r\\n                ? \'bg-indigo-50/50 text-indigo-700 font-semibold\' \\r\\n                : \'text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-medium\'\\r\\n            }`}\\r\\n          >\\r\\n            <div className=\\"flex items-center space-x-3\\">\\r\\n              <span className={`transition-colors ${isActiveParent ? \'text-indigo-600\' : \'text-slate-400 group-hover:text-slate-600\'}`}>\\r\\n                {iconMap[item.icon] || <Settings size={20} />}\\r\\n              </span>\\r\\n              <span className=\\"text-sm\\">{item.name}</span>\\r\\n            </div>\\r\\n            {/* Flecha de rotaci贸n */}\\r\\n            <div className={`transition-transform duration-200 ${isOpen ? \'rotate-90\' : \'\'}`}>\\r\\n               <ChevronRight size={16} className=\\"text-slate-400\\"/>\\r\\n            </div>\\r\\n          </button>\\r\\n\\r\\n          {/* Renderizado de Hijos (Submen煤) */}\\r\\n          {isOpen && (\\r\\n            <div className=\\"mt-1 ml-4 border-l-2 border-slate-100 space-y-1\\">\\r\\n              {item.children!.map(child => {\\r\\n                const isChildActive = router.pathname === child.path;\\r\\n                return (\\r\\n                  <button\\r\\n                    key={child.path}\\r\\n                    onClick={() => {\\r\\n                      if (child.path) router.push(child.path);\\r\\n                      setIsMobileMenuOpen(false);\\r\\n                    }}\\r\\n                    className={`w-full flex items-center space-x-3 px-3 py-2 rounded-r-lg transition-all duration-200 ml-1 ${\\r\\n                      isChildActive \\r\\n                        ? \'bg-indigo-50 text-indigo-700 font-bold border-l-4 border-indigo-600 -ml-[5px]\' // Efecto visual activo\\r\\n                        : \'text-slate-500 hover:text-slate-900 hover:bg-slate-50\'\\r\\n                    }`}\\r\\n                  >\\r\\n                    <span className={`text-sm ${isChildActive ? \'ml-0\' : \'ml-0\'}`}>{child.name}</span>\\r\\n                  </button>\\r\\n                );\\r\\n              })}\\r\\n            </div>\\r\\n          )}\\r\\n        </div>\\r\\n      );\\r\\n    }\\r\\n\\r\\n    // 2. SI ES UN ITEM SIMPLE (SIN HIJOS)\\r\\n    return (\\r\\n      <button\\r\\n        key={item.path}\\r\\n        onClick={() => {\\r\\n          if (item.path) router.push(item.path);\\r\\n          setIsMobileMenuOpen(false);\\r\\n        }}\\r\\n        className={`w-full flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all duration-200 group mb-1 ${\\r\\n          isActive \\r\\n            ? \'bg-indigo-50 text-indigo-700 font-semibold shadow-sm ring-1 ring-indigo-200\' \\r\\n            : \'text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-medium\'\\r\\n        }`}\\r\\n      >\\r\\n        <span className={`transition-colors ${isActive ? \'text-indigo-600\' : \'text-slate-400 group-hover:text-slate-600\'}`}>\\r\\n          {iconMap[item.icon] || <Settings size={20} />}\\r\\n        </span>\\r\\n        <span className=\\"text-sm\\">{item.name}</span>\\r\\n      </button>\\r\\n    );\\r\\n  };\\r\\n\\r\\n  const SidebarContent = () => (\\r\\n    <>\\r\\n      {/* Header */}\\r\\n      <div className=\\"h-16 flex items-center px-6 border-b border-slate-100 bg-white\\">\\r\\n        <div>\\r\\n          <h1 className=\\"text-xl font-extrabold text-indigo-700 tracking-tight\\">\\r\\n            {APP_INFO.name}\\r\\n          </h1>\\r\\n          <div className=\\"flex items-center space-x-2\\">\\r\\n            <span className=\\"text-[10px] font-mono text-slate-400 border border-slate-200 rounded px-1.5 bg-slate-50\\">\\r\\n                v{APP_INFO.version}\\r\\n            </span>\\r\\n          </div>\\r\\n        </div>\\r\\n      </div>\\r\\n\\r\\n      {/* Contexto */}\\r\\n      <div className=\\"px-4 py-4 border-b border-slate-100 bg-slate-50/50\\">\\r\\n          <label className=\\"text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block\\">\\r\\n            Contexto Operativo\\r\\n          </label>\\r\\n          {loading ? (\\r\\n              <div className=\\"h-9 w-full bg-slate-200 rounded animate-pulse\\"></div>\\r\\n          ) : (\\r\\n              <div className=\\"relative\\">\\r\\n                <select \\r\\n                    value={selectedClientId} \\r\\n                    onChange={(e) => setClient(e.target.value)}\\r\\n                    className={`w-full text-sm border-slate-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 py-2 pl-2 pr-8 appearance-none cursor-pointer truncate font-medium ${selectedClientId === \'\' ? \'bg-indigo-50 text-indigo-700 font-bold border-indigo-200\' : \'bg-white text-slate-700\'}`}\\r\\n                >\\r\\n                    <option value=\\"\\"> Ver Toda la Operaci贸n</option>\\r\\n                    <optgroup label=\\"Clientes Espec铆ficos\\">\\r\\n                        {clients.map(c => (\\r\\n                            <option key={c.id} value={c.id}>{c.businessName}</option>\\r\\n                        ))}\\r\\n                    </optgroup>\\r\\n                </select>\\r\\n                <div className=\\"pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500\\">\\r\\n                  <ChevronDown size={14} />\\r\\n                </div>\\r\\n              </div>\\r\\n          )}\\r\\n      </div>\\r\\n\\r\\n      {/* Navegaci贸n (Renderizado Din谩mico) */}\\r\\n      <nav className=\\"flex-1 px-3 py-4 overflow-y-auto\\">\\r\\n        {APP_INFO.menuItems.map(item => renderMenuItem(item))}\\r\\n      </nav>\\r\\n\\r\\n      {/* Footer */}\\r\\n      <div className=\\"p-4 border-t border-slate-100 mt-auto bg-white\\">\\r\\n        <button onClick={handleLogout} className=\\"flex items-center space-x-3 text-rose-600 hover:bg-rose-50 w-full px-3 py-2.5 rounded-lg transition-colors text-sm font-medium group\\">\\r\\n          <LogOut size={20} className=\\"group-hover:text-rose-700\\" />\\r\\n          <span>Cerrar Sesi贸n</span>\\r\\n        </button>\\r\\n      </div>\\r\\n    </>\\r\\n  );\\r\\n\\r\\n  return (\\r\\n    <div className=\\"flex h-screen bg-[#F8FAFC] font-sans text-slate-600\\">\\r\\n      \\r\\n      {/* Desktop Sidebar */}\\r\\n      <aside className=\\"w-64 bg-white border-r border-slate-200 hidden md:flex flex-col fixed h-full z-30 shadow-sm\\">\\r\\n        <SidebarContent />\\r\\n      </aside>\\r\\n\\r\\n      {/* Mobile Menu Overlay */}\\r\\n      {isMobileMenuOpen && (\\r\\n        <div className=\\"fixed inset-0 z-50 flex md:hidden\\">\\r\\n          <div className=\\"fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity\\" onClick={() => setIsMobileMenuOpen(false)}></div>\\r\\n          <div className=\\"relative flex-1 flex flex-col max-w-xs w-full bg-white shadow-2xl transform transition-transform duration-300 ease-in-out\\">\\r\\n            <div className=\\"absolute top-0 right-0 -mr-12 pt-2\\">\\r\\n              <button className=\\"ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white\\" onClick={() => setIsMobileMenuOpen(false)}>\\r\\n                <X className=\\"h-6 w-6 text-white\\" />\\r\\n              </button>\\r\\n            </div>\\r\\n            <SidebarContent />\\r\\n          </div>\\r\\n        </div>\\r\\n      )}\\r\\n\\r\\n      {/* Main Content Area */}\\r\\n      <div className=\\"flex-1 flex flex-col md:pl-64 h-screen overflow-hidden transition-all duration-300\\">\\r\\n        \\r\\n        {/* Topbar */}\\r\\n        <header className=\\"h-16 bg-white/90 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-4 md:px-8 sticky top-0 z-20 shrink-0 shadow-sm\\">\\r\\n          <div className=\\"flex items-center gap-3\\">\\r\\n            <button onClick={() => setIsMobileMenuOpen(true)} className=\\"md:hidden -ml-2 p-2 text-slate-500 hover:text-indigo-600 rounded-md\\">\\r\\n              <Menu className=\\"w-6 h-6\\" />\\r\\n            </button>\\r\\n            <h2 className=\\"text-lg font-bold text-slate-800 truncate leading-tight\\">{title}</h2>\\r\\n          </div>\\r\\n          <div className=\\"flex items-center space-x-4\\">\\r\\n             <div className=\\"h-9 w-9 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-700 font-bold text-sm border border-indigo-100 shadow-sm\\">\\r\\n               AD\\r\\n             </div>\\r\\n          </div>\\r\\n        </header>\\r\\n\\r\\n        {/* Page Content */}\\r\\n        <main className=\\"flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth\\">\\r\\n          <div className=\\"max-w-7xl mx-auto h-full\\">\\r\\n            {children}\\r\\n          </div>\\r\\n        </main>\\r\\n      </div>\\r\\n    </div>\\r\\n  );\\r\\n}\\r\\n\\r\\nexport default DashboardLayout;\\n\\n\\n\\n"},{"id":"29ff4nh6n","name":"Sidebar.tsx","path":"apps\\\\web\\\\src\\\\components\\\\layout\\\\Sidebar.tsx","area":"FRONTEND","content":"import React from \'react\';\\nimport Link from \'next/link\';\\nimport { useRouter } from \'next/router\';\\nimport { useAuth } from \'@/context/AuthContext\';\\nimport { \\n  LayoutDashboard, \\n  Users, \\n  Calendar, \\n  Map as MapIcon, \\n  Settings, \\n  LogOut,\\n  UserCheck,\\n  ClipboardList,\\n  Wallet\\n} from \'lucide-react\';\\n\\nexport function Sidebar() {\\n  const router = useRouter();\\n  const { signOut, user } = useAuth();\\n\\n  const menuItems = [\\n    { name: \'Dashboard\', href: \'/admin/dashboard\', icon: LayoutDashboard },\\n    { name: \'Personal\', href: \'/admin/personal\', icon: Users },\\n    { name: \'Asignaciones\', href: \'/admin/asignaciones\', icon: Calendar },\\n    { name: \'Mapa Operativo\', href: \'/admin/operations/map\', icon: MapIcon },\\n    { name: \'Liquidaciones\', href: \'/admin/liquidaciones\', icon: Wallet },\\n    { name: \'Configuraci贸n\', href: \'/admin/configuracion\', icon: Settings },\\n  ];\\n\\n  return (\\n    <aside className=\\"w-64 bg-white border-r border-slate-200 flex flex-col h-screen\\">\\n      <div className=\\"p-6\\">\\n        <h1 className=\\"text-xl font-bold text-slate-800\\">CronoApp</h1>\\n        <p className=\\"text-xs text-slate-500\\">Panel de Control</p>\\n      </div>\\n      \\n      <nav className=\\"flex-1 px-4 space-y-1\\">\\n        {menuItems.map((item) => {\\n          const Icon = item.icon;\\n          const isActive = router.pathname === item.href;\\n          \\n          return (\\n            <Link\\n              key={item.name}\\n              href={item.href}\\n              className={`flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-colors ${\\n                isActive \\n                  ? \'bg-indigo-50 text-indigo-700\' \\n                  : \'text-slate-600 hover:bg-slate-50 hover:text-slate-900\'\\n              }`}\\n            >\\n              <Icon className=\\"mr-3 h-5 w-5\\" />\\n              {item.name}\\n            </Link>\\n          );\\n        })}\\n      </nav>\\n\\n      <div className=\\"p-4 border-t border-slate-200\\">\\n        <div className=\\"flex items-center mb-4 px-4\\">\\n          <div className=\\"flex-1 min-w-0\\">\\n            <p className=\\"text-sm font-medium text-slate-900 truncate\\">\\n              {user?.displayName || \'Administrador\'}\\n            </p>\\n            <p className=\\"text-xs text-slate-500 truncate\\">\\n              {user?.email}\\n            </p>\\n          </div>\\n        </div>\\n        <button\\n          onClick={() => signOut()}\\n          className=\\"flex items-center w-full px-4 py-2 text-sm font-medium text-slate-600 rounded-lg hover:bg-rose-50 hover:text-rose-700 transition-colors\\"\\n        >\\n          <LogOut className=\\"mr-3 h-5 w-5\\" />\\n          Cerrar Sesi贸n\\n        </button>\\n      </div>\\n    </aside>\\n  );\\n}\\n"},{"id":"1g87t8v89","name":"app.config.ts","path":"apps\\\\web\\\\src\\\\config\\\\app.config.ts","area":"FRONTEND","content":"import { ReactNode } from \'react\';\\r\\n\\r\\n// Definici贸n de tipos para el men煤\\r\\nexport interface MenuItem {\\r\\n  name: string;\\r\\n  path?: string; // Opcional si es un padre agrupador\\r\\n  icon: string;\\r\\n  children?: MenuItem[]; // Soporte para submen煤s\\r\\n}\\r\\n\\r\\nexport const APP_INFO = {\\r\\n  name: \'BacarPlan\',\\r\\n  version: \'1.3.0\',\\r\\n  description: \'Sistema Integral de Gesti贸n Operativa\',\\r\\n  menuItems: [\\r\\n    { \\r\\n      name: \'Planificaci贸n\', \\r\\n      icon: \'CalendarDays\',\\r\\n      children: [\\r\\n        { name: \'Calendario (Grid)\', path: \'/admin/dashboard\', icon: \'LayoutDashboard\' },\\r\\n        { name: \'Cronograma (Gantt)\', path: \'/admin/planning/gantt\', icon: \'Zap\' },\\r\\n      ]\\r\\n    },\\r\\n    { \\r\\n      name: \'Operaciones\', \\r\\n      icon: \'Map\',\\r\\n      children: [\\r\\n        { name: \'Torre de Control\', path: \'/admin/operations/map\', icon: \'Map\' },\\r\\n      ]\\r\\n    },\\r\\n    { \\r\\n      name: \'Gesti贸n\', \\r\\n      icon: \'Building2\',\\r\\n      children: [\\r\\n        { name: \'Empresas / Clientes\', path: \'/admin/clients\', icon: \'Building2\' },\\r\\n        { name: \'Sedes / Objetivos\', path: \'/admin/objective-management\', icon: \'Target\' },\\r\\n        { name: \'Personal / RRHH\', path: \'/admin/employees\', icon: \'Users\' },\\r\\n        //  NUEVO TEM\\r\\n        { name: \'Convenios / Reglas\', path: \'/admin/labor-agreements\', icon: \'Briefcase\' },\\r\\n        { name: \'Novedades (Licencias)\', path: \'/admin/rrhh/novedades\', icon: \'FileText\' },\\r\\n      ]\\r\\n    },\\r\\n    { \\r\\n      name: \'Configuraci贸n\', \\r\\n      icon: \'Settings\',\\r\\n      children: [\\r\\n        { name: \'Usuarios Sistema\', path: \'/admin/system-users\', icon: \'ShieldCheck\' },\\r\\n        { name: \'Diagn贸stico\', path: \'/admin/status\', icon: \'Activity\' },\\r\\n      ]\\r\\n    },\\r\\n  ] as MenuItem[]\\r\\n};\\n\\n\\n\\n"},{"id":"bp4yn9wn9","name":"AuthContext.tsx","path":"apps\\\\web\\\\src\\\\context\\\\AuthContext.tsx","area":"FRONTEND","content":"import React, { createContext, useContext, useEffect, useState } from \'react\';\\r\\nimport { \\r\\n    onAuthStateChanged, \\r\\n    signInWithEmailAndPassword, \\r\\n    signOut as firebaseSignOut, \\r\\n    User \\r\\n} from \'firebase/auth\';\\r\\nimport { auth } from \'@/services/firebase-client.service\';\\r\\nimport { useRouter } from \'next/router\';\\r\\n\\r\\ninterface AuthContextProps {\\r\\n    user: User | null;\\r\\n    loading: boolean;\\r\\n    login: (email: string, pass: string) => Promise<void>;\\r\\n    logout: () => Promise<void>;\\r\\n}\\r\\n\\r\\nconst AuthContext = createContext<AuthContextProps>({\\r\\n    user: null,\\r\\n    loading: true,\\r\\n    login: async () => {},\\r\\n    logout: async () => {},\\r\\n});\\r\\n\\r\\nexport const useAuth = () => useContext(AuthContext);\\r\\n\\r\\nexport const AuthProvider = ({ children }: { children: React.ReactNode }) => {\\r\\n    const [user, setUser] = useState<User | null>(null);\\r\\n    const [loading, setLoading] = useState(true);\\r\\n    const router = useRouter();\\r\\n\\r\\n    useEffect(() => {\\r\\n        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {\\r\\n            setUser(currentUser);\\r\\n            setLoading(false);\\r\\n        });\\r\\n        return () => unsubscribe();\\r\\n    }, []);\\r\\n\\r\\n    const login = async (email: string, pass: string) => {\\r\\n        await signInWithEmailAndPassword(auth, email, pass);\\r\\n    };\\r\\n\\r\\n    const logout = async () => {\\r\\n        await firebaseSignOut(auth);\\r\\n        router.push(\'/\');\\r\\n    };\\r\\n\\r\\n    return (\\r\\n        <AuthContext.Provider value={{ user, loading, login, logout }}>\\r\\n            {children}\\r\\n        </AuthContext.Provider>\\r\\n    );\\r\\n};\\n\\n"},{"id":"9vsvidfjq","name":"ClientContext.tsx","path":"apps\\\\web\\\\src\\\\context\\\\ClientContext.tsx","area":"FRONTEND","content":"import React, { createContext, useContext, useState, useEffect, ReactNode } from \'react\';\\r\\nimport { onAuthStateChanged } from \'firebase/auth\';\\r\\nimport { auth, callManageHierarchy } from \'@/services/firebase-client.service\';\\r\\nimport { IClient } from \'@/common/interfaces/client.interface\';\\r\\nimport toast from \'react-hot-toast\';\\r\\n\\r\\ninterface ClientContextType {\\r\\n  clients: IClient[];\\r\\n  selectedClientId: string;\\r\\n  selectedClient: IClient | undefined;\\r\\n  setClient: (id: string) => void;\\r\\n  loading: boolean;\\r\\n}\\r\\n\\r\\n// Roles que tienen permiso para ver empresas\\r\\nconst ADMIN_ROLES = [\'admin\', \'SuperAdmin\', \'Scheduler\', \'HR_Manager\', \'Manager\', \'Operator\', \'Supervisor\'];\\r\\n\\r\\nconst ClientContext = createContext<ClientContextType | undefined>(undefined);\\r\\n\\r\\nexport function ClientProvider({ children }: { children: ReactNode }) {\\r\\n  const [clients, setClients] = useState<IClient[]>([]);\\r\\n  const [selectedClientId, setSelectedClientId] = useState<string>(\'\'); // Default: Vac铆o = \\"Todos\\"\\r\\n  const [loading, setLoading] = useState(true);\\r\\n\\r\\n  useEffect(() => {\\r\\n    const unsubscribe = onAuthStateChanged(auth, async (user) => {\\r\\n      if (user) {\\r\\n        try {\\r\\n          const tokenResult = await user.getIdTokenResult();\\r\\n          const role = tokenResult.claims.role as string;\\r\\n\\r\\n          if (ADMIN_ROLES.includes(role)) {\\r\\n            await loadClients();\\r\\n          } else {\\r\\n            setLoading(false);\\r\\n          }\\r\\n        } catch (error) {\\r\\n          console.error(\\"Error verificando permisos:\\", error);\\r\\n          setLoading(false);\\r\\n        }\\r\\n      } else {\\r\\n        setClients([]);\\r\\n        setSelectedClientId(\'\');\\r\\n        setLoading(false);\\r\\n      }\\r\\n    });\\r\\n\\r\\n    return () => unsubscribe();\\r\\n  }, []);\\r\\n\\r\\n  async function loadClients() {\\r\\n    try {\\r\\n      const res = await callManageHierarchy({ action: \'GET_ALL_CLIENTS\', payload: {} });\\r\\n      const responseData = res.data as any; \\r\\n      const data = responseData.data || [];\\r\\n      \\r\\n      setClients(data);\\r\\n\\r\\n      //  LGICA DE SELECCIN INTELIGENTE\\r\\n      const savedId = localStorage.getItem(\'selectedClientId\');\\r\\n      \\r\\n      // Si hay un guardado v谩lido, lo usamos.\\r\\n      if (savedId && (savedId === \'\' || data.find((c: IClient) => c.id === savedId))) {\\r\\n        setSelectedClientId(savedId);\\r\\n      } else {\\r\\n        // Si no hay nada guardado, por defecto mostramos \\"TODOS\\" (vac铆o)\\r\\n        // Esto es mejor para una visi贸n gerencial.\\r\\n        setSelectedClientId(\'\');\\r\\n      }\\r\\n\\r\\n    } catch (error: any) {\\r\\n      console.error(\\"Error loading clients\\", error);\\r\\n      toast.error(\\"No se pudieron cargar las empresas.\\");\\r\\n    } finally {\\r\\n      setLoading(false);\\r\\n    }\\r\\n  }\\r\\n\\r\\n  const setClient = (id: string) => {\\r\\n    setSelectedClientId(id);\\r\\n    localStorage.setItem(\'selectedClientId\', id);\\r\\n    \\r\\n    // Feedback visual opcional\\r\\n    if (id === \'\') toast.success(\\"Vista Global activada\\");\\r\\n    else {\\r\\n        const clientName = clients.find(c => c.id === id)?.businessName;\\r\\n        toast.success(`Filtrando por: ${clientName}`);\\r\\n    }\\r\\n  };\\r\\n\\r\\n  const selectedClient = clients.find(c => c.id === selectedClientId);\\r\\n\\r\\n  return (\\r\\n    <ClientContext.Provider value={{ clients, selectedClientId, selectedClient, setClient, loading }}>\\r\\n      {children}\\r\\n    </ClientContext.Provider>\\r\\n  );\\r\\n}\\r\\n\\r\\nexport function useClient() {\\r\\n  const context = useContext(ClientContext);\\r\\n  if (!context) throw new Error(\'useClient debe usarse dentro de ClientProvider\');\\r\\n  return context;\\r\\n}\\n\\n\\n\\n"},{"id":"t5mtneqhy","name":"ThemeContext.tsx","path":"apps\\\\web\\\\src\\\\context\\\\ThemeContext.tsx","area":"FRONTEND","content":"import React, { createContext, useContext, useEffect, useState } from \'react\';\\n\\nexport type TTheme = \'enterprise\' | \'tactical\' | \'modern\';\\n\\ninterface ThemeProps {\\n  theme: TTheme;\\n  setTheme: (t: TTheme) => void;\\n}\\n\\nconst ThemeContext = createContext<ThemeProps | undefined>(undefined);\\n\\nexport const ThemeProvider = ({ children }: { children: React.ReactNode }) => {\\n  const [theme, setTheme] = useState<TTheme>(\'enterprise\');\\n\\n  useEffect(() => {\\n    const saved = localStorage.getItem(\'cronoapp-theme\') as TTheme;\\n    if (saved) setTheme(saved); console.log(\\"DEBUG-CONTEXT: Tema cargado de storage\\", saved);\\n  }, []);\\n\\n  useEffect(() => {\\n    const rootEl = document.documentElement;\\n    rootEl.setAttribute(\'data-theme\', theme);\\n    localStorage.setItem(\'cronoapp-theme\', theme); console.log(\\"DEBUG-CONTEXT: Tema aplicado al HTML\\", theme);\\n    console.log(\\"CronoApp Theme Switch ->\\", theme);\\n  }, [theme]);\\n\\n  return (\\n    <ThemeContext.Provider value={{ theme, setTheme }}>\\n      {children}\\n    </ThemeContext.Provider>\\n  );\\n};\\n\\nexport const useTheme = () => {\\n  const context = useContext(ThemeContext);\\n  if (!context) return { theme: \'enterprise\' as TTheme, setTheme: () => {} };\\n  return context;\\n};\\n"},{"id":"xl27779rp","name":"useAudit.ts","path":"apps\\\\web\\\\src\\\\hooks\\\\useAudit.ts","area":"FRONTEND","content":"import { useQuery } from \'@tanstack/react-query\';\\nimport { callManageAudits } from \'@/services/firebase-client.service\';\\nimport { useClient } from \'@/context/ClientContext\';\\n\\nexport function useAuditLogs(filters: any) {\\n  const { selectedClientId } = useClient();\\n\\n  return useQuery({\\n    // Incluimos el ID del cliente en la queryKey para que refresque al cambiar de empresa\\n    queryKey: [\'audit-logs\', selectedClientId, filters],\\n    queryFn: async () => {\\n      console.log(\\"帮 Enviando petici贸n de Auditor铆a para Cliente:\\", selectedClientId);\\n      \\n      try {\\n        const res: any = await callManageAudits({ \\n          action: \'GET_LOGS\', \\n          payload: { \\n            ...filters,\\n            clientId: selectedClientId // IMPORTANTE: Enviamos el ID al backend\\n          } \\n        });\\n        \\n        console.log(\\" Respuesta recibida:\\", res);\\n\\n        // Extraemos los datos intentando todas las rutas posibles del objeto\\n        const finalData = res?.data?.data || res?.data || res || [];\\n        return Array.isArray(finalData) ? finalData : [];\\n      } catch (err) {\\n        console.error(\\" Error cr铆tico en Auditor铆a:\\", err);\\n        return [];\\n      }\\n    },\\n    // Solo se ejecuta si hay un cliente seleccionado\\n    enabled: !!selectedClientId,\\n  });\\n}"},{"id":"9gf3oenvh","name":"useSchedulerDataFetcher.ts","path":"apps\\\\web\\\\src\\\\hooks\\\\useSchedulerDataFetcher.ts","area":"FRONTEND","content":"import { useState, useEffect } from \'react\';\\r\\nimport toast from \'react-hot-toast\';\\r\\nimport { callManageEmployees, callManageData } from \'@/services/firebase-client.service\';\\r\\nimport { IEmployee } from \'@/common/interfaces/employee.interface\';\\r\\nimport { IObjective } from \'@/common/interfaces/client.interface\';\\r\\n\\r\\nexport const useSchedulerDataFetcher = (selectedClientId: string | null) => {\\r\\n    const [employees, setEmployees] = useState<IEmployee[]>([]);\\r\\n    const [objectives, setObjectives] = useState<IObjective[]>([]);\\r\\n    const [selectedObjectiveId, setSelectedObjectiveId] = useState<string>(\'\');\\r\\n    const [isLoading, setIsLoading] = useState<boolean>(false);\\r\\n\\r\\n    useEffect(() => {\\r\\n        const fetchAll = async () => {\\r\\n            //  DEBUG: Verificar qu茅 ID llega al hook\\r\\n            console.log(\\" [Fetcher] Cambio de empresa detectado. ID:\\", selectedClientId);\\r\\n\\r\\n            // Si no hay cliente seleccionado, limpiamos y salimos\\r\\n            if (!selectedClientId) {\\r\\n                console.log(\\"锔 [Fetcher] No hay cliente seleccionado. Limpiando datos.\\");\\r\\n                setEmployees([]);\\r\\n                setObjectives([]);\\r\\n                setSelectedObjectiveId(\'\');\\r\\n                return;\\r\\n            }\\r\\n\\r\\n            setIsLoading(true);\\r\\n            \\r\\n            try {\\r\\n                // 1. Obtener Empleados (Con filtro de empresa)\\r\\n                console.log(\\" [Fetcher] Solicitando empleados al Backend para cliente:\\", selectedClientId);\\r\\n                \\r\\n                const empRes = await callManageEmployees({ \\r\\n                    action: \'GET_ALL_EMPLOYEES\', \\r\\n                    payload: { clientId: selectedClientId } //  Aqu铆 enviamos el filtro\\r\\n                });\\r\\n                \\r\\n                // Manejo defensivo de la respuesta\\r\\n                const empData = (empRes.data as any).data || [];\\r\\n                \\r\\n                //  DEBUG: Verificar qu茅 devolvi贸 el Backend\\r\\n                console.log(` [Fetcher] Recibidos ${empData.length} empleados.`);\\r\\n                console.log(\\" [Fetcher] Lista de empleados:\\", empData);\\r\\n                \\r\\n                setEmployees(empData);\\r\\n\\r\\n                // 2. Obtener Objetivos (Con filtro de empresa)\\r\\n                console.log(\\" [Fetcher] Solicitando objetivos...\\");\\r\\n                const objRes = await callManageData({ \\r\\n                    action: \'GET_ALL_OBJECTIVES\', \\r\\n                    payload: { clientId: selectedClientId } \\r\\n                });\\r\\n                \\r\\n                const objData = (objRes.data as any).data || [];\\r\\n                setObjectives(objData);\\r\\n                \\r\\n                // Seleccionar autom谩ticamente el primer objetivo si existe\\r\\n                if (objData.length > 0) {\\r\\n                    setSelectedObjectiveId(objData[0].id);\\r\\n                } else {\\r\\n                    setSelectedObjectiveId(\'\');\\r\\n                }\\r\\n            \\r\\n            } catch (error) {\\r\\n                console.error(\\" [Fetcher] Error CRTICO cargando datos:\\", error);\\r\\n                toast.error(\\"Error al cargar los datos de la empresa.\\");\\r\\n                setEmployees([]);\\r\\n                setObjectives([]);\\r\\n            } finally {\\r\\n                setIsLoading(false);\\r\\n            }\\r\\n        };\\r\\n\\r\\n        fetchAll();\\r\\n\\r\\n    }, [selectedClientId]); //  DEPENDENCIA: Se ejecuta al cambiar el cliente\\r\\n\\r\\n    return { \\r\\n        employees, \\r\\n        objectives, \\r\\n        selectedObjectiveId, \\r\\n        setSelectedObjectiveId, \\r\\n        isLoading \\r\\n    };\\r\\n};\\n\\n\\n\\n"},{"id":"uboamli24","name":"firebase-client.service.ts","path":"apps\\\\web\\\\src\\\\services\\\\firebase-client.service.ts","area":"FRONTEND","content":"import { initializeApp } from \'firebase/app\';\\r\\nimport { getAuth } from \'firebase/auth\';\\r\\nimport { getFunctions, httpsCallable } from \'firebase/functions\';\\r\\nimport { \\r\\n    getFirestore, \\r\\n    collection, \\r\\n    query, \\r\\n    where, \\r\\n    getDocs, \\r\\n    doc,\\r\\n    getDoc,\\r\\n    QueryDocumentSnapshot\\r\\n} from \'firebase/firestore\';\\r\\nimport { IShift } from \'@/common/interfaces/shift.interface\';\\r\\nimport { IAbsencePayload } from \'@/common/interfaces/employee.interface\';\\r\\nimport { IObjective, IServiceContract, IShiftType } from \'@/common/interfaces/client.interface\';\\r\\n\\r\\n// 1. CONFIGURACIN Y CREDENCIALES\\r\\nconst firebaseConfig = {\\r\\n    apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,\\r\\n    authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,\\r\\n    projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,\\r\\n    storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,\\r\\n    messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,\\r\\n    appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,\\r\\n    measurementId: process.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID\\r\\n};\\r\\n\\r\\nconst app = initializeApp(firebaseConfig);\\r\\n\\r\\n// Exportamos las instancias para usarlas en toda la app\\r\\nexport const auth = getAuth(app);\\r\\nexport const functions = getFunctions(app, \'us-central1\');\\r\\nexport const db = getFirestore(app);\\r\\n\\r\\n// Constantes de Colecciones\\r\\nconst SHIFTS_COLLECTION = \'turnos\';\\r\\nconst CONTRACTS_COLLECTION = \'contratos_servicio\'; \\r\\nconst OBJECTIVES_COLLECTION = \'objetivos\';\\r\\n\\r\\n// ------------------------------------------------------------------\\r\\n// 2. FUNCIONES INVOCABLES (CLOUD FUNCTIONS)\\r\\n// ------------------------------------------------------------------\\r\\n\\r\\n// Auth y Usuarios\\r\\n//  FIX: Nos aseguramos que esta l铆nea est茅 presente y exportada\\r\\nexport const callCreateUser = httpsCallable(functions, \'createUser\');\\r\\nexport const callManageSystemUsers = httpsCallable(functions, \'manageSystemUsers\');\\r\\n\\r\\n// Jerarqu铆a y Datos Maestros\\r\\nexport const callManageHierarchy = httpsCallable(functions, \'manageHierarchy\');\\r\\nexport const callManageData = httpsCallable(functions, \'manageData\');\\r\\nexport const callManageEmployees = httpsCallable(functions, \'manageEmployees\');\\r\\n\\r\\n// Operaciones (Turnos y Fichadas)\\r\\nexport const callScheduleShift = httpsCallable(functions, \'scheduleShift\'); \\r\\nexport const callManageShifts = httpsCallable(functions, \'manageShifts\');   \\r\\nexport const callAuditShift = httpsCallable(functions, \'auditShift\');       \\r\\nexport const callManagePatterns = httpsCallable(functions, \'managePatterns\'); \\r\\n\\r\\n// RRHH y Sistema\\r\\nexport const callManageAbsences = httpsCallable(functions, \'manageAbsences\');\\r\\nexport const callCheckSystemHealth = httpsCallable(functions, \'checkSystemHealth\');\\r\\n\\r\\n\\r\\n// ------------------------------------------------------------------\\r\\n// 3. WRAPPERS DE SERVICIOS (L贸gica de Cliente)\\r\\n// ------------------------------------------------------------------\\r\\n\\r\\n// --- GESTIN DE AUSENCIAS ---\\r\\nexport async function createAbsence(params: { action: \'CREATE_ABSENCE\', payload: IAbsencePayload }): Promise<any> {\\r\\n    const { payload } = params;\\r\\n\\r\\n    if (!payload.employeeId || !payload.clientId || !payload.startDate || !payload.endDate || !payload.reason) {\\r\\n        throw new Error(\\"Faltan datos requeridos para la ausencia.\\");\\r\\n    }\\r\\n    \\r\\n    if (!(payload.startDate instanceof Date) || isNaN(payload.startDate.getTime())) {\\r\\n        throw new Error(\\"Fecha de inicio inv谩lida.\\");\\r\\n    }\\r\\n    \\r\\n    // Convertimos fechas a ISO String\\r\\n    const absenceData = {\\r\\n        employeeId: payload.employeeId,\\r\\n        employeeName: payload.employeeName,\\r\\n        clientId: payload.clientId,\\r\\n        type: payload.type,\\r\\n        startDate: payload.startDate.toISOString(),\\r\\n        endDate: payload.endDate.toISOString(),\\r\\n        reason: payload.reason,\\r\\n    };\\r\\n\\r\\n    try {\\r\\n        const result = await callManageAbsences({ \\r\\n            action: params.action, \\r\\n            payload: absenceData \\r\\n        });\\r\\n\\r\\n        if (result.data && (result.data as any).success === false) {\\r\\n             throw new Error((result.data as any).message || \\"Error en backend.\\");\\r\\n        }\\r\\n        return result.data;\\r\\n    } catch (error) {\\r\\n        console.error(\\"[Service Error - createAbsence]:\\", error);\\r\\n        throw error;\\r\\n    }\\r\\n}\\r\\n\\r\\n// --- GESTIN DE PATRONES (AUTOMATIZACIN) ---\\r\\nexport async function createPattern(payload: any) {\\r\\n    // Validamos fechas\\r\\n    const safePayload = { ...payload };\\r\\n    if (payload.validFrom instanceof Date) safePayload.validFrom = payload.validFrom.toISOString();\\r\\n    if (payload.validTo instanceof Date) safePayload.validTo = payload.validTo.toISOString();\\r\\n\\r\\n    return callManagePatterns({ action: \'CREATE_PATTERN\', payload: safePayload });\\r\\n}\\r\\n\\r\\nexport async function getPatterns(contractId: string) {\\r\\n    const res = await callManagePatterns({ action: \'GET_PATTERNS\', payload: { contractId } });\\r\\n    return (res.data as any) || [];\\r\\n}\\r\\n\\r\\nexport async function deletePattern(id: string) {\\r\\n    return callManagePatterns({ action: \'DELETE_PATTERN\', payload: { id } });\\r\\n}\\r\\n\\r\\nexport async function generateVacancies(contractId: string, objectiveId: string, month: number, year: number) {\\r\\n    return callManagePatterns({ \\r\\n        action: \'GENERATE_VACANCIES\', \\r\\n        payload: { contractId, objectiveId, month, year } \\r\\n    });\\r\\n}\\r\\n\\r\\n\\r\\n// ------------------------------------------------------------------\\r\\n// 4. LECTURA DE DATOS (FIRESTORE DIRECTO)\\r\\n// ------------------------------------------------------------------\\r\\n\\r\\nexport async function getEmployeeShifts(employeeId: string): Promise<IShift[]> {\\r\\n    if (!employeeId) return [];\\r\\n    \\r\\n    const shiftsRef = collection(db, SHIFTS_COLLECTION);\\r\\n    const todayStart = new Date();\\r\\n    todayStart.setHours(0, 0, 0, 0);\\r\\n    \\r\\n    const shiftsQuery = query(\\r\\n        shiftsRef, \\r\\n        where(\'employeeId\', \'==\', employeeId), \\r\\n        where(\'startTime\', \'>=\', todayStart)\\r\\n    );\\r\\n    const snapshot = await getDocs(shiftsQuery);\\r\\n\\r\\n    return snapshot.docs.map((doc: QueryDocumentSnapshot) => {\\r\\n        const data = doc.data();\\r\\n        return { ...data, id: doc.id };\\r\\n    }) as unknown as IShift[];\\r\\n}\\r\\n\\r\\nexport async function getObjectiveShifts(objectiveId: string): Promise<IShift[]> {\\r\\n    if (!objectiveId) return [];\\r\\n    \\r\\n    const shiftsRef = collection(db, SHIFTS_COLLECTION);\\r\\n    const shiftsQuery = query(shiftsRef, where(\'objectiveId\', \'==\', objectiveId)); \\r\\n    const snapshot = await getDocs(shiftsQuery);\\r\\n    \\r\\n    return snapshot.docs.map((doc: QueryDocumentSnapshot) => {\\r\\n        const data = doc.data();\\r\\n        return { ...data, id: doc.id };\\r\\n    }) as unknown as IShift[];\\r\\n}\\r\\n\\r\\nexport async function getActiveContract(objectiveId: string): Promise<{ id: string, totalHours: number, name: string, quantity?: number, daysOfWeek?: number[] } | null> {\\r\\n    if (!objectiveId) return null;\\r\\n\\r\\n    try {\\r\\n        const contractsRef = collection(db, CONTRACTS_COLLECTION);\\r\\n        const q = query(\\r\\n            contractsRef, \\r\\n            where(\'objectiveId\', \'==\', objectiveId),\\r\\n            where(\'isActive\', \'==\', true) \\r\\n        );\\r\\n        const snapshot = await getDocs(q);\\r\\n        \\r\\n        if (snapshot.empty) return null;\\r\\n\\r\\n        const docSnapshot = snapshot.docs[0];\\r\\n        const docData = docSnapshot.data();\\r\\n        return {\\r\\n            id: docSnapshot.id,\\r\\n            totalHours: docData.totalHoursPerMonth || 0,\\r\\n            name: docData.name || \'Contrato\',\\r\\n            quantity: docData.quantity,\\r\\n            daysOfWeek: docData.daysOfWeek\\r\\n        };\\r\\n    } catch (e) {\\r\\n        console.error(\\"Error fetching contract:\\", e);\\r\\n        return null;\\r\\n    }\\r\\n}\\r\\n\\r\\n\\r\\n// ------------------------------------------------------------------\\r\\n// 5. TORRE DE CONTROL (DASHBOARD OBJETIVO)\\r\\n// ------------------------------------------------------------------\\r\\n\\r\\nexport async function getObjectiveControlData(objectiveId: string) {\\r\\n    if (!objectiveId) throw new Error(\\"ID de objetivo requerido\\");\\r\\n\\r\\n    try {\\r\\n        const objRef = doc(db, OBJECTIVES_COLLECTION, objectiveId);\\r\\n        const objSnap = await getDoc(objRef);\\r\\n\\r\\n        if (!objSnap.exists()) throw new Error(\\"El objetivo no existe.\\");\\r\\n        const objective = { id: objSnap.id, ...objSnap.data() } as IObjective;\\r\\n\\r\\n        const today = new Date();\\r\\n        today.setHours(0,0,0,0);\\r\\n\\r\\n        const shiftsRef = collection(db, SHIFTS_COLLECTION);\\r\\n        const q = query(\\r\\n            shiftsRef,\\r\\n            where(\'objectiveId\', \'==\', objectiveId),\\r\\n            where(\'startTime\', \'>=\', today)\\r\\n        );\\r\\n\\r\\n        const shiftSnaps = await getDocs(q);\\r\\n        const shifts = shiftSnaps.docs.map(d => ({ id: d.id, ...d.data() })) as unknown as IShift[];\\r\\n\\r\\n        shifts.sort((a, b) => {\\r\\n            const timeA = (a.startTime as any).toDate ? (a.startTime as any).toDate() : new Date(a.startTime as any);\\r\\n            const timeB = (b.startTime as any).toDate ? (b.startTime as any).toDate() : new Date(b.startTime as any);\\r\\n            return timeA.getTime() - timeB.getTime();\\r\\n        });\\r\\n\\r\\n        return { objective, shifts };\\r\\n\\r\\n    } catch (error) {\\r\\n        console.error(\\"Error fetching control data:\\", error);\\r\\n        throw error;\\r\\n    }\\r\\n}\\r\\n\\r\\n\\r\\n// ------------------------------------------------------------------\\r\\n// 6. ABM DE JERARQUA Y TURNOS\\r\\n// ------------------------------------------------------------------\\r\\n\\r\\nexport async function updateObjective(id: string, data: Partial<IObjective>) {\\r\\n    return await callManageHierarchy({\\r\\n        action: \'UPDATE_OBJECTIVE\',\\r\\n        payload: { id, data }\\r\\n    });\\r\\n}\\r\\n\\r\\nexport async function getObjectiveContracts(objectiveId: string): Promise<IServiceContract[]> {\\r\\n    try {\\r\\n        const q = query(collection(db, CONTRACTS_COLLECTION), where(\'objectiveId\', \'==\', objectiveId));\\r\\n        const snapshot = await getDocs(q);\\r\\n        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) as unknown as IServiceContract[];\\r\\n    } catch (error) {\\r\\n        console.error(\\"Error fetching contracts:\\", error);\\r\\n        return [];\\r\\n    }\\r\\n}\\r\\n\\r\\nexport async function createServiceForObjective(payload: { objectiveId: string, name: string, totalHours: number, quantity?: number, daysOfWeek?: number[] }) {\\r\\n    return await callManageHierarchy({\\r\\n        action: \'CREATE_CONTRACT\',\\r\\n        payload: {\\r\\n            objectiveId: payload.objectiveId,\\r\\n            name: payload.name,\\r\\n            totalHoursPerMonth: payload.totalHours,\\r\\n            quantity: payload.quantity || 1,\\r\\n            daysOfWeek: payload.daysOfWeek || [],\\r\\n            startDate: new Date().toISOString(),\\r\\n            isActive: true\\r\\n        }\\r\\n    });\\r\\n}\\r\\n\\r\\nexport async function updateServiceContract(id: string, data: any) {\\r\\n    return await callManageHierarchy({ action: \'UPDATE_CONTRACT\', payload: { id, data } });\\r\\n}\\r\\n\\r\\nexport async function deleteServiceContract(id: string) {\\r\\n    return await callManageHierarchy({ action: \'DELETE_CONTRACT\', payload: { id } });\\r\\n}\\r\\n\\r\\nexport async function getShiftTypes(contractId: string): Promise<IShiftType[]> {\\r\\n    try {\\r\\n        const res = await callManageHierarchy({ action: \'GET_SHIFT_TYPES\', payload: { contractId } });\\r\\n        return (res.data as any).data || [];\\r\\n    } catch (error) { return []; }\\r\\n}\\r\\n\\r\\nexport async function createShiftType(payload: Omit<IShiftType, \'id\'>) {\\r\\n    return await callManageHierarchy({ action: \'CREATE_SHIFT_TYPE\', payload });\\r\\n}\\r\\n\\r\\nexport async function updateShiftType(id: string, data: Partial<IShiftType>) {\\r\\n    return await callManageHierarchy({ action: \'UPDATE_SHIFT_TYPE\', payload: { id, data } });\\r\\n}\\r\\n\\r\\nexport async function deleteShiftType(id: string) {\\r\\n    return await callManageHierarchy({ action: \'DELETE_SHIFT_TYPE\', payload: { id } });\\r\\n}\\r\\n\\r\\n// --- CRUD TURNOS ---\\r\\nexport async function updateShift(id: string, data: any) {\\r\\n    const payloadData = { ...data };\\r\\n    if (payloadData.startTime instanceof Date) payloadData.startTime = payloadData.startTime.toISOString();\\r\\n    if (payloadData.endTime instanceof Date) payloadData.endTime = payloadData.endTime.toISOString();\\r\\n\\r\\n    return await callManageShifts({ action: \'UPDATE_SHIFT\', payload: { id, data: payloadData } });\\r\\n}\\r\\n\\r\\nexport async function deleteShift(id: string) {\\r\\n    return await callManageShifts({ action: \'DELETE_SHIFT\', payload: { id } });\\r\\n}\\n\\n\\n\\n"},{"id":"1fc2rg8dj","name":"globals.css","path":"apps\\\\web\\\\src\\\\styles\\\\globals.css","area":"FRONTEND","content":"@tailwind base;\\n@tailwind components;\\n@tailwind utilities;\\n\\nhtml, body, #__next {\\n  height: 100%;\\n  margin: 0;\\n  padding: 0;\\n  background-color: #f8fafc;\\n}\\n\\n/* Fix para FullCalendar en Next.js 16 */\\n.fc {\\n  --fc-border-color: #e2e8f0;\\n  --fc-button-bg-color: #4f46e5;\\n  --fc-button-border-color: #4f46e5;\\n  --fc-button-hover-bg-color: #4338ca;\\n  font-family: inherit;\\n}\\n\\n.fc .fc-toolbar-title {\\n  font-size: 1.25rem !important;\\n  font-weight: 700 !important;\\n  color: #1e293b;\\n}"},{"id":"blfbobcqc","name":"geocoding.ts","path":"apps\\\\web\\\\src\\\\utils\\\\geocoding.ts","area":"FRONTEND","content":"/**\\r\\n * Utilidad para geocodificaci贸n usando Google Maps Platform.\\r\\n */\\r\\nexport async function getCoordinatesFromAddress(address: string): Promise<{ lat: number, lng: number } | null> {\\r\\n    const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_KEY;\\r\\n\\r\\n    // 1. Diagn贸stico de la Clave\\r\\n    if (!apiKey) {\\r\\n        console.error(\\" ERROR CRTICO: La variable NEXT_PUBLIC_GOOGLE_MAPS_KEY est谩 vac铆a o undefined.\\");\\r\\n        console.info(\\" RECUERDA: Debes crear el archivo .env.local en apps/web/ y reiniciar el servidor (npm run dev).\\");\\r\\n        return null;\\r\\n    }\\r\\n\\r\\n    try {\\r\\n        console.log(` Consultando Google Maps para: \\"${address}\\"`);\\r\\n        \\r\\n        const query = encodeURIComponent(address);\\r\\n        const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${query}&key=${apiKey}`;\\r\\n        \\r\\n        const response = await fetch(url);\\r\\n        const data = await response.json();\\r\\n\\r\\n        // 2. Diagn贸stico de la Respuesta de Google\\r\\n        if (data.status !== \'OK\') {\\r\\n            console.error(\\" Google Maps API Error:\\", data.status);\\r\\n            console.error(\\"Mensaje de error:\\", data.error_message); // Muy 煤til para ver si falta habilitar la API\\r\\n            \\r\\n            if (data.status === \'REQUEST_DENIED\') {\\r\\n                console.warn(\\"锔 Revisa en Google Cloud Console que la \'Geocoding API\' est茅 habilitada y que la API Key sea correcta.\\");\\r\\n            }\\r\\n            return null;\\r\\n        }\\r\\n\\r\\n        if (data.results.length > 0) {\\r\\n            const location = data.results[0].geometry.location;\\r\\n            console.log(\\" Coordenadas encontradas:\\", location);\\r\\n            return {\\r\\n                lat: location.lat,\\r\\n                lng: location.lng\\r\\n            };\\r\\n        } else {\\r\\n            console.warn(\\"锔 Google no encontr贸 resultados para esa direcci贸n.\\");\\r\\n            return null;\\r\\n        }\\r\\n\\r\\n    } catch (error) {\\r\\n        console.error(\\" Error de red o fetch:\\", error);\\r\\n        return null;\\r\\n    }\\r\\n}\\n\\n\\n\\n"},{"id":"6jwvqfdz7","name":"geolocation.ts","path":"apps\\\\web\\\\src\\\\utils\\\\geolocation.ts","area":"FRONTEND","content":"export interface IGeoCoordinates {\\r\\n    latitude: number;\\r\\n    longitude: number;\\r\\n    accuracy: number;\\r\\n}\\r\\n\\r\\n/**\\r\\n * Obtiene la posici贸n actual con promesa y manejo de errores en Espa帽ol.\\r\\n */\\r\\nexport function getCurrentPosition(timeoutMs: number = 10000): Promise<IGeoCoordinates> {\\r\\n    return new Promise((resolve, reject) => {\\r\\n        if (!navigator.geolocation) {\\r\\n            reject(new Error(\'Tu navegador no soporta geolocalizaci贸n.\'));\\r\\n            return;\\r\\n        }\\r\\n\\r\\n        const options: PositionOptions = {\\r\\n            enableHighAccuracy: true, // Intentar usar GPS real\\r\\n            timeout: timeoutMs,\\r\\n            maximumAge: 0 // No usar cach茅\\r\\n        };\\r\\n\\r\\n        navigator.geolocation.getCurrentPosition(\\r\\n            (position) => {\\r\\n                resolve({\\r\\n                    latitude: position.coords.latitude,\\r\\n                    longitude: position.coords.longitude,\\r\\n                    accuracy: position.coords.accuracy\\r\\n                });\\r\\n            },\\r\\n            (error) => {\\r\\n                let msg = \'Error desconocido de ubicaci贸n.\';\\r\\n                switch (error.code) {\\r\\n                    case error.PERMISSION_DENIED:\\r\\n                        msg = \'Permiso de ubicaci贸n denegado. Habil铆talo en tu navegador.\';\\r\\n                        break;\\r\\n                    case error.POSITION_UNAVAILABLE:\\r\\n                        msg = \'Se帽al GPS no disponible.\';\\r\\n                        break;\\r\\n                    case error.TIMEOUT:\\r\\n                        msg = \'Se agot贸 el tiempo buscando se帽al GPS.\';\\r\\n                        break;\\r\\n                }\\r\\n                reject(new Error(msg));\\r\\n            },\\r\\n            options\\r\\n        );\\r\\n    });\\r\\n}\\n\\n\\n\\n"},{"id":"dolmgz3xp","name":"GeneralTab.tsx","path":"apps\\\\web2\\\\src\\\\components\\\\admin\\\\config\\\\GeneralTab.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\nimport { \\n    Save, Building, FileText, Mail, Phone, AlertTriangle, Trash2, \\n    ShieldAlert, RefreshCw, Moon, Sun, Monitor, Zap, Hexagon \\n} from \'lucide-react\';\\nimport { functions } from \'@/lib/firebase\';\\nimport { httpsCallable } from \'firebase/functions\';\\nimport { toast } from \'sonner\';\\n\\nexport default function GeneralTab() {\\n    const [cleaningTarget, setCleaningTarget] = useState<string | null>(null);\\n    const [company, setCompany] = useState({ name: \'CronoApp Security\', cuit: \'\', address: \'\', website: \'\', email: \'\', phone: \'\' });\\n    \\n    // TEMA SELECCIONADO\\n    const [theme, setTheme] = useState(\'system\');\\n\\n    useEffect(() => {\\n        // Cargar tema\\n        const savedTheme = localStorage.getItem(\'theme\') || \'system\';\\n        applyTheme(savedTheme);\\n    }, []);\\n\\n    const applyTheme = (newTheme: string) => {\\n        setTheme(newTheme);\\n        localStorage.setItem(\'theme\', newTheme);\\n        \\n        // Logica de clases en <html>\\n        const root = document.documentElement;\\n        root.classList.remove(\'dark\', \'theme-contrast\', \'theme-blue\');\\n        \\n        if (newTheme === \'dark\') root.classList.add(\'dark\');\\n        if (newTheme === \'contrast\') root.classList.add(\'theme-contrast\'); // Clase para CSS global\\n        if (newTheme === \'blue\') root.classList.add(\'theme-blue\');         // Clase para CSS global\\n        \\n        // \'light\' es el default sin clases extra\\n        \\n        if (newTheme === \'system\') {\\n            if (window.matchMedia(\'(prefers-color-scheme: dark)\').matches) root.classList.add(\'dark\');\\n        }\\n    };\\n\\n    const handleChange = (e: any) => setCompany({...company, [e.target.name]: e.target.value});\\n\\n    const handleSaveCompany = () => {\\n        // Aqu铆 podr铆as guardar en Firebase, por ahora simulamos\\n        toast.success(\\"Datos de organizaci贸n guardados\\");\\n    };\\n\\n    const handleSystemClean = async (target: \'AUDIT\' | \'SHIFTS\') => {\\n        toast(\\"锔 隆PELIGRO! 驴Borrar datos?\\", {\\n            description: \\"Esta acci贸n no se puede deshacer.\\",\\n            action: {\\n                label: \'S, BORRAR TODO\',\\n                onClick: async () => {\\n                    setCleaningTarget(target);\\n                    try {\\n                        const cleanFn = httpsCallable(functions, \'limpiarBaseDeDatos\');\\n                        await cleanFn({ target });\\n                        toast.success(\\"Limpieza completada con 茅xito\\");\\n                    } catch (error: any) { \\n                        toast.error(\\"Error: \\" + error.message); \\n                    } finally { \\n                        setCleaningTarget(null); \\n                    }\\n                }\\n            },\\n            cancel: { label: \'Cancelar\', onClick: () => {} },\\n        });\\n    };\\n\\n    return (\\n        <div className=\\"space-y-8 animate-in fade-in pb-10\\">\\n            \\n            {/* 1. SELECTOR DE TEMAS (5 OPCIONES REALES) */}\\n            <div className=\\"bg-white dark:bg-slate-800 p-8 rounded-[2rem] border border-slate-200 dark:border-slate-700 shadow-xl\\">\\n                <h3 className=\\"text-xl font-black text-slate-800 dark:text-white mb-6 flex items-center gap-2\\">\\n                    <Monitor className=\\"text-indigo-600\\"/> TEMAS Y APARIENCIA\\n                </h3>\\n                \\n                <div className=\\"grid grid-cols-2 md:grid-cols-5 gap-4\\">\\n                    {/* LIGHT */}\\n                    <button onClick={() => applyTheme(\'light\')} className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-3 transition-all hover:scale-105 ${theme === \'light\' ? \'border-indigo-600 bg-indigo-50 text-indigo-700\' : \'border-slate-100 hover:border-slate-300\'}`}>\\n                        <div className=\\"w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center shadow-sm\\"><Sun size={20} className=\\"text-slate-600\\"/></div>\\n                        <span className=\\"text-xs font-black uppercase text-slate-600\\">Claro</span>\\n                    </button>\\n\\n                    {/* DARK */}\\n                    <button onClick={() => applyTheme(\'dark\')} className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-3 transition-all hover:scale-105 ${theme === \'dark\' ? \'border-indigo-500 bg-slate-900 text-white\' : \'border-slate-100 hover:border-slate-300\'}`}>\\n                        <div className=\\"w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center shadow-sm\\"><Moon size={20} className=\\"text-white\\"/></div>\\n                        <span className=\\"text-xs font-black uppercase text-slate-600 dark:text-slate-400\\">Oscuro</span>\\n                    </button>\\n\\n                    {/* CONTRASTE */}\\n                    <button onClick={() => applyTheme(\'contrast\')} className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-3 transition-all hover:scale-105 ${theme === \'contrast\' ? \'border-black bg-black text-yellow-400\' : \'border-slate-100 hover:border-slate-300\'}`}>\\n                        <div className=\\"w-10 h-10 rounded-full bg-black border border-white flex items-center justify-center shadow-sm\\"><Zap size={20} className=\\"text-yellow-400\\"/></div>\\n                        <span className=\\"text-xs font-black uppercase text-slate-600\\">Contraste</span>\\n                    </button>\\n\\n                    {/* AZUL / NAVY */}\\n                    <button onClick={() => applyTheme(\'blue\')} className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-3 transition-all hover:scale-105 ${theme === \'blue\' ? \'border-blue-600 bg-blue-50 text-blue-800\' : \'border-slate-100 hover:border-slate-300\'}`}>\\n                        <div className=\\"w-10 h-10 rounded-full bg-blue-900 flex items-center justify-center shadow-sm\\"><Hexagon size={20} className=\\"text-blue-200\\"/></div>\\n                        <span className=\\"text-xs font-black uppercase text-slate-600\\">Azul Pro</span>\\n                    </button>\\n\\n                    {/* SISTEMA */}\\n                    <button onClick={() => applyTheme(\'system\')} className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-3 transition-all hover:scale-105 ${theme === \'system\' ? \'border-slate-400 bg-slate-100 text-slate-800\' : \'border-slate-100 hover:border-slate-300\'}`}>\\n                        <div className=\\"w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center shadow-sm\\"><Monitor size={20} className=\\"text-slate-600\\"/></div>\\n                        <span className=\\"text-xs font-black uppercase text-slate-600\\">Sistema</span>\\n                    </button>\\n                </div>\\n                <p className=\\"mt-4 text-xs text-slate-400 font-medium\\">Nota: El modo \\"Claro\\" ahora usa tipograf铆a de alto contraste (Gris oscuro/Negro) para mejor legibilidad.</p>\\n            </div>\\n\\n            {/* 2. DATOS DE LA EMPRESA */}\\n            <div className=\\"bg-white dark:bg-slate-800 p-8 rounded-[2rem] border border-slate-200 dark:border-slate-700 shadow-xl relative overflow-hidden\\">\\n                <h3 className=\\"text-xl font-black text-slate-800 dark:text-white mb-8 flex items-center gap-3 relative z-10\\">\\n                    <div className=\\"p-3 bg-indigo-50 dark:bg-indigo-900/50 rounded-xl text-indigo-600 dark:text-indigo-400\\"><Building size={24}/></div>\\n                    DATOS DE LA ORGANIZACIN\\n                </h3>\\n                <div className=\\"grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10\\">\\n                    <div><label className=\\"text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 block\\">Raz贸n Social</label><input name=\\"name\\" value={company.name} onChange={handleChange} className=\\"w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-indigo-500 rounded-xl font-bold text-slate-900 dark:text-white outline-none transition-all\\"/></div>\\n                    <div><label className=\\"text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 block\\">CUIT</label><input name=\\"cuit\\" value={company.cuit} onChange={handleChange} className=\\"w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-indigo-500 rounded-xl font-mono font-medium text-slate-900 dark:text-white outline-none transition-all\\"/></div>\\n                    <div className=\\"md:col-span-2\\"><label className=\\"text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 block\\">Direcci贸n</label><div className=\\"relative\\"><FileText size={20} className=\\"absolute left-4 top-4 text-slate-400\\"/><input name=\\"address\\" value={company.address} onChange={handleChange} className=\\"w-full pl-12 p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-indigo-500 rounded-xl font-medium text-slate-900 dark:text-white outline-none transition-all\\"/></div></div>\\n                </div>\\n                <div className=\\"mt-8 pt-6 border-t border-slate-100 dark:border-slate-700 flex justify-end\\">\\n                    <button onClick={handleSaveCompany} className=\\"bg-slate-900 hover:bg-slate-800 dark:bg-white dark:text-slate-900 text-white px-8 py-4 rounded-xl font-black text-xs uppercase flex items-center gap-2 shadow-xl hover:-translate-y-1 transition-all\\"><Save size={18}/> GUARDAR DATOS</button>\\n                </div>\\n            </div>\\n\\n            {/* 3. ZONA DE MANTENIMIENTO */}\\n            <div className=\\"bg-rose-50 dark:bg-rose-950/20 p-8 rounded-[2rem] border-2 border-rose-100 dark:border-rose-900/50 relative overflow-hidden\\">\\n                <div className=\\"absolute top-0 right-0 p-4 opacity-10\\"><ShieldAlert size={120} className=\\"text-rose-600\\"/></div>\\n                <h3 className=\\"text-xl font-black text-rose-700 dark:text-rose-400 mb-2 flex items-center gap-3\\"><AlertTriangle size={24}/> ZONA DE MANTENIMIENTO</h3>\\n                <p className=\\"text-sm text-rose-600/80 mb-6 font-medium\\">Acciones destructivas e irreversibles para limpiar la base de datos.</p>\\n                <div className=\\"grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10\\">\\n                    <button onClick={() => handleSystemClean(\'AUDIT\')} disabled={!!cleaningTarget} className=\\"p-4 bg-white dark:bg-slate-900 border border-rose-200 rounded-xl flex items-center justify-between hover:border-rose-400 group transition-all\\">\\n                        <span className=\\"font-bold text-rose-700 text-sm\\">Borrar Historial</span>\\n                        {cleaningTarget === \'AUDIT\' ? <RefreshCw className=\\"animate-spin text-rose-500\\"/> : <Trash2 className=\\"text-rose-300 group-hover:text-rose-600\\"/>}\\n                    </button>\\n                    <button onClick={() => handleSystemClean(\'SHIFTS\')} disabled={!!cleaningTarget} className=\\"p-4 bg-white dark:bg-slate-900 border border-rose-200 rounded-xl flex items-center justify-between hover:border-rose-400 group transition-all\\">\\n                        <span className=\\"font-bold text-rose-700 text-sm\\">Borrar Turnos</span>\\n                        {cleaningTarget === \'SHIFTS\' ? <RefreshCw className=\\"animate-spin text-rose-500\\"/> : <Trash2 className=\\"text-rose-300 group-hover:text-rose-600\\"/>}\\n                    </button>\\n                </div>\\n            </div>\\n        </div>\\n    );\\n}"},{"id":"ett9iphm4","name":"RolesTab.tsx","path":"apps\\\\web2\\\\src\\\\components\\\\admin\\\\config\\\\RolesTab.tsx","area":"FRONTEND","content":"import React, { useEffect, useState } from \'react\';\\nimport { Plus, Edit3, Trash2, Save, Shield, Check, X } from \'lucide-react\';\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, getDocs, doc, setDoc, deleteDoc, updateDoc } from \'firebase/firestore\';\\nimport { SYSTEM_MODULES, PERMISSION_ACTIONS } from \'@/config/modules\';\\n\\ninterface IRole { id: string; name: string; permissions: Record<string, string[]>; }\\n\\nexport default function RolesTab() {\\n    const [roles, setRoles] = useState<IRole[]>([]);\\n    const [isModalOpen, setIsModalOpen] = useState(false);\\n    const [roleName, setRoleName] = useState(\'\');\\n    const [editId, setEditId] = useState<string | null>(null);\\n    const [matrix, setMatrix] = useState<Record<string, string[]>>({});\\n\\n    useEffect(() => { loadRoles(); }, []);\\n\\n    const loadRoles = async () => {\\n        const snap = await getDocs(collection(db, \'roles\'));\\n        setRoles(snap.docs.map(d => ({ id: d.id, ...d.data() })) as IRole[]);\\n    };\\n\\n    const handleOpenCreate = () => { setEditId(null); setRoleName(\'\'); setMatrix({}); setIsModalOpen(true); };\\n    const handleOpenEdit = (role: IRole) => { setEditId(role.id); setRoleName(role.name); setMatrix(role.permissions || {}); setIsModalOpen(true); };\\n\\n    const togglePermission = (moduleKey: string, actionKey: string) => {\\n        setMatrix(prev => {\\n            const currentActions = prev[moduleKey] || [];\\n            let newActions;\\n            if (currentActions.includes(actionKey)) {\\n                newActions = currentActions.filter(a => a !== actionKey);\\n                if (actionKey === \'read\') newActions = [];\\n            } else {\\n                newActions = [...currentActions, actionKey];\\n                if (actionKey !== \'read\' && !currentActions.includes(\'read\')) newActions.push(\'read\');\\n            }\\n            return { ...prev, [moduleKey]: newActions };\\n        });\\n    };\\n\\n    const handleSave = async (e: React.FormEvent) => {\\n        e.preventDefault();\\n        if (!roleName.trim()) return alert(\\"Nombre requerido\\");\\n        const roleData = { name: roleName, permissions: matrix };\\n        try {\\n            if (editId) await updateDoc(doc(db, \'roles\', editId), roleData);\\n            else await setDoc(doc(db, \'roles\', roleName.toUpperCase().replace(/\\\\s+/g, \'_\')), roleData);\\n            setIsModalOpen(false); loadRoles();\\n        } catch (e) { alert(\\"Error guardando\\"); }\\n    };\\n\\n    const handleDelete = async (id: string) => {\\n        if (confirm(\\"驴Borrar rol?\\")) { await deleteDoc(doc(db, \'roles\', id)); loadRoles(); }\\n    };\\n\\n    return (\\n        <div className=\\"animate-in fade-in space-y-6\\">\\n            <div className=\\"flex justify-end\\"><button onClick={handleOpenCreate} className=\\"bg-slate-900 dark:bg-white dark:text-slate-900 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:scale-105 transition-transform shadow-lg\\"><Shield size={18}/> CREAR ROL</button></div>\\n            <div className=\\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\\">\\n                {roles.map(role => (\\n                    <div key={role.id} className=\\"bg-white dark:bg-slate-800 p-6 rounded-2xl border dark:border-slate-700 shadow-sm hover:shadow-md transition-all group relative\\">\\n                        <div className=\\"flex justify-between items-start mb-4\\">\\n                            <h3 className=\\"font-black text-xl text-slate-800 dark:text-white uppercase\\">{role.name}</h3>\\n                            <div className=\\"flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity absolute top-4 right-4 bg-white dark:bg-slate-800 p-1 rounded-lg shadow-sm border dark:border-slate-600\\">\\n                                <button onClick={()=>handleOpenEdit(role)} className=\\"p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg text-indigo-500\\"><Edit3 size={16}/></button>\\n                                <button onClick={()=>handleDelete(role.id)} className=\\"p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg text-rose-500\\"><Trash2 size={16}/></button>\\n                            </div>\\n                        </div>\\n                        <div className=\\"space-y-2\\">\\n                            {Object.entries(role.permissions || {}).map(([modKey, actions]) => {\\n                                if (actions.length === 0) return null;\\n                                const modLabel = SYSTEM_MODULES.find(m => m.key === modKey)?.label || modKey;\\n                                return (\\n                                    <div key={modKey} className=\\"text-xs bg-slate-50 dark:bg-slate-900 p-2 rounded-lg flex justify-between items-center border dark:border-slate-700\\">\\n                                        <span className=\\"font-bold text-slate-600 dark:text-slate-400 truncate w-1/2\\">{modLabel}</span>\\n                                        <div className=\\"flex gap-1\\">{actions.map(a => <span key={a} className={`w-5 h-5 flex items-center justify-center rounded text-[9px] font-black uppercase ${a===\'read\'?\'bg-blue-100 text-blue-700\':a===\'create\'?\'bg-emerald-100 text-emerald-700\':a===\'update\'?\'bg-amber-100 text-amber-700\':\'bg-rose-100 text-rose-700\'}`}>{a.charAt(0)}</span>)}</div>\\n                                    </div>\\n                                )\\n                            })}\\n                        </div>\\n                    </div>\\n                ))}\\n            </div>\\n            {isModalOpen && (\\n                <div className=\\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md\\">\\n                    <div className=\\"bg-white dark:bg-slate-800 rounded-3xl w-full max-w-4xl p-8 flex flex-col max-h-[90vh] shadow-2xl animate-in zoom-in-95 border dark:border-slate-700\\">\\n                        <div className=\\"flex justify-between items-center mb-6\\">\\n                            <div className=\\"w-full\\"><label className=\\"text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1\\">Nombre del Rol</label><input autoFocus type=\\"text\\" placeholder=\\"Ej: Auditor\\" className=\\"w-1/2 text-2xl font-black bg-transparent border-b-2 border-slate-200 focus:border-indigo-600 outline-none dark:text-white pb-2 dark:border-slate-700\\" value={roleName} onChange={e => setRoleName(e.target.value)} /></div>\\n                            <button onClick={() => setIsModalOpen(false)} className=\\"p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full text-slate-400\\"><X/></button>\\n                        </div>\\n                        <div className=\\"flex-1 overflow-auto border rounded-xl dark:border-slate-700 custom-scrollbar\\">\\n                            <table className=\\"w-full text-left text-sm\\">\\n                                <thead className=\\"bg-slate-100 dark:bg-slate-900 sticky top-0 z-10\\"><tr><th className=\\"p-4 font-black text-slate-500 uppercase text-xs\\">M贸dulo</th>{PERMISSION_ACTIONS.map(act => <th key={act.key} className=\\"p-4 text-center font-black text-slate-500 uppercase text-xs w-24\\">{act.label}</th>)}</tr></thead>\\n                                <tbody className=\\"divide-y dark:divide-slate-700\\">{SYSTEM_MODULES.map(mod => (<tr key={mod.key} className=\\"hover:bg-slate-50 dark:hover:bg-slate-700/30\\"><td className=\\"p-4 font-bold dark:text-white\\">{mod.label}</td>{PERMISSION_ACTIONS.map(act => { const isActive = matrix[mod.key]?.includes(act.key); return <td key={act.key} className=\\"p-4 text-center\\"><button onClick={() => togglePermission(mod.key, act.key)} className={`w-8 h-8 rounded-lg flex items-center justify-center transition-all border-2 mx-auto ${isActive ? \'bg-indigo-600 border-indigo-600 text-white shadow-md scale-110\' : \'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-600 text-slate-300 hover:border-indigo-300\'}`}>{isActive && <Check size={16} strokeWidth={4}/>}</button></td>; })}</tr>))}</tbody>\\n                            </table>\\n                        </div>\\n                        <div className=\\"mt-6 flex justify-end gap-3 pt-4 border-t dark:border-slate-700\\"><button onClick={() => setIsModalOpen(false)} className=\\"px-6 py-3 font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl\\">Cancelar</button><button onClick={handleSave} className=\\"px-8 py-3 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 shadow-xl flex items-center gap-2 uppercase text-xs\\"><Save size={18}/> Guardar Rol</button></div>\\n                    </div>\\n                </div>\\n            )}\\n        </div>\\n    );\\n}"},{"id":"tihtul6yb","name":"UsersTab.tsx","path":"apps\\\\web2\\\\src\\\\components\\\\admin\\\\config\\\\UsersTab.tsx","area":"FRONTEND","content":"import React, { useEffect, useState } from \'react\';\\nimport { Search, Plus, CheckCircle, XCircle, Shield, RefreshCw, X, Edit3, Trash2 } from \'lucide-react\';\\nimport { db, functions } from \'@/lib/firebase\';\\nimport { collection, getDocs, query, orderBy, doc, updateDoc, deleteDoc } from \'firebase/firestore\';\\nimport { httpsCallable } from \'firebase/functions\';\\nimport { toast } from \'sonner\'; // <--- IMPORTAMOS SONNER\\n\\nexport default function UsersTab() {\\n    const [users, setUsers] = useState<any[]>([]);\\n    const [rolesList, setRolesList] = useState<any[]>([]);\\n    const [loading, setLoading] = useState(false);\\n    const [isModalOpen, setIsModalOpen] = useState(false);\\n    const [isProcessing, setIsProcessing] = useState(false);\\n    const [editMode, setEditMode] = useState(false);\\n    \\n    const initialForm = { id: \'\', firstName: \'\', lastName: \'\', email: \'\', password: \'\', role: \'\' };\\n    const [formData, setFormData] = useState(initialForm);\\n\\n    useEffect(() => { loadData(); }, []);\\n\\n    const loadData = async () => {\\n        setLoading(true);\\n        try {\\n            const [uSnap, rSnap] = await Promise.all([\\n                getDocs(query(collection(db, \'system_users\'), orderBy(\'lastName\'))),\\n                getDocs(collection(db, \'roles\'))\\n            ]);\\n            setUsers(uSnap.docs.map(d => ({ id: d.id, ...d.data() })));\\n            setRolesList(rSnap.docs.map(d => ({ id: d.id, ...d.data() })));\\n        } catch (e) { \\n            console.error(e); \\n            toast.error(\\"Error de conexi贸n al cargar usuarios\\");\\n        } finally { setLoading(false); }\\n    };\\n\\n    const handleOpenCreate = () => {\\n        setEditMode(false);\\n        setFormData(initialForm);\\n        setIsModalOpen(true);\\n    };\\n\\n    const handleOpenEdit = (user: any) => {\\n        setEditMode(true);\\n        setFormData({\\n            id: user.id, firstName: user.firstName, lastName: user.lastName, email: user.email, password: \'\', role: user.role\\n        });\\n        setIsModalOpen(true);\\n    };\\n\\n    const handleSubmit = async (e: React.FormEvent) => {\\n        e.preventDefault();\\n        setIsProcessing(true);\\n        \\n        // Promesa para Sonner (Feedback visual incre铆ble)\\n        const promise = new Promise(async (resolve, reject) => {\\n            try {\\n                if (editMode) {\\n                    const userRef = doc(db, \'system_users\', formData.id);\\n                    await updateDoc(userRef, { firstName: formData.firstName, lastName: formData.lastName, role: formData.role });\\n                    resolve(\\"Usuario actualizado correctamente\\");\\n                } else {\\n                    const createFn = httpsCallable(functions, \'crearUsuarioSistema\');\\n                    await createFn(formData);\\n                    resolve(\\"Usuario creado y acceso concedido\\");\\n                }\\n                setIsModalOpen(false);\\n                loadData();\\n            } catch (error: any) {\\n                reject(error.message || \\"Error desconocido\\");\\n            } finally {\\n                setIsProcessing(false);\\n            }\\n        });\\n\\n        toast.promise(promise, {\\n            loading: editMode ? \'Actualizando datos...\' : \'Creando credenciales...\',\\n            success: (data) => `${data}`,\\n            error: (err) => `Error: ${err}`\\n        });\\n    };\\n\\n    const handleDelete = async (userId: string) => {\\n        toast(\\"驴Est谩s seguro?\\", {\\n            action: {\\n                label: \'Eliminar\',\\n                onClick: async () => {\\n                    try {\\n                        await deleteDoc(doc(db, \'system_users\', userId));\\n                        toast.success(\\"Usuario eliminado\\");\\n                        loadData();\\n                    } catch(e) { toast.error(\\"No se pudo eliminar\\"); }\\n                }\\n            },\\n            cancel: { label: \'Cancelar\', onClick: () => {} }\\n        });\\n    };\\n\\n    return (\\n        <div className=\\"space-y-6 animate-in fade-in\\">\\n            <div className=\\"flex justify-between items-center bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm\\">\\n                <div className=\\"flex items-center gap-4\\">\\n                    <div className=\\"p-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-xl text-indigo-600 dark:text-indigo-400\\"><Shield size={24}/></div>\\n                    <div>\\n                        <h3 className=\\"font-black text-lg text-slate-800 dark:text-white uppercase\\">Usuarios de Plataforma</h3>\\n                        <p className=\\"text-sm text-slate-500 dark:text-slate-400 font-medium\\">Administra qui茅n puede entrar al sistema.</p>\\n                    </div>\\n                </div>\\n                <button onClick={handleOpenCreate} className=\\"bg-slate-900 dark:bg-white dark:text-slate-900 text-white px-6 py-3 rounded-xl font-bold text-xs shadow-lg hover:scale-105 transition-transform flex items-center gap-2\\"><Plus size={18}/> NUEVO USUARIO</button>\\n            </div>\\n\\n            <div className=\\"bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden\\">\\n                <table className=\\"w-full text-left text-sm\\">\\n                    <thead className=\\"bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700\\">\\n                        <tr>\\n                            <th className=\\"p-5 font-black text-slate-800 dark:text-slate-200 text-xs uppercase tracking-wider\\">Usuario</th>\\n                            <th className=\\"p-5 font-black text-slate-800 dark:text-slate-200 text-xs uppercase tracking-wider\\">Rol</th>\\n                            <th className=\\"p-5 font-black text-slate-800 dark:text-slate-200 text-xs uppercase tracking-wider text-center\\">Estado</th>\\n                            <th className=\\"p-5 font-black text-slate-800 dark:text-slate-200 text-xs uppercase tracking-wider text-right\\">Acciones</th>\\n                        </tr>\\n                    </thead>\\n                    <tbody className=\\"divide-y divide-slate-100 dark:divide-slate-700\\">\\n                        {users.map(u => (\\n                            <tr key={u.id} className=\\"hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors\\">\\n                                <td className=\\"p-5\\">\\n                                    <div className=\\"flex items-center gap-3\\">\\n                                        <div className=\\"w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 flex items-center justify-center font-black text-sm border border-slate-200 dark:border-slate-600 uppercase\\">{u.firstName?.[0]}</div>\\n                                        <div><p className=\\"font-bold text-slate-900 dark:text-white\\">{u.firstName} {u.lastName}</p><p className=\\"text-xs text-slate-500 font-medium\\">{u.email}</p></div>\\n                                    </div>\\n                                </td>\\n                                <td className=\\"p-5\\"><span className=\\"bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 px-3 py-1 rounded-lg text-xs font-bold uppercase\\">{rolesList.find(r=>r.id === u.role)?.name || u.role}</span></td>\\n                                <td className=\\"p-5 text-center\\">{u.status === \'ACTIVE\' ? <span className=\\"inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 text-[10px] font-black uppercase\\"><CheckCircle size={12}/> Activo</span> : <span className=\\"inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-slate-100 text-slate-500 text-[10px] font-black uppercase\\"><XCircle size={12}/> Inactivo</span>}</td>\\n                                <td className=\\"p-5 text-right\\">\\n                                    <div className=\\"flex justify-end gap-2\\">\\n                                        <button onClick={() => handleOpenEdit(u)} className=\\"p-2 hover:bg-indigo-50 text-slate-400 hover:text-indigo-600 rounded-lg transition-colors\\"><Edit3 size={16}/></button>\\n                                        <button onClick={() => handleDelete(u.id)} className=\\"p-2 hover:bg-rose-50 text-slate-400 hover:text-rose-600 rounded-lg transition-colors\\"><Trash2 size={16}/></button>\\n                                    </div>\\n                                </td>\\n                            </tr>\\n                        ))}\\n                    </tbody>\\n                </table>\\n                {users.length === 0 && !loading && <div className=\\"p-10 text-center text-slate-500 font-medium\\">No hay usuarios registrados.</div>}\\n            </div>\\n\\n            {isModalOpen && (\\n                <div className=\\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md\\">\\n                    <div className=\\"bg-white dark:bg-slate-800 rounded-[2rem] w-full max-w-lg p-8 shadow-2xl animate-in zoom-in-95 border border-slate-100 dark:border-slate-700\\">\\n                        <div className=\\"flex justify-between items-center mb-8\\">\\n                            <div><h3 className=\\"font-black text-xl text-slate-900 dark:text-white uppercase\\">{editMode ? \'Editar Usuario\' : \'Nuevo Acceso\'}</h3></div>\\n                            <button onClick={()=>setIsModalOpen(false)} className=\\"p-2 bg-slate-100 dark:bg-slate-700 rounded-full hover:bg-slate-200 transition-colors\\"><X size={20}/></button>\\n                        </div>\\n                        <form onSubmit={handleSubmit} className=\\"space-y-5\\">\\n                            <div className=\\"grid grid-cols-2 gap-5\\">\\n                                <div><label className=\\"text-[10px] font-black uppercase text-slate-500 dark:text-slate-400 ml-1 mb-1 block\\">Nombre</label><input required className=\\"w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-indigo-500 rounded-xl font-bold text-slate-900 dark:text-white outline-none\\" value={formData.firstName} onChange={e=>setFormData({...formData, firstName: e.target.value})}/></div>\\n                                <div><label className=\\"text-[10px] font-black uppercase text-slate-500 dark:text-slate-400 ml-1 mb-1 block\\">Apellido</label><input required className=\\"w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-indigo-500 rounded-xl font-bold text-slate-900 dark:text-white outline-none\\" value={formData.lastName} onChange={e=>setFormData({...formData, lastName: e.target.value})}/></div>\\n                            </div>\\n                            \\n                            <div><label className=\\"text-[10px] font-black uppercase text-slate-500 dark:text-slate-400 ml-1 mb-1 block\\">Email</label><input required type=\\"email\\" disabled={editMode} className=\\"w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-indigo-500 rounded-xl font-bold text-slate-900 dark:text-white outline-none disabled:opacity-50\\" value={formData.email} onChange={e=>setFormData({...formData, email: e.target.value})}/></div>\\n                            \\n                            {!editMode && <div><label className=\\"text-[10px] font-black uppercase text-slate-500 dark:text-slate-400 ml-1 mb-1 block\\">Contrase帽a</label><input required type=\\"password\\" minLength={6} className=\\"w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-indigo-500 rounded-xl font-bold text-slate-900 dark:text-white outline-none\\" value={formData.password} onChange={e=>setFormData({...formData, password: e.target.value})}/></div>}\\n                            \\n                            <div><label className=\\"text-[10px] font-black uppercase text-slate-500 dark:text-slate-400 ml-1 mb-1 block\\">Rol</label><select required className=\\"w-full p-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-indigo-500 rounded-xl font-bold text-indigo-600 outline-none\\" value={formData.role} onChange={e=>setFormData({...formData, role: e.target.value})}><option value=\\"\\">Seleccionar Rol...</option>{rolesList.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}</select></div>\\n                            \\n                            <div className=\\"flex gap-3 pt-4\\">\\n                                <button type=\\"button\\" onClick={()=>setIsModalOpen(false)} className=\\"px-6 py-4 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition-colors\\">Cancelar</button>\\n                                <button type=\\"submit\\" disabled={isProcessing} className=\\"flex-1 py-4 bg-indigo-600 text-white rounded-xl font-black uppercase tracking-wide hover:bg-indigo-700 shadow-lg flex justify-center items-center gap-2\\">\\n                                    {isProcessing ? <RefreshCw className=\\"animate-spin\\" size={20}/> : (editMode ? <Edit3 size={20}/> : <Plus size={20}/>)} {editMode ? \'GUARDAR\' : \'CREAR\'}\\n                                </button>\\n                            </div>\\n                        </form>\\n                    </div>\\n                </div>\\n            )}\\n        </div>\\n    );\\n}"},{"id":"40oi7mtqt","name":"PlanningTab.tsx","path":"apps\\\\web2\\\\src\\\\components\\\\admin\\\\planning\\\\PlanningTab.tsx","area":"FRONTEND","content":"\\nimport React, { useState, useEffect, useMemo } from \'react\';\\nimport { db, functions } from \'@/lib/firebase\';\\nimport { collection, onSnapshot, query, orderBy, deleteDoc, doc } from \'firebase/firestore\';\\nimport { httpsCallable } from \'firebase/functions\';\\nimport { \\n    Calendar as CalendarIcon, ShieldAlert, Lock, Trash2, User, \\n    ChevronLeft, ChevronRight, Filter, Download\\n} from \'lucide-react\';\\nimport { toast } from \'sonner\';\\nimport { startOfWeek, addDays, format, isSameDay, startOfMonth, endOfMonth, eachDayOfInterval } from \'date-fns\';\\nimport { es } from \'date-fns/locale\';\\n\\nexport default function PlanningTab() {\\n    const [shifts, setShifts] = useState<any[]>([]);\\n    const [employees, setEmployees] = useState<any[]>([]);\\n    const [currentDate, setCurrentDate] = useState(new Date());\\n    const [viewMode, setViewMode] = useState<\'WEEK\' | \'MONTH\'>(\'WEEK\');\\n\\n    // 1. CARGA EN TIEMPO REAL (CRTICO PARA VER EL VERDE AL INSTANTE)\\n    useEffect(() => {\\n        // Escuchamos empleados\\n        const unsubEmp = onSnapshot(collection(db, \'employees\'), (snap) => {\\n            setEmployees(snap.docs.map(d => ({ id: d.id, ...d.data() })));\\n        });\\n\\n        // Escuchamos turnos\\n        const q = query(collection(db, \'turnos\'));\\n        const unsubShifts = onSnapshot(q, (snap) => {\\n            const data = snap.docs.map(d => {\\n                const s = d.data();\\n                return {\\n                    id: d.id,\\n                    ...s,\\n                    start: s.startTime?.toDate(),\\n                    end: s.endTime?.toDate()\\n                };\\n            });\\n            setShifts(data);\\n        });\\n\\n        return () => { unsubEmp(); unsubShifts(); };\\n    }, []);\\n\\n    // 2. GENERAR DAS DE LA GRILLA\\n    const days = useMemo(() => {\\n        const start = viewMode === \'WEEK\' ? startOfWeek(currentDate, { weekStartsOn: 1 }) : startOfMonth(currentDate);\\n        const end = viewMode === \'WEEK\' ? addDays(start, 6) : endOfMonth(currentDate);\\n        return eachDayOfInterval({ start, end });\\n    }, [currentDate, viewMode]);\\n\\n    // 3. LGICA DE COLOR (AQU EST LA MAGIA)\\n    const getShiftStyle = (shift: any) => {\\n        // PRIORIDAD 1: ESTADO (Si ya fich贸, VERDE)\\n        if (shift.status === \'PRESENT\') {\\n            return \'bg-emerald-100 text-emerald-700 border-emerald-300 font-black\'; // VERDE = PRESENTE\\n        }\\n        if (shift.status === \'ABSENT\') {\\n            return \'bg-rose-100 text-rose-700 border-rose-300 font-black\'; // ROJO = AUSENTE\\n        }\\n        if (shift.status === \'COMPLETED\') {\\n            return \'bg-blue-100 text-blue-700 border-blue-300 font-bold\'; // AZUL = FINALIZADO\\n        }\\n\\n        // PRIORIDAD 2: TIPO DE TURNO (Si es pendiente)\\n        // Detectamos tipo por hora (simple) o por campo \'type\'\\n        const hour = shift.start?.getHours() || 0;\\n        if (hour >= 21 || hour <= 5) return \'bg-indigo-50 text-indigo-600 border-indigo-100\'; // NOCHE\\n        if (hour >= 13) return \'bg-sky-50 text-sky-600 border-sky-100\'; // TARDE\\n        \\n        return \'bg-amber-50 text-amber-600 border-amber-100\'; // MAANA\\n    };\\n\\n    const getShiftLabel = (shift: any) => {\\n        if (shift.status === \'ABSENT\') return \'AUS\';\\n        // Letra seg煤n hora\\n        const hour = shift.start?.getHours() || 0;\\n        if (hour >= 21 || hour <= 5) return \'N\'; // Noche\\n        if (hour >= 13) return \'T\'; // Tarde\\n        return \'M\'; // Ma帽ana\\n    };\\n\\n    // --- MANEJO DE CLIC EN CELDA (SEGURIDAD) ---\\n    const handleShiftClick = (shift: any) => {\\n        if (shift.status === \'PRESENT\' || shift.status === \'COMPLETED\') {\\n            alert(` TURNO BLINDADO\\\\n\\\\nEstado: ${shift.status}\\\\nEmpleado: ${shift.employeeName}\\\\n\\\\nEste turno ya inici贸 o finaliz贸. No se puede modificar desde la grilla r谩pida.`);\\n            return;\\n        }\\n        \\n        if (confirm(`驴Borrar turno pendiente de ${shift.employeeName}?`)) {\\n            deleteDoc(doc(db, \'turnos\', shift.id));\\n            toast.success(\\"Turno eliminado\\");\\n        }\\n    };\\n\\n    return (\\n        <div className=\\"bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 animate-in fade-in flex flex-col h-[calc(100vh-120px)]\\">\\n            \\n            {/* HEADER */}\\n            <div className=\\"flex justify-between items-center mb-6\\">\\n                <div>\\n                    <h2 className=\\"text-xl font-black uppercase dark:text-white flex items-center gap-2\\">\\n                        <CalendarIcon size={24} className=\\"text-indigo-600\\"/> Dotaci贸n y Turnos\\n                    </h2>\\n                    <p className=\\"text-xs text-slate-500\\">Vista matricial de asignaciones.</p>\\n                </div>\\n                \\n                <div className=\\"flex items-center gap-4 bg-slate-50 dark:bg-slate-900 p-2 rounded-xl\\">\\n                    <div className=\\"flex items-center gap-2\\">\\n                        <button onClick={() => setViewMode(\'WEEK\')} className={`px-3 py-1 text-xs font-bold rounded-lg transition-all ${viewMode === \'WEEK\' ? \'bg-white shadow text-indigo-600\' : \'text-slate-400\'}`}>SEMANA</button>\\n                        <button onClick={() => setViewMode(\'MONTH\')} className={`px-3 py-1 text-xs font-bold rounded-lg transition-all ${viewMode === \'MONTH\' ? \'bg-white shadow text-indigo-600\' : \'text-slate-400\'}`}>MES</button>\\n                    </div>\\n                    <div className=\\"h-4 w-px bg-slate-300 mx-2\\"></div>\\n                    <div className=\\"flex gap-1\\">\\n                        <button onClick={() => setCurrentDate(d => addDays(d, viewMode === \'WEEK\' ? -7 : -30))} className=\\"p-1 hover:bg-slate-200 rounded\\"><ChevronLeft size={16}/></button>\\n                        <span className=\\"text-sm font-black uppercase w-32 text-center\\">\\n                            {format(currentDate, viewMode === \'WEEK\' ? \\"\'Semana\' w\\" : \'MMMM yyyy\', { locale: es })}\\n                        </span>\\n                        <button onClick={() => setCurrentDate(d => addDays(d, viewMode === \'WEEK\' ? 7 : 30))} className=\\"p-1 hover:bg-slate-200 rounded\\"><ChevronRight size={16}/></button>\\n                    </div>\\n                </div>\\n            </div>\\n\\n            {/* LEYENDA */}\\n            <div className=\\"flex gap-4 text-[10px] font-bold uppercase mb-4 px-2\\">\\n                <div className=\\"flex items-center gap-1\\"><span className=\\"w-3 h-3 bg-emerald-100 border border-emerald-300 rounded block\\"></span> Presente</div>\\n                <div className=\\"flex items-center gap-1\\"><span className=\\"w-3 h-3 bg-sky-50 border border-sky-100 rounded block\\"></span> Tarde (Pend)</div>\\n                <div className=\\"flex items-center gap-1\\"><span className=\\"w-3 h-3 bg-indigo-50 border border-indigo-100 rounded block\\"></span> Noche (Pend)</div>\\n                <div className=\\"flex items-center gap-1\\"><span className=\\"w-3 h-3 bg-rose-100 border border-rose-300 rounded block\\"></span> Ausente</div>\\n            </div>\\n\\n            {/* GRILLA (SCROLLABLE) */}\\n            <div className=\\"flex-1 overflow-auto border rounded-xl dark:border-slate-700 relative\\">\\n                <table className=\\"w-full text-left border-collapse\\">\\n                    <thead className=\\"sticky top-0 z-10 bg-slate-50 dark:bg-slate-900 shadow-sm\\">\\n                        <tr>\\n                            <th className=\\"p-4 min-w-[200px] text-xs font-black text-slate-400 uppercase tracking-wider border-b dark:border-slate-700 bg-slate-50 dark:bg-slate-900 sticky left-0 z-20\\">Empleado</th>\\n                            {days.map(day => (\\n                                <th key={day.toISOString()} className={`p-2 text-center min-w-[50px] border-b border-l dark:border-slate-700 ${isSameDay(day, new Date()) ? \'bg-indigo-50/50 text-indigo-600\' : \'\'}`}>\\n                                    <div className=\\"text-[10px] font-bold uppercase text-slate-400\\">{format(day, \'EEE\', { locale: es })}</div>\\n                                    <div className=\\"text-sm font-black text-slate-700 dark:text-slate-300\\">{format(day, \'d\')}</div>\\n                                </th>\\n                            ))}\\n                        </tr>\\n                    </thead>\\n                    <tbody className=\\"divide-y divide-slate-100 dark:divide-slate-700\\">\\n                        {employees.map(emp => (\\n                            <tr key={emp.id} className=\\"hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors\\">\\n                                {/* COLUMNA EMPLEADO (FIJA) */}\\n                                <td className=\\"p-3 sticky left-0 bg-white dark:bg-slate-800 z-10 border-r dark:border-slate-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]\\">\\n                                    <div className=\\"flex items-center gap-3\\">\\n                                        <div className=\\"w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs font-black text-slate-500\\">\\n                                            {emp.firstName?.charAt(0)}{emp.lastName?.charAt(0)}\\n                                        </div>\\n                                        <div>\\n                                            <div className=\\"text-xs font-bold text-slate-700 dark:text-white truncate max-w-[140px]\\">{emp.firstName} {emp.lastName}</div>\\n                                            <div className=\\"text-[9px] text-slate-400 uppercase\\">Guardia</div>\\n                                        </div>\\n                                    </div>\\n                                </td>\\n\\n                                {/* CELDAS DAS */}\\n                                {days.map(day => {\\n                                    // Buscar turno para este empleado en este d铆a\\n                                    const dayShift = shifts.find(s => \\n                                        s.employeeId === emp.id && \\n                                        isSameDay(s.start, day)\\n                                    );\\n\\n                                    return (\\n                                        <td key={day.toISOString()} className=\\"p-1 border-l dark:border-slate-700 relative h-12\\">\\n                                            {dayShift ? (\\n                                                <button \\n                                                    onClick={() => handleShiftClick(dayShift)}\\n                                                    className={`w-full h-full rounded-lg border text-xs flex items-center justify-center transition-all hover:scale-95 ${getShiftStyle(dayShift)}`}\\n                                                    title={`${dayShift.clientName} - ${dayShift.status}`}\\n                                                >\\n                                                    {getShiftLabel(dayShift)}\\n                                                </button>\\n                                            ) : (\\n                                                <div className=\\"w-full h-full hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-lg cursor-pointer group flex items-center justify-center\\">\\n                                                    <span className=\\"hidden group-hover:block text-slate-300 text-lg\\">+</span>\\n                                                </div>\\n                                            )}\\n                                        </td>\\n                                    );\\n                                })}\\n                            </tr>\\n                        ))}\\n                    </tbody>\\n                </table>\\n            </div>\\n        </div>\\n    );\\n}\\n"},{"id":"jhjvqgl2q","name":"AuthGuard.tsx","path":"apps\\\\web2\\\\src\\\\components\\\\auth\\\\AuthGuard.tsx","area":"FRONTEND","content":"\\nimport { useEffect, useState } from \'react\';\\nimport { useRouter } from \'next/router\';\\nimport { useAuth } from \'@/context/AuthContext\';\\nimport Link from \'next/link\';\\n\\nexport default function AuthGuard({ children }: { children: React.ReactNode }) {\\n  const { user, loading } = useAuth();\\n  const [isReady, setIsReady] = useState(false);\\n\\n  useEffect(() => {\\n    if (!loading) {\\n      if (user) {\\n        setIsReady(true);\\n      } else {\\n        console.log(\\"AuthGuard: No hay usuario activo.\\");\\n        // NO REDIRIGIMOS AUTOMTICAMENTE para evitar el bucle.\\n      }\\n    }\\n  }, [user, loading]);\\n\\n  if (loading) {\\n    return (\\n      <div className=\\"min-h-screen flex items-center justify-center bg-slate-900 text-white\\">\\n        <div className=\\"animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500\\"></div>\\n      </div>\\n    );\\n  }\\n\\n  if (!user) {\\n    return (\\n      <div className=\\"min-h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-6 text-center\\">\\n        <div className=\\"bg-rose-500/10 p-4 rounded-full mb-4\\">\\n          <svg className=\\"w-12 h-12 text-rose-500\\" fill=\\"none\\" stroke=\\"currentColor\\" viewBox=\\"0 0 24 24\\"><path strokeLinecap=\\"round\\" strokeLinejoin=\\"round\\" strokeWidth={2} d=\\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\\" /></svg>\\n        </div>\\n        <h1 className=\\"text-xl font-bold mb-2\\">Sesi贸n no detectada</h1>\\n        <p className=\\"text-slate-400 mb-6 max-w-sm\\">\\n           El sistema no detecta tu usuario. Esto evita que entres en un bucle infinito.\\n        </p>\\n        <Link \\n          href=\\"/login\\"\\n          className=\\"bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl transition-all\\"\\n        >\\n          Ir al Login Manualmente\\n        </Link>\\n        <p className=\\"mt-8 text-xs text-slate-600\\">\\n           Si acabas de loguearte y ves esto, revisa los \'Dominios Autorizados\' en Firebase Console.\\n        </p>\\n      </div>\\n    );\\n  }\\n\\n  return <>{children}</>;\\n}\\n"},{"id":"5mfu91ri1","name":"withAuthGuard.tsx","path":"apps\\\\web2\\\\src\\\\components\\\\common\\\\withAuthGuard.tsx","area":"FRONTEND","content":"\\nimport React, { useEffect, useState } from \'react\';\\nimport { useRouter } from \'next/router\';\\nimport { auth } from \'@/services/firebase-client.service\'; \\nimport { onAuthStateChanged } from \'firebase/auth\';\\n\\nexport function withAuthGuard<P extends object>(Component: React.ComponentType<P>, allowedRoles?: string[]) {\\n  return function WithAuthGuard(props: P) {\\n    const router = useRouter();\\n    const [authorized, setAuthorized] = useState(false);\\n    const [loading, setLoading] = useState(true);\\n\\n    useEffect(() => {\\n      // Escuchar cambios en la autenticaci贸n\\n      const unsubscribe = onAuthStateChanged(auth, async (user) => {\\n        if (!user) {\\n          console.log(\\" No autenticado (Modo desarrollo: Permitido temporalmente)\\");\\n          // router.replace(\'/auth/login\'); // Descomentar en producci贸n\\n          setAuthorized(true); \\n        } else {\\n          setAuthorized(true);\\n        }\\n        setLoading(false);\\n      });\\n\\n      return () => unsubscribe();\\n    }, [router]);\\n\\n    if (loading) {\\n      return (\\n        <div className=\\"h-screen w-screen flex items-center justify-center bg-gray-50\\">\\n          <div className=\\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600\\"></div>\\n        </div>\\n      );\\n    }\\n\\n    if (!authorized) return null;\\n\\n    return <Component {...props} />;\\n  };\\n}\\n"},{"id":"wgkaky6vx","name":"DashboardLayout.tsx","path":"apps\\\\web2\\\\src\\\\components\\\\layout\\\\DashboardLayout.tsx","area":"FRONTEND","content":"import React, { useState } from \'react\';\\nimport Link from \'next/link\';\\nimport { useRouter } from \'next/router\';\\nimport { useAuth } from \'@/context/AuthContext\';\\nimport { auth } from \'@/lib/firebase\';\\nimport { signOut } from \'firebase/auth\';\\nimport { Toaster } from \'sonner\';\\nimport { \\n  Menu, X, LogOut, Briefcase, BarChart3, Users, \\n  Settings, Calendar, LayoutDashboard, Radio, ShieldCheck\\n} from \'lucide-react\';\\n\\nexport default function DashboardLayout({ children }: { children: React.ReactNode }) {\\n  const [isSidebarOpen, setSidebarOpen] = useState(true);\\n  const router = useRouter();\\n  const { user } = useAuth();\\n\\n  const handleLogout = async () => {\\n    try {\\n      await signOut(auth);\\n      window.location.href = \'/login\';\\n    } catch (error) {\\n      console.error(\\"Error cerrando sesi贸n:\\", error);\\n    }\\n  };\\n\\n  const isActive = (path: string) => router.pathname.startsWith(path);\\n  \\n  const getLinkClass = (path: string, special = false) => {\\n    const base = `flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium text-sm ${!isSidebarOpen ? \'justify-center px-2\' : \'\'}`;\\n    \\n    if (isActive(path)) {\\n       return `${base} bg-indigo-600 text-white shadow-lg shadow-indigo-900/50`;\\n    }\\n    \\n    if (special) {\\n       return `${base} bg-rose-600/10 text-rose-400 hover:bg-rose-600 hover:text-white border border-rose-900/50 hover:border-rose-500`;\\n    }\\n    \\n    return `${base} text-slate-300 hover:bg-slate-800 hover:text-white`;\\n  };\\n\\n  return (\\n    <div className=\\"min-h-screen bg-slate-50 dark:bg-slate-900 transition-colors duration-300 flex\\">\\n      <Toaster position=\\"top-right\\" richColors closeButton expand={true} />\\n\\n      {/* SIDEBAR */}\\n      <aside \\n        className={`fixed top-0 left-0 z-40 h-screen transition-all duration-300 bg-slate-900 text-white border-r border-slate-800 flex flex-col\\n        ${isSidebarOpen ? \'w-64 translate-x-0\' : \'w-20 -translate-x-full lg:translate-x-0\'} \\n        `}\\n      >\\n        \\n        <div className={`p-6 flex items-center ${isSidebarOpen ? \'justify-between\' : \'justify-center\'} shrink-0`}>\\n          {isSidebarOpen ? (\\n             <span className=\\"text-xl font-black tracking-tighter text-indigo-400\\">CRONOAPP</span>\\n          ) : (\\n             <ShieldCheck className=\\"text-indigo-400\\" />\\n          )}\\n          <button onClick={() => setSidebarOpen(false)} className=\\"lg:hidden text-slate-400 hover:text-white\\"><X/></button>\\n        </div>\\n\\n        <nav className=\\"px-3 space-y-2 mt-4 flex-1 overflow-y-auto custom-scrollbar\\">\\n          \\n          {isSidebarOpen && <div className=\\"px-4 py-2 text-[10px] font-black text-slate-500 uppercase tracking-widest\\">Operativa</div>}\\n          \\n          <Link href=\\"/admin/dashboard\\" className={getLinkClass(\'/admin/dashboard\')} title=\\"Dashboard\\">\\n            <LayoutDashboard size={20}/> {isSidebarOpen && <span>Dashboard</span>}\\n          </Link>\\n          \\n          <Link href=\\"/admin/operaciones\\" className={getLinkClass(\'/admin/operaciones\', true)} title=\\"Centro Control\\">\\n            <Radio size={20}/> {isSidebarOpen && <span>Centro Control</span>}\\n          </Link>\\n          \\n          <Link href=\\"/admin/planificacion\\" className={getLinkClass(\'/admin/planificacion\')} title=\\"Planificador\\">\\n            <Calendar size={20}/> {isSidebarOpen && <span>Planificador</span>}\\n          </Link>\\n\\n          {isSidebarOpen && <div className=\\"px-4 py-2 text-[10px] font-black text-slate-500 uppercase tracking-widest mt-4\\">Gesti贸n</div>}\\n          \\n          <Link href=\\"/admin/crm\\" className={getLinkClass(\'/admin/crm\')} title=\\"CRM Clientes\\">\\n            <Briefcase size={20}/> {isSidebarOpen && <span>CRM Clientes</span>}\\n          </Link>\\n          \\n          <Link href=\\"/admin/servicios\\" className={getLinkClass(\'/admin/servicios\')} title=\\"Servicios\\">\\n            <ShieldCheck size={20}/> {isSidebarOpen && <span>Servicios</span>}\\n          </Link>\\n\\n          {/*  AQU EST EL ENLACE RESTAURADO */}\\n          <Link href=\\"/admin/reportes\\" className={getLinkClass(\'/admin/reportes\')} title=\\"Reportes\\">\\n            <BarChart3 size={20}/> {isSidebarOpen && <span>Reportes</span>}\\n          </Link>\\n          \\n          <Link href=\\"/admin/rrhh\\" className={getLinkClass(\'/admin/rrhh\')} title=\\"RRHH\\">\\n            <Users size={20}/> {isSidebarOpen && <span>RRHH</span>}\\n          </Link>\\n\\n           {isSidebarOpen && <div className=\\"px-4 py-2 text-[10px] font-black text-slate-500 uppercase tracking-widest mt-4\\">Sistema</div>}\\n          \\n          <Link href=\\"/admin/configuracion\\" className={getLinkClass(\'/admin/configuracion\')} title=\\"Configuraci贸n\\">\\n            <Settings size={20}/> {isSidebarOpen && <span>Configuraci贸n</span>}\\n          </Link>\\n        </nav>\\n\\n        <div className=\\"p-4 border-t border-slate-800 shrink-0 flex flex-col gap-2\\">\\n           <button onClick={handleLogout} className=\\"w-full flex items-center justify-center gap-3 px-4 py-3 text-rose-400 hover:bg-rose-900/20 hover:text-rose-300 rounded-xl transition-all font-medium text-sm\\" title=\\"Cerrar Sesi贸n\\">\\n            <LogOut size={20}/> {isSidebarOpen && <span>Salir</span>}\\n          </button>\\n        </div>\\n      </aside>\\n\\n      {/* CONTENIDO */}\\n      <div className={`flex-1 transition-all duration-300 ${isSidebarOpen ? \'lg:ml-64\' : \'lg:ml-20\'}`}>\\n        <div className=\\"bg-white dark:bg-slate-800 p-4 shadow-sm border-b border-slate-200 dark:border-slate-700 flex items-center gap-4 sticky top-0 z-30\\">\\n           <button \\n             onClick={() => setSidebarOpen(!isSidebarOpen)} \\n             className=\\"p-2 rounded-lg hover:bg-slate-100 text-slate-600 dark:text-slate-200 transition-colors\\"\\n           >\\n             <Menu size={24} />\\n           </button>\\n           <span className=\\"font-black text-slate-700 dark:text-white uppercase tracking-tight\\">\\n             {isSidebarOpen ? \'Panel de Control\' : \'CronoApp\'}\\n           </span>\\n        </div>\\n\\n        <main className=\\"p-4 lg:p-8\\">\\n          {children}\\n        </main>\\n      </div>\\n    </div>\\n  );\\n}"},{"id":"3442uhz7k","name":"Sidebar.tsx","path":"apps\\\\web2\\\\src\\\\components\\\\layout\\\\Sidebar.tsx","area":"FRONTEND","content":"\'use client\';\\n\\nimport Link from \'next/link\';\\nimport { usePathname } from \'next/navigation\';\\nimport { \\n  LayoutDashboard, \\n  Users, \\n  FileText, \\n  Settings, \\n  Clock, \\n  Shield,\\n  Briefcase\\n} from \'lucide-react\';\\n\\nconst menuItems = [\\n  {\\n    title: \'Dashboard\',\\n    icon: LayoutDashboard,\\n    href: \'/dashboard\',\\n    variant: \'default\'\\n  },\\n  {\\n    title: \'Centro Control\',\\n    icon: Shield,\\n    href: \'/dashboard/operaciones\',\\n    variant: \'ghost\'\\n  },\\n  {\\n    title: \'Planificador\',\\n    icon: Clock,\\n    href: \'/dashboard/planificador\',\\n    variant: \'ghost\'\\n  },\\n  {\\n    title: \'CRM Clientes\',\\n    icon: Briefcase,\\n    href: \'/dashboard/crm\',\\n    variant: \'ghost\'\\n  },\\n  {\\n    title: \'RRHH\',\\n    icon: Users,\\n    href: \'/dashboard/rrhh\',\\n    variant: \'ghost\'\\n  },\\n  {\\n    title: \'Reportes\',\\n    icon: FileText,\\n    href: \'/dashboard/reportes\',\\n    variant: \'ghost\'\\n  },\\n  {\\n    title: \'Configuraci贸n\',\\n    icon: Settings,\\n    href: \'/dashboard/configuracion\',\\n    variant: \'ghost\'\\n  }\\n];\\n\\nexport function Sidebar() {\\n  const pathname = usePathname();\\n\\n  return (\\n    // MODIFICADO: Agregada clase \'print:hidden\' para ocultar al imprimir\\n    <aside className=\\"w-64 bg-gray-900 text-white min-h-screen p-4 flex flex-col print:hidden\\">\\n      <div className=\\"mb-8 px-2\\">\\n        <h1 className=\\"text-2xl font-bold text-blue-400\\">CRONOAPP</h1>\\n        <p className=\\"text-xs text-gray-400\\">Enterprise Edition</p>\\n      </div>\\n\\n      <nav className=\\"space-y-2 flex-1\\">\\n        {menuItems.map((item) => {\\n          const isActive = pathname === item.href;\\n          return (\\n            <Link\\n              key={item.href}\\n              href={item.href}\\n              className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${\\n                isActive \\n                  ? \'bg-blue-600 text-white\' \\n                  : \'text-gray-300 hover:bg-gray-800 hover:text-white\'\\n              }`}\\n            >\\n              <item.icon className=\\"w-5 h-5\\" />\\n              <span>{item.title}</span>\\n            </Link>\\n          );\\n        })}\\n      </nav>\\n\\n      <div className=\\"mt-auto pt-4 border-t border-gray-800\\">\\n        <div className=\\"px-4 py-2\\">\\n          <p className=\\"text-sm font-medium\\">Usuario Admin</p>\\n          <p className=\\"text-xs text-gray-500\\">admin@cronoapp.com</p>\\n        </div>\\n      </div>\\n    </aside>\\n  );\\n}\\n"},{"id":"dtnexzx97","name":"AbsenceResolutionModal.tsx","path":"apps\\\\web2\\\\src\\\\components\\\\operaciones\\\\AbsenceResolutionModal.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport { \\r\\n    X, UserX, Clock, UserCheck, UserPlus, ArrowRight, AlertTriangle, \\r\\n    Search, Briefcase, CheckCircle, User, Loader2, CalendarClock, ShieldAlert,\\r\\n    PauseCircle, FastForward, HelpCircle, BellRing, FileWarning\\r\\n} from \'lucide-react\';\\r\\nimport { db } from \'@/lib/firebase\';\\r\\nimport { collection, query, where, getDocs, Timestamp, updateDoc, doc, addDoc, serverTimestamp, orderBy, limit } from \'firebase/firestore\';\\r\\nimport { getAuth } from \'firebase/auth\';\\r\\nimport { toast } from \'sonner\';\\r\\n\\r\\n// --- TARJETA DE EMPLEADO (VISUAL INTACTA) ---\\r\\nconst EmployeeCard = ({ data, actionLabel, onAction, colorClass, type, subLabel }: any) => {\\r\\n    let displayName = \\"Guardia\\";\\r\\n    if (data.employeeName && data.employeeName !== \'undefined undefined\') {\\r\\n        displayName = data.employeeName;\\r\\n    } else if (data.firstName || data.lastName) {\\r\\n        displayName = `${data.lastName || \'\'} ${data.firstName || \'\'}`.trim();\\r\\n    }\\r\\n\\r\\n    return (\\r\\n        <div className={`flex items-center justify-between p-3 border rounded-xl bg-white hover:shadow-md transition-all group ${colorClass?.border || \'border-slate-200\'}`}>\\r\\n            <div className=\\"flex items-center gap-3 overflow-hidden\\">\\r\\n                <div className={`p-2 rounded-lg ${colorClass?.bg || \'bg-slate-100\'} ${colorClass?.text || \'text-slate-500\'}`}>\\r\\n                    <User size={18}/>\\r\\n                </div>\\r\\n                <div className=\\"min-w-0\\">\\r\\n                    <p className=\\"font-bold text-sm text-slate-800 truncate\\">{displayName}</p>\\r\\n                    <div className=\\"flex flex-col\\">\\r\\n                        <div className=\\"flex items-center gap-2 text-[10px] text-slate-500\\">\\r\\n                            {type === \'SHIFT\' ? <Clock size={10}/> : <CheckCircle size={10}/>}\\r\\n                            <span>\\r\\n                                {type === \'SHIFT\' && data.startTime \\r\\n                                    ? `${new Date(data.startTime.seconds * 1000).toLocaleTimeString([],{hour:\'2-digit\', minute:\'2-digit\'})} - ${new Date(data.endTime.seconds * 1000).toLocaleTimeString([],{hour:\'2-digit\', minute:\'2-digit\'})}`\\r\\n                                    : \'Disponible\'\\r\\n                                }\\r\\n                            </span>\\r\\n                        </div>\\r\\n                        {subLabel && <span className=\\"text-[9px] font-bold text-slate-400 uppercase\\">{subLabel}</span>}\\r\\n                    </div>\\r\\n                </div>\\r\\n            </div>\\r\\n            <button \\r\\n                onClick={() => onAction(data)}\\r\\n                className={`px-3 py-1.5 text-[10px] font-bold uppercase rounded-lg border transition-all ${colorClass?.bg || \'bg-slate-50\'} ${colorClass?.text || \'text-slate-600\'} hover:brightness-95 hover:scale-105`}\\r\\n            >\\r\\n                {actionLabel}\\r\\n            </button>\\r\\n        </div>\\r\\n    );\\r\\n};\\r\\n\\r\\ninterface Props {\\r\\n    isOpen: boolean;\\r\\n    onClose: () => void;\\r\\n    absenceShift: any; \\r\\n    onResolve: () => void;\\r\\n}\\r\\n\\r\\nexport default function AbsenceResolutionModal({ isOpen, onClose, absenceShift, onResolve }: Props) {\\r\\n    const [phase, setPhase] = useState<\'DIAGNOSIS\' | \'STRATEGY\' | \'SELECTION\' | \'CONFIRM\'>(\'DIAGNOSIS\');\\r\\n    const [method, setMethod] = useState<\'EXTENSION\' | \'ANTICIPATION\' | \'RELIEF\' | \'PENDING\' | \'PLANNING_ALERT\' | null>(null);\\r\\n    \\r\\n    // ESTADO: 驴Es un puesto sin asignar?\\r\\n    const [isUnassigned, setIsUnassigned] = useState(false);\\r\\n\\r\\n    const [activeGuards, setActiveGuards] = useState<any[]>([]);\\r\\n    const [showVariants, setShowVariants] = useState(false);\\r\\n    \\r\\n    const [candidates, setCandidates] = useState<any[]>([]);\\r\\n    const [selectedCandidate, setSelectedCandidate] = useState<any>(null);\\r\\n    const [loading, setLoading] = useState(false);\\r\\n\\r\\n    useEffect(() => {\\r\\n        if (isOpen) {\\r\\n            setPhase(\'DIAGNOSIS\');\\r\\n            setMethod(null);\\r\\n            setCandidates([]);\\r\\n            setSelectedCandidate(null);\\r\\n            setActiveGuards([]);\\r\\n            setShowVariants(false);\\r\\n            \\r\\n            // Detecci贸n: 驴Es un turno \\"Sin Asignar\\" o un Guardia Real?\\r\\n            const isGhost = !absenceShift?.employeeId || absenceShift.employeeName === \'Sin Asignar\' || absenceShift.employeeName === \'Vacante\';\\r\\n            setIsUnassigned(isGhost);\\r\\n\\r\\n            checkActiveGuards();\\r\\n        }\\r\\n    }, [isOpen, absenceShift]);\\r\\n\\r\\n    // 1. DETECTAR QUIN EST REALMENTE EN EL OBJETIVO (SOLUCIONA EL TEMA FRANCOS)\\r\\n    const checkActiveGuards = async () => {\\r\\n        try {\\r\\n            const now = new Date();\\r\\n            // Consulta ESTRICTA:\\r\\n            // - Mismo Objetivo\\r\\n            // - Status PRESENTE (Ya marc贸 entrada)\\r\\n            // - Hora Entrada < AHORA (Ya entr贸)\\r\\n            // - Hora Salida > AHORA (Todav铆a no se fue)\\r\\n            const q = query(\\r\\n                collection(db, \'turnos\'),\\r\\n                where(\'objectiveId\', \'==\', absenceShift.objectiveId),\\r\\n                where(\'status\', \'==\', \'PRESENT\'),\\r\\n                where(\'startTime\', \'<=\', Timestamp.fromDate(now)),\\r\\n                where(\'endTime\', \'>\', Timestamp.fromDate(now))\\r\\n            );\\r\\n            const snap = await getDocs(q);\\r\\n            const guards = snap.docs.map(d => ({ id: d.id, ...(d.data() as any) }));\\r\\n            setActiveGuards(guards);\\r\\n        } catch (e) { console.error(\\"Error buscando guardias activos\\", e); }\\r\\n    };\\r\\n\\r\\n    // --- AUDITORA ---\\r\\n    const logAudit = async (action: string, details: string, affectedEmployee: string) => {\\r\\n        try {\\r\\n            const auth = getAuth();\\r\\n            const user = auth.currentUser;\\r\\n            await addDoc(collection(db, \'audit_logs\'), {\\r\\n                timestamp: serverTimestamp(),\\r\\n                actorUid: user?.uid || \'system\',\\r\\n                actorName: user?.displayName || user?.email || \'Operador\',\\r\\n                module: \'OPERACIONES\',\\r\\n                action: action,\\r\\n                details: details,\\r\\n                targetShiftId: absenceShift.id,\\r\\n                targetEmployee: affectedEmployee,\\r\\n                clientName: absenceShift.clientName\\r\\n            });\\r\\n        } catch (e) { console.error(e); }\\r\\n    };\\r\\n\\r\\n    // --- ACCIN ESPECIAL: NOTIFICAR A PLANIFICACIN (SIN ASIGNAR) ---\\r\\n    const handleNotifyPlanning = async () => {\\r\\n        setLoading(true);\\r\\n        try {\\r\\n            // 1. Crear alerta en Novedades\\r\\n            await addDoc(collection(db, \'novedades\'), {\\r\\n                type: \'ERROR_PLANIFICACION\',\\r\\n                priority: \'ALTA\',\\r\\n                clientId: absenceShift.clientId,\\r\\n                clientName: absenceShift.clientName,\\r\\n                objectiveId: absenceShift.objectiveId,\\r\\n                objectiveName: absenceShift.objectiveName,\\r\\n                details: `Puesto sin cubrir detectado en ${absenceShift.objectiveName}. Turno vac铆o.`,\\r\\n                createdAt: serverTimestamp(),\\r\\n                status: \'OPEN\'\\r\\n            });\\r\\n\\r\\n            // 2. Actualizar el turno \\"fantasma\\" para que no moleste m谩s\\r\\n            if (absenceShift.id) {\\r\\n                await updateDoc(doc(db, \'turnos\', absenceShift.id), {\\r\\n                    status: \'UNCOVERED_REPORTED\',\\r\\n                    comments: \'Reportado a planificaci贸n como falta de cobertura.\'\\r\\n                });\\r\\n            }\\r\\n\\r\\n            await logAudit(\'REPORTE_PLANIFICACION\', `Se report贸 puesto sin asignar a planificaci贸n.`, \'Sin Asignar\');\\r\\n            toast.success(\\"Alerta enviada a Planificaci贸n.\\");\\r\\n            onResolve();\\r\\n        } catch(e) { toast.error(\\"Error al notificar\\"); } finally { setLoading(false); }\\r\\n    };\\r\\n\\r\\n    // --- FASE 1: DIAGNSTICO ---\\r\\n    const handleLateArrival = async () => {\\r\\n        setLoading(true);\\r\\n        try {\\r\\n            await updateDoc(doc(db, \'turnos\', absenceShift.id), {\\r\\n                isPresent: true,              \\r\\n                startTime: serverTimestamp(), \\r\\n                isLate: true,                 \\r\\n                status: \'PRESENT\',            \\r\\n                comments: \'Ingreso registrado con demora (Resoluci贸n Operativa)\'\\r\\n            });\\r\\n            await logAudit(\'LLEGADA_TARDE\', `Guardia ${absenceShift.employeeName} ingres贸 tarde.`, absenceShift.employeeName);\\r\\n            toast.success(\\" Ingreso registrado.\\");\\r\\n            onResolve(); \\r\\n        } catch(e) { toast.error(\\"Error al registrar ingreso\\"); } finally { setLoading(false); }\\r\\n    };\\r\\n\\r\\n    const handleConfirmAbsence = async () => {\\r\\n        setLoading(true);\\r\\n        try {\\r\\n            await updateDoc(doc(db, \'turnos\', absenceShift.id), { isAbsent: true, status: \'ABSENT\', comments: \'Ausencia sin aviso confirmada.\' });\\r\\n            await addDoc(collection(db, \'novedades\'), { type: \'AUSENCIA\', employeeId: absenceShift.employeeId, details: `Falta sin aviso en ${absenceShift.objectiveName}`, createdAt: serverTimestamp() });\\r\\n            \\r\\n            await logAudit(\'AUSENCIA_CONFIRMADA\', `Se confirm贸 ausencia de ${absenceShift.employeeName}.`, absenceShift.employeeName);\\r\\n            \\r\\n            setPhase(\'STRATEGY\'); \\r\\n        } catch(e) { toast.error(\\"Error\\"); } finally { setLoading(false); }\\r\\n    };\\r\\n\\r\\n    const handleResolveLater = async () => {\\r\\n        setLoading(true);\\r\\n        try {\\r\\n            await updateDoc(doc(db, \'turnos\', absenceShift.id), {\\r\\n                resolutionStatus: \'PENDING\', \\r\\n                comments: \'Ausencia confirmada. Gesti贸n pospuesta.\'\\r\\n            });\\r\\n            await logAudit(\'GESTION_POSPUESTA\', `Operador pospuso la cobertura.`, absenceShift.employeeName);\\r\\n            toast.info(\\"Gesti贸n pospuesta.\\");\\r\\n            onResolve();\\r\\n        } catch(e) { toast.error(\\"Error\\"); } finally { setLoading(false); }\\r\\n    };\\r\\n\\r\\n    // --- CARGA DE CANDIDATOS ---\\r\\n    const handleDirectRetention = (guard: any) => {\\r\\n        setSelectedCandidate(guard);\\r\\n        setMethod(\'EXTENSION\');\\r\\n        setPhase(\'CONFIRM\');\\r\\n    };\\r\\n\\r\\n    const loadCandidates = async (strategy: \'ANTICIPATION\' | \'RELIEF\') => {\\r\\n        setLoading(true);\\r\\n        setMethod(strategy);\\r\\n        try {\\r\\n            let data: any[] = [];\\r\\n            const shiftStart = absenceShift.startTime ? absenceShift.startTime.toDate() : new Date();\\r\\n            \\r\\n            if (strategy === \'ANTICIPATION\') {\\r\\n                const q = query(\\r\\n                    collection(db, \'turnos\'),\\r\\n                    where(\'objectiveId\', \'==\', absenceShift.objectiveId),\\r\\n                    where(\'startTime\', \'>\', Timestamp.fromDate(shiftStart)),\\r\\n                    orderBy(\'startTime\', \'asc\'),\\r\\n                    limit(5)\\r\\n                );\\r\\n                const snap = await getDocs(q);\\r\\n                data = snap.docs.map(d => ({ id: d.id, ...(d.data() as any) }));\\r\\n            } else {\\r\\n                // RELIEF: Traer activos y filtrar ocupados\\r\\n                const qEmp = query(collection(db, \'empleados\'), where(\'status\', \'==\', \'activo\'));\\r\\n                const empSnap = await getDocs(qEmp);\\r\\n                const allEmps = empSnap.docs.map(d => ({ id: d.id, ...(d.data() as any) }));\\r\\n\\r\\n                const rangeEnd = new Date(shiftStart.getTime() + 8 * 3600 * 1000);\\r\\n                const qBusy = query(\\r\\n                    collection(db, \'turnos\'),\\r\\n                    where(\'startTime\', \'<\', Timestamp.fromDate(rangeEnd)),\\r\\n                    where(\'endTime\', \'>\', Timestamp.fromDate(shiftStart))\\r\\n                );\\r\\n                const busySnap = await getDocs(qBusy);\\r\\n                const busyIds = new Set(busySnap.docs.map(d => d.data().employeeId));\\r\\n\\r\\n                data = allEmps.filter(e => !busyIds.has(e.id));\\r\\n            }\\r\\n            setCandidates(data);\\r\\n            setPhase(\'SELECTION\');\\r\\n        } catch (e) { toast.error(\\"Error buscando candidatos\\"); } finally { setLoading(false); }\\r\\n    };\\r\\n\\r\\n    // --- EJECUCIN ---\\r\\n    const handleExecute = async () => {\\r\\n        if (method !== \'PENDING\' && method !== \'PLANNING_ALERT\' && !selectedCandidate) return;\\r\\n        setLoading(true);\\r\\n\\r\\n        try {\\r\\n            const newStatus = (method === \'PENDING\' || method === \'PLANNING_ALERT\') ? \'PENDING\' : \'RESOLVED\';\\r\\n\\r\\n            await updateDoc(doc(db, \'turnos\', absenceShift.id), {\\r\\n                resolutionStatus: newStatus, \\r\\n                resolutionMethod: method, \\r\\n            });\\r\\n\\r\\n            if (method === \'EXTENSION\') {\\r\\n                const newEndTime = absenceShift.endTime; \\r\\n                await updateDoc(doc(db, \'turnos\', selectedCandidate.id), {\\r\\n                    endTime: newEndTime,\\r\\n                    isExtraShift: true, \\r\\n                    originalEndTime: selectedCandidate.endTime, \\r\\n                    resolutionNote: `Extensi贸n por ausencia de ${absenceShift.employeeName}`\\r\\n                });\\r\\n                await logAudit(\'RESOLUCION_EXTENSION\', `Doble Turno: ${selectedCandidate.employeeName}.`, selectedCandidate.employeeName);\\r\\n\\r\\n            } else if (method === \'ANTICIPATION\') {\\r\\n                await updateDoc(doc(db, \'turnos\', selectedCandidate.id), {\\r\\n                    startTime: absenceShift.startTime, \\r\\n                    isEarlyEntry: true, \\r\\n                    originalStartTime: selectedCandidate.startTime, \\r\\n                    resolutionNote: `Anticipo con Beneficio por ausencia de ${absenceShift.employeeName}`\\r\\n                });\\r\\n                await logAudit(\'RESOLUCION_ANTICIPO\', `Anticipo con Beneficio: ${selectedCandidate.employeeName}.`, selectedCandidate.employeeName);\\r\\n\\r\\n            } else if (method === \'RELIEF\') {\\r\\n                await addDoc(collection(db, \'turnos\'), {\\r\\n                    employeeId: selectedCandidate.id,\\r\\n                    employeeName: `${selectedCandidate.lastName}, ${selectedCandidate.firstName}`,\\r\\n                    clientId: absenceShift.clientId,\\r\\n                    clientName: absenceShift.clientName,\\r\\n                    objectiveId: absenceShift.objectiveId,\\r\\n                    objectiveName: absenceShift.objectiveName,\\r\\n                    startTime: absenceShift.startTime || serverTimestamp(), // Hora del turno original\\r\\n                    endTime: absenceShift.endTime,\\r\\n                    status: \'PRESENT\',\\r\\n                    isPresent: true,\\r\\n                    isRelief: true,\\r\\n                    comments: `Relevo con Beneficio por ${absenceShift.employeeName}`\\r\\n                });\\r\\n                await logAudit(\'RESOLUCION_RELEVO\', `Relevo con Beneficio: ${selectedCandidate.lastName}.`, selectedCandidate.lastName);\\r\\n            }\\r\\n\\r\\n            toast.success(\\"Incidencia resuelta.\\");\\r\\n            onResolve();\\r\\n\\r\\n        } catch (e) { toast.error(\\"Error al guardar\\"); } finally { setLoading(false); }\\r\\n    };\\r\\n\\r\\n    if (!isOpen) return null;\\r\\n\\r\\n    return (\\r\\n        <div className=\\"fixed inset-0 z-[9000] bg-black/60 flex items-center justify-center p-4 animate-in fade-in\\">\\r\\n            <div className=\\"bg-white dark:bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden border dark:border-slate-800 flex flex-col max-h-[90vh]\\">\\r\\n                <div className=\\"bg-rose-50 dark:bg-rose-900/20 p-4 border-b border-rose-100 dark:border-rose-800 flex justify-between items-center shrink-0\\">\\r\\n                    <h3 className=\\"font-black text-rose-700 dark:text-rose-400 flex items-center gap-2\\">\\r\\n                        {isUnassigned ? <FileWarning className=\\"animate-pulse\\"/> : <HelpCircle className=\\"animate-pulse\\"/>}\\r\\n                        {isUnassigned ? \'PUESTO SIN ASIGNAR\' : \'CONTROL DE ASISTENCIA\'}\\r\\n                    </h3>\\r\\n                    <button onClick={onClose}><X size={20} className=\\"text-rose-400 hover:text-rose-600\\"/></button>\\r\\n                </div>\\r\\n\\r\\n                <div className=\\"p-6 overflow-y-auto custom-scrollbar\\">\\r\\n                    \\r\\n                    {/* ENCABEZADO DIFERENCIADO: SIN ASIGNAR vs AUSENCIA */}\\r\\n                    <div className=\\"mb-6 text-center\\">\\r\\n                        {isUnassigned ? (\\r\\n                            <div className=\\"bg-red-50 p-3 rounded-xl border border-red-100\\">\\r\\n                                <p className=\\"text-xs font-bold text-red-600 uppercase mb-1\\">隆Alerta de Planificaci贸n!</p>\\r\\n                                <p className=\\"text-sm text-slate-600\\">Este puesto figura vacante en el sistema.</p>\\r\\n                                <p className=\\"text-xs text-slate-400 mt-1\\">{absenceShift?.objectiveName}</p>\\r\\n                            </div>\\r\\n                        ) : (\\r\\n                            <>\\r\\n                                <p className=\\"text-sm text-slate-500 uppercase font-bold\\">Validando turno de:</p>\\r\\n                                <h2 className=\\"text-2xl font-black text-slate-800 dark:text-white\\">{absenceShift?.employeeName}</h2>\\r\\n                                <p className=\\"text-xs text-slate-400\\">{absenceShift?.objectiveName}</p>\\r\\n                            </>\\r\\n                        )}\\r\\n                    </div>\\r\\n\\r\\n                    {/* FASE 1: DIAGNSTICO */}\\r\\n                    {phase === \'DIAGNOSIS\' && (\\r\\n                        <>\\r\\n                            {isUnassigned ? (\\r\\n                                // LOGICA 1: SIN ASIGNAR -> REPORTAR O CUBRIR\\r\\n                                <div className=\\"space-y-3\\">\\r\\n                                    <button onClick={handleNotifyPlanning} disabled={loading} className=\\"w-full p-4 bg-white border-2 border-red-100 hover:border-red-500 rounded-xl hover:shadow-md transition-all text-left flex items-center gap-3 group\\">\\r\\n                                        <div className=\\"bg-red-100 p-2 rounded-full text-red-600\\"><BellRing size={20}/></div>\\r\\n                                        <div>\\r\\n                                            <p className=\\"font-bold text-sm text-slate-800\\">Notificar a Planificaci贸n</p>\\r\\n                                            <p className=\\"text-[10px] text-slate-500\\">Enviar alerta y cerrar incidencia.</p>\\r\\n                                        </div>\\r\\n                                    </button>\\r\\n                                    \\r\\n                                    <button onClick={() => setPhase(\'STRATEGY\')} className=\\"w-full p-4 bg-white border-2 border-slate-100 hover:border-indigo-500 rounded-xl hover:shadow-md transition-all text-left flex items-center gap-3 group\\">\\r\\n                                        <div className=\\"bg-slate-100 p-2 rounded-full text-slate-600\\"><UserPlus size={20}/></div>\\r\\n                                        <div>\\r\\n                                            <p className=\\"font-bold text-sm text-slate-800\\">Cubrir Operativamente</p>\\r\\n                                            <p className=\\"text-[10px] text-slate-500\\">Buscar relevo o guardia presente.</p>\\r\\n                                        </div>\\r\\n                                    </button>\\r\\n                                </div>\\r\\n                            ) : (\\r\\n                                // LOGICA 2: NORMAL -> LLEG O NO LLEG\\r\\n                                <div className=\\"space-y-3\\">\\r\\n                                    <p className=\\"text-center text-sm font-bold text-slate-600 mb-2\\">驴El guardia se encuentra en el objetivo?</p>\\r\\n                                    <div className=\\"grid grid-cols-2 gap-4\\">\\r\\n                                        <button onClick={handleLateArrival} disabled={loading} className=\\"p-4 bg-white border border-indigo-200 hover:border-indigo-500 rounded-xl hover:shadow-md transition-all text-left group\\">\\r\\n                                            <CalendarClock className=\\"text-indigo-600 mb-2 group-hover:scale-110 transition-transform\\"/>\\r\\n                                            <p className=\\"font-bold text-sm text-slate-800\\">S, LLEG AHORA</p>\\r\\n                                            <p className=\\"text-[10px] text-slate-500 mt-1\\">Marcar Llegada Tarde.</p>\\r\\n                                        </button>\\r\\n                                        <button onClick={handleConfirmAbsence} disabled={loading} className=\\"p-4 bg-white border border-rose-200 hover:border-rose-500 rounded-xl hover:shadow-md transition-all text-left group\\">\\r\\n                                            <AlertTriangle className=\\"text-rose-600 mb-2 group-hover:scale-110 transition-transform\\"/>\\r\\n                                            <p className=\\"font-bold text-sm text-slate-800\\">NO LLEG</p>\\r\\n                                            <p className=\\"text-[10px] text-slate-500 mt-1\\">Confirmar Ausencia.</p>\\r\\n                                        </button>\\r\\n                                    </div>\\r\\n                                </div>\\r\\n                            )}\\r\\n                        </>\\r\\n                    )}\\r\\n\\r\\n                    {/* FASE 2: ESTRATEGIA */}\\r\\n                    {phase === \'STRATEGY\' && (\\r\\n                        <div className=\\"space-y-4\\">\\r\\n                            {/* RAMA: HAY GUARDIAS Y NO SE PIDI VARIANTES */}\\r\\n                            {activeGuards.length > 0 && !showVariants ? (\\r\\n                                <div className=\\"space-y-3 animate-in fade-in\\">\\r\\n                                    <div className=\\"bg-orange-50 dark:bg-orange-900/10 p-4 rounded-xl border border-orange-100 dark:border-orange-800\\">\\r\\n                                        <div className=\\"flex items-center gap-2 mb-3\\">\\r\\n                                            <Clock className=\\"text-orange-600\\" size={16}/>\\r\\n                                            <p className=\\"text-xs font-black text-orange-700 uppercase\\">Guardias Presentes (Retener)</p>\\r\\n                                        </div>\\r\\n                                        <div className=\\"space-y-2\\">\\r\\n                                            {activeGuards.map(guard => (\\r\\n                                                <EmployeeCard \\r\\n                                                    key={guard.id} \\r\\n                                                    data={guard}\\r\\n                                                    type=\\"SHIFT\\"\\r\\n                                                    actionLabel=\\"RETENER (DOBLE)\\" \\r\\n                                                    subLabel=\\"Turno Actual\\"\\r\\n                                                    colorClass={{ bg: \'bg-white\', text: \'text-orange-600\', border: \'border-orange-200\' }}\\r\\n                                                    onAction={handleDirectRetention}\\r\\n                                                />\\r\\n                                            ))}\\r\\n                                        </div>\\r\\n                                    </div>\\r\\n\\r\\n                                    <div className=\\"grid grid-cols-2 gap-3\\">\\r\\n                                        <button onClick={handleResolveLater} className=\\"p-3 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-xl text-xs font-bold text-slate-500 uppercase transition-all flex items-center justify-center gap-2\\">\\r\\n                                            <PauseCircle size={16}/> Posponer\\r\\n                                        </button>\\r\\n                                        <button onClick={() => setShowVariants(true)} className=\\"p-3 bg-white hover:bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-500 uppercase transition-all flex items-center justify-center gap-2\\">\\r\\n                                            <FastForward size={16}/> Ver Variantes\\r\\n                                        </button>\\r\\n                                    </div>\\r\\n                                </div>\\r\\n                            ) : (\\r\\n                                <div className=\\"grid grid-cols-1 gap-3 animate-in fade-in\\">\\r\\n                                    <div className=\\"flex items-center gap-2 mb-1 px-1\\">\\r\\n                                        <ShieldAlert className=\\"text-indigo-500\\" size={14}/>\\r\\n                                        <p className=\\"text-xs font-black text-slate-500 uppercase\\">Variantes (Beneficio Turno Completo)</p>\\r\\n                                    </div>\\r\\n                                    \\r\\n                                    <button onClick={() => loadCandidates(\'ANTICIPATION\')} className=\\"p-4 bg-white border-2 border-cyan-50 hover:border-cyan-500 rounded-xl flex items-center gap-4 group transition-all\\">\\r\\n                                        <div className=\\"bg-cyan-100 p-2 rounded-lg text-cyan-600\\"><ArrowRight size={20}/></div>\\r\\n                                        <div className=\\"text-left flex-1\\">\\r\\n                                            <p className=\\"font-bold text-slate-700\\">Adelantar Turno</p>\\r\\n                                            <p className=\\"text-[10px] text-slate-400\\">Llamar al siguiente.</p>\\r\\n                                        </div>\\r\\n                                        <ArrowRight className=\\"text-slate-300 group-hover:text-cyan-500\\"/>\\r\\n                                    </button>\\r\\n\\r\\n                                    <button onClick={() => loadCandidates(\'RELIEF\')} className=\\"p-4 bg-white border-2 border-emerald-50 hover:border-emerald-500 rounded-xl flex items-center gap-4 group transition-all\\">\\r\\n                                        <div className=\\"bg-emerald-100 p-2 rounded-lg text-emerald-600\\"><UserPlus size={20}/></div>\\r\\n                                        <div className=\\"text-left flex-1\\">\\r\\n                                            <p className=\\"font-bold text-slate-700\\">Buscar Relevo (Franco)</p>\\r\\n                                            <p className=\\"text-[10px] text-slate-400\\">Traer externo.</p>\\r\\n                                        </div>\\r\\n                                        <ArrowRight className=\\"text-slate-300 group-hover:text-emerald-500\\"/>\\r\\n                                    </button>\\r\\n                                    \\r\\n                                    {activeGuards.length > 0 && (\\r\\n                                        <button onClick={() => setShowVariants(false)} className=\\"mt-2 text-xs text-slate-400 underline\\">Volver a Guardias Presentes</button>\\r\\n                                    )}\\r\\n                                </div>\\r\\n                            )}\\r\\n                        </div>\\r\\n                    )}\\r\\n\\r\\n                    {phase === \'SELECTION\' && (\\r\\n                        <div>\\r\\n                            <div className=\\"flex justify-between items-center mb-2\\">\\r\\n                                <h4 className=\\"font-bold text-sm text-slate-700\\">Seleccionar Candidato</h4>\\r\\n                                <button onClick={() => setPhase(\'STRATEGY\')} className=\\"text-xs text-slate-400 underline\\">Volver</button>\\r\\n                            </div>\\r\\n                            <div className=\\"max-h-[200px] overflow-y-auto custom-scrollbar border rounded-xl mb-4 p-2 space-y-2\\">\\r\\n                                {candidates.length === 0 ? (\\r\\n                                    <div className=\\"p-4 text-center text-slate-400 text-xs\\">No se encontraron candidatos disponibles.</div>\\r\\n                                ) : (\\r\\n                                    candidates.map(c => (\\r\\n                                        <EmployeeCard \\r\\n                                            key={c.id} \\r\\n                                            data={c} \\r\\n                                            type={method === \'RELIEF\' ? \'EMPLOYEE\' : \'SHIFT\'}\\r\\n                                            actionLabel=\\"SELECCIONAR\\"\\r\\n                                            colorClass={{\\r\\n                                                bg: method === \'ANTICIPATION\' ? \'bg-cyan-50\' : \'bg-emerald-50\',\\r\\n                                                text: method === \'ANTICIPATION\' ? \'text-cyan-600\' : \'text-emerald-600\',\\r\\n                                                border: \'border-slate-100\'\\r\\n                                            }}\\r\\n                                            onAction={() => { setSelectedCandidate(c); setPhase(\'CONFIRM\'); }}\\r\\n                                        />\\r\\n                                    ))\\r\\n                                )}\\r\\n                            </div>\\r\\n                        </div>\\r\\n                    )}\\r\\n\\r\\n                    {phase === \'CONFIRM\' && (\\r\\n                        <div className=\\"text-center space-y-4\\">\\r\\n                            <div className=\\"bg-slate-50 p-4 rounded-xl border border-slate-200\\">\\r\\n                                <p className=\\"text-xs text-slate-500 uppercase font-bold mb-2\\">Confirmar Acci贸n</p>\\r\\n                                <div className=\\"text-sm font-medium\\">\\r\\n                                    {method === \'EXTENSION\' && <p>Doble Turno: <b>{selectedCandidate.employeeName}</b></p>}\\r\\n                                    {method === \'ANTICIPATION\' && (\\r\\n                                        <>\\r\\n                                            <p>Anticipo: <b>{selectedCandidate.employeeName}</b></p>\\r\\n                                            <p className=\\"text-[10px] text-emerald-600 font-bold mt-1\\"> Se computar谩 horario completo</p>\\r\\n                                        </>\\r\\n                                    )}\\r\\n                                    {method === \'RELIEF\' && (\\r\\n                                        <>\\r\\n                                            <p>Relevo: <b>{selectedCandidate.lastName}</b></p>\\r\\n                                            <p className=\\"text-[10px] text-emerald-600 font-bold mt-1\\"> Se computar谩 horario completo</p>\\r\\n                                        </>\\r\\n                                    )}\\r\\n                                </div>\\r\\n                            </div>\\r\\n                            <button onClick={handleExecute} disabled={loading} className=\\"w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold uppercase shadow-lg transition-all flex items-center justify-center gap-2\\">\\r\\n                                {loading ? <Loader2 className=\\"animate-spin\\" size={18}/> : <UserCheck size={18}/>} Confirmar\\r\\n                            </button>\\r\\n                            <button onClick={() => setPhase(\'STRATEGY\')} className=\\"text-xs text-slate-400 underline\\">Cancelar</button>\\r\\n                        </div>\\r\\n                    )}\\r\\n                </div>\\r\\n            </div>\\r\\n        </div>\\r\\n    );\\r\\n}"},{"id":"n39cfscc3","name":"mapStyles.ts","path":"apps\\\\web2\\\\src\\\\components\\\\operaciones\\\\mapStyles.ts","area":"FRONTEND","content":"export const POPUP_STYLES = `\\r\\n    /* ANIMACIONES */\\r\\n    @keyframes pulse-ring { 0% { transform: scale(0.33); opacity: 1; } 80%, 100% { transform: scale(2.5); opacity: 0; } }\\r\\n    @keyframes pulse-dot { 0% { transform: scale(0.8); } 50% { transform: scale(1); } 100% { transform: scale(0.8); } }\\r\\n    \\r\\n    .marker-alert-container { position: relative; width: 30px; height: 30px; }\\r\\n    .marker-alert-ring { position: absolute; height: 30px; width: 30px; border-radius: 50%; background-color: rgba(225, 29, 72, 0.6); animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }\\r\\n    .marker-alert-dot { position: absolute; left: 0; top: 0; height: 30px; width: 30px; background-color: #e11d48; border: 2px solid white; border-radius: 50%; color: white; font-weight: 900; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); animation: pulse-dot 1.5s cubic-bezier(0.455, 0.03, 0.515, 0.955) -0.4s infinite; }\\r\\n\\r\\n    /* TOOLTIPS DARK GLASS */\\r\\n    .leaflet-tooltip { background: transparent !important; border: none !important; box-shadow: none !important; }\\r\\n    .leaflet-tooltip.custom-tooltip {\\r\\n        background-color: #0f172a !important;\\r\\n        border: 1px solid rgba(255,255,255,0.2) !important;\\r\\n        color: #f8fafc !important;\\r\\n        font-family: ui-sans-serif, system-ui, sans-serif !important;\\r\\n        font-weight: 800 !important;\\r\\n        font-size: 11px !important;\\r\\n        text-transform: uppercase !important;\\r\\n        border-radius: 6px !important;\\r\\n        padding: 5px 10px !important;\\r\\n        box-shadow: 0 4px 15px rgba(0,0,0,0.5) !important;\\r\\n        white-space: nowrap !important;\\r\\n    }\\r\\n    .leaflet-tooltip-top:before { border-top-color: #0f172a !important; }\\r\\n\\r\\n    /* TARJETAS POPUP PRO */\\r\\n    .leaflet-popup-content-wrapper { padding: 0 !important; border-radius: 12px !important; overflow: hidden !important; background: white !important; }\\r\\n    .leaflet-popup-content { margin: 0 !important; width: 300px !important; font-family: ui-sans-serif, system-ui, sans-serif !important; }\\r\\n    \\r\\n    .pop-header { padding: 16px; color: white; position: relative; display: flex; justify-content: space-between; align-items: flex-start; }\\r\\n    .pop-header.normal { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }\\r\\n    .pop-header.alert { background: linear-gradient(135deg, #be123c 0%, #881337 100%); }\\r\\n    \\r\\n    .pop-info { display: flex; align-items: center; gap: 10px; }\\r\\n    .pop-badges { display: flex; gap: 5px; position: absolute; bottom: 12px; right: 12px; }\\r\\n    \\r\\n    .pop-badge { \\r\\n        background: rgba(255,255,255,0.9); color: #334155; \\r\\n        font-size: 9px; font-weight: 800; padding: 3px 8px; \\r\\n        border-radius: 12px; display: flex; align-items: center; gap: 3px;\\r\\n        box-shadow: 0 2px 4px rgba(0,0,0,0.1);\\r\\n    }\\r\\n    .pop-badge.alert { color: #e11d48; background: #fff; }\\r\\n\\r\\n    .pop-body { padding: 16px; max-height: 250px; overflow-y: auto; background: #fff; }\\r\\n    \\r\\n    .pop-address { \\r\\n        font-size: 10px; color: #64748b; margin-bottom: 12px; \\r\\n        display: flex; align-items: center; gap: 4px; background: #f8fafc;\\r\\n        padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0;\\r\\n    }\\r\\n\\r\\n    .pop-row { \\r\\n        background: #fff; border: 1px solid #e2e8f0; border-left-width: 4px; \\r\\n        border-radius: 8px; padding: 10px; margin-bottom: 8px; \\r\\n        box-shadow: 0 1px 2px rgba(0,0,0,0.02); transition: all 0.2s;\\r\\n    }\\r\\n    .pop-row:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }\\r\\n    .pop-row.present { border-left-color: #10b981; }\\r\\n    .pop-row.absent { border-left-color: #94a3b8; opacity: 0.6; background: #f8fafc; }\\r\\n    .pop-row.late { border-left-color: #e11d48; background: #fff1f2; }\\r\\n    .pop-row.expired { border-left-color: #64748b; background: #f1f5f9; opacity: 0.8; }\\r\\n    .pop-row.overdue { border-left-color: #ef4444; background: #fef2f2; animation: pulse-soft 2s infinite; }\\r\\n\\r\\n    .pop-row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }\\r\\n    .pop-name { font-weight: 700; font-size: 12px; color: #334155; display: flex; align-items: center; gap: 5px; }\\r\\n    \\r\\n    .pop-tag { font-size: 8px; padding: 2px 5px; border-radius: 4px; font-weight: bold; color: white; text-transform: uppercase; }\\r\\n    .pop-tag.late { background: #e11d48; }\\r\\n    .pop-tag.on { background: #10b981; }\\r\\n    .pop-tag.exp { background: #64748b; }\\r\\n    .pop-tag.over { background: #ef4444; }\\r\\n\\r\\n    .pop-time { font-size: 10px; color: #64748b; display: flex; align-items: center; gap: 4px; background: #f1f5f9; padding: 3px 6px; border-radius: 4px; width: fit-content; margin-bottom: 10px; }\\r\\n\\r\\n    .pop-actions { display: flex; gap: 6px; }\\r\\n    .pop-btn { \\r\\n        border: none; border-radius: 6px; padding: 8px 10px; \\r\\n        font-size: 10px; font-weight: 700; cursor: pointer; \\r\\n        text-transform: uppercase; color: white; flex: 1; transition: opacity 0.2s;\\r\\n    }\\r\\n    .pop-btn:hover { opacity: 0.9; }\\r\\n    .btn-checkin { background: #4f46e5; }\\r\\n    .btn-checkout { background: #7e22ce; }\\r\\n    .btn-alert { background: #e11d48; }\\r\\n    .btn-nov { background: #fff; color: #475569; border: 1px solid #cbd5e1; flex: 0 0 auto; }\\r\\n    .btn-nov:hover { background: #f1f5f9; }\\r\\n\\r\\n    @keyframes pulse-soft { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }\\r\\n`;"},{"id":"3oeib4z61","name":"OperacionesMap.tsx","path":"apps\\\\web2\\\\src\\\\components\\\\operaciones\\\\OperacionesMap.tsx","area":"FRONTEND","content":"import React, { useEffect } from \'react\';\\nimport { MapContainer, TileLayer, Marker, Popup, useMap } from \'react-leaflet\';\\nimport L from \'leaflet\';\\nimport \'leaflet/dist/leaflet.css\';\\nimport { Building2, User, AlertTriangle, ShieldCheck, ShieldAlert, Clock, Siren, FileWarning } from \'lucide-react\'; // Agregue FileWarning\\n\\nconst iconUrl = \'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png\';\\nconst iconRetinaUrl = \'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png\';\\nconst shadowUrl = \'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png\';\\n\\n/* GENERADOR DE ICONOS DINMICOS */\\nconst createCustomIcon = (status: \'OK\' | \'WARNING\' | \'CRITICAL\' | \'RETENTION\', countPresent: number, countTotal: number) => {\\n    let color = \'#10b981\'; \\n    let shadowColor = \'rgba(16, 185, 129, 0.4)\';\\n    let iconHtml = \'\';\\n    \\n    if (status === \'WARNING\') {\\n        color = \'#f59e0b\'; \\n        shadowColor = \'rgba(245, 158, 11, 0.4)\';\\n    } \\n    else if (status === \'CRITICAL\') {\\n        color = \'#ef4444\'; \\n        shadowColor = \'rgba(239, 68, 68, 0.4)\';\\n        iconHtml = `<div style=\\"position: absolute; top: -5px; right: -5px; background: ${color}; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 2px solid white;\\">!</div>`;\\n    }\\n    else if (status === \'RETENTION\') {\\n        color = \'#f97316\'; \\n        shadowColor = \'rgba(249, 115, 22, 0.5)\';\\n        iconHtml = `<div style=\\"position: absolute; top: -5px; right: -5px; background: ${color}; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; animation: pulse 2s infinite;\\">R</div>`;\\n    }\\n\\n    const html = `\\n    <div style=\\"\\n        background-color: white;\\n        border: 3px solid ${color};\\n        border-radius: 50%;\\n        width: 44px;\\n        height: 44px;\\n        display: flex;\\n        flex-direction: column;\\n        align-items: center;\\n        justify-content: center;\\n        box-shadow: 0 4px 15px ${shadowColor};\\n        font-family: sans-serif;\\n        position: relative;\\n        transition: all 0.3s ease;\\n    \\">\\n        <div style=\\"font-size: 11px; font-weight: 900; color: ${color}; line-height: 1;\\">${countPresent}/${countTotal}</div>\\n        <div style=\\"font-size: 7px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-top: 1px;\\">GRD</div>\\n        ${iconHtml}\\n    </div>`;\\n\\n    return L.divIcon({\\n        html: html,\\n        className: \'custom-map-icon\',\\n        iconSize: [44, 44],\\n        iconAnchor: [22, 44],\\n        popupAnchor: [0, -50]\\n    });\\n};\\n\\nconst RecenterMap = ({ center }: { center: [number, number] }) => {\\n    const map = useMap();\\n    useEffect(() => {\\n        map.setView(center, map.getZoom());\\n    }, [center]);\\n    return null;\\n};\\n\\ninterface Props {\\n    center: [number, number];\\n    objectives: any[];\\n    processedData: any[]; \\n    onAction: (action: string, id: string) => void;\\n    setMapInstance: (map: any) => void;\\n    isExternal?: boolean;\\n    onOpenResolution?: (shift: any) => void;\\n}\\n\\nexport default function OperacionesMap({ center, objectives, processedData, onAction, setMapInstance, isExternal, onOpenResolution }: Props) {\\n    \\n    // LGICA DE AUDITORA EN TIEMPO REAL POR OBJETIVO\\n    const getObjectiveStatus = (objId: string) => {\\n        const now = new Date();\\n        const shifts = processedData.filter(s => s.objectiveId === objId);\\n\\n        // 1. FILTRADO ESTRICTO DE TURNOS ACTIVOS\\n        const currentShiftShifts = shifts.filter(s => {\\n            if (s.status === \'CANCELED\') return false;\\n            \\n            const start = s.shiftDateObj || new Date(s.startTime.seconds * 1000); \\n            const end = s.endDateObj || (s.endTime ? new Date(s.endTime.seconds * 1000) : new Date(start.getTime() + 8*3600*1000));\\n            \\n            return now >= start && now <= end;\\n        });\\n\\n        // 2. DETECCIN DE ESTADOS\\n        const activeShiftsWithFlags = currentShiftShifts.map(s => {\\n            // DETECTAMOS SI ES UN REPORTE YA HECHO\\n            const isReported = s.status === \'UNCOVERED_REPORTED\';\\n            \\n            // SOLO ES \\"SIN ASIGNAR CRTICO\\" SI NO TIENE NOMBRE Y NO FUE REPORTADO\\n            const isUnassigned = (!s.employeeId || s.employeeId === \'VACANTE\' || s.employeeName === \'Sin Asignar\' || s.employeeName === \'Vacante\') && !isReported;\\n            \\n            return { ...s, isUnassigned, isReported };\\n        });\\n\\n        // 3. PROBLEMAS HEREDADOS Y RETENCIONES\\n        const lingeringIssues = shifts.filter(s => {\\n            if (s.status === \'CANCELED\') return false;\\n            const start = s.shiftDateObj;\\n            const end = s.endDateObj;\\n            \\n            if (now >= start && now <= end) return false; \\n\\n            if (s.isRetention && !s.isCompleted) return true;\\n            if (s.isExtraShift && s.isPresent && !s.isCompleted) return true;\\n\\n            const hoursSinceStart = (now.getTime() - start.getTime()) / 3600000;\\n            if ((s.isAbsent || s.isLate) && !s.isCompleted && !s.isPresent && hoursSinceStart < 12) return true;\\n\\n            return false;\\n        });\\n\\n        // Combinar listas\\n        const visibleList = [\\n            ...activeShiftsWithFlags.filter(s => s.isUnassigned), \\n            ...activeShiftsWithFlags.filter(s => !s.isUnassigned), // Aqu铆 van los reportados\\n            ...lingeringIssues\\n        ];\\n\\n        const totalReq = activeShiftsWithFlags.length;\\n        const totalPres = activeShiftsWithFlags.filter(s => s.isPresent && !s.isUnassigned).length;\\n        const totalUnassigned = activeShiftsWithFlags.filter(s => s.isUnassigned).length; // Solo cuenta los NO reportados\\n        \\n        const hasRetention = visibleList.some(s => s.isRetention);\\n        \\n        let status: \'OK\' | \'WARNING\' | \'CRITICAL\' | \'RETENTION\' = \'OK\'; \\n        \\n        // SEMFORO\\n        if (totalUnassigned > 0) {\\n            status = \'CRITICAL\'; // ALERTA ROJA (Solo si no fue reportado)\\n        } else if (hasRetention) {\\n            status = \'RETENTION\'; // NARANJA\\n        } else if (totalReq === 0) {\\n            status = \'OK\'; \\n        } else if (totalPres === 0 && totalReq > 0) {\\n            // Si hay 0 presentes pero fue reportado, caer谩 aqu铆 o en Warning. \\n            // Si fue reportado, NO es CRITICAL por unassigned, pero falta gente.\\n            // Decisi贸n: Si falta gente pero est谩 reportado, es WARNING (Amarillo).\\n            status = \'WARNING\'; \\n        } else if (totalPres < totalReq) {\\n            status = \'WARNING\'; // AMARILLO\\n        }\\n\\n        return {\\n            status,\\n            req: totalReq,\\n            present: totalPres,\\n            missing: Math.max(0, totalReq - totalPres),\\n            guards: visibleList, \\n            absents: visibleList.filter(s => s.isAbsent || s.status === \'ABSENT\')\\n        };\\n    };\\n\\n    return (\\n        <MapContainer \\n            center={center} \\n            zoom={13} \\n            style={{ height: \'100%\', width: \'100%\', background: \'#f8fafc\' }}\\n            ref={setMapInstance} \\n        >\\n            <TileLayer\\n                url=\\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\\"\\n                attribution=\'&copy; <a href=\\"https://www.openstreetmap.org/copyright\\">OSM</a>\'\\n            />\\n            <RecenterMap center={center} />\\n\\n            {objectives.map(obj => {\\n                const audit = getObjectiveStatus(obj.id);\\n                \\n                if (!obj.lat || !obj.lng) return null;\\n\\n                return (\\n                    <Marker \\n                        key={obj.id} \\n                        position={[obj.lat, obj.lng]}\\n                        icon={createCustomIcon(audit.status, audit.present, audit.req)}\\n                    >\\n                        <Popup className=\\"custom-popup\\">\\n                            <div className=\\"min-w-[280px]\\">\\n                                <div className={`p-3 rounded-t-lg flex justify-between items-center ${\\n                                    audit.status === \'OK\' ? \'bg-emerald-600\' : \\n                                    audit.status === \'WARNING\' ? \'bg-amber-500\' : \\n                                    audit.status === \'RETENTION\' ? \'bg-orange-600\' : \'bg-rose-600\'\\n                                }`}>\\n                                    <h3 className=\\"text-white font-black text-sm uppercase flex items-center gap-2\\">\\n                                        <Building2 size={16}/> {obj.name}\\n                                    </h3>\\n                                    <span className=\\"bg-white/20 text-white text-[10px] px-2 py-0.5 rounded font-bold\\">\\n                                        {audit.status === \'OK\' ? \'OK\' : \\n                                         audit.status === \'RETENTION\' ? \'RETENCIN\' :\\n                                         audit.status === \'WARNING\' ? \'PARCIAL\' : \'ALERTA\'}\\n                                    </span>\\n                                </div>\\n\\n                                <div className=\\"grid grid-cols-3 gap-1 p-2 bg-slate-50 border-b border-slate-200\\">\\n                                    <div className=\\"text-center p-1 bg-white rounded border border-slate-200\\">\\n                                        <span className=\\"block text-[10px] font-bold text-slate-400\\">PLAN</span>\\n                                        <span className=\\"block text-lg font-black text-slate-800\\">{audit.req}</span>\\n                                    </div>\\n                                    <div className=\\"text-center p-1 bg-white rounded border border-slate-200\\">\\n                                        <span className=\\"block text-[10px] font-bold text-slate-400\\">PRES</span>\\n                                        <span className=\\"block text-lg font-black text-emerald-600\\">{audit.present}</span>\\n                                    </div>\\n                                    <div className=\\"text-center p-1 bg-white rounded border border-slate-200\\">\\n                                        <span className=\\"block text-[10px] font-bold text-slate-400\\">FALT</span>\\n                                        <span className={`block text-lg font-black ${audit.missing > 0 ? \'text-rose-500 animate-pulse\' : \'text-slate-300\'}`}>{audit.missing}</span>\\n                                    </div>\\n                                </div>\\n\\n                                <div className=\\"p-3 max-h-[200px] overflow-y-auto custom-scrollbar bg-white\\">\\n                                    <p className=\\"text-[10px] font-bold text-slate-400 uppercase mb-2\\">Estado del Equipo Actual:</p>\\n                                    \\n                                    {audit.guards.length === 0 ? (\\n                                        <p className=\\"text-xs text-slate-400 italic text-center py-2\\">Sin turnos programados ahora.</p>\\n                                    ) : (\\n                                        <div className=\\"space-y-2\\">\\n                                            {audit.guards.map((s: any) => (\\n                                                <div key={s.id} className={`flex justify-between items-center border-b border-slate-100 pb-2 last:border-0 ${\\n                                                    s.isUnassigned ? \'bg-red-50 -mx-1 px-1 rounded border-l-2 border-red-500 animate-pulse\' :\\n                                                    s.isReported ? \'bg-amber-50 -mx-1 px-1 rounded border-l-2 border-amber-500\' :\\n                                                    s.isRetention ? \'bg-orange-50 -mx-1 px-1 rounded border-l-2 border-orange-500\' : \\n                                                    s.isExtraShift ? \'bg-indigo-50 -mx-1 px-1 rounded border-l-2 border-indigo-500\' : \'\'\\n                                                }`}>\\n                                                    <div className=\\"flex items-center gap-2 overflow-hidden\\">\\n                                                        <div className={`w-2 h-2 rounded-full shrink-0 ${\\n                                                            s.isUnassigned ? \'bg-red-600\' :\\n                                                            s.isReported ? \'bg-amber-500\' :\\n                                                            s.isRetention ? \'bg-orange-500 animate-pulse\' :\\n                                                            s.isPresent ? \'bg-emerald-500\' : \\n                                                            s.isAbsent ? \'bg-rose-500\' : \'bg-slate-300\'\\n                                                        }`}></div>\\n                                                        <div className=\\"flex flex-col\\">\\n                                                            <span className={`text-xs font-bold truncate max-w-[140px] ${s.isUnassigned ? \'text-red-700\' : s.isReported ? \'text-amber-700\' : \'text-slate-700\'}`}>\\n                                                                {s.isUnassigned ? \'SIN ASIGNAR\' : s.isReported ? \'SIN ASIGNAR (Reportado)\' : s.employeeName}\\n                                                            </span>\\n                                                            <span className=\\"text-[9px] text-slate-400\\">\\n                                                                {new Date(s.startTime.seconds * 1000).toLocaleTimeString([],{hour:\'2-digit\', minute:\'2-digit\'})} - \\n                                                                {s.endTime ? new Date(s.endTime.seconds * 1000).toLocaleTimeString([],{hour:\'2-digit\', minute:\'2-digit\'}) : \'?\'}\\n                                                            </span>\\n                                                            {s.isExtraShift && <span className=\\"text-[8px] font-black text-indigo-600 uppercase\\">DOBLE</span>}\\n                                                        </div>\\n                                                    </div>\\n                                                    \\n                                                    {/* BOTONES DE ACCIN */}\\n                                                    {s.isUnassigned ? (\\n                                                        <button \\n                                                            onClick={() => onOpenResolution && onOpenResolution(s)}\\n                                                            className=\\"text-[9px] bg-red-600 text-white px-2 py-1 rounded shadow-sm hover:bg-red-700 transition-colors uppercase font-black flex items-center gap-1 animate-pulse\\"\\n                                                        >\\n                                                            <AlertTriangle size={10}/> CUBRIR\\n                                                        </button>\\n                                                    ) : s.isReported ? (\\n                                                        <span className=\\"text-[9px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded font-bold uppercase flex items-center gap-1\\">\\n                                                            <FileWarning size={10}/> PLANIF.\\n                                                        </span>\\n                                                    ) : s.isRetention ? (\\n                                                        <button \\n                                                            onClick={() => onOpenResolution && onOpenResolution(s)}\\n                                                            className=\\"text-[9px] bg-orange-600 text-white px-2 py-1 rounded shadow-sm hover:bg-orange-700 transition-colors uppercase font-black flex items-center gap-1 animate-pulse\\"\\n                                                        >\\n                                                            <Clock size={10}/> RESOLVER\\n                                                        </button>\\n                                                    ) : (!s.isPresent && !s.isAbsent) ? (\\n                                                        <button \\n                                                            onClick={() => onOpenResolution && onOpenResolution(s)}\\n                                                            className=\\"text-[9px] bg-rose-50 text-rose-600 px-3 py-1 rounded border border-rose-200 hover:bg-rose-600 hover:text-white transition-colors uppercase font-black\\"\\n                                                        >\\n                                                            GESTIONAR\\n                                                        </button>\\n                                                    ) : s.isAbsent ? (\\n                                                        <span className=\\"text-[9px] bg-rose-100 text-rose-600 px-2 py-0.5 rounded font-bold\\">AUSENTE</span>\\n                                                    ) : (\\n                                                        <span className={`text-[9px] px-2 py-0.5 rounded font-bold ${s.isExtraShift ? \'bg-indigo-100 text-indigo-700\' : \'bg-emerald-100 text-emerald-600\'}`}>\\n                                                            {s.isExtraShift ? \'DOBLE\' : \'OK\'}\\n                                                        </span>\\n                                                    )}\\n                                                </div>\\n                                            ))}\\n                                        </div>\\n                                    )}\\n                                </div>\\n                            </div>\\n                        </Popup>\\n                    </Marker>\\n                );\\n            })}\\n        </MapContainer>\\n    );\\n}"},{"id":"a5mw93ose","name":"RetentionModal.tsx","path":"apps\\\\web2\\\\src\\\\components\\\\operaciones\\\\RetentionModal.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport { Dialog } from \'@headlessui/react\';\\r\\nimport { \\r\\n    X, Clock, UserCheck, ArrowRight, Shield, CalendarClock, User, \\r\\n    Search, Briefcase, Phone, MessageCircle, CheckCircle // IMPORT CORREGIDO\\r\\n} from \'lucide-react\';\\r\\nimport { db } from \'@/lib/firebase\';\\r\\nimport { collection, query, where, getDocs, Timestamp, updateDoc, doc, serverTimestamp, addDoc, orderBy } from \'firebase/firestore\';\\r\\nimport { getAuth } from \'firebase/auth\'; // IMPORT CORREGIDO\\r\\nimport { toast } from \'sonner\';\\r\\n\\r\\n// --- SUBCOMPONENTE: TARJETA UNIFICADA ---\\r\\nconst EmployeeCard = ({ data, actionLabel, onAction, colorClass, type }: any) => {\\r\\n    let displayName = \\"Guardia Desconocido\\";\\r\\n    if (data.employeeName && data.employeeName !== \'undefined undefined\') {\\r\\n        displayName = data.employeeName;\\r\\n    } else if (data.firstName || data.lastName) {\\r\\n        displayName = `${data.lastName || \'\'} ${data.firstName || \'\'}`.trim();\\r\\n    }\\r\\n\\r\\n    const phone = data.phone || \'\';\\r\\n    \\r\\n    let details = \\"\\";\\r\\n    if (type === \'SHIFT\') {\\r\\n        const start = data.startTime ? new Date(data.startTime.seconds * 1000).toLocaleTimeString([], {hour:\'2-digit\', minute:\'2-digit\'}) : \'--:--\';\\r\\n        const end = data.endTime ? new Date(data.endTime.seconds * 1000).toLocaleTimeString([], {hour:\'2-digit\', minute:\'2-digit\'}) : \'Indef.\';\\r\\n        details = `${start} - ${end}`;\\r\\n    } else {\\r\\n        details = \\"Disponible\\";\\r\\n    }\\r\\n\\r\\n    return (\\r\\n        <div className={`flex flex-col p-3 border rounded-xl bg-white hover:shadow-md transition-all group ${type === \'SHIFT\' ? \'border-l-4 border-l-indigo-500\' : \'border-l-4 border-l-emerald-500\'}`}>\\r\\n            <div className=\\"flex justify-between items-start mb-2\\">\\r\\n                <div className=\\"flex items-center gap-3 overflow-hidden\\">\\r\\n                    <div className={`p-2 rounded-lg ${colorClass} bg-opacity-10 text-opacity-100`}>\\r\\n                        <User size={18}/>\\r\\n                    </div>\\r\\n                    <div className=\\"min-w-0\\">\\r\\n                        <p className=\\"font-bold text-sm text-slate-800 truncate\\">{displayName}</p>\\r\\n                        <div className=\\"flex items-center gap-2 text-[10px] text-slate-500\\">\\r\\n                            {type === \'SHIFT\' ? <Clock size={10}/> : <CheckCircle size={10}/>}\\r\\n                            <span>{details}</span>\\r\\n                        </div>\\r\\n                    </div>\\r\\n                </div>\\r\\n                \\r\\n                {phone && (\\r\\n                    <div className=\\"flex gap-1\\">\\r\\n                        <button onClick={() => window.open(`tel:${phone}`)} className=\\"p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded transition-colors\\" title=\\"Llamar\\"><Phone size={14}/></button>\\r\\n                        <button onClick={() => window.open(`https://wa.me/${phone.replace(/[^0-9]/g,\'\')}`, \'_blank\')} className=\\"p-1.5 text-emerald-500 hover:text-emerald-700 hover:bg-emerald-50 rounded transition-colors\\" title=\\"WhatsApp\\"><MessageCircle size={14}/></button>\\r\\n                    </div>\\r\\n                )}\\r\\n            </div>\\r\\n\\r\\n            {onAction && (\\r\\n                <button \\r\\n                    onClick={() => onAction(data)}\\r\\n                    className={`w-full text-[10px] font-bold uppercase py-1.5 rounded-lg border transition-all ${colorClass} bg-opacity-5 border-opacity-20 hover:bg-opacity-100 hover:text-white border-current mt-1`}\\r\\n                >\\r\\n                    {actionLabel}\\r\\n                </button>\\r\\n            )}\\r\\n        </div>\\r\\n    );\\r\\n};\\r\\n\\r\\ninterface Props {\\r\\n    isOpen: boolean;\\r\\n    onClose: () => void;\\r\\n    retainedShift: any; \\r\\n    onResolve: () => void;\\r\\n}\\r\\n\\r\\nexport default function RetentionModal({ isOpen, onClose, retainedShift, onResolve }: Props) {\\r\\n    const [step, setStep] = useState<\'SELECT_ACTION\' | \'SELECT_RELIEF\'>(\'SELECT_ACTION\');\\r\\n    const [loading, setLoading] = useState(false);\\r\\n    \\r\\n    const [nextShiftCandidates, setNextShiftCandidates] = useState<any[]>([]);\\r\\n    const [otherCandidates, setOtherCandidates] = useState<any[]>([]); \\r\\n    const [filteredOthers, setFilteredOthers] = useState<any[]>([]); \\r\\n    const [searchTerm, setSearchTerm] = useState(\'\');\\r\\n\\r\\n    useEffect(() => {\\r\\n        if (isOpen) {\\r\\n            setStep(\'SELECT_ACTION\');\\r\\n            setSearchTerm(\'\');\\r\\n            loadReliefCandidates();\\r\\n        }\\r\\n    }, [isOpen, retainedShift]);\\r\\n\\r\\n    useEffect(() => {\\r\\n        if (!searchTerm) {\\r\\n            setFilteredOthers(otherCandidates);\\r\\n        } else {\\r\\n            const lower = searchTerm.toLowerCase();\\r\\n            setFilteredOthers(otherCandidates.filter(e => \\r\\n                (e.lastName + \' \' + e.firstName).toLowerCase().includes(lower) || \\r\\n                (e.fileNumber && e.fileNumber.includes(lower))\\r\\n            ));\\r\\n        }\\r\\n    }, [searchTerm, otherCandidates]);\\r\\n\\r\\n    // --- AUDITORA ---\\r\\n    const logAudit = async (action: string, details: string) => {\\r\\n        try {\\r\\n            const auth = getAuth();\\r\\n            const user = auth.currentUser;\\r\\n            await addDoc(collection(db, \'audit_logs\'), {\\r\\n                timestamp: serverTimestamp(),\\r\\n                actorUid: user?.uid || \'system\',\\r\\n                actorName: user?.displayName || user?.email || \'Operador\',\\r\\n                module: \'OPERACIONES\',\\r\\n                action: action,\\r\\n                details: details,\\r\\n                targetShiftId: retainedShift.id,\\r\\n                targetEmployee: retainedShift.employeeName,\\r\\n                clientName: retainedShift.clientName\\r\\n            });\\r\\n        } catch(e) { console.error(e); }\\r\\n    };\\r\\n\\r\\n    const loadReliefCandidates = async () => {\\r\\n        try {\\r\\n            const now = new Date();\\r\\n            \\r\\n            const qNext = query(\\r\\n                collection(db, \'turnos\'),\\r\\n                where(\'objectiveId\', \'==\', retainedShift.objectiveId),\\r\\n                where(\'startTime\', \'>=\', Timestamp.fromDate(now)), \\r\\n                orderBy(\'startTime\', \'asc\') \\r\\n            );\\r\\n\\r\\n            const qEmp = query(collection(db, \'empleados\'), where(\'status\', \'==\', \'activo\'));\\r\\n\\r\\n            const [nextShiftsSnap, empSnap] = await Promise.all([getDocs(qNext), getDocs(qEmp)]);\\r\\n\\r\\n            const allEmployees = empSnap.docs.map(d => ({ id: d.id, ...(d.data() as any) }));\\r\\n            \\r\\n            const scheduledEmployeeIds = new Set();\\r\\n            const scheduledDataMap = new Map(); \\r\\n\\r\\n            nextShiftsSnap.docs.forEach(d => {\\r\\n                const data = d.data();\\r\\n                if (!scheduledEmployeeIds.has(data.employeeId)) {\\r\\n                    scheduledEmployeeIds.add(data.employeeId);\\r\\n                    scheduledDataMap.set(data.employeeId, {\\r\\n                        startTime: data.startTime.toDate(),\\r\\n                        shiftName: getShiftName(data.startTime.toDate())\\r\\n                    });\\r\\n                }\\r\\n            });\\r\\n\\r\\n            const priorityList: any[] = [];\\r\\n            const othersList: any[] = [];\\r\\n\\r\\n            allEmployees.forEach((emp: any) => {\\r\\n                if (emp.id === retainedShift.employeeId) return;\\r\\n\\r\\n                if (scheduledEmployeeIds.has(emp.id)) {\\r\\n                    const scheduleInfo = scheduledDataMap.get(emp.id);\\r\\n                    priorityList.push({\\r\\n                        ...emp,\\r\\n                        nextShiftTime: scheduleInfo.startTime,\\r\\n                        shiftLabel: scheduleInfo.shiftName\\r\\n                    });\\r\\n                } else {\\r\\n                    othersList.push(emp);\\r\\n                }\\r\\n            });\\r\\n\\r\\n            priorityList.sort((a, b) => a.nextShiftTime - b.nextShiftTime);\\r\\n\\r\\n            setNextShiftCandidates(priorityList);\\r\\n            setOtherCandidates(othersList);\\r\\n            setFilteredOthers(othersList); \\r\\n\\r\\n        } catch (e) {\\r\\n            console.error(e);\\r\\n            toast.error(\\"Error cargando lista de relevos\\");\\r\\n        }\\r\\n    };\\r\\n\\r\\n    const getShiftName = (date: Date) => {\\r\\n        const h = date.getHours();\\r\\n        if (h >= 6 && h < 14) return \'Turno Ma帽ana\';\\r\\n        if (h >= 14 && h < 22) return \'Turno Tarde\';\\r\\n        return \'Turno Noche\';\\r\\n    };\\r\\n\\r\\n    const handleCall = (phone: string) => {\\r\\n        if (!phone) return toast.error(\\"Sin tel茅fono registrado\\");\\r\\n        window.open(`tel:${phone}`, \'_self\');\\r\\n    };\\r\\n\\r\\n    const handleWhatsApp = (phone: string) => {\\r\\n        if (!phone) return toast.error(\\"Sin tel茅fono registrado\\");\\r\\n        const cleanPhone = phone.replace(/[^0-9]/g, \'\'); \\r\\n        window.open(`https://wa.me/${cleanPhone}`, \'_blank\');\\r\\n    };\\r\\n\\r\\n    // --- ACCIN A: DOBLE TURNO ---\\r\\n    const handleFullCoverage = async () => {\\r\\n        if(!confirm(`驴Confirmar DOBLE JORNADA para ${retainedShift.employeeName}?`)) return;\\r\\n        setLoading(true);\\r\\n        try {\\r\\n            const baseTime = retainedShift.endTime ? retainedShift.endTime.toDate().getTime() : new Date().getTime();\\r\\n            const newEndTime = new Date(baseTime + (8 * 3600 * 1000)); \\r\\n\\r\\n            await updateDoc(doc(db, \'turnos\', retainedShift.id), {\\r\\n                endTime: Timestamp.fromDate(newEndTime),\\r\\n                isRetention: false, \\r\\n                isExtraShift: true, // FLAG AGREGADO\\r\\n                status: \'PRESENT\',  \\r\\n                comments: \'Cobertura de turno completo (Resoluci贸n de Retenci贸n)\',\\r\\n                resolutionStatus: \'RESOLVED\'\\r\\n            });\\r\\n\\r\\n            await logAudit(\'RETENCION_DOBLE_TURNO\', `Guardia ${retainedShift.employeeName} extendi贸 a doble turno.`);\\r\\n\\r\\n            toast.success(\\"Turno extendido (Doble Jornada).\\");\\r\\n            onResolve();\\r\\n        } catch (e) { toast.error(\\"Error al extender turno\\"); }\\r\\n        finally { setLoading(false); }\\r\\n    };\\r\\n\\r\\n    // --- ACCIN B: RELEVO ---\\r\\n    const handleReliefArrival = async (reliefEmployee: any, isScheduled: boolean) => {\\r\\n        if(!confirm(`驴CONFIRMAR RELEVO?\\\\n\\\\nEntra: ${reliefEmployee.lastName}\\\\nSale: ${retainedShift.employeeName}`)) return;\\r\\n        setLoading(true);\\r\\n        try {\\r\\n            const now = new Date();\\r\\n\\r\\n            // 1. Cerrar Retenci贸n\\r\\n            await updateDoc(doc(db, \'turnos\', retainedShift.id), {\\r\\n                status: \'COMPLETED\',\\r\\n                isCompleted: true,\\r\\n                isRetention: false,\\r\\n                realEndTime: serverTimestamp(),\\r\\n                checkoutNote: `Relevado por ${reliefEmployee.lastName}`\\r\\n            });\\r\\n\\r\\n            // 2. Crear Turno del Relevo\\r\\n            const estimatedEnd = new Date(now.getTime() + (8 * 3600 * 1000)); \\r\\n\\r\\n            await addDoc(collection(db, \'turnos\'), {\\r\\n                employeeId: reliefEmployee.id,\\r\\n                employeeName: `${reliefEmployee.lastName}, ${reliefEmployee.firstName}`,\\r\\n                clientId: retainedShift.clientId,\\r\\n                clientName: retainedShift.clientName,\\r\\n                objectiveId: retainedShift.objectiveId,\\r\\n                objectiveName: retainedShift.objectiveName,\\r\\n                startTime: serverTimestamp(),\\r\\n                endTime: Timestamp.fromDate(estimatedEnd),\\r\\n                status: \'PRESENT\',\\r\\n                isPresent: true,\\r\\n                isRelief: true, // FLAG AGREGADO\\r\\n                comments: `Relevo de ${retainedShift.employeeName} ${isScheduled ? \'(Programado)\' : \'(Cobertura)\'}`\\r\\n            });\\r\\n\\r\\n            await logAudit(\'RETENCION_RELEVO\', `Relevo asignado: ${reliefEmployee.lastName} libera a ${retainedShift.employeeName}.`);\\r\\n\\r\\n            toast.success(`Relevo registrado exitosamente.`);\\r\\n            onResolve();\\r\\n        } catch (e) { toast.error(\\"Error al procesar relevo\\"); }\\r\\n        finally { setLoading(false); }\\r\\n    };\\r\\n\\r\\n    if (!isOpen) return null;\\r\\n\\r\\n    return (\\r\\n        <div className=\\"fixed inset-0 z-[9000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in\\">\\r\\n            <div className=\\"bg-white dark:bg-slate-900 w-full max-w-3xl rounded-3xl shadow-2xl overflow-hidden border dark:border-slate-800 flex flex-col max-h-[85vh]\\">\\r\\n                <div className=\\"bg-orange-50 dark:bg-orange-900/20 p-5 border-b border-orange-100 dark:border-orange-800 flex justify-between items-center shrink-0\\">\\r\\n                    <div>\\r\\n                        <h3 className=\\"font-black text-orange-700 dark:text-orange-400 flex items-center gap-2 text-lg\\"><Clock className=\\"animate-pulse\\" size={24}/> FINALIZAR RETENCIN</h3>\\r\\n                        <p className=\\"text-sm text-orange-600/70 dark:text-orange-300/70 mt-1\\">Contacte al relevo antes de asignarlo.</p>\\r\\n                    </div>\\r\\n                    <button onClick={onClose} className=\\"p-2 hover:bg-orange-100 rounded-full transition-colors\\"><X size={24} className=\\"text-orange-400 hover:text-orange-600\\"/></button>\\r\\n                </div>\\r\\n                <div className=\\"p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-50 dark:bg-slate-950\\">\\r\\n                    {step === \'SELECT_ACTION\' ? (\\r\\n                        <>\\r\\n                            <div className=\\"mb-6 bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between\\">\\r\\n                                <div className=\\"flex items-center gap-4\\"><div className=\\"bg-orange-100 p-3 rounded-xl text-orange-600\\"><User size={24}/></div><div><p className=\\"text-xs text-slate-400 uppercase font-bold\\">Guardia Retenido</p><p className=\\"text-lg font-black text-slate-800 dark:text-white\\">{retainedShift.employeeName}</p></div></div>\\r\\n                                <span className=\\"bg-orange-100 text-orange-700 px-3 py-1 rounded-lg text-xs font-bold animate-pulse\\">EN ESPERA</span>\\r\\n                            </div>\\r\\n                            <div className=\\"grid grid-cols-1 md:grid-cols-2 gap-4\\">\\r\\n                                <button onClick={() => setStep(\'SELECT_RELIEF\')} className=\\"p-6 bg-white dark:bg-slate-800 border-2 border-indigo-100 hover:border-indigo-500 rounded-2xl flex flex-col items-center gap-4 shadow-sm hover:shadow-xl\\"><div className=\\"bg-indigo-100 p-4 rounded-full text-indigo-600\\"><UserCheck size={32}/></div><div><p className=\\"font-bold text-lg text-slate-800 dark:text-white\\">Buscar Relevo</p><p className=\\"text-sm text-slate-500 dark:text-slate-400\\">Contactar personal.</p></div><div className=\\"mt-2 text-indigo-500 font-bold text-xs uppercase flex items-center gap-1\\">Ver Lista <ArrowRight size={12}/></div></button>\\r\\n                                <button onClick={handleFullCoverage} disabled={loading} className=\\"p-6 bg-white dark:bg-slate-800 border-2 border-emerald-100 hover:border-emerald-500 rounded-2xl flex flex-col items-center gap-4 shadow-sm hover:shadow-xl\\"><div className=\\"bg-emerald-100 p-4 rounded-full text-emerald-600\\"><Shield size={32}/></div><div><p className=\\"font-bold text-lg text-slate-800 dark:text-white\\">Doble Turno</p><p className=\\"text-sm text-slate-500 dark:text-slate-400\\">Extender horario actual.</p></div><div className=\\"mt-2 text-emerald-500 font-bold text-xs uppercase flex items-center gap-1\\">Confirmar <ArrowRight size={12}/></div></button>\\r\\n                            </div>\\r\\n                        </>\\r\\n                    ) : (\\r\\n                        <div className=\\"space-y-6\\">\\r\\n                            <div><p className=\\"text-xs font-black text-indigo-600 dark:text-indigo-400 uppercase mb-3 flex items-center gap-2\\"><CalendarClock size={16}/> Sugeridos (Pr贸ximos Turnos)</p><div className=\\"grid grid-cols-1 md:grid-cols-2 gap-3\\">{nextShiftCandidates.length === 0 ? <div className=\\"col-span-full text-sm text-slate-400 italic p-4 border border-dashed rounded-xl text-center\\">Sin sugerencias.</div> : nextShiftCandidates.map(emp => <EmployeeCard key={emp.id} data={emp} type=\\"SHIFT\\" actionLabel=\\"ASIGNAR\\" colorClass=\\"text-indigo-600 border-indigo-200 bg-indigo-50\\" onAction={(e:any) => handleReliefArrival(e, true)} />)}</div></div>\\r\\n                            <hr className=\\"border-slate-200 dark:border-slate-700\\"/>\\r\\n                            <div className=\\"flex flex-col h-[350px]\\"><div className=\\"flex justify-between items-center mb-3\\"><p className=\\"text-xs font-black text-slate-500 dark:text-slate-400 uppercase\\">Otros Disponibles</p><div className=\\"relative w-1/2 md:w-1/3\\"><Search className=\\"absolute left-3 top-2.5 text-slate-400\\" size={14}/><input className=\\"w-full pl-9 pr-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-xs outline-none focus:ring-2 focus:ring-indigo-500\\" placeholder=\\"Buscar...\\" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}/></div></div><div className=\\"flex-1 overflow-y-auto custom-scrollbar\\">{filteredOthers.length === 0 ? <div className=\\"text-center py-10 text-sm text-slate-400 italic\\">No se encontraron resultados.</div> : <div className=\\"grid grid-cols-1 md:grid-cols-2 gap-3\\">{filteredOthers.slice(0, 40).map(emp => <EmployeeCard key={emp.id} data={emp} type=\\"EMPLOYEE\\" actionLabel=\\"ASIGNAR\\" colorClass=\\"text-emerald-600 border-emerald-200 bg-emerald-50\\" onAction={(e:any) => handleReliefArrival(e, false)} />)}</div>}</div></div>\\r\\n                            <button onClick={() => setStep(\'SELECT_ACTION\')} className=\\"text-xs font-bold text-slate-400 hover:text-slate-600 underline w-full text-center pt-2\\">Volver</button>\\r\\n                        </div>\\r\\n                    )}\\r\\n                </div>\\r\\n            </div>\\r\\n        </div>\\r\\n    );\\r\\n}"},{"id":"qoss7r3sr","name":"modules.ts","path":"apps\\\\web2\\\\src\\\\config\\\\modules.ts","area":"FRONTEND","content":"export const SYSTEM_MODULES = [\\n    { key: \'DASHBOARD\', label: \' Dashboard Principal\' },\\n    { key: \'PLANNING\', label: \' Planificaci贸n y Turnos\' },\\n    { key: \'RRHH\', label: \' RRHH y Legajos\' },\\n    { key: \'CLIENTS\', label: \' Clientes y Objetivos\' },\\n    { key: \'REPORTS\', label: \' Reportes y Liquidaci贸n\' },\\n    { key: \'CONFIG\', label: \'锔 Configuraci贸n Global\' }\\n];\\n\\nexport const PERMISSION_ACTIONS = [\\n    { key: \'read\', label: \'Ver\' },\\n    { key: \'create\', label: \'Crear\' },\\n    { key: \'update\', label: \'Editar\' },\\n    { key: \'delete\', label: \'Borrar\' }\\n];"},{"id":"yexxljr1j","name":"AuthContext.tsx","path":"apps\\\\web2\\\\src\\\\context\\\\AuthContext.tsx","area":"FRONTEND","content":"\\nimport React, { createContext, useContext, useEffect, useState } from \'react\';\\nimport { onAuthStateChanged, User, setPersistence, browserLocalPersistence, signOut } from \'firebase/auth\';\\nimport { auth } from \'@/lib/firebase\';\\nimport { useRouter } from \'next/router\';\\n\\ninterface AuthContextType {\\n  user: User | null;\\n  loading: boolean;\\n  logout: () => Promise<void>;\\n}\\n\\nconst AuthContext = createContext<AuthContextType>({ user: null, loading: true, logout: async () => {} });\\nexport const useAuth = () => useContext(AuthContext);\\n\\nexport const AuthProvider = ({ children }: { children: React.ReactNode }) => {\\n  const [user, setUser] = useState<User | null>(null);\\n  const [loading, setLoading] = useState(true);\\n  const router = useRouter();\\n\\n  useEffect(() => {\\n    // 1. Forzar persistencia LOCAL (sobrevive al refresh)\\n    setPersistence(auth, browserLocalPersistence).catch(e => console.error(\\"Error persistencia:\\", e));\\n\\n    // 2. Escuchar cambios\\n    const unsub = onAuthStateChanged(auth, (u) => {\\n      console.log(\\"Auth State:\\", u ? \\"LOGGED IN\\" : \\"LOGGED OUT\\");\\n      setUser(u);\\n      setLoading(false);\\n    });\\n    return () => unsub();\\n  }, []);\\n\\n  const logout = async () => {\\n    await signOut(auth);\\n    router.push(\'/login\');\\n  };\\n\\n  return <AuthContext.Provider value={{ user, loading, logout }}>{children}</AuthContext.Provider>;\\n};\\n"},{"id":"b4cot7tjq","name":"SettingsContext.tsx","path":"apps\\\\web2\\\\src\\\\context\\\\SettingsContext.tsx","area":"FRONTEND","content":"import React, { createContext, useContext, useState, useEffect } from \'react\';\\n\\ninterface SettingsContextType {\\n  timezone: string;\\n  setTimezone: (tz: string) => void;\\n  locale: string;\\n}\\n\\nconst defaultSettings = {\\n  timezone: \'America/Argentina/Buenos_Aires\', // Valor por defecto\\n  locale: \'es-AR\'\\n};\\n\\nconst SettingsContext = createContext<SettingsContextType | undefined>(undefined);\\n\\nexport function SettingsProvider({ children }: { children: React.ReactNode }) {\\n  const [timezone, setTimezoneState] = useState(defaultSettings.timezone);\\n\\n  // Al iniciar, buscamos si hay algo guardado en el navegador\\n  useEffect(() => {\\n    const saved = localStorage.getItem(\'app_timezone\');\\n    if (saved) setTimezoneState(saved);\\n  }, []);\\n\\n  // Funci贸n para guardar el cambio\\n  const setTimezone = (tz: string) => {\\n    setTimezoneState(tz);\\n    localStorage.setItem(\'app_timezone\', tz);\\n  };\\n\\n  return (\\n    <SettingsContext.Provider value={{ timezone, setTimezone, locale: defaultSettings.locale }}>\\n      {children}\\n    </SettingsContext.Provider>\\n  );\\n}\\n\\n// Hook para usar esto en cualquier parte de la app\\nexport function useSettings() {\\n  const context = useContext(SettingsContext);\\n  if (context === undefined) {\\n    throw new Error(\'useSettings debe usarse dentro de un SettingsProvider\');\\n  }\\n  return context;\\n}\\n"},{"id":"327s1iqum","name":"ThemeContext.tsx","path":"apps\\\\web2\\\\src\\\\context\\\\ThemeContext.tsx","area":"FRONTEND","content":"\\nimport React, { createContext, useContext, useEffect, useState } from \'react\';\\n\\n// Definimos los 5 temas\\nexport type Theme = \'enterprise\' | \'tactical\' | \'midnight\' | \'oled\' | \'modern\';\\n\\ninterface ThemeContextType {\\n  theme: Theme;\\n  toggleTheme: (theme: Theme) => void;\\n}\\n\\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\\n\\nexport const ThemeProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\\n  const [theme, setTheme] = useState<Theme>(\'enterprise\');\\n\\n  useEffect(() => {\\n    const savedTheme = localStorage.getItem(\'theme\') as Theme;\\n    if (savedTheme) {\\n      setTheme(savedTheme);\\n      applyTheme(savedTheme);\\n    } else {\\n      const prefersDark = window.matchMedia(\'(prefers-color-scheme: dark)\').matches;\\n      const defaultTheme = prefersDark ? \'tactical\' : \'enterprise\';\\n      setTheme(defaultTheme);\\n      applyTheme(defaultTheme);\\n    }\\n  }, []);\\n\\n  const applyTheme = (t: Theme) => {\\n    const root = window.document.documentElement;\\n    root.classList.remove(\'light\', \'dark\', \'enterprise\', \'tactical\', \'midnight\', \'oled\', \'modern\');\\n    \\n    root.classList.add(t);\\n\\n    // Modern es un tema CLARO (\'light\'), los otros 3 son OSCUROS (\'dark\')\\n    if ([\'tactical\', \'midnight\', \'oled\'].includes(t)) {\\n      root.classList.add(\'dark\');\\n    } else {\\n      root.classList.add(\'light\');\\n    }\\n\\n    localStorage.setItem(\'theme\', t);\\n  };\\n\\n  const toggleTheme = (t: Theme) => {\\n    setTheme(t);\\n    applyTheme(t);\\n  };\\n\\n  return (\\n    <ThemeContext.Provider value={{ theme, toggleTheme }}>\\n      {children}\\n    </ThemeContext.Provider>\\n  );\\n};\\n\\nexport const useTheme = () => {\\n  const context = useContext(ThemeContext);\\n  if (!context) throw new Error(\'useTheme debe usarse dentro de un ThemeProvider\');\\n  return context;\\n};\\n"},{"id":"9uf5w1j47","name":"ToastContext.tsx","path":"apps\\\\web2\\\\src\\\\context\\\\ToastContext.tsx","area":"FRONTEND","content":"\\nimport React, { createContext, useContext, useState, useCallback } from \'react\';\\nimport { CheckCircle, AlertCircle, Info, X } from \'lucide-react\';\\n\\ntype ToastType = \'success\' | \'error\' | \'info\';\\n\\ninterface Toast {\\n  id: number;\\n  message: string;\\n  type: ToastType;\\n}\\n\\ninterface ToastContextType {\\n  addToast: (message: string, type?: ToastType) => void;\\n}\\n\\nconst ToastContext = createContext<ToastContextType | undefined>(undefined);\\n\\nexport const ToastProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\\n  const [toasts, setToasts] = useState<Toast[]>([]);\\n\\n  const addToast = useCallback((message: string, type: ToastType = \'info\') => {\\n    const id = Date.now();\\n    setToasts((prev) => [...prev, { id, message, type }]);\\n    setTimeout(() => {\\n      setToasts((prev) => prev.filter((t) => t.id !== id));\\n    }, 3000);\\n  }, []);\\n\\n  const removeToast = (id: number) => {\\n    setToasts((prev) => prev.filter((t) => t.id !== id));\\n  };\\n\\n  return (\\n    <ToastContext.Provider value={{ addToast }}>\\n      {children}\\n      <div className=\\"fixed bottom-6 right-6 z-[9999] flex flex-col gap-3 pointer-events-none\\">\\n        {toasts.map((toast) => (\\n          <div \\n            key={toast.id} \\n            className={`\\n              pointer-events-auto flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl transform transition-all duration-300 animate-in slide-in-from-right-10 fade-in\\n              ${toast.type === \'success\' ? \'bg-white dark:bg-slate-800 border-l-4 border-emerald-500\' : \'\'}\\n              ${toast.type === \'error\' ? \'bg-white dark:bg-slate-800 border-l-4 border-rose-500\' : \'\'}\\n              ${toast.type === \'info\' ? \'bg-white dark:bg-slate-800 border-l-4 border-indigo-500\' : \'\'}\\n            `}\\n          >\\n            <div className=\\"shrink-0\\">\\n              {toast.type === \'success\' && <CheckCircle className=\\"text-emerald-500\\" size={20} />}\\n              {toast.type === \'error\' && <AlertCircle className=\\"text-rose-500\\" size={20} />}\\n              {toast.type === \'info\' && <Info className=\\"text-indigo-500\\" size={20} />}\\n            </div>\\n            <p className=\\"font-bold text-sm text-slate-700 dark:text-slate-200\\">{toast.message}</p>\\n            <button onClick={() => removeToast(toast.id)} className=\\"ml-4 text-slate-400 hover:text-slate-600 dark:hover:text-white\\">\\n              <X size={14} />\\n            </button>\\n          </div>\\n        ))}\\n      </div>\\n    </ToastContext.Provider>\\n  );\\n};\\n\\nexport const useToast = () => {\\n  const context = useContext(ToastContext);\\n  if (!context) throw new Error(\'useToast debe usarse dentro de un ToastProvider\');\\n  return context;\\n};\\n"},{"id":"v4ju1w3kj","name":"useOperacionesMonitor.ts","path":"apps\\\\web2\\\\src\\\\hooks\\\\useOperacionesMonitor.ts","area":"FRONTEND","content":"import { useState, useEffect, useMemo } from \'react\';\\nimport { collection, query, where, onSnapshot, orderBy, limit, Timestamp, addDoc, updateDoc, doc, serverTimestamp } from \'firebase/firestore\';\\nimport { db } from \'@/lib/firebase\';\\nimport { toast } from \'sonner\';\\n\\n// --- HELPER PARA FECHAS SEGURAS ---\\nconst getSafeDate = (val: any) => {\\n    if (!val) return null;\\n    if (val.toDate && typeof val.toDate === \'function\') return val.toDate(); // Firestore Timestamp\\n    if (val instanceof Date) return val; // Objeto Date nativo\\n    if (typeof val === \'string\' || typeof val === \'number\') return new Date(val); // ISO String o Timestamp number\\n    return null;\\n};\\n\\nexport const useOperacionesMonitor = () => {\\n    const [now, setNow] = useState(new Date());\\n    const [rawShifts, setRawShifts] = useState<any[]>([]);\\n    const [employees, setEmployees] = useState<any[]>([]);\\n    const [objectives, setObjectives] = useState<any[]>([]);\\n    const [recentLogs, setRecentLogs] = useState<any[]>([]);\\n    \\n    // Filtros y UI State\\n    // MODIFICADO: Agregamos \'AUSENTES\'\\n    const [viewTab, setViewTab] = useState<\'PRIORIDAD\' | \'ACTIVOS\' | \'AUSENTES\' | \'HOY\'>(\'PRIORIDAD\');\\n    const [filterText, setFilterText] = useState(\'\');\\n    const [isCompact, setIsCompact] = useState(false);\\n    \\n    // Modales y Acciones\\n    const [modals, setModals] = useState({ checkout: false, novedad: false, coverage: false });\\n    const [processingId, setProcessingId] = useState<string | null>(null);\\n    const [checkoutData, setCheckoutData] = useState({ type: \'NORMAL\', note: \'\' });\\n    const [novedadData, setNovedadData] = useState({ tipo: \'Llegada Tarde\', nota: \'\' });\\n    const [coverageSearch, setCoverageSearch] = useState(\'\');\\n    \\n    // Datos para l贸gica de cobertura (RESTITUIDOS)\\n    const [absentShiftData, setAbsentShiftData] = useState<any>(null); \\n    const [adjacentShifts, setAdjacentShifts] = useState<{prev: any, next: any}>({ prev: null, next: null });\\n    const [isExtensionApplied, setIsExtensionApplied] = useState(false);\\n\\n    const NOVEDAD_TYPES = [\'Llegada Tarde\', \'Ausencia con Aviso\', \'Ausencia sin Aviso\', \'Uniforme Incompleto\', \'Problema de Salud\', \'Siniestro/Robo\', \'Otro\'];\\n\\n    // 1. RELOJ CENTRAL\\n    useEffect(() => {\\n        const timer = setInterval(() => setNow(new Date()), 30000); \\n        return () => clearInterval(timer);\\n    }, []);\\n\\n    // 2. CARGA DE DATOS MAESTROS\\n    useEffect(() => {\\n        const unsubEmp = onSnapshot(collection(db, \'empleados\'), snap => {\\n            setEmployees(snap.docs.map(d => ({ id: d.id, fullName: `${d.data().lastName} ${d.data().firstName}`, ...d.data() })));\\n        });\\n        \\n        const unsubObj = onSnapshot(collection(db, \'clients\'), snap => {\\n            const objs: any[] = [];\\n            snap.docs.forEach(d => {\\n                const c = d.data();\\n                if (c.objetivos) {\\n                    c.objetivos.forEach((o: any) => objs.push({ ...o, clientName: c.name, clientId: d.id }));\\n                }\\n            });\\n            setObjectives(objs);\\n        });\\n\\n        // Cargar Logs Recientes\\n        const qLogs = query(collection(db, \'audit_logs\'), orderBy(\'timestamp\', \'desc\'), limit(50));\\n        const unsubLogs = onSnapshot(qLogs, snap => {\\n            setRecentLogs(snap.docs.map(d => {\\n                const data = d.data();\\n                return {\\n                    id: d.id,\\n                    time: getSafeDate(data.timestamp),\\n                    type: data.action || \'SISTEMA\',\\n                    emp: data.actorName || \'Sistema\',\\n                    title: data.module || \'General\',\\n                    desc: data.details || \'\'\\n                };\\n            }));\\n        });\\n\\n        return () => { unsubEmp(); unsubObj(); unsubLogs(); };\\n    }, []);\\n\\n    // 3. CARGA DE TURNOS (HOY +/- 24hs)\\n    useEffect(() => {\\n        const start = new Date(); start.setHours(0,0,0,0); start.setDate(start.getDate() - 1);\\n        const end = new Date(); end.setHours(23,59,59,999); end.setDate(end.getDate() + 1);\\n\\n        const q = query(collection(db, \'turnos\'), where(\'startTime\', \'>=\', Timestamp.fromDate(start)), where(\'startTime\', \'<=\', Timestamp.fromDate(end)));\\n        \\n        const unsub = onSnapshot(q, (snap) => {\\n            const shifts = snap.docs.map(d => {\\n                const data = d.data();\\n                const startObj = getSafeDate(data.startTime);\\n                const endObj = getSafeDate(data.endTime); \\n                \\n                if (!startObj) return null;\\n\\n                const visualEndObj = endObj || new Date(startObj.getTime() + (8 * 3600000));\\n\\n                const emp = employees.find(e => e.id === data.employeeId);\\n                const obj = objectives.find(o => o.id === data.objectiveId || o.name === data.objectiveName);\\n\\n                return {\\n                    id: d.id,\\n                    ...data,\\n                    shiftDateObj: startObj,\\n                    endDateObj: endObj, \\n                    visualEndDateObj: visualEndObj, \\n                    employeeName: emp ? emp.fullName : \'Sin Asignar\',\\n                    clientName: obj ? obj.clientName : \'Cliente\',\\n                    objectiveName: obj ? obj.name : (data.objectiveName || \'Objetivo\'),\\n                    phone: emp?.phone || \'\'\\n                };\\n            }).filter(Boolean); \\n            \\n            setRawShifts(shifts);\\n        });\\n\\n        return () => unsub();\\n    }, [employees, objectives]); \\n\\n    // 4. PROCESAMIENTO DE ESTADOS\\n    const processedData = useMemo(() => {\\n        return rawShifts.map(shift => {\\n            const shiftStart = shift.shiftDateObj.getTime();\\n            const shiftEnd = shift.visualEndDateObj.getTime();\\n            const nowTime = now.getTime();\\n\\n            const TOLERANCE_MINUTES = 15; \\n            const minutesLate = (nowTime - shiftStart) / 60000;\\n            const minutesUntilEnd = (shiftEnd - nowTime) / 60000;\\n\\n            let isLate = false;\\n            let isImminent = false;\\n            let isEnding = false;\\n            let statusText = \'Pendiente\';\\n\\n            if (shift.isAbsent || shift.status === \'ABSENT\') {\\n                statusText = \'AUSENTE\';\\n            }\\n            else if (shift.isPresent || shift.status === \'PRESENT\' || shift.status === \'CHECK_IN\') {\\n                if (shift.isRetention) {\\n                    statusText = \'RETENIDO\';\\n                } else if (shift.isCompleted || shift.status === \'COMPLETED\') {\\n                    statusText = \'FINALIZADO\';\\n                } else {\\n                    statusText = \'EN SERVICIO\';\\n                    if (minutesUntilEnd > 0 && minutesUntilEnd <= 30) isEnding = true;\\n                    if (minutesUntilEnd < -30) statusText = \'SIN CIERRE\'; \\n                }\\n            }\\n            else {\\n                if (minutesLate > TOLERANCE_MINUTES) {\\n                    isLate = true;\\n                    statusText = \'LLEGADA TARDE\';\\n                } else if (minutesLate >= -30) { \\n                    isImminent = true;\\n                    statusText = \'INMINENTE\';\\n                }\\n            }\\n\\n            return {\\n                ...shift,\\n                isLate,\\n                isImminent,\\n                isEnding,\\n                statusText,\\n                isPresent: shift.status === \'PRESENT\' || shift.status === \'CHECK_IN\' || !!shift.isPresent,\\n                isCompleted: shift.status === \'COMPLETED\' || !!shift.isCompleted,\\n                isRetention: !!shift.isRetention,\\n                isAbsent: shift.status === \'ABSENT\' || !!shift.isAbsent\\n            };\\n        }).sort((a:any, b:any) => a.shiftDateObj - b.shiftDateObj);\\n    }, [rawShifts, now]);\\n\\n    // 5. FILTRADO PARA LISTA (CON NUEVA LGICA DE AUSENTES)\\n    const listData = useMemo(() => {\\n        let filtered = processedData;\\n\\n        if (filterText) {\\n            const lower = filterText.toLowerCase();\\n            filtered = filtered.filter((s:any) => \\n                s.employeeName.toLowerCase().includes(lower) || \\n                s.clientName.toLowerCase().includes(lower) ||\\n                s.objectiveName.toLowerCase().includes(lower)\\n            );\\n        }\\n\\n        if (viewTab === \'PRIORIDAD\') {\\n            // Prioridad: Tarde, Retenidos, Sin Cierre, Inminentes.\\n            // EXCLUIMOS Ausentes confirmados (van a su propia pesta帽a) y Finalizados.\\n            return filtered.filter((s:any) => \\n                (s.isRetention || s.isLate || s.statusText === \'SIN CIERRE\' || s.isImminent) \\n                && !s.isCompleted && !s.isAbsent\\n            );\\n        } else if (viewTab === \'ACTIVOS\') {\\n            // Solo gente en el puesto\\n            return filtered.filter((s:any) => s.isPresent && !s.isCompleted && !s.isAbsent);\\n        } else if (viewTab === \'AUSENTES\') {\\n            // Solo los confirmados como ausentes\\n            return filtered.filter((s:any) => s.isAbsent);\\n        } else {\\n            // HOY: Todo\\n            return filtered;\\n        }\\n    }, [processedData, viewTab, filterText]);\\n\\n    // 6. ACCIONES (HANDLERS)\\n    // MODIFICADO: Acepta comments (3er argumento) para soportar el modal de checkout del index.tsx\\n    const handleAction = async (action: string, shiftId: string, comments?: string | null) => {\\n        setProcessingId(shiftId);\\n        try {\\n            const shiftRef = doc(db, \'turnos\', shiftId);\\n            \\n            if (action === \'CHECKIN\') {\\n                await updateDoc(shiftRef, {\\n                    status: \'PRESENT\',\\n                    realStartTime: serverTimestamp(),\\n                    isPresent: true,\\n                    isLate: false,\\n                    isImminent: false\\n                });\\n                toast.success(`Entrada registrada`);\\n            } \\n            else if (action === \'CHECKOUT\') {\\n                // Si viene comentario (desde el modal de index), guardamos directo\\n                if (comments !== undefined) {\\n                    await updateDoc(shiftRef, {\\n                        status: \'COMPLETED\',\\n                        realEndTime: serverTimestamp(),\\n                        isCompleted: true,\\n                        isPresent: false,\\n                        isRetention: false, // Liberar retenci贸n si exist铆a\\n                        checkoutNote: comments || null,\\n                        hasNovedad: !!comments\\n                    });\\n                    toast.success(\\"Salida registrada\\");\\n                } else {\\n                    // Si no viene comentario, mantenemos la l贸gica antigua de abrir el modal interno del hook\\n                    // (aunque ahora usamos el del index, esto previene errores si se llama de otro lado)\\n                    setProcessingId(null);\\n                    setModals({ ...modals, checkout: true });\\n                    return;\\n                }\\n            }\\n            else if (action === \'NOVEDAD\') {\\n                setProcessingId(null);\\n                setModals({ ...modals, novedad: true });\\n                return;\\n            }\\n        } catch (error) {\\n            console.error(error);\\n            toast.error(\\"Error al procesar acci贸n\\");\\n        }\\n        setProcessingId(null);\\n    };\\n\\n    // --- FUNCIONES ORIGINALES RESTITUIDAS ---\\n    \\n    const confirmCheckout = async () => {\\n        if (!processingId) return;\\n        try {\\n            await updateDoc(doc(db, \'turnos\', processingId), {\\n                status: \'COMPLETED\',\\n                realEndTime: serverTimestamp(),\\n                isCompleted: true,\\n                checkoutNote: checkoutData.note || null,\\n                hasNovedad: checkoutData.type === \'WITH_NOTE\'\\n            });\\n            toast.success(\\"Salida registrada\\");\\n            setModals(p => ({ ...p, checkout: false }));\\n            setCheckoutData({ type: \'NORMAL\', note: \'\' });\\n        } catch (e) { toast.error(\\"Error al cerrar turno\\"); }\\n    };\\n\\n    const confirmNovedad = async () => {\\n        if (!processingId) return;\\n        try {\\n            const shift = rawShifts.find(s => s.id === processingId);\\n            await addDoc(collection(db, \'novedades\'), {\\n                shiftId: processingId,\\n                employeeId: shift?.employeeId,\\n                employeeName: shift?.employeeName,\\n                type: novedadData.tipo,\\n                notes: novedadData.nota,\\n                createdAt: serverTimestamp(),\\n                viewed: false\\n            });\\n            await updateDoc(doc(db, \'turnos\', processingId), {\\n                hasNovedad: true,\\n                lastNovedad: novedadData.tipo\\n            });\\n            toast.success(\\"Novedad reportada\\");\\n            setModals(p => ({ ...p, novedad: false }));\\n            setNovedadData({ tipo: \'Llegada Tarde\', nota: \'\' });\\n        } catch (e) { toast.error(\\"Error al reportar novedad\\"); }\\n    };\\n\\n    const handleAsignarSuplente = async (employee: any) => {\\n        if (!absentShiftData) return;\\n        try {\\n             await addDoc(collection(db, \'turnos\'), {\\n                 ...absentShiftData, \\n                 employeeId: employee.id,\\n                 employeeName: employee.fullName,\\n                 status: \'PENDING\',\\n                 isPresent: false, isAbsent: false, isLate: false,\\n                 isCoverage: true, \\n                 coverageNote: `Cubriendo a ${absentShiftData.employeeName}`,\\n                 id: undefined \\n             });\\n             toast.success(`Suplente asignado: ${employee.fullName}`);\\n             setModals(p => ({ ...p, coverage: false }));\\n        } catch (e) { toast.error(\\"Error al asignar suplente\\"); }\\n    };\\n\\n    return {\\n        now,\\n        processedData,\\n        listData,\\n        objectives,\\n        recentLogs,\\n        allEmployees: employees,\\n        viewTab, setViewTab,\\n        filterText, setFilterText,\\n        isCompact, setIsCompact,\\n        modals, setModals,\\n        processingId,\\n        checkoutData, setCheckoutData,\\n        novedadData, setNovedadData,\\n        coverageSearch, setCoverageSearch,\\n        absentShiftData, \\n        handleAction,\\n        confirmCheckout,\\n        confirmNovedad,\\n        handleAsignarSuplente,\\n        NOVEDAD_TYPES\\n    };\\n};"},{"id":"pd9xebt5t","name":"usePlanificacion.ts","path":"apps\\\\web2\\\\src\\\\hooks\\\\usePlanificacion.ts","area":"FRONTEND","content":"import { useState, useEffect, useMemo } from \'react\';\\r\\nimport { db } from \'@/lib/firebase\';\\r\\nimport { \\r\\n    collection, query, where, getDocs, onSnapshot, \\r\\n    addDoc, deleteDoc, doc, Timestamp, updateDoc \\r\\n} from \'firebase/firestore\';\\r\\nimport { IPlannerEmployee, IPlannerShift, SHIFT_CODES } from \'@/types/planificacion.types\';\\r\\nimport { toast } from \'sonner\';\\r\\n\\r\\nexport const usePlanificacion = () => {\\r\\n    // --- ESTADOS ---\\r\\n    const [currentDate, setCurrentDate] = useState(new Date());\\r\\n    const [employees, setEmployees] = useState<IPlannerEmployee[]>([]);\\r\\n    const [shifts, setShifts] = useState<IPlannerShift[]>([]);\\r\\n    const [loading, setLoading] = useState(true);\\r\\n    \\r\\n    // Modal de Asignaci贸n\\r\\n    const [selectedCell, setSelectedCell] = useState<{ empId: string, date: Date, currentShift?: IPlannerShift } | null>(null);\\r\\n    const [isModalOpen, setIsModalOpen] = useState(false);\\r\\n\\r\\n    // --- UTILS DE FECHAS ---\\r\\n    const getMonthData = () => {\\r\\n        const year = currentDate.getFullYear();\\r\\n        const month = currentDate.getMonth();\\r\\n        const daysInMonth = new Date(year, month + 1, 0).getDate();\\r\\n        const daysArray = Array.from({ length: daysInMonth }, (_, i) => {\\r\\n            const d = new Date(year, month, i + 1);\\r\\n            return {\\r\\n                day: i + 1,\\r\\n                date: d,\\r\\n                isToday: d.toDateString() === new Date().toDateString(),\\r\\n                isWeekend: d.getDay() === 0 || d.getDay() === 6\\r\\n            };\\r\\n        });\\r\\n        return { year, month, daysInMonth, daysArray };\\r\\n    };\\r\\n\\r\\n    const { daysArray, year, month } = getMonthData();\\r\\n\\r\\n    // --- CARGA DE DATOS ---\\r\\n    useEffect(() => {\\r\\n        // 1. Cargar Empleados (Solo una vez)\\r\\n        const loadEmployees = async () => {\\r\\n            const q = query(collection(db, \'empleados\'));\\r\\n            const snap = await getDocs(q);\\r\\n            const emps = snap.docs.map(d => ({ \\r\\n                id: d.id, \\r\\n                fullName: d.data().name || `${d.data().lastName} ${d.data().firstName}` \\r\\n            }));\\r\\n            setEmployees(emps);\\r\\n        };\\r\\n        loadEmployees();\\r\\n    }, []);\\r\\n\\r\\n    useEffect(() => {\\r\\n        // 2. Cargar Turnos del Mes Actual (Escucha en tiempo real)\\r\\n        setLoading(true);\\r\\n        const startOfMonth = new Date(year, month, 1);\\r\\n        const endOfMonth = new Date(year, month + 1, 0, 23, 59, 59);\\r\\n\\r\\n        const q = query(\\r\\n            collection(db, \'turnos\'),\\r\\n            where(\'startTime\', \'>=\', Timestamp.fromDate(startOfMonth)),\\r\\n            where(\'startTime\', \'<=\', Timestamp.fromDate(endOfMonth))\\r\\n        );\\r\\n\\r\\n        const unsubscribe = onSnapshot(q, (snap) => {\\r\\n            const loadedShifts = snap.docs.map(d => ({\\r\\n                id: d.id,\\r\\n                ...d.data()\\r\\n            })) as IPlannerShift[];\\r\\n            setShifts(loadedShifts);\\r\\n            setLoading(false);\\r\\n        });\\r\\n\\r\\n        return () => unsubscribe();\\r\\n    }, [currentDate]);\\r\\n\\r\\n    // --- ACCIONES ---\\r\\n    const navigateMonth = (direction: \'prev\' | \'next\') => {\\r\\n        const newDate = new Date(currentDate);\\r\\n        newDate.setMonth(currentDate.getMonth() + (direction === \'next\' ? 1 : -1));\\r\\n        setCurrentDate(newDate);\\r\\n    };\\r\\n\\r\\n    const handleCellClick = (empId: string, date: Date) => {\\r\\n        // Buscar si ya existe turno\\r\\n        const existing = shifts.find(s => \\r\\n            s.employeeId === empId && \\r\\n            s.startTime.toDate().toDateString() === date.toDateString()\\r\\n        );\\r\\n        setSelectedCell({ empId, date, currentShift: existing });\\r\\n        setIsModalOpen(true);\\r\\n    };\\r\\n\\r\\n    const assignShift = async (code: string) => {\\r\\n        if (!selectedCell) return;\\r\\n        \\r\\n        try {\\r\\n            const emp = employees.find(e => e.id === selectedCell.empId);\\r\\n            if (!emp) return;\\r\\n\\r\\n            // Configurar horas base seg煤n c贸digo\\r\\n            const start = new Date(selectedCell.date);\\r\\n            const end = new Date(selectedCell.date);\\r\\n            \\r\\n            if (code === \'M\') { start.setHours(6,0,0); end.setHours(14,0,0); }\\r\\n            else if (code === \'T\') { start.setHours(14,0,0); end.setHours(22,0,0); }\\r\\n            else if (code === \'N\') { start.setHours(22,0,0); end.setHours(6,0,0); end.setDate(end.getDate() + 1); }\\r\\n            else { start.setHours(9,0,0); end.setHours(18,0,0); } // Franco/Default\\r\\n\\r\\n            const payload = {\\r\\n                employeeId: emp.id,\\r\\n                employeeName: emp.fullName,\\r\\n                startTime: Timestamp.fromDate(start),\\r\\n                endTime: Timestamp.fromDate(end),\\r\\n                code: code,\\r\\n                status: code === \'F\' ? \'COMPLETED\' : \'PENDING\',\\r\\n                isFranco: code === \'F\',\\r\\n                // Campos dummy requeridos por reglas de seguridad\\r\\n                clientId: \'MANUAL\', clientName: \'Planificaci贸n Manual\',\\r\\n                objectiveId: \'MANUAL\', objectiveName: \'General\'\\r\\n            };\\r\\n\\r\\n            if (selectedCell.currentShift) {\\r\\n                await updateDoc(doc(db, \'turnos\', selectedCell.currentShift.id), payload);\\r\\n                toast.success(\\"Turno actualizado\\");\\r\\n            } else {\\r\\n                await addDoc(collection(db, \'turnos\'), payload);\\r\\n                toast.success(\\"Turno asignado\\");\\r\\n            }\\r\\n            setIsModalOpen(false);\\r\\n        } catch (e) {\\r\\n            console.error(e);\\r\\n            toast.error(\\"Error asignando turno\\");\\r\\n        }\\r\\n    };\\r\\n\\r\\n    const deleteShift = async () => {\\r\\n        if (!selectedCell?.currentShift) return;\\r\\n        try {\\r\\n            await deleteDoc(doc(db, \'turnos\', selectedCell.currentShift.id));\\r\\n            toast.success(\\"Turno eliminado\\");\\r\\n            setIsModalOpen(false);\\r\\n        } catch (e) { toast.error(\\"Error al eliminar\\"); }\\r\\n    };\\r\\n\\r\\n    // Helper para renderizar\\r\\n    const getShiftForCell = (empId: string, date: Date) => {\\r\\n        return shifts.find(s => \\r\\n            s.employeeId === empId && \\r\\n            s.startTime.toDate().toDateString() === date.toDateString()\\r\\n        );\\r\\n    };\\r\\n\\r\\n    return {\\r\\n        currentDate, daysArray, employees, loading,\\r\\n        isModalOpen, setIsModalOpen, selectedCell, SHIFT_CODES,\\r\\n        navigateMonth, handleCellClick, assignShift, deleteShift, getShiftForCell\\r\\n    };\\r\\n};"},{"id":"xrv9zmi9h","name":"useReportes.ts","path":"apps\\\\web2\\\\src\\\\hooks\\\\useReportes.ts","area":"FRONTEND","content":"import { useState, useEffect } from \'react\';\\r\\nimport { db } from \'@/lib/firebase\';\\r\\nimport { collection, getDocs, query, where, Timestamp } from \'firebase/firestore\';\\r\\nimport { toast } from \'sonner\';\\r\\n\\r\\n// --- CONSTANTES Y HELPERS ---\\r\\nconst OPERATIVE_CODES = [\'M\', \'T\', \'N\', \'D12\', \'N12\', \'PU\', \'GU\', \'FT\']; \\r\\nconst SHIFT_HOURS_LOOKUP: Record<string, number> = { \\r\\n    \'M\':8, \'T\':8, \'N\':8, \'D12\':12, \'N12\':12, \'PU\':12, \'GU\':8, \'FT\': 0, \\r\\n    \'F\':0, \'V\':0, \'L\':0, \'A\':0, \'E\':0, \'FF\':0 \\r\\n};\\r\\n\\r\\n// Helper seguro para fechas (Formato local Argentina)\\r\\nconst getArgentinaDate = (dateInput: any): string => {\\r\\n    if (!dateInput) return \'\';\\r\\n    try {\\r\\n        const d = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);\\r\\n        const year = d.getFullYear();\\r\\n        const month = String(d.getMonth() + 1).padStart(2, \'0\');\\r\\n        const day = String(d.getDate()).padStart(2, \'0\');\\r\\n        return `${year}-${month}-${day}`;\\r\\n    } catch (e) {\\r\\n        return \'\'; \\r\\n    }\\r\\n};\\r\\n\\r\\n// C谩lculo de horas nocturnas (21:00 a 06:00)\\r\\nconst getNightDuration = (start: Date, end: Date) => {\\r\\n    let durationMins = 0;\\r\\n    if (isNaN(start.getTime()) || isNaN(end.getTime())) return 0;\\r\\n\\r\\n    let current = new Date(start.getTime());\\r\\n    const endTime = end.getTime();\\r\\n    \\r\\n    // Seguridad anti-loop (max 24hs)\\r\\n    let safety = 0;\\r\\n    while (current.getTime() < endTime && safety < 1440) {\\r\\n        const h = current.getHours();\\r\\n        if (h >= 21 || h < 6) durationMins++;\\r\\n        current.setMinutes(current.getMinutes() + 1);\\r\\n        safety++;\\r\\n    }\\r\\n    return durationMins / 60;\\r\\n};\\r\\n\\r\\n// Calculadora CCT 507/07\\r\\nconst calculateStatsExact = (shifts: any[], holidaysMap: Record<string, boolean>) => {\\r\\n    // 1. FILTRO DE SEGURIDAD: Solo procesar turnos con fechas v谩lidas\\r\\n    const validShifts = shifts.filter(s => s.startTime && s.endTime && s.startTime.seconds && s.endTime.seconds);\\r\\n\\r\\n    // Ordenamos en memoria\\r\\n    const sortedDocs = [...validShifts].sort((a, b) => a.startTime.seconds - b.startTime.seconds);\\r\\n    \\r\\n    let hoursTotalOperativas = 0;\\r\\n    let totalDiurnas = 0;\\r\\n    let totalNocturnas = 0;\\r\\n    let hoursFT = 0;        \\r\\n    let hoursFeriado = 0;   \\r\\n    \\r\\n    sortedDocs.forEach(d => {\\r\\n        try {\\r\\n            const st = (d.status || \'\').toLowerCase();\\r\\n            if (st.includes(\'cancel\') || st.includes(\'delet\')) return;\\r\\n            if (d.type === \'NOVEDAD\') return;\\r\\n            \\r\\n            const rawCode = (d.code || \'\').trim().toUpperCase();\\r\\n            if ([\'F\', \'FF\', \'V\', \'L\', \'A\', \'E\'].includes(rawCode)) return;\\r\\n            \\r\\n            const start = d.startTime.toDate();\\r\\n            const end = d.endTime.toDate();\\r\\n            \\r\\n            let duration = (end.getTime() - start.getTime()) / 3600000;\\r\\n            \\r\\n            // Correcci贸n de seguridad para datos sucios\\r\\n            if (duration < 0 || duration > 24 || isNaN(duration)) {\\r\\n                duration = SHIFT_HOURS_LOOKUP[rawCode] || 8;\\r\\n            }\\r\\n            \\r\\n            const night = getNightDuration(start, end);\\r\\n            const day = Math.max(0, duration - night);\\r\\n            const dateKey = getArgentinaDate(d.startTime);\\r\\n            \\r\\n            const isFeriado = holidaysMap[dateKey];\\r\\n            const isFT = d.isFrancoTrabajado || rawCode === \'FT\'; \\r\\n\\r\\n            if (isFeriado) { hoursFeriado += duration; }\\r\\n\\r\\n            if (isFT) {\\r\\n                hoursFT += duration;\\r\\n                totalNocturnas += night;\\r\\n                totalDiurnas += day;\\r\\n            } else {\\r\\n                hoursTotalOperativas += duration;\\r\\n                totalNocturnas += night;\\r\\n                totalDiurnas += day;\\r\\n            }\\r\\n        } catch (err) {\\r\\n            console.warn(\\"Saltando turno corrupto:\\", d.id);\\r\\n        }\\r\\n    });\\r\\n\\r\\n    const baseLimit = 200;\\r\\n    const excess = Math.max(0, hoursTotalOperativas - baseLimit);\\r\\n    const horasSimples = Math.min(hoursTotalOperativas, baseLimit);\\r\\n\\r\\n    return {\\r\\n        totalReal: hoursTotalOperativas + hoursFT,\\r\\n        horasSimples,\\r\\n        totalDiurnas,\\r\\n        totalNocturnas,\\r\\n        extra50: excess,\\r\\n        extra100: hoursFT,\\r\\n        plusFeriado: hoursFeriado\\r\\n    };\\r\\n};\\r\\n\\r\\nexport const useReportes = () => {\\r\\n    const [loading, setLoading] = useState(false);\\r\\n    \\r\\n    // Inicializamos fechas locales\\r\\n    const today = new Date();\\r\\n    const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,\'0\')}-${String(today.getDate()).padStart(2,\'0\')}`;\\r\\n    \\r\\n    const [dateRange, setDateRange] = useState({ start: todayStr, end: todayStr });\\r\\n    \\r\\n    const [employeeReport, setEmployeeReport] = useState<any[]>([]);\\r\\n    const [objectiveReport, setObjectiveReport] = useState<any[]>([]);\\r\\n    const [auditLogs, setAuditLogs] = useState<any[]>([]);\\r\\n    \\r\\n    const [empMap, setEmpMap] = useState<Record<string, string>>({});\\r\\n    const [objMap, setObjMap] = useState<Record<string, string>>({});\\r\\n    const [clientMap, setClientMap] = useState<Record<string, string>>({});\\r\\n    const [holidaysData, setHolidaysData] = useState<Record<string, boolean>>({});\\r\\n\\r\\n    useEffect(() => {\\r\\n        const loadCatalogs = async () => {\\r\\n            try {\\r\\n                const [s, c, h] = await Promise.all([ \\r\\n                    getDocs(collection(db, \'empleados\')), \\r\\n                    getDocs(collection(db, \'clients\')),\\r\\n                    getDocs(collection(db, \'feriados\'))\\r\\n                ]);\\r\\n                \\r\\n                const emps: any = {};\\r\\n                s.forEach(d => {\\r\\n                    const data = d.data();\\r\\n                    emps[d.id] = data.name || (data.firstName ? `${data.lastName}, ${data.firstName}` : \'Sin Nombre\');\\r\\n                });\\r\\n                setEmpMap(emps);\\r\\n                \\r\\n                const objs: any = {};\\r\\n                const clis: any = {};\\r\\n                c.forEach(doc => {\\r\\n                    const data = doc.data();\\r\\n                    clis[doc.id] = data.name;\\r\\n                    if (data.objetivos) {\\r\\n                        data.objetivos.forEach((obj: any) => {\\r\\n                            const oid = obj.id || obj.name;\\r\\n                            objs[oid] = obj.name; \\r\\n                        });\\r\\n                    }\\r\\n                });\\r\\n                setObjMap(objs);\\r\\n                setClientMap(clis);\\r\\n\\r\\n                const holidays: any = {};\\r\\n                h.docs.forEach(d => { if(d.data().date) holidays[d.data().date] = true; });\\r\\n                setHolidaysData(holidays);\\r\\n\\r\\n            } catch (e) { console.error(\\"Error cargando cat谩logos:\\", e); }\\r\\n        };\\r\\n        loadCatalogs();\\r\\n    }, []);\\r\\n\\r\\n    const generateReports = async () => {\\r\\n        if (!dateRange.start || !dateRange.end) return toast.error(\\"Seleccione un rango de fechas\\");\\r\\n        setLoading(true);\\r\\n        setEmployeeReport([]);\\r\\n        setObjectiveReport([]);\\r\\n\\r\\n        try {\\r\\n            // FIX CRTICO DE FECHAS: Usar formato ISO Local\\r\\n            const startDate = new Date(`${dateRange.start}T00:00:00`);\\r\\n            const endDate = new Date(`${dateRange.end}T23:59:59.999`);\\r\\n\\r\\n            if (startDate > endDate) {\\r\\n                toast.error(\\"La fecha \'Desde\' no puede ser mayor a \'Hasta\'\\");\\r\\n                setLoading(false);\\r\\n                return;\\r\\n            }\\r\\n\\r\\n            // Consulta SIN indices complejos (filtrado en memoria si es necesario, o b谩sico por fecha)\\r\\n            const q = query(\\r\\n                collection(db, \'turnos\'),\\r\\n                where(\'startTime\', \'>=\', Timestamp.fromDate(startDate)),\\r\\n                where(\'startTime\', \'<=\', Timestamp.fromDate(endDate))\\r\\n            );\\r\\n\\r\\n            const shiftsSnap = await getDocs(q);\\r\\n            \\r\\n            // FILTRADO DEFENSIVO: Eliminar basura antes de procesar\\r\\n            const rawShifts = shiftsSnap.docs\\r\\n                .map(doc => ({ id: doc.id, ...doc.data() }))\\r\\n                .filter((d: any) => {\\r\\n                    // Validar que tenga fechas y que sean Timestamps v谩lidos\\r\\n                    return d.startTime && d.endTime && typeof d.startTime.toDate === \'function\';\\r\\n                });\\r\\n\\r\\n            if (rawShifts.length === 0) {\\r\\n                toast.info(\\"No se encontraron turnos v谩lidos en este rango.\\");\\r\\n            }\\r\\n\\r\\n            // 3. Procesamiento por Empleado\\r\\n            const empGroups: any = {};\\r\\n            rawShifts.forEach((s: any) => {\\r\\n                if(!empGroups[s.employeeId]) empGroups[s.employeeId] = [];\\r\\n                empGroups[s.employeeId].push(s);\\r\\n            });\\r\\n\\r\\n            const empRows = Object.keys(empGroups).map(empId => {\\r\\n                const shifts = empGroups[empId];\\r\\n                const stats = calculateStatsExact(shifts, holidaysData);\\r\\n                \\r\\n                const ftCount = shifts.filter((s:any) => s.isFrancoTrabajado || s.code === \'FT\').length;\\r\\n                const ffCount = shifts.filter((s:any) => s.isFrancoCompensatorio || s.code === \'FF\').length;\\r\\n\\r\\n                return {\\r\\n                    id: empId,\\r\\n                    type: \'EMPLOYEE\',\\r\\n                    name: empMap[empId] || \'Desconocido\', \\r\\n                    shifts: shifts.filter((s:any) => OPERATIVE_CODES.includes((s.code||\'\').trim().toUpperCase())).length,\\r\\n                    total: stats.totalReal,\\r\\n                    diurnas: stats.totalDiurnas,\\r\\n                    nocturnas: stats.totalNocturnas,\\r\\n                    extra50: stats.extra50,\\r\\n                    extra100: stats.extra100,\\r\\n                    plusFeriado: stats.plusFeriado,\\r\\n                    ftCount,\\r\\n                    ffCount,\\r\\n                    rawShifts: shifts \\r\\n                };\\r\\n            });\\r\\n            setEmployeeReport(empRows.sort((a,b) => b.total - a.total));\\r\\n\\r\\n            // 4. Procesamiento por Objetivo\\r\\n            const objGroups: any = {};\\r\\n            rawShifts.forEach((s: any) => {\\r\\n                if (s.type === \'NOVEDAD\' || !OPERATIVE_CODES.includes((s.code||\'\').trim().toUpperCase())) return;\\r\\n                \\r\\n                const key = s.objectiveId || \'SIN_OBJETIVO\';\\r\\n                if(!objGroups[key]) objGroups[key] = { shifts: [], clientId: s.clientId };\\r\\n                objGroups[key].shifts.push(s);\\r\\n            });\\r\\n\\r\\n            const objRows = Object.keys(objGroups).map(objId => {\\r\\n                const data = objGroups[objId];\\r\\n                const stats = calculateStatsExact(data.shifts, holidaysData);\\r\\n                return {\\r\\n                    id: objId,\\r\\n                    type: \'OBJECTIVE\',\\r\\n                    name: objMap[objId] || objId,\\r\\n                    clientId: data.clientId,\\r\\n                    client: clientMap[data.clientId] || \'Sin Cliente\',\\r\\n                    shifts: data.shifts.length,\\r\\n                    total: stats.totalReal,\\r\\n                    diurnas: stats.totalDiurnas,\\r\\n                    nocturnas: stats.totalNocturnas,\\r\\n                    extra50: stats.extra50,\\r\\n                    extra100: stats.extra100,\\r\\n                    plusFeriado: stats.plusFeriado,\\r\\n                    rawShifts: data.shifts\\r\\n                };\\r\\n            });\\r\\n            setObjectiveReport(objRows.sort((a,b) => a.client.localeCompare(b.client)));\\r\\n\\r\\n        } catch (error: any) {\\r\\n            console.error(\\"Error generando reporte:\\", error);\\r\\n            if(error.message?.includes(\\"index\\")) {\\r\\n                toast.error(\\"Falta 铆ndice en Firebase. Revisa la consola.\\");\\r\\n            } else {\\r\\n                toast.error(\\"Error al procesar datos.\\");\\r\\n            }\\r\\n        } finally {\\r\\n            setLoading(false);\\r\\n        }\\r\\n    };\\r\\n\\r\\n    const loadAudit = async () => {\\r\\n        setLoading(true);\\r\\n        try {\\r\\n            const startDate = new Date(`${dateRange.start}T00:00:00`);\\r\\n            const endDate = new Date(`${dateRange.end}T23:59:59.999`);\\r\\n\\r\\n            const q = query(\\r\\n                collection(db, \'audit_logs\'), \\r\\n                where(\'timestamp\', \'>=\', Timestamp.fromDate(startDate)), \\r\\n                where(\'timestamp\', \'<=\', Timestamp.fromDate(endDate))\\r\\n            );\\r\\n            \\r\\n            const snap = await getDocs(q);\\r\\n            const logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));\\r\\n            \\r\\n            setAuditLogs(logs.sort((a:any, b:any) => b.timestamp.seconds - a.timestamp.seconds));\\r\\n            \\r\\n        } catch(e) { console.error(e); } finally { setLoading(false); }\\r\\n    };\\r\\n\\r\\n    return {\\r\\n        loading,\\r\\n        dateRange, setDateRange,\\r\\n        generateReports,\\r\\n        loadAudit,\\r\\n        employeeReport,\\r\\n        objectiveReport,\\r\\n        auditLogs,\\r\\n        SHIFT_HOURS_LOOKUP, \\r\\n        OPERATIVE_CODES\\r\\n    };\\r\\n};"},{"id":"supjm9q7v","name":"firebase.ts","path":"apps\\\\web2\\\\src\\\\lib\\\\firebase.ts","area":"FRONTEND","content":"import { initializeApp, getApps, getApp } from \'firebase/app\';\\nimport { getAuth } from \'firebase/auth\';\\nimport { getFirestore } from \'firebase/firestore\';\\nimport { getFunctions } from \'firebase/functions\';\\n\\nconst firebaseConfig = {\\n  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,\\n  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,\\n  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,\\n  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,\\n  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,\\n  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,\\n};\\n\\n// Singleton para evitar reinicializaciones\\nconst app = !getApps().length ? initializeApp(firebaseConfig) : getApp();\\n\\nconst auth = getAuth(app);\\nconst db = getFirestore(app);\\nconst functions = getFunctions(app); // Habilitamos Functions\\n\\nexport { app, auth, db, functions };"},{"id":"wscwq9cdk","name":"index.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\configuracion\\\\index.tsx","area":"FRONTEND","content":"import React, { useState } from \'react\';\\nimport Head from \'next/head\';\\nimport { Settings, Users, Shield, Database } from \'lucide-react\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport UsersTab from \'@/components/admin/config/UsersTab\';\\nimport RolesTab from \'@/components/admin/config/RolesTab\';\\nimport GeneralTab from \'@/components/admin/config/GeneralTab\';\\n\\nexport default function ConfigPage() {\\n    const [activeTab, setActiveTab] = useState<\'GENERAL\' | \'USERS\' | \'ROLES\'>(\'GENERAL\');\\n\\n    return (\\n        <DashboardLayout>\\n            <Head><title>Configuraci贸n | CronoApp</title></Head>\\n            <div className=\\"p-6 max-w-7xl mx-auto min-h-screen flex flex-col space-y-6 animate-in fade-in\\">\\n                <div className=\\"flex items-center gap-4 border-b dark:border-slate-800 pb-6\\">\\n                    <div className=\\"p-3 bg-indigo-100 dark:bg-indigo-900/30 rounded-2xl\\">\\n                        <Settings className=\\"text-indigo-600 dark:text-indigo-400\\" size={32}/>\\n                    </div>\\n                    <div>\\n                        <h1 className=\\"text-3xl font-black text-slate-800 dark:text-white uppercase tracking-tight\\">Configuraci贸n del Sistema</h1>\\n                        <p className=\\"text-slate-500 dark:text-slate-400 font-medium\\">Gesti贸n de par谩metros, usuarios de plataforma y seguridad.</p>\\n                    </div>\\n                </div>\\n\\n                <div className=\\"flex flex-wrap gap-2\\">\\n                    <button onClick={() => setActiveTab(\'GENERAL\')} className={`px-6 py-3 rounded-xl text-xs font-black uppercase flex items-center gap-2 transition-all ${activeTab === \'GENERAL\' ? \'bg-indigo-600 text-white shadow-lg scale-105\' : \'bg-white dark:bg-slate-800 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700\'}`}><Database size={16}/> Sistema</button>\\n                    <button onClick={() => setActiveTab(\'USERS\')} className={`px-6 py-3 rounded-xl text-xs font-black uppercase flex items-center gap-2 transition-all ${activeTab === \'USERS\' ? \'bg-indigo-600 text-white shadow-lg scale-105\' : \'bg-white dark:bg-slate-800 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700\'}`}><Users size={16}/> Usuarios Admin</button>\\n                    <button onClick={() => setActiveTab(\'ROLES\')} className={`px-6 py-3 rounded-xl text-xs font-black uppercase flex items-center gap-2 transition-all ${activeTab === \'ROLES\' ? \'bg-indigo-600 text-white shadow-lg scale-105\' : \'bg-white dark:bg-slate-800 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700\'}`}><Shield size={16}/> Roles y Permisos</button>\\n                </div>\\n\\n                <div className=\\"flex-1 rounded-3xl p-2\\">\\n                    <div className=\\"bg-transparent h-full w-full p-2\\">\\n                        {activeTab === \'GENERAL\' && <GeneralTab />}\\n                        {activeTab === \'USERS\' && <UsersTab />}\\n                        {activeTab === \'ROLES\' && <RolesTab />}\\n                    </div>\\n                </div>\\n            </div>\\n        </DashboardLayout>\\n    );\\n}"},{"id":"lxlyjmr5i","name":"index.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\crm\\\\index.tsx","area":"FRONTEND","content":"import React, { useState, useEffect, useRef } from \'react\';\\nimport Head from \'next/head\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { db } from \'@/lib/firebase\';\\nimport { \\n    collection, getDocs, addDoc, updateDoc, deleteDoc, doc, \\n    query, orderBy, where, arrayUnion, serverTimestamp \\n} from \'firebase/firestore\';\\n//  IMPORTACIONES DE AUTH\\nimport { getAuth, onAuthStateChanged } from \'firebase/auth\';\\nimport { Toaster, toast } from \'sonner\';\\nimport { \\n    Users, Building2, MapPin, Phone, Mail, Search, Plus, \\n    Trash2, Briefcase, Send, Edit2, Save, X, ExternalLink, User,\\n    Bug, Crosshair, Navigation, CreditCard, Hash, ShieldCheck\\n} from \'lucide-react\';\\n\\nexport default function CRMPage() {\\n    const [view, setView] = useState(\'list\');\\n    const [activeTab, setActiveTab] = useState(\'INFO\');\\n    \\n    //  ESTADO VISUAL DEL USUARIO\\n    const [currentUserName, setCurrentUserName] = useState(\\"Cargando...\\");\\n\\n    // Datos\\n    const [clients, setClients] = useState<any[]>([]);\\n    const [filteredClients, setFilteredClients] = useState<any[]>([]);\\n    const [selectedClient, setSelectedClient] = useState<any>(null);\\n    const [clientServices, setClientServices] = useState<any[]>([]);\\n    \\n    // UI\\n    const [searchTerm, setSearchTerm] = useState(\'\');\\n    const [historyNote, setHistoryNote] = useState(\'\');\\n    const [showDebug, setShowDebug] = useState(false);\\n    \\n    // --- ESTADOS DE EDICIN ---\\n    const [isEditingInfo, setIsEditingInfo] = useState(false);\\n    const [infoForm, setInfoForm] = useState<any>({});\\n    \\n    // Edici贸n Sedes + Autocomplete\\n    const [editingObjectiveId, setEditingObjectiveId] = useState<string | null>(null);\\n    const [tempObjective, setTempObjective] = useState<any>({});\\n    const [addressSuggestions, setAddressSuggestions] = useState<any[]>([]);\\n    const [showSuggestions, setShowSuggestions] = useState(false);\\n    const searchTimeout = useRef<any>(null);\\n    \\n    // Edici贸n Contactos\\n    const [editingContactId, setEditingContactId] = useState<string | null>(null);\\n    const [tempContact, setTempContact] = useState<any>({});\\n\\n    //  DETECCIN DE USUARIO REAL AL MONTAR\\n    useEffect(() => {\\n        const auth = getAuth();\\n        const unsubscribe = onAuthStateChanged(auth, (user) => {\\n            if (user) {\\n                // Prioridad: Nombre > Email\\n                setCurrentUserName(user.displayName || user.email || \\"Usuario Sin Nombre\\");\\n            } else {\\n                setCurrentUserName(\\"No Logueado\\");\\n            }\\n        });\\n        return () => unsubscribe();\\n    }, []);\\n\\n    // Cargas\\n    useEffect(() => { fetchClients(); }, []);\\n\\n    useEffect(() => {\\n        if (!clients.length) return;\\n        const term = searchTerm.toLowerCase();\\n        setFilteredClients(clients.filter(c => \\n            (c.name || \'\').toLowerCase().includes(term) || \\n            (c.fantasyName || \'\').toLowerCase().includes(term) ||\\n            (c.taxId || \'\').includes(term)\\n        ));\\n    }, [searchTerm, clients]);\\n\\n    useEffect(() => {\\n        if (selectedClient && activeTab === \'SERVICIOS\') {\\n            loadServices(selectedClient.id);\\n        }\\n    }, [selectedClient, activeTab]);\\n\\n    //  FUNCIN DE AUDITORA CENTRALIZADA\\n    const registrarAuditoria = async (accion: string, detalle: string) => {\\n        try {\\n            const auth = getAuth();\\n            const u = auth.currentUser;\\n            const nombreReal = u?.displayName || u?.email || \\"Usuario Desconocido\\";\\n\\n            await addDoc(collection(db, \'audit_logs\'), {\\n                timestamp: serverTimestamp(),\\n                actorUid: u?.uid || \\"unknown\\",\\n                actorName: nombreReal, \\n                action: accion,\\n                module: \'CRM\',\\n                details: detalle,\\n                metadata: { platform: \'web\' }\\n            });\\n        } catch (error) {\\n            console.error(\\"Error auditor铆a:\\", error);\\n        }\\n    };\\n\\n    const fetchClients = async () => {\\n        try {\\n            const q = query(collection(db, \'clients\'), orderBy(\'name\'));\\n            const s = await getDocs(q);\\n            const data = s.docs.map(d => ({ id: d.id, ...d.data() }));\\n            setClients(data);\\n            setFilteredClients(data);\\n        } catch (e) { console.error(e); }\\n    };\\n\\n    const loadServices = async (clientId: string) => {\\n        try {\\n            const q1 = query(collection(db, \'servicios_sla\'), where(\'clientId\', \'==\', clientId));\\n            const s1 = await getDocs(q1);\\n            const allDocs = s1.docs.map(d => ({ id: d.id, ...d.data() }));\\n            \\n            if (allDocs.length === 0) {\\n                // Fallback a colecci贸n legacy\\n                const q2 = query(collection(db, \'services\'), where(\'clientId\', \'==\', clientId));\\n                const s2 = await getDocs(q2);\\n                allDocs.push(...s2.docs.map(d => ({ id: d.id, ...d.data() })));\\n            }\\n\\n            const normalizedServices = allDocs.map((s:any) => ({\\n                id: s.id,\\n                name: s.objectiveName || s.name || \'Servicio\',\\n                start: s.startDate || s.start_date || s.fechaInicio || s.createdAt,\\n                status: s.status || \'Activo\',\\n                positions: s.positions || [],\\n                _raw: s\\n            }));\\n            setClientServices(normalizedServices);\\n        } catch (e) { console.error(e); }\\n    };\\n\\n    // --- LGICA AUTOCOMPLETADO GEO (Sedes) ---\\n    const handleAddressSearch = (text: string) => {\\n        setTempObjective({ ...tempObjective, address: text });\\n        \\n        if (searchTimeout.current) clearTimeout(searchTimeout.current);\\n        if (!text || text.length < 3) {\\n            setAddressSuggestions([]);\\n            return;\\n        }\\n\\n        searchTimeout.current = setTimeout(async () => {\\n            try {\\n                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(text)}&limit=5`);\\n                const data = await response.json();\\n                setAddressSuggestions(data);\\n                setShowSuggestions(true);\\n            } catch (error) { console.error(error); }\\n        }, 500);\\n    };\\n\\n    const selectAddress = (item: any) => {\\n        setTempObjective({\\n            ...tempObjective,\\n            address: item.display_name,\\n            lat: item.lat,\\n            lng: item.lon,\\n            coords: `${item.lat},${item.lon}`\\n        });\\n        setAddressSuggestions([]);\\n        setShowSuggestions(false);\\n    };\\n\\n    // --- ACCIONES CRUD CON AUDITORA ---\\n    const handleSaveInfo = async () => {\\n        if (!infoForm.name) return toast.error(\'Nombre/Raz贸n Social requerido\');\\n        try {\\n            const updated = { ...selectedClient, ...infoForm };\\n            await updateDoc(doc(db, \'clients\', selectedClient.id), infoForm);\\n            \\n            await registrarAuditoria(\'UPDATE_CLIENT_INFO\', `Actualiz贸 informaci贸n de: ${updated.name}`);\\n            \\n            setSelectedClient(updated);\\n            setClients(prev => prev.map(c => c.id === updated.id ? updated : c));\\n            setIsEditingInfo(false);\\n            toast.success(\'Informaci贸n guardada\');\\n        } catch (e) { toast.error(\'Error\'); }\\n    };\\n\\n    const saveObjective = async () => {\\n        try {\\n            let updatedObjectives = [...(selectedClient.objetivos || [])];\\n            const finalObj = {\\n                ...tempObjective,\\n                coords: tempObjective.coords || (tempObjective.lat ? `${tempObjective.lat},${tempObjective.lng}` : \'\')\\n            };\\n\\n            let actionDetail = \'\';\\n\\n            if (editingObjectiveId === \'NEW\') {\\n                updatedObjectives.push({ ...finalObj, id: Date.now().toString() });\\n                actionDetail = `Cre贸 sede: ${finalObj.name}`;\\n            } else {\\n                updatedObjectives = updatedObjectives.map(obj => \\n                    obj.id === editingObjectiveId ? { ...obj, ...finalObj } : obj\\n                );\\n                actionDetail = `Edit贸 sede: ${finalObj.name}`;\\n            }\\n\\n            await updateDoc(doc(db, \'clients\', selectedClient.id), { objetivos: updatedObjectives });\\n            await registrarAuditoria(\'UPDATE_OBJECTIVES\', `${actionDetail} para ${selectedClient.name}`);\\n\\n            setSelectedClient({ ...selectedClient, objetivos: updatedObjectives });\\n            setEditingObjectiveId(null);\\n            setTempObjective({});\\n            setAddressSuggestions([]);\\n            toast.success(\'Sede guardada\');\\n        } catch (e) { toast.error(\'Error\'); }\\n    };\\n\\n    const deleteObjective = async (objId: string) => {\\n        if (!confirm(\'驴Borrar sede?\')) return;\\n        const target = selectedClient.objetivos.find((o:any) => o.id === objId);\\n        const updated = selectedClient.objetivos.filter((o:any) => o.id !== objId);\\n        \\n        await updateDoc(doc(db, \'clients\', selectedClient.id), { objetivos: updated });\\n        await registrarAuditoria(\'DELETE_OBJECTIVE\', `Elimin贸 sede: ${target?.name} de ${selectedClient.name}`);\\n\\n        setSelectedClient({ ...selectedClient, objetivos: updated });\\n    };\\n\\n    const saveContact = async () => {\\n        try {\\n            let updated = [...(selectedClient.contactos || [])];\\n            let actionDetail = \'\';\\n\\n            if (editingContactId === \'NEW\') {\\n                updated.push({ ...tempContact, id: Date.now().toString() });\\n                actionDetail = `Cre贸 contacto: ${tempContact.name}`;\\n            }\\n            else {\\n                updated = updated.map(c => c.id === editingContactId ? { ...c, ...tempContact } : c);\\n                actionDetail = `Edit贸 contacto: ${tempContact.name}`;\\n            }\\n\\n            await updateDoc(doc(db, \'clients\', selectedClient.id), { contactos: updated });\\n            await registrarAuditoria(\'UPDATE_CONTACTS\', `${actionDetail} para ${selectedClient.name}`);\\n\\n            setSelectedClient({ ...selectedClient, contactos: updated });\\n            setEditingContactId(null);\\n            toast.success(\'Contacto guardado\');\\n        } catch (e) { toast.error(\'Error\'); }\\n    };\\n\\n    const deleteContact = async (cid: string) => {\\n        if (!confirm(\'驴Borrar?\')) return;\\n        const target = selectedClient.contactos.find((c:any) => c.id === cid);\\n        const updated = selectedClient.contactos.filter((c:any) => c.id !== cid);\\n        \\n        await updateDoc(doc(db, \'clients\', selectedClient.id), { contactos: updated });\\n        await registrarAuditoria(\'DELETE_CONTACT\', `Elimin贸 contacto: ${target?.name} de ${selectedClient.name}`);\\n\\n        setSelectedClient({ ...selectedClient, contactos: updated });\\n    };\\n\\n    const handleCreateNew = async () => {\\n        const newClient = { name: \'Nuevo Cliente\', status: \'ACTIVE\', createdAt: new Date().toISOString(), objetivos: [], contactos: [] };\\n        const ref = await addDoc(collection(db, \'clients\'), newClient);\\n        \\n        await registrarAuditoria(\'CREATE_CLIENT\', `Alta de cliente inicial`);\\n\\n        fetchClients();\\n        const created = { id: ref.id, ...newClient };\\n        setSelectedClient(created);\\n        setInfoForm(created);\\n        setIsEditingInfo(true);\\n        setView(\'detail\');\\n    };\\n\\n    const handleAddHistory = async () => {\\n        if (!historyNote) return;\\n        \\n        const auth = getAuth();\\n        const u = auth.currentUser;\\n        const userName = u?.displayName || u?.email || \\"Usuario\\";\\n\\n        const note = { date: new Date().toISOString(), note: historyNote, user: userName };\\n        \\n        await updateDoc(doc(db, \'clients\', selectedClient.id), { historial: arrayUnion(note) });\\n        await registrarAuditoria(\'ADD_HISTORY\', `Nota historial: ${historyNote} en ${selectedClient.name}`);\\n\\n        setSelectedClient({ ...selectedClient, historial: [...(selectedClient.historial || []), note] });\\n        setHistoryNote(\'\');\\n    };\\n\\n    // --- HELPERS VISUALES ---\\n    const getStatusColor = (status: string) => {\\n        if (status === \'INACTIVE\') return \'bg-slate-100 text-slate-500\';\\n        if (status === \'SUSPENDED\') return \'bg-amber-100 text-amber-700\';\\n        return \'bg-emerald-100 text-emerald-700\';\\n    };\\n\\n    return (\\n        <DashboardLayout>\\n            <Head><title>CRM | Ficha T茅cnica</title></Head>\\n            <Toaster position=\\"top-center\\" />\\n            <div className=\\"max-w-7xl mx-auto p-4 space-y-6 animate-in fade-in\\">\\n                \\n                {/* HEADER */}\\n                <header className=\\"flex justify-between items-end\\">\\n                    <div>\\n                        <h1 className=\\"text-3xl font-black uppercase text-slate-800\\">CRM</h1>\\n                        <p className=\\"text-[10px] text-indigo-500 mt-1\\">Usuario Activo: <b>{currentUserName}</b></p>\\n                    </div>\\n                    {view === \'list\' ? (\\n                        <button onClick={handleCreateNew} className=\\"bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase flex gap-2\\"><Plus size={16}/> Nuevo</button>\\n                    ) : (\\n                        <button onClick={() => setView(\'list\')} className=\\"text-slate-500 font-bold text-xs uppercase\\">Volver</button>\\n                    )}\\n                </header>\\n\\n                {/* VISTA: LISTA */}\\n                {view === \'list\' && (\\n                    <div className=\\"space-y-4\\">\\n                        <div className=\\"bg-white p-3 rounded-xl border flex items-center gap-2\\">\\n                            <Search className=\\"text-slate-400\\" size={18}/>\\n                            <input className=\\"w-full bg-transparent outline-none font-bold text-sm\\" placeholder=\\"Buscar...\\" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/>\\n                        </div>\\n                        <div className=\\"grid grid-cols-1 md:grid-cols-3 gap-4\\">\\n                            {filteredClients.map(c => (\\n                                <div key={c.id} onClick={() => { setSelectedClient(c); setInfoForm({}); setIsEditingInfo(false); setActiveTab(\'INFO\'); setView(\'detail\'); }} className=\\"bg-white p-5 rounded-2xl border hover:shadow-md cursor-pointer transition-all\\">\\n                                    <div className=\\"flex justify-between mb-2\\">\\n                                        <Building2 className=\\"text-indigo-500\\"/>\\n                                        <span className={`px-2 py-1 rounded text-[10px] font-black uppercase ${getStatusColor(c.status)}`}>{c.status === \'ACTIVE\' || !c.status ? \'Activo\' : c.status}</span>\\n                                    </div>\\n                                    <h3 className=\\"font-black text-lg truncate\\">{c.name}</h3>\\n                                    <p className=\\"text-xs text-slate-500 font-bold uppercase\\">{c.fantasyName}</p>\\n                                </div>\\n                            ))}\\n                        </div>\\n                    </div>\\n                )}\\n\\n                {/* VISTA: DETALLE */}\\n                {view === \'detail\' && selectedClient && (\\n                    <div className=\\"flex flex-col lg:flex-row gap-6\\">\\n                        \\n                        {/* SIDEBAR KPI */}\\n                        <div className=\\"w-full lg:w-1/3 bg-white p-6 rounded-3xl border h-fit\\">\\n                            <div className=\\"text-center mb-6\\">\\n                                <div className=\\"w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600\\"><Building2 size={40}/></div>\\n                                <h2 className=\\"text-xl font-black\\">{selectedClient.name}</h2>\\n                                <p className=\\"text-sm font-bold text-slate-500\\">{selectedClient.taxId || \'CUIT No Informado\'}</p>\\n                                <span className={`mt-2 inline-block px-3 py-1 rounded-full text-[10px] font-black uppercase ${getStatusColor(selectedClient.status)}`}>\\n                                    {selectedClient.status === \'ACTIVE\' || !selectedClient.status ? \'Activo\' : selectedClient.status}\\n                                </span>\\n                            </div>\\n                            <div className=\\"space-y-3 text-xs font-bold text-slate-600\\">\\n                                <div className=\\"p-3 bg-slate-50 rounded-xl flex gap-3\\"><Mail size={16}/> {selectedClient.email || \'-\'}</div>\\n                                <div className=\\"p-3 bg-slate-50 rounded-xl flex gap-3\\"><Phone size={16}/> {selectedClient.phone || \'-\'}</div>\\n                                <div className=\\"p-3 bg-slate-50 rounded-xl flex gap-3\\">\\n                                    <MapPin size={16}/> \\n                                    {selectedClient.city ? `${selectedClient.city}, ${selectedClient.province}` : (selectedClient.address || \'-\')}\\n                                </div>\\n                            </div>\\n                        </div>\\n\\n                        {/* CONTENIDO PRINCIPAL */}\\n                        <div className=\\"flex-1 bg-white rounded-3xl border overflow-hidden flex flex-col\\">\\n                            <div className=\\"flex border-b overflow-x-auto\\">\\n                                {[\'INFO\', \'SEDES\', \'CONTACTOS\', \'SERVICIOS\', \'HISTORIAL\'].map(t => (\\n                                    <button key={t} onClick={() => setActiveTab(t)} className={`px-6 py-4 text-xs font-black uppercase border-b-2 ${activeTab === t ? \'border-indigo-600 text-indigo-600\' : \'border-transparent text-slate-400\'}`}>{t}</button>\\n                                ))}\\n                            </div>\\n                            <div className=\\"p-6 flex-1 overflow-y-auto min-h-[400px]\\">\\n                                \\n                                {/* 1. PESTAA INFO (ESTRUCTURA NUEVA V18) */}\\n                                {activeTab === \'INFO\' && (\\n                                    <div className=\\"space-y-4\\">\\n                                        <div className=\\"flex justify-between items-center mb-4\\">\\n                                            <h3 className=\\"font-bold text-sm uppercase\\">Ficha de Cliente</h3>\\n                                            {!isEditingInfo ? (\\n                                                <button onClick={() => { setInfoForm({...selectedClient}); setIsEditingInfo(true); }} className=\\"text-indigo-600 text-xs font-bold uppercase flex gap-1 hover:underline\\"><Edit2 size={12}/> Editar</button>\\n                                            ) : (\\n                                                <div className=\\"flex gap-2\\"><button onClick={() => setIsEditingInfo(false)} className=\\"text-slate-400 text-xs font-bold\\">Cancelar</button><button onClick={handleSaveInfo} className=\\"text-emerald-600 text-xs font-bold\\">Guardar</button></div>\\n                                            )}\\n                                        </div>\\n\\n                                        {isEditingInfo ? (\\n                                            <div className=\\"space-y-6 animate-in fade-in\\">\\n                                                {/* A. IDENTIFICACIN */}\\n                                                <div className=\\"bg-slate-50 p-4 rounded-xl border border-slate-100\\">\\n                                                    <h4 className=\\"text-[10px] font-black uppercase text-indigo-400 mb-3 flex items-center gap-2\\"><Building2 size={12}/> Identificaci贸n (Core)</h4>\\n                                                    <div className=\\"grid grid-cols-2 gap-4\\">\\n                                                        <div><label className=\\"text-[10px] font-bold text-slate-400\\">Tipo de Cliente</label>\\n                                                            <select className=\\"w-full p-2 border rounded font-bold text-xs\\" value={infoForm.clientType||\'JURIDICA\'} onChange={e=>setInfoForm({...infoForm, clientType:e.target.value})}>\\n                                                                <option value=\\"JURIDICA\\">Persona Jur铆dica (Empresa)</option>\\n                                                                <option value=\\"FISICA\\">Persona F铆sica</option>\\n                                                            </select>\\n                                                        </div>\\n                                                        <div><label className=\\"text-[10px] font-bold text-slate-400\\">CUIT / DNI</label><input className=\\"w-full p-2 border rounded font-bold\\" value={infoForm.taxId||\'\'} onChange={e=>setInfoForm({...infoForm, taxId:e.target.value})}/></div>\\n                                                        <div className=\\"col-span-2\\"><label className=\\"text-[10px] font-bold text-slate-400\\">Raz贸n Social (Legal)</label><input className=\\"w-full p-2 border rounded font-bold\\" value={infoForm.name||\'\'} onChange={e=>setInfoForm({...infoForm, name:e.target.value})}/></div>\\n                                                        <div className=\\"col-span-2\\"><label className=\\"text-[10px] font-bold text-slate-400\\">Nombre Fantas铆a</label><input className=\\"w-full p-2 border rounded font-bold\\" value={infoForm.fantasyName||\'\'} onChange={e=>setInfoForm({...infoForm, fantasyName:e.target.value})}/></div>\\n                                                    </div>\\n                                                </div>\\n\\n                                                {/* B. UBICACIN Y CONTACTO */}\\n                                                <div className=\\"bg-slate-50 p-4 rounded-xl border border-slate-100\\">\\n                                                    <h4 className=\\"text-[10px] font-black uppercase text-indigo-400 mb-3 flex items-center gap-2\\"><MapPin size={12}/> Direcci贸n Legal y Contacto</h4>\\n                                                    <div className=\\"grid grid-cols-6 gap-3\\">\\n                                                        <div className=\\"col-span-4\\"><label className=\\"text-[10px] font-bold text-slate-400\\">Calle</label><input className=\\"w-full p-2 border rounded\\" value={infoForm.street||\'\'} onChange={e=>setInfoForm({...infoForm, street:e.target.value})}/></div>\\n                                                        <div className=\\"col-span-1\\"><label className=\\"text-[10px] font-bold text-slate-400\\">N煤mero</label><input className=\\"w-full p-2 border rounded\\" value={infoForm.number||\'\'} onChange={e=>setInfoForm({...infoForm, number:e.target.value})}/></div>\\n                                                        <div className=\\"col-span-1\\"><label className=\\"text-[10px] font-bold text-slate-400\\">Piso/Dpto</label><input className=\\"w-full p-2 border rounded\\" value={infoForm.floor||\'\'} onChange={e=>setInfoForm({...infoForm, floor:e.target.value})}/></div>\\n                                                        \\n                                                        <div className=\\"col-span-2\\"><label className=\\"text-[10px] font-bold text-slate-400\\">C贸digo Postal</label><input className=\\"w-full p-2 border rounded\\" value={infoForm.zipCode||\'\'} onChange={e=>setInfoForm({...infoForm, zipCode:e.target.value})}/></div>\\n                                                        <div className=\\"col-span-2\\"><label className=\\"text-[10px] font-bold text-slate-400\\">Localidad</label><input className=\\"w-full p-2 border rounded\\" value={infoForm.city||\'\'} onChange={e=>setInfoForm({...infoForm, city:e.target.value})}/></div>\\n                                                        <div className=\\"col-span-2\\"><label className=\\"text-[10px] font-bold text-slate-400\\">Provincia</label><input className=\\"w-full p-2 border rounded\\" value={infoForm.province||\'\'} onChange={e=>setInfoForm({...infoForm, province:e.target.value})}/></div>\\n\\n                                                        <div className=\\"col-span-3 mt-2\\"><label className=\\"text-[10px] font-bold text-slate-400\\">Email Principal</label><input className=\\"w-full p-2 border rounded\\" value={infoForm.email||\'\'} onChange={e=>setInfoForm({...infoForm, email:e.target.value})}/></div>\\n                                                        <div className=\\"col-span-3 mt-2\\"><label className=\\"text-[10px] font-bold text-slate-400\\">Tel茅fono</label><input className=\\"w-full p-2 border rounded\\" value={infoForm.phone||\'\'} onChange={e=>setInfoForm({...infoForm, phone:e.target.value})}/></div>\\n                                                    </div>\\n                                                </div>\\n\\n                                                {/* C. DATOS FISCALES */}\\n                                                <div className=\\"bg-slate-50 p-4 rounded-xl border border-slate-100\\">\\n                                                    <h4 className=\\"text-[10px] font-black uppercase text-indigo-400 mb-3 flex items-center gap-2\\"><CreditCard size={12}/> Datos Fiscales</h4>\\n                                                    <div className=\\"grid grid-cols-2 gap-4\\">\\n                                                        <div><label className=\\"text-[10px] font-bold text-slate-400\\">Condici贸n IVA</label>\\n                                                            <select className=\\"w-full p-2 border rounded text-xs\\" value={infoForm.ivaCondition||\'RI\'} onChange={e=>setInfoForm({...infoForm, ivaCondition:e.target.value})}>\\n                                                                <option value=\\"RI\\">Responsable Inscripto</option>\\n                                                                <option value=\\"MONOTRIBUTO\\">Monotributo</option>\\n                                                                <option value=\\"EXENTO\\">Exento</option>\\n                                                                <option value=\\"CF\\">Consumidor Final</option>\\n                                                            </select>\\n                                                        </div>\\n                                                        <div><label className=\\"text-[10px] font-bold text-slate-400\\">Ingresos Brutos (IIBB)</label><input className=\\"w-full p-2 border rounded\\" value={infoForm.iibb||\'\'} onChange={e=>setInfoForm({...infoForm, iibb:e.target.value})}/></div>\\n                                                    </div>\\n                                                </div>\\n\\n                                                {/* D. SISTEMA */}\\n                                                <div className=\\"bg-slate-50 p-4 rounded-xl border border-slate-100\\">\\n                                                    <h4 className=\\"text-[10px] font-black uppercase text-indigo-400 mb-3 flex items-center gap-2\\"><ShieldCheck size={12}/> Auditor铆a y Estado</h4>\\n                                                    <div className=\\"grid grid-cols-2 gap-4\\">\\n                                                        <div><label className=\\"text-[10px] font-bold text-slate-400\\">Estado del Cliente</label>\\n                                                            <select className=\\"w-full p-2 border rounded font-bold text-xs\\" value={infoForm.status||\'ACTIVE\'} onChange={e=>setInfoForm({...infoForm, status:e.target.value})}>\\n                                                                <option value=\\"ACTIVE\\">Activo</option>\\n                                                                <option value=\\"INACTIVE\\">Inactivo</option>\\n                                                                <option value=\\"SUSPENDED\\">Suspendido</option>\\n                                                            </select>\\n                                                        </div>\\n                                                        <div><label className=\\"text-[10px] font-bold text-slate-400\\">ID Interno</label><input className=\\"w-full p-2 border rounded bg-slate-200 text-slate-500\\" value={selectedClient.id} disabled/></div>\\n                                                    </div>\\n                                                </div>\\n                                            </div>\\n                                        ) : (\\n                                            <div className=\\"space-y-6\\">\\n                                                {/* LECTURA: IDENTIFICACIN */}\\n                                                <div className=\\"grid grid-cols-2 gap-4\\">\\n                                                    <div className=\\"p-3 bg-white border rounded-xl\\"><label className=\\"text-[9px] font-black text-slate-400 uppercase\\">Raz贸n Social</label><p className=\\"font-bold text-sm\\">{selectedClient.name}</p></div>\\n                                                    <div className=\\"p-3 bg-white border rounded-xl\\"><label className=\\"text-[9px] font-black text-slate-400 uppercase\\">Fantas铆a</label><p className=\\"font-bold text-sm\\">{selectedClient.fantasyName || \'-\'}</p></div>\\n                                                    <div className=\\"p-3 bg-white border rounded-xl\\"><label className=\\"text-[9px] font-black text-slate-400 uppercase\\">CUIT</label><p className=\\"font-bold text-sm\\">{selectedClient.taxId || \'-\'}</p></div>\\n                                                    <div className=\\"p-3 bg-white border rounded-xl\\"><label className=\\"text-[9px] font-black text-slate-400 uppercase\\">Tipo</label><p className=\\"font-bold text-sm\\">{selectedClient.clientType === \'FISICA\' ? \'Persona F铆sica\' : \'Persona Jur铆dica\'}</p></div>\\n                                                </div>\\n\\n                                                {/* LECTURA: UBICACIN */}\\n                                                <div>\\n                                                    <h4 className=\\"text-[10px] font-black uppercase text-slate-400 mb-2 border-b pb-1\\">Ubicaci贸n Legal</h4>\\n                                                    <div className=\\"p-4 bg-slate-50 rounded-xl border border-slate-100 flex gap-4 items-center\\">\\n                                                        <MapPin className=\\"text-slate-400\\"/>\\n                                                        <div>\\n                                                            <p className=\\"font-bold text-sm\\">\\n                                                                {selectedClient.street ? `${selectedClient.street} ${selectedClient.number || \'\'}` : (selectedClient.address || \'Sin direcci贸n\')}\\n                                                            </p>\\n                                                            {selectedClient.city && <p className=\\"text-xs text-slate-500\\">{selectedClient.floor ? `Piso ${selectedClient.floor}, ` : \'\'}{selectedClient.city}, {selectedClient.province} (CP {selectedClient.zipCode})</p>}\\n                                                        </div>\\n                                                    </div>\\n                                                </div>\\n\\n                                                {/* LECTURA: FISCAL */}\\n                                                <div>\\n                                                    <h4 className=\\"text-[10px] font-black uppercase text-slate-400 mb-2 border-b pb-1\\">Datos Fiscales</h4>\\n                                                    <div className=\\"grid grid-cols-2 gap-4\\">\\n                                                        <div className=\\"p-3 bg-white border rounded-xl\\"><label className=\\"text-[9px] font-black text-slate-400 uppercase\\">Condici贸n IVA</label><p className=\\"font-bold text-sm\\">{selectedClient.ivaCondition || \'-\'}</p></div>\\n                                                        <div className=\\"p-3 bg-white border rounded-xl\\"><label className=\\"text-[9px] font-black text-slate-400 uppercase\\">Ingresos Brutos</label><p className=\\"font-bold text-sm\\">{selectedClient.iibb || \'-\'}</p></div>\\n                                                    </div>\\n                                                </div>\\n                                            </div>\\n                                        )}\\n                                    </div>\\n                                )}\\n\\n                                {/* --- SEDES CON AUTOCOMPLETE (MANTENIDO V17) --- */}\\n                                {activeTab === \'SEDES\' && (\\n                                    <div className=\\"space-y-4\\">\\n                                        <button onClick={() => { setEditingObjectiveId(\'NEW\'); setTempObjective({ name: \'\', address: \'\' }); }} className=\\"text-indigo-600 text-xs font-bold uppercase hover:underline\\">+ Agregar Sede</button>\\n                                        \\n                                        {editingObjectiveId === \'NEW\' && (\\n                                            <div className=\\"p-4 bg-indigo-50 border rounded-xl space-y-3 relative\\">\\n                                                <input autoFocus placeholder=\\"Nombre Sede\\" className=\\"w-full p-2 rounded border\\" value={tempObjective.name} onChange={e => setTempObjective({...tempObjective, name: e.target.value})}/>\\n                                                <div className=\\"relative\\">\\n                                                    <input \\n                                                        placeholder=\\"Direcci贸n (Escriba para buscar...)\\" \\n                                                        className=\\"w-full p-2 rounded border\\" \\n                                                        value={tempObjective.address} \\n                                                        onChange={e => handleAddressSearch(e.target.value)}\\n                                                    />\\n                                                    {addressSuggestions.length > 0 && showSuggestions && (\\n                                                        <ul className=\\"absolute z-50 left-0 right-0 top-full mt-1 bg-white border rounded-xl shadow-xl max-h-48 overflow-y-auto\\">\\n                                                            {addressSuggestions.map((item:any, idx) => (\\n                                                                <li key={idx} onClick={() => selectAddress(item)} className=\\"p-2 text-xs hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2\\">\\n                                                                        <Navigation size={10} className=\\"text-indigo-500\\"/> {item.display_name}\\n                                                                </li>\\n                                                            ))}\\n                                                        </ul>\\n                                                    )}\\n                                                </div>\\n                                                <div className=\\"flex gap-2\\">\\n                                                    <input className=\\"w-1/2 p-2 rounded border bg-slate-100\\" value={tempObjective.lat || tempObjective.coords?.split(\',\')[0]} readOnly/>\\n                                                    <input className=\\"w-1/2 p-2 rounded border bg-slate-100\\" value={tempObjective.lng || tempObjective.coords?.split(\',\')[1]} readOnly/>\\n                                                </div>\\n                                                <div className=\\"flex justify-end gap-2\\"><button onClick={() => setEditingObjectiveId(null)} className=\\"px-3 py-1 bg-white rounded text-xs\\">Cancelar</button><button onClick={saveObjective} className=\\"px-3 py-1 bg-indigo-600 text-white rounded text-xs\\">Guardar</button></div>\\n                                            </div>\\n                                        )}\\n\\n                                        {selectedClient.objetivos?.map((obj:any) => (\\n                                            <div key={obj.id} className=\\"p-3 border rounded-xl bg-slate-50\\">\\n                                                {editingObjectiveId === obj.id ? (\\n                                                    <div className=\\"space-y-2\\">\\n                                                        <input className=\\"w-full p-2 rounded border font-bold\\" value={tempObjective.name} onChange={e => setTempObjective({...tempObjective, name: e.target.value})}/>\\n                                                        <div className=\\"relative\\">\\n                                                            <input className=\\"w-full p-2 rounded border\\" value={tempObjective.address} onChange={e => handleAddressSearch(e.target.value)}/>\\n                                                            {addressSuggestions.length > 0 && showSuggestions && (\\n                                                                <ul className=\\"absolute z-50 left-0 right-0 top-full mt-1 bg-white border rounded-xl shadow-xl max-h-48 overflow-y-auto\\">\\n                                                                        {addressSuggestions.map((item:any, idx) => (\\n                                                                            <li key={idx} onClick={() => selectAddress(item)} className=\\"p-2 text-xs hover:bg-indigo-50 cursor-pointer border-b\\">\\n                                                                                {item.display_name}\\n                                                                            </li>\\n                                                                        ))}\\n                                                                </ul>\\n                                                            )}\\n                                                        </div>\\n                                                        <div className=\\"flex gap-2\\">\\n                                                            <input className=\\"w-1/2 p-2 rounded border bg-slate-100\\" value={tempObjective.lat || tempObjective.coords?.split(\',\')[0]} readOnly/>\\n                                                            <input className=\\"w-1/2 p-2 rounded border bg-slate-100\\" value={tempObjective.lng || tempObjective.coords?.split(\',\')[1]} readOnly/>\\n                                                        </div>\\n                                                        <div className=\\"flex justify-end gap-2\\"><button onClick={() => setEditingObjectiveId(null)} className=\\"text-xs\\">Cancelar</button><button onClick={saveObjective} className=\\"text-xs text-emerald-600 font-bold\\">Guardar</button></div>\\n                                                    </div>\\n                                                ) : (\\n                                                    <div className=\\"flex justify-between items-center\\">\\n                                                        <div>\\n                                                            <div className=\\"font-bold text-sm text-slate-800\\">{obj.name}</div>\\n                                                            <div className=\\"text-xs text-slate-500\\">{obj.address}</div>\\n                                                            {(obj.lat && obj.lng) && <div className=\\"text-[10px] text-indigo-500 mt-1 flex items-center gap-1\\"><Crosshair size={10}/> GPS OK</div>}\\n                                                        </div>\\n                                                        <div className=\\"flex gap-2\\">\\n                                                            {(obj.lat && obj.lng) && <a href={`http://maps.google.com/?q=${obj.lat},${obj.lng}`} target=\\"_blank\\" className=\\"p-2 bg-white border rounded text-indigo-500\\"><ExternalLink size={14}/></a>}\\n                                                            <button onClick={() => { setEditingObjectiveId(obj.id); setTempObjective(obj); }} className=\\"p-2 bg-white border rounded hover:text-indigo-600\\"><Edit2 size={14}/></button>\\n                                                            <button onClick={() => deleteObjective(obj.id)} className=\\"p-2 bg-white border rounded hover:text-rose-500\\"><Trash2 size={14}/></button>\\n                                                        </div>\\n                                                    </div>\\n                                                )}\\n                                            </div>\\n                                        ))}\\n                                    </div>\\n                                )}\\n\\n                                {/* CONTACTOS */}\\n                                {activeTab === \'CONTACTOS\' && (\\n                                    <div className=\\"space-y-4\\">\\n                                        <button onClick={() => { setEditingContactId(\'NEW\'); setTempContact({}); }} className=\\"text-indigo-600 text-xs font-bold uppercase hover:underline\\">+ Agregar Contacto</button>\\n                                        \\n                                        {editingContactId === \'NEW\' && (\\n                                            <div className=\\"p-4 bg-indigo-50 border rounded-xl space-y-3\\">\\n                                                <div className=\\"grid grid-cols-2 gap-2\\">\\n                                                    <input autoFocus placeholder=\\"Nombre\\" className=\\"p-2 rounded border\\" value={tempContact.name||\'\'} onChange={e => setTempContact({...tempContact, name: e.target.value})}/>\\n                                                    <input placeholder=\\"Cargo\\" className=\\"p-2 rounded border\\" value={tempContact.role||\'\'} onChange={e => setTempContact({...tempContact, role: e.target.value})}/>\\n                                                </div>\\n                                                <input placeholder=\\"Email / Tel\\" className=\\"w-full p-2 rounded border\\" value={tempContact.phone||\'\'} onChange={e => setTempContact({...tempContact, phone: e.target.value})}/>\\n                                                <div className=\\"flex justify-end gap-2\\"><button onClick={() => setEditingContactId(null)} className=\\"px-3 py-1 bg-white rounded text-xs\\">Cancelar</button><button onClick={saveContact} className=\\"px-3 py-1 bg-indigo-600 text-white rounded text-xs\\">Guardar</button></div>\\n                                            </div>\\n                                        )}\\n\\n                                        {selectedClient.contactos?.map((c:any) => (\\n                                            <div key={c.id} className=\\"p-4 bg-white border rounded-xl flex justify-between items-center\\">\\n                                                {editingContactId === c.id ? (\\n                                                    <div className=\\"flex-1 space-y-2 mr-4\\">\\n                                                        <input className=\\"w-full p-1 border rounded\\" value={tempContact.name} onChange={e=>setTempContact({...tempContact, name:e.target.value})}/>\\n                                                        <input className=\\"w-full p-1 border rounded\\" value={tempContact.phone} onChange={e=>setTempContact({...tempContact, phone:e.target.value})}/>\\n                                                        <div className=\\"flex justify-end gap-2\\"><button onClick={()=>setEditingContactId(null)} className=\\"text-xs\\">Cancelar</button><button onClick={saveContact} className=\\"text-xs text-emerald-600 font-bold\\">Guardar</button></div>\\n                                                    </div>\\n                                                ) : (\\n                                                    <>\\n                                                        <div className=\\"flex items-center gap-3\\">\\n                                                            <div className=\\"w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-black\\"><User size={14}/></div>\\n                                                            <div><p className=\\"font-bold text-sm\\">{c.name}</p><p className=\\"text-[10px] text-slate-400\\">{c.role}  {c.phone}</p></div>\\n                                                        </div>\\n                                                        <div className=\\"flex gap-2\\">\\n                                                            <button onClick={()=>{setEditingContactId(c.id); setTempContact(c)}} className=\\"text-slate-300 hover:text-indigo-600\\"><Edit2 size={16}/></button>\\n                                                            <button onClick={()=>deleteContact(c.id)} className=\\"text-slate-300 hover:text-rose-500\\"><Trash2 size={16}/></button>\\n                                                        </div>\\n                                                    </>\\n                                                )}\\n                                            </div>\\n                                        ))}\\n                                    </div>\\n                                )}\\n\\n                                {/* SERVICIOS */}\\n                                {activeTab === \'SERVICIOS\' && (\\n                                    <div className=\\"space-y-4\\">\\n                                        <div className=\\"flex justify-between\\"><h3 className=\\"font-bold text-sm uppercase\\">Servicios Activos</h3><button onClick={() => setShowDebug(!showDebug)} className=\\"text-[10px] text-slate-300 flex gap-1 items-center hover:text-slate-500\\"><Bug size={12}/> Debug</button></div>\\n                                        {showDebug && <div className=\\"p-4 bg-slate-900 text-emerald-400 font-mono text-[10px] rounded-xl overflow-auto max-h-40\\">{JSON.stringify(clientServices, null, 2)}</div>}\\n                                        {clientServices.map(s => (\\n                                            <div key={s.id} className=\\"p-4 border rounded-xl bg-slate-50/50\\">\\n                                                <div className=\\"flex justify-between items-start\\">\\n                                                    <div><h4 className=\\"font-black text-slate-800 uppercase\\">{s.name}</h4><p className=\\"text-xs text-slate-500 font-medium mt-1\\">Inicio: {s.start ? new Date(s.start.seconds ? s.start.seconds * 1000 : s.start).toLocaleDateString() : \'-\'}</p></div>\\n                                                    <span className=\\"px-3 py-1 bg-emerald-100 text-emerald-700 rounded-lg text-[10px] font-black uppercase\\">{s.status}</span>\\n                                                </div>\\n                                                {s.positions?.length > 0 && <div className=\\"mt-2 pt-2 border-t flex gap-2 flex-wrap\\">{s.positions.map((p:any, i:number) => <span key={i} className=\\"text-[10px] bg-white border px-2 py-1 rounded font-bold text-slate-600\\">{p.quantity}x {p.name}</span>)}</div>}\\n                                            </div>\\n                                        ))}\\n                                        {clientServices.length === 0 && <p className=\\"text-center text-slate-400 text-xs py-8 border-2 border-dashed rounded-xl\\">No hay servicios.</p>}\\n                                    </div>\\n                                )}\\n\\n                                {activeTab === \'HISTORIAL\' && (\\n                                    <div className=\\"flex flex-col h-full\\">\\n                                        <div className=\\"flex-1 space-y-4 mb-4\\">\\n                                            {selectedClient.historial?.map((h:any, i:number) => (\\n                                                <div key={i} className=\\"flex gap-4\\">\\n                                                    <div className=\\"w-2 h-2 bg-indigo-400 rounded-full mt-1.5 shrink-0\\"></div>\\n                                                    <div><p className=\\"text-xs text-slate-400 font-mono\\">{new Date(h.date).toLocaleString()} - <b>{h.user}</b></p><p className=\\"text-sm font-medium\\">{h.note}</p></div>\\n                                                </div>\\n                                            ))}\\n                                        </div>\\n                                        <div className=\\"flex gap-2 pt-4 border-t\\"><input className=\\"flex-1 bg-slate-50 border rounded-xl px-4 text-xs font-bold outline-none\\" placeholder=\\"Nota...\\" value={historyNote} onChange={e => setHistoryNote(e.target.value)} onKeyDown={e => e.key === \'Enter\' && handleAddHistory()}/><button onClick={handleAddHistory} className=\\"p-3 bg-indigo-600 text-white rounded-xl\\"><Send size={16}/></button></div>\\n                                    </div>\\n                                )}\\n                            </div>\\n                        </div>\\n                    </div>\\n                )}\\n            </div>\\n        </DashboardLayout>\\n    );\\n}"},{"id":"a9yxn58uo","name":"dashboard.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\dashboard.tsx","area":"FRONTEND","content":"import React, { useEffect, useState } from \'react\';\\nimport Head from \'next/head\';\\nimport { \\n  Shield, Users, Clock, AlertTriangle, \\n  Briefcase, Activity, Calendar, \\n  AlertOctagon, UserCheck, TrendingUp, Zap, MapPin, \\n  Building2, BarChart3, PieChart as PieChartIcon, LayoutDashboard, UserX, Target, Filter\\n} from \'lucide-react\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { withAuthGuard } from \'@/components/common/withAuthGuard\';\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, getDocs, query, where, Timestamp, getCountFromServer } from \'firebase/firestore\';\\nimport { \\n  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, \\n  PieChart, Pie, Cell, AreaChart, Area, Legend \\n} from \'recharts\';\\n\\n// --- TIPOS ---\\ninterface IDashboardStats {\\n  clientsCount: number;\\n  objectivesCount: number;\\n  servicesCount: number;\\n  activeEmployees: number;\\n  totalEmployees: number;\\n  coverage: number;\\n  totalHours: number;\\n  overtimeHours: number;\\n  absentCount: number;\\n  lateCount: number;\\n  incidentCount: number;\\n}\\n\\ninterface IChartData {\\n  name: string;\\n  value: number;\\n  color?: string;\\n}\\n\\ntype TimeRange = \'day\' | \'week\' | \'month\';\\n\\nconst COLORS = [\'#6366f1\', \'#10b981\', \'#f59e0b\', \'#ef4444\', \'#8b5cf6\', \'#ec4899\', \'#06b6d4\'];\\n\\nconst KpiCard = ({ title, value, icon: Icon, color, subtext, trend }: any) => (\\n  <div className=\\"bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-all duration-300 group\\">\\n    <div className=\\"flex justify-between items-start mb-4\\">\\n      <div className={\'p-3 rounded-xl bg-opacity-10 text-current \' + color}>\\n        <Icon size={24} className={color.replace(\'bg-\', \'text-\')} />\\n      </div>\\n      {trend && (\\n        <span className={\'text-xs font-bold px-2 py-1 rounded-full \' + (trend === \'up\' ? \'bg-emerald-100 text-emerald-600\' : \'bg-rose-100 text-rose-600\')}>\\n          {trend === \'up\' ? \'\' : \'\'}\\n        </span>\\n      )}\\n    </div>\\n    <div>\\n      <h3 className=\\"text-3xl font-black text-slate-800 dark:text-white mb-1\\">{value}</h3>\\n      <p className=\\"text-xs font-bold text-slate-400 uppercase tracking-wider\\">{title}</p>\\n      {subtext && <p className=\\"text-xs text-slate-500 mt-2 font-medium\\">{subtext}</p>}\\n    </div>\\n  </div>\\n);\\n\\nfunction AdminDashboard() {\\n  const [loading, setLoading] = useState(true);\\n  const [timeRange, setTimeRange] = useState<TimeRange>(\'day\');\\n  \\n  const [stats, setStats] = useState<IDashboardStats>({ \\n    clientsCount: 0, objectivesCount: 0, servicesCount: 0,\\n    activeEmployees: 0, totalEmployees: 0,\\n    coverage: 0, totalHours: 0, overtimeHours: 0,\\n    absentCount: 0, lateCount: 0, incidentCount: 0\\n  });\\n\\n  const [mainChartData, setMainChartData] = useState<any[]>([]); \\n  const [topClients, setTopClients] = useState<any[]>([]);\\n  const [absenceReasons, setAbsenceReasons] = useState<any[]>([]);\\n  const [employeeDistribution, setEmployeeDistribution] = useState<any[]>([]);\\n\\n  const today = new Date();\\n\\n  useEffect(() => {\\n    fetchData();\\n  }, [timeRange]); \\n\\n  const getRangeDates = () => {\\n      const now = new Date();\\n      let start = new Date(now);\\n      let end = new Date(now);\\n\\n      if (timeRange === \'day\') {\\n          start.setHours(0,0,0,0);\\n          end.setHours(23,59,59,999);\\n      } else if (timeRange === \'week\') {\\n          start.setDate(now.getDate() - 6); \\n          start.setHours(0,0,0,0);\\n          end.setHours(23,59,59,999);\\n      } else if (timeRange === \'month\') {\\n          start.setDate(1); \\n          start.setHours(0,0,0,0);\\n          end = new Date(now.getFullYear(), now.getMonth() + 1, 0); \\n          end.setHours(23,59,59,999);\\n      }\\n      return { start, end };\\n  };\\n\\n  const fetchData = async () => {\\n      setLoading(true);\\n      try {\\n        const { start, end } = getRangeDates();\\n\\n        // 1. CARGA DE CLIENTES Y OBJETIVOS (MAPEO)\\n        const clientsSnap = await getDocs(collection(db, \'clients\'));\\n        const servicesSnap = await getDocs(collection(db, \'servicios_sla\'));\\n        \\n        let clientCount = 0;\\n        let objCount = 0;\\n        const objectiveMap: Record<string, string> = {}; \\n        const clientMap: Record<string, string> = {};\\n\\n        clientsSnap.forEach(doc => {\\n            clientCount++;\\n            const data = doc.data();\\n            if (data.name) clientMap[doc.id] = data.name;\\n            if (data.objetivos && Array.isArray(data.objetivos)) {\\n                objCount += data.objetivos.length;\\n                data.objetivos.forEach((obj: any) => {\\n                    if (obj.id && obj.name) {\\n                        objectiveMap[obj.id] = obj.name;\\n                    }\\n                });\\n            }\\n        });\\n\\n        // 2. RECURSOS HUMANOS\\n        const employeesSnap = await getDocs(collection(db, \'empleados\'));\\n        const date30DaysAgo = new Date();\\n        date30DaysAgo.setDate(date30DaysAgo.getDate() - 30);\\n        const absencesSnap = await getDocs(query(collection(db, \'ausencias\'), where(\'startDate\', \'>=\', date30DaysAgo.toISOString().split(\'T\')[0])));\\n\\n        // 3. OPERATIVA\\n        const shiftsSnap = await getDocs(query(\\n            collection(db, \'turnos\'),\\n            where(\'startTime\', \'>=\', Timestamp.fromDate(start)),\\n            where(\'startTime\', \'<=\', Timestamp.fromDate(end))\\n        ));\\n\\n        // --- PROCESAMIENTO ---\\n        let totalH = 0;\\n        let extraH = 0;\\n        let vacancies = 0;\\n        let uniqueGuards = new Set<string>();\\n        let absencesToday = 0;\\n        let lates = 0;\\n        let incidents = 0;\\n        let clientHours: Record<string, number> = {};\\n\\n        // PREPARAR ESTRUCTURA DEL GRFICO PRINCIPAL\\n        let chartDataMap: Record<string, number> = {};\\n        \\n        if (timeRange === \'day\') {\\n            for(let i=0; i<24; i++) {\\n                chartDataMap[i + \'h\'] = 0;\\n            }\\n        } else {\\n            let loopDate = new Date(start);\\n            while(loopDate <= end) {\\n                const label = loopDate.getDate().toString();\\n                chartDataMap[label] = 0;\\n                loopDate.setDate(loopDate.getDate() + 1);\\n            }\\n        }\\n\\n        shiftsSnap.forEach(doc => {\\n            const s = doc.data();\\n            if (s.status === \'Canceled\') return;\\n\\n            const shiftStart = s.startTime.toDate();\\n            const shiftEnd = s.endTime.toDate();\\n            const duration = (shiftEnd.getTime() - shiftStart.getTime()) / 3600000;\\n\\n            if (!s.employeeId || s.employeeId === \'VACANTE\') {\\n                vacancies++;\\n            } else {\\n                uniqueGuards.add(s.employeeId);\\n                totalH += duration;\\n                if (s.isExtended || s.isEarlyStart || s.isFrancoTrabajado) extraH += duration;\\n                if (s.status === \'ABSENT\') absencesToday++;\\n                if (s.status === \'LATE\') lates++;\\n                if (s.hasNovedad) incidents++;\\n\\n                // LGICA DE GRFICO DINMICO\\n                if (timeRange === \'day\') {\\n                    let temp = new Date(shiftStart);\\n                    while(temp < shiftEnd) {\\n                        const h = temp.getHours() + \'h\';\\n                        if(chartDataMap[h] !== undefined) chartDataMap[h]++;\\n                        temp.setHours(temp.getHours() + 1);\\n                    }\\n                } else {\\n                    const dayLabel = shiftStart.getDate().toString();\\n                    if(chartDataMap[dayLabel] !== undefined) {\\n                        chartDataMap[dayLabel] += duration;\\n                    }\\n                }\\n\\n                // CORRECCIN DE NOMBRES\\n                let cName = s.clientName;\\n                if (!cName || cName === \'Otros\') {\\n                    cName = clientMap[s.clientId] || \'Sin Asignar\';\\n                }\\n                clientHours[cName] = (clientHours[cName] || 0) + duration;\\n            }\\n        });\\n\\n        const formattedChartData = Object.entries(chartDataMap).map(([label, value]) => ({\\n            label, \\n            value: Math.round(value)\\n        }));\\n        \\n        if (timeRange !== \'day\') {\\n             formattedChartData.sort((a,b) => parseInt(a.label) - parseInt(b.label));\\n        }\\n\\n        const coverage = shiftsSnap.size > 0 ? ((shiftsSnap.size - vacancies) / shiftsSnap.size) * 100 : 100;\\n\\n        const clientChartData = Object.entries(clientHours)\\n            .map(([name, val]) => ({ name: name.substring(0, 15), value: Math.round(val) }))\\n            .sort((a,b) => b.value - a.value)\\n            .filter(item => item.value > 0)\\n            .slice(0, 5);\\n\\n        // Distribuci贸n por Objetivo\\n        let distMap: Record<string, number> = {};\\n        let totalActiveEmp = 0;\\n        employeesSnap.forEach(doc => {\\n            const e = doc.data();\\n            if ([\'active\', \'activo\'].includes(e.status)) {\\n                totalActiveEmp++;\\n                const objId = e.preferredObjectiveId;\\n                const objName = objId ? (objectiveMap[objId] || \'Sin Asignar\') : \'Sin Asignar\';\\n                distMap[objName] = (distMap[objName] || 0) + 1;\\n            }\\n        });\\n        if (distMap[\'Sin Asignar\'] === 0) delete distMap[\'Sin Asignar\'];\\n        const distChartData = Object.entries(distMap)\\n            .map(([name, value]) => ({ name: name.length > 15 ? name.substring(0,15)+\'...\' : name, value }))\\n            .sort((a,b) => b.value - a.value)\\n            .slice(0, 6);\\n\\n        // Ausencias\\n        let absenceMap: Record<string, number> = {};\\n        absencesSnap.forEach(doc => {\\n            const d = doc.data();\\n            const absDate = new Date(d.startDate);\\n            if (absDate <= end) {\\n                const reason = d.type || \'Sin Motivo\';\\n                absenceMap[reason] = (absenceMap[reason] || 0) + 1;\\n            }\\n        });\\n        const absenceChartData = Object.entries(absenceMap)\\n            .map(([name, value]) => ({ name, value }))\\n            .sort((a,b) => b.value - a.value)\\n            .slice(0, 5);\\n\\n        setStats({\\n            clientsCount: clientCount,\\n            objectivesCount: objCount,\\n            servicesCount: servicesSnap.size,\\n            totalEmployees: totalActiveEmp,\\n            activeEmployees: uniqueGuards.size, \\n            coverage,\\n            totalHours: totalH,\\n            overtimeHours: extraH,\\n            absentCount: absencesToday,\\n            lateCount: lates,\\n            incidentCount: incidents\\n        });\\n\\n        setTopClients(clientChartData);\\n        setMainChartData(formattedChartData);\\n        setAbsenceReasons(absenceChartData);\\n        setEmployeeDistribution(distChartData);\\n        setLoading(false);\\n\\n      } catch (error) {\\n        console.error(error);\\n        setLoading(false);\\n      }\\n    };\\n\\n  const getChartTitle = () => {\\n      if (timeRange === \'day\') return \'Actividad en Tiempo Real (Guardias Activos)\';\\n      return \'Volumen Operativo Diario (Horas Hombre)\';\\n  };\\n\\n  return (\\n    <DashboardLayout>\\n      <Head><title>Dashboard Pro | CronoApp</title></Head>\\n      \\n      <div className=\\"min-h-screen bg-slate-50/50 dark:bg-slate-900 p-6 animate-in fade-in pb-20\\">\\n        \\n        {/* HEADER & FILTROS */}\\n        <div className=\\"flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4\\">\\n            <div>\\n                <h1 className=\\"text-3xl font-black text-slate-900 dark:text-white tracking-tight flex items-center gap-3\\">\\n                    <LayoutDashboard size={32} className=\\"text-indigo-600\\"/> \\n                    PANEL DE CONTROL\\n                </h1>\\n                <p className=\\"text-slate-500 font-medium mt-1\\">\\n                    Resumen operativo del <span className=\\"text-indigo-600 font-bold\\">{today.toLocaleDateString(\'es-AR\', { weekday: \'long\', day: \'numeric\', month: \'long\' })}</span>\\n                </p>\\n            </div>\\n            \\n            <div className=\\"flex items-center gap-2 bg-white p-1 rounded-xl border border-slate-200 shadow-sm\\">\\n                 <button onClick={() => setTimeRange(\'day\')} className={\'px-4 py-2 rounded-lg text-xs font-bold transition-all \' + (timeRange === \'day\' ? \'bg-indigo-600 text-white shadow-md\' : \'text-slate-500 hover:bg-slate-50\')}>Hoy</button>\\n                 <button onClick={() => setTimeRange(\'week\')} className={\'px-4 py-2 rounded-lg text-xs font-bold transition-all \' + (timeRange === \'week\' ? \'bg-indigo-600 text-white shadow-md\' : \'text-slate-500 hover:bg-slate-50\')}>Semana</button>\\n                 <button onClick={() => setTimeRange(\'month\')} className={\'px-4 py-2 rounded-lg text-xs font-bold transition-all \' + (timeRange === \'month\' ? \'bg-indigo-600 text-white shadow-md\' : \'text-slate-500 hover:bg-slate-50\')}>Mes</button>\\n            </div>\\n        </div>\\n\\n        {/* 1. KPIs PRINCIPALES */}\\n        <div className=\\"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8\\">\\n            <KpiCard title=\\"Clientes Activos\\" value={stats.clientsCount} icon={Building2} color=\\"bg-blue-500\\" subtext={stats.objectivesCount + \' Objetivos Totales\'} />\\n            <KpiCard title=\\"Cumplimiento\\" value={stats.coverage.toFixed(1) + \'%\'} icon={Shield} color={stats.coverage > 95 ? \\"bg-emerald-500\\" : \\"bg-rose-500\\"} subtext=\\"Nivel de Servicio\\" />\\n            <KpiCard title=\\"Volumen Horas\\" value={Math.round(stats.totalHours)} icon={Clock} color=\\"bg-violet-500\\" subtext={Math.round(stats.overtimeHours) + \'hs Recargo\'} />\\n            <KpiCard title=\\"Novedades\\" value={stats.incidentCount + stats.absentCount} icon={AlertOctagon} color={stats.incidentCount > 0 ? \\"bg-amber-500\\" : \\"bg-slate-400\\"} subtext={timeRange === \'day\' ? \'Hoy\' : \'En el periodo\'} />\\n        </div>\\n\\n        {/* 2. GRFICOS OPERATIVOS */}\\n        <div className=\\"grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8\\">\\n            <div className=\\"lg:col-span-2 bg-white dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 shadow-sm p-6 flex flex-col h-[350px]\\">\\n                <div className=\\"flex justify-between items-center mb-6\\">\\n                    <h3 className=\\"font-black text-lg text-slate-800 dark:text-white flex items-center gap-2\\">\\n                        <Activity className=\\"text-indigo-500\\"/> {getChartTitle()}\\n                    </h3>\\n                </div>\\n                <div className=\\"flex-1 w-full min-h-0\\">\\n                    <ResponsiveContainer width=\\"100%\\" height=\\"100%\\">\\n                        <AreaChart data={mainChartData}>\\n                            <defs>\\n                                <linearGradient id=\\"colorMain\\" x1=\\"0\\" y1=\\"0\\" x2=\\"0\\" y2=\\"1\\">\\n                                    <stop offset=\\"5%\\" stopColor=\\"#6366f1\\" stopOpacity={0.3}/>\\n                                    <stop offset=\\"95%\\" stopColor=\\"#6366f1\\" stopOpacity={0}/>\\n                                </linearGradient>\\n                            </defs>\\n                            <CartesianGrid strokeDasharray=\\"3 3\\" vertical={false} stroke=\\"#e2e8f0\\"/>\\n                            <XAxis dataKey=\\"label\\" tick={{fontSize: 11}} axisLine={false} tickLine={false}/>\\n                            <Tooltip contentStyle={{borderRadius: \'12px\', border: \'none\', boxShadow: \'0 4px 6px -1px rgb(0 0 0 / 0.1)\'}}/>\\n                            <Area type=\\"monotone\\" dataKey=\\"value\\" stroke=\\"#6366f1\\" strokeWidth={3} fillOpacity={1} fill=\\"url(#colorMain)\\" />\\n                        </AreaChart>\\n                    </ResponsiveContainer>\\n                </div>\\n            </div>\\n\\n            <div className=\\"bg-white dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 shadow-sm p-6 flex flex-col h-[350px]\\">\\n                <h3 className=\\"font-black text-lg text-slate-800 dark:text-white mb-4 flex items-center gap-2\\">\\n                    <PieChartIcon className=\\"text-emerald-500\\"/> Top Demanda (Hs)\\n                </h3>\\n                <div className=\\"flex-1 w-full min-h-0\\">\\n                     <ResponsiveContainer width=\\"100%\\" height=\\"100%\\">\\n                        <BarChart data={topClients} layout=\\"vertical\\" margin={{top:0, left:0, right:30, bottom:0}}>\\n                            <XAxis type=\\"number\\" hide/>\\n                            <YAxis dataKey=\\"name\\" type=\\"category\\" width={100} tick={{fontSize: 10, fontWeight: 600}} axisLine={false} tickLine={false}/>\\n                            <Tooltip cursor={{fill: \'#f1f5f9\'}} contentStyle={{borderRadius: \'8px\'}}/>\\n                            <Bar dataKey=\\"value\\" fill=\\"#4f46e5\\" radius={[0, 4, 4, 0]} barSize={20} />\\n                        </BarChart>\\n                     </ResponsiveContainer>\\n                </div>\\n            </div>\\n        </div>\\n\\n        {/* 3. GRFICOS RRHH */}\\n        <div className=\\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8\\">\\n            <div className=\\"bg-white dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 shadow-sm h-[300px] flex flex-col\\">\\n                <h3 className=\\"font-black text-lg text-slate-800 mb-2 flex items-center gap-2\\">\\n                    <UserX className=\\"text-rose-500\\"/> Motivos de Ausencia\\n                </h3>\\n                <div className=\\"flex-1 w-full\\">\\n                    {absenceReasons.length > 0 ? (\\n                        <ResponsiveContainer width=\\"100%\\" height=\\"100%\\">\\n                            <BarChart data={absenceReasons} layout=\\"vertical\\" margin={{ left: 20 }}>\\n                                <CartesianGrid strokeDasharray=\\"3 3\\" horizontal={false} />\\n                                <XAxis type=\\"number\\" hide />\\n                                <YAxis dataKey=\\"name\\" type=\\"category\\" width={120} tick={{fontSize: 10}} />\\n                                <Tooltip cursor={{fill: \'transparent\'}} />\\n                                <Bar dataKey=\\"value\\" fill=\\"#6366f1\\" radius={[0, 4, 4, 0]} barSize={25} />\\n                            </BarChart>\\n                        </ResponsiveContainer>\\n                    ) : <div className=\\"h-full flex items-center justify-center text-slate-400 text-xs\\">Sin datos en este periodo</div>}\\n                </div>\\n            </div>\\n\\n            <div className=\\"bg-white dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 shadow-sm h-[300px] flex flex-col\\">\\n                <h3 className=\\"font-black text-lg text-slate-800 mb-2 flex items-center gap-2\\">\\n                    <Target className=\\"text-emerald-500\\"/> Distribuci贸n por Objetivo\\n                </h3>\\n                <div className=\\"flex-1 relative\\">\\n                    <ResponsiveContainer width=\\"100%\\" height=\\"100%\\">\\n                        <PieChart>\\n                            <Pie\\n                                data={employeeDistribution}\\n                                cx=\\"50%\\"\\n                                cy=\\"50%\\"\\n                                innerRadius={60}\\n                                outerRadius={80}\\n                                paddingAngle={5}\\n                                dataKey=\\"value\\"\\n                            >\\n                                {employeeDistribution.map((entry, index) => (\\n                                    <Cell key={\'cell-\' + index} fill={COLORS[index % COLORS.length]} />\\n                                ))}\\n                            </Pie>\\n                            <Tooltip />\\n                            <Legend layout=\\"vertical\\" verticalAlign=\\"middle\\" align=\\"right\\" />\\n                        </PieChart>\\n                    </ResponsiveContainer>\\n                    <div className=\\"absolute inset-0 flex flex-col items-center justify-center pointer-events-none mr-24\\">\\n                        <span className=\\"text-3xl font-black text-slate-800\\">{stats.activeEmployees}</span>\\n                        <span className=\\"text-[9px] uppercase text-slate-400 font-bold\\">Activos</span>\\n                    </div>\\n                </div>\\n            </div>\\n        </div>\\n\\n        {/* 4. ACCESOS RPIDOS */}\\n        <div className=\\"grid grid-cols-2 md:grid-cols-4 gap-4\\">\\n            <button onClick={() => window.location.href=\'/admin/planificacion\'} className=\\"p-4 bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group\\">\\n                <Calendar className=\\"text-indigo-500 mb-2 group-hover:scale-110 transition-transform\\"/>\\n                <p className=\\"font-black text-slate-700\\">Planificador</p>\\n                <p className=\\"text-[10px] text-slate-400\\">Gestionar turnos</p>\\n            </button>\\n            <button onClick={() => window.location.href=\'/admin/empleados\'} className=\\"p-4 bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group\\">\\n                <Users className=\\"text-emerald-500 mb-2 group-hover:scale-110 transition-transform\\"/>\\n                <p className=\\"font-black text-slate-700\\">Personal</p>\\n                <p className=\\"text-[10px] text-slate-400\\">Ver legajos</p>\\n            </button>\\n            <button onClick={() => window.location.href=\'/admin/crm\'} className=\\"p-4 bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all text-left group\\">\\n                <Building2 className=\\"text-blue-500 mb-2 group-hover:scale-110 transition-transform\\"/>\\n                <p className=\\"font-black text-slate-700\\">Comercial</p>\\n                <p className=\\"text-[10px] text-slate-400\\">Clientes y tarifas</p>\\n            </button>\\n            <button onClick={() => window.location.href=\'/admin/reportes\'} className=\\"p-4 bg-indigo-600 rounded-xl shadow-lg hover:bg-indigo-700 transition-all text-left group\\">\\n                <BarChart3 className=\\"text-white mb-2 group-hover:scale-110 transition-transform\\"/>\\n                <p className=\\"font-black text-white\\">Reportes</p>\\n                <p className=\\"text-[10px] text-indigo-200\\">Exportar data</p>\\n            </button>\\n        </div>\\n\\n      </div>\\n    </DashboardLayout>\\n  );\\n}\\n\\nexport default withAuthGuard(AdminDashboard, [\'admin\', \'SuperAdmin\', \'Director\', \'Auditor\']);\\n"},{"id":"flh6o9wgz","name":"index.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\empleados\\\\index.tsx","area":"FRONTEND","content":"\\nimport React, { useState, useEffect } from \'react\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { employeeService, Employee } from \'@/services/employeeService\';\\nimport { auditService } from \'@/services/auditService\'; // <--- IMPORTANTE\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, getDocs, query, where } from \'firebase/firestore\';\\nimport { useToast } from \'@/context/ToastContext\';\\nimport { \\n  Users, Search, Plus, Edit2, Trash2, Phone, Mail, \\n  FileBadge, UserCheck, UserX, AlertCircle, MapPin, Building2\\n} from \'lucide-react\';\\n\\nexport default function EmployeesPage() {\\n  const { addToast } = useToast();\\n  const [view, setView] = useState<\'list\' | \'form\'>(\'list\');\\n  const [employees, setEmployees] = useState<Employee[]>([]);\\n  const [filteredEmployees, setFilteredEmployees] = useState<Employee[]>([]);\\n  const [searchTerm, setSearchTerm] = useState(\'\');\\n  const [isEditing, setIsEditing] = useState(false);\\n  const [clients, setClients] = useState<any[]>([]);\\n  const [allObjectives, setAllObjectives] = useState<any[]>([]);\\n  const [filteredObjectives, setFilteredObjectives] = useState<any[]>([]);\\n\\n  const initialForm: any = {\\n    firstName: \'\', lastName: \'\', dni: \'\', fileNumber: \'\', \\n    phone: \'\', email: \'\', category: \'Vigilador\', status: \'active\',\\n    laborAgreement: \'SUVICO\',\\n    preferredClientId: \'\', preferredObjectiveId: \'\'\\n  };\\n\\n  const [form, setForm] = useState<any>(initialForm);\\n\\n  useEffect(() => { loadData(); loadClientsAndObjectives(); }, []);\\n\\n  useEffect(() => {\\n    const term = searchTerm.toLowerCase();\\n    setFilteredEmployees(employees.filter(e => \\n      e.lastName.toLowerCase().includes(term) || \\n      e.firstName.toLowerCase().includes(term) ||\\n      e.fileNumber.includes(term)\\n    ));\\n  }, [searchTerm, employees]);\\n\\n  useEffect(() => {\\n      if (form.preferredClientId) {\\n          const objs = allObjectives.filter(o => o.clientId === form.preferredClientId);\\n          setFilteredObjectives(objs);\\n      } else {\\n          setFilteredObjectives([]);\\n      }\\n  }, [form.preferredClientId, allObjectives]);\\n\\n  const loadData = async () => {\\n    const data = await employeeService.getAll();\\n    setEmployees(data);\\n  };\\n\\n  const loadClientsAndObjectives = async () => {\\n      try {\\n        const cSnap = await getDocs(collection(db, \'clients\'));\\n        const cList = cSnap.docs.map(d => ({ id: d.id, ...d.data() }));\\n        setClients(cList);\\n\\n        const sSnap = await getDocs(query(collection(db, \'servicios_sla\'), where(\'status\', \'==\', \'active\')));\\n        const oList = sSnap.docs.map(d => {\\n            const data = d.data();\\n            return { id: data.objectiveId, name: data.objectiveName, clientId: data.clientId };\\n        });\\n        const uniqueObjectives = Array.from(new Map(oList.map(item => [item.id, item])).values());\\n        setAllObjectives(uniqueObjectives);\\n      } catch (e) { console.error(\\"Error cargando clientes/objetivos\\", e); }\\n  };\\n\\n  const handleSave = async () => {\\n    if (!form.lastName || !form.firstName || !form.dni) return addToast(\'Datos incompletos\', \'error\');\\n    try {\\n      if (isEditing && form.id) {\\n        await employeeService.update(form.id, form);\\n        await auditService.log(\'EDICION_EMPLEADO\', \'RRHH\', { id: form.id, ...form }); // <--- AUDITORA\\n        addToast(\'Legajo actualizado\', \'success\');\\n      } else {\\n        const id = await employeeService.add({ ...form, createdAt: new Date().toISOString() });\\n        await auditService.log(\'ALTA_EMPLEADO\', \'RRHH\', { ...form, id }); // <--- AUDITORA\\n        addToast(\'Legajo creado\', \'success\');\\n      }\\n      loadData();\\n      setView(\'list\');\\n    } catch (e) { addToast(\'Error al guardar\', \'error\'); }\\n  };\\n\\n  const handleDelete = async (id: string) => {\\n    if(confirm(\'驴Eliminar legajo?\')) {\\n      const empToDelete = employees.find(e => e.id === id); // Capturar datos antes de borrar\\n      await auditService.log(\'BAJA_EMPLEADO\', \'RRHH\', { ...empToDelete }); // <--- AUDITORA\\n      \\n      await employeeService.delete(id);\\n      loadData();\\n      addToast(\'Legajo eliminado\', \'info\');\\n    }\\n  };\\n\\n  const openNew = () => { setForm(initialForm); setIsEditing(false); setView(\'form\'); };\\n  const openEdit = (emp: any) => { setForm(emp); setIsEditing(true); setView(\'form\'); };\\n\\n  return (\\n    <DashboardLayout>\\n      <div className=\\"max-w-7xl mx-auto space-y-6 animate-in fade-in\\">\\n        <header className=\\"flex justify-between items-end\\">\\n          <div>\\n            <h1 className=\\"text-4xl font-black text-slate-900 dark:text-white uppercase tracking-tighter\\">Personal</h1>\\n            <p className=\\"text-slate-500 dark:text-slate-400 mt-1 font-medium\\">Gesti贸n de Legajos y Dotaci贸n.</p>\\n          </div>\\n          {view === \'list\' && (\\n            <button onClick={openNew} className=\\"bg-indigo-600 text-white px-6 py-3 rounded-xl font-black text-xs uppercase shadow-xl hover:scale-105 transition-all flex gap-2\\"><Plus size={16}/> Nuevo Legajo</button>\\n          )}\\n        </header>\\n\\n        {view === \'list\' && (\\n          <>\\n            <div className=\\"bg-white dark:bg-slate-800 p-4 rounded-2xl border dark:border-slate-700 flex items-center gap-4 shadow-sm\\">\\n              <Search className=\\"text-slate-400\\"/>\\n              <input placeholder=\\"Buscar por Nombre, Apellido o Legajo...\\" className=\\"w-full bg-transparent outline-none font-bold text-slate-700 dark:text-white uppercase\\" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/>\\n              <div className=\\"text-xs font-black text-slate-300 uppercase px-4 border-l dark:border-slate-700\\">{filteredEmployees.length} Pax</div>\\n            </div>\\n\\n            <div className=\\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\\">\\n              {filteredEmployees.map(emp => (\\n                <div key={emp.id} className=\\"bg-white dark:bg-slate-800 p-6 rounded-[2rem] border dark:border-slate-700 shadow-sm hover:shadow-lg transition-all group relative overflow-hidden\\">\\n                   <div className={`absolute top-0 right-0 p-4 ${emp.status === \'active\' ? \'text-emerald-500\' : \'text-rose-500\'}`}>\\n                      {emp.status === \'active\' ? <UserCheck size={18}/> : <UserX size={18}/>}\\n                   </div>\\n                   <div className=\\"flex items-center gap-4 mb-4\\">\\n                      <div className=\\"w-12 h-12 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center font-black text-slate-500 dark:text-slate-300 text-xl\\">\\n                        {emp.firstName.charAt(0)}{emp.lastName.charAt(0)}\\n                      </div>\\n                      <div>\\n                        <h3 className=\\"font-black text-slate-800 dark:text-white uppercase leading-tight\\">{emp.lastName}</h3>\\n                        <p className=\\"font-bold text-slate-500 text-sm uppercase\\">{emp.firstName}</p>\\n                        <span className=\\"text-[10px] bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 px-2 py-0.5 rounded font-black uppercase mt-1 inline-block\\">{emp.category}</span>\\n                      </div>\\n                   </div>\\n                   <div className=\\"space-y-2 border-t dark:border-slate-700 pt-4\\">\\n                      <div className=\\"flex items-center gap-2 text-xs font-bold text-slate-500 dark:text-slate-400\\"><FileBadge size={14}/> Legajo: {emp.fileNumber || \'S/N\'}</div>\\n                      <div className=\\"flex items-center gap-2 text-xs font-bold text-slate-500 dark:text-slate-400\\"><MapPin size={14}/> Objetivo: {(allObjectives.find(o => o.id === emp.preferredObjectiveId)?.name) || \'Sin asignar\'}</div>\\n                   </div>\\n                   <div className=\\"absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2\\">\\n                      <button onClick={() => openEdit(emp)} className=\\"p-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-indigo-600 hover:scale-110\\"><Edit2 size={14}/></button>\\n                      <button onClick={() => handleDelete(emp.id!)} className=\\"p-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-rose-600 hover:scale-110\\"><Trash2 size={14}/></button>\\n                   </div>\\n                </div>\\n              ))}\\n            </div>\\n          </>\\n        )}\\n\\n        {view === \'form\' && (\\n           <div className=\\"bg-white dark:bg-slate-800 p-8 rounded-[3rem] border dark:border-slate-700 animate-in slide-in-from-right-4\\">\\n              <div className=\\"flex justify-between items-center mb-8\\">\\n                  <h2 className=\\"text-2xl font-black text-slate-900 dark:text-white uppercase\\">{isEditing ? \'Editar Legajo\' : \'Alta de Personal\'}</h2>\\n                  <button onClick={() => setView(\'list\')} className=\\"text-slate-400 font-bold uppercase text-xs\\">Cancelar</button>\\n              </div>\\n              <div className=\\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6\\">\\n                 <div><label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Nombre</label><input className=\\"w-full p-4 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-2xl font-bold\\" value={form.firstName} onChange={e => setForm({...form, firstName: e.target.value})}/></div>\\n                 <div><label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Apellido</label><input className=\\"w-full p-4 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-2xl font-bold\\" value={form.lastName} onChange={e => setForm({...form, lastName: e.target.value})}/></div>\\n              </div>\\n              <div className=\\"grid grid-cols-1 md:grid-cols-3 gap-6 mb-6\\">\\n                 <div><label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">DNI</label><input className=\\"w-full p-4 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-2xl font-bold\\" value={form.dni} onChange={e => setForm({...form, dni: e.target.value})}/></div>\\n                 <div><label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Legajo</label><input className=\\"w-full p-4 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-2xl font-bold\\" value={form.fileNumber} onChange={e => setForm({...form, fileNumber: e.target.value})}/></div>\\n                 <div>\\n                    <label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Categor铆a</label>\\n                    <select className=\\"w-full p-4 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-2xl font-bold\\" value={form.category} onChange={e => setForm({...form, category: e.target.value as any})}>\\n                        <option value=\\"Vigilador\\">Vigilador</option>\\n                        <option value=\\"Supervisor\\">Supervisor</option>\\n                        <option value=\\"Monitoreo\\">Monitoreo</option>\\n                        <option value=\\"Custodia\\">Custodia</option>\\n                    </select>\\n                 </div>\\n              </div>\\n\\n              {/* DOTACIN FIJA */}\\n              <div className=\\"bg-slate-50 dark:bg-slate-900/50 p-6 rounded-3xl border dark:border-slate-700 mb-6\\">\\n                  <h3 className=\\"text-sm font-black uppercase text-indigo-500 mb-4 flex items-center gap-2\\"><MapPin size={16}/> Dotaci贸n Fija (Objetivo Preferido)</h3>\\n                  <div className=\\"grid grid-cols-1 md:grid-cols-2 gap-6\\">\\n                      <div>\\n                        <label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Cliente</label>\\n                        <select className=\\"w-full p-4 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-2xl font-bold\\" value={form.preferredClientId || \'\'} onChange={e => setForm({...form, preferredClientId: e.target.value, preferredObjectiveId: \'\'})}>\\n                            <option value=\\"\\">- Sin Asignar -</option>\\n                            {clients.map(c => <option key={c.id} value={c.id}>{c.name || c.razonSocial}</option>)}\\n                        </select>\\n                      </div>\\n                      <div>\\n                        <label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Objetivo</label>\\n                        <select className=\\"w-full p-4 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-2xl font-bold\\" value={form.preferredObjectiveId || \'\'} onChange={e => setForm({...form, preferredObjectiveId: e.target.value})} disabled={!form.preferredClientId}>\\n                            <option value=\\"\\">- Sin Asignar -</option>\\n                            {filteredObjectives.map(o => <option key={o.id} value={o.id}>{o.name}</option>)}\\n                        </select>\\n                      </div>\\n                  </div>\\n              </div>\\n\\n              <div className=\\"flex justify-end pt-6 border-t dark:border-slate-700\\">\\n                 <button onClick={handleSave} className=\\"bg-slate-900 dark:bg-white dark:text-slate-900 text-white px-8 py-3 rounded-xl font-black uppercase text-xs shadow-xl hover:scale-105 transition-transform\\">Guardar Legajo</button>\\n              </div>\\n           </div>\\n        )}\\n      </div>\\n    </DashboardLayout>\\n  );\\n}\\n"},{"id":"vh8gh4b35","name":"index.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\gestion\\\\index.tsx","area":"FRONTEND","content":"import React from \'react\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { Construction } from \'lucide-react\';\\n\\nexport default function GestionPage() {\\n  return (\\n    <DashboardLayout>\\n      <div className=\\"flex flex-col items-center justify-center h-[60vh] text-text-muted\\">\\n        <Construction size={64} className=\\"mb-4 opacity-50\\" />\\n        <h2 className=\\"text-2xl font-black uppercase\\">Gesti贸n Operativa</h2>\\n        <p>M贸dulo en desarrollo.</p>\\n      </div>\\n    </DashboardLayout>\\n  );\\n}"},{"id":"ppmfm6490","name":"index.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\index.tsx","area":"FRONTEND","content":"import React, { useEffect, useState } from \'react\';\\nimport Head from \'next/head\';\\nimport { \\n  Shield, Users, Clock, AlertTriangle, \\n  CheckCircle, Briefcase, MapPin, \\n  Activity, ArrowRight, Calendar \\n, AlertOctagon } from \'lucide-react\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { withAuthGuard } from \'@/components/common/withAuthGuard\';\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, getDocs, query, where, Timestamp } from \'firebase/firestore\';\\n\\n// --- TIPOS ---\\ninterface IDashboardStats {\\n  coverage: number;\\n  vacancies: number;\\n  totalHours: number;\\n  activeGuards: number;\\n  totalShifts: number;\\n}\\n\\ninterface IVacancy {\\n  id: string;\\n  client: string;\\n  objective: string;\\n  startTime: Date;\\n  hours: number;\\n}\\n\\ninterface IClientLoad {\\n  name: string;\\n  hours: number;\\n  percentage: number;\\n}\\n\\n// --- COMPONENTES UI (Gr谩ficos CSS Puros) ---\\nconst ProgressBar = ({ value, color = \'bg-indigo-500\' }: { value: number, color?: string }) => (\\n  <div className=\\"w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2 mt-2\\">\\n    <div className={`h-2 rounded-full ${color}`} style={{ width: `${value}%` }}></div>\\n  </div>\\n);\\n\\nconst ActivityHeatmap = ({ hourlyData }: { hourlyData: number[] }) => {\\n  const max = Math.max(...hourlyData, 1);\\n  return (\\n    <div className=\\"flex items-end justify-between h-24 gap-1 mt-4\\">\\n      {hourlyData.map((val, i) => (\\n        <div key={i} className=\\"flex-1 flex flex-col items-center group relative\\">\\n           {/* Tooltip */}\\n           <div className=\\"absolute bottom-full mb-1 hidden group-hover:block bg-slate-800 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-10\\">\\n             {i}:00hs - {val} guardias\\n           </div>\\n           {/* Bar */}\\n           <div \\n             className=\\"w-full bg-indigo-200 dark:bg-indigo-900/50 hover:bg-indigo-500 transition-all rounded-t-sm\\" \\n             style={{ height: `${(val / max) * 100}%` }}\\n           ></div>\\n           {/* Label */}\\n           {i % 4 === 0 && <span className=\\"text-[9px] text-slate-400 mt-1\\">{i}h</span>}\\n        </div>\\n      ))}\\n    </div>\\n  );\\n};\\n\\nfunction AdminDashboard() {\\n  const [loading, setLoading] = useState(true);\\n  const [stats, setStats] = useState<IDashboardStats>({ coverage: 0, vacancies: 0, totalHours: 0, activeGuards: 0, totalShifts: 0 });\\n  const [vacanciesList, setVacanciesList] = useState<IVacancy[]>([]);\\n  const [topClients, setTopClients] = useState<IClientLoad[]>([]);\\n  const [activityCurve, setActivityCurve] = useState<number[]>(new Array(24).fill(0));\\n  \\n  const today = new Date();\\n\\n  useEffect(() => {\\n    loadDashboardData();\\n  }, []);\\n\\n  const loadDashboardData = async () => {\\n    setLoading(true);\\n    try {\\n        // 1. Rango de Fechas: HOY (00:00 a 23:59)\\n        const start = new Date(); start.setHours(0,0,0,0);\\n        const end = new Date(); end.setHours(23,59,59,999);\\n        \\n        // 2. Cargar Turnos de HOY\\n        const shiftsQ = query(\\n            collection(db, \'turnos\'), \\n            where(\'startTime\', \'>=\', Timestamp.fromDate(start)), \\n            where(\'startTime\', \'<=\', Timestamp.fromDate(end))\\n        );\\n        const shiftsSnap = await getDocs(shiftsQ);\\n        \\n        // 3. Procesar Datos\\n        let totalH = 0;\\n        let activeEmp = new Set<string>();\\n        let vacancyCount = 0;\\n        let vacancies: IVacancy[] = [];\\n        let clientHours: Record<string, number> = {};\\n        let hourlyActivity = new Array(24).fill(0);\\n\\n        // Pre-carga de nombres de clientes (Optimizaci贸n: Podr铆amos cargar collection(\'clients\') si son muchos)\\n        // Por ahora usamos el nombre denormalizado en el turno si existe, o \'Cliente\'\\n        \\n        shiftsSnap.forEach(doc => {\\n            const s = doc.data();\\n            if (s.status === \'Canceled\') return;\\n\\n            const sStart = s.startTime.toDate();\\n            const sEnd = s.endTime.toDate();\\n            const duration = (sEnd.getTime() - sStart.getTime()) / 3600000;\\n            \\n            // A. Totales\\n            totalH += duration;\\n            \\n            // B. Vacantes vs Activos\\n            const isVacante = s.employeeId === \'VACANTE\' || s.employeeName === \'VACANTE\' || !s.employeeId;\\n            \\n            if (isVacante) {\\n                vacancyCount++;\\n                vacancies.push({\\n                    id: doc.id,\\n                    client: s.clientName || \'Cliente\', // Asumiendo que guardamos el nombre, si no habr铆a que cruzar\\n                    objective: s.objectiveName || \'Objetivo\',\\n                    startTime: sStart,\\n                    hours: duration\\n                });\\n            } else {\\n                activeEmp.add(s.employeeId);\\n            }\\n\\n            // C. Por Cliente (Agrupaci贸n)\\n            const cName = s.objectiveName ? s.objectiveName.split(\'(\')[0] : \'General\'; // Simplificaci贸n visual\\n            // Idealmente usar s.clientId y cruzar con mapa de clientes, pero para el dashboard r谩pido usamos lo que hay\\n            const cleanClient = s.clientId || \'Sin Cliente\';\\n            clientHours[cleanClient] = (clientHours[cleanClient] || 0) + duration;\\n\\n            // D. Curva de Actividad (Heatmap)\\n            let temp = new Date(sStart);\\n            while(temp < sEnd) {\\n                const h = temp.getHours();\\n                hourlyActivity[h]++;\\n                temp.setHours(h + 1);\\n            }\\n        });\\n\\n        // 4. Calcular KPIs Finales\\n        const totalShifts = shiftsSnap.size;\\n        const coverage = totalShifts > 0 ? ((totalShifts - vacancyCount) / totalShifts) * 100 : 100;\\n\\n        // Top Clientes (Necesitamos nombres reales, haremos un fetch r谩pido de clientes si hay IDs)\\n        // Para simplificar V1, mostramos los IDs o lo que tengamos\\n        const sortedClients = Object.entries(clientHours)\\n            .sort(([,a], [,b]) => b - a)\\n            .slice(0, 5)\\n            .map(([name, hours]) => ({\\n                name: name.substring(0, 15), // Truncar\\n                hours,\\n                percentage: (hours / totalH) * 100\\n            }));\\n\\n        // Actualizar Estado\\n        setStats({\\n            coverage,\\n            vacancies: vacancyCount,\\n            totalHours: totalH,\\n            activeGuards: activeEmp.size,\\n            totalShifts\\n        });\\n        setVacanciesList(vacancies.sort((a,b) => a.startTime.getTime() - b.startTime.getTime()));\\n        setTopClients(sortedClients);\\n        setActivityCurve(hourlyActivity);\\n\\n    } catch (error) {\\n        console.error(\\"Error loading dashboard\\", error);\\n    } finally {\\n        setLoading(false);\\n    }\\n  };\\n\\n  return (\\n    <DashboardLayout>\\n      <Head><title>Dashboard | CronoApp</title></Head>\\n      \\n      <div className=\\"p-6 max-w-7xl mx-auto space-y-6 animate-in fade-in\\">\\n        \\n        {/* HEADER FECHA */}\\n        <div className=\\"flex justify-between items-end mb-4\\">\\n            <div>\\n                <h1 className=\\"text-2xl font-black text-slate-900 dark:text-white uppercase\\">Operaciones Hoy</h1>\\n                <p className=\\"text-slate-500 font-medium flex items-center gap-2\\">\\n                    <Calendar size={16}/> {today.toLocaleDateString(\'es-AR\', { weekday: \'long\', day: \'numeric\', month: \'long\', year: \'numeric\' })}\\n                </p>\\n            </div>\\n            <div className=\\"flex gap-2\\">\\n               {/* Aqu铆 podr铆as poner selector de fecha futuro */}\\n            </div>\\n        </div>\\n\\n        {/* 1. KPIs SUPERIORES */}\\n        <div className=\\"grid grid-cols-1 md:grid-cols-4 gap-4\\">\\n            {/* COBERTURA */}\\n            <div className=\\"p-5 bg-white dark:bg-slate-800 rounded-3xl border dark:border-slate-700 shadow-sm relative overflow-hidden\\">\\n                <div className=\\"absolute right-0 top-0 p-4 opacity-5\\"><Shield size={64}/></div>\\n                <p className=\\"text-xs font-black text-slate-400 uppercase tracking-widest mb-1\\">Cobertura</p>\\n                <h3 className={`text-3xl font-black ${stats.coverage < 100 ? \'text-amber-500\' : \'text-emerald-500\'}`}>\\n                    {stats.coverage.toFixed(1)}%\\n                </h3>\\n                <ProgressBar value={stats.coverage} color={stats.coverage < 100 ? \'bg-amber-500\' : \'bg-emerald-500\'} />\\n                <p className=\\"text-[10px] text-slate-400 mt-2 text-right\\">{stats.totalShifts} turnos tot.</p>\\n            </div>\\n\\n            {/* VACANTES */}\\n            <div className={`p-5 rounded-3xl border shadow-sm relative overflow-hidden ${stats.vacancies > 0 ? \'bg-rose-50 border-rose-100 dark:bg-rose-900/20 dark:border-rose-800\' : \'bg-white border-slate-100 dark:bg-slate-800 dark:border-slate-700\'}`}>\\n                <div className=\\"absolute right-0 top-0 p-4 opacity-5\\"><AlertTriangle size={64}/></div>\\n                <p className={`text-xs font-black uppercase tracking-widest mb-1 ${stats.vacancies > 0 ? \'text-rose-600 dark:text-rose-400\' : \'text-slate-400\'}`}>Vacantes Criticas</p>\\n                <h3 className={`text-3xl font-black ${stats.vacancies > 0 ? \'text-rose-600 dark:text-rose-400\' : \'text-slate-700 dark:text-white\'}`}>\\n                    {stats.vacancies}\\n                </h3>\\n                <p className=\\"text-[10px] mt-2 opacity-60 font-bold\\">Puestos sin cubrir hoy</p>\\n            </div>\\n\\n            {/* VOLUMEN */}\\n            <div className=\\"p-5 bg-white dark:bg-slate-800 rounded-3xl border dark:border-slate-700 shadow-sm relative overflow-hidden\\">\\n                <div className=\\"absolute right-0 top-0 p-4 opacity-5\\"><Clock size={64}/></div>\\n                <p className=\\"text-xs font-black text-slate-400 uppercase tracking-widest mb-1\\">Volumen Hoy</p>\\n                <h3 className=\\"text-3xl font-black text-indigo-600 dark:text-indigo-400\\">\\n                    {stats.totalHours.toFixed(0)} <span className=\\"text-sm text-slate-400\\">hs</span>\\n                </h3>\\n                <div className=\\"mt-2 flex items-center gap-1 text-[10px] text-slate-400\\">\\n                    <Activity size={12}/> Actividad planificada\\n                </div>\\n            </div>\\n\\n            {/* DOTACIN */}\\n            <div className=\\"p-5 bg-white dark:bg-slate-800 rounded-3xl border dark:border-slate-700 shadow-sm relative overflow-hidden\\">\\n                <div className=\\"absolute right-0 top-0 p-4 opacity-5\\"><Users size={64}/></div>\\n                <p className=\\"text-xs font-black text-slate-400 uppercase tracking-widest mb-1\\">Dotaci贸n Activa</p>\\n                <h3 className=\\"text-3xl font-black text-slate-700 dark:text-white\\">\\n                    {stats.activeGuards}\\n                </h3>\\n                <p className=\\"text-[10px] text-slate-400 mt-2\\">Guardias en servicio</p>\\n            </div>\\n        </div>\\n\\n        {/* 2. SECCIN PRINCIPAL: VACANTES Y DISTRIBUCIN */}\\n        <div className=\\"grid grid-cols-1 lg:grid-cols-3 gap-6\\">\\n            \\n            {/* A. ALERTAS DE VACANTES (2/3 de ancho) */}\\n            <div className=\\"lg:col-span-2 bg-white dark:bg-slate-800 rounded-3xl border dark:border-slate-700 shadow-sm p-6 flex flex-col\\">\\n                <h3 className=\\"text-lg font-black text-slate-800 dark:text-white flex items-center gap-2 mb-4\\">\\n                    <AlertOctagon className=\\"text-rose-500\\"/> Pr贸ximas Vacantes <span className=\\"text-xs bg-rose-100 text-rose-700 px-2 py-1 rounded-full\\">{vacanciesList.length}</span>\\n                </h3>\\n                \\n                <div className=\\"flex-1 overflow-auto custom-scrollbar max-h-[300px]\\">\\n                    {vacanciesList.length === 0 ? (\\n                        <div className=\\"h-full flex flex-col items-center justify-center text-slate-400 space-y-2 opacity-50\\">\\n                            <CheckCircle size={48} className=\\"text-emerald-500\\"/>\\n                            <p>隆Todo cubierto! No hay vacantes pendientes para hoy.</p>\\n                        </div>\\n                    ) : (\\n                        <table className=\\"w-full text-left text-sm\\">\\n                            <thead className=\\"bg-slate-50 dark:bg-slate-900 text-[10px] uppercase text-slate-400 font-black sticky top-0\\">\\n                                <tr>\\n                                    <th className=\\"p-3\\">Horario</th>\\n                                    <th className=\\"p-3\\">Objetivo / Sede</th>\\n                                    <th className=\\"p-3 text-right\\">Duraci贸n</th>\\n                                    <th className=\\"p-3 text-center\\">Acci贸n</th>\\n                                </tr>\\n                            </thead>\\n                            <tbody className=\\"divide-y dark:divide-slate-700\\">\\n                                {vacanciesList.map(v => (\\n                                    <tr key={v.id} className=\\"group hover:bg-rose-50 dark:hover:bg-rose-900/10 transition-colors\\">\\n                                        <td className=\\"p-3 font-mono font-bold text-rose-600\\">\\n                                            {v.startTime.toLocaleTimeString(\'es-AR\', {hour:\'2-digit\', minute:\'2-digit\'})}\\n                                        </td>\\n                                        <td className=\\"p-3\\">\\n                                            <div className=\\"font-bold text-slate-700 dark:text-white\\">{v.objective}</div>\\n                                            <div className=\\"text-[10px] text-slate-400 uppercase\\">{v.client}</div>\\n                                        </td>\\n                                        <td className=\\"p-3 text-right text-slate-500\\">{v.hours}h</td>\\n                                        <td className=\\"p-3 text-center\\">\\n                                            <button className=\\"bg-slate-900 text-white px-3 py-1 rounded-lg text-xs font-bold hover:scale-105 transition-transform shadow-lg\\">\\n                                                Asignar\\n                                            </button>\\n                                        </td>\\n                                    </tr>\\n                                ))}\\n                            </tbody>\\n                        </table>\\n                    )}\\n                </div>\\n            </div>\\n\\n            {/* B. DISTRIBUCIN POR CLIENTE (1/3 ancho) */}\\n            <div className=\\"bg-white dark:bg-slate-800 rounded-3xl border dark:border-slate-700 shadow-sm p-6\\">\\n                <h3 className=\\"text-lg font-black text-slate-800 dark:text-white mb-4\\">Top Demanda Hoy</h3>\\n                <div className=\\"space-y-4\\">\\n                    {topClients.length > 0 ? topClients.map((c, i) => (\\n                        <div key={i}>\\n                            <div className=\\"flex justify-between text-xs font-bold mb-1\\">\\n                                <span className=\\"text-slate-600 dark:text-slate-300 truncate w-32\\">{c.name}</span>\\n                                <span className=\\"text-indigo-600\\">{Math.round(c.hours)} hs</span>\\n                            </div>\\n                            <ProgressBar value={c.percentage} color=\\"bg-indigo-500\\" />\\n                        </div>\\n                    )) : <p className=\\"text-slate-400 text-sm\\">Sin datos para hoy</p>}\\n                </div>\\n                <div className=\\"mt-6 pt-4 border-t dark:border-slate-700\\">\\n                    <button className=\\"w-full py-2 flex items-center justify-center gap-2 text-xs font-black text-slate-500 hover:text-indigo-600 transition-colors\\">\\n                        VER REPORTE COMPLETO <ArrowRight size={12}/>\\n                    </button>\\n                </div>\\n            </div>\\n        </div>\\n\\n        {/* 3. CURVA DE ACTIVIDAD (Heatmap) */}\\n        <div className=\\"bg-white dark:bg-slate-800 rounded-3xl border dark:border-slate-700 shadow-sm p-6\\">\\n            <h3 className=\\"text-lg font-black text-slate-800 dark:text-white mb-2\\">Curva de Actividad (24h)</h3>\\n            <p className=\\"text-xs text-slate-400 mb-6\\">Cantidad de personal activo por hora del d铆a.</p>\\n            <ActivityHeatmap hourlyData={activityCurve} />\\n        </div>\\n\\n      </div>\\n    </DashboardLayout>\\n  );\\n}\\n\\nexport default withAuthGuard(AdminDashboard, [\'admin\', \'SuperAdmin\', \'Director\', \'Auditor\']);\\n"},{"id":"ry69w2lls","name":"debug.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\operaciones\\\\debug.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\r\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\r\\nimport { useOperacionesMonitor } from \'@/hooks/useOperacionesMonitor\';\\r\\nimport { getAuth } from \'firebase/auth\';\\r\\nimport { Bug, CheckCircle, XCircle, RefreshCw, Download } from \'lucide-react\';\\r\\n\\r\\n// --- FUNCIONES AUXILIARES ---\\r\\n\\r\\nconst safeDate = (dateInput: any): Date | null => {\\r\\n    if (!dateInput) return null;\\r\\n    try {\\r\\n        if (dateInput.seconds) return new Date(dateInput.seconds * 1000);\\r\\n        if (dateInput instanceof Date) return dateInput;\\r\\n        const d = new Date(dateInput);\\r\\n        return isNaN(d.getTime()) ? null : d;\\r\\n    } catch (e) { return null; }\\r\\n};\\r\\n\\r\\nconst formatTime = (dateInput: any) => {\\r\\n    const d = safeDate(dateInput);\\r\\n    if (!d) return \'--:--\';\\r\\n    return d.toLocaleTimeString(\'es-AR\', { hour: \'2-digit\', minute: \'2-digit\' });\\r\\n};\\r\\n\\r\\nconst formatDateTime = (dateInput: any) => {\\r\\n    const d = safeDate(dateInput);\\r\\n    if (!d) return \'FECHA INVALIDA\';\\r\\n    return d.toLocaleString(\'es-AR\');\\r\\n};\\r\\n\\r\\nexport default function DebugPage() {\\r\\n    const { processedData, recentLogs } = useOperacionesMonitor();\\r\\n    \\r\\n    const [user, setUser] = useState<any>(null);\\r\\n    const [filterAnalysis, setFilterAnalysis] = useState<any[]>([]);\\r\\n\\r\\n    useEffect(() => {\\r\\n        const auth = getAuth();\\r\\n        setUser(auth.currentUser);\\r\\n    }, []);\\r\\n\\r\\n    // --- ANLISIS DE FILTRADO ---\\r\\n    useEffect(() => {\\r\\n        if (!processedData) return;\\r\\n\\r\\n        const now = new Date();\\r\\n        const todayStart = new Date(); todayStart.setHours(0,0,0,0);\\r\\n        const todayEnd = new Date(); todayEnd.setHours(23,59,59,999);\\r\\n\\r\\n        const analysis = processedData.map((s: any) => {\\r\\n            const report: any = {\\r\\n                id: s.id,\\r\\n                employee: s.employeeName || \'Sin Nombre\',\\r\\n                objective: s.objectiveName || \'Sin Objetivo\',\\r\\n                rawType: s.shiftType,\\r\\n                rawStatus: s.status,\\r\\n                isPresent: s.isPresent,\\r\\n                isRetention: s.isRetention,\\r\\n                isCompleted: s.isCompleted,\\r\\n                startTime: formatDateTime(s.shiftDateObj || s.startTime),\\r\\n                endTime: formatDateTime(s.endDateObj || s.endTime),\\r\\n                decision: \'ACEPTADO\',\\r\\n                reason: \'Cumple criterios base\'\\r\\n            };\\r\\n\\r\\n            // 1. BASURA\\r\\n            if (s.status === \'CANCELED\' || s.status === \'DRAFT\') {\\r\\n                report.decision = \'ELIMINADO\';\\r\\n                report.reason = `Estado inv谩lido: ${s.status}`;\\r\\n                return report;\\r\\n            }\\r\\n\\r\\n            // 2. FRANCOS\\r\\n            const typeUpper = (s.shiftType || \'\').toUpperCase();\\r\\n            const statusUpper = (s.status || \'\').toUpperCase();\\r\\n            const prohibited = [\'FRANCO\', \'OFF\', \'LICENCIA\', \'VACACIONES\', \'ART\', \'CARPETA\'];\\r\\n            \\r\\n            if (prohibited.some(term => typeUpper.includes(term))) {\\r\\n                report.decision = \'ELIMINADO\';\\r\\n                report.reason = `Es Franco (Tipo: ${s.shiftType})`;\\r\\n                return report;\\r\\n            }\\r\\n            if (prohibited.some(term => statusUpper.includes(term))) {\\r\\n                report.decision = \'ELIMINADO\';\\r\\n                report.reason = `Es Franco (Estado: ${s.status})`;\\r\\n                return report;\\r\\n            }\\r\\n\\r\\n            // 3. FECHAS\\r\\n            let start = safeDate(s.shiftDateObj) || safeDate(s.startTime);\\r\\n\\r\\n            if (!start) {\\r\\n                report.decision = \'ELIMINADO\';\\r\\n                report.reason = \'Fecha de inicio inv谩lida/nula\';\\r\\n                return report;\\r\\n            }\\r\\n\\r\\n            const isToday = (start >= todayStart && start <= todayEnd);\\r\\n            const isActive = s.isPresent && !s.isCompleted; \\r\\n            const isRetained = s.isRetention;\\r\\n\\r\\n            if (isActive) {\\r\\n                report.decision = \'ACEPTADO (ACTIVO)\';\\r\\n                report.reason = \'Guardia Presente. Se fuerza visualizaci贸n.\';\\r\\n            } else if (isRetained) {\\r\\n                report.decision = \'ACEPTADO (RETENIDO)\';\\r\\n                report.reason = \'Guardia Retenido. Se fuerza visualizaci贸n.\';\\r\\n            } else if (isToday) {\\r\\n                report.decision = \'ACEPTADO (HOY)\';\\r\\n                report.reason = \'Es un turno planificado para hoy.\';\\r\\n            } else {\\r\\n                const hoursDiff = (now.getTime() - start.getTime()) / (1000 * 60 * 60);\\r\\n                if ((s.isLate || s.isAbsent) && !s.isCompleted && hoursDiff < 30) {\\r\\n                    report.decision = \'ACEPTADO (PENDIENTE)\';\\r\\n                    report.reason = \'Incidencia de ayer sin resolver.\';\\r\\n                } else {\\r\\n                    report.decision = \'ELIMINADO\';\\r\\n                    report.reason = `Fecha pasada y NO est谩 presente.`;\\r\\n                }\\r\\n            }\\r\\n\\r\\n            return report;\\r\\n        });\\r\\n\\r\\n        setFilterAnalysis(analysis);\\r\\n\\r\\n    }, [processedData]);\\r\\n\\r\\n    // --- FUNCIN DE DESCARGA JSON ---\\r\\n    const handleDownloadDump = () => {\\r\\n        const dumpData = {\\r\\n            timestamp: new Date().toISOString(),\\r\\n            currentUser: {\\r\\n                uid: user?.uid || \'NO_AUTH\',\\r\\n                email: user?.email || \'NO_EMAIL\'\\r\\n            },\\r\\n            logsReceived: recentLogs, // Para ver si coinciden los UIDs\\r\\n            analysis: filterAnalysis, // Para ver por qu茅 se eliminan turnos\\r\\n            rawDataSample: processedData.slice(0, 10) // Para ver la estructura cruda\\r\\n        };\\r\\n\\r\\n        const dataStr = \\"data:text/json;charset=utf-8,\\" + encodeURIComponent(JSON.stringify(dumpData, null, 2));\\r\\n        const downloadAnchorNode = document.createElement(\'a\');\\r\\n        downloadAnchorNode.setAttribute(\\"href\\", dataStr);\\r\\n        downloadAnchorNode.setAttribute(\\"download\\", `debug_operaciones_${new Date().getTime()}.json`);\\r\\n        document.body.appendChild(downloadAnchorNode);\\r\\n        downloadAnchorNode.click();\\r\\n        downloadAnchorNode.remove();\\r\\n        \\r\\n        alert(\\"Archivo de diagn贸stico descargado. Por favor env铆alo al soporte.\\");\\r\\n    };\\r\\n\\r\\n    return (\\r\\n        <DashboardLayout>\\r\\n            <div className=\\"p-6 space-y-8 bg-slate-50 min-h-screen text-slate-800\\">\\r\\n                \\r\\n                <div className=\\"flex flex-col md:flex-row items-center justify-between gap-4\\">\\r\\n                    <h1 className=\\"text-2xl font-black flex items-center gap-2\\">\\r\\n                        <Bug className=\\"text-red-600\\"/> DIAGNSTICO DE DATOS\\r\\n                    </h1>\\r\\n                    <div className=\\"flex gap-2\\">\\r\\n                        <button \\r\\n                            onClick={handleDownloadDump} \\r\\n                            className=\\"px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 flex gap-2 font-bold shadow-lg\\"\\r\\n                        >\\r\\n                            <Download size={18}/> DESCARGAR REPORTE JSON\\r\\n                        </button>\\r\\n                        <button \\r\\n                            onClick={() => window.location.reload()} \\r\\n                            className=\\"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex gap-2 font-bold shadow-lg\\"\\r\\n                        >\\r\\n                            <RefreshCw size={18}/> Recargar\\r\\n                        </button>\\r\\n                    </div>\\r\\n                </div>\\r\\n\\r\\n                {/* 1. USUARIO */}\\r\\n                <div className=\\"bg-white p-6 rounded-xl border border-slate-300 shadow-sm\\">\\r\\n                    <h2 className=\\"text-lg font-bold mb-4 text-slate-700 underline\\">1. Diagn贸stico de Bit谩cora</h2>\\r\\n                    <div className=\\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4\\">\\r\\n                        <div className=\\"p-3 bg-slate-100 rounded border\\">\\r\\n                            <p className=\\"font-bold text-slate-500\\">TU USUARIO ACTUAL:</p>\\r\\n                            <p className=\\"font-mono text-blue-600 font-bold break-all\\">{user ? user.uid : \'DESCONECTADO\'}</p>\\r\\n                            <p className=\\"text-xs text-slate-400\\">{user?.email}</p>\\r\\n                        </div>\\r\\n                        <div className=\\"p-3 bg-slate-100 rounded border\\">\\r\\n                            <p className=\\"font-bold text-slate-500\\">TOTAL LOGS RECIBIDOS:</p>\\r\\n                            <p className=\\"font-mono text-purple-600 font-bold text-lg\\">{recentLogs?.length || 0}</p>\\r\\n                        </div>\\r\\n                    </div>\\r\\n                    <div className=\\"overflow-x-auto bg-slate-900 rounded-lg p-2 text-xs font-mono text-slate-300\\">\\r\\n                        <table className=\\"w-full text-left\\">\\r\\n                            <thead>\\r\\n                                <tr className=\\"text-yellow-500 border-b border-slate-700\\">\\r\\n                                    <th className=\\"p-2\\">HORA</th>\\r\\n                                    <th className=\\"p-2\\">ACCIN</th>\\r\\n                                    <th className=\\"p-2\\">ACTOR UID</th>\\r\\n                                    <th className=\\"p-2\\">COINCIDE?</th>\\r\\n                                </tr>\\r\\n                            </thead>\\r\\n                            <tbody>\\r\\n                                {recentLogs && recentLogs.slice(0, 10).map((l:any, i) => {\\r\\n                                    const isMatch = l.actorUid === user?.uid;\\r\\n                                    return (\\r\\n                                        <tr key={i} className=\\"border-b border-slate-800\\">\\r\\n                                            <td className=\\"p-2\\">{formatTime(l.timestamp)}</td>\\r\\n                                            <td className=\\"p-2 text-white\\">{l.action || l.type}</td>\\r\\n                                            <td className=\\"p-2\\">{l.actorUid}</td>\\r\\n                                            <td className=\\"p-2\\">\\r\\n                                                {isMatch \\r\\n                                                    ? <span className=\\"text-green-400 font-bold\\">S (Visible)</span> \\r\\n                                                    : <span className=\\"text-red-400\\">NO (Oculto)</span>\\r\\n                                                }\\r\\n                                            </td>\\r\\n                                        </tr>\\r\\n                                    );\\r\\n                                })}\\r\\n                            </tbody>\\r\\n                        </table>\\r\\n                    </div>\\r\\n                </div>\\r\\n\\r\\n                {/* 2. TABLA */}\\r\\n                <div className=\\"bg-white p-6 rounded-xl border border-slate-300 shadow-sm\\">\\r\\n                    <h2 className=\\"text-lg font-bold mb-4 text-slate-700 underline\\">2. An谩lisis de Turnos (Mapa y Lista)</h2>\\r\\n                    <p className=\\"text-sm text-slate-500 mb-4\\">Total turnos procesados: <b>{processedData?.length || 0}</b></p>\\r\\n                    \\r\\n                    <div className=\\"overflow-x-auto\\">\\r\\n                        <table className=\\"w-full text-xs text-left border-collapse border border-slate-200\\">\\r\\n                            <thead className=\\"bg-slate-800 text-white\\">\\r\\n                                <tr>\\r\\n                                    <th className=\\"p-2 border border-slate-600\\">EMPLEADO / OBJETIVO</th>\\r\\n                                    <th className=\\"p-2 border border-slate-600\\">TIPO / ESTADO</th>\\r\\n                                    <th className=\\"p-2 border border-slate-600\\">HORARIO</th>\\r\\n                                    <th className=\\"p-2 border border-slate-600\\">FLAGS</th>\\r\\n                                    <th className=\\"p-2 border border-slate-600\\">DECISIN</th>\\r\\n                                </tr>\\r\\n                            </thead>\\r\\n                            <tbody>\\r\\n                                {filterAnalysis.map((row: any) => (\\r\\n                                    <tr key={row.id} className={`border-b ${row.decision.includes(\'ACEPTADO\') ? \'bg-emerald-50\' : \'bg-red-50\'}`}>\\r\\n                                        <td className=\\"p-2 border font-bold text-slate-700\\">\\r\\n                                            {row.employee}<br/>\\r\\n                                            <span className=\\"text-[10px] text-slate-500 font-normal\\">{row.objective}</span>\\r\\n                                        </td>\\r\\n                                        <td className=\\"p-2 border\\">\\r\\n                                            {row.rawType}<br/>\\r\\n                                            <span className=\\"text-[10px] text-slate-500\\">{row.rawStatus}</span>\\r\\n                                        </td>\\r\\n                                        <td className=\\"p-2 border\\">\\r\\n                                            <span className=\\"text-green-700\\">In: {row.startTime}</span><br/>\\r\\n                                            <span className=\\"text-red-700\\">Out: {row.endTime}</span>\\r\\n                                        </td>\\r\\n                                        <td className=\\"p-2 border text-center\\">\\r\\n                                            {row.isPresent && <span className=\\"bg-green-200 text-green-800 px-1 rounded mx-1\\">PRESENTE</span>}\\r\\n                                            {row.isRetention && <span className=\\"bg-orange-200 text-orange-800 px-1 rounded mx-1\\">RETENIDO</span>}\\r\\n                                        </td>\\r\\n                                        <td className=\\"p-2 border\\">\\r\\n                                            {row.decision.includes(\'ACEPTADO\') \\r\\n                                                ? <span className=\\"text-green-700 font-bold flex items-center gap-1\\"><CheckCircle size={14}/> {row.decision}</span>\\r\\n                                                : <span className=\\"text-red-700 font-bold flex items-center gap-1\\"><XCircle size={14}/> {row.decision}</span>\\r\\n                                            }\\r\\n                                            <div className=\\"text-[9px] text-slate-500 italic\\">{row.reason}</div>\\r\\n                                        </td>\\r\\n                                    </tr>\\r\\n                                ))}\\r\\n                            </tbody>\\r\\n                        </table>\\r\\n                    </div>\\r\\n                </div>\\r\\n\\r\\n            </div>\\r\\n        </DashboardLayout>\\r\\n    );\\r\\n}"},{"id":"g4jxtb7s9","name":"index.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\operaciones\\\\index.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\nimport { createPortal } from \'react-dom\';\\nimport Head from \'next/head\';\\nimport dynamic from \'next/dynamic\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { \\n    Radio, Search, CheckCircle, AlertTriangle, X, Loader2, ListFilter, Siren, \\n    Calendar, Briefcase, Maximize2, Minimize2, User, Building2, ExternalLink,\\n    LogOut, ClipboardList, MessageCircle, Clock, UserX, ShieldAlert, Phone, FileCheck, FileWarning,\\n    Hourglass\\n} from \'lucide-react\';\\nimport { Toaster, toast } from \'sonner\';\\nimport { useOperacionesMonitor } from \'@/hooks/useOperacionesMonitor\';\\nimport { POPUP_STYLES } from \'@/components/operaciones/mapStyles\';\\nimport { db } from \'@/lib/firebase\'; \\nimport AbsenceResolutionModal from \'@/components/operaciones/AbsenceResolutionModal\';\\nimport RetentionModal from \'@/components/operaciones/RetentionModal\';\\n\\nconst OperacionesMap = dynamic(\\n    () => import(\'@/components/operaciones/OperacionesMap\'),\\n    { \\n        loading: () => <div className=\\"h-full w-full flex items-center justify-center bg-slate-100 text-slate-400\\"><Loader2 className=\\"animate-spin mr-2\\"/> Cargando Mapa...</div>,\\n        ssr: false \\n    }\\n);\\n\\nconst formatTime = (dateObj: any) => {\\n    if (!dateObj) return \'--:--\';\\n    const date = dateObj.seconds ? new Date(dateObj.seconds * 1000) : (dateObj instanceof Date ? dateObj : new Date(dateObj));\\n    return isNaN(date.getTime()) ? \'--:--\' : date.toLocaleTimeString(\'es-AR\', { hour: \'2-digit\', minute: \'2-digit\' });\\n};\\n\\n// --- MODAL DE RESUMEN DE MAPA ---\\nconst MapSummaryModal = ({ isOpen, onClose, type, data, onAction, onResolve }: any) => {\\n    if (!isOpen) return null;\\n\\n    let title = \\"\\";\\n    let icon = null;\\n    let headerColor = \\"\\";\\n\\n    if (type === \'RETENTION\') {\\n        title = \\"PERSONAL RETENIDO\\";\\n        icon = <Clock className=\\"text-orange-500 animate-pulse\\"/>;\\n        headerColor = \\"border-orange-500\\";\\n    } else if (type === \'ALERT\') {\\n        title = \\"ALERTAS OPERATIVAS\\";\\n        icon = <Siren className=\\"text-rose-500 animate-pulse\\"/>;\\n        headerColor = \\"border-rose-500\\";\\n    } else {\\n        title = \\"PERSONAL ACTIVO\\";\\n        icon = <CheckCircle className=\\"text-emerald-500\\"/>;\\n        headerColor = \\"border-emerald-500\\";\\n    }\\n\\n    return (\\n        <div className=\\"fixed inset-0 z-[8000] bg-black/60 flex items-center justify-center p-4 animate-in zoom-in-95\\">\\n            <div className=\\"bg-white dark:bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden border dark:border-slate-800 flex flex-col max-h-[80vh]\\">\\n                <div className={`bg-slate-50 dark:bg-slate-950 p-4 border-l-4 ${headerColor} flex justify-between items-center shrink-0`}>\\n                    <h3 className=\\"font-black text-slate-800 dark:text-white flex items-center gap-2 text-lg\\">{icon} {title} ({data.length})</h3>\\n                    <button onClick={onClose} className=\\"p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full transition-colors\\"><X size={20}/></button>\\n                </div>\\n                \\n                <div className=\\"p-4 overflow-y-auto custom-scrollbar flex-1 space-y-2 bg-slate-100 dark:bg-slate-900/50\\">\\n                    {data.length === 0 ? (\\n                        <div className=\\"text-center py-10 text-slate-400 italic\\">No hay registros en esta categor铆a.</div>\\n                    ) : (\\n                        data.map((shift: any) => (\\n                            <div key={shift.id} className=\\"bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex justify-between items-center group hover:border-indigo-300 transition-all\\">\\n                                <div>\\n                                    <p className=\\"font-bold text-slate-800 dark:text-white\\">{shift.employeeName}</p>\\n                                    <p className=\\"text-xs text-slate-500 flex items-center gap-1\\"><Building2 size={12}/> {shift.objectiveName}</p>\\n                                    <div className=\\"flex gap-2 mt-1 flex-wrap\\">\\n                                        <span className=\\"text-[10px] bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-slate-500 font-mono\\">{formatTime(shift.shiftDateObj)} - {formatTime(shift.endDateObj)}</span>\\n                                        {shift.isRetention && <span className=\\"text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-bold\\">RETENIDO</span>}\\n                                        {shift.isExtraShift && <span className=\\"text-[10px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded font-bold\\">DOBLE TURNO</span>}\\n                                        {shift.isLate && <span className=\\"text-[10px] bg-rose-100 text-rose-600 px-2 py-0.5 rounded font-bold\\">TARDE</span>}\\n                                        {shift.isAbsent && <span className=\\"text-[10px] bg-rose-100 text-rose-600 px-2 py-0.5 rounded font-bold\\">AUSENTE</span>}\\n                                    </div>\\n                                </div>\\n                                <div>\\n                                    {type === \'RETENTION\' && (\\n                                        <button onClick={() => onResolve(shift)} className=\\"px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white text-xs font-bold rounded-lg uppercase shadow-sm\\">Gestionar</button>\\n                                    )}\\n                                    {type === \'ALERT\' && (\\n                                        <button onClick={() => onResolve(shift)} className=\\"px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white text-xs font-bold rounded-lg uppercase shadow-sm flex items-center gap-2\\"><Siren size={14}/> Resolver</button>\\n                                    )}\\n                                    {type === \'ACTIVE\' && (\\n                                        <button onClick={() => onAction(shift)} className=\\"px-4 py-2 bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 text-xs font-bold rounded-lg uppercase shadow-sm\\">Ver</button>\\n                                    )}\\n                                </div>\\n                            </div>\\n                        ))\\n                    )}\\n                </div>\\n            </div>\\n        </div>\\n    );\\n};\\n\\n// --- MODAL DE SALIDA (CHECKOUT) ---\\nconst CheckOutModal = ({ isOpen, onClose, onConfirm, employeeName }: any) => {\\n    const [novedad, setNovedad] = useState(\'\');\\n    const [isSubmitting, setIsSubmitting] = useState(false);\\n\\n    if (!isOpen) return null;\\n\\n    const handleConfirm = async (withNovedad: boolean) => {\\n        setIsSubmitting(true);\\n        await onConfirm(withNovedad ? novedad : null);\\n        setIsSubmitting(false);\\n        setNovedad(\'\');\\n        onClose();\\n    };\\n\\n    return (\\n        <div className=\\"fixed inset-0 z-[9000] bg-black/60 flex items-center justify-center p-4 animate-in fade-in\\">\\n            <div className=\\"bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden border dark:border-slate-800\\">\\n                <div className=\\"bg-slate-50 dark:bg-slate-950 p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center\\">\\n                    <h3 className=\\"font-black text-slate-800 dark:text-white flex items-center gap-2\\"><LogOut className=\\"text-purple-600\\"/> REGISTRAR SALIDA</h3>\\n                    <button onClick={onClose} className=\\"text-slate-400 hover:text-slate-600\\"><X size={20}/></button>\\n                </div>\\n                <div className=\\"p-6 space-y-4\\">\\n                    <p className=\\"text-sm text-slate-600 dark:text-slate-300 text-center\\">\\n                        驴Confirmar salida de <span className=\\"font-bold text-slate-900 dark:text-white\\">{employeeName}</span>?\\n                    </p>\\n                    <button onClick={() => handleConfirm(false)} disabled={isSubmitting} className=\\"w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold uppercase text-xs flex items-center justify-center gap-2 transition-all shadow-sm\\"><FileCheck size={16}/> Salida Sin Novedad</button>\\n                    <div className=\\"relative border-t border-slate-100 dark:border-slate-800 pt-4 mt-2\\">\\n                        <p className=\\"text-[10px] font-bold text-slate-400 uppercase mb-2\\">O reportar novedad al salir:</p>\\n                        <textarea className=\\"w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm mb-2 outline-none focus:ring-2 focus:ring-purple-500\\" rows={2} placeholder=\\"Describa la novedad...\\" value={novedad} onChange={(e) => setNovedad(e.target.value)}/>\\n                        <button onClick={() => handleConfirm(true)} disabled={isSubmitting || !novedad.trim()} className=\\"w-full py-3 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-rose-50 hover:text-rose-600 hover:border-rose-200 border border-transparent rounded-xl font-bold uppercase text-xs flex items-center justify-center gap-2 transition-all\\"><AlertTriangle size={16}/> Salida Con Novedad</button>\\n                    </div>\\n                </div>\\n            </div>\\n        </div>\\n    );\\n};\\n\\n// --- VENTANA EXTERNA ---\\nconst ExternalMapWindow = ({ children, onClose }: any) => {\\n    const [containerEl, setContainerEl] = useState<HTMLElement | null>(null);\\n    React.useEffect(() => {\\n        if (typeof window === \'undefined\') return;\\n        const windowName = `MapaOperativo_${Date.now()}`;\\n        const newWindow = window.open(\'\', windowName, \'width=1200,height=800,left=200,top=200\');\\n        if (!newWindow) { alert(\\"锔 Ventana bloqueada. Habilita pop-ups.\\"); onClose(); return; }\\n        newWindow.document.title = \\"Monitor de Operaciones - Mapa\\";\\n        const styles = document.querySelectorAll(\'style, link[rel=\\"stylesheet\\"]\');\\n        styles.forEach(node => newWindow.document.head.appendChild(node.cloneNode(true)));\\n        const popupStyle = newWindow.document.createElement(\'style\');\\n        popupStyle.innerHTML = POPUP_STYLES;\\n        newWindow.document.head.appendChild(popupStyle);\\n        if (document.documentElement.classList.contains(\'dark\')) { newWindow.document.documentElement.classList.add(\'dark\'); }\\n        newWindow.document.body.className = \\"bg-slate-100 dark:bg-slate-900 m-0 p-0 overflow-hidden\\";\\n        const div = newWindow.document.createElement(\'div\');\\n        div.id = \'external-root\';\\n        div.style.height = \'100%\';\\n        div.style.width = \'100%\';\\n        newWindow.document.body.appendChild(div);\\n        setContainerEl(div);\\n        const checkClosed = setInterval(() => { if (newWindow.closed) { clearInterval(checkClosed); onClose(); } }, 500);\\n        return () => { clearInterval(checkClosed); if (newWindow && !newWindow.closed) { newWindow.close(); } };\\n    }, []);\\n    if (!containerEl) return null;\\n    return createPortal(children, containerEl);\\n};\\n\\n// --- TARJETA DE GUARDIA (LISTA LATERAL) ---\\nconst GuardCard = ({ shift, statusType, onAction, isProcessing, readOnly, isCompact, onOpenResolution, onOpenCheckout, simpleView }: any) => {\\n    const isReported = shift.status === \'UNCOVERED_REPORTED\';\\n    const isUnassigned = (!shift.employeeId || shift.employeeId === \'VACANTE\' || shift.employeeName === \'Sin Asignar\' || shift.employeeName === \'Vacante\') && !isReported;\\n    const isRetention = shift.isRetention === true; \\n    const isResolved = shift.resolutionStatus === \'RESOLVED\';\\n    const isExtraShift = shift.isExtraShift === true && shift.isPresent && !shift.isCompleted;\\n    const isConflict = !shift.isPresent && !shift.isAbsent && !isRetention && !isResolved && (statusType === \'LATE\' || statusType === \'IMMINENT\'); \\n    \\n    // --- MODO SIMPLE (PARA SOLAPA \'HOY\' - PLANIFICACIN PURA) ---\\n    if (simpleView) {\\n        // [CORRECCIN CRTICA]: Usamos \'shiftDateObj\' que es la hora original planificada.\\n        // Ignoramos \'startTime\' porque ese se sobreescribe cuando fichan.\\n        // Si \'originalStartTime\' existe, lo usamos por seguridad.\\n        const planTime = shift.originalStartTime \\n            ? (shift.originalStartTime.seconds ? new Date(shift.originalStartTime.seconds * 1000) : new Date(shift.originalStartTime))\\n            : (shift.shiftDateObj && shift.shiftDateObj.seconds ? new Date(shift.shiftDateObj.seconds * 1000) : new Date(shift.shiftDateObj));\\n        \\n        return (\\n            <div className=\\"p-3 rounded-xl border border-slate-100 bg-white dark:bg-slate-800 dark:border-slate-700 shadow-sm flex items-center justify-between group hover:border-slate-300 transition-all\\">\\n                <div className=\\"flex items-center gap-3 overflow-hidden\\">\\n                    <div className=\\"p-2 bg-slate-50 dark:bg-slate-700 rounded-lg text-slate-400\\">\\n                        <Calendar size={16}/>\\n                    </div>\\n                    <div className=\\"flex flex-col min-w-0\\">\\n                        <span className=\\"text-xs font-bold text-slate-700 dark:text-slate-200 truncate\\">{shift.employeeName}</span>\\n                        <div className=\\"flex items-center gap-1 text-[10px] text-slate-400 truncate\\">\\n                            <Building2 size={10} /> {shift.objectiveName}\\n                        </div>\\n                    </div>\\n                </div>\\n                <div className=\\"text-right pl-2\\">\\n                    <div className=\\"text-[11px] font-mono font-bold text-slate-500 bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded\\">\\n                        {formatTime(planTime)}\\n                    </div>\\n                    <span className=\\"text-[9px] text-slate-400 uppercase\\">Planificado</span>\\n                </div>\\n            </div>\\n        );\\n    }\\n\\n    const getStatusStyles = () => {\\n        if (isUnassigned) return { border: \'border-l-red-600\', bg: \'bg-red-50 dark:bg-red-900/30\', text: \'text-red-700 dark:text-red-200\', badge: \'bg-red-600 text-white animate-pulse\', label: \'PUESTO VACANTE\' };\\n        if (isReported) return { border: \'border-l-amber-500\', bg: \'bg-amber-50 dark:bg-amber-900/30\', text: \'text-amber-800 dark:text-amber-200\', badge: \'bg-amber-500 text-white\', label: \'EN PLANIFICACIN\' };\\n\\n        if (isRetention) return { border: \'border-l-orange-500\', bg: \'bg-orange-50 dark:bg-orange-900/20\', text: \'text-orange-800 dark:text-orange-200\', badge: \'bg-orange-600 text-white animate-pulse\', label: \'RETENCIN EN CURSO\' };\\n        if (isExtraShift) return { border: \'border-l-indigo-500\', bg: \'bg-indigo-50 dark:bg-indigo-900/20\', text: \'text-indigo-800 dark:text-indigo-200\', badge: \'bg-indigo-600 text-white\', label: \'DOBLE TURNO\' };\\n        if (shift.isAbsent || shift.status === \'ABSENT\') return { border: \'border-l-rose-500\', bg: \'bg-rose-50 dark:bg-rose-950/40\', text: \'text-rose-700 dark:text-rose-300\', badge: \'bg-rose-600 text-white\', label: \'AUSENTE\' };\\n        if (shift.isCompleted) return { border: \'border-l-gray-300 dark:border-l-slate-600\', bg: \'bg-gray-50/50 dark:bg-slate-800/30\', text: \'text-gray-400 dark:text-slate-500\', badge: \'bg-gray-100 dark:bg-slate-800 text-gray-400 dark:text-slate-500\', label: \'FINALIZADO\' };\\n        if (isResolved && !isExtraShift) return { border: \'border-l-emerald-500\', bg: \'bg-emerald-50/10 dark:bg-emerald-900/5\', text: \'text-emerald-700\', badge: \'bg-emerald-100 text-emerald-800\', label: \'RESUELTO\' };\\n\\n        if (shift.isEnding && shift.isPresent) return { border: \'border-l-purple-500\', bg: \'bg-purple-50/30 dark:bg-purple-900/20\', text: \'text-purple-700 dark:text-purple-300\', badge: \'bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300\', label: \'CIERRE PRXIMO\' };\\n        if (statusType === \'LATE\') return { border: \'border-l-rose-500\', bg: \'bg-rose-50/40 dark:bg-rose-900/20\', text: \'text-rose-700 dark:text-rose-300\', badge: \'bg-rose-100 dark:bg-rose-900/40 text-rose-700 dark:text-rose-300\', label: \'LLEGADA TARDE\' };\\n        if (shift.isEarlyEntry && !shift.isPresent) return { border: \'border-l-blue-500\', bg: \'bg-blue-50/30 dark:bg-blue-900/20\', text: \'text-blue-700 dark:text-blue-300\', badge: \'bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300\', label: \'ADELANTADO\' };\\n        if (statusType === \'IMMINENT\') return { border: \'border-l-orange-500\', bg: \'bg-orange-50/30 dark:bg-orange-900/20\', text: \'text-orange-700 dark:text-orange-300\', badge: \'bg-orange-100 dark:bg-orange-900/40 text-orange-700 dark:text-orange-300\', label: \'INMINENTE\' };\\n        if (statusType === \'ACTIVE\') return { border: \'border-l-emerald-500\', bg: \'bg-emerald-50/20 dark:bg-emerald-900/10\', text: \'text-emerald-700 dark:text-emerald-300\', badge: \'bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300\', label: \'EN SERVICIO\' };\\n        return { border: \'border-l-slate-300 dark:border-l-slate-600\', bg: \'bg-white dark:bg-slate-800\', text: \'text-slate-600 dark:text-slate-400\', badge: \'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400\', label: \'PENDIENTE\' };\\n    };\\n    const style = getStatusStyles();\\n    \\n    const handleWhatsApp = (e: any) => { \\n        e.stopPropagation(); \\n        if (shift.phone) window.open(`https://wa.me/${shift.phone.replace(/[^0-9]/g, \'\')}`, \'_blank\'); \\n        else toast.error(\\"No hay tel茅fono registrado\\");\\n    };\\n    const handleResolution = (e:any) => { e.stopPropagation(); onOpenResolution(shift); };\\n    const handleCheckoutClick = (e: any) => { e.stopPropagation(); onOpenCheckout(shift); };\\n\\n    const showActions = (!readOnly || isRetention || isConflict || shift.isAbsent || isExtraShift || isUnassigned) && !shift.isCompleted && (!isResolved || isExtraShift);\\n\\n    if (isCompact) {\\n        return (\\n            <div className={`pl-2 pr-3 py-2 rounded-md border border-slate-200 dark:border-slate-700 shadow-sm transition-all relative border-l-4 ${style.border} ${style.bg} flex items-center justify-between group`}>\\n                <div className=\\"flex items-center gap-3 overflow-hidden\\">\\n                    <div className=\\"flex flex-col min-w-[50px]\\"><span className=\\"text-[10px] font-mono font-bold text-slate-400\\">{formatTime(shift.shiftDateObj)}</span></div>\\n                    <div className=\\"flex flex-col truncate\\"><span className={`text-xs font-bold truncate ${shift.isCompleted ? \'text-slate-400 line-through\' : \'text-slate-700 dark:text-slate-200\'}`}>{isUnassigned ? \'SIN ASIGNAR\' : shift.employeeName}</span><div className=\\"flex items-center gap-1 text-[9px] text-slate-400 truncate\\"><Briefcase size={9} /> {shift.clientName} <span className=\\"text-slate-300\\">|</span> {style.label}</div></div>\\n                </div>\\n                {showActions && (\\n                    <div className=\\"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity\\">\\n                          {isUnassigned ? (\\n                              <button onClick={handleResolution} title=\\"Cubrir Vacante\\" className=\\"p-1.5 bg-red-600 text-white rounded animate-pulse\\"><AlertTriangle size={14}/></button>\\n                          ) : ((isConflict || isRetention || shift.isAbsent) && !isResolved && !isExtraShift) ? (<button onClick={handleResolution} title=\\"Resolver\\" className=\\"p-1.5 bg-rose-600 text-white rounded animate-pulse\\"><Siren size={14}/></button>) : (<>{!shift.isPresent && !shift.isAbsent ? (<button onClick={() => onAction(\'CHECKIN\', shift.id)} disabled={isProcessing} title=\\"Dar Presente\\" className=\\"p-1.5 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-600 hover:text-white transition-colors\\"><CheckCircle size={14} /></button>) : (<button onClick={handleCheckoutClick} disabled={isProcessing} title=\\"Finalizar\\" className=\\"p-1.5 bg-purple-50 text-purple-600 rounded hover:bg-purple-600 hover:text-white transition-colors\\"><LogOut size={14} /></button>)}<button onClick={() => onAction(\'NOVEDAD\', shift.id)} title=\\"Novedad\\" className=\\"p-1.5 bg-slate-50 text-slate-500 rounded hover:bg-rose-50 hover:text-rose-600 transition-colors\\"><AlertTriangle size={14} /></button></>)}\\n                    </div>\\n                )}\\n                {shift.isAbsent && <UserX size={16} className=\\"text-rose-500 mr-2\\"/>}{isRetention && <Clock size={16} className=\\"text-orange-500 mr-2 animate-pulse\\"/>}\\n            </div>\\n        );\\n    }\\n    return (\\n        <div className={`p-3 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm transition-all relative overflow-hidden group hover:shadow-md hover:border-indigo-100 dark:hover:border-slate-600 ${style.bg}`}>\\n            <div className={`absolute left-0 top-0 bottom-0 w-1 ${style.border}`}></div>\\n            {isRetention && (<div className=\\"absolute top-2 right-2 flex items-center gap-1 text-orange-600 font-mono text-xs font-black bg-white/80 px-2 py-1 rounded shadow-sm animate-pulse\\"><Clock size={12}/> EN PROCESO</div>)}\\n            {isExtraShift && (<div className=\\"absolute top-2 right-2 flex items-center gap-1 text-indigo-600 font-mono text-[9px] font-black bg-white/80 px-2 py-1 rounded shadow-sm border border-indigo-100\\">DOBLE TURNO</div>)}\\n            \\n            <div className=\\"pl-2 flex justify-between items-start mb-1\\">\\n                 <div className=\\"flex flex-col\\"><span className={`text-[9px] font-bold uppercase tracking-wider w-fit px-1.5 py-0.5 rounded mb-1 ${style.badge}`}>{style.label}</span><h4 className={`font-bold text-sm leading-tight truncate flex items-center gap-1 ${shift.isCompleted ? \'text-slate-400\' : \'text-slate-800 dark:text-slate-100\'}`}>{isUnassigned ? \'SIN ASIGNAR\' : shift.employeeName}</h4></div>\\n                 <div className=\\"text-right\\"><div className=\\"text-[11px] font-black font-mono text-slate-600 dark:text-slate-300 bg-white/50 dark:bg-black/20 px-1 rounded\\">{formatTime(shift.shiftDateObj)}</div><div className=\\"text-[9px] text-slate-400\\">a {formatTime(shift.endDateObj)}</div></div>\\n            </div>\\n            <div className=\\"pl-2 mb-2\\">\\n                <div className=\\"text-xs text-slate-500 dark:text-slate-400 font-medium truncate flex items-center gap-1\\"><Building2 size={10} className=\\"text-slate-400\\"/> {shift.clientName}<span className=\\"text-slate-300 dark:text-slate-600 mx-1\\"></span><span className=\\"text-slate-400\\">{shift.objectiveName}</span></div>\\n                {isRetention && <div className=\\"mt-1 text-[10px] text-orange-700 font-bold\\">锔 Guardia retenido en puesto.</div>}\\n                {isConflict && !isResolved && <div className=\\"mt-1 text-[10px] text-rose-600 font-bold\\"> Requiere atenci贸n inmediata.</div>}\\n                {isUnassigned && <div className=\\"mt-1 text-[10px] text-red-600 font-bold animate-pulse\\">锔 PUESTO CRTICO SIN CUBRIR</div>}\\n                {isReported && <div className=\\"mt-1 text-[10px] text-amber-700 font-medium flex items-center gap-1\\"><FileWarning size={10}/> Reportado a Planificaci贸n.</div>}\\n\\n                {shift.isAbsent && (<div className=\\"mt-2 text-[11px] text-rose-700 dark:text-rose-300 bg-white/60 dark:bg-black/20 p-2 rounded border border-rose-200 dark:border-rose-900 italic flex items-start gap-2\\"><UserX size={12} className=\\"mt-0.5 shrink-0\\"/>{shift.comments || \\"Ausencia sin aviso registrado.\\"}</div>)}\\n                {(shift.isEarlyEntry || shift.isCoverage) && (<div className=\\"mt-1.5 text-[10px] text-blue-700 dark:text-blue-300 bg-blue-100/50 dark:bg-blue-900/30 border border-blue-100 dark:border-blue-900/50 px-2 py-0.5 rounded-md inline-block font-medium\\">Info: {shift.coverageNote || shift.entryNote || \\"Cobertura operativa\\"}</div>)}\\n                {isRetention && (<div className=\\"mt-1.5 text-[10px] text-orange-700 dark:text-orange-200 bg-orange-100/50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800 px-2 py-1 rounded-md font-bold flex items-center gap-1\\"><Siren size={10} className=\\"animate-bounce\\"/> Relevo pendiente. No abandonar puesto.</div>)}\\n                {isResolved && !isExtraShift && <div className=\\"mt-2 text-[10px] text-emerald-700 bg-emerald-100/50 px-2 py-1 rounded border border-emerald-200 font-bold flex items-center gap-1\\"><CheckCircle size={10}/> Resuelto: {shift.resolutionMethod || \'Gestionado\'}</div>}\\n            </div>\\n            \\n            {showActions && (\\n                <div className=\\"pl-2 mt-3 pt-2 border-t border-slate-200/50 dark:border-slate-700/50 flex gap-2\\">\\n                    {isUnassigned ? (\\n                        <button onClick={handleResolution} className=\\"flex-1 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-lg text-[10px] font-bold uppercase shadow-md flex items-center justify-center gap-2 animate-pulse\\">\\n                            <AlertTriangle size={14}/> CUBRIR VACANTE\\n                        </button>\\n                    ) : ((isConflict || isRetention || shift.isAbsent) && !isExtraShift ? (<button onClick={handleResolution} className=\\"flex-1 py-1.5 bg-rose-600 hover:bg-rose-700 text-white rounded-lg text-[10px] font-bold uppercase shadow-md flex items-center justify-center gap-2 animate-pulse\\"><Siren size={14}/> {isRetention ? \'GESTIONAR RETENCIN\' : \'ASISTENTE DE CRISIS\'}</button>) : (<>{!shift.isPresent && !shift.isAbsent ? (<button onClick={() => onAction(\'CHECKIN\', shift.id)} disabled={isProcessing} className=\\"flex-1 py-1.5 bg-indigo-600 text-white rounded-lg text-[10px] font-bold uppercase flex items-center justify-center gap-2 hover:bg-indigo-700 transition-colors\\"><CheckCircle size={12}/> LLEGADA</button>) : (<button onClick={handleCheckoutClick} disabled={isProcessing} className=\\"flex-1 py-1.5 bg-purple-600 text-white rounded-lg text-[10px] font-bold uppercase flex items-center justify-center gap-2 hover:bg-purple-700 transition-colors\\"><LogOut size={12}/> SALIDA</button>)}<button onClick={() => onAction(\'NOVEDAD\', shift.id)} className=\\"px-3 py-1.5 bg-white border border-slate-200 text-slate-500 rounded-lg hover:bg-rose-50 hover:text-rose-600 transition-colors\\"><AlertTriangle size={14}/></button></>))}\\n                    {!isUnassigned && (\\n                        <div className=\\"flex gap-1\\">\\n                            <button onClick={() => window.open(`tel:${shift.phone?.replace(/[^0-9]/g,\'\') || \'\'}`)} className=\\"p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-500 transition-colors\\" title=\\"Llamar\\"><Phone size={14}/></button>\\n                            <button onClick={handleWhatsApp} className=\\"p-2 bg-emerald-50 border border-emerald-100 text-emerald-600 rounded-lg hover:bg-emerald-600 hover:text-white transition-colors\\" title=\\"WhatsApp\\"><MessageCircle size={14}/></button>\\n                        </div>\\n                    )}\\n                </div>\\n            )}\\n        </div>\\n    );\\n};\\n\\nexport default function OperacionesPage() {\\n    const logic = useOperacionesMonitor();\\n    const [isExternalMap, setIsExternalMap] = useState(false);\\n    const [mapInstance, setMapInstance] = useState<any>(null);\\n    const [isProcessing, setIsProcessing] = useState(false); \\n    \\n    // ESTADOS DE MODALES\\n    const [wizardData, setWizardData] = useState<{isOpen: boolean, shift: any | null}>({isOpen: false, shift: null});\\n    const [checkoutData, setCheckoutData] = useState<{isOpen: boolean, shift: any | null}>({isOpen: false, shift: null});\\n    const [summaryModal, setSummaryModal] = useState<{isOpen: boolean, type: \'RETENTION\' | \'ALERT\' | \'ACTIVE\' | null}>({ isOpen: false, type: null });\\n    const [retentionModal, setRetentionModal] = useState<{isOpen: boolean, shift: any | null}>({isOpen: false, shift: null});\\n    const [minimizedResolutions, setMinimizedResolutions] = useState<any[]>([]);\\n\\n    // ESTADO TABS\\n    const [viewTab, setViewTab] = useState<\'PRIORIDAD\' | \'RETENIDOS\' | \'AUN_NO\' | \'ACTIVOS\' | \'AUSENTES\' | \'HOY\'>(\'PRIORIDAD\');\\n\\n    // --- FILTRADO DE HIERRO ---\\n    const getCleanData = () => {\\n        const now = new Date();\\n        const todayStart = new Date(); todayStart.setHours(0,0,0,0);\\n        const todayEnd = new Date(); todayEnd.setHours(23,59,59,999);\\n\\n        return logic.processedData.filter((s: any) => {\\n            if (s.status === \'CANCELED\' || s.status === \'DRAFT\') return false;\\n            \\n            const typeUpper = (s.shiftType || \'\').toUpperCase();\\n            const statusUpper = (s.status || \'\').toUpperCase();\\n            if ([\'FRANCO\', \'OFF\', \'LICENCIA\', \'VACACIONES\'].includes(typeUpper)) return false;\\n            if ([\'FRANCO\', \'OFF\', \'LICENCIA\', \'VACACIONES\'].includes(statusUpper)) return false;\\n\\n            let start = s.shiftDateObj;\\n            if (start && start.seconds) start = new Date(start.seconds * 1000);\\n            if (!(start instanceof Date) || isNaN(start.getTime())) start = new Date(s.startTime.seconds * 1000);\\n\\n            let end = s.endDateObj;\\n            if (end && end.seconds) end = new Date(end.seconds * 1000);\\n            if (!(end instanceof Date) || isNaN(end.getTime())) end = s.endTime ? new Date(s.endTime.seconds * 1000) : new Date(start.getTime() + 8*3600000);\\n\\n            const isToday = (start >= todayStart && start <= todayEnd);\\n            const hoursSinceStart = (now.getTime() - start.getTime()) / (1000 * 60 * 60);\\n            const isCriticalLingering = !s.isCompleted && (s.isPresent || s.isRetention) && hoursSinceStart < 24;\\n\\n            return isToday || isCriticalLingering;\\n        });\\n    };\\n\\n    const cleanData = getCleanData();\\n\\n    // --- FUNCIN getSummaryData ---\\n    const getSummaryData = () => {\\n        if (summaryModal.type === \'RETENTION\') {\\n            return cleanData.filter(s => s.isRetention);\\n        } else if (summaryModal.type === \'ALERT\') {\\n            return cleanData.filter(s => \\n                (s.isLate || s.isImminent || s.statusText === \'SIN CIERRE\' || (s.isAbsent && !s.isCompleted && !s.resolutionStatus)) \\n                && !s.isRetention\\n            );\\n        } else if (summaryModal.type === \'ACTIVE\') {\\n            return cleanData.filter(s => s.isPresent && !s.isCompleted && !s.isAbsent);\\n        }\\n        return [];\\n    };\\n\\n    // --- FILTRADO POR PESTAA (LGICA CORREGIDA) ---\\n    const getFilteredList = () => {\\n        const base = cleanData;\\n        switch (viewTab) {\\n            case \'RETENIDOS\':\\n                return base.filter(s => s.isRetention);\\n            case \'AUN_NO\':\\n                return base.filter(s => s.isLate && !s.isPresent && !s.isAbsent && !s.isCompleted);\\n            case \'ACTIVOS\':\\n                return base.filter(s => s.isPresent && !s.isCompleted && !s.isAbsent);\\n            case \'AUSENTES\':\\n                return base.filter(s => s.isAbsent);\\n            case \'HOY\':\\n                // [HOY] = PLANIFICACIN ORIGINAL\\n                // 1. Filtrar Sin Asignar\\n                // 2. Usar solo turnos que empiezan HOY (no zombies)\\n                // 3. Eliminar duplicados (Zutira x2)\\n                const todayStart = new Date(); todayStart.setHours(0,0,0,0);\\n                const todayEnd = new Date(); todayEnd.setHours(23,59,59,999);\\n\\n                const todayOnly = base.filter(s => {\\n                    // Usar hora planificada, no real\\n                    const start = s.shiftDateObj && s.shiftDateObj.seconds ? new Date(s.shiftDateObj.seconds * 1000) : new Date(s.shiftDateObj);\\n                    const isStrictlyToday = start >= todayStart && start <= todayEnd;\\n                    const isUnassigned = !s.employeeId || s.employeeId === \'VACANTE\' || s.employeeName === \'Sin Asignar\' || s.employeeName === \'Vacante\';\\n                    return isStrictlyToday && !isUnassigned;\\n                });\\n\\n                // DEDUPLICACIN DE ZUTIRA: Solo 1 registro por empleado por d铆a en la lista HOY\\n                const uniqueEmployees = new Map();\\n                todayOnly.forEach((item: any) => {\\n                    if (!uniqueEmployees.has(item.employeeId)) {\\n                        uniqueEmployees.set(item.employeeId, item);\\n                    }\\n                });\\n                \\n                return Array.from(uniqueEmployees.values()).sort((a: any, b: any) => {\\n                    const tA = a.shiftDateObj?.seconds || a.startTime.seconds;\\n                    const tB = b.shiftDateObj?.seconds || b.startTime.seconds;\\n                    return tA - tB;\\n                });\\n\\n            case \'PRIORIDAD\':\\n            default:\\n                return base.filter(s => {\\n                    if (s.isCompleted) return false;\\n                    const isReported = s.status === \'UNCOVERED_REPORTED\';\\n                    if (isReported) return false;\\n                    const isUnassigned = (!s.employeeId || s.employeeName === \'Sin Asignar\');\\n                    const problem = (s.isLate || s.isImminent || s.statusText === \'SIN CIERRE\' || (s.isAbsent && !s.isCompleted && !s.resolutionStatus));\\n                    return (problem && !s.isRetention) || isUnassigned;\\n                });\\n        }\\n    };\\n\\n    const displayList = getFilteredList();\\n\\n    // --- CONTADORES ---\\n    const countRetenidos = cleanData.filter(s => s.isRetention).length;\\n    const countAunNo = cleanData.filter(s => s.isLate && !s.isPresent && !s.isAbsent && !s.isCompleted).length;\\n    const countActivos = cleanData.filter(s => s.isPresent && !s.isCompleted && !s.isAbsent).length;\\n    const countAusentes = cleanData.filter(s => s.isAbsent).length;\\n    \\n    // [FIX] Contador HOY coherente (sin duplicados, sin vacantes)\\n    const todayStart = new Date(); todayStart.setHours(0,0,0,0);\\n    const todayEnd = new Date(); todayEnd.setHours(23,59,59,999);\\n    const todayUniqueSet = new Set();\\n    const countHoy = cleanData.filter(s => {\\n        const start = s.shiftDateObj && s.shiftDateObj.seconds ? new Date(s.shiftDateObj.seconds * 1000) : new Date(s.shiftDateObj);\\n        const isStrictlyToday = start >= todayStart && start <= todayEnd;\\n        const isUnassigned = !s.employeeId || s.employeeName === \'Sin Asignar\';\\n        if (isStrictlyToday && !isUnassigned) {\\n            if (todayUniqueSet.has(s.employeeId)) return false;\\n            todayUniqueSet.add(s.employeeId);\\n            return true;\\n        }\\n        return false;\\n    }).length;\\n\\n    const countPrioridad = cleanData.filter(s => {\\n        if (s.isCompleted) return false;\\n        const isReported = s.status === \'UNCOVERED_REPORTED\';\\n        if (isReported) return false;\\n        const isUnassigned = (!s.employeeId || s.employeeName === \'Sin Asignar\');\\n        const problem = (s.isLate || s.isImminent || s.statusText === \'SIN CIERRE\' || (s.isAbsent && !s.resolutionStatus));\\n        return (problem && !s.isRetention) || isUnassigned;\\n    }).length;\\n\\n    // ... (Manejo de Modales)\\n    const openResolution = (shift: any) => {\\n        if (shift.isRetention) { setRetentionModal({ isOpen: true, shift: shift }); return; }\\n        const isMinimized = minimizedResolutions.find(m => m.shift.id === shift.id);\\n        if (isMinimized) { setWizardData({ isOpen: true, shift: isMinimized.shift }); setMinimizedResolutions(prev => prev.filter(m => m.shift.id !== shift.id)); return; }\\n        setWizardData({ isOpen: true, shift: shift });\\n    };\\n    const openCheckout = (shift: any) => { setCheckoutData({ isOpen: true, shift: shift }); };\\n    const handleResolveWizard = () => { setWizardData({ isOpen: false, shift: null }); };\\n    const handleConfirmCheckout = async (novedad: string | null) => {\\n        if (!checkoutData.shift) return;\\n        setIsProcessing(true);\\n        try { await logic.handleAction(\'CHECKOUT\', checkoutData.shift.id, novedad); toast.success(\\"Salida registrada\\"); } \\n        catch(e) { toast.error(\\"Error al registrar salida\\"); } finally { setIsProcessing(false); }\\n    };\\n    const handleSummaryAction = (shift: any) => {\\n        setSummaryModal({ isOpen: false, type: null }); \\n        if (summaryModal.type === \'RETENTION\') openResolution(shift); else if (summaryModal.type === \'ACTIVE\') openCheckout(shift);\\n    };\\n    const handleSummaryResolve = (shift: any) => { setSummaryModal({ isOpen: false, type: null }); openResolution(shift); };\\n\\n    return (\\n        <DashboardLayout>\\n            <Toaster position=\\"top-right\\" />\\n            <Head><title>Operaciones | Monitor</title></Head>\\n            <style>{POPUP_STYLES}</style>\\n\\n            <div className=\\"h-[calc(100vh-100px)] flex flex-col lg:flex-row gap-4 p-2 animate-in fade-in relative\\">\\n                {!isExternalMap && (\\n                    <div className=\\"flex-1 lg:flex-[3] bg-slate-100 dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 overflow-hidden relative shadow-inner z-10\\">\\n                        <OperacionesMap \\n                            center={[-31.4201, -64.1888]} \\n                            objectives={logic.objectives} \\n                            processedData={cleanData} \\n                            onAction={logic.handleAction} \\n                            setMapInstance={setMapInstance} \\n                            onOpenResolution={openResolution} \\n                        />\\n                        <button onClick={() => setIsExternalMap(true)} className=\\"absolute top-4 right-4 z-[1000] bg-white dark:bg-slate-900 p-2 rounded-lg shadow-lg hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700\\" title=\\"Ventana Flotante\\"><ExternalLink size={20}/></button>\\n                    </div>\\n                )}\\n                {isExternalMap && (<ExternalMapWindow onClose={() => setIsExternalMap(false)}><div className=\\"h-full w-full relative\\"><OperacionesMap center={[-31.4201, -64.1888]} objectives={logic.objectives} processedData={cleanData} onAction={logic.handleAction} setMapInstance={setMapInstance} isExternal={true} onOpenResolution={openResolution} /></div></ExternalMapWindow>)}\\n                \\n                <div className={`bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 flex flex-col overflow-hidden shadow-xl transition-all duration-300 ${isExternalMap ? \'flex-1 w-full\' : \'flex-1 lg:flex-[2]\'}`}>\\n                    <div className=\\"p-4 bg-slate-50 dark:bg-slate-950/50 border-b border-slate-200 dark:border-slate-800\\">\\n                        <div className=\\"flex justify-between items-center mb-4\\"><h2 className=\\"text-lg font-black text-slate-800 dark:text-white flex items-center gap-2\\"><Radio className=\\"text-rose-600 animate-pulse\\" /> RADIO</h2><div className=\\"bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg px-2 py-1 text-xs font-mono text-slate-500 dark:text-slate-400 shadow-sm\\">{logic.now.toLocaleTimeString([], {hour:\'2-digit\', minute:\'2-digit\'})}</div></div>\\n                        \\n                        <div className=\\"flex p-1 bg-slate-200/50 dark:bg-slate-800 rounded-xl mb-3 gap-1 overflow-x-auto no-scrollbar snap-x\\">\\n                            <button onClick={() => setViewTab(\'PRIORIDAD\')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-lg transition-all flex items-center justify-center gap-1 min-w-[90px] whitespace-nowrap snap-center ${viewTab === \'PRIORIDAD\' ? \'bg-white dark:bg-slate-700 text-rose-600 dark:text-rose-400 shadow-md\' : \'text-slate-400 hover:text-slate-600\'}`}><Siren size={14}/> Prioridad ({countPrioridad})</button>\\n                            <button onClick={() => setViewTab(\'RETENIDOS\')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-lg transition-all flex items-center justify-center gap-1 min-w-[90px] whitespace-nowrap snap-center ${viewTab === \'RETENIDOS\' ? \'bg-white dark:bg-slate-700 text-orange-600 shadow-md\' : \'text-slate-400 hover:text-slate-600\'}`}><Clock size={14}/> Retenidos ({countRetenidos})</button>\\n                            <button onClick={() => setViewTab(\'AUN_NO\')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-lg transition-all flex items-center justify-center gap-1 min-w-[90px] whitespace-nowrap snap-center ${viewTab === \'AUN_NO\' ? \'bg-white dark:bg-slate-700 text-amber-600 shadow-md\' : \'text-slate-400 hover:text-slate-600\'}`}><Hourglass size={14}/> A煤n no llega ({countAunNo})</button>\\n                            <button onClick={() => setViewTab(\'ACTIVOS\')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-lg transition-all flex items-center justify-center gap-1 min-w-[90px] whitespace-nowrap snap-center ${viewTab === \'ACTIVOS\' ? \'bg-white dark:bg-slate-700 text-emerald-600 shadow-md\' : \'text-slate-400 hover:text-slate-600\'}`}><CheckCircle size={14}/> Activos ({countActivos})</button>\\n                            <button onClick={() => setViewTab(\'AUSENTES\')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-lg transition-all flex items-center justify-center gap-1 min-w-[90px] whitespace-nowrap snap-center ${viewTab === \'AUSENTES\' ? \'bg-white dark:bg-slate-700 text-rose-700 shadow-md\' : \'text-slate-400 hover:text-slate-600\'}`}><UserX size={14}/> Ausentes ({countAusentes})</button>\\n                            <button onClick={() => setViewTab(\'HOY\')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-lg transition-all flex items-center justify-center gap-1 min-w-[90px] whitespace-nowrap snap-center ${viewTab === \'HOY\' ? \'bg-white dark:bg-slate-700 text-indigo-600 shadow-md\' : \'text-slate-400 hover:text-slate-600\'}`}><Calendar size={14}/> Hoy ({countHoy})</button>\\n                        </div>\\n\\n                        <div className=\\"flex gap-2 items-center mt-3\\">\\n                             <div className=\\"relative flex-1\\"><Search className=\\"absolute left-3 top-2.5 text-slate-400\\" size={16}/><input className=\\"w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 pl-9 pr-3 py-2 rounded-xl text-xs font-bold uppercase focus:ring-2 focus:ring-indigo-500 outline-none transition-all dark:text-white\\" placeholder=\\"BUSCAR...\\" value={logic.filterText} onChange={(e) => logic.setFilterText(e.target.value)} /></div>\\n                             <button onClick={() => logic.setIsCompact(!logic.isCompact)} className={`p-2 rounded-xl border transition-all ${logic.isCompact ? \'bg-indigo-100 text-indigo-700\' : \'bg-white text-slate-400 border-slate-300\'}`} title={logic.isCompact ? \\"Vista Expandida\\" : \\"Vista Compacta\\"}>{logic.isCompact ? <Maximize2 size={18} /> : <Minimize2 size={18} />}</button>\\n                        </div>\\n                    </div>\\n                    \\n                    <div className=\\"flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50/30 dark:bg-slate-950/30 custom-scrollbar relative\\">\\n                        {displayList.length === 0 ? <div className=\\"flex flex-col items-center justify-center h-full w-full col-span-full text-slate-400 opacity-60\\"><ListFilter size={48} className=\\"mb-2\\"/><p className=\\"text-xs font-bold uppercase\\">Sin datos en esta vista</p></div> : displayList.map((s:any) => {\\n                            let type = \'PENDING\';\\n                            if (s.isLate) type = \'LATE\'; else if (s.isImminent) type = \'IMMINENT\'; else if (s.isPresent) type = \'ACTIVE\';\\n                            \\n                            return (\\n                                <GuardCard \\n                                    key={s.id} \\n                                    shift={s} \\n                                    statusType={type} \\n                                    onAction={logic.handleAction} \\n                                    isProcessing={logic.processingId === s.id} \\n                                    simpleView={viewTab === \'HOY\'} \\n                                    readOnly={viewTab === \'HOY\' || s.isCompleted} \\n                                    isCompact={logic.isCompact} \\n                                    onOpenResolution={openResolution} \\n                                    onOpenCheckout={openCheckout} \\n                                />\\n                            );\\n                        })}\\n                    </div>\\n                    \\n                    <div className=\\"h-40 border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 flex flex-col\\">\\n                        <div className=\\"px-4 py-2 border-b border-slate-100 dark:border-slate-800 flex items-center gap-2\\"><ClipboardList size={14} className=\\"text-slate-400\\"/><h3 className=\\"text-[10px] font-black uppercase text-slate-500 dark:text-slate-400\\">Bit谩cora del D铆a</h3></div>\\n                        <div className=\\"flex-1 overflow-y-auto custom-scrollbar p-0\\">\\n                            {logic.recentLogs.length === 0 ? <p className=\\"text-center text-[10px] text-slate-300 italic py-4\\">Sin actividad reciente</p> : (\\n                                <table className=\\"w-full text-[10px] text-left\\"><tbody className=\\"divide-y divide-slate-50 dark:divide-slate-800\\">{logic.recentLogs.map((log:any) => (<tr key={log.id} className=\\"hover:bg-slate-50 dark:hover:bg-slate-800/50\\"><td className=\\"px-4 py-2 font-mono text-slate-400 w-16\\">{log.time ? formatTime(log.time) : \'--:--\'}</td><td className=\\"px-2 py-2 w-24\\"><span className={`px-1.5 py-0.5 rounded font-bold uppercase text-[8px] border ${log.type === \'NOVEDAD\' ? \'bg-orange-50 text-orange-600 border-orange-100\' : \'bg-rose-50 text-rose-600 border-rose-100\'}`}>{log.type}</span></td><td className=\\"px-2 py-2 font-bold text-slate-700 dark:text-slate-300 truncate max-w-[100px]\\">{log.emp}</td><td className=\\"px-2 py-2 text-slate-500 dark:text-slate-400 truncate max-w-[150px]\\">{log.title}: {log.desc}</td></tr>))}</tbody></table>\\n                            )}\\n                        </div>\\n                    </div>\\n                </div>\\n            </div>\\n\\n            {/* MODALES */}\\n            <AbsenceResolutionModal isOpen={wizardData.isOpen} onClose={() => setWizardData({isOpen:false, shift: null})} absenceShift={wizardData.shift} onResolve={handleResolveWizard} />\\n            <RetentionModal isOpen={retentionModal.isOpen} onClose={() => setRetentionModal({isOpen:false, shift: null})} retainedShift={retentionModal.shift} onResolve={() => setRetentionModal({isOpen:false, shift: null})} />\\n            <CheckOutModal isOpen={checkoutData.isOpen} onClose={() => setCheckoutData({isOpen:false, shift:null})} onConfirm={handleConfirmCheckout} employeeName={checkoutData.shift?.employeeName || \'Desconocido\'} />\\n            <MapSummaryModal isOpen={summaryModal.isOpen} onClose={() => setSummaryModal({isOpen: false, type: null})} type={summaryModal.type} data={getSummaryData()} onAction={handleSummaryAction} onResolve={handleSummaryResolve} />\\n            {logic.modals.novedad && (<div className=\\"fixed inset-0 z-[6000] bg-black/60 flex items-center justify-center p-4\\"><div className=\\"bg-white p-6 rounded-2xl\\"><h3 className=\\"font-bold mb-4\\">Reportar Novedad</h3><button onClick={logic.confirmNovedad} className=\\"bg-rose-600 text-white px-4 py-2 rounded\\">Reportar</button><button onClick={() => logic.setModals(p=>({...p, novedad:false}))} className=\\"ml-2 text-slate-500\\">Cancelar</button></div></div>)}\\n            <div className=\\"fixed bottom-4 right-4 z-[8000] flex flex-col gap-2 items-end\\">{minimizedResolutions.map((item, idx) => (<div key={idx} onClick={() => { setWizardData({ isOpen: true, shift: item.shift }); setMinimizedResolutions(prev => prev.filter((_, i) => i !== idx)); }} className=\\"bg-slate-900 text-white p-3 rounded-xl shadow-2xl cursor-pointer hover:bg-slate-800 transition-all flex items-center gap-3 animate-in slide-in-from-bottom border border-slate-700\\"><div className=\\"relative\\"><Siren className=\\"text-rose-500 animate-pulse\\" size={20}/></div><div><p className=\\"text-xs font-bold uppercase\\">Incidencia Pendiente</p><p className=\\"text-[10px] text-slate-400\\">{item.shift?.employeeName}</p></div></div>))}</div>\\n        </DashboardLayout>\\n    );\\n}"},{"id":"w6y1xdha3","name":"index.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\planificacion\\\\index.tsx","area":"FRONTEND","content":"import React, { useState, useEffect, useMemo } from \'react\';\\nimport Head from \'next/head\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { \\n    ChevronLeft, ChevronRight, Search, Plus, \\n    Users, Clock, X, UserPlus, ArrowRight, Eye, EyeOff, \\n    CheckCircle, Trash2, ShieldAlert, User, Briefcase, Layers,\\n    Bell, CalendarX, Loader2, Stethoscope, MapPin, Lock, ShieldCheck, UserMinus,\\n    Save, Undo, History, MousePointer2, AlertTriangle, Grip, LayoutGrid, MonitorPlay,\\n    Printer, Download, Grid, RefreshCw, Edit3, Shield, ArrowRightCircle, Info, ArrowDownWideNarrow, ArrowDownAZ,\\n    BadgePercent, ArrowLeftRight, CalendarSearch, CheckSquare, XCircle, Search as SearchIcon, RefreshCcw, UserCheck, Map, Split, Ban,\\n    FastForward, Rewind, AlertOctagon, Siren, FileText, Fingerprint, CalendarCheck\\n} from \'lucide-react\';\\nimport { db } from \'@/lib/firebase\';\\nimport { getAuth, onAuthStateChanged } from \'firebase/auth\'; \\nimport { collection, onSnapshot, addDoc, deleteDoc, doc, query, orderBy, limit, serverTimestamp, Timestamp, where, getDocs, updateDoc, writeBatch } from \'firebase/firestore\';\\nimport { Toaster, toast } from \'sonner\';\\n\\n// --- CONFIGURACIN VISUAL ---\\nconst SHIFT_STYLES: any = {\\n    \'M\': \'bg-blue-100 text-blue-700 border-blue-200\',\\n    \'T\': \'bg-orange-100 text-orange-700 border-orange-200\',\\n    \'N\': \'bg-indigo-100 text-indigo-700 border-indigo-200\',\\n    \'D12\': \'bg-cyan-100 text-cyan-700 border-cyan-200\',\\n    \'N12\': \'bg-purple-100 text-purple-700 border-purple-200\',\\n    \'F\': \'bg-emerald-100 text-emerald-700 border-emerald-200\',\\n    \'PU\': \'bg-pink-100 text-pink-700 border-pink-200\',\\n    \'A\': \'bg-red-100 text-red-700 border-red-300 font-black pattern-diagonal\',        \\n    \'V\': \'bg-teal-600 text-white border-teal-700 font-black shadow-sm\', // ESTILO VACACIONES        \\n    \'L\': \'bg-purple-100 text-purple-700 border-purple-300 font-black\', \\n    \'E\': \'bg-rose-100 text-rose-700 border-rose-300 font-black\',    \\n    \'Ausencia con Aviso\': \'bg-amber-100 text-amber-700 border-amber-300\',\\n    \'LOCKED\': \'bg-slate-200 text-slate-500 border-slate-300 pattern-grid\',\\n    \'PAST\': \'bg-gray-100 text-gray-300 border-gray-200 cursor-not-allowed\',\\n    \'CONSOLIDATED\': \'bg-slate-100 text-slate-600 border-slate-300 font-bold opacity-90\',\\n    \'FT\': \'bg-violet-600 text-white border-violet-700 font-black shadow-sm\',\\n    \'FF\': \'bg-cyan-600 text-white border-cyan-700 font-black shadow-sm\',\\n    \'SWAP\': \'bg-cyan-50 text-cyan-700 border-cyan-300 border-dashed font-bold\'\\n};\\n\\nconst DEFAULT_LIMITS = { weekly: 48, monthly: 200 };\\n\\nconst SHIFT_HOURS_LOOKUP: Record<string, number> = {\\n    \'M\': 8, \'T\': 8, \'N\': 8, \'D12\': 12, \'N12\': 12, \'PU\': 12, \'F\': 0, \'FF\': 0, \'V\': 0, \'L\': 0, \'A\': 0, \'E\': 0 \\n};\\n\\nconst getDateKey = (dateInput: any) => {\\n    const d = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);\\n    const options: Intl.DateTimeFormatOptions = { timeZone: \'America/Argentina/Cordoba\', year: \'numeric\', month: \'2-digit\', day: \'2-digit\' };\\n    const parts = new Intl.DateTimeFormat(\'es-AR\', options).formatToParts(d);\\n    const day = parts.find(p => p.type === \'day\')?.value;\\n    const month = parts.find(p => p.type === \'month\')?.value;\\n    const year = parts.find(p => p.type === \'year\')?.value;\\n    return `${year}-${month}-${day}`;\\n};\\n\\nconst isDateLocked = (dateStr: string) => {\\n    const [y, m, d] = dateStr.split(\'-\').map(Number);\\n    const cellDate = new Date(y, m - 1, d);\\n    cellDate.setHours(23, 59, 59, 999); \\n    const startOfToday = new Date();\\n    startOfToday.setHours(0,0,0,0);\\n    return cellDate < startOfToday; \\n};\\n\\nconst getDefaultStyle = (code: string) => SHIFT_STYLES[code] || \'bg-slate-100 text-slate-700 border-slate-300\';\\n\\nconst formatTime = (dateInput: any) => {\\n    if (!dateInput) return \'--:--\';\\n    const d = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);\\n    return d.toLocaleTimeString(\'es-AR\', { hour: \'2-digit\', minute: \'2-digit\' });\\n};\\n\\nconst ACTION_LABELS: Record<string, string> = {\\n    \'ASIGNACION\': \'Asignaci贸n\', \'ELIMINACION\': \'Eliminaci贸n\', \'EDICION_MASIVA\': \'Edici贸n Masiva\',\\n    \'ASIGNACION_MASIVA\': \'Asignaci贸n M煤ltiple\', \'CAMBIO_FRANCO_TURNO\': \'Franco x Turno (FT)\', \'CAMBIO_TURNO_FRANCO\': \'Turno x Franco (FF)\',\\n};\\n\\ninterface Coords { r: number; c: number; }\\n\\nconst isShiftConsolidated = (shift: any) => {\\n    if (!shift) return false;\\n    if (shift.status === \'PRESENT\' || shift.status === \'CHECK_IN\' || shift.status === \'COMPLETED\') return true;\\n    return false;\\n};\\n\\nexport default function PlanificacionPage() {\\n    const [currentDate, setCurrentDate] = useState(new Date());\\n    const [selectedClient, setSelectedClient] = useState(\'\');\\n    const [selectedObjective, setSelectedObjective] = useState(\'\');\\n    const [forceShowAll, setForceShowAll] = useState(false);\\n    const [isProcessing, setIsProcessing] = useState(false);\\n    const [sortBy, setSortBy] = useState<\'name\' | \'activity\'>(\'activity\');\\n\\n    const [employees, setEmployees] = useState<any[]>([]);\\n    const [shiftsMap, setShiftsMap] = useState<Record<string, any>>({});\\n    const [absencesMap, setAbsencesMap] = useState<Record<string, any>>({});\\n    const [clients, setClients] = useState<any[]>([]);\\n    const [agreements, setAgreements] = useState<any[]>([]);\\n    const [unifiedLogs, setUnifiedLogs] = useState<any[]>([]);\\n    const [notifications, setNotifications] = useState<any[]>([]);\\n    const [showNotifications, setShowNotifications] = useState(false);\\n    const [hasUnread, setHasUnread] = useState(false);\\n    \\n    const [operatorName, setOperatorName] = useState(\'Cargando...\');\\n    const [operatorEmail, setOperatorEmail] = useState(\'\');\\n    const [usersMap, setUsersMap] = useState<Record<string, string>>({}); \\n\\n    const [positionStructure, setPositionStructure] = useState<any[]>([]);\\n    const [showAddModal, setShowAddModal] = useState(false);\\n    const [searchTerm, setSearchTerm] = useState(\'\');\\n    const [addSearchTerm, setAddSearchTerm] = useState(\'\');\\n    const [selectedCell, setSelectedCell] = useState<any>(null);\\n\\n    const [pendingAssignment, setPendingAssignment] = useState<any>(null); \\n    const [authWarningMessage, setAuthWarningMessage] = useState(\'\');\\n\\n    const [pendingChanges, setPendingChanges] = useState<Record<string, any>>({});\\n    const [selection, setSelection] = useState<{start: Coords | null, end: Coords | null}>({ start: null, end: null });\\n    const [isDragging, setIsDragging] = useState(false);\\n\\n    const [showHistoryModal, setShowHistoryModal] = useState(false);\\n    const [historyVersions, setHistoryVersions] = useState<any[]>([]);\\n    const [comparingSnapshot, setComparingSnapshot] = useState<any | null>(null);\\n\\n    const [francoMode, setFrancoMode] = useState<\'NONE\' | \'FT_SELECTION\' | \'FF_WIZARD\'>(\'NONE\');\\n    const [showSwapModal, setShowSwapModal] = useState(false);\\n    const [swapConfig, setSwapConfig] = useState<any>(null);\\n    const [selectedSwapTarget, setSelectedSwapTarget] = useState(\'\');\\n    const [selectedSwapDate, setSelectedSwapDate] = useState(\'\');\\n    const [swapSearchTerm, setSwapSearchTerm] = useState(\'\'); \\n    const [targetFrancos, setTargetFrancos] = useState<any[]>([]);\\n    const [coverageStep, setCoverageStep] = useState(false);\\n    const [coverShift1, setCoverShift1] = useState(\'M\');\\n    const [coverShift2, setCoverShift2] = useState(\'M\');\\n    const [isShift1Fixed, setIsShift1Fixed] = useState(false);\\n    const [isShift2Fixed, setIsShift2Fixed] = useState(false);\\n\\n    const [showRRHHModal, setShowRRHHModal] = useState(false);\\n    const [rrhhData, setRrhhData] = useState({ type: \'Ausencia con Aviso\', reason: \'\' });\\n    const [showConflictModal, setShowConflictModal] = useState(false);\\n    const [conflictNeighbors, setConflictNeighbors] = useState<{prev: any, next: any} | null>(null);\\n    \\n    // --- NUEVO: MODAL DE GESTIN DE VACACIONES ---\\n    const [showVacancyModal, setShowVacancyModal] = useState(false);\\n    const [vacancyData, setVacancyData] = useState<any>(null);\\n    const [selectedReplacement, setSelectedReplacement] = useState(\'\');\\n    \\n    const [modifiers, setModifiers] = useState({ extend: false, early: false, plannedNovedad: \'\' });\\n\\n    useEffect(() => {\\n        const loadUsers = async () => { \\n            try { \\n                const snap = await getDocs(collection(db, \'system_users\')); \\n                const map: Record<string, string> = {}; \\n                snap.docs.forEach(d => { const u = d.data(); if (u.email) map[u.email] = u.name || u.email; }); \\n                setUsersMap(map); \\n            } catch (e) { console.error(\\"Error loading users\\", e); } \\n        };\\n        loadUsers();\\n        const auth = getAuth();\\n        onAuthStateChanged(auth, (user) => { if (user) { setOperatorEmail(user.email || \'\'); setOperatorName(user.displayName || user.email || \\"Usuario\\"); } else { setOperatorName(\\"No Logueado\\"); } });\\n    }, []);\\n\\n    useEffect(() => {\\n        const unsubC = onSnapshot(collection(db, \'clients\'), snap => setClients(snap.docs.map(d => ({id: d.id, ...d.data()}))));\\n        const unsubAg = onSnapshot(collection(db, \'convenios\'), snap => setAgreements(snap.docs.map(d => ({ id: d.id, ...d.data() }))));\\n        const unsubE = onSnapshot(collection(db, \'empleados\'), snap => setEmployees(snap.docs.map(d => ({ id: d.id, name: d.data().name || d.data().firstName + \' \' + d.data().lastName, preferredObjectiveId: d.data().preferredObjectiveId, laborAgreement: d.data().laborAgreement }))));\\n        \\n        const unsubS = onSnapshot(collection(db, \'turnos\'), snap => { \\n            const map: any = {}; \\n            snap.docs.forEach(d => { \\n                const data = d.data(); \\n                if (data.startTime?.seconds) { \\n                    const dateKey = getDateKey(data.startTime); \\n                    const key = `${data.employeeId}_${dateKey}`; \\n                    map[key] = { \\n                        id: d.id, ...data, code: data.code || data.type, objectiveId: data.objectiveId, \\n                        startTime: data.startTime, realStartTime: data.realStartTime, status: data.status, \\n                        isExtended: data.isExtended, isEarlyStart: data.isEarlyStart || data.isEarlyEntry, \\n                        isFrancoTrabajado: data.isFrancoTrabajado || false, isFrancoCompensatorio: data.isFrancoCompensatorio || false, \\n                        swapWith: data.swapWith, swapDate: data.swapDate, hasNovedad: data.hasNovedad, plannedNovedad: data.plannedNovedad \\n                    }; \\n                } \\n            }); \\n            setShiftsMap(map); \\n        });\\n\\n        const unsubA = onSnapshot(collection(db, \'ausencias\'), snap => { \\n            const map: any = {}; \\n            snap.docs.forEach(d => { \\n                const data = d.data(); \\n                if (data.startDate && data.endDate && data.employeeId) { \\n                    const [sY, sM, sD] = data.startDate.split(\'-\').map(Number); \\n                    const [eY, eM, eD] = data.endDate.split(\'-\').map(Number); \\n                    let current = new Date(sY, sM - 1, sD); \\n                    const end = new Date(eY, eM - 1, eD); \\n                    while (current <= end) { \\n                        const key = `${data.employeeId}_${getDateKey(current)}`; \\n                        map[key] = { id: d.id, ...data, isAbsence: true }; \\n                        current.setDate(current.getDate() + 1); \\n                    } \\n                } \\n            }); \\n            setAbsencesMap(map); \\n        });\\n        \\n        return () => { unsubC(); unsubE(); unsubS(); unsubA(); unsubAg(); };\\n    }, []);\\n\\n    // --- MANEJO DE ALERTAS (CLICK EN CAMPANITA) ---\\n    const handleNotificationClick = async (notif: any) => {\\n        setShowNotifications(false);\\n        \\n        // 1. SI ES UNA LICENCIA/VACACIONES, ABRIR MODAL DE COBERTURA\\n        if (notif.source === \'AUSENCIA\' && notif.type && (notif.type.includes(\'Vacaciones\') || notif.type.includes(\'Licencia\'))) {\\n            setVacancyData(notif); // Pasamos toda la data de la ausencia\\n            setSelectedReplacement(\'\');\\n            setShowVacancyModal(true);\\n            return;\\n        }\\n\\n        // 2. NAVEGACIN ESTNDAR A FECHA\\n        if (notif.date) {\\n            try {\\n                let targetDate: Date | null = null;\\n                if (typeof notif.date === \'string\') { const parts = notif.date.split(\'-\'); if(parts.length === 3) { const y = parseInt(parts[0]); const m = parseInt(parts[1]) - 1; const d = parseInt(parts[2]); targetDate = new Date(y, m, d); } } else if (notif.date instanceof Date) { targetDate = notif.date; } else if (notif.date?.seconds) { targetDate = new Date(notif.date.seconds * 1000); }\\n                if (targetDate) {\\n                    setCurrentDate(new Date(targetDate.getFullYear(), targetDate.getMonth(), 1));\\n                    const targetEmp = employees.find(e => e.id === notif.employeeId || e.name === notif.employeeName);\\n                    if (targetEmp) { setSearchTerm(targetEmp.name); setForceShowAll(true); toast.info(`Navegando a: ${targetEmp.name}`); } else { toast.info(`Navegando a fecha: ${targetDate.toLocaleDateString()}`); }\\n                }\\n            } catch (e) { console.error(\\"Error navegando\\", e); }\\n        }\\n        \\n        // Marcar como vista\\n        if (notif.id) { try { const collectionName = notif.source === \'NOVEDAD\' ? \'novedades\' : \'ausencias\'; const notifRef = doc(db, collectionName, notif.id); await updateDoc(notifRef, { viewed: true }); } catch (e) { console.error(\\"Error marcar vista\\", e); } }\\n    };\\n\\n    // --- PROCESAMIENTO DE VACANTE (LGICA DEL MODAL NUEVO) ---\\n    const handleProcessVacancy = () => {\\n        if (!vacancyData || !selectedReplacement) return;\\n        \\n        const replacementEmp = employees.find(e => e.id === selectedReplacement);\\n        if (!replacementEmp) return;\\n\\n        const newChanges = { ...pendingChanges };\\n        const [sY, sM, sD] = vacancyData.startDate.split(\'-\').map(Number);\\n        const [eY, eM, eD] = vacancyData.endDate.split(\'-\').map(Number);\\n        let current = new Date(sY, sM - 1, sD);\\n        const end = new Date(eY, eM - 1, eD);\\n\\n        let count = 0;\\n\\n        while (current <= end) {\\n            const dateStr = getDateKey(current);\\n            const titularKey = `${vacancyData.employeeId}_${dateStr}`;\\n            const existingShift = shiftsMap[titularKey]; // El turno original del titular\\n\\n            // 1. Al Titular le ponemos \'V\' (Vacaciones)\\n            // No borramos su registro, lo marcamos como Licencia para que RRHH sepa\\n            newChanges[titularKey] = { \\n                code: \'V\', // V de Vacaciones\\n                name: \'Vacaciones\',\\n                isTemp: true,\\n                hours: 0,\\n                startTime: \'00:00\',\\n                comments: `Licencia: ${vacancyData.type}`\\n            };\\n\\n            // 2. Al Suplente le asignamos el turno que ten铆a el titular\\n            if (existingShift && existingShift.code !== \'F\') {\\n                const suplenteKey = `${replacementEmp.id}_${dateStr}`;\\n                newChanges[suplenteKey] = {\\n                    code: existingShift.code, // Mismo turno (ej: M, T, N)\\n                    name: existingShift.code,\\n                    isTemp: true,\\n                    objectiveId: existingShift.objectiveId, // Importante: Asignar al mismo objetivo\\n                    hours: existingShift.hours || 8,\\n                    startTime: existingShift.startTime,\\n                    comments: `Cubriendo a ${vacancyData.employeeName} (${vacancyData.type})`\\n                };\\n            }\\n\\n            count++;\\n            current.setDate(current.getDate() + 1);\\n        }\\n\\n        setPendingChanges(newChanges);\\n        setShowVacancyModal(false);\\n        setVacancyData(null);\\n        toast.success(`Cobertura planificada para ${count} d铆as. Revise y guarde los cambios.`);\\n    };\\n\\n\\n    useEffect(() => { const qLogs = query(collection(db, \'audit_logs\'), orderBy(\'timestamp\', \'desc\'), limit(20)); const unsubLogs = onSnapshot(qLogs, (snap) => { const items = snap.docs.map(d => ({ id: d.id, source: \'AUDIT\', timestamp: d.data().timestamp?.seconds * 1000, label: ACTION_LABELS[d.data().action] || d.data().action, detail: d.data().details, actor: d.data().actorName, actorUid: d.data().actorUid })); setUnifiedLogs(items); }); return () => unsubLogs(); }, []);\\n\\n    // --- DETECCIN DE NOTIFICACIONES (INCLUYENDO LICENCIAS/VACACIONES) ---\\n    useEffect(() => { \\n        const d = new Date(); d.setDate(d.getDate() - 30); const dateStr = d.toISOString().split(\'T\')[0];\\n        const qAbsence = query(collection(db, \'ausencias\'), where(\'startDate\', \'>=\', dateStr));\\n        const qNovedades = query(collection(db, \'novedades\'), where(\'createdAt\', \'>=\', Timestamp.fromDate(d)));\\n        const internalState: any = { ausencias: [], novedades: [] };\\n        \\n        const updateState = () => { const allItems = [...internalState.ausencias, ...internalState.novedades].sort((a,b) => b.createdAt - a.createdAt); setNotifications(allItems); setHasUnread(allItems.length > 0); };\\n        \\n        const unsubNotif = onSnapshot(qAbsence, (snap) => { \\n            const items = snap.docs.map(d => ({ ...d.data(), id: d.id, source: \'AUSENCIA\', createdAt: new Date(d.data().startDate).getTime() }))\\n                .filter((d:any) => !d.viewed)\\n                .map((d:any) => ({ \\n                    id: d.id, \\n                    title: d.type, // Ej: \\"Vacaciones\\"\\n                    msg: `${d.employeeName} - ${d.reason || \'Sin motivo\'}`, \\n                    type: d.type, // Guardamos el tipo crudo para filtrar en el click\\n                    startDate: d.startDate,\\n                    endDate: d.endDate,\\n                    employeeId: d.employeeId, \\n                    employeeName: d.employeeName, \\n                    critical: true, \\n                    source: \'AUSENCIA\', \\n                    createdAt: d.createdAt \\n                })); \\n            internalState.ausencias = items; \\n            updateState(); \\n        });\\n        \\n        const unsubNov = onSnapshot(qNovedades, (snap) => { const items = snap.docs.map(d => ({ ...d.data(), id: d.id })).filter((d:any) => !d.viewed && d.type !== \'NOVEDAD_CIERRE\').map((d:any) => ({ id: d.id, title: d.type, msg: `${d.employeeName} - ${d.notes}`, date: d.createdAt, employeeId: d.employeeId || d.shiftId, employeeName: d.employeeName, critical: true, source: \'NOVEDAD\', createdAt: d.createdAt?.seconds ? d.createdAt.seconds * 1000 : Date.now() })); internalState.novedades = items; updateState(); });\\n        return () => { unsubNotif(); unsubNov(); }; \\n    }, []);\\n\\n    useEffect(() => { if (!selectedClient || !selectedObjective) { setPositionStructure([]); return; } const fetchSLA = async () => { try { const q = query(collection(db, \'servicios_sla\'), where(\'clientId\', \'==\', selectedClient)); const snap = await getDocs(q); const srv = snap.docs.map(d => d.data()).find(d => d.objectiveId === selectedObjective); const structure: any[] = []; if (srv?.positions) { srv.positions.forEach((pos: any) => { if (pos.allowedShiftTypes?.length > 0) structure.push({ positionName: pos.name || \'General\', shifts: pos.allowedShiftTypes }); }); } if (structure.length === 0) structure.push({ positionName: \'General\', shifts: [{code:\'M\',hours:8},{code:\'T\',hours:8},{code:\'N\',hours:8}] }); setPositionStructure(structure); } catch (e) { setPositionStructure([]); } }; fetchSLA(); }, [selectedClient, selectedObjective]);\\n    const getObjectiveName = (objId: string) => { if (!objId) return \'Desconocido\'; for (const client of clients) { if (client.objetivos) { const found = client.objetivos.find((o: any) => (o.id || o.name) === objId); if (found) return found.name; } } return objId; };\\n    const loadHistory = async () => { if (!selectedObjective) { toast.error(\\"Seleccione un objetivo\\"); return; } try { const q = query(collection(db, \'planificaciones_historial\'), where(\'period\', \'==\', `${currentDate.getMonth()+1}-${currentDate.getFullYear()}`)); const snap = await getDocs(q); const versions = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter((v: any) => v.objectiveId === selectedObjective).sort((a:any, b:any) => b.timestamp.seconds - a.timestamp.seconds); setHistoryVersions(versions); setShowHistoryModal(true); } catch (e) { toast.error(\\"Error historial\\"); } };\\n    const daysInMonth = useMemo(() => { const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1); const days = []; while (d.getMonth() === currentDate.getMonth()) { days.push(new Date(d)); d.setDate(d.getDate() + 1); } return days; }, [currentDate]);\\n    const getEmployeeShiftCount = (empId: string) => { let count = 0; daysInMonth.forEach(day => { const key = `${empId}_${getDateKey(day)}`; const pending = pendingChanges[key]; const existing = shiftsMap[key]; if (pending) { if (!pending.isDeleted) count++; } else if (existing) { if (existing.objectiveId === selectedObjective) count++; } }); return count; };\\n    const displayedEmployees = useMemo(() => { if (!selectedObjective && !forceShowAll) return []; let list = employees; if (selectedObjective && !forceShowAll) { const activeGuestIds = new Set(); Object.values(shiftsMap).forEach((shift: any) => { if (shift.objectiveId === selectedObjective) activeGuestIds.add(shift.employeeId); }); Object.entries(pendingChanges).forEach(([key, change]: [string, any]) => { const [empId] = key.split(\'_\'); if (!change.isDeleted) activeGuestIds.add(empId); }); list = list.filter(e => e.preferredObjectiveId === selectedObjective || activeGuestIds.has(e.id)); } if (searchTerm) list = list.filter(e => e.name.toLowerCase().includes(searchTerm.toLowerCase())); return list.sort((a, b) => { if (sortBy === \'activity\') { const countA = getEmployeeShiftCount(a.id); const countB = getEmployeeShiftCount(b.id); if (countA !== countB) return countB - countA; } return a.name.localeCompare(b.name); }); }, [employees, selectedObjective, forceShowAll, searchTerm, shiftsMap, pendingChanges, sortBy]);\\n    const uniqueSLAShifts = useMemo(() => { const uniqueMap: any = {}; if (positionStructure && Array.isArray(positionStructure)) { positionStructure.forEach(pos => { if (pos.shifts && Array.isArray(pos.shifts)) { pos.shifts.forEach((s: any) => { if (s && s.code && !uniqueMap[s.code]) { uniqueMap[s.code] = s; } }); } }); } return Object.values(uniqueMap); }, [positionStructure]);\\n    const checkLaborRules = (empId: string, targetDate: Date, newHours: number) => { const emp = employees.find(e => e.id === empId); if (!emp) return null; const dateKey = getDateKey(targetDate); const key = `${empId}_${dateKey}`; if (absencesMap[key]) { return `ALERTA CRTICA: El empleado tiene una Ausencia Registrada (${absencesMap[key].type}) para esta fecha.`; } const rule = agreements.find(a => a.name === emp.laborAgreement) || agreements.find(a => a.name === \'General\') || { maxHoursWeekly: DEFAULT_LIMITS.weekly, maxHoursMonthly: DEFAULT_LIMITS.monthly }; const limitMonthly = parseInt(rule.maxHoursMonthly) || DEFAULT_LIMITS.monthly; const pendingShift = pendingChanges[key]; const existingShift = shiftsMap[key]; let finalShift = pendingShift ? (pendingShift.isDeleted ? null : pendingShift) : existingShift; if (finalShift && (finalShift.code === \'F\' || finalShift.isFranco)) return `ALERTA CRTICA: El empleado ya tiene un FRANCO asignado este d铆a.`; const targetMonthStr = getDateKey(targetDate).substring(0,7); let monthlyTotal = 0; const daysInCurrentMonth = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0).getDate(); for(let d=1; d<=daysInCurrentMonth; d++) { const checkDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), d); const k = `${empId}_${getDateKey(checkDate)}`; const p = pendingChanges[k]; const s = shiftsMap[k]; let active = p ? (p.isDeleted ? null : p) : s; if (active && active.code !== \'F\') monthlyTotal += (SHIFT_HOURS_LOOKUP[active.code] || active.hours || 8); } if ((monthlyTotal + newHours) > limitMonthly) return `ALERTA MENSUAL: L铆mite de ${limitMonthly}hs superado.`; return null; };\\n    const handleContextChange = (newClient: string, newObjective: string) => { if (Object.keys(pendingChanges).length > 0) { if (!confirm(`锔 TIENES CAMBIOS SIN GUARDAR.\\\\n驴Descartar y cambiar de objetivo?`)) return; setPendingChanges({}); } setSelectedClient(newClient); setSelectedObjective(newObjective); setSearchTerm(\'\'); setSelection({start: null, end: null}); setComparingSnapshot(null); };\\n    \\n    // --- BUSCADOR INTELIGENTE DE VECINOS PARA CONFLICTOS ---\\n    const findNeighbors = (problemShift: any, dateStr: string) => {\\n        const candidates: any[] = [];\\n        Object.values(shiftsMap).forEach((s: any) => {\\n            if (s.objectiveId === problemShift.objectiveId && getDateKey(s.startTime) === dateStr && s.id !== problemShift.id) {\\n                const key = `${s.employeeId}_${dateStr}`;\\n                if (!absencesMap[key]) {\\n                    candidates.push({ ...s, employeeName: employees.find(e => e.id === s.employeeId)?.name || \'Desconocido\' });\\n                }\\n            }\\n        });\\n        candidates.sort((a,b) => a.startTime.seconds - b.startTime.seconds);\\n        const myStart = problemShift.startTime.seconds;\\n        let prev = null; let next = null;\\n        for (const cand of candidates) {\\n            if (cand.startTime.seconds < myStart) prev = cand;\\n            if (cand.startTime.seconds > myStart && !next) next = cand;\\n        }\\n        setConflictNeighbors({ prev, next });\\n    };\\n\\n    //  MANEJO DE CLIC EN CELDA (CORREGIDO: ERROR 1 ARGUMENTO)\\n    const handleMouseUp = () => { \\n        setIsDragging(false); \\n        if (selection.start && selection.end && selection.start.r === selection.end.r && selection.start.c === selection.end.c) { \\n            const emp = displayedEmployees[selection.start.r]; \\n            const day = daysInMonth[selection.start.c]; \\n            const dateStr = getDateKey(day);\\n            const key = `${emp.id}_${dateStr}`; \\n            const shift = pendingChanges[key] || shiftsMap[key]; \\n            const absence = absencesMap[key];\\n\\n            if (selection.start.r === selection.end.r && selection.start.c === selection.end.c) { setSelection({ start: null, end: null }); }\\n            \\n            if (!pendingChanges[key]?.isDeleted) {\\n                if (isShiftConsolidated(shift)) {\\n                    setSelectedCell({ empId: emp.id, dateStr: dateStr, currentShift: shift, absence: absence });\\n                    return; \\n                }\\n\\n                // SI HAY TURNO Y AUSENCIA -> MODO CONFLICTO\\n                const isLocked = isDateLocked(dateStr); \\n                if (!isLocked && ((shift && absence) || (shift && shift.hasNovedad))) {\\n                    findNeighbors(shift, dateStr);\\n                    setSelectedCell({ empId: emp.id, dateStr: dateStr, currentShift: shift, absence: absence });\\n                    setShowConflictModal(true);\\n                } else {\\n                    if (!isLocked) {\\n                        let initialModifiers = { extend: false, early: false, plannedNovedad: \'\' };\\n                        if (shift) {\\n                            initialModifiers = { extend: shift.isExtended || false, early: shift.isEarlyStart || false, plannedNovedad: shift.plannedNovedad || \'\' };\\n                        }\\n                        setModifiers(initialModifiers);\\n                        setFrancoMode(\'NONE\');\\n                    }\\n                    setSelectedCell({ empId: emp.id, dateStr: dateStr, currentShift: shift, absence: absence });\\n                }\\n            } \\n        } \\n    };\\n\\n    const handleMouseDown = (r: number, c: number) => { \\n        if (!selectedObjective || comparingSnapshot) return; \\n        setIsDragging(true); setSelection({ start: {r, c}, end: {r, c} }); \\n    };\\n    \\n    const handleMouseEnter = (r: number, c: number) => { if (!isDragging) return; setSelection(prev => ({ ...prev, end: {r, c} })); };\\n    const isCellSelected = (r: number, c: number) => selection.start && r >= Math.min(selection.start.r, selection.end!.r) && r <= Math.max(selection.start.r, selection.end!.r) && c >= Math.min(selection.start.c, selection.end!.c) && c <= Math.max(selection.start.c, selection.end!.c);\\n    \\n    const resolveConflict = async (type: \'SPLIT\' | \'FULL_COVERAGE\') => { if (!selectedCell?.currentShift) return; const batch = writeBatch(db); const shiftId = selectedCell.currentShift.id; if (selectedCell.absence) { batch.update(doc(db, \'turnos\', shiftId), { status: \'ABSENT\', comments: \'Cubierto por ausencia\' }); } else { batch.update(doc(db, \'turnos\', shiftId), { hasNovedad: false, comments: \'Novedad resuelta\' }); } if (type === \'SPLIT\') { if (conflictNeighbors?.prev) { batch.update(doc(db, \'turnos\', conflictNeighbors.prev.id), { isExtended: true, comments: \'Extensi贸n por cobertura\' }); } if (conflictNeighbors?.next) { batch.update(doc(db, \'turnos\', conflictNeighbors.next.id), { isEarlyStart: true, comments: \'Adelanto por cobertura\' }); } toast.success(\\"Cobertura aplicada: Extensi贸n + Adelanto\\"); } else { setShowConflictModal(false); setFrancoMode(\'FT_SELECTION\'); return; } await batch.commit(); setShowConflictModal(false); setSelectedCell(null); };\\n    const handleRRHHSubmit = async () => { if (!selectedCell) return; try { await addDoc(collection(db, \'ausencias\'), { employeeId: selectedCell.empId, employeeName: employees.find(e => e.id === selectedCell.empId)?.name, startDate: selectedCell.dateStr, endDate: selectedCell.dateStr, type: rrhhData.type, reason: rrhhData.reason, status: \'APPROVED\', createdAt: serverTimestamp() }); toast.success(\\"Ausencia cargada por RRHH\\"); setShowRRHHModal(false); setSelectedCell(null); } catch(e) { toast.error(\\"Error al cargar ausencia\\"); } };\\n    const handleAssignShift = async (shiftConfig: any, positionName: string) => { if (!selectedCell) return; if (isDateLocked(selectedCell.dateStr)) { toast.error(\\"Periodo cerrado.\\"); return; } const key = `${selectedCell.empId}_${selectedCell.dateStr}`; const existing = selectedCell.currentShift; const isFT = francoMode === \'FT_SELECTION\'; if (existing && existing.objectiveId !== selectedObjective && !existing.isFranco && !isFT) { const objName = getObjectiveName(existing.objectiveId); if(!confirm(`锔 ALERTA DE TRANSFERENCIA\\\\n\\\\nEl empleado ya tiene turno en \\"${objName}\\".\\\\n\\\\n驴Desea moverlo a este objetivo?`)) return; applyToPending({ ...shiftConfig, oldObjectiveId: existing.objectiveId }); return; } if (existing && (existing.code === \'F\' || existing.isFranco) && shiftConfig.code !== \'F\' && !isFT) { if(!confirm(`锔 ATENCIN: EST ELIMINANDO UN FRANCO\\\\n\\\\n驴Seguro que desea eliminar el Franco?`)) return; } const [y, m, d] = selectedCell.dateStr.split(\'-\').map(Number); const targetDate = new Date(y, m-1, d); const hours = shiftConfig.hours || 8; if (shiftConfig.code !== \'F\' && !isFT) { const warning = checkLaborRules(selectedCell.empId, targetDate, hours); if (warning) { setAuthWarningMessage(warning); if(warning.includes(\\"CRTICA\\")) { toast.error(warning); return; } setPendingAssignment({ shiftConfig, positionName, targetDate }); return; } } applyToPending({ ...shiftConfig, isFrancoTrabajado: isFT, isExtended: modifiers.extend, isEarlyStart: modifiers.early, plannedNovedad: modifiers.plannedNovedad }); };\\n    const confirmPendingAssignment = () => { if (!pendingAssignment) return; applyToPending({ ...pendingAssignment.shiftConfig, isFrancoTrabajado: francoMode === \'FT_SELECTION\', isExtended: modifiers.extend, isEarlyStart: modifiers.early, plannedNovedad: modifiers.plannedNovedad }); setPendingAssignment(null); setAuthWarningMessage(\'\'); };\\n    const applyToPending = (config: any) => { const key = `${selectedCell.empId}_${selectedCell.dateStr}`; const newChanges = { ...pendingChanges }; newChanges[key] = { ...config, isTemp: true, isFranco: config.code === \'F\' || config.code === \'FF\' || config.isFranco, swapWith: config.swapWith || null, swapDate: config.swapDate || null }; setPendingChanges(newChanges); setSelectedCell(null); setPendingAssignment(null); setSwapConfig(null); setShowSwapModal(false); toast.info(\\"Cambio aplicado\\"); };\\n    const executeSwap = () => { const emp1 = selectedCell.empId; const date1 = selectedCell.dateStr; const emp2 = selectedSwapTarget; const date2 = selectedSwapDate; const newChanges = { ...pendingChanges }; const name1 = employees.find(e => e.id === emp1)?.name || \'Emp1\'; const name2 = employees.find(e => e.id === emp2)?.name || \'Emp2\'; newChanges[`${emp1}_${date1}`] = { code: coverShift1, isTemp: true, isFranco: false, isSwap: true, swapWith: name2 }; newChanges[`${emp2}_${date1}`] = { code: \'FF\', isTemp: true, isFranco: true, isFrancoCompensatorio: true, swapWith: name1, swapDate: date2 }; newChanges[`${emp1}_${date2}`] = { code: \'FF\', isTemp: true, isFranco: true, isFrancoCompensatorio: true, swapWith: name2, swapDate: date1 }; newChanges[`${emp2}_${date2}`] = { code: coverShift2, isTemp: true, isFranco: false, isSwap: true, swapWith: name1 }; setPendingChanges(newChanges); setShowSwapModal(false); setSwapConfig(null); setSelectedCell(null); setCoverageStep(false); toast.success(\\"Enroque completado\\"); };\\n    const handleSelectDate = (dateStr: string) => { setSelectedSwapDate(dateStr); setCoverageStep(true); const getShiftInfo = (eId: string, dStr: string) => { const k = `${eId}_${dStr}`; return pendingChanges[k] || shiftsMap[k]; }; const s1 = getShiftInfo(selectedSwapTarget, selectedCell.dateStr); if (s1 && s1.code !== \'F\' && s1.code !== \'FF\') { setCoverShift1(s1.code); setIsShift1Fixed(true); } else { setCoverShift1(\'M\'); setIsShift1Fixed(false); } const s2 = getShiftInfo(selectedCell.empId, dateStr); if (s2 && s2.code !== \'F\' && s2.code !== \'FF\') { setCoverShift2(s2.code); setIsShift2Fixed(true); } else { setCoverShift2(\'M\'); setIsShift2Fixed(false); } };\\n    useEffect(() => { if (selectedSwapTarget) { const dates: any[] = []; Object.values(shiftsMap).forEach((s: any) => { if (s.employeeId === selectedSwapTarget && (s.code === \'F\' || s.isFranco)) { const [y, m, d] = getDateKey(s.startTime).split(\'-\'); dates.push({ dateStr: getDateKey(s.startTime), label: `${d}/${m}` }); } }); setTargetFrancos(dates); } else { setTargetFrancos([]); } }, [selectedSwapTarget, shiftsMap]);\\n    const swapCandidates = useMemo(() => { if (!showSwapModal) return []; return employees.filter(e => e.id !== swapConfig?.empId).filter(e => e.name.toLowerCase().includes(swapSearchTerm.toLowerCase())).sort((a, b) => a.name.localeCompare(b.name)); }, [employees, showSwapModal, swapSearchTerm, swapConfig]);\\n    const handleDelete = async () => { if (!selectedCell) return; if (isDateLocked(selectedCell.dateStr)) { toast.warning(\\"Bloqueado.\\"); return; } const key = `${selectedCell.empId}_${selectedCell.dateStr}`; const newChanges = { ...pendingChanges }; newChanges[key] = { isDeleted: true }; setPendingChanges(newChanges); setSelectedCell(null); toast.info(\\"Marcado para borrar.\\"); };\\n    const getSafeTime = (input: any) => { if (!input) return [6, 0]; if (typeof input === \'string\') return input.split(\':\').map(Number); if (input.toDate) { const d = input.toDate(); return [d.getHours(), d.getMinutes()]; } if (input.seconds) { const d = new Date(input.seconds * 1000); return [d.getHours(), d.getMinutes()]; } if (input instanceof Date) return [input.getHours(), input.getMinutes()]; return [6, 0]; };\\n    const handleSaveAll = async () => { const count = Object.keys(pendingChanges).length; if (count === 0) return; if (!confirm(`驴Confirmar y guardar ${count} cambios?`)) return; setIsProcessing(true); const batch = writeBatch(db); const auth = getAuth(); const realActorName = usersMap[operatorEmail] || operatorName || \'Sistema\'; const logData: any[] = []; const snapshotData: Record<string, any> = {}; displayedEmployees.forEach(emp => { daysInMonth.forEach(day => { const key = `${emp.id}_${getDateKey(day)}`; const pending = pendingChanges[key]; const existing = shiftsMap[key]; if (pending) { if (!pending.isDeleted) { snapshotData[key] = { code: pending.code, isFranco: pending.isFranco, isFrancoTrabajado: pending.isFrancoTrabajado, isFrancoCompensatorio: pending.isFrancoCompensatorio, swapWith: pending.swapWith, objectiveId: selectedObjective, isExtended: pending.isExtended, isEarlyStart: pending.isEarlyStart }; } } else if (existing) { if(existing.objectiveId === selectedObjective) { snapshotData[key] = { code: existing.code, isFranco: existing.isFranco, isFrancoTrabajado: existing.isFrancoTrabajado, isFrancoCompensatorio: existing.isFrancoCompensatorio, swapWith: existing.swapWith, objectiveId: selectedObjective, isExtended: existing.isExtended, isEarlyStart: existing.isEarlyStart }; } } }); }); try { for (const [key, change] of Object.entries(pendingChanges)) { const [empId, dateStr] = key.split(\'_\'); const existing = shiftsMap[key]; const empObj = employees.find(e => e.id === empId); const empName = empObj ? empObj.name : \'Desconocido\'; let actionType = \'ASIGNACION_MASIVA\'; let actionDetail = `Asign贸 ${change.code} a ${empName} el ${dateStr}`; if (change.isDeleted) { actionType = \'ELIMINACION_MASIVA\'; actionDetail = `Borr贸 turno de ${empName} el ${dateStr}`; if (existing?.id) batch.delete(doc(db, \'turnos\', existing.id)); } else { if (existing?.id) batch.delete(doc(db, \'turnos\', existing.id)); if (existing) { if ((existing.code === \'F\' || existing.isFranco) && change.code !== \'F\') { if (change.isFrancoTrabajado) { actionType = \'CAMBIO_FRANCO_TURNO\'; actionDetail = `Asign贸 FT (${change.code}) a ${empName} el ${dateStr}`; } else { actionType = \'CAMBIO_DIAGRAMA\'; actionDetail = `Cambio de Diagrama (F x ${change.code}) a ${empName}`; } } else if (existing.code !== \'F\' && change.code === \'F\') { if (change.isFrancoCompensatorio) { actionType = \'CAMBIO_TURNO_FRANCO\'; actionDetail = `Asign贸 FF a ${empName} el ${dateStr}`; } } } const [y, m, d] = dateStr.split(\'-\').map(Number); const tDate = new Date(y, m-1, d); const [sh, sm] = getSafeTime(change.startTime); const start = new Date(tDate); start.setHours(sh, sm, 0); const end = new Date(start); if(change.code === \'F\' || change.code === \'FF\') end.setHours(23,59,59); else end.setTime(start.getTime() + ((change.hours||8)*3600000)); const safeSwapWith = change.swapWith || null; const safeSwapDate = change.swapDate || null; batch.set(doc(collection(db, \'turnos\')), { employeeId: empId, clientId: selectedClient, objectiveId: selectedObjective, code: change.isFrancoCompensatorio ? \'FF\' : change.code, type: change.name||change.code, startTime: Timestamp.fromDate(start), endTime: Timestamp.fromDate(end), isFranco: change.code===\'F\' || change.isFrancoCompensatorio || change.isFranco === true, isFrancoTrabajado: change.isFrancoTrabajado || false, isFrancoCompensatorio: change.isFrancoCompensatorio || false, swapWith: safeSwapWith, swapDate: safeSwapDate, createdAt: serverTimestamp(), comments: \'Carga Masiva\', isExtended: change.isExtended || false, isEarlyStart: change.isEarlyStart || false, plannedNovedad: change.plannedNovedad || null }); logData.push({ empId, date: dateStr, action: actionType }); batch.set(doc(collection(db, \'audit_logs\')), { action: actionType, module: \'PLANIFICADOR\', details: actionDetail, timestamp: serverTimestamp(), actorName: realActorName, actorUid: auth.currentUser?.uid }); } } await addDoc(collection(db, \'planificaciones_historial\'), { timestamp: serverTimestamp(), user: realActorName, period: `${currentDate.getMonth()+1}-${currentDate.getFullYear()}`, objectiveId: selectedObjective, changes: logData, count, snapshot: JSON.stringify(snapshotData) }); await batch.commit(); setPendingChanges({}); toast.success(\\"Guardado exitoso\\"); } catch(e) { console.error(e); toast.error(\\"Error al guardar\\"); } finally { setIsProcessing(false); } };\\n    const handleViewSnapshot = (v: any) => { try { const data = JSON.parse(v.snapshot); setComparingSnapshot({ id: v.id, date: new Date(v.timestamp.seconds*1000), user: v.user, data: data }); setShowHistoryModal(false); } catch(e) { toast.error(\\"Error al cargar versi贸n hist贸rica\\"); } };\\n    const exitSnapshotMode = () => setComparingSnapshot(null);\\n    const handleUnassignEmployee = async (emp: any) => { if (!selectedObjective) return; if (emp.preferredObjectiveId !== selectedObjective) { toast.error(\\"Error asignaci贸n.\\"); return; } if (!confirm(`驴CONFIRMAR DESVINCULACIN?`)) return; try { await updateDoc(doc(db, \'empleados\', emp.id), { preferredObjectiveId: null }); await addDoc(collection(db, \'audit_logs\'), { action: \'DESVINCULACION_OBJETIVO\', module: \'PLANIFICADOR\', details: `Desvincul贸 a ${emp.name}`, timestamp: serverTimestamp(), actorName: operatorName, actorUid: getAuth().currentUser?.uid }); toast.success(\\"Desvinculado\\"); } catch (e) { toast.error(\\"Error\\"); } };\\n    const applyBulkChange = (shiftConfig: any) => { if (!selection.start || !selection.end) return; const startDay = daysInMonth[Math.min(selection.start.c, selection.end.c)]; if (isDateLocked(getDateKey(startDay))) { toast.warning(\\"Periodo cerrado.\\"); return; } const minR = Math.min(selection.start.r, selection.end.r); const maxR = Math.max(selection.start.r, selection.end.r); const minC = Math.min(selection.start.c, selection.end.c); const maxC = Math.max(selection.start.c, selection.end.c); const newChanges = { ...pendingChanges }; let count = 0; let francosReplaced = 0; for (let r = minR; r <= maxR; r++) { const emp = displayedEmployees[r]; if (!emp) continue; for (let c = minC; c <= maxC; c++) { const day = daysInMonth[c]; const key = `${emp.id}_${getDateKey(day)}`; const existing = shiftsMap[key]; if (existing && (existing.code === \'F\' || existing.isFranco) && shiftConfig && shiftConfig.code !== \'F\') { francosReplaced++; } } } let markAsFT = false; if (francosReplaced > 0) { if(confirm(`锔 Est谩s sobrescribiendo ${francosReplaced} Francos.\\\\n驴Deseas marcarlos como FT?`)) { markAsFT = true; } } for (let r = minR; r <= maxR; r++) { const emp = displayedEmployees[r]; if (!emp) continue; for (let c = minC; c <= maxC; c++) { const day = daysInMonth[c]; const key = `${emp.id}_${getDateKey(day)}`; const existing = shiftsMap[key]; if (isShiftConsolidated(existing)) continue; if (shiftConfig === null) { newChanges[key] = { isDeleted: true }; } else { let cellIsFT = false; if (existing && (existing.code === \'F\' || existing.isFranco) && shiftConfig.code !== \'F\') { cellIsFT = markAsFT; } newChanges[key] = { ...shiftConfig, isTemp: true, oldObjectiveId: existing?.objectiveId, isFrancoTrabajado: cellIsFT }; } count++; } } setPendingChanges(newChanges); toast.info(`${count} celdas`); };\\n\\n    const renderGrid = (isSnapshotView: boolean, snapshotData?: any) => (\\n        <table className=\\"border-collapse w-full text-xs\\">\\n            <thead className=\\"sticky top-0 z-30 bg-slate-100 shadow-md h-10\\"><tr><th className=\\"sticky left-0 z-40 bg-slate-100 p-2 text-left min-w-[150px] border-b border-r\\"><span className=\\"text-[10px] font-black uppercase\\"><Users size={12}/> Dotaci贸n</span></th>{daysInMonth.map(d => <th key={d.toISOString()} className={`min-w-[25px] border-b border-r p-1 text-center ${[0,6].includes(d.getDay())?\'bg-slate-200\':\'\'}`}><span className=\\"text-[10px] font-bold\\">{d.getDate()}</span></th>)}</tr></thead>\\n            <tbody>\\n                {displayedEmployees.map((emp, idx) => (\\n                    <tr key={emp.id} className=\\"group hover:bg-slate-50\\">\\n                        <td className=\\"sticky left-0 z-20 bg-white p-2 border-r border-b shadow-sm group-hover:bg-slate-50 flex justify-between items-center h-8\\">\\n                            <span className=\\"text-[9px] font-bold truncate w-32 flex items-center gap-1\\">\\n                                {emp.name}\\n                                {selectedObjective && emp.preferredObjectiveId !== selectedObjective && <ArrowRightCircle size={10} className=\\"text-indigo-500\\"/>}\\n                            </span>\\n                            {!isSnapshotView && selectedObjective && emp.preferredObjectiveId === selectedObjective && (\\n                                <button onClick={(e) => { e.stopPropagation(); handleUnassignEmployee(emp); }} className=\\"opacity-0 group-hover:opacity-100 p-1 hover:bg-rose-100 text-rose-400 hover:text-rose-600 rounded transition-all ml-1\\" title=\\"Desvincular del Objetivo\\"><UserMinus size={12}/></button>\\n                            )}\\n                        </td>\\n                        {daysInMonth.map((day, dayIndex) => {\\n                            const key = `${emp.id}_${getDateKey(day)}`;\\n                            let s, p;\\n                            if (isSnapshotView && snapshotData) { const sn = snapshotData[key]; if (sn) s = { ...sn, id: \'history\', objectiveId: selectedObjective }; p = null; } else { s = shiftsMap[key]; p = pendingChanges[key]; }\\n                            const selected = !isSnapshotView && isCellSelected(idx, dayIndex);\\n                            const isLockedDate = !isSnapshotView && isDateLocked(getDateKey(day));\\n                            let content = null; let style = \\"\\";\\n                            let isFT = s?.isFrancoTrabajado || p?.isFrancoTrabajado; let isFF = s?.isFrancoCompensatorio || p?.isFrancoCompensatorio;\\n                            let isExtended = s?.isExtended || p?.isExtended; let isEarly = s?.isEarlyStart || p?.isEarlyStart; \\n                            let plannedNov = s?.plannedNovedad || p?.plannedNovedad; \\n                            \\n                            let absence = absencesMap[key];\\n                            let hasConflict = (s && absence && s.status !== \'ABSENT\') || (s && s.hasNovedad); \\n\\n                            let statusIndicator = null;\\n                            if (s && !isSnapshotView) { if (s.status === \'PRESENT\' || s.status === \'COMPLETED\') statusIndicator = \'bg-emerald-500\'; else if (s.status === \'ABSENT\') statusIndicator = \'bg-rose-500\'; }\\n                            let isSwap = s?.swapWith || p?.swapWith;\\n                            const nonLockableCodes = [\'V\', \'L\', \'A\', \'E\']; let isLocked = s && s.objectiveId !== selectedObjective && !s.isFranco && !isFT && !isFF && !nonLockableCodes.includes(s.code);\\n                            \\n                            if (isLockedDate) { style = SHIFT_STYLES[\'PAST\']; if (s) content = s.code; } \\n                            else if (p) { if(p.isDeleted) { content=<X size={12}/>; style=\\"bg-rose-50 text-rose-300\\"; } else { if(isFT) { style=SHIFT_STYLES[\'FT\']; content=\\"FT\\"; } else if(isFF) { style=SHIFT_STYLES[\'FF\']; content=\\"FF\\"; } else { content=p.code; style=`bg-amber-100 text-amber-700 font-black ring-2 ring-amber-400 ${isSwap ? SHIFT_STYLES[\'SWAP\'] : \'\'}`; } } } \\n                            else if (s) { \\n                                if (!isLockedDate) {\\n                                    if(isFT) { style=SHIFT_STYLES[\'FT\']; content=\\"FT\\"; } else if(isFF) { style=SHIFT_STYLES[\'FF\']; content=\\"FF\\"; } else { style=`${getDefaultStyle(s.code)} ${isSwap ? SHIFT_STYLES[\'SWAP\'] : \'\'}`; content=s.code; } \\n                                }\\n                            }\\n                            \\n                            if (isExtended) { style += \' ring-2 ring-violet-600 z-10\'; }\\n                            if (isEarly) { style += \' ring-2 ring-cyan-500 z-10\'; }\\n                            if (plannedNov === \'AVISO\') { style += \' border-l-4 border-l-amber-500\'; } \\n                            if (plannedNov === \'LICENCIA\') { style += \' border-l-4 border-l-purple-500\'; } \\n                            \\n                            // VISUALIZACIN DE VACACIONES\\n                            if (absence) { \\n                                style = SHIFT_STYLES[\'V\'] || \'bg-teal-600 text-white font-black\'; \\n                                content = \\"V\\"; \\n                                if (absence.type === \'Vacaciones\') { content = \\"V\\"; }\\n                                else if (absence.type === \'Enfermedad\') { content = \\"E\\"; style = SHIFT_STYLES[\'E\']; }\\n                                else { content = \\"AUS\\"; style = \'bg-rose-50 text-rose-700 font-bold border-rose-200\'; }\\n                            }\\n\\n                            return <td key={key} onMouseDown={() => !isSnapshotView && handleMouseDown(idx, dayIndex)} onMouseEnter={() => !isSnapshotView && isDragging && setSelection(pr => ({...pr, end:{r:idx, c:dayIndex}}))} className={`border-b border-r p-0.5 ${!isSnapshotView && !isLockedDate ? \'cursor-pointer\' : \'cursor-default\'} text-center relative ${selected?\'bg-indigo-200\':\'\'}`}>\\n                                <div className={`w-full h-6 rounded flex items-center justify-center text-[9px] font-black relative ${style}`}>\\n                                    {content}\\n                                    {(isExtended || isEarly) && <div className=\\"absolute -top-1 -right-1 text-[8px] bg-slate-800 text-white px-1 rounded-full\\">+</div>}\\n                                    {statusIndicator && <div className={`absolute top-0 right-0 w-2 h-2 rounded-full border border-white ${statusIndicator}`}></div>}\\n                                    {hasConflict && ( <div className=\\"absolute inset-0 bg-red-500/30 flex items-center justify-center animate-pulse border-2 border-red-500 z-20\\"><Siren size={14} className=\\"text-white drop-shadow-md\\"/></div> )}\\n                                </div>\\n                            </td>;\\n                        })}\\n                    </tr>\\n                ))}\\n            </tbody>\\n        </table>\\n    );\\n\\n    return (\\n        <DashboardLayout>\\n            <Head><title>Planificador</title></Head>\\n            <style>{`.pattern-grid { background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%, transparent 75%, #e5e7eb 75%, #e5e7eb), linear-gradient(45deg, #e5e7eb 25%, transparent 25%, transparent 75%, #e5e7eb 75%, #e5e7eb); background-size: 10px 10px; background-position: 0 0, 5px 5px; } @media print { @page { size: A4 landscape; margin: 5mm; } body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background-color: white !important; } #printable-section { position: absolute; left: 0; top: 0; width: 100%; min-width: 100%; transform: none; background: white; } .no-print { display: none !important; } .custom-scrollbar { overflow: visible !important; height: auto !important; } }`}</style>\\n            <Toaster position=\\"top-center\\" />\\n            <div className=\\"flex flex-col h-[calc(100vh-100px)] p-2 space-y-4 animate-in fade-in select-none\\" onMouseUp={handleMouseUp}>\\n                \\n                <div className=\\"bg-white p-3 rounded-2xl shadow-sm border flex flex-wrap items-center justify-between gap-3 shrink-0\\">\\n                    {comparingSnapshot ? (\\n                         <div className=\\"flex-1 bg-amber-50 border-amber-200 border px-4 py-2 rounded-xl flex justify-between items-center animate-in slide-in-from-top no-print shadow-sm\\">\\n                            <div className=\\"flex items-center gap-4\\">\\n                                <div className=\\"p-2 bg-amber-100 rounded-lg text-amber-700\\"><Split size={20}/></div>\\n                                <div><p className=\\"text-xs font-black text-amber-800 uppercase\\">Modo Comparaci贸n Activado</p><p className=\\"text-[10px] text-amber-600\\">Comparando Actualidad vs. Versi贸n del {comparingSnapshot.date.toLocaleString()}</p></div>\\n                            </div>\\n                            <button onClick={exitSnapshotMode} className=\\"bg-amber-600 text-white px-4 py-2 rounded-lg text-xs font-black hover:bg-amber-700 shadow-sm flex items-center gap-2\\"><X size={14}/> CERRAR COMPARACIN</button>\\n                        </div>\\n                    ) : (\\n                        <>\\n                            <div className=\\"flex gap-2 no-print\\">\\n                                <select value={selectedClient} onChange={e => handleContextChange(e.target.value, \'\')} className=\\"bg-slate-50 border p-2 rounded-xl text-xs font-bold w-40\\"><option value=\\"\\">Cliente...</option>{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>\\n                                <select value={selectedObjective} onChange={e => handleContextChange(selectedClient, e.target.value)} className=\\"bg-slate-50 border p-2 rounded-xl text-xs font-bold w-40\\"><option value=\\"\\">Objetivo...</option>{clients.find(c => c.id === selectedClient)?.objetivos?.map((o:any) => <option key={o.id||o.name} value={o.id||o.name}>{o.name}</option>)}</select>\\n                            </div>\\n                            {Object.keys(pendingChanges).length > 0 && <div className=\\"flex items-center gap-2 animate-in slide-in-from-top-2 bg-amber-50 p-1.5 rounded-xl border border-amber-200 shadow-lg no-print\\"><span className=\\"text-[10px] font-bold text-amber-700 uppercase tracking-widest hidden md:inline\\">Planificando como: {operatorName}</span><div className=\\"h-4 w-px bg-amber-200 mx-1\\"></div><span className=\\"text-xs font-black text-amber-700 px-1\\">{Object.keys(pendingChanges).length} cambios</span><button onClick={() => setPendingChanges({})} className=\\"p-1.5 hover:bg-amber-100 rounded-lg text-amber-600\\"><Undo size={16}/></button><button onClick={handleSaveAll} className=\\"bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-xs font-black flex items-center gap-2 shadow\\"><Save size={14}/> GUARDAR</button></div>}\\n                            <div className=\\"flex items-center gap-3 no-print\\">\\n                                <div className=\\"relative\\"><button onClick={() => {setShowNotifications(!showNotifications); setHasUnread(false)}} className=\\"p-2 bg-slate-100 hover:bg-slate-200 rounded-xl relative\\"><Bell size={18}/>{hasUnread && <span className=\\"absolute top-0 right-0 w-3 h-3 bg-rose-500 rounded-full border-2 border-white animate-pulse\\"></span>}</button>{showNotifications && (<div className=\\"absolute right-0 top-full mt-2 w-80 bg-white rounded-2xl shadow-2xl border overflow-hidden z-50 animate-in zoom-in-95\\"><div className=\\"p-3 bg-slate-50 border-b flex justify-between items-center\\"><h3 className=\\"font-black text-xs uppercase text-slate-500\\">Alertas</h3><button onClick={() => setShowNotifications(false)}><X size={14}/></button></div><div className=\\"max-h-60 overflow-y-auto\\">{notifications.length > 0 ? notifications.map((notif, i) => (<div key={i} className=\\"p-3 border-b last:border-0 hover:bg-slate-50 flex gap-3 items-start cursor-pointer\\" onClick={() => handleNotificationClick(notif)}><div className=\\"p-2 rounded-full bg-amber-100 text-amber-600\\"><CalendarX size={16}/></div><div><p className=\\"text-xs font-bold text-slate-800\\">{notif.title}</p><p className=\\"text-[10px] text-slate-500\\">{notif.msg}</p><p className=\\"text-[9px] font-mono text-slate-400 mt-1\\">{notif.createdAt ? new Date(notif.createdAt).toLocaleDateString() : notif.date}</p></div></div>)) : <div className=\\"p-6 text-center text-slate-400 text-xs\\">Sin novedades recientes.</div>}</div></div>)}</div>\\n                                <div className=\\"flex items-center bg-slate-100 rounded-xl p-1\\"><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className=\\"p-1 hover:bg-white rounded-lg\\"><ChevronLeft size={16}/></button><span className=\\"px-3 font-black text-xs w-24 text-center capitalize\\">{currentDate.toLocaleDateString(\'es-AR\', {month:\'long\'})}</span><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className=\\"p-1 hover:bg-white rounded-lg\\"><ChevronRight size={16}/></button></div>\\n                                <button onClick={loadHistory} className=\\"p-2 bg-slate-100 rounded-lg hover:bg-indigo-50 hover:text-indigo-600 transition-colors\\" title=\\"Ver Historial\\" disabled={!selectedObjective}><History size={18}/></button>\\n                                <button onClick={() => setSortBy(prev => prev === \'name\' ? \'activity\' : \'name\')} className=\\"p-2 bg-slate-100 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition-colors border border-transparent hover:border-indigo-200\\" title={sortBy === \'activity\' ? \\"Ordenado por Actividad\\" : \\"Ordenado por Nombre\\"}>{sortBy === \'activity\' ? <ArrowDownWideNarrow size={18}/> : <ArrowDownAZ size={18}/>}</button>\\n                                <button onClick={() => setForceShowAll(!forceShowAll)} className={`px-3 py-2 rounded-xl text-xs font-black uppercase flex items-center gap-2 border transition-colors ${forceShowAll ? \'bg-amber-100 text-amber-700 border-amber-200\' : \'bg-white border-slate-200 text-slate-500\'}`}>{forceShowAll ? <Eye size={14}/> : <EyeOff size={14}/>} {forceShowAll ? \'Ver Todos\' : \'Dotaci贸n\'}</button>\\n                                <button onClick={() => setShowAddModal(true)} disabled={!selectedObjective} className=\\"bg-slate-900 text-white px-3 py-2 rounded-xl text-xs font-black uppercase flex items-center gap-2 hover:bg-slate-800 disabled:opacity-50\\"><UserPlus size={14}/> Asignar</button>\\n                            </div>\\n                        </>\\n                    )}\\n                </div>\\n\\n                {/* BARRA FLOTANTE */}\\n                {selection.start && (selection.start.r !== selection.end?.r || selection.start.c !== selection.end?.c) && !comparingSnapshot && (\\n                    <div className=\\"absolute top-24 left-1/2 -translate-x-1/2 z-[60] bg-slate-800 text-white p-2 rounded-2xl shadow-2xl flex gap-1 animate-in zoom-in-95 items-center border border-slate-600 no-print\\">\\n                        <span className=\\"text-[10px] font-bold px-2 text-slate-300 uppercase tracking-wider\\">Asignar:</span>\\n                        {uniqueSLAShifts.map((s: any) => ( <button key={s.code} onClick={() => applyBulkChange({ code: s.code, name: s.name, hours: s.hours, startTime: s.startTime })} className={`w-8 h-8 rounded-lg font-black text-xs ${getDefaultStyle(s.code)}`}>{s.code}</button>))}\\n                        <button onClick={() => applyBulkChange({ code: \'F\', name: \'Franco\', hours: 0, startTime: \'00:00\' })} className=\\"w-8 h-8 rounded-lg bg-emerald-600 text-white font-black text-xs border border-emerald-700\\">F</button>\\n                        \\n                        {/* BOTN RRHH */}\\n                        <div className=\\"h-6 w-px bg-slate-600 mx-2\\"></div>\\n                        <button onClick={() => setShowRRHHModal(true)} className=\\"p-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-white font-bold text-xs flex items-center gap-2 shadow-sm\\"><FileText size={12}/> +Ausencia</button>\\n                        \\n                        <div className=\\"h-6 w-px bg-slate-600 mx-2\\"></div>\\n                        <button onClick={() => applyBulkChange(null)} className=\\"p-2 hover:bg-rose-600 rounded-lg text-rose-300 hover:text-white transition-colors\\" title=\\"Borrar\\"><Trash2 size={16}/></button>\\n                        <button onClick={() => setSelection({start:null, end:null})} className=\\"ml-1 p-2 hover:bg-slate-700 rounded-lg\\"><X size={16}/></button>\\n                    </div>\\n                )}\\n\\n                {/* GRID CONTAINER */}\\n                <div id=\\"printable-section\\" className=\\"flex-1 rounded-2xl border shadow-xl overflow-hidden flex flex-col relative select-none bg-slate-100 gap-1\\">\\n                      <div className={`flex-1 bg-white flex flex-col overflow-hidden ${comparingSnapshot ? \'rounded-t-2xl border-b-4 border-slate-300\' : \'rounded-2xl\'}`}>\\n                        <div className=\\"hidden print:block p-4 border-b text-center mb-2\\"><h1 className=\\"text-xl font-black uppercase text-slate-900\\">Planificaci贸n Mensual</h1></div>\\n                        {comparingSnapshot && <div className=\\"px-4 py-1 bg-white text-[10px] font-black uppercase text-slate-400 border-b flex justify-between\\"><span>VISTA ACTUAL (EN VIVO)</span></div>}\\n                        <div className=\\"flex-1 overflow-auto custom-scrollbar\\">{renderGrid(false)}</div>\\n                      </div>\\n                      {comparingSnapshot && (\\n                        <div className=\\"flex-1 bg-amber-50/50 flex flex-col overflow-hidden rounded-b-2xl animate-in slide-in-from-bottom duration-300\\">\\n                             <div className=\\"px-4 py-1 bg-amber-100 text-[10px] font-black uppercase text-amber-700 border-b border-amber-200 flex justify-between items-center shadow-sm\\"><span>VISTA HISTRICA: {comparingSnapshot.date.toLocaleString()}</span><span className=\\"text-[9px] opacity-75\\">Por: {comparingSnapshot.user}</span></div>\\n                             <div className=\\"flex-1 overflow-auto custom-scrollbar bg-amber-50\\">{renderGrid(true, comparingSnapshot.data)}</div>\\n                        </div>\\n                      )}\\n                </div>\\n\\n                {/* MODAL DETALLE (CON RESOLUCIN DE NOVEDAD Y VISTA LECTURA) */}\\n                {selectedCell && !pendingAssignment && !comparingSnapshot && !showSwapModal && !showConflictModal && !showRRHHModal && !showVacancyModal && (\\n                    <div className=\\"fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 no-print\\">\\n                        <div className=\\"bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in zoom-in-95\\">\\n                            <div className=\\"flex justify-between items-center mb-4 border-b pb-2\\"><div><h3 className=\\"font-black text-lg uppercase\\">{employees.find(e=>e.id===selectedCell.empId)?.name}</h3><p className=\\"text-xs text-slate-500 font-bold\\">{selectedCell.dateStr}</p></div><button onClick={() => setSelectedCell(null)} className=\\"p-2 bg-slate-100 rounded-full hover:bg-slate-200\\"><X size={16}/></button></div>\\n                            \\n                            {(selectedCell.currentShift?.code === \'F\' || selectedCell.currentShift?.isFranco) && francoMode === \'NONE\' ? (\\n                                <div className=\\"space-y-4\\">\\n                                    <div className=\\"p-6 bg-emerald-50 rounded-2xl border border-emerald-200 text-center\\"><h3 className=\\"text-2xl font-black text-emerald-700\\">FRANCO</h3><p className=\\"text-xs text-emerald-600 mt-2\\">驴Qu茅 desea hacer con este franco?</p></div>\\n                                    <div className=\\"grid grid-cols-2 gap-3\\">\\n                                        <button onClick={() => setFrancoMode(\'FT_SELECTION\')} className=\\"p-4 bg-violet-50 hover:bg-violet-100 border border-violet-200 rounded-xl flex flex-col items-center gap-2 transition-colors\\"><BadgePercent size={24} className=\\"text-violet-600\\"/><span className=\\"text-[10px] font-black text-violet-700 uppercase\\">Franco Trabajado (FT)</span></button>\\n                                        <button onClick={() => { setSwapConfig({ empId: selectedCell.empId, dateStr: selectedCell.dateStr, oldShift: selectedCell.currentShift }); setSwapSearchTerm(\'\'); setShowSwapModal(true); }} className=\\"p-4 bg-cyan-50 hover:bg-cyan-100 border border-cyan-200 rounded-xl flex flex-col items-center gap-2 transition-colors\\"><ArrowLeftRight size={24} className=\\"text-cyan-600\\"/><span className=\\"text-[10px] font-black text-cyan-700 uppercase\\">Intercambiar (FF)</span></button>\\n                                    </div>\\n                                    {!isShiftConsolidated(selectedCell.currentShift) && (\\n                                        <button onClick={handleDelete} className=\\"w-full py-3 bg-slate-100 text-slate-500 rounded-xl font-bold text-xs hover:bg-slate-200 flex items-center justify-center gap-2\\"><Trash2 size={14}/> Borrar / Dejar Vac铆o</button>\\n                                    )}\\n                                </div>\\n                            ) : (\\n                                <>\\n                                    {selectedCell.currentShift ? (\\n                                        <div className={`mb-6 p-4 border rounded-2xl text-center relative ${selectedCell.currentShift.isFrancoTrabajado ? \'bg-violet-50 border-violet-200\' : selectedCell.currentShift.isFrancoCompensatorio ? \'bg-cyan-50 border-cyan-200\' : \'bg-indigo-50 border-indigo-100\'}`}>\\n                                            {/* SI ES CONSOLIDADO, MOSTRAMOS BADGE DE SOLO LECTURA */}\\n                                            {isShiftConsolidated(selectedCell.currentShift) && (\\n                                                <div className=\\"absolute -top-3 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[9px] font-black px-3 py-1 rounded-full uppercase flex items-center gap-1 shadow-md z-10\\">\\n                                                    <Lock size={10}/> Consolidado / Solo Lectura\\n                                                </div>\\n                                            )}\\n                                            \\n                                            {selectedCell.currentShift.isFrancoTrabajado ? ( \\n                                                <>\\n                                                    <BadgePercent size={32} className=\\"mx-auto text-violet-600 mb-2\\"/>\\n                                                    <h3 className=\\"text-xl font-black text-violet-700 uppercase\\">Franco Trabajado</h3>\\n                                                    <p className=\\"text-[10px] font-bold text-violet-500 mt-1\\">Cubri贸 turno: <span className=\\"text-lg\\">{selectedCell.currentShift.code}</span></p>\\n                                                    <div className=\\"mt-2 bg-white/50 p-1.5 rounded border border-violet-100 inline-block\\"><p className=\\"text-[9px] font-bold text-violet-800 flex items-center gap-1 justify-center\\"><MapPin size={10}/> {getObjectiveName(selectedCell.currentShift.objectiveId || selectedObjective)}</p></div>\\n                                                </> \\n                                            ) \\n                                            : selectedCell.currentShift.isFrancoCompensatorio ? ( \\n                                                <>\\n                                                    <ArrowLeftRight size={32} className=\\"mx-auto text-cyan-600 mb-2\\"/>\\n                                                    <h3 className=\\"text-xl font-black text-cyan-700 uppercase\\">Franco Compensatorio</h3>\\n                                                    <div className=\\"bg-white p-3 rounded-xl border border-cyan-200 mt-2 shadow-sm text-left\\">\\n                                                        <p className=\\"text-[10px] text-cyan-500 font-bold uppercase mb-1 flex items-center gap-1\\"><UserCheck size={10}/> Intercambio con:</p><p className=\\"text-sm font-black text-slate-800 mb-2\\">{selectedCell.currentShift.swapWith || \'---\'}</p><div className=\\"h-px bg-cyan-100 my-2\\"></div><p className=\\"text-[10px] text-cyan-500 font-bold uppercase mb-1 flex items-center gap-1\\"><CalendarSearch size={10}/> Fecha Devuelta:</p><p className=\\"text-sm font-bold text-slate-600\\">{selectedCell.currentShift.swapDate || \'---\'}</p>\\n                                                    </div>\\n                                                </> \\n                                            ) \\n                                            : ( \\n                                                <>\\n                                                    <p className=\\"text-[10px] font-black text-indigo-400 uppercase\\">Turno Actual</p>\\n                                                    <p className=\\"text-3xl font-black text-indigo-700 mt-1\\">{selectedCell.currentShift.code}</p>\\n                                                    \\n                                                    {/* --- AQUI AGREGAMOS EL HORARIO --- */}\\n                                                    <div className=\\"my-2 bg-white/60 p-2 rounded-lg border border-indigo-200 inline-block\\">\\n                                                        <p className=\\"text-xs font-bold text-slate-700 flex items-center justify-center gap-2\\">\\n                                                            <Clock size={12}/> \\n                                                            {(() => {\\n                                                                const code = selectedCell.currentShift.code;\\n                                                                // --- CORRECCIN CLAVE: Tipado expl铆cito ---\\n                                                                const shiftConf = (uniqueSLAShifts as any[]).find((s: any) => s.code === code);\\n                                                                if (shiftConf && shiftConf.startTime && shiftConf.endTime) {\\n                                                                    return `${shiftConf.startTime} - ${shiftConf.endTime}`;\\n                                                                } else if (shiftConf && shiftConf.hours) {\\n                                                                    return `${shiftConf.hours} horas`;\\n                                                                }\\n                                                                return \\"Horario Est谩ndar\\";\\n                                                            })()}\\n                                                        </p>\\n                                                    </div>\\n                                                    {/* ------------------------------- */}\\n\\n                                                    {selectedCell.currentShift.swapWith && <p className=\\"text-[9px] text-cyan-600 mt-1 font-bold\\"> Cubre a: {selectedCell.currentShift.swapWith}</p>}\\n                                                    {selectedCell.currentShift.realStartTime && (\\n                                                        <div className=\\"mt-3 pt-3 border-t border-indigo-200/50\\">\\n                                                                <p className=\\"text-[9px] font-black uppercase text-slate-400\\">Datos Reales (Operaciones)</p>\\n                                                                <div className=\\"flex justify-between text-xs mt-1\\"><span className=\\"font-bold text-slate-600\\">Entrada:</span><span className=\\"font-mono text-indigo-600 font-bold\\">{formatTime(selectedCell.currentShift.realStartTime)}</span></div>\\n                                                                {selectedCell.currentShift.status === \'ABSENT\' && (<div className=\\"bg-rose-100 text-rose-600 text-xs font-bold px-2 py-1 rounded mt-2 uppercase text-center\\">Ausente</div>)}\\n                                                        </div>\\n                                                    )}\\n                                                </> \\n                                            )}\\n                                            {!isShiftConsolidated(selectedCell.currentShift) && <button onClick={handleDelete} className=\\"absolute top-2 right-2 p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-full\\"><Trash2 size={16}/></button>}\\n                                        </div>\\n                                    ) : <div className=\\"p-4 text-center text-slate-400 text-xs italic mb-4\\">Celda vac铆a</div>}\\n\\n                                    {/* SI NO ES CONSOLIDADO, MOSTRAMOS LOS CONTROLES DE EDICIN */}\\n                                    {!isShiftConsolidated(selectedCell.currentShift) ? (\\n                                        <>\\n                                            <div className=\\"bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4 space-y-3\\">\\n                                                <p className=\\"text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1\\"><AlertOctagon size={10}/> Gesti贸n de Horario y Ausencias</p>\\n                                                \\n                                                <div className=\\"grid grid-cols-2 gap-2\\">\\n                                                    <button onClick={() => setModifiers(p => ({...p, extend: !p.extend}))} className={`p-2 rounded-lg text-xs font-bold border flex items-center justify-center gap-1 transition-all ${modifiers.extend ? \'bg-violet-100 border-violet-300 text-violet-700 ring-1 ring-violet-400\' : \'bg-white border-slate-200 text-slate-500\'}`}><FastForward size={14}/> Extender Salida</button>\\n                                                    <button onClick={() => setModifiers(p => ({...p, early: !p.early}))} className={`p-2 rounded-lg text-xs font-bold border flex items-center justify-center gap-1 transition-all ${modifiers.early ? \'bg-cyan-100 border-cyan-300 text-cyan-700 ring-1 ring-cyan-400\' : \'bg-white border-slate-200 text-slate-500\'}`}><Rewind size={14}/> Adelantar Ingreso</button>\\n                                                </div>\\n\\n                                                <div>\\n                                                    <label className=\\"text-[9px] font-bold text-slate-400 uppercase mb-1 block\\">Registro de Ausencia / Licencia</label>\\n                                                    <div className=\\"flex gap-1 bg-white border rounded-lg p-1\\">\\n                                                        <button onClick={() => setModifiers(p => ({...p, plannedNovedad: \'\'}))} className={`flex-1 py-1 rounded text-[10px] font-bold ${!modifiers.plannedNovedad ? \'bg-slate-100 text-slate-700\' : \'text-slate-400 hover:bg-slate-50\'}`}>Normal</button>\\n                                                        <button onClick={() => setModifiers(p => ({...p, plannedNovedad: \'AVISO\'}))} className={`flex-1 py-1 rounded text-[10px] font-bold ${modifiers.plannedNovedad === \'AVISO\' ? \'bg-amber-100 text-amber-700\' : \'text-slate-400 hover:bg-slate-50\'}`}>Con Aviso</button>\\n                                                        <button onClick={() => setModifiers(p => ({...p, plannedNovedad: \'LICENCIA\'}))} className={`flex-1 py-1 rounded text-[10px] font-bold ${modifiers.plannedNovedad === \'LICENCIA\' ? \'bg-purple-100 text-purple-700\' : \'text-slate-400 hover:bg-slate-50\'}`}>Licencia</button>\\n                                                    </div>\\n                                                </div>\\n                                            </div>\\n\\n                                            <div className=\\"space-y-6\\">\\n                                                <p className=\\"text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-1 flex items-center gap-2\\">\\n                                                    {francoMode === \'FT_SELECTION\' ? <><BadgePercent size={12} className=\\"text-violet-500\\"/> Seleccione Turno para FT</> : <><Edit3 size={10}/> Acciones</>}\\n                                                </p>\\n                                                {positionStructure.map((pos, idx) => ( <div key={idx} className=\\"space-y-2\\"><div className=\\"flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase\\"><Layers size={10}/> {pos.positionName}</div><div className=\\"grid grid-cols-3 gap-2\\">{pos.shifts.map((conf: any) => (<button key={conf.code} onClick={() => handleAssignShift(conf, pos.positionName)} className={`p-2 rounded-xl border flex flex-col items-center justify-center gap-1 hover:brightness-95 ${getDefaultStyle(conf.code)}`}><span className=\\"font-black text-sm\\">{conf.code}</span></button>))}</div></div> ))}\\n                                                {francoMode === \'NONE\' && <div className=\\"pt-2 border-t\\"><button onClick={() => handleAssignShift({code:\'F\', name:\'Franco\', startTime:\'00:00\'}, \'General\')} className=\\"w-full p-3 rounded-xl border bg-emerald-50 border-emerald-200 text-emerald-700 font-black text-sm hover:brightness-95\\">ASIGNAR FRANCO</button></div>}\\n                                                {francoMode !== \'NONE\' && <button onClick={() => setFrancoMode(\'NONE\')} className=\\"w-full py-3 bg-slate-100 text-slate-500 rounded-xl font-bold text-xs hover:bg-slate-200\\">Volver / Cancelar</button>}\\n                                            </div>\\n                                        </>\\n                                    ) : (\\n                                        /* VISTA DE SOLO LECTURA PARA CONSOLIDADOS */\\n                                        <div className=\\"text-center p-4 bg-slate-50 rounded-xl border border-slate-200\\">\\n                                            <p className=\\"text-xs text-slate-500 italic\\">Este turno ya fue consolidado y no puede ser modificado desde el planificador.</p>\\n                                            <div className=\\"mt-4 flex gap-2 justify-center\\">\\n                                                 <div className=\\"p-2 bg-white border rounded-lg text-center min-w-[60px]\\">\\n                                                     <p className=\\"text-[9px] font-bold text-slate-400 uppercase\\">Inicio</p>\\n                                                     <p className=\\"font-mono text-indigo-600 font-bold\\">{formatTime(selectedCell.currentShift.startTime)}</p>\\n                                                 </div>\\n                                                 <div className=\\"p-2 bg-white border rounded-lg text-center min-w-[60px]\\">\\n                                                     <p className=\\"text-[9px] font-bold text-slate-400 uppercase\\">Fin</p>\\n                                                     <p className=\\"font-mono text-indigo-600 font-bold\\">{formatTime(selectedCell.currentShift.endTime || selectedCell.currentShift.startTime)}</p>\\n                                                 </div>\\n                                            </div>\\n                                        </div>\\n                                    )}\\n                                </>\\n                            )}\\n                        </div>\\n                    </div>\\n                )}\\n                \\n                {/* MODAL DE CONFIRMACIN DE ALERTAS */}\\n                {pendingAssignment && (\\n                    <div className=\\"fixed inset-0 z-[150] bg-amber-900/40 backdrop-blur-sm flex items-center justify-center p-4\\">\\n                        <div className=\\"bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl border-2 border-amber-400 animate-in zoom-in-95\\">\\n                            <div className=\\"flex flex-col items-center text-center space-y-4\\">\\n                                <div className=\\"p-4 bg-amber-100 rounded-full text-amber-600\\"><AlertTriangle size={32} /></div>\\n                                <div><h3 className=\\"font-black text-lg text-amber-800 uppercase\\">Advertencia Laboral</h3><p className=\\"text-xs text-slate-600 mt-2 font-medium\\">{authWarningMessage}</p></div>\\n                                <div className=\\"w-full pt-4 border-t flex gap-3\\">\\n                                    <button onClick={() => { setPendingAssignment(null); setAuthWarningMessage(\'\'); }} className=\\"flex-1 py-3 text-slate-500 font-bold text-xs rounded-xl hover:bg-slate-100\\">Cancelar</button>\\n                                    <button onClick={confirmPendingAssignment} className=\\"flex-1 py-3 bg-amber-500 text-white font-black text-xs rounded-xl hover:bg-amber-600 shadow-md\\">Confirmar</button>\\n                                </div>\\n                            </div>\\n                        </div>\\n                    </div>\\n                )}\\n\\n                {/* MODAL ASISTENTE DE COBERTURA (NUEVO) */}\\n                {showConflictModal && selectedCell && (\\n                    <div className=\\"fixed inset-0 z-[200] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in\\">\\n                        <div className=\\"bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl relative\\">\\n                            <div className=\\"flex items-center gap-4 mb-6 border-b pb-4\\">\\n                                <div className=\\"p-4 bg-rose-100 text-rose-600 rounded-2xl animate-pulse\\"><Siren size={32}/></div>\\n                                <div><h3 className=\\"font-black text-xl text-rose-700 uppercase\\">Conflicto de Cobertura</h3><p className=\\"text-sm font-bold text-slate-500\\">Ausencia registrada sobre turno activo.</p></div>\\n                            </div>\\n                            <div className=\\"grid grid-cols-2 gap-4 mb-6\\">\\n                                <div className=\\"p-4 bg-slate-50 rounded-xl border border-slate-200\\"><p className=\\"text-[10px] font-black uppercase text-slate-400\\">Ausencia</p><p className=\\"font-bold text-slate-800\\">{selectedCell.absence?.type || \'Novedad\'}</p></div>\\n                                <div className=\\"p-4 bg-indigo-50 rounded-xl border border-indigo-200\\"><p className=\\"text-[10px] font-black uppercase text-indigo-400\\">Turno Afectado</p><p className=\\"font-black text-2xl text-indigo-700\\">{selectedCell.currentShift.code}</p></div>\\n                            </div>\\n                            <h4 className=\\"text-xs font-black uppercase text-slate-400 mb-3\\">Opciones de Resoluci贸n</h4>\\n                            <div className=\\"space-y-3\\">\\n                                <button onClick={() => resolveConflict(\'SPLIT\')} className=\\"w-full p-4 bg-white border-2 border-violet-100 hover:border-violet-500 rounded-xl flex items-center gap-4 group transition-all\\">\\n                                    <div className=\\"p-2 bg-violet-100 text-violet-600 rounded-lg group-hover:bg-violet-600 group-hover:text-white transition-colors\\"><ArrowLeftRight size={20}/></div>\\n                                    <div className=\\"text-left\\"><p className=\\"font-bold text-slate-700 text-sm\\">Extender y Adelantar</p><p className=\\"text-[10px] text-slate-400\\">Extiende salida del turno anterior y adelanta ingreso del posterior.</p></div>\\n                                </button>\\n                                <button onClick={() => resolveConflict(\'FULL_COVERAGE\')} className=\\"w-full p-4 bg-white border-2 border-emerald-100 hover:border-emerald-500 rounded-xl flex items-center gap-4 group transition-all\\">\\n                                    <div className=\\"p-2 bg-emerald-100 text-emerald-600 rounded-lg group-hover:bg-emerald-600 group-hover:text-white transition-colors\\"><UserPlus size={20}/></div>\\n                                    <div className=\\"text-left\\"><p className=\\"font-bold text-slate-700 text-sm\\">Asignar Suplente (Franco Trabajado)</p><p className=\\"text-[10px] text-slate-400\\">Busca un guardia de franco para cubrir el turno completo.</p></div>\\n                                </button>\\n                            </div>\\n                            <button onClick={() => setShowConflictModal(false)} className=\\"w-full mt-6 py-3 text-slate-400 font-bold text-xs hover:text-slate-600\\">Cancelar y resolver luego</button>\\n                        </div>\\n                    </div>\\n                )}\\n\\n                {/* MODAL CARGA RRHH (NUEVO) */}\\n                {showRRHHModal && (\\n                    <div className=\\"fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in\\">\\n                        <div className=\\"bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative\\">\\n                            <button onClick={() => setShowRRHHModal(false)} className=\\"absolute top-4 right-4 text-slate-400 hover:text-slate-600\\"><X size={20}/></button>\\n                            <h3 className=\\"font-black text-lg text-slate-800 mb-1 flex items-center gap-2\\"><FileText className=\\"text-amber-600\\"/> Carga de Ausencia (RRHH)</h3>\\n                            <p className=\\"text-xs text-slate-500 mb-4\\">Simulaci贸n de carga de novedad por RRHH.</p>\\n                            <div className=\\"space-y-3\\">\\n                                <div><label className=\\"text-[10px] font-bold text-slate-400 uppercase\\">Tipo de Ausencia</label><select className=\\"w-full p-2 border rounded-lg text-sm font-bold bg-slate-50\\" value={rrhhData.type} onChange={e => setRrhhData({...rrhhData, type: e.target.value})}><option value=\\"Ausencia con Aviso\\">Ausencia con Aviso</option><option value=\\"Licencia M茅dica\\">Licencia M茅dica</option><option value=\\"Vacaciones\\">Vacaciones</option></select></div>\\n                                <div><label className=\\"text-[10px] font-bold text-slate-400 uppercase\\">Motivo / Detalle</label><textarea className=\\"w-full p-2 border rounded-lg text-sm bg-slate-50 min-h-[80px]\\" placeholder=\\"Ej: Turno m茅dico, enfermedad...\\" value={rrhhData.reason} onChange={e => setRrhhData({...rrhhData, reason: e.target.value})}/></div>\\n                                <button onClick={handleRRHHSubmit} disabled={!selectedCell} className=\\"w-full py-3 bg-amber-500 text-white font-black rounded-xl hover:bg-amber-600 disabled:opacity-50\\">CONFIRMAR CARGA</button>\\n                            </div>\\n                        </div>\\n                    </div>\\n                )}\\n\\n                {/* MODAL VACANCY SOLVER (NUEVO) */}\\n                {showVacancyModal && vacancyData && (\\n                    <div className=\\"fixed inset-0 z-[200] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in\\">\\n                        <div className=\\"bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl relative flex flex-col max-h-[90vh]\\">\\n                            <button onClick={() => {setShowVacancyModal(false); setVacancyData(null);}} className=\\"absolute top-4 right-4 text-slate-400 hover:text-slate-600\\"><X size={20}/></button>\\n                            \\n                            <div className=\\"flex items-center gap-3 border-b pb-4 mb-4\\">\\n                                <div className=\\"p-3 bg-teal-100 text-teal-600 rounded-xl\\"><CalendarCheck size={24}/></div>\\n                                <div>\\n                                    <h3 className=\\"font-black text-lg text-slate-800\\">Gesti贸n de Vacaciones</h3>\\n                                    <p className=\\"text-xs text-slate-500\\">Cubrir vacantes generadas por licencia</p>\\n                                </div>\\n                            </div>\\n\\n                            <div className=\\"bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6\\">\\n                                <div className=\\"grid grid-cols-2 gap-4 text-center\\">\\n                                    <div><p className=\\"text-[10px] font-black uppercase text-slate-400\\">Empleado</p><p className=\\"font-bold text-slate-800\\">{vacancyData.employeeName}</p></div>\\n                                    <div><p className=\\"text-[10px] font-black uppercase text-slate-400\\">Periodo</p><p className=\\"font-bold text-teal-600\\">{vacancyData.startDate} <br/> al {vacancyData.endDate}</p></div>\\n                                </div>\\n                            </div>\\n\\n                            <div className=\\"space-y-4\\">\\n                                <label className=\\"text-xs font-black uppercase text-slate-500 block\\">Seleccionar Suplente para el Periodo:</label>\\n                                <select className=\\"w-full p-3 bg-white border-2 border-slate-200 rounded-xl text-sm font-bold focus:border-teal-500 outline-none\\" value={selectedReplacement} onChange={(e) => setSelectedReplacement(e.target.value)}>\\n                                    <option value=\\"\\">-- Seleccionar Guardia --</option>\\n                                    {employees.filter(e => e.id !== vacancyData.employeeId).map(e => (\\n                                        <option key={e.id} value={e.id}>{e.name}</option>\\n                                    ))}\\n                                </select>\\n                                \\n                                <button onClick={handleProcessVacancy} disabled={!selectedReplacement} className=\\"w-full py-4 bg-teal-600 text-white rounded-xl font-black text-sm hover:bg-teal-700 shadow-lg shadow-teal-100 disabled:opacity-50 flex items-center justify-center gap-2\\">\\n                                    <CheckCircle size={18}/> APLICAR COBERTURA\\n                                </button>\\n                            </div>\\n\\n                        </div>\\n                    </div>\\n                )}\\n\\n                {/* SWAP WIZARD */}\\n                {showSwapModal && (\\n                    <div className=\\"fixed inset-0 z-[200] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in\\">\\n                        <div className=\\"bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl relative flex flex-col max-h-[90vh]\\">\\n                            <button onClick={() => {setShowSwapModal(false); setSwapConfig(null); setCoverageStep(false);}} className=\\"absolute top-4 right-4 p-2 bg-slate-100 hover:bg-slate-200 rounded-full z-10\\"><X size={16}/></button>\\n                            <div className=\\"flex items-center gap-3 border-b pb-4 mb-4 shrink-0\\"><div className=\\"p-3 bg-cyan-100 text-cyan-600 rounded-xl\\"><ArrowLeftRight size={24}/></div><div><h3 className=\\"font-black text-lg text-slate-800\\">Asistente de Intercambio</h3><p className=\\"text-xs text-slate-500\\">Gesti贸n de Franco Compensatorio (FF)</p></div></div>\\n                            {!coverageStep ? (\\n                                <div className=\\"space-y-4 flex-1 overflow-y-auto custom-scrollbar p-1\\">\\n                                    <div><label className=\\"text-[10px] font-black uppercase text-slate-400 mb-1 block\\">1. 驴Con qui茅n cambia?</label><div className=\\"relative\\"><SearchIcon size={14} className=\\"absolute left-3 top-3.5 text-slate-400\\"/><input autoFocus type=\\"text\\" placeholder=\\"Buscar compa帽ero...\\" className=\\"w-full pl-9 pr-4 py-3 bg-slate-50 border rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-cyan-500 transition-all\\" value={swapSearchTerm} onChange={e => setSwapSearchTerm(e.target.value)}/></div><div className=\\"mt-2 max-h-40 overflow-y-auto custom-scrollbar border rounded-xl bg-white shadow-sm\\">{swapCandidates.length > 0 ? swapCandidates.map(e => (<div key={e.id} onClick={() => setSelectedSwapTarget(e.id)} className={`p-3 flex justify-between items-center cursor-pointer border-b last:border-0 hover:bg-cyan-50 transition-colors ${selectedSwapTarget === e.id ? \'bg-cyan-50 border-cyan-200\' : \'\'}`}><span className={`text-xs font-bold ${selectedSwapTarget === e.id ? \'text-cyan-700\' : \'text-slate-600\'}`}>{e.name}</span>{selectedSwapTarget === e.id && <CheckCircle size={14} className=\\"text-cyan-600\\"/>}</div>)) : <div className=\\"p-4 text-center text-xs text-slate-400 italic\\">No se encontraron empleados.</div>}</div></div>\\n                                    {selectedSwapTarget && (\\n                                        <div className=\\"animate-in slide-in-from-top-2 pt-2 border-t\\">\\n                                            <label className=\\"text-[10px] font-black uppercase text-slate-400 mb-2 block\\">2. Seleccione el Franco del compa帽ero:</label>\\n                                            <div className=\\"grid grid-cols-3 gap-2 max-h-32 overflow-y-auto\\">\\n                                                {targetFrancos.length > 0 ? targetFrancos.map((f: any) => (\\n                                                    <button key={f.dateStr} onClick={() => handleSelectDate(f.dateStr)} className=\\"p-2 bg-emerald-50 border border-emerald-100 text-emerald-700 rounded-lg text-xs font-black hover:bg-emerald-100 flex flex-col items-center\\"><span>{f.label}</span></button>\\n                                                )) : <div className=\\"col-span-3 p-3 bg-slate-50 text-slate-400 text-xs italic rounded-xl flex items-center justify-center gap-2\\"><CalendarSearch size={14}/> Sin francos disponibles.</div>}\\n                                            </div>\\n                                        </div>\\n                                    )}\\n                                </div>\\n                            ) : (\\n                                <div className=\\"space-y-6 flex-1 animate-in slide-in-from-right-4\\">\\n                                    <div className=\\"bg-slate-50 p-4 rounded-xl border border-slate-200\\">\\n                                        <p className=\\"text-[10px] font-black uppercase text-slate-400 mb-2\\">D铆a 1 ({selectedCell.dateStr})</p>\\n                                        <div className=\\"text-xs font-bold text-slate-700 mb-3\\"><span className=\\"text-cyan-600\\">{employees.find(e=>e.id===selectedCell.empId)?.name}</span> cubre a <span className=\\"text-emerald-600\\">{employees.find(e=>e.id===selectedSwapTarget)?.name}</span></div>\\n                                        {isShift1Fixed ? (<div className=\\"p-3 bg-white border border-cyan-200 rounded-lg text-center shadow-sm\\"><p className=\\"text-[10px] text-cyan-600 font-bold mb-1\\">TURNO DETECTADO</p><p className=\\"text-2xl font-black text-slate-800\\">{coverShift1}</p></div>) : (<div className=\\"flex gap-2 justify-center\\">{[\'M\',\'T\',\'N\'].map(c => (<button key={c} onClick={() => setCoverShift1(c)} className={`w-10 h-10 rounded-lg font-black ${coverShift1 === c ? \'bg-cyan-600 text-white ring-2 ring-cyan-300\' : \'bg-white border text-slate-500\'}`}>{c}</button>))}</div>)}\\n                                    </div>\\n                                    <div className=\\"bg-slate-50 p-4 rounded-xl border border-slate-200\\">\\n                                        <p className=\\"text-[10px] font-black uppercase text-slate-400 mb-2\\">D铆a 2 ({selectedSwapDate})</p>\\n                                        <div className=\\"text-xs font-bold text-slate-700 mb-3\\"><span className=\\"text-emerald-600\\">{employees.find(e=>e.id===selectedSwapTarget)?.name}</span> cubre a <span className=\\"text-cyan-600\\">{employees.find(e=>e.id===selectedCell.empId)?.name}</span></div>\\n                                        {isShift2Fixed ? (<div className=\\"p-3 bg-white border border-cyan-200 rounded-lg text-center shadow-sm\\"><p className=\\"text-[10px] text-cyan-600 font-bold mb-1\\">TURNO DETECTADO</p><p className=\\"text-2xl font-black text-slate-800\\">{coverShift2}</p></div>) : (<div className=\\"flex gap-2 justify-center\\">{[\'M\',\'T\',\'N\'].map(c => (<button key={c} onClick={() => setCoverShift2(c)} className={`w-10 h-10 rounded-lg font-black ${coverShift2 === c ? \'bg-cyan-600 text-white ring-2 ring-cyan-300\' : \'bg-white border text-slate-500\'}`}>{c}</button>))}</div>)}\\n                                    </div>\\n                                    <button onClick={executeSwap} className=\\"w-full py-4 bg-emerald-600 text-white rounded-xl font-black text-sm hover:bg-emerald-700 shadow-lg shadow-emerald-200 flex items-center justify-center gap-2\\"><CheckCircle size={18}/> CONFIRMAR ENROQUE</button>\\n                                    <button onClick={() => setCoverageStep(false)} className=\\"w-full py-2 text-slate-400 text-xs font-bold hover:text-slate-600\\">Volver atr谩s</button>\\n                                </div>\\n                            )}\\n                        </div>\\n                    </div>\\n                )}\\n\\n                {showHistoryModal && (\\n                    <div className=\\"fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in\\">\\n                        <div className=\\"bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl relative\\">\\n                            <button onClick={() => setShowHistoryModal(false)} className=\\"absolute top-4 right-4 text-slate-400 hover:text-slate-600\\"><X size={20}/></button>\\n                            <h3 className=\\"font-black text-lg text-slate-800 mb-4 flex items-center gap-2\\"><History className=\\"text-indigo-600\\"/> Historial de Cambios</h3>\\n                            <div className=\\"max-h-[60vh] overflow-y-auto custom-scrollbar space-y-3\\">\\n                                {historyVersions.length > 0 ? historyVersions.map((v) => (\\n                                    <div key={v.id} onClick={() => handleViewSnapshot(v)} className=\\"p-4 border rounded-xl hover:bg-indigo-50 cursor-pointer group transition-all\\">\\n                                            <div className=\\"flex justify-between items-center mb-2\\"><span className=\\"font-bold text-indigo-700 text-xs bg-indigo-100 px-2 py-1 rounded\\">{new Date(v.timestamp.seconds*1000).toLocaleString()}</span><span className=\\"text-[10px] text-slate-400\\">Por: {v.user}</span></div>\\n                                            <p className=\\"text-xs text-slate-600\\">Se guardaron <strong>{v.count}</strong> cambios.</p>\\n                                            <div className=\\"text-[10px] text-indigo-500 font-bold mt-2 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1\\"><Split size={12}/> Comparar con Actual</div>\\n                                    </div>\\n                                )) : (\\n                                    <div className=\\"text-center py-8 text-slate-400 text-xs italic\\">No hay historial disponible para este mes.</div>\\n                                )}\\n                            </div>\\n                        </div>\\n                    </div>\\n                )}\\n\\n                {showAddModal && (\\n                    <div className=\\"fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in\\">\\n                        <div className=\\"bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl relative\\">\\n                            <button onClick={() => setShowAddModal(false)} className=\\"absolute top-4 right-4 text-slate-400 hover:text-slate-600\\"><X size={20}/></button>\\n                            <h3 className=\\"font-black text-lg text-slate-800 mb-1 flex items-center gap-2\\"><UserPlus className=\\"text-emerald-600\\"/> Asignar Empleado</h3>\\n                            <p className=\\"text-xs text-slate-500 mb-4\\">Busque un empleado para traerlo a la vista actual.</p>\\n                            <div className=\\"relative mb-4\\"><Search className=\\"absolute left-3 top-3 text-slate-400\\" size={16}/><input autoFocus type=\\"text\\" placeholder=\\"Buscar por nombre o legajo...\\" className=\\"w-full pl-10 pr-4 py-3 bg-slate-50 border rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-emerald-500\\" value={addSearchTerm} onChange={(e) => setAddSearchTerm(e.target.value)}/></div>\\n                            <div className=\\"max-h-[50vh] overflow-y-auto custom-scrollbar space-y-2\\">\\n                                {employees.filter(e => e.name.toLowerCase().includes(addSearchTerm.toLowerCase())).slice(0, 10).map(emp => (\\n                                    <div key={emp.id} onClick={() => { const d = daysInMonth[0]; const key = `${emp.id}_${getDateKey(d)}`; const newChanges = { ...pendingChanges }; if (!newChanges[key]) { newChanges[key] = { code: \'M\', isTemp: true, hours: 8 }; setPendingChanges(newChanges); toast.success(`${emp.name} agregado a la vista.`); setShowAddModal(false); } else { toast.info(\\"Este empleado ya tiene cambios pendientes.\\"); } }} className=\\"p-3 border rounded-xl hover:bg-emerald-50 cursor-pointer flex justify-between items-center group transition-all\\">\\n                                        <div><p className=\\"font-bold text-slate-700 text-sm\\">{emp.name}</p><p className=\\"text-[10px] text-slate-400\\">{emp.laborAgreement || \'Sin Convenio\'}</p></div><Plus size={18} className=\\"text-emerald-500 opacity-0 group-hover:opacity-100 transition-opacity\\"/>\\n                                    </div>\\n                                ))}\\n                                {addSearchTerm && employees.filter(e => e.name.toLowerCase().includes(addSearchTerm.toLowerCase())).length === 0 && (<div className=\\"text-center py-4 text-slate-400 text-xs\\">No se encontraron empleados.</div>)}\\n                            </div>\\n                        </div>\\n                    </div>\\n                )}\\n\\n                <div className=\\"bg-white p-2 rounded-xl border shadow-sm shrink-0 h-32 overflow-hidden flex flex-col no-print\\">\\n                    <h4 className=\\"text-[10px] font-black uppercase text-slate-400 mb-2 px-2 border-b pb-1 flex items-center gap-2\\"><Clock size={12}/> Actividad Reciente</h4>\\n                    <div className=\\"overflow-y-auto custom-scrollbar space-y-1 px-2 pb-2\\">\\n                        {unifiedLogs.map(log => {\\n                            const realName = usersMap[log.actor] || usersMap[log.actorUid] || log.actor || \'Sistema\';\\n                            return (\\n                                <div key={log.id} className=\\"flex items-center gap-2 text-[10px] p-1 border-b last:border-0 hover:bg-slate-50\\">\\n                                    <span className=\\"font-mono text-slate-400\\">{new Date(log.timestamp).toLocaleTimeString([], {hour:\'2-digit\', minute:\'2-digit\'})}</span>\\n                                    <span className=\\"font-bold px-1.5 rounded uppercase bg-slate-100 text-slate-600\\">{log.label}</span>\\n                                    <span className=\\"text-slate-600 truncate flex-1\\">{log.detail}</span>\\n                                    <span className=\\"text-[9px] text-slate-400 font-bold\\">{realName}</span>\\n                                </div>\\n                            );\\n                        })}\\n                    </div>\\n                </div>\\n\\n            </div>\\n        </DashboardLayout>\\n    );\\n}"},{"id":"tj35suzjf","name":"index_backup_v1.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\planificacion\\\\index_backup_v1.tsx","area":"FRONTEND","content":"import React, { useState, useEffect, useMemo } from \'react\';\\nimport Head from \'next/head\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { \\n    ChevronLeft, ChevronRight, Search, Plus, \\n    Users, Clock, X, UserPlus, ArrowRight, Eye, EyeOff, \\n    CheckCircle, Trash2, ShieldAlert, User, Briefcase, Layers,\\n    Bell, CalendarX, Loader2, Stethoscope, MapPin, Lock, ShieldCheck, UserMinus\\n} from \'lucide-react\';\\nimport { db } from \'@/lib/firebase\';\\nimport { getAuth, onAuthStateChanged } from \'firebase/auth\'; \\nimport { collection, onSnapshot, addDoc, deleteDoc, doc, query, orderBy, limit, serverTimestamp, Timestamp, where, getDocs, updateDoc } from \'firebase/firestore\';\\nimport { Toaster, toast } from \'sonner\';\\n\\n// --- CONFIGURACIN VISUAL ---\\nconst SHIFT_STYLES: any = {\\n    // Turnos Operativos\\n    \'M\': \'bg-blue-100 text-blue-700 border-blue-200\',\\n    \'T\': \'bg-orange-100 text-orange-700 border-orange-200\',\\n    \'N\': \'bg-indigo-100 text-indigo-700 border-indigo-200\',\\n    \'D12\': \'bg-cyan-100 text-cyan-700 border-cyan-200\',\\n    \'N12\': \'bg-purple-100 text-purple-700 border-purple-200\',\\n    \'F\': \'bg-emerald-100 text-emerald-700 border-emerald-200\',\\n    \'PU\': \'bg-pink-100 text-pink-700 border-pink-200\',\\n    \\n    // Novedades / Ausencias\\n    \'A\': \'bg-red-100 text-red-700 border-red-300 font-black pattern-diagonal\',       \\n    \'V\': \'bg-teal-100 text-teal-700 border-teal-300 font-black\',     \\n    \'L\': \'bg-purple-100 text-purple-700 border-purple-300 font-black\', \\n    \'E\': \'bg-rose-100 text-rose-700 border-rose-300 font-black\',     \\n    \'Ausencia con Aviso\': \'bg-amber-100 text-amber-700 border-amber-300\',\\n};\\n\\nconst DEFAULT_LIMITS = { weekly: 48, monthly: 200 };\\n\\nconst SHIFT_HOURS_LOOKUP: Record<string, number> = {\\n    \'M\': 8, \'T\': 8, \'N\': 8, \\n    \'D12\': 12, \'N12\': 12, \\n    \'PU\': 12, \'F\': 0,\\n    \'V\': 0, \'L\': 0, \'A\': 0, \'E\': 0 \\n};\\n\\nconst getAbsenceCode = (type: string) => {\\n    if (!type) return \'A\';\\n    const t = type.toLowerCase();\\n    if (t.includes(\'vacaci\')) return \'V\';\\n    if (t.includes(\'licencia\')) return \'L\';\\n    if (t.includes(\'enfermedad\') || t.includes(\'medico\')) return \'E\';\\n    if (t.includes(\'ausencia\') || t.includes(\'falta\') || t.includes(\'aviso\')) return \'A\';\\n    return type.substring(0, 1).toUpperCase(); \\n};\\n\\nconst getDateKey = (date: Date) => {\\n    const y = date.getFullYear();\\n    const m = String(date.getMonth() + 1).padStart(2, \'0\');\\n    const d = String(date.getDate()).padStart(2, \'0\');\\n    return `${y}-${m}-${d}`;\\n};\\n\\nconst getDefaultStyle = (code: string) => SHIFT_STYLES[code] || \'bg-slate-100 text-slate-700 border-slate-300\';\\n\\nconst ACTION_LABELS: Record<string, string> = {\\n    \'MANUAL_CHECKIN\': \'Presente Manual\',\\n    \'ASIGNACION_TURNO\': \'Asignaci贸n\',\\n    \'ASIGNACION\': \'Asignaci贸n\',\\n    \'ELIMINACION_TURNO\': \'Eliminaci贸n\',\\n    \'ELIMINACION\': \'Eliminaci贸n\',\\n    \'AUTORIZACION_EXCEPCION\': \'Excepci贸n Autorizada\',\\n    \'DESVINCULACION_OBJETIVO\': \'Desvinculaci贸n Objetivo\'\\n};\\n\\nexport default function PlanificacionPage() {\\n    // --- ESTADOS ---\\n    const [currentDate, setCurrentDate] = useState(new Date());\\n    const [selectedClient, setSelectedClient] = useState(\'\');\\n    const [selectedObjective, setSelectedObjective] = useState(\'\');\\n    const [forceShowAll, setForceShowAll] = useState(false);\\n    const [isProcessing, setIsProcessing] = useState(false);\\n    \\n    // Datos Principales\\n    const [employees, setEmployees] = useState<any[]>([]);\\n    const [shiftsMap, setShiftsMap] = useState<Record<string, any>>({});\\n    const [absencesMap, setAbsencesMap] = useState<Record<string, any>>({});\\n    const [clients, setClients] = useState<any[]>([]);\\n    const [agreements, setAgreements] = useState<any[]>([]);\\n    const [unifiedLogs, setUnifiedLogs] = useState<any[]>([]);\\n    \\n    // Notificaciones\\n    const [notifications, setNotifications] = useState<any[]>([]);\\n    const [showNotifications, setShowNotifications] = useState(false);\\n    const [hasUnread, setHasUnread] = useState(false);\\n    const [highlightKey, setHighlightKey] = useState<string | null>(null);\\n\\n    // Identidad\\n    const [operatorName, setOperatorName] = useState(\'Cargando...\');\\n    const [usersMap, setUsersMap] = useState<Record<string, string>>({}); \\n\\n    // SLA Din谩mico\\n    const [positionStructure, setPositionStructure] = useState<any[]>([]);\\n\\n    // UI & Modales\\n    const [showAddModal, setShowAddModal] = useState(false);\\n    const [searchTerm, setSearchTerm] = useState(\'\');\\n    const [addSearchTerm, setAddSearchTerm] = useState(\'\');\\n    const [selectedCell, setSelectedCell] = useState<any>(null);\\n\\n    // Modal Autorizaci贸n\\n    const [pendingAssignment, setPendingAssignment] = useState<any>(null); \\n    const [authWarningMessage, setAuthWarningMessage] = useState(\'\');\\n\\n    // --- CARGA INICIAL ---\\n    useEffect(() => {\\n        const loadUsers = async () => {\\n            try {\\n                const snap = await getDocs(collection(db, \'system_users\'));\\n                const map: Record<string, string> = {};\\n                snap.docs.forEach(d => {\\n                    const u = d.data();\\n                    if (u.email) map[u.email] = u.name || (u.firstName ? `${u.firstName} ${u.lastName || \'\'}` : u.email);\\n                });\\n                setUsersMap(map);\\n            } catch (e) { console.error(e); }\\n        };\\n        loadUsers();\\n        \\n        const auth = getAuth();\\n        const unsubscribe = onAuthStateChanged(auth, (user) => {\\n            if (user) {\\n                setOperatorName(user.displayName || user.email || \\"Usuario Desconocido\\");\\n            } else {\\n                setOperatorName(\\"No Logueado\\");\\n            }\\n        });\\n        return () => unsubscribe();\\n    }, []);\\n\\n    // --- SNAPSHOTS ---\\n    useEffect(() => {\\n        const unsubC = onSnapshot(collection(db, \'clients\'), snap => setClients(snap.docs.map(d => ({id: d.id, ...d.data()}))));\\n        const unsubAgreements = onSnapshot(collection(db, \'convenios\'), snap => setAgreements(snap.docs.map(d => ({ id: d.id, ...d.data() }))));\\n        const unsubE = onSnapshot(collection(db, \'empleados\'), snap => setEmployees(snap.docs.map(d => ({\\n            id: d.id, \\n            name: d.data().name || d.data().firstName + \' \' + d.data().lastName, \\n            preferredObjectiveId: d.data().preferredObjectiveId,\\n            laborAgreement: d.data().laborAgreement\\n        }))));\\n        \\n        const unsubS = onSnapshot(collection(db, \'turnos\'), snap => {\\n            const map: any = {};\\n            snap.docs.forEach(d => {\\n                const data = d.data();\\n                if (data.startTime?.seconds) {\\n                    const date = new Date(data.startTime.seconds * 1000);\\n                    const key = `${data.employeeId}_${getDateKey(date)}`;\\n                    map[key] = { id: d.id, ...data, code: data.code || data.type }; \\n                }\\n            });\\n            setShiftsMap(map);\\n        });\\n\\n        const unsubA = onSnapshot(collection(db, \'ausencias\'), snap => {\\n            const map: any = {};\\n            snap.docs.forEach(d => {\\n                const data = d.data();\\n                if (data.startDate && data.endDate && data.employeeId) {\\n                    const [sY, sM, sD] = data.startDate.split(\'-\').map(Number);\\n                    const [eY, eM, eD] = data.endDate.split(\'-\').map(Number);\\n                    \\n                    let current = new Date(sY, sM - 1, sD);\\n                    const end = new Date(eY, eM - 1, eD);\\n\\n                    while (current <= end) {\\n                        const key = `${data.employeeId}_${getDateKey(current)}`;\\n                        map[key] = { \\n                            id: d.id, \\n                            type: data.type || \'Ausencia\', \\n                            reason: data.reason,\\n                            status: data.status,\\n                            isAbsence: true\\n                        };\\n                        current.setDate(current.getDate() + 1);\\n                    }\\n                }\\n            });\\n            setAbsencesMap(map);\\n        });\\n\\n        return () => { unsubC(); unsubE(); unsubS(); unsubA(); unsubAgreements(); };\\n    }, []);\\n\\n    // --- LOGS ---\\n    useEffect(() => {\\n        const qLogs = query(collection(db, \'audit_logs\'), orderBy(\'timestamp\', \'desc\'), limit(30));\\n        const qAusencias = query(collection(db, \'ausencias\'), limit(20));\\n\\n        const unsubLogs = onSnapshot(qLogs, (snapLogs) => {\\n            const logItems = snapLogs.docs.map(d => ({\\n                id: d.id,\\n                source: \'AUDIT\',\\n                timestamp: d.data().timestamp?.seconds * 1000,\\n                label: ACTION_LABELS[d.data().action] || d.data().action,\\n                detail: d.data().details,\\n                actor: d.data().actorName\\n            }));\\n\\n            getDocs(qAusencias).then(snapAus => {\\n                const ausItems = snapAus.docs.map(d => ({\\n                    id: d.id,\\n                    source: \'AUSENCIA\',\\n                    timestamp: new Date(d.data().createdAt || d.data().startDate).getTime(),\\n                    label: d.data().type || \'Ausencia\',\\n                    detail: `${d.data().employeeName}: ${d.data().reason}`,\\n                    actor: \'RRHH\',\\n                    critical: true\\n                }));\\n                const merged = [...logItems, ...ausItems].sort((a, b) => b.timestamp - a.timestamp).slice(0, 50);\\n                setUnifiedLogs(merged);\\n            });\\n        });\\n        return () => unsubLogs();\\n    }, []);\\n\\n    // --- NOTIFICACIONES ---\\n    useEffect(() => {\\n        const todayStr = new Date().toISOString().split(\'T\')[0];\\n        const qAbsence = query(collection(db, \'ausencias\'), where(\'startDate\', \'>=\', todayStr));\\n        \\n        const unsubNotif = onSnapshot(qAbsence, (snap) => {\\n            const items = snap.docs\\n                .map(d => ({ ...d.data(), id: d.id }))\\n                .filter((d:any) => !d.viewed) \\n                .map((d:any) => ({\\n                    id: d.id,\\n                    title: d.type,\\n                    msg: `${d.employeeName} - ${d.reason}`,\\n                    date: d.startDate,\\n                    employeeId: d.employeeId,\\n                    critical: true\\n                }));\\n            \\n            setNotifications(items);\\n            if (items.length > 0) setHasUnread(true);\\n        });\\n        return () => unsubNotif();\\n    }, []);\\n\\n    // --- SLA ---\\n    useEffect(() => {\\n        if (!selectedClient || !selectedObjective) {\\n            setPositionStructure([]);\\n            return;\\n        }\\n        const fetchSLA = async () => {\\n            try {\\n                const q = query(collection(db, \'servicios_sla\'), where(\'clientId\', \'==\', selectedClient));\\n                const snap = await getDocs(q);\\n                const relevantService = snap.docs.map(d => d.data()).find(d => d.objectiveId === selectedObjective);\\n                const structure: any[] = [];\\n\\n                if (relevantService && relevantService.positions) {\\n                    relevantService.positions.forEach((pos: any) => {\\n                        if (pos.allowedShiftTypes && pos.allowedShiftTypes.length > 0) {\\n                            structure.push({\\n                                positionName: pos.name || \'General\',\\n                                shifts: pos.allowedShiftTypes.map((t: any) => ({\\n                                    code: t.code, name: t.name, startTime: t.startTime, endTime: t.endTime, hours: t.hours\\n                                }))\\n                            });\\n                        }\\n                    });\\n                }\\n                if (structure.length === 0) structure.push({ positionName: \'General\', shifts: [{code:\'M\',name:\'M\',startTime:\'06:00\',hours:8}, {code:\'T\',name:\'T\',startTime:\'14:00\',hours:8}, {code:\'N\',name:\'N\',startTime:\'22:00\',hours:8}] });\\n                setPositionStructure(structure);\\n            } catch (e) { setPositionStructure([]); }\\n        };\\n        fetchSLA();\\n    }, [selectedClient, selectedObjective]);\\n\\n    const daysInMonth = useMemo(() => {\\n        const year = currentDate.getFullYear();\\n        const month = currentDate.getMonth();\\n        const date = new Date(year, month, 1);\\n        const days = [];\\n        while (date.getMonth() === month) {\\n            days.push(new Date(date));\\n            date.setDate(date.getDate() + 1);\\n        }\\n        return days;\\n    }, [currentDate]);\\n\\n    const displayedEmployees = useMemo(() => {\\n        if (!selectedObjective && !forceShowAll) return [];\\n        let list = employees;\\n        if (selectedObjective && !forceShowAll) list = list.filter(e => e.preferredObjectiveId === selectedObjective);\\n        if (searchTerm) list = list.filter(e => e.name.toLowerCase().includes(searchTerm.toLowerCase()));\\n\\n        return list.sort((a, b) => {\\n            const aHasActivity = daysInMonth.some(d => shiftsMap[`${a.id}_${getDateKey(d)}`] || absencesMap[`${a.id}_${getDateKey(d)}`]);\\n            const bHasActivity = daysInMonth.some(d => shiftsMap[`${b.id}_${getDateKey(d)}`] || absencesMap[`${b.id}_${getDateKey(d)}`]);\\n            if (aHasActivity && !bHasActivity) return -1; \\n            if (!aHasActivity && bHasActivity) return 1;  \\n            return a.name.localeCompare(b.name);          \\n        });\\n    }, [employees, selectedObjective, forceShowAll, searchTerm, shiftsMap, absencesMap, daysInMonth]);\\n\\n    const availableToAdd = useMemo(() => employees.filter(e => e.preferredObjectiveId !== selectedObjective && e.name.toLowerCase().includes(addSearchTerm.toLowerCase())), [employees, selectedObjective, addSearchTerm]);\\n\\n    //  VALIDACIN REGLAS\\n    const checkLaborRules = (empId: string, targetDate: Date, newHours: number) => {\\n        const emp = employees.find(e => e.id === empId);\\n        if (!emp) return null;\\n\\n        const rule = agreements.find(a => a.name === emp.laborAgreement) || \\n                     agreements.find(a => a.name === \'General\') || \\n                     { maxHoursWeekly: DEFAULT_LIMITS.weekly, maxHoursMonthly: DEFAULT_LIMITS.monthly };\\n\\n        const limitWeekly = parseInt(rule.maxHoursWeekly) || DEFAULT_LIMITS.weekly;\\n        const limitMonthly = parseInt(rule.maxHoursMonthly) || DEFAULT_LIMITS.monthly;\\n\\n        const dateKey = getDateKey(targetDate);\\n        const existingShift = shiftsMap[`${empId}_${dateKey}`];\\n        if (existingShift && (existingShift.code === \'F\' || existingShift.isFranco)) {\\n            return `ALERTA CRTICA: El empleado ya tiene un FRANCO asignado este d铆a.`;\\n        }\\n\\n        const targetMonthStr = targetDate.toISOString().slice(0, 7);\\n        let monthlyTotal = 0;\\n        Object.values(shiftsMap).forEach((s: any) => {\\n            if (s.employeeId === empId && s.code !== \'F\') {\\n                const sDate = s.startTime?.seconds ? new Date(s.startTime.seconds * 1000) : new Date(s.startTime);\\n                if (sDate.toISOString().startsWith(targetMonthStr)) {\\n                    monthlyTotal += (SHIFT_HOURS_LOOKUP[s.code] || 8);\\n                }\\n            }\\n        });\\n\\n        if ((monthlyTotal + newHours) > limitMonthly) {\\n            return `ALERTA MENSUAL: L铆mite de ${limitMonthly}hs superado. Acumular谩 ${monthlyTotal + newHours}hs.`;\\n        }\\n\\n        let weeklyTotal = 0;\\n        let hasFrancoInWindow = false;\\n        \\n        for (let i = 1; i <= 6; i++) {\\n            const d = new Date(targetDate);\\n            d.setDate(d.getDate() - i);\\n            const key = `${empId}_${getDateKey(d)}`;\\n            const prevShift = shiftsMap[key];\\n            if (prevShift) {\\n                if (prevShift.code === \'F\' || prevShift.isFranco) hasFrancoInWindow = true;\\n                else weeklyTotal += (SHIFT_HOURS_LOOKUP[prevShift.code] || 8);\\n            }\\n        }\\n\\n        const projectedWeekly = weeklyTotal + newHours;\\n        if (!hasFrancoInWindow && projectedWeekly > limitWeekly) {\\n            return `ALERTA SEMANAL: Sin francos en 7 d铆as.\\\\nAcumula ${projectedWeekly}hs (L铆mite: ${limitWeekly}hs).`;\\n        }\\n\\n        return null;\\n    };\\n\\n    // --- ACCIONES ---\\n\\n    const handleAssignShift = async (shiftConfig: any, positionName: string) => {\\n        if (!selectedCell || isProcessing) return;\\n        \\n        const [y, m, d] = selectedCell.dateStr.split(\'-\').map(Number);\\n        const targetDate = new Date(y, m - 1, d);\\n        const hoursToAdd = shiftConfig.hours || SHIFT_HOURS_LOOKUP[shiftConfig.code] || 8;\\n\\n        const assignmentData = { shiftConfig, positionName, targetDate };\\n\\n        if (shiftConfig.code !== \'F\') {\\n            const warning = checkLaborRules(selectedCell.empId, targetDate, hoursToAdd);\\n            if (warning) {\\n                setAuthWarningMessage(warning);\\n                setPendingAssignment(assignmentData);\\n                return; \\n            }\\n        }\\n        await executeAssignment(assignmentData, null);\\n    };\\n\\n    const executeAssignment = async (data: any, overrideReason: string | null) => {\\n        setIsProcessing(true);\\n        const { shiftConfig, positionName, targetDate } = data;\\n        const [startH, startM] = (shiftConfig.startTime || \'06:00\').split(\':\').map(Number);\\n        const start = new Date(targetDate);\\n        start.setHours(startH, startM || 0, 0);\\n        \\n        const end = new Date(start);\\n        if (shiftConfig.code === \'F\') end.setHours(23, 59, 59);\\n        else end.setTime(start.getTime() + ((shiftConfig.hours||8) * 3600000));\\n\\n        const auth = getAuth();\\n        const u = auth.currentUser;\\n        const realUser = u?.displayName || u?.email || \\"Usuario Desconocido\\";\\n\\n        const empName = employees.find(e => e.id === selectedCell.empId)?.name || \'Empleado\';\\n        const clientObj = clients.find(c => c.id === selectedClient);\\n        const clientName = clientObj?.name || \'Cliente\';\\n        const objName = clientObj?.objetivos?.find((o:any) => o.id === selectedObjective || o.name === selectedObjective)?.name || selectedObjective;\\n\\n        try {\\n            if (selectedCell.currentShift?.id) await deleteDoc(doc(db, \'turnos\', selectedCell.currentShift.id));\\n            \\n            await addDoc(collection(db, \'turnos\'), {\\n                employeeId: selectedCell.empId, \\n                clientId: selectedClient, \\n                objectiveId: selectedObjective,\\n                code: shiftConfig.code, \\n                type: shiftConfig.name, \\n                position: positionName,\\n                startTime: Timestamp.fromDate(start), \\n                endTime: Timestamp.fromDate(end), \\n                isFranco: shiftConfig.code === \'F\', \\n                createdAt: serverTimestamp(),\\n                comments: overrideReason ? `Excepci贸n por: ${realUser}` : `Asignado por: ${realUser}`\\n            });\\n            \\n            await addDoc(collection(db, \'audit_logs\'), { \\n                action: overrideReason ? \'AUTORIZACION_EXCEPCION\' : \'ASIGNACION\', \\n                module: \'PLANIFICADOR\', \\n                details: overrideReason \\n                    ? `锔 Autoriz贸 excepci贸n: ${authWarningMessage}. Turno: ${shiftConfig.code} a ${empName}`\\n                    : `Asign贸 ${shiftConfig.code} a ${empName} en ${clientName} - ${objName}`, \\n                timestamp: serverTimestamp(), \\n                actorName: realUser,\\n                actorUid: u?.uid || \'system\'\\n            });\\n            \\n            toast.success(\'Asignado correctamente\'); \\n            setSelectedCell(null);\\n            setPendingAssignment(null); \\n        } catch (e) { toast.error(\'Error al guardar\'); } finally { setIsProcessing(false); }\\n    };\\n\\n    const handleDelete = async () => {\\n        if (!selectedCell?.currentShift || isProcessing) return;\\n        if (!confirm(\'驴Borrar turno?\')) return;\\n        setIsProcessing(true);\\n        \\n        const auth = getAuth();\\n        const u = auth.currentUser;\\n        const realUser = u?.displayName || u?.email || \\"Usuario Desconocido\\";\\n        \\n        const shiftData = selectedCell.currentShift;\\n        const empName = employees.find(e => e.id === selectedCell.empId)?.name || \'Empleado\';\\n\\n        try {\\n            await deleteDoc(doc(db, \'turnos\', selectedCell.currentShift.id));\\n            \\n            await addDoc(collection(db, \'audit_logs\'), { \\n                action: \'ELIMINACION\', \\n                module: \'PLANIFICADOR\', \\n                details: `Borr贸 turno ${shiftData.code} (${shiftData.type}) de ${empName} del d铆a ${selectedCell.dateStr}`, \\n                timestamp: serverTimestamp(), \\n                actorName: realUser,\\n                actorUid: u?.uid || \'system\'\\n            });\\n            \\n            toast.success(\'Borrado\'); setSelectedCell(null);\\n        } catch(e) { toast.error(\'Error\'); } finally { setIsProcessing(false); }\\n    };\\n\\n    const handleAddToRoster = async (emp: any) => {\\n        if (!confirm(`驴Asignar a ${emp.name}?`)) return;\\n        try { await updateDoc(doc(db, \'empleados\', emp.id), { preferredObjectiveId: selectedObjective }); toast.success(\'Agregado\'); setShowAddModal(false); } catch(e) { toast.error(\'Error\'); }\\n    };\\n\\n    //  DESASIGNAR DEL OBJETIVO\\n    const handleRemoveFromRoster = async (empId: string, empName: string) => {\\n        if(!confirm(`驴Quitar a ${empName} de este objetivo?\\\\nEl empleado volver谩 a estar disponible para otros servicios.`)) return;\\n        try {\\n            await updateDoc(doc(db, \'empleados\', empId), { preferredObjectiveId: \'\' });\\n            \\n            // Log auditoria\\n            const auth = getAuth();\\n            const u = auth.currentUser;\\n            const realUser = u?.displayName || u?.email || \\"Usuario Desconocido\\";\\n            await addDoc(collection(db, \'audit_logs\'), { \\n                action: \'DESVINCULACION_OBJETIVO\', \\n                module: \'PLANIFICADOR\', \\n                details: `Desvincul贸 a ${empName} del objetivo ${selectedObjective}`, \\n                timestamp: serverTimestamp(), \\n                actorName: realUser,\\n                actorUid: u?.uid || \'system\'\\n            });\\n\\n            toast.success(\'Desasignado correctamente\');\\n        } catch(e) { toast.error(\'Error al desasignar\'); }\\n    };\\n\\n    const handleNotificationClick = async (notif: any) => {\\n        try {\\n            await updateDoc(doc(db, \'ausencias\', notif.id), { viewed: true });\\n            toast.success(\'Notificaci贸n archivada\');\\n        } catch(e) { console.error(e); }\\n\\n        if (notif.employeeId) {\\n            const emp = employees.find(e => e.id === notif.employeeId);\\n            if(emp) setSearchTerm(emp.name);\\n            setForceShowAll(true);\\n            const [y, m, d] = notif.date.split(\'-\').map(Number);\\n            setCurrentDate(new Date(y, m-1, 1));\\n            const key = `${notif.employeeId}_${notif.date}`;\\n            setHighlightKey(key);\\n            setTimeout(() => setHighlightKey(null), 3000);\\n        }\\n        setShowNotifications(false);\\n    };\\n\\n    return (\\n        <DashboardLayout>\\n            <Head><title>Planificador</title></Head>\\n            <Toaster position=\\"top-center\\" />\\n            <div className=\\"flex flex-col h-[calc(100vh-100px)] p-2 space-y-4 animate-in fade-in\\">\\n                \\n                {/* HEADER */}\\n                <div className=\\"bg-white p-3 rounded-2xl shadow-sm border flex flex-wrap items-center gap-3 shrink-0\\">\\n                    <div className=\\"flex gap-2 bg-slate-50 p-1 rounded-xl border\\">\\n                        {/*  LIMPIEZA DE FILTROS AL CAMBIAR SELECTS */}\\n                        <select value={selectedClient} onChange={e => {setSelectedClient(e.target.value); setSelectedObjective(\'\'); setSearchTerm(\'\'); setForceShowAll(false); }} className=\\"bg-transparent text-xs font-bold w-32 outline-none\\">\\n                            <option value=\\"\\">Cliente...</option>\\n                            {clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}\\n                        </select>\\n                        <select value={selectedObjective} onChange={e => { setSelectedObjective(e.target.value); setSearchTerm(\'\'); setForceShowAll(false); }} className=\\"bg-transparent text-xs font-bold w-32 outline-none\\" disabled={!selectedClient}>\\n                            <option value=\\"\\">Objetivo...</option>\\n                            {clients.find(c => c.id === selectedClient)?.objetivos?.map((o:any) => <option key={o.id||o.name} value={o.id||o.name}>{o.name}</option>)}\\n                        </select>\\n                    </div>\\n                    <div className=\\"flex items-center bg-slate-100 rounded-xl p-1\\">\\n                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className=\\"p-1\\"><ChevronLeft size={16}/></button>\\n                        <span className=\\"px-3 font-black text-xs w-24 text-center capitalize\\">{currentDate.toLocaleDateString(\'es-AR\', {month:\'long\'})}</span>\\n                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className=\\"p-1\\"><ChevronRight size={16}/></button>\\n                    </div>\\n                    <div className=\\"ml-auto flex items-center gap-3\\">\\n                        <div className=\\"relative\\">\\n                            <button onClick={() => {setShowNotifications(!showNotifications); setHasUnread(false)}} className=\\"p-2 bg-white border rounded-full hover:bg-slate-50 text-slate-600 relative\\">\\n                                <Bell size={18}/>\\n                                {hasUnread && <span className=\\"absolute top-0 right-0 w-3 h-3 bg-rose-500 rounded-full border-2 border-white animate-pulse\\"></span>}\\n                            </button>\\n                            {showNotifications && (\\n                                <div className=\\"absolute right-0 top-full mt-2 w-80 bg-white rounded-2xl shadow-2xl border overflow-hidden z-50 animate-in zoom-in-95\\">\\n                                    <div className=\\"p-3 bg-slate-50 border-b flex justify-between items-center\\"><h3 className=\\"font-black text-xs uppercase text-slate-500\\">Alertas</h3><button onClick={() => setShowNotifications(false)}><X size={14}/></button></div>\\n                                    <div className=\\"max-h-60 overflow-y-auto\\">\\n                                        {notifications.length > 0 ? notifications.map((notif, i) => (\\n                                            <div key={i} className=\\"p-3 border-b last:border-0 hover:bg-slate-50 flex gap-3 items-start\\">\\n                                                <div className=\\"p-2 rounded-full bg-amber-100 text-amber-600\\"><CalendarX size={16}/></div>\\n                                                <div className=\\"flex-1\\">\\n                                                    <p className=\\"text-xs font-bold text-slate-800\\">{notif.title}</p>\\n                                                    <p className=\\"text-[10px] text-slate-500 leading-tight\\">{notif.msg}</p>\\n                                                    <p className=\\"text-[9px] font-mono text-slate-400 mt-1\\">{notif.date}</p>\\n                                                    <button onClick={() => handleNotificationClick(notif)} className=\\"mt-2 text-[10px] font-black text-indigo-600 uppercase hover:underline\\">Ver y Archivar</button>\\n                                                </div>\\n                                            </div>\\n                                        )) : <div className=\\"p-6 text-center text-slate-400 text-xs\\">Sin novedades pendientes.</div>}\\n                                    </div>\\n                                </div>\\n                            )}\\n                        </div>\\n                        <div className=\\"hidden md:flex items-center gap-1 bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-lg border border-indigo-100\\"><User size={12}/> <span className=\\"text-[10px] font-black uppercase\\">{operatorName}</span></div>\\n                        \\n                        <button onClick={() => setShowAddModal(true)} disabled={!selectedObjective} className=\\"bg-slate-900 text-white px-3 py-1.5 rounded-lg text-xs font-black uppercase flex items-center gap-2 hover:bg-slate-800 disabled:opacity-50\\"><UserPlus size={14}/> Asignar</button>\\n                        <button onClick={() => setForceShowAll(!forceShowAll)} className={`px-3 py-1.5 rounded-lg text-xs font-black uppercase flex items-center gap-2 border ${forceShowAll ? \'bg-amber-100 text-amber-700 border-amber-200\' : \'bg-white border-slate-200 text-slate-500\'}`}>{forceShowAll ? <Eye size={14}/> : <EyeOff size={14}/>} {forceShowAll ? \'Ver Todos\' : \'Dotaci贸n\'}</button>\\n                    </div>\\n                </div>\\n\\n                {/* GRID CON BUSCADOR MEJORADO */}\\n                {(!selectedObjective && !forceShowAll) ? (\\n                    <div className=\\"flex-1 flex flex-col items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed text-slate-400\\"><ShieldAlert size={48} className=\\"mb-4 opacity-50\\"/><h3 className=\\"text-lg font-black uppercase\\">Seleccione Objetivo</h3></div>\\n                ) : (\\n                    <div className=\\"flex-1 bg-white rounded-2xl border shadow-xl overflow-hidden flex flex-col relative\\">\\n                        {/* BARRA DE BSQUEDA FLOTANTE DENTRO DE LA TABLA */}\\n                        <div className=\\"sticky top-0 z-50 bg-white p-2 border-b flex gap-2\\">\\n                             <div className=\\"relative w-64\\">\\n                                <Search className=\\"absolute left-2 top-2 text-slate-400\\" size={16}/>\\n                                <input \\n                                    className=\\"w-full pl-8 pr-8 py-1.5 bg-slate-100 rounded-lg text-xs font-bold outline-none\\" \\n                                    placeholder=\\"Filtrar empleado...\\" \\n                                    value={searchTerm} \\n                                    onChange={e => setSearchTerm(e.target.value)}\\n                                />\\n                                {searchTerm && (\\n                                    <button onClick={() => setSearchTerm(\'\')} className=\\"absolute right-2 top-2 text-slate-400 hover:text-slate-600\\">\\n                                        <X size={14}/>\\n                                    </button>\\n                                )}\\n                             </div>\\n                        </div>\\n\\n                        <div className=\\"flex-1 overflow-auto custom-scrollbar\\">\\n                            <table className=\\"border-collapse w-full\\">\\n                                <thead className=\\"sticky top-0 z-30 bg-slate-100 shadow-md h-10\\">\\n                                    <tr>\\n                                        <th className=\\"sticky left-0 z-40 bg-slate-100 p-2 text-left min-w-[200px] border-b border-r\\"><span className=\\"text-[10px] font-black uppercase flex items-center gap-2\\"><Users size={12}/> Dotaci贸n ({displayedEmployees.length})</span></th>\\n                                        {daysInMonth.map(day => (\\n                                            <th key={day.toISOString()} className={`min-w-[36px] border-b border-r p-1 text-center ${[0,6].includes(day.getDay()) ? \'bg-slate-200\' : \'\'}`}>\\n                                                <div className=\\"flex flex-col items-center\\"><span className=\\"text-[8px] font-black uppercase text-slate-500\\">{day.toLocaleDateString(\'es-AR\', {weekday:\'narrow\'})}</span><span className=\\"text-[10px] font-bold\\">{day.getDate()}</span></div>\\n                                            </th>\\n                                        ))}\\n                                    </tr>\\n                                </thead>\\n                                <tbody>\\n                                    {displayedEmployees.map(emp => (\\n                                        <tr key={emp.id} className=\\"group hover:bg-slate-50\\">\\n                                            {/*  COLUMNA DE EMPLEADO CON BOTN DE DESVINCULAR */}\\n                                            <td className=\\"sticky left-0 z-20 bg-white p-2 border-r border-b shadow-sm group-hover:bg-slate-50\\">\\n                                                <div className=\\"flex justify-between items-center w-32\\">\\n                                                    <span className=\\"text-[10px] font-bold truncate\\">{emp.name}</span>\\n                                                    {selectedObjective && (\\n                                                        <button \\n                                                            onClick={(e) => { e.stopPropagation(); handleRemoveFromRoster(emp.id, emp.name); }} \\n                                                            className=\\"opacity-0 group-hover:opacity-100 text-slate-300 hover:text-rose-500 transition-opacity p-1\\"\\n                                                            title=\\"Desvincular del objetivo\\"\\n                                                        >\\n                                                            <UserMinus size={12}/>\\n                                                        </button>\\n                                                    )}\\n                                                </div>\\n                                            </td>\\n                                            {daysInMonth.map(day => {\\n                                                const key = `${emp.id}_${getDateKey(day)}`;\\n                                                const shift = shiftsMap[key];\\n                                                const absence = absencesMap[key];\\n                                                const isHighlighted = highlightKey === key;\\n                                                \\n                                                let cellContent = null;\\n                                                let cellClass = \\"hover:bg-slate-100\\";\\n\\n                                                if (absence) {\\n                                                    const code = getAbsenceCode(absence.type);\\n                                                    cellClass = SHIFT_STYLES[code] || SHIFT_STYLES[\'Ausencia con Aviso\'];\\n                                                    cellContent = (\\n                                                        <div className=\\"flex flex-col items-center\\">\\n                                                            <span className=\\"text-[10px] font-black\\">{code}</span>\\n                                                        </div>\\n                                                    );\\n                                                } else if (shift) {\\n                                                    const label = shift.code || shift.type || \'?\';\\n                                                    const style = getDefaultStyle(label);\\n                                                    cellClass = `${style} shadow-sm border`;\\n                                                    cellContent = (\\n                                                        <div className=\\"flex flex-col items-center\\">\\n                                                            <span>{label}</span>\\n                                                            {shift.position && <span className=\\"text-[6px] opacity-70\\">{shift.position.substring(0,2).toUpperCase()}</span>}\\n                                                        </div>\\n                                                    );\\n                                                }\\n\\n                                                return (\\n                                                    <td key={key} onClick={() => setSelectedCell({ empId: emp.id, dateStr: getDateKey(day), currentShift: shift, absence: absence })} className={`border-b border-r p-0.5 cursor-pointer text-center relative ${isHighlighted ? \'bg-indigo-100\' : \'\'}`}>\\n                                                        <div className={`w-full h-8 rounded flex items-center justify-center text-[10px] font-black ${cellClass} ${isHighlighted ? \'ring-4 ring-indigo-500 animate-pulse z-50\' : \'\'}`}>\\n                                                            {cellContent}\\n                                                        </div>\\n                                                    </td>\\n                                                );\\n                                            })}\\n                                        </tr>\\n                                    ))}\\n                                </tbody>\\n                            </table>\\n                        </div>\\n                    </div>\\n                )}\\n\\n                {/* NOVEDADES UNIFICADAS */}\\n                <div className=\\"bg-white p-2 rounded-xl border shadow-sm shrink-0 h-32 overflow-hidden flex flex-col\\">\\n                    <h4 className=\\"text-[10px] font-black uppercase text-slate-400 mb-2 px-2 border-b pb-1 flex items-center gap-2\\"><Clock size={12}/> ltimas Novedades</h4>\\n                    <div className=\\"overflow-y-auto custom-scrollbar space-y-1 px-2 pb-2\\">\\n                        {unifiedLogs.map(log => {\\n                            const isAlert = log.source === \'AUSENCIA\';\\n                            const actorKey = typeof log.actor === \'string\' ? log.actor : \'Sistema\';\\n                            const realActor = usersMap[actorKey] || actorKey || \'Sistema\';\\n                            \\n                            return (\\n                                <div key={log.id} className={`flex items-center gap-2 text-[10px] p-1 border-b last:border-0 hover:bg-slate-50 ${isAlert ? \'bg-amber-50/50\' : \'\'}`}>\\n                                    <span className=\\"font-mono text-slate-400\\">{new Date(log.timestamp).toLocaleTimeString([], {hour:\'2-digit\', minute:\'2-digit\'})}</span>\\n                                    <span className={`font-bold px-1.5 rounded uppercase ${isAlert ? \'bg-amber-100 text-amber-700\' : \'bg-indigo-50 text-indigo-700\'}`}>{log.label}</span>\\n                                    <span className=\\"text-slate-600 truncate flex-1\\">{log.detail}</span>\\n                                    <span className=\\"text-[9px] text-slate-400 flex items-center gap-1 bg-slate-100 px-2 rounded-full border\\"><User size={8}/> {realActor}</span>\\n                                </div>\\n                            );\\n                        })}\\n                    </div>\\n                </div>\\n            </div>\\n\\n            {/* MODAL DE DETALLE / ACCIONES */}\\n            {selectedCell && !pendingAssignment && (\\n                <div className=\\"fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4\\">\\n                    <div className=\\"bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in zoom-in-95 max-h-[80vh] overflow-y-auto\\">\\n                        <div className=\\"flex justify-between items-center mb-4 sticky top-0 bg-white z-10 pb-2 border-b\\">\\n                            <div><h3 className=\\"font-black text-lg uppercase\\">{employees.find(e=>e.id===selectedCell.empId)?.name}</h3><p className=\\"text-xs text-slate-500 font-bold\\">{selectedCell.dateStr}</p></div>\\n                            <button onClick={() => setSelectedCell(null)} className=\\"p-2 bg-slate-100 rounded-full hover:bg-slate-200\\"><X size={16}/></button>\\n                        </div>\\n\\n                        {selectedCell.absence && (\\n                            <div className=\\"p-4 bg-amber-50 border-l-4 border-amber-500 rounded-r-xl mb-4\\">\\n                                <h4 className=\\"font-black text-amber-700 uppercase text-xs flex items-center gap-2\\"><Stethoscope size={14}/> {selectedCell.absence.type}</h4>\\n                                <p className=\\"text-xs text-amber-800 mt-1\\">{selectedCell.absence.reason}</p>\\n                                <p className=\\"text-[10px] text-amber-600 mt-2 font-bold\\">Estado: {selectedCell.absence.status}</p>\\n                            </div>\\n                        )}\\n\\n                        {selectedCell.currentShift ? (\\n                            <div className=\\"space-y-3\\">\\n                                <div className=\\"p-4 bg-indigo-50 border border-indigo-100 rounded-2xl text-center\\">\\n                                    <p className=\\"text-[10px] font-black text-indigo-400 uppercase\\">Turno Actual</p>\\n                                    <p className=\\"text-3xl font-black text-indigo-700 mt-1\\">{selectedCell.currentShift.code}</p>\\n                                    {selectedCell.currentShift.position && <p className=\\"text-xs font-bold text-indigo-500 mt-1\\">{selectedCell.currentShift.position}</p>}\\n                                </div>\\n                                <button onClick={handleDelete} disabled={isProcessing} className=\\"w-full py-4 bg-rose-50 text-rose-600 rounded-xl font-black text-xs uppercase flex items-center justify-center gap-2 hover:bg-rose-100 transition-colors disabled:opacity-50\\">\\n                                    {isProcessing ? <Loader2 className=\\"animate-spin\\" size={16}/> : <><Trash2 size={16}/> Eliminar Turno</>}\\n                                </button>\\n                            </div>\\n                        ) : (\\n                            <div className=\\"space-y-6\\">\\n                                {positionStructure.map((pos, idx) => (\\n                                    <div key={idx} className=\\"space-y-2\\">\\n                                        <div className=\\"flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-1\\"><Layers size={10}/> {pos.positionName}</div>\\n                                        <div className=\\"grid grid-cols-3 gap-2\\">\\n                                            {pos.shifts.map((conf: any) => (\\n                                                <button key={conf.code} onClick={() => handleAssignShift(conf, pos.positionName)} disabled={isProcessing} className={`p-2 rounded-xl border flex flex-col items-center justify-center gap-1 hover:brightness-95 transition-all disabled:opacity-50 ${getDefaultStyle(conf.code)}`}>\\n                                                    <span className=\\"font-black text-sm\\">{conf.code}</span>\\n                                                    <span className=\\"text-[8px] opacity-70\\">{conf.startTime?.substring(0,5)}</span>\\n                                                </button>\\n                                            ))}\\n                                        </div>\\n                                    </div>\\n                                ))}\\n                                <div className=\\"pt-2 border-t\\">\\n                                    <button onClick={() => handleAssignShift({code:\'F\', name:\'Franco\', startTime:\'00:00\'}, \'General\')} disabled={isProcessing} className=\\"w-full p-3 rounded-xl border bg-emerald-50 border-emerald-200 text-emerald-700 font-black text-sm hover:brightness-95 disabled:opacity-50\\">\\n                                        {isProcessing ? \'PROCESANDO...\' : \'ASIGNAR FRANCO\'}\\n                                    </button>\\n                                </div>\\n                            </div>\\n                        )}\\n                    </div>\\n                </div>\\n            )}\\n\\n            {/*  MODAL DE AUTORIZACIN (EXCEPCIN) */}\\n            {pendingAssignment && (\\n                <div className=\\"fixed inset-0 z-[200] bg-rose-900/90 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in\\">\\n                    <div className=\\"bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl text-center border-4 border-rose-500 relative\\">\\n                        <div className=\\"w-20 h-20 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-6 text-rose-600\\">\\n                            <ShieldAlert size={40}/>\\n                        </div>\\n                        \\n                        <h3 className=\\"text-2xl font-black uppercase text-rose-600 mb-2\\">隆Alto! Regla Rota</h3>\\n                        <div className=\\"bg-rose-50 p-4 rounded-xl text-left border border-rose-100 mb-6\\">\\n                            <p className=\\"text-xs font-bold text-rose-800 whitespace-pre-wrap\\">{authWarningMessage}</p>\\n                        </div>\\n\\n                        <div className=\\"mb-6 text-xs text-slate-400 font-bold uppercase\\">\\n                            <p>Autoriza:</p>\\n                            <div className=\\"flex items-center justify-center gap-2 mt-1 bg-slate-100 py-2 rounded-lg\\">\\n                                <ShieldCheck size={14} className=\\"text-emerald-500\\"/> {operatorName}\\n                            </div>\\n                        </div>\\n\\n                        <div className=\\"grid grid-cols-2 gap-3\\">\\n                            <button onClick={() => setPendingAssignment(null)} className=\\"py-4 bg-slate-100 rounded-2xl font-black text-xs uppercase hover:bg-slate-200\\">Cancelar</button>\\n                            <button onClick={() => executeAssignment(pendingAssignment, \\"Forzado por \\" + operatorName)} className=\\"py-4 bg-rose-600 text-white rounded-2xl font-black text-xs uppercase hover:bg-rose-700 shadow-xl shadow-rose-500/30\\">Autorizar Excepci贸n</button>\\n                        </div>\\n                    </div>\\n                </div>\\n            )}\\n\\n            {showAddModal && (\\n                <div className=\\"fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4\\">\\n                    <div className=\\"bg-white w-full max-w-md rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[80vh]\\">\\n                        <div className=\\"p-4 border-b flex justify-between items-center bg-slate-50\\"><h3 className=\\"font-black text-sm uppercase\\">Agregar a Dotaci贸n</h3><button onClick={() => setShowAddModal(false)}><X size={18}/></button></div>\\n                        <div className=\\"p-3 border-b\\"><input autoFocus type=\\"text\\" placeholder=\\"Buscar empleado...\\" className=\\"w-full bg-slate-100 p-2 rounded-lg text-xs font-bold outline-none\\" onChange={e => setAddSearchTerm(e.target.value)} /></div>\\n                        <div className=\\"flex-1 overflow-y-auto p-2 space-y-1\\">\\n                            {availableToAdd.map(emp => (\\n                                <div key={emp.id} className=\\"flex justify-between items-center p-3 hover:bg-indigo-50 rounded-lg group cursor-pointer border border-transparent hover:border-indigo-100\\" onClick={() => handleAddToRoster(emp)}>\\n                                    <span className=\\"text-xs font-bold\\">{emp.name}</span><ArrowRight size={14} className=\\"text-slate-300 group-hover:text-indigo-600\\"/>\\n                                </div>\\n                            ))}\\n                        </div>\\n                    </div>\\n                </div>\\n            )}\\n        </DashboardLayout>\\n    );\\n}"},{"id":"klqb51bk8","name":"index_backup_v3.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\planificacion\\\\index_backup_v3.tsx","area":"FRONTEND","content":"import React, { useState, useEffect, useMemo, useRef } from \'react\';\\nimport Head from \'next/head\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { \\n    ChevronLeft, ChevronRight, Search, Plus, \\n    Users, Clock, X, UserPlus, ArrowRight, Eye, EyeOff, \\n    CheckCircle, Trash2, ShieldAlert, User, Briefcase, Layers,\\n    Bell, CalendarX, Loader2, Stethoscope, MapPin, Lock, ShieldCheck, UserMinus,\\n    Save, Undo, Copy, History\\n} from \'lucide-react\';\\nimport { db } from \'@/lib/firebase\';\\nimport { getAuth, onAuthStateChanged } from \'firebase/auth\'; \\nimport { collection, onSnapshot, addDoc, deleteDoc, doc, query, orderBy, limit, serverTimestamp, Timestamp, where, getDocs, updateDoc, writeBatch } from \'firebase/firestore\';\\nimport { Toaster, toast } from \'sonner\';\\n\\n// --- CONFIGURACIN VISUAL ---\\nconst SHIFT_STYLES: any = {\\n    \'M\': \'bg-blue-100 text-blue-700 border-blue-200\',\\n    \'T\': \'bg-orange-100 text-orange-700 border-orange-200\',\\n    \'N\': \'bg-indigo-100 text-indigo-700 border-indigo-200\',\\n    \'D12\': \'bg-cyan-100 text-cyan-700 border-cyan-200\',\\n    \'N12\': \'bg-purple-100 text-purple-700 border-purple-200\',\\n    \'F\': \'bg-emerald-100 text-emerald-700 border-emerald-200\',\\n    \'PU\': \'bg-pink-100 text-pink-700 border-pink-200\',\\n    \'A\': \'bg-red-100 text-red-700 border-red-300 font-black pattern-diagonal\',       \\n    \'V\': \'bg-teal-100 text-teal-700 border-teal-300 font-black\',     \\n    \'L\': \'bg-purple-100 text-purple-700 border-purple-300 font-black\', \\n    \'E\': \'bg-rose-100 text-rose-700 border-rose-300 font-black\',    \\n    \'Ausencia con Aviso\': \'bg-amber-100 text-amber-700 border-amber-300\',\\n};\\n\\nconst DEFAULT_LIMITS = { weekly: 48, monthly: 200 };\\n\\nconst SHIFT_HOURS_LOOKUP: Record<string, number> = {\\n    \'M\': 8, \'T\': 8, \'N\': 8, \\n    \'D12\': 12, \'N12\': 12, \\n    \'PU\': 12, \'F\': 0,\\n    \'V\': 0, \'L\': 0, \'A\': 0, \'E\': 0 \\n};\\n\\nconst getAbsenceCode = (type: string) => {\\n    if (!type) return \'A\';\\n    const t = type.toLowerCase();\\n    if (t.includes(\'vacaci\')) return \'V\';\\n    if (t.includes(\'licencia\')) return \'L\';\\n    if (t.includes(\'enfermedad\') || t.includes(\'medico\')) return \'E\';\\n    if (t.includes(\'ausencia\') || t.includes(\'falta\') || t.includes(\'aviso\')) return \'A\';\\n    return type.substring(0, 1).toUpperCase(); \\n};\\n\\nconst getDateKey = (date: Date) => {\\n    const y = date.getFullYear();\\n    const m = String(date.getMonth() + 1).padStart(2, \'0\');\\n    const d = String(date.getDate()).padStart(2, \'0\');\\n    return `${y}-${m}-${d}`;\\n};\\n\\nconst getDefaultStyle = (code: string) => SHIFT_STYLES[code] || \'bg-slate-100 text-slate-700 border-slate-300\';\\n\\nconst ACTION_LABELS: Record<string, string> = {\\n    \'MANUAL_CHECKIN\': \'Presente Manual\',\\n    \'ASIGNACION_TURNO\': \'Asignaci贸n\',\\n    \'ASIGNACION\': \'Asignaci贸n\',\\n    \'ELIMINACION_TURNO\': \'Eliminaci贸n\',\\n    \'ELIMINACION\': \'Eliminaci贸n\',\\n    \'AUTORIZACION_EXCEPCION\': \'Excepci贸n Autorizada\',\\n    \'DESVINCULACION_OBJETIVO\': \'Desvinculaci贸n Objetivo\'\\n};\\n\\nexport default function PlanificacionPage() {\\n    // --- ESTADOS ---\\n    const [currentDate, setCurrentDate] = useState(new Date());\\n    const [selectedClient, setSelectedClient] = useState(\'\');\\n    const [selectedObjective, setSelectedObjective] = useState(\'\');\\n    const [forceShowAll, setForceShowAll] = useState(false);\\n    const [isProcessing, setIsProcessing] = useState(false);\\n    \\n    // Datos Principales\\n    const [employees, setEmployees] = useState<any[]>([]);\\n    const [shiftsMap, setShiftsMap] = useState<Record<string, any>>({});\\n    const [absencesMap, setAbsencesMap] = useState<Record<string, any>>({});\\n    const [clients, setClients] = useState<any[]>([]);\\n    const [agreements, setAgreements] = useState<any[]>([]);\\n    const [unifiedLogs, setUnifiedLogs] = useState<any[]>([]);\\n    \\n    // Notificaciones\\n    const [notifications, setNotifications] = useState<any[]>([]);\\n    const [showNotifications, setShowNotifications] = useState(false);\\n    const [hasUnread, setHasUnread] = useState(false);\\n    const [highlightKey, setHighlightKey] = useState<string | null>(null);\\n\\n    // Identidad\\n    const [operatorName, setOperatorName] = useState(\'Cargando...\');\\n    const [usersMap, setUsersMap] = useState<Record<string, string>>({}); \\n\\n    // SLA Din谩mico\\n    const [positionStructure, setPositionStructure] = useState<any[]>([]);\\n\\n    // UI & Modales\\n    const [showAddModal, setShowAddModal] = useState(false);\\n    const [searchTerm, setSearchTerm] = useState(\'\');\\n    const [addSearchTerm, setAddSearchTerm] = useState(\'\');\\n    const [selectedCell, setSelectedCell] = useState<any>(null);\\n\\n    // Modal Autorizaci贸n\\n    const [pendingAssignment, setPendingAssignment] = useState<any>(null); \\n    const [authWarningMessage, setAuthWarningMessage] = useState(\'\');\\n\\n    // --- NUEVO: ESTADO TRANSACCIONAL (MODO EXCEL) ---\\n    const [pendingChanges, setPendingChanges] = useState<Record<string, any>>({}); // Cambios locales sin guardar\\n    const [selection, setSelection] = useState<{start: string | null, end: string | null}>({ start: null, end: null });\\n    const [isDragging, setIsDragging] = useState(false);\\n    \\n    // --- CARGA INICIAL ---\\n    useEffect(() => {\\n        const loadUsers = async () => {\\n            try {\\n                const snap = await getDocs(collection(db, \'system_users\'));\\n                const map: Record<string, string> = {};\\n                snap.docs.forEach(d => {\\n                    const u = d.data();\\n                    if (u.email) map[u.email] = u.name || (u.firstName ? `${u.firstName} ${u.lastName || \'\'}` : u.email);\\n                });\\n                setUsersMap(map);\\n            } catch (e) { console.error(e); }\\n        };\\n        loadUsers();\\n        \\n        const auth = getAuth();\\n        const unsubscribe = onAuthStateChanged(auth, (user) => {\\n            if (user) {\\n                setOperatorName(user.displayName || user.email || \\"Usuario Desconocido\\");\\n            } else {\\n                setOperatorName(\\"No Logueado\\");\\n            }\\n        });\\n        return () => unsubscribe();\\n    }, []);\\n\\n    // --- SNAPSHOTS ---\\n    useEffect(() => {\\n        const unsubC = onSnapshot(collection(db, \'clients\'), snap => setClients(snap.docs.map(d => ({id: d.id, ...d.data()}))));\\n        const unsubAgreements = onSnapshot(collection(db, \'convenios\'), snap => setAgreements(snap.docs.map(d => ({ id: d.id, ...d.data() }))));\\n        const unsubE = onSnapshot(collection(db, \'empleados\'), snap => setEmployees(snap.docs.map(d => ({\\n            id: d.id, \\n            name: d.data().name || d.data().firstName + \' \' + d.data().lastName, \\n            preferredObjectiveId: d.data().preferredObjectiveId,\\n            laborAgreement: d.data().laborAgreement\\n        }))));\\n        \\n        const unsubS = onSnapshot(collection(db, \'turnos\'), snap => {\\n            const map: any = {};\\n            snap.docs.forEach(d => {\\n                const data = d.data();\\n                if (data.startTime?.seconds) {\\n                    const date = new Date(data.startTime.seconds * 1000);\\n                    const key = `${data.employeeId}_${getDateKey(date)}`;\\n                    map[key] = { id: d.id, ...data, code: data.code || data.type }; \\n                }\\n            });\\n            setShiftsMap(map);\\n        });\\n\\n        const unsubA = onSnapshot(collection(db, \'ausencias\'), snap => {\\n            const map: any = {};\\n            snap.docs.forEach(d => {\\n                const data = d.data();\\n                if (data.startDate && data.endDate && data.employeeId) {\\n                    const [sY, sM, sD] = data.startDate.split(\'-\').map(Number);\\n                    const [eY, eM, eD] = data.endDate.split(\'-\').map(Number);\\n                    \\n                    let current = new Date(sY, sM - 1, sD);\\n                    const end = new Date(eY, eM - 1, eD);\\n\\n                    while (current <= end) {\\n                        const key = `${data.employeeId}_${getDateKey(current)}`;\\n                        map[key] = { \\n                            id: d.id, \\n                            type: data.type || \'Ausencia\', \\n                            reason: data.reason,\\n                            status: data.status,\\n                            isAbsence: true\\n                        };\\n                        current.setDate(current.getDate() + 1);\\n                    }\\n                }\\n            });\\n            setAbsencesMap(map);\\n        });\\n\\n        return () => { unsubC(); unsubE(); unsubS(); unsubA(); unsubAgreements(); };\\n    }, []);\\n\\n    // --- LOGS ---\\n    useEffect(() => {\\n        const qLogs = query(collection(db, \'audit_logs\'), orderBy(\'timestamp\', \'desc\'), limit(30));\\n        const qAusencias = query(collection(db, \'ausencias\'), limit(20));\\n\\n        const unsubLogs = onSnapshot(qLogs, (snapLogs) => {\\n            const logItems = snapLogs.docs.map(d => ({\\n                id: d.id,\\n                source: \'AUDIT\',\\n                timestamp: d.data().timestamp?.seconds * 1000,\\n                label: ACTION_LABELS[d.data().action] || d.data().action,\\n                detail: d.data().details,\\n                actor: d.data().actorName\\n            }));\\n\\n            getDocs(qAusencias).then(snapAus => {\\n                const ausItems = snapAus.docs.map(d => ({\\n                    id: d.id,\\n                    source: \'AUSENCIA\',\\n                    timestamp: new Date(d.data().createdAt || d.data().startDate).getTime(),\\n                    label: d.data().type || \'Ausencia\',\\n                    detail: `${d.data().employeeName}: ${d.data().reason}`,\\n                    actor: \'RRHH\',\\n                    critical: true\\n                }));\\n                const merged = [...logItems, ...ausItems].sort((a, b) => b.timestamp - a.timestamp).slice(0, 50);\\n                setUnifiedLogs(merged);\\n            });\\n        });\\n        return () => unsubLogs();\\n    }, []);\\n\\n    // --- NOTIFICACIONES ---\\n    useEffect(() => {\\n        const todayStr = new Date().toISOString().split(\'T\')[0];\\n        const qAbsence = query(collection(db, \'ausencias\'), where(\'startDate\', \'>=\', todayStr));\\n        \\n        const unsubNotif = onSnapshot(qAbsence, (snap) => {\\n            const items = snap.docs\\n                .map(d => ({ ...d.data(), id: d.id }))\\n                .filter((d:any) => !d.viewed) \\n                .map((d:any) => ({\\n                    id: d.id,\\n                    title: d.type,\\n                    msg: `${d.employeeName} - ${d.reason}`,\\n                    date: d.startDate,\\n                    employeeId: d.employeeId,\\n                    critical: true\\n                }));\\n            \\n            setNotifications(items);\\n            if (items.length > 0) setHasUnread(true);\\n        });\\n        return () => unsubNotif();\\n    }, []);\\n\\n    // --- SLA ---\\n    useEffect(() => {\\n        if (!selectedClient || !selectedObjective) {\\n            setPositionStructure([]);\\n            return;\\n        }\\n        const fetchSLA = async () => {\\n            try {\\n                const q = query(collection(db, \'servicios_sla\'), where(\'clientId\', \'==\', selectedClient));\\n                const snap = await getDocs(q);\\n                const relevantService = snap.docs.map(d => d.data()).find(d => d.objectiveId === selectedObjective);\\n                const structure: any[] = [];\\n\\n                if (relevantService && relevantService.positions) {\\n                    relevantService.positions.forEach((pos: any) => {\\n                        if (pos.allowedShiftTypes && pos.allowedShiftTypes.length > 0) {\\n                            structure.push({\\n                                positionName: pos.name || \'General\',\\n                                shifts: pos.allowedShiftTypes.map((t: any) => ({\\n                                    code: t.code, name: t.name, startTime: t.startTime, endTime: t.endTime, hours: t.hours\\n                                }))\\n                            });\\n                        }\\n                    });\\n                }\\n                if (structure.length === 0) structure.push({ positionName: \'General\', shifts: [{code:\'M\',name:\'M\',startTime:\'06:00\',hours:8}, {code:\'T\',name:\'T\',startTime:\'14:00\',hours:8}, {code:\'N\',name:\'N\',startTime:\'22:00\',hours:8}] });\\n                setPositionStructure(structure);\\n            } catch (e) { setPositionStructure([]); }\\n        };\\n        fetchSLA();\\n    }, [selectedClient, selectedObjective]);\\n\\n    const daysInMonth = useMemo(() => {\\n        const year = currentDate.getFullYear();\\n        const month = currentDate.getMonth();\\n        const date = new Date(year, month, 1);\\n        const days = [];\\n        while (date.getMonth() === month) {\\n            days.push(new Date(date));\\n            date.setDate(date.getDate() + 1);\\n        }\\n        return days;\\n    }, [currentDate]);\\n\\n    const displayedEmployees = useMemo(() => {\\n        if (!selectedObjective && !forceShowAll) return [];\\n        let list = employees;\\n        if (selectedObjective && !forceShowAll) list = list.filter(e => e.preferredObjectiveId === selectedObjective);\\n        if (searchTerm) list = list.filter(e => e.name.toLowerCase().includes(searchTerm.toLowerCase()));\\n\\n        return list.sort((a, b) => {\\n            const aHasActivity = daysInMonth.some(d => shiftsMap[`${a.id}_${getDateKey(d)}`] || absencesMap[`${a.id}_${getDateKey(d)}`]);\\n            const bHasActivity = daysInMonth.some(d => shiftsMap[`${b.id}_${getDateKey(d)}`] || absencesMap[`${b.id}_${getDateKey(d)}`]);\\n            if (aHasActivity && !bHasActivity) return -1; \\n            if (!aHasActivity && bHasActivity) return 1;  \\n            return a.name.localeCompare(b.name);          \\n        });\\n    }, [employees, selectedObjective, forceShowAll, searchTerm, shiftsMap, absencesMap, daysInMonth]);\\n\\n    const availableToAdd = useMemo(() => employees.filter(e => e.preferredObjectiveId !== selectedObjective && e.name.toLowerCase().includes(addSearchTerm.toLowerCase())), [employees, selectedObjective, addSearchTerm]);\\n\\n    //  VALIDACIN REGLAS\\n    const checkLaborRules = (empId: string, targetDate: Date, newHours: number) => {\\n        const emp = employees.find(e => e.id === empId);\\n        if (!emp) return null;\\n\\n        const rule = agreements.find(a => a.name === emp.laborAgreement) || \\n                     agreements.find(a => a.name === \'General\') || \\n                     { maxHoursWeekly: DEFAULT_LIMITS.weekly, maxHoursMonthly: DEFAULT_LIMITS.monthly };\\n\\n        const limitWeekly = parseInt(rule.maxHoursWeekly) || DEFAULT_LIMITS.weekly;\\n        const limitMonthly = parseInt(rule.maxHoursMonthly) || DEFAULT_LIMITS.monthly;\\n\\n        const dateKey = getDateKey(targetDate);\\n        const existingShift = shiftsMap[`${empId}_${dateKey}`];\\n        if (existingShift && (existingShift.code === \'F\' || existingShift.isFranco)) {\\n            return `ALERTA CRTICA: El empleado ya tiene un FRANCO asignado este d铆a.`;\\n        }\\n\\n        const targetMonthStr = targetDate.toISOString().slice(0, 7);\\n        let monthlyTotal = 0;\\n        Object.values(shiftsMap).forEach((s: any) => {\\n            if (s.employeeId === empId && s.code !== \'F\') {\\n                const sDate = s.startTime?.seconds ? new Date(s.startTime.seconds * 1000) : new Date(s.startTime);\\n                if (sDate.toISOString().startsWith(targetMonthStr)) {\\n                    monthlyTotal += (SHIFT_HOURS_LOOKUP[s.code] || 8);\\n                }\\n            }\\n        });\\n\\n        if ((monthlyTotal + newHours) > limitMonthly) {\\n            return `ALERTA MENSUAL: L铆mite de ${limitMonthly}hs superado. Acumular谩 ${monthlyTotal + newHours}hs.`;\\n        }\\n\\n        let weeklyTotal = 0;\\n        let hasFrancoInWindow = false;\\n        \\n        for (let i = 1; i <= 6; i++) {\\n            const d = new Date(targetDate);\\n            d.setDate(d.getDate() - i);\\n            const key = `${empId}_${getDateKey(d)}`;\\n            const prevShift = shiftsMap[key];\\n            if (prevShift) {\\n                if (prevShift.code === \'F\' || prevShift.isFranco) hasFrancoInWindow = true;\\n                else weeklyTotal += (SHIFT_HOURS_LOOKUP[prevShift.code] || 8);\\n            }\\n        }\\n\\n        const projectedWeekly = weeklyTotal + newHours;\\n        if (!hasFrancoInWindow && projectedWeekly > limitWeekly) {\\n            return `ALERTA SEMANAL: Sin francos en 7 d铆as.\\\\nAcumula ${projectedWeekly}hs (L铆mite: ${limitWeekly}hs).`;\\n        }\\n\\n        return null;\\n    };\\n\\n    // --- NUEVO: LGICA DE SELECCIN Y MODO EXCEL ---\\n    const handleMouseDown = (key: string) => {\\n        if (!selectedObjective) return;\\n        setIsDragging(true);\\n        setSelection({ start: key, end: key });\\n    };\\n\\n    const handleMouseEnter = (key: string) => {\\n        if (!isDragging) return;\\n        setSelection(prev => ({ ...prev, end: key }));\\n    };\\n\\n    const handleMouseUp = () => {\\n        setIsDragging(false);\\n    };\\n\\n    // Helper para saber si una celda est谩 seleccionada\\n    const isCellSelected = (empId: string, day: Date) => {\\n        if (!selection.start || !selection.end) return false;\\n        \\n        // Descomponer claves: \\"empID_YYYY-MM-DD\\"\\n        const [startEmp, startDate] = selection.start.split(\'_\');\\n        const [endEmp, endDate] = selection.end.split(\'_\');\\n        \\n        const targetEmp = empId;\\n        const targetDate = getDateKey(day);\\n\\n        // L贸gica simple de rango (podr铆a mejorarse con 铆ndices, pero esto funciona para demos)\\n        // Aqu铆 simplificamos asumiendo selecci贸n lineal por ahora o de bloque si ordenamos\\n        // Para simplificar: Solo seleccionamos si coincide el empleado O el d铆a en modo lineal\\n        // Implementaci贸n robusta requerir铆a 铆ndices de la tabla visualizada\\n        return (targetEmp === startEmp && targetEmp === endEmp && targetDate >= (startDate < endDate ? startDate : endDate) && targetDate <= (startDate > endDate ? startDate : endDate)) ||\\n               (selection.start === `${empId}_${getDateKey(day)}`); \\n    };\\n\\n    // --- GESTIN DE CAMBIOS PENDIENTES ---\\n    const applyBulkChange = (shiftConfig: any) => {\\n        if (!selection.start || !selection.end) return;\\n        \\n        // 1. Identificar rango de fechas\\n        const [startEmp, startDateStr] = selection.start.split(\'_\');\\n        const [endEmp, endDateStr] = selection.end.split(\'_\');\\n        \\n        // Solo permitimos selecci贸n horizontal (mismo empleado) por ahora para evitar caos\\n        if (startEmp !== endEmp) {\\n            toast.error(\\"Por seguridad, la edici贸n masiva solo est谩 permitida para un mismo empleado a la vez.\\");\\n            return;\\n        }\\n\\n        const start = new Date(startDateStr);\\n        const end = new Date(endDateStr);\\n        const minDate = start < end ? start : end;\\n        const maxDate = start > end ? start : end;\\n\\n        const newChanges = { ...pendingChanges };\\n        \\n        // Recorrer d铆as\\n        for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) {\\n            const key = `${startEmp}_${getDateKey(d)}`;\\n            \\n            if (shiftConfig === null) {\\n                // Borrar\\n                newChanges[key] = { isDeleted: true };\\n            } else {\\n                // Asignar\\n                newChanges[key] = {\\n                    ...shiftConfig,\\n                    isTemp: true\\n                };\\n            }\\n        }\\n        \\n        setPendingChanges(newChanges);\\n        setSelection({ start: null, end: null }); // Limpiar selecci贸n\\n        toast.info(\\"Cambios en borrador. Recuerda GUARDAR.\\");\\n    };\\n\\n    const handleDiscardChanges = () => {\\n        if(confirm(\\"驴Descartar todos los cambios no guardados?\\")) {\\n            setPendingChanges({});\\n        }\\n    };\\n\\n    const handleCommitChanges = async () => {\\n        if (Object.keys(pendingChanges).length === 0) return;\\n        if (!confirm(`驴Confirmar y guardar ${Object.keys(pendingChanges).length} cambios en la base de datos?`)) return;\\n\\n        setIsProcessing(true);\\n        const batch = writeBatch(db);\\n        const changesLog: any[] = [];\\n\\n        try {\\n            for (const [key, change] of Object.entries(pendingChanges)) {\\n                const [empId, dateStr] = key.split(\'_\');\\n                const existingShift = shiftsMap[key]; // Turno real en BD\\n\\n                // CASO BORRAR\\n                if (change.isDeleted) {\\n                    if (existingShift?.id) {\\n                        batch.delete(doc(db, \'turnos\', existingShift.id));\\n                        changesLog.push({ type: \'DELETE\', empId, date: dateStr });\\n                    }\\n                } \\n                // CASO AGREGAR / EDITAR\\n                else {\\n                    // Si ya existe y es igual, ignorar\\n                    if (existingShift && existingShift.code === change.code) continue;\\n\\n                    // Si existe otro turno ese d铆a, borrarlo primero (reemplazo)\\n                    if (existingShift?.id) {\\n                        batch.delete(doc(db, \'turnos\', existingShift.id));\\n                    }\\n\\n                    // Crear nuevo\\n                    const [y, m, d] = dateStr.split(\'-\').map(Number);\\n                    const targetDate = new Date(y, m - 1, d);\\n                    const [startH, startM] = (change.startTime || \'06:00\').split(\':\').map(Number);\\n                    const start = new Date(targetDate);\\n                    start.setHours(startH, startM || 0, 0);\\n                    \\n                    const end = new Date(start);\\n                    if (change.code === \'F\') end.setHours(23, 59, 59);\\n                    else end.setTime(start.getTime() + ((change.hours||8) * 3600000));\\n\\n                    const ref = doc(collection(db, \'turnos\'));\\n                    batch.set(ref, {\\n                        employeeId: empId,\\n                        clientId: selectedClient,\\n                        objectiveId: selectedObjective,\\n                        code: change.code,\\n                        type: change.name,\\n                        startTime: Timestamp.fromDate(start),\\n                        endTime: Timestamp.fromDate(end),\\n                        isFranco: change.code === \'F\',\\n                        createdAt: serverTimestamp(),\\n                        comments: \'Carga Masiva (Planificador)\'\\n                    });\\n                    changesLog.push({ type: \'CREATE\', empId, date: dateStr, code: change.code });\\n                }\\n            }\\n\\n            // Historial\\n            if (changesLog.length > 0) {\\n                const auth = getAuth();\\n                const user = auth.currentUser?.email || \'Sistema\';\\n                await addDoc(collection(db, \'planificaciones_historial\'), {\\n                    timestamp: serverTimestamp(),\\n                    user,\\n                    period: `${currentDate.getMonth()+1}-${currentDate.getFullYear()}`,\\n                    changeCount: changesLog.length,\\n                    changes: changesLog\\n                });\\n            }\\n\\n            await batch.commit();\\n            setPendingChanges({});\\n            toast.success(\\"Planificaci贸n guardada exitosamente\\");\\n\\n        } catch (e) {\\n            console.error(e);\\n            toast.error(\\"Error al guardar cambios\\");\\n        } finally {\\n            setIsProcessing(false);\\n        }\\n    };\\n\\n    // --- RENDER ---\\n    return (\\n        <DashboardLayout>\\n            <Head><title>Planificador V2</title></Head>\\n            <Toaster position=\\"top-center\\" />\\n            <div className=\\"flex flex-col h-[calc(100vh-100px)] p-2 space-y-4 animate-in fade-in\\" onMouseUp={handleMouseUp}>\\n                \\n                {/* HEADER */}\\n                <div className=\\"bg-white p-3 rounded-2xl shadow-sm border flex flex-wrap items-center gap-3 shrink-0 justify-between\\">\\n                    <div className=\\"flex gap-2\\">\\n                        <select value={selectedClient} onChange={e => {setSelectedClient(e.target.value); setSelectedObjective(\'\'); setSearchTerm(\'\'); setForceShowAll(false); }} className=\\"bg-slate-50 border p-2 rounded-xl text-xs font-bold w-40 outline-none\\">\\n                            <option value=\\"\\">Cliente...</option>\\n                            {clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}\\n                        </select>\\n                        <select value={selectedObjective} onChange={e => { setSelectedObjective(e.target.value); setSearchTerm(\'\'); setForceShowAll(false); }} className=\\"bg-slate-50 border p-2 rounded-xl text-xs font-bold w-40 outline-none\\" disabled={!selectedClient}>\\n                            <option value=\\"\\">Objetivo...</option>\\n                            {clients.find(c => c.id === selectedClient)?.objetivos?.map((o:any) => <option key={o.id||o.name} value={o.id||o.name}>{o.name}</option>)}\\n                        </select>\\n                    </div>\\n\\n                    {/* BARRA DE ACCIONES DE GUARDADO (SOLO SI HAY CAMBIOS) */}\\n                    {Object.keys(pendingChanges).length > 0 && (\\n                        <div className=\\"flex items-center gap-2 animate-in slide-in-from-top-2 bg-amber-50 p-1 rounded-xl border border-amber-200\\">\\n                            <span className=\\"text-[10px] font-black text-amber-700 px-2\\">{Object.keys(pendingChanges).length} cambios sin guardar</span>\\n                            <button onClick={handleDiscardChanges} className=\\"p-2 hover:bg-amber-100 rounded-lg text-amber-600\\"><Undo size={16}/></button>\\n                            <button onClick={handleCommitChanges} className=\\"bg-amber-500 hover:bg-amber-600 text-white px-4 py-1.5 rounded-lg text-xs font-black flex items-center gap-2 shadow-md\\">\\n                                <Save size={14}/> GUARDAR TODO\\n                            </button>\\n                        </div>\\n                    )}\\n\\n                    <div className=\\"flex items-center bg-slate-100 rounded-xl p-1\\">\\n                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className=\\"p-1\\"><ChevronLeft size={16}/></button>\\n                        <span className=\\"px-3 font-black text-xs w-24 text-center capitalize\\">{currentDate.toLocaleDateString(\'es-AR\', {month:\'long\'})}</span>\\n                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className=\\"p-1\\"><ChevronRight size={16}/></button>\\n                    </div>\\n                </div>\\n\\n                {/* BARRA FLOTANTE DE EDICIN MASIVA (CUANDO SELECCIONAS) */}\\n                {selection.start && (\\n                    <div className=\\"absolute top-20 left-1/2 -translate-x-1/2 z-[60] bg-slate-800 text-white p-2 rounded-2xl shadow-2xl flex gap-2 animate-in zoom-in-95 items-center\\">\\n                        <span className=\\"text-[10px] font-bold px-2\\">Asignar a selecci贸n:</span>\\n                        {[\'M\',\'T\',\'N\',\'F\'].map(code => (\\n                            <button key={code} onClick={() => applyBulkChange({ code, name: code === \'F\' ? \'Franco\' : \'Turno\', hours: code===\'F\'?0:8 })} className=\\"w-8 h-8 rounded-lg bg-slate-700 hover:bg-indigo-600 font-black text-xs transition-colors\\">\\n                                {code}\\n                            </button>\\n                        ))}\\n                        <div className=\\"w-px h-6 bg-slate-600 mx-1\\"></div>\\n                        <button onClick={() => applyBulkChange(null)} className=\\"p-2 hover:bg-rose-600 rounded-lg text-rose-300 hover:text-white transition-colors\\"><Trash2 size={16}/></button>\\n                        <button onClick={() => setSelection({start:null, end:null})} className=\\"ml-2\\"><X size={16}/></button>\\n                    </div>\\n                )}\\n\\n                {/* GRID PRINCIPAL */}\\n                {(!selectedObjective && !forceShowAll) ? (\\n                    <div className=\\"flex-1 flex flex-col items-center justify-center bg-slate-50 rounded-3xl border-2 border-dashed text-slate-400\\"><ShieldAlert size={48} className=\\"mb-4 opacity-50\\"/><h3 className=\\"text-lg font-black uppercase\\">Seleccione Objetivo</h3></div>\\n                ) : (\\n                    <div className=\\"flex-1 bg-white rounded-2xl border shadow-xl overflow-hidden flex flex-col relative select-none\\">\\n                        <div className=\\"flex-1 overflow-auto custom-scrollbar\\">\\n                            <table className=\\"border-collapse w-full\\">\\n                                <thead className=\\"sticky top-0 z-30 bg-slate-100 shadow-md h-10\\">\\n                                    <tr>\\n                                        <th className=\\"sticky left-0 z-40 bg-slate-100 p-2 text-left min-w-[200px] border-b border-r\\"><span className=\\"text-[10px] font-black uppercase flex items-center gap-2\\"><Users size={12}/> Dotaci贸n ({displayedEmployees.length})</span></th>\\n                                        {daysInMonth.map(day => (\\n                                            <th key={day.toISOString()} className={`min-w-[36px] border-b border-r p-1 text-center ${[0,6].includes(day.getDay()) ? \'bg-slate-200\' : \'\'}`}>\\n                                                <div className=\\"flex flex-col items-center\\"><span className=\\"text-[8px] font-black uppercase text-slate-500\\">{day.toLocaleDateString(\'es-AR\', {weekday:\'narrow\'})}</span><span className=\\"text-[10px] font-bold\\">{day.getDate()}</span></div>\\n                                            </th>\\n                                        ))}\\n                                    </tr>\\n                                </thead>\\n                                <tbody>\\n                                    {displayedEmployees.map(emp => (\\n                                        <tr key={emp.id} className=\\"group hover:bg-slate-50\\">\\n                                            <td className=\\"sticky left-0 z-20 bg-white p-2 border-r border-b shadow-sm group-hover:bg-slate-50\\">\\n                                                <div className=\\"flex justify-between items-center w-32\\">\\n                                                    <span className=\\"text-[10px] font-bold truncate\\">{emp.name}</span>\\n                                                </div>\\n                                            </td>\\n                                            {daysInMonth.map(day => {\\n                                                const key = `${emp.id}_${getDateKey(day)}`;\\n                                                const serverShift = shiftsMap[key];\\n                                                const pendingChange = pendingChanges[key];\\n                                                const absence = absencesMap[key];\\n                                                \\n                                                // Prioridad visual: 1. Cambio Pendiente 2. Ausencia 3. Turno Real\\n                                                let displayCode = null;\\n                                                let cellClass = \\"\\";\\n                                                \\n                                                // Estado visual de selecci贸n\\n                                                const isSelected = isCellSelected(emp.id, day);\\n\\n                                                if (pendingChange) {\\n                                                    if (pendingChange.isDeleted) {\\n                                                        displayCode = <X size={12}/>;\\n                                                        cellClass = \\"bg-rose-50 text-rose-300\\";\\n                                                    } else {\\n                                                        displayCode = pendingChange.code;\\n                                                        cellClass = \\"bg-amber-100 text-amber-700 border-amber-300 ring-2 ring-inset ring-amber-400\\"; // Amarillo = Borrador\\n                                                    }\\n                                                } else if (absence) {\\n                                                    displayCode = getAbsenceCode(absence.type);\\n                                                    cellClass = SHIFT_STYLES[displayCode] || SHIFT_STYLES[\'Ausencia con Aviso\'];\\n                                                } else if (serverShift) {\\n                                                    displayCode = serverShift.code;\\n                                                    cellClass = getDefaultStyle(displayCode);\\n                                                }\\n\\n                                                return (\\n                                                    <td \\n                                                        key={key} \\n                                                        onMouseDown={() => handleMouseDown(key)}\\n                                                        onMouseEnter={() => handleMouseEnter(key)}\\n                                                        className={`border-b border-r p-0.5 cursor-pointer text-center relative transition-colors ${isSelected ? \'bg-indigo-200\' : \'\'}`}\\n                                                    >\\n                                                        <div className={`w-full h-8 rounded flex items-center justify-center text-[10px] font-black ${cellClass} ${isSelected ? \'ring-2 ring-indigo-500 z-10\' : \'\'}`}>\\n                                                            {displayCode}\\n                                                        </div>\\n                                                    </td>\\n                                                );\\n                                            })}\\n                                        </tr>\\n                                    ))}\\n                                </tbody>\\n                            </table>\\n                        </div>\\n                    </div>\\n                )}\\n            </div>\\n        </DashboardLayout>\\n    );\\n}\\n"},{"id":"1xuejzmym","name":"index.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\reportes\\\\index.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\nimport Head from \'next/head\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { \\n    Users, Building, Download, Printer, \\n    Calendar, User, X, ChevronRight, Sun, Moon\\n} from \'lucide-react\';\\nimport { db } from \'@/lib/firebase\'; // Necesario para el log de descarga\\nimport { getAuth } from \'firebase/auth\'; \\nimport { collection, addDoc, serverTimestamp } from \'firebase/firestore\';\\nimport { useReportes } from \'@/hooks/useReportes\'; // <--- IMPORTAMOS EL HOOK\\n\\n// --- ESTILOS DE IMPRESIN (MANTENIDOS) ---\\nconst PrintStyles = () => (\\n    <style>{`\\n        @media print {\\n            @page { margin: 0.5cm; size: landscape; }\\n            body { background: white !important; -webkit-print-color-adjust: exact; font-family: sans-serif; }\\n            .no-print, nav, aside, button, .dashboard-header { display: none !important; }\\n            .print-only { display: block !important; }\\n            .print-container { width: 100%; margin: 0; padding: 0; box-shadow: none !important; border: none !important; }\\n            table { width: 100%; border-collapse: collapse; font-size: 8pt; }\\n            th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }\\n            th { background-color: #f3f4f6 !important; color: #000 !important; font-weight: bold; }\\n            .text-indigo-600, .text-emerald-400, .text-rose-400 { color: #000 !important; }\\n        }\\n        .print-only { display: none; }\\n    `}</style>\\n);\\n\\n// Helpers visuales\\nconst formatTime = (dateInput: any) => {\\n    const d = dateInput?.seconds ? new Date(dateInput.seconds * 1000) : new Date(dateInput);\\n    if (isNaN(d.getTime())) return \'\';\\n    return d.toLocaleTimeString(\'es-AR\', { hour: \'2-digit\', minute: \'2-digit\' });\\n};\\n\\nconst formatDate = (dateInput: any) => {\\n    const d = dateInput?.seconds ? new Date(dateInput.seconds * 1000) : new Date(dateInput);\\n    if (isNaN(d.getTime())) return \'-\';\\n    return new Intl.DateTimeFormat(\'es-AR\', { day: \'2-digit\', month: \'2-digit\', year: \'numeric\' }).format(d);\\n};\\n\\nconst getNightDuration = (start: Date, end: Date) => {\\n    // Reutilizamos l贸gica visual simple si se necesita en render,\\n    // pero los datos ya vienen calculados del hook.\\n    let durationMins = 0;\\n    let current = new Date(start.getTime());\\n    const endTime = end.getTime();\\n    while (current.getTime() < endTime) {\\n        const h = current.getHours();\\n        if (h >= 21 || h < 6) durationMins++;\\n        current.setMinutes(current.getMinutes() + 1);\\n    }\\n    return durationMins / 60;\\n};\\n\\nconst DICTIONARY: Record<string, string> = {\\n    \'MANUAL_CHECKIN\': \'Fichada Manual\', \'CHECKIN\': \'Entrada\', \'CHECKOUT\': \'Salida\',\\n    \'ASIGNACION_TURNO\': \'Asignaci贸n\', \'ELIMINACION_TURNO\': \'Eliminaci贸n\',\\n    \'CAMBIO_DOTACION\': \'Cambio Dotaci贸n\', \'ALTA_EMPLEADO\': \'Alta Empleado\',\\n    \'BAJA_EMPLEADO\': \'Baja Empleado\', \'EDICION_CLIENTE\': \'Edici贸n Cliente\',\\n    \'AUTORIZACION_EXCEPCION\': \'Excepci贸n\', \'ASIGNACION_MASIVA\': \'Carga Masiva\',\\n    \'CAMBIO_FRANCO_TURNO\': \'Franco Trab. (FT)\', \'CAMBIO_DIAGRAMA\': \'Enroque\',\\n    \'CAMBIO_TURNO_FRANCO\': \'Devoluci贸n (FF)\'\\n};\\n\\nexport default function ReportsPage() {\\n    // Usamos el Hook\\n    const { \\n        loading, dateRange, setDateRange, generateReports, loadAudit,\\n        employeeReport, objectiveReport, auditLogs,\\n        SHIFT_HOURS_LOOKUP, OPERATIVE_CODES\\n    } = useReportes();\\n\\n    const [activeTab, setActiveTab] = useState<\'EMPLOYEE\' | \'OBJECTIVE\' | \'AUDIT\' | \'SHIFTS\'>(\'EMPLOYEE\');\\n    const [selectedDetailEmployee, setSelectedDetailEmployee] = useState<string>(\'\');\\n    const [detailItem, setDetailItem] = useState<any | null>(null);\\n    const [currentUserName, setCurrentUserName] = useState(\\"Cargando...\\");\\n\\n    useEffect(() => {\\n        const auth = getAuth();\\n        if (auth.currentUser) setCurrentUserName(auth.currentUser.displayName || auth.currentUser.email || \\"Usuario\\");\\n    }, []);\\n\\n    // Funci贸n de descarga CSV (Mantenida local porque usa interacci贸n con DOM)\\n    const downloadCSV = async (data: any[], filename: string) => {\\n        if (!data.length) return;\\n        const auth = getAuth();\\n        const u = auth.currentUser;\\n        await addDoc(collection(db, \'audit_logs\'), { timestamp: serverTimestamp(), actorUid: u?.uid || \'system\', actorName: currentUserName, action: \'EXPORT_REPORT\', module: \'REPORTES\', details: `Export贸 ${filename}.csv` });\\n\\n        const rows = data.map(obj => {\\n            const { rawShifts, type, id, clientId, ...rest } = obj; \\n            return Object.values(rest).join(\',\');\\n        }).join(\'\\\\n\');\\n        const headers = Object.keys(data[0]).filter(k => ![\'rawShifts\',\'type\',\'id\',\'clientId\'].includes(k)).join(\',\');\\n        const blob = new Blob([`${headers}\\\\n${rows}`], { type: \'text/csv\' });\\n        const url = window.URL.createObjectURL(blob);\\n        const a = document.createElement(\'a\');\\n        a.href = url;\\n        a.download = `${filename}.csv`;\\n        a.click();\\n    };\\n\\n    // --- RENDERIZADO TABLA OBJETIVOS ---\\n    const renderObjectiveTable = () => {\\n        const groupedByClient: any = {};\\n        objectiveReport.forEach(row => {\\n            if (!groupedByClient[row.client]) groupedByClient[row.client] = [];\\n            groupedByClient[row.client].push(row);\\n        });\\n\\n        const grandTotal = objectiveReport.reduce((acc, curr) => ({\\n            shifts: acc.shifts + curr.shifts,\\n            total: acc.total + curr.total,\\n            diurnas: acc.diurnas + curr.diurnas,\\n            nocturnas: acc.nocturnas + curr.nocturnas,\\n            extra50: acc.extra50 + curr.extra50,\\n            extra100: acc.extra100 + curr.extra100,\\n            plusFeriado: acc.plusFeriado + curr.plusFeriado\\n        }), { shifts: 0, total: 0, diurnas: 0, nocturnas: 0, extra50: 0, extra100: 0, plusFeriado: 0 });\\n\\n        return (\\n            <div className=\\"bg-white rounded-2xl shadow-sm border overflow-hidden print-container\\">\\n                <div className=\\"p-4 border-b flex justify-between items-center bg-slate-50 no-print\\">\\n                    <h3 className=\\"font-black text-sm uppercase flex gap-2\\"><Building size={16}/> Costos por Objetivo</h3>\\n                    <div className=\\"flex gap-2\\">\\n                        <button onClick={() => downloadCSV(objectiveReport, \'reporte_objetivos\')} className=\\"p-2 bg-white border rounded hover:bg-slate-100 text-slate-500\\"><Download size={16}/></button>\\n                        <button onClick={() => window.print()} className=\\"p-2 bg-white border rounded hover:bg-slate-100 text-slate-500\\"><Printer size={16}/></button>\\n                    </div>\\n                </div>\\n                <div className=\\"overflow-x-auto\\">\\n                    <table className=\\"w-full text-sm text-left\\">\\n                        <thead className=\\"bg-slate-50 text-slate-500 font-bold uppercase text-[10px]\\">\\n                            <tr>\\n                                <th className=\\"p-4\\">Objetivo</th>\\n                                <th className=\\"p-4 text-center\\">Turnos</th>\\n                                <th className=\\"p-4 text-center text-indigo-600\\">Total Hs</th>\\n                                <th className=\\"p-4 text-center\\">Diurnas</th>\\n                                <th className=\\"p-4 text-center\\">Noct.</th>\\n                                <th className=\\"p-4 text-center text-rose-600\\">Ex 100%</th>\\n                                <th className=\\"p-4 text-center text-emerald-600\\">Feriado</th>\\n                            </tr>\\n                        </thead>\\n                        <tbody className=\\"divide-y\\">\\n                            {Object.keys(groupedByClient).map(clientName => {\\n                                const rows = groupedByClient[clientName];\\n                                return (\\n                                    <React.Fragment key={clientName}>\\n                                        <tr className=\\"bg-slate-100/50 border-b border-slate-200\\">\\n                                            <td colSpan={7} className=\\"px-4 py-2 font-black text-xs text-slate-500 uppercase tracking-wider\\">{clientName}</td>\\n                                        </tr>\\n                                        {rows.map((row:any) => (\\n                                            <tr key={row.id} className=\\"hover:bg-slate-50\\">\\n                                                <td className=\\"p-4 pl-8 text-slate-700 font-bold\\">{row.name}</td>\\n                                                <td className=\\"p-4 text-center\\">{row.shifts}</td>\\n                                                <td className=\\"p-4 text-center font-black text-indigo-600\\">{row.total.toFixed(1)}</td>\\n                                                <td className=\\"p-4 text-center text-slate-500\\">{row.diurnas.toFixed(1)}</td>\\n                                                <td className=\\"p-4 text-center text-slate-500\\">{row.nocturnas.toFixed(1)}</td>\\n                                                <td className=\\"p-4 text-center font-bold text-rose-600\\">{row.extra100.toFixed(1)}</td>\\n                                                <td className=\\"p-4 text-center font-bold text-emerald-600\\">{row.plusFeriado.toFixed(1)}</td>\\n                                            </tr>\\n                                        ))}\\n                                    </React.Fragment>\\n                                );\\n                            })}\\n                        </tbody>\\n                        <tfoot className=\\"bg-slate-900 text-white font-black text-xs uppercase print:bg-gray-200 print:text-black\\">\\n                            <tr>\\n                                <td className=\\"p-4 text-right\\">TOTAL GENERAL</td>\\n                                <td className=\\"p-4 text-center\\">{grandTotal.shifts}</td>\\n                                <td className=\\"p-4 text-center text-emerald-400 print:text-black\\">{grandTotal.total.toFixed(1)}</td>\\n                                <td className=\\"p-4 text-center\\">{grandTotal.diurnas.toFixed(1)}</td>\\n                                <td className=\\"p-4 text-center text-violet-300 print:text-black\\">{grandTotal.nocturnas.toFixed(1)}</td>\\n                                <td className=\\"p-4 text-center text-rose-400 print:text-black\\">{grandTotal.extra100.toFixed(1)}</td>\\n                                <td className=\\"p-4 text-center text-emerald-400 print:text-black\\">{grandTotal.plusFeriado.toFixed(1)}</td>\\n                            </tr>\\n                        </tfoot>\\n                    </table>\\n                </div>\\n            </div>\\n        );\\n    };\\n\\n    const renderEmployeeTable = () => {\\n        const grandTotal = employeeReport.reduce((acc, curr) => ({\\n            shifts: acc.shifts + curr.shifts,\\n            total: acc.total + curr.total,\\n            diurnas: acc.diurnas + curr.diurnas,\\n            nocturnas: acc.nocturnas + curr.nocturnas,\\n            extra50: acc.extra50 + curr.extra50,\\n            extra100: acc.extra100 + curr.extra100,\\n            plusFeriado: acc.plusFeriado + curr.plusFeriado\\n        }), { shifts: 0, total: 0, diurnas: 0, nocturnas: 0, extra50: 0, extra100: 0, plusFeriado: 0 });\\n\\n        return (\\n            <div className=\\"bg-white rounded-2xl shadow-sm border overflow-hidden print-container\\">\\n                <div className=\\"p-4 border-b flex justify-between items-center bg-slate-50 no-print\\">\\n                    <h3 className=\\"font-black text-sm uppercase flex gap-2\\"><Users size={16}/> Liquidaci贸n de Horas</h3>\\n                    <div className=\\"flex gap-2\\">\\n                        <button onClick={() => downloadCSV(employeeReport, \'reporte_empleados\')} className=\\"p-2 bg-white border rounded hover:bg-slate-100 text-slate-500\\"><Download size={16}/></button>\\n                        <button onClick={() => window.print()} className=\\"p-2 bg-white border rounded hover:bg-slate-100 text-slate-500\\"><Printer size={16}/></button>\\n                    </div>\\n                </div>\\n                <div className=\\"overflow-x-auto\\">\\n                    <table className=\\"w-full text-sm text-left\\">\\n                        <thead className=\\"bg-slate-50 text-slate-500 font-bold uppercase text-[10px]\\">\\n                            <tr>\\n                                <th className=\\"p-4\\">Empleado</th>\\n                                <th className=\\"p-4 text-center\\">Turnos</th>\\n                                <th className=\\"p-4 text-center text-indigo-600\\">Total Hs</th>\\n                                <th className=\\"p-4 text-center text-slate-400\\">Normales</th>\\n                                <th className=\\"p-4 text-center text-amber-600\\">Ex 50%</th>\\n                                <th className=\\"p-4 text-center text-rose-600\\">Ex 100%</th>\\n                                <th className=\\"p-4 text-center text-violet-600\\">Noct.</th>\\n                                <th className=\\"p-4 text-center text-emerald-600\\">Plus Feriado</th>\\n                                <th className=\\"p-4 text-center no-print\\">Ver</th>\\n                            </tr>\\n                        </thead>\\n                        <tbody className=\\"divide-y\\">\\n                            {employeeReport.map(row => (\\n                                <tr key={row.id} className=\\"hover:bg-indigo-50/30 cursor-pointer group\\" onClick={() => setDetailItem(row)}>\\n                                    <td className=\\"p-4 font-bold text-slate-700\\">\\n                                        {row.name}\\n                                        {(row.ftCount > 0 || row.ffCount > 0) && (\\n                                            <div className=\\"flex gap-1 mt-1\\">\\n                                                {row.ftCount > 0 && <span className=\\"text-[9px] bg-violet-100 text-violet-700 px-1 rounded border border-violet-200\\">FT: {row.ftCount}</span>}\\n                                                {row.ffCount > 0 && <span className=\\"text-[9px] bg-cyan-100 text-cyan-700 px-1 rounded border border-cyan-200\\">FF: {row.ffCount}</span>}\\n                                            </div>\\n                                        )}\\n                                    </td>\\n                                    <td className=\\"p-4 text-center\\">{row.shifts}</td>\\n                                    <td className=\\"p-4 text-center font-black text-indigo-600 text-lg\\">{row.total.toFixed(1)}</td>\\n                                    <td className=\\"p-4 text-center text-slate-400\\">{row.diurnas.toFixed(1)}</td>\\n                                    <td className=\\"p-4 text-center font-bold text-amber-600 bg-amber-50/30\\">{row.extra50.toFixed(1)}</td>\\n                                    <td className=\\"p-4 text-center font-bold text-rose-600 bg-rose-50/30\\">{row.extra100.toFixed(1)}</td>\\n                                    <td className=\\"p-4 text-center text-violet-600\\">{row.nocturnas.toFixed(1)}</td>\\n                                    <td className=\\"p-4 text-center font-bold text-emerald-600\\">{row.plusFeriado.toFixed(1)}</td>\\n                                    <td className=\\"p-4 text-center text-slate-300 group-hover:text-indigo-600 no-print\\"><ChevronRight size={16}/></td>\\n                                </tr>\\n                            ))}\\n                        </tbody>\\n                        <tfoot className=\\"bg-slate-900 text-white font-black text-xs uppercase print:bg-gray-200 print:text-black\\">\\n                            <tr>\\n                                <td className=\\"p-4 text-right\\">TOTAL GENERAL</td>\\n                                <td className=\\"p-4 text-center\\">{grandTotal.shifts}</td>\\n                                <td className=\\"p-4 text-center text-emerald-400 print:text-black\\">{grandTotal.total.toFixed(1)}</td>\\n                                <td className=\\"p-4 text-center text-slate-400 print:text-black\\">{grandTotal.diurnas.toFixed(1)}</td>\\n                                <td className=\\"p-4 text-center text-amber-400 print:text-black\\">{grandTotal.extra50.toFixed(1)}</td>\\n                                <td className=\\"p-4 text-center text-rose-400 print:text-black\\">{grandTotal.extra100.toFixed(1)}</td>\\n                                <td className=\\"p-4 text-center text-violet-300 print:text-black\\">{grandTotal.nocturnas.toFixed(1)}</td>\\n                                <td className=\\"p-4 text-center text-emerald-400 print:text-black\\">{grandTotal.plusFeriado.toFixed(1)}</td>\\n                                <td className=\\"no-print\\"></td>\\n                            </tr>\\n                        </tfoot>\\n                    </table>\\n                </div>\\n            </div>\\n        );\\n    };\\n\\n    const renderShiftsDetailTable = () => {\\n        const empData = employeeReport.find(e => e.id === selectedDetailEmployee);\\n        \\n        if (!selectedDetailEmployee) {\\n            return (\\n                <div className=\\"p-10 text-center bg-white rounded-2xl border border-dashed border-slate-300 text-slate-400 animate-in fade-in\\">\\n                    <User size={48} className=\\"mx-auto mb-2 opacity-20\\"/>\\n                    <p className=\\"font-bold uppercase text-sm\\">Seleccione un empleado para ver sus turnos</p>\\n                </div>\\n            );\\n        }\\n\\n        if (!empData || !empData.rawShifts.length) {\\n            return (\\n                <div className=\\"p-10 text-center bg-white rounded-2xl border border-dashed border-slate-300 text-slate-400\\">\\n                    <p className=\\"font-bold uppercase text-sm\\">No se encontraron turnos para este empleado en el rango seleccionado.</p>\\n                </div>\\n            );\\n        }\\n\\n        const sortedShifts = [...empData.rawShifts].sort((a: any, b: any) => a.startTime.seconds - b.startTime.seconds);\\n\\n        return (\\n            <div className=\\"bg-white rounded-2xl shadow-sm border overflow-hidden print-container animate-in fade-in slide-in-from-bottom-4\\">\\n                <div className=\\"p-4 border-b flex justify-between items-center bg-slate-50 no-print\\">\\n                    <h3 className=\\"font-black text-sm uppercase flex gap-2 items-center\\">\\n                        <Calendar size={16} className=\\"text-indigo-600\\"/> \\n                        Cronograma: <span className=\\"text-slate-700\\">{empData.name}</span>\\n                    </h3>\\n                    <div className=\\"flex gap-2\\">\\n                        <button onClick={() => window.print()} className=\\"p-2 bg-white border rounded hover:bg-slate-100 text-slate-500\\"><Printer size={16}/></button>\\n                    </div>\\n                </div>\\n                <div className=\\"overflow-x-auto\\">\\n                    <table className=\\"w-full text-sm text-left\\">\\n                        <thead className=\\"bg-slate-50 text-slate-500 font-bold uppercase text-[10px]\\">\\n                            <tr>\\n                                <th className=\\"p-4\\">Fecha</th>\\n                                <th className=\\"p-4\\">D铆a</th>\\n                                <th className=\\"p-4 text-center\\">C贸digo</th>\\n                                <th className=\\"p-4 text-center\\">Horario</th>\\n                                <th className=\\"p-4\\">Objetivo</th>\\n                                <th className=\\"p-4 text-center\\">Hs Calc.</th>\\n                                <th className=\\"p-4 text-center\\">Estado</th>\\n                            </tr>\\n                        </thead>\\n                        <tbody className=\\"divide-y\\">\\n                            {sortedShifts.map((s: any) => {\\n                                const dateObj = new Date(s.startTime.seconds * 1000);\\n                                const dayName = dateObj.toLocaleDateString(\'es-AR\', { weekday: \'long\' });\\n                                \\n                                let duration = (s.endTime.seconds - s.startTime.seconds) / 3600;\\n                                const rawCode = (s.code || \'\').trim().toUpperCase();\\n                                if (SHIFT_HOURS_LOOKUP[rawCode]) duration = SHIFT_HOURS_LOOKUP[rawCode];\\n\\n                                return (\\n                                    <tr key={s.id} className=\\"hover:bg-slate-50\\">\\n                                        <td className=\\"p-4 font-bold text-slate-700\\">{formatDate(s.startTime)}</td>\\n                                        <td className=\\"p-4 capitalize text-slate-500 text-xs\\">{dayName}</td>\\n                                        <td className=\\"p-4 text-center\\">\\n                                            <span className={`px-2 py-1 rounded text-[10px] font-black uppercase border ${s.code === \'F\' ? \'bg-slate-100 text-slate-400\' : \'bg-indigo-50 text-indigo-700 border-indigo-100\'}`}>\\n                                                {s.code}\\n                                            </span>\\n                                        </td>\\n                                        <td className=\\"p-4 text-center font-mono text-xs text-slate-500\\">\\n                                            {formatTime(s.startTime)} - {formatTime(s.endTime)}\\n                                        </td>\\n                                        <td className=\\"p-4 text-xs font-bold text-slate-600 truncate max-w-[200px]\\">\\n                                            {s.objectiveName || s.objectiveId}\\n                                        </td>\\n                                        <td className=\\"p-4 text-center font-bold text-indigo-600\\">\\n                                            {duration > 0 ? duration.toFixed(1) : \'-\'}\\n                                        </td>\\n                                        <td className=\\"p-4 text-center\\">\\n                                            {s.status === \'PRESENT\' \\n                                                ? <span className=\\"text-[9px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-bold\\">PRESENTE</span>\\n                                                : s.status === \'ABSENT\'\\n                                                ? <span className=\\"text-[9px] bg-rose-100 text-rose-700 px-2 py-1 rounded font-bold\\">AUSENTE</span>\\n                                                : <span className=\\"text-[9px] bg-slate-100 text-slate-500 px-2 py-1 rounded font-bold\\">PENDIENTE</span>\\n                                            }\\n                                        </td>\\n                                    </tr>\\n                                );\\n                            })}\\n                        </tbody>\\n                    </table>\\n                </div>\\n            </div>\\n        );\\n    };\\n\\n    const renderDetailModal = () => {\\n        if (!detailItem) return null;\\n\\n        // Nota: Si usas el mismo l贸gica de visualizaci贸n que arriba, puedes reutilizarla.\\n        // Aqu铆 mantengo tu estructura del modal para no romper el dise帽o.\\n        \\n        const rowsWithData = detailItem.rawShifts\\n            .sort((a:any,b:any) => a.startTime.seconds - b.startTime.seconds)\\n            .map((s:any) => {\\n                const rawCode = (s.code||\'\').trim().toUpperCase();\\n                const isOp = OPERATIVE_CODES.includes(rawCode);\\n                \\n                const start = new Date(s.startTime.seconds * 1000);\\n                const end = new Date(s.endTime.seconds * 1000);\\n                let duration = isOp ? (end.getTime() - start.getTime()) / 3600000 : 0;\\n                if (duration < 0 || duration > 24) duration = SHIFT_HOURS_LOOKUP[rawCode] || 8;\\n                \\n                const night = isOp ? getNightDuration(start, end) : 0;\\n                const day = duration - night;\\n                \\n                // Nota: Aqu铆 se recalcula visualmente, pero los datos duros vienen del hook en `employeeReport`\\n                // Si quieres precisi贸n absoluta, deber铆as pasarle el \\"holidayMap\\" al componente, \\n                // pero para efectos visuales esto funciona bien si es consistente.\\n                \\n                const isFT = s.isFrancoTrabajado || rawCode === \'FT\';\\n                const isFF = s.isFrancoCompensatorio || rawCode === \'FF\';\\n\\n                return {\\n                    id: s.id,\\n                    date: start,\\n                    code: rawCode,\\n                    swapWith: s.swapWith,\\n                    isOp,\\n                    total: duration,\\n                    day,\\n                    night,\\n                    h100: isFT ? duration : 0, \\n                    hFeriado: 0, // Simplificaci贸n visual, el total real est谩 en la tabla principal\\n                    isFT,\\n                    isFF\\n                };\\n            });\\n\\n        const totalSum = rowsWithData.reduce((acc:any, curr:any) => ({\\n            total: acc.total + curr.total,\\n            day: acc.day + curr.day,\\n            night: acc.night + curr.night,\\n            h100: acc.h100 + curr.h100,\\n            hFeriado: acc.hFeriado + curr.hFeriado\\n        }), { total: 0, day: 0, night: 0, h100: 0, hFeriado: 0 });\\n\\n        const horasParaBolsa = totalSum.total - totalSum.h100; \\n        const excedente = Math.max(0, horasParaBolsa - 200);\\n        const horasSimples = Math.min(horasParaBolsa, 200);\\n\\n        return (\\n            <div className=\\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm no-print\\" onClick={() => setDetailItem(null)}>\\n                <div className=\\"bg-white w-full max-w-5xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-in zoom-in-95\\" onClick={e => e.stopPropagation()}>\\n                    <div className=\\"p-6 bg-slate-50 border-b flex justify-between items-start\\">\\n                        <div>\\n                            <p className=\\"text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1\\">DETALLE DE HORAS</p>\\n                            <h2 className=\\"text-2xl font-black text-slate-800 uppercase flex items-center gap-2\\">\\n                                <Users size={24} className=\\"text-indigo-600\\"/> {detailItem.name}\\n                            </h2>\\n                        </div>\\n                        <button onClick={() => setDetailItem(null)} className=\\"p-2 bg-white rounded-full border hover:bg-slate-100\\"><X size={20}/></button>\\n                    </div>\\n                    <div className=\\"flex-1 overflow-auto bg-slate-50 p-6\\">\\n                        <table className=\\"w-full text-sm text-left border-collapse bg-white shadow-sm rounded-xl overflow-hidden\\">\\n                            <thead className=\\"text-[10px] font-black text-slate-500 uppercase border-b border-slate-200 bg-slate-100\\">\\n                                <tr>\\n                                    <th className=\\"py-3 px-4\\">Fecha</th>\\n                                    <th className=\\"py-3 px-4\\">Horario</th>\\n                                    <th className=\\"py-3 px-4 text-center\\">Tipo</th>\\n                                    <th className=\\"py-3 px-4 text-center border-l border-slate-200\\">Hs Totales</th>\\n                                    <th className=\\"py-3 px-4 text-center text-amber-600\\">Diurnas</th>\\n                                    <th className=\\"py-3 px-4 text-center text-indigo-600\\">Nocturnas</th>\\n                                    <th className=\\"py-3 px-4 text-center text-rose-600 border-l border-slate-200\\">Hs 100% (FT)</th>\\n                                    <th className=\\"py-3 px-4 text-center\\">Obs.</th>\\n                                </tr>\\n                            </thead>\\n                            <tbody className=\\"divide-y divide-slate-100\\">\\n                                {rowsWithData.map((row:any) => (\\n                                    <tr key={row.id} className=\\"hover:bg-indigo-50/50\\">\\n                                        <td className=\\"py-3 px-4 font-bold text-slate-700\\">{formatDate({seconds: row.date.getTime()/1000})}</td>\\n                                        <td className=\\"py-3 px-4 text-slate-500 font-mono text-xs\\">{formatTime({seconds: row.date.getTime()/1000})}</td>\\n                                        <td className=\\"py-3 px-4 text-center\\">\\n                                            <span className={`px-2 py-1 rounded text-[10px] font-black uppercase border ${row.isFT ? \'bg-violet-100 text-violet-700 border-violet-200\' : row.isFF ? \'bg-cyan-100 text-cyan-700 border-cyan-200\' : \'bg-slate-100 text-slate-600\'}`}>\\n                                                {row.code}\\n                                            </span>\\n                                        </td>\\n                                        <td className=\\"py-3 px-4 text-center font-black text-slate-800 border-l border-slate-100\\">{row.total > 0 ? row.total.toFixed(1) : \'-\'}</td>\\n                                        <td className=\\"py-3 px-4 text-center font-mono text-amber-600\\"><div className=\\"flex items-center justify-center gap-1\\">{row.day > 0 && <Sun size={10}/>} {row.day > 0 ? row.day.toFixed(1) : \'-\'}</div></td>\\n                                        <td className=\\"py-3 px-4 text-center font-mono text-indigo-600\\"><div className=\\"flex items-center justify-center gap-1\\">{row.night > 0 && <Moon size={10}/>} {row.night > 0 ? row.night.toFixed(1) : \'-\'}</div></td>\\n                                        <td className=\\"py-3 px-4 text-center font-black text-rose-600 bg-rose-50/20 border-l border-slate-100\\">{row.h100 > 0 ? row.h100.toFixed(1) : \'-\'}</td>\\n                                        <td className=\\"py-3 px-4 text-center\\">\\n                                            {row.swapWith && <span className=\\"text-[9px] bg-amber-50 text-amber-600 px-1 rounded border border-amber-100\\"> {row.swapWith}</span>}\\n                                        </td>\\n                                    </tr>\\n                                ))}\\n                            </tbody>\\n                            <tfoot className=\\"bg-slate-900 text-white font-bold text-xs\\">\\n                                <tr>\\n                                    <td colSpan={3} className=\\"py-4 px-4 text-right uppercase tracking-wider\\">Acumulado:</td>\\n                                    <td className=\\"py-4 px-4 text-center font-black text-white text-sm border-l border-slate-700\\">{totalSum.total.toFixed(1)}</td>\\n                                    <td className=\\"py-4 px-4 text-center text-amber-400\\">{totalSum.day.toFixed(1)}</td>\\n                                    <td className=\\"py-4 px-4 text-center text-indigo-300\\">{totalSum.night.toFixed(1)}</td>\\n                                    <td className=\\"py-4 px-4 text-center text-rose-400 font-black text-sm border-l border-slate-700\\">{totalSum.h100.toFixed(1)}</td>\\n                                    <td></td>\\n                                </tr>\\n                                <tr className=\\"bg-slate-800 border-t border-slate-700\\">\\n                                    <td colSpan={3} className=\\"py-3 px-4 text-right uppercase text-amber-400\\">Liquidaci贸n (200hs):</td>\\n                                    <td colSpan={3} className=\\"py-3 px-4\\">\\n                                        <div className=\\"flex justify-around items-center\\">\\n                                            <div className=\\"flex flex-col items-center\\"><span className=\\"text-[9px] text-slate-400 uppercase\\">Hs Simples</span><span className=\\"text-white font-mono text-lg\\">{horasSimples.toFixed(1)}</span></div>\\n                                            <div className=\\"h-8 w-px bg-slate-600\\"></div>\\n                                            <div className=\\"flex flex-col items-center\\"><span className=\\"text-[9px] text-amber-400 uppercase\\">Extras 50%</span><span className=\\"text-amber-400 font-mono text-lg font-black\\">{excedente.toFixed(1)}</span></div>\\n                                        </div>\\n                                    </td>\\n                                    <td colSpan={3} className=\\"py-3 px-4 text-center text-xs text-slate-500 italic border-l border-slate-700\\">* FT y Feriados se pagan aparte.</td>\\n                                </tr>\\n                            </tfoot>\\n                        </table>\\n                    </div>\\n                </div>\\n            </div>\\n        );\\n    };\\n\\n    return (\\n        <DashboardLayout>\\n            <Head><title>Reportes | CronoApp</title></Head>\\n            <PrintStyles />\\n            <div className=\\"max-w-7xl mx-auto p-4 space-y-6 animate-in fade-in\\">\\n                <div className=\\"flex justify-between items-center border-b pb-4 no-print\\">\\n                    <div><h1 className=\\"text-2xl font-black uppercase text-slate-800\\">Centro de Reportes</h1><p className=\\"text-sm text-slate-500 font-medium\\">Liquidaci贸n CCT 507/07</p></div>\\n                    <div className=\\"flex bg-slate-100 p-1 rounded-xl\\">\\n                        <button onClick={() => setActiveTab(\'EMPLOYEE\')} className={`px-4 py-2 rounded-lg text-xs font-black uppercase transition-all ${activeTab === \'EMPLOYEE\' ? \'bg-white shadow text-indigo-600\' : \'text-slate-400\'}`}>Liquidaci贸n</button>\\n                        <button onClick={() => setActiveTab(\'SHIFTS\')} className={`px-4 py-2 rounded-lg text-xs font-black uppercase transition-all ${activeTab === \'SHIFTS\' ? \'bg-white shadow text-indigo-600\' : \'text-slate-400\'}`}>Detalle Turnos</button>\\n                        <button onClick={() => setActiveTab(\'OBJECTIVE\')} className={`px-4 py-2 rounded-lg text-xs font-black uppercase transition-all ${activeTab === \'OBJECTIVE\' ? \'bg-white shadow text-indigo-600\' : \'text-slate-400\'}`}>Por Objetivo</button>\\n                        <button onClick={() => setActiveTab(\'AUDIT\')} className={`px-4 py-2 rounded-lg text-xs font-black uppercase transition-all ${activeTab === \'AUDIT\' ? \'bg-white shadow text-indigo-600\' : \'text-slate-400\'}`}>Auditor铆a</button>\\n                    </div>\\n                </div>\\n\\n                <div className=\\"bg-white p-4 rounded-2xl shadow-sm border flex flex-wrap gap-4 items-end no-print\\">\\n                    <div className=\\"flex-1 min-w-[150px]\\">\\n                        <label className=\\"text-[10px] font-bold text-slate-400 uppercase\\">Desde</label>\\n                        <input type=\\"date\\" value={dateRange.start} onChange={e => setDateRange({...dateRange, start: e.target.value})} className=\\"w-full p-2 border rounded-xl font-bold text-sm\\"/>\\n                    </div>\\n                    <div className=\\"flex-1 min-w-[150px]\\">\\n                        <label className=\\"text-[10px] font-bold text-slate-400 uppercase\\">Hasta</label>\\n                        <input type=\\"date\\" value={dateRange.end} onChange={e => setDateRange({...dateRange, end: e.target.value})} className=\\"w-full p-2 border rounded-xl font-bold text-sm\\"/>\\n                    </div>\\n\\n                    {activeTab === \'SHIFTS\' && (\\n                        <div className=\\"flex-[2] min-w-[250px] animate-in slide-in-from-left-5\\">\\n                            <label className=\\"text-[10px] font-bold text-indigo-500 uppercase\\">Filtrar por Empleado</label>\\n                            <select \\n                                value={selectedDetailEmployee} \\n                                onChange={(e) => setSelectedDetailEmployee(e.target.value)}\\n                                className=\\"w-full p-2.5 border-2 border-indigo-100 bg-indigo-50/30 rounded-xl font-bold text-sm text-slate-700 outline-none focus:border-indigo-500\\"\\n                            >\\n                                <option value=\\"\\">-- Seleccione un Empleado --</option>\\n                                {employeeReport.map(emp => (\\n                                    <option key={emp.id} value={emp.id}>{emp.name}</option>\\n                                ))}\\n                            </select>\\n                        </div>\\n                    )}\\n\\n                    <button onClick={() => activeTab === \'AUDIT\' ? loadAudit() : generateReports()} className=\\"bg-slate-900 text-white px-6 py-2.5 rounded-xl font-black text-xs uppercase hover:bg-slate-800 transition-colors\\">\\n                        {loading ? \'Procesando...\' : \'Generar Reporte\'}\\n                    </button>\\n                </div>\\n\\n                {activeTab === \'EMPLOYEE\' && renderEmployeeTable()}\\n                {activeTab === \'SHIFTS\' && renderShiftsDetailTable()}\\n                {activeTab === \'OBJECTIVE\' && renderObjectiveTable()}\\n                \\n                {activeTab === \'AUDIT\' && (\\n                    <div className=\\"bg-white rounded-2xl shadow-sm border overflow-hidden\\">\\n                        <table className=\\"w-full text-sm text-left\\"><thead className=\\"bg-slate-50 text-slate-500 font-bold uppercase text-[10px]\\"><tr><th className=\\"p-4\\">Fecha</th><th className=\\"p-4\\">Actor</th><th className=\\"p-4\\">Acci贸n</th><th className=\\"p-4\\">Detalle</th></tr></thead><tbody className=\\"divide-y\\">{auditLogs.map(log => (<tr key={log.id} className=\\"hover:bg-slate-50\\"><td className=\\"p-4\\"><p className=\\"font-bold\\">{formatDate(log.timestamp)}</p><p className=\\"text-xs text-slate-400\\">{formatTime(log.timestamp)}</p></td><td className=\\"p-4 font-bold text-indigo-600\\">{log.actorName || \'Sistema\'}</td><td className=\\"p-4\\"><span className=\\"px-2 py-1 bg-slate-100 rounded text-[10px] font-black uppercase text-slate-600 border\\">{DICTIONARY[log.action] || log.action}</span></td><td className=\\"p-4 text-xs text-slate-500 truncate max-w-xs\\">{typeof log.details === \'string\' ? log.details : JSON.stringify(log.details)}</td></tr>))}</tbody></table>\\n                    </div>\\n                )}\\n\\n                {renderDetailModal()}\\n            </div>\\n        </DashboardLayout>\\n    );\\n}"},{"id":"r4t3pbl3g","name":"index.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\rrhh\\\\index.tsx","area":"FRONTEND","content":"\\nimport React, { useState, useEffect, useMemo } from \'react\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { employeeService, Employee } from \'@/services/employeeService\';\\nimport { absenceService, Absence } from \'@/services/absenceService\';\\nimport { holidayService, Holiday } from \'@/services/holidayService\';\\nimport { agreementService } from \'@/services/agreementService\';\\nimport { db } from \'@/lib/firebase\';\\nimport { getAuth, onAuthStateChanged } from \'firebase/auth\'; \\nimport { collection, getDocs, query, where, Timestamp, addDoc, updateDoc, doc, deleteDoc, writeBatch, serverTimestamp } from \'firebase/firestore\';\\nimport { useToast } from \'@/context/ToastContext\';\\nimport { \\n    Users, Search, Plus, Edit2, Trash2, \\n    FileText, X, CheckCircle, ChevronRight, ChevronLeft,\\n    BarChart2, Book, Download, Coffee, AlertOctagon, FileCheck,\\n    FileSpreadsheet, Shirt, Info, UploadCloud, FileDown, Activity, AlertTriangle, Calendar, Briefcase, Save, ArrowLeft, Printer,\\n    PieChart as PieChartIcon, TrendingUp, Clock, Target, MapPin, ExternalLink\\n} from \'lucide-react\';\\n\\nimport { \\n  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,\\n  PieChart, Pie, Cell, Legend\\n} from \'recharts\';\\n\\n// --- UTILIDADES ---\\n\\nconst getArgentinaDate = (dateInput: any): string => {\\n    if (!dateInput) return \'\';\\n    const d = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);\\n    const options: Intl.DateTimeFormatOptions = { timeZone: \'America/Argentina/Cordoba\', year: \'numeric\', month: \'2-digit\', day: \'2-digit\' };\\n    const parts = new Intl.DateTimeFormat(\'es-AR\', options).formatToParts(d);\\n    const day = parts.find(p => p.type === \'day\')?.value;\\n    const month = parts.find(p => p.type === \'month\')?.value;\\n    const year = parts.find(p => p.type === \'year\')?.value;\\n    return `${year}-${month}-${day}`;\\n};\\n\\n// --- PARSEO CSV ---\\nconst parseCSV = (text: string) => {\\n    const cleanText = text.replace(/^\\\\uFEFF/, \'\').replace(/\\\\r\\\\n/g, \'\\\\n\').replace(/\\\\r/g, \'\\\\n\');\\n    const lines = cleanText.split(\'\\\\n\').filter(l => l.trim().length > 0);\\n    if (lines.length < 2) return []; \\n\\n    const firstLine = lines[0];\\n    const delimiter = firstLine.includes(\';\') ? \';\' : \',\';\\n    const headers = firstLine.split(delimiter).map(h => h.trim().toLowerCase().replace(/^\\"|\\"$/g, \'\'));\\n    \\n    const result = [];\\n    for(let i=1; i<lines.length; i++){\\n        const rowLine = lines[i];\\n        if (!rowLine.trim() || rowLine.replace(/;/g, \'\').trim().length === 0) continue;\\n\\n        let row = [];\\n        if (delimiter === \';\') {\\n             row = rowLine.split(\';\'); \\n        } else {\\n             const matches = rowLine.match(/(\\".*?\\"|[^\\",\\\\s]+)(?=\\\\s*,|\\\\s*$)/g);\\n             row = matches ? matches : rowLine.split(\',\');\\n        }\\n        \\n        const obj: any = {};\\n        headers.forEach((h, idx) => {\\n            let val = row[idx] ? row[idx].trim() : \'\';\\n            val = val.replace(/^\\"|\\"$/g, \'\');\\n            obj[h] = val;\\n        });\\n        result.push(obj);\\n    }\\n    return result;\\n};\\n\\nconst parseDateString = (dateStr: string) => {\\n    if (!dateStr) return \'\';\\n    if (dateStr.match(/^\\\\d{4}-\\\\d{2}-\\\\d{2}$/)) return dateStr; \\n    const parts = dateStr.split(/[/\\\\-]/);\\n    if (parts.length === 3) {\\n        const day = parts[0].padStart(2, \'0\');\\n        const month = parts[1].padStart(2, \'0\');\\n        const year = parts[2].length === 2 ? \'20\' + parts[2] : parts[2];\\n        return `${year}-${month}-${day}`;\\n    }\\n    return \'\';\\n};\\n\\n// --- MAPEO DE DATOS ---\\nconst createEmployeeObject = (data: any, objectivesList: any[]) => {\\n    let objId = \'\';\\n    \\n    // PRIORIDAD 1: ID Manual\\n    if (data.preferredObjectiveId && data.preferredObjectiveId !== \'undefined\') {\\n        objId = data.preferredObjectiveId;\\n    } \\n    // PRIORIDAD 2: Busqueda por nombre\\n    else if (data.objectiveName) {\\n        const cleanObj = data.objectiveName.toLowerCase().trim();\\n        let found = objectivesList.find(o => o.name.toLowerCase().trim() === cleanObj);\\n        if (!found) {\\n             found = objectivesList.find(o => o.name.toLowerCase().includes(cleanObj) || cleanObj.includes(o.name.toLowerCase()));\\n        }\\n        if (found) objId = found.id;\\n    }\\n\\n    let finalName = \'\';\\n    const ln = (data.lastName || \'\').trim();\\n    const fn = (data.firstName || \'\').trim();\\n\\n    if (ln && fn) {\\n        if (ln.toLowerCase().includes(fn.toLowerCase())) { finalName = ln; } \\n        else { finalName = `${ln}, ${fn}`; }\\n    } else {\\n        finalName = ln || fn || \'Desconocido\';\\n    }\\n\\n    finalName = finalName.toUpperCase();\\n    const cycleDay = data.cycleStartDay ? parseInt(data.cycleStartDay.toString().replace(/[^0-9]/g, \'\')) : 26;\\n\\n    return {\\n        firstName: fn,\\n        lastName: ln,\\n        name: finalName, \\n        dni: data.dni || \'\',\\n        cuil: data.cuil || \'\',\\n        fileNumber: data.fileNumber || \'\',\\n        email: data.email || \'\',\\n        phone: data.phone || \'\',\\n        address: data.address || \'\',\\n        lat: data.lat || null, \\n        lng: data.lng || null,\\n        category: data.category || \'Vigilador\',\\n        cct: data.cct || \'Seguridad Privada\',\\n        laborAgreement: data.laborAgreement || \'SUVICO\',\\n        status: data.status ? data.status.toLowerCase() : \'activo\',\\n        role: \'employee\',\\n        isAvailable: true,\\n        contractType: data.contractType || \'FullTime\',\\n        periodType: data.periodType || \'Mensual\',\\n        startDate: data.startDate || new Date().toISOString().split(\'T\')[0],\\n        cycleStartDay: !isNaN(cycleDay) ? cycleDay : 26, \\n        maxHours: 200,\\n        preferredClientId: \'\', \\n        preferredObjectiveId: objId,\\n        createdAt: new Date().toISOString(),\\n        sizes: data.sizes || { shirt: \'\', pants: \'\', shoes: \'\' }\\n    };\\n};\\n\\nconst getNightDuration = (start: Date, end: Date, nightStart: number, nightEnd: number) => {\\n    let durationMins = 0;\\n    let current = new Date(start.getTime());\\n    const endTime = end.getTime();\\n    while (current.getTime() < endTime) {\\n        const h = current.getHours();\\n        if (h >= nightStart || h < nightEnd) durationMins++;\\n        current.setMinutes(current.getMinutes() + 1);\\n    }\\n    return durationMins / 60;\\n};\\n\\nconst CHART_COLORS = [\'#6366f1\', \'#10b981\', \'#f59e0b\', \'#ef4444\', \'#8b5cf6\', \'#ec4899\'];\\nconst OPERATIVE_CODES = [\'M\', \'T\', \'N\', \'D12\', \'N12\', \'PU\', \'GU\', \'FT\']; \\nconst SHIFT_HOURS_LOOKUP: Record<string, number> = { \'M\':8, \'T\':8, \'N\':8, \'D12\':12, \'N12\':12, \'PU\':12, \'GU\':8, \'FT\': 0, \'F\':0, \'V\':0, \'L\':0, \'A\':0, \'E\':0 };\\n\\ninterface Agreement {\\n    id?: string;\\n    name: string;\\n    code: string;\\n    maxHoursWeekly: number;\\n    maxHoursMonthly: number;\\n    saturdayCutoffHour: number;\\n    saturdayRate: number;\\n    nightShiftStart: number;\\n    nightShiftEnd: number;\\n    categories: string[];\\n    paysDoubleOnFranco: boolean;\\n    holidayIsPlus?: boolean;\\n    sundayIs100?: boolean;\\n}\\n\\ninterface ExtendedAgreement extends Agreement {\\n    holidayIsPlus?: boolean;\\n    francoWorkedIs100?: boolean;\\n    saturdayAfter13Is100?: boolean; \\n    sundayIs100?: boolean;\\n}\\n\\nexport default function EmployeesPage() {\\n  const { addToast } = useToast();\\n  const [currentUserName, setCurrentUserName] = useState(\\"Cargando...\\");\\n  const [currentDate, setCurrentDate] = useState(new Date());\\n  const [activeTab, setActiveTab] = useState<\'legajos\' | \'ausencias\' | \'feriados\' | \'convenios\'>(\'legajos\');\\n  const [view, setView] = useState<\'list\' | \'form\'>(\'list\');\\n  const [selectedEmp, setSelectedEmp] = useState<any | null>(null); // Changed type to any to avoid strict interface blocking\\n  const [employees, setEmployees] = useState<any[]>([]); // Changed to any[]\\n  const [filteredEmployees, setFilteredEmployees] = useState<any[]>([]);\\n  const [searchTerm, setSearchTerm] = useState(\'\');\\n  \\n  const [empStats, setEmpStats] = useState<any>(null);\\n  const [loadingStats, setLoadingStats] = useState(false);\\n  const [globalStats, setGlobalStats] = useState({ totalEmployees: 0, activeAbsences: 0, nextHolidays: 0 });\\n\\n  const [clients, setClients] = useState<any[]>([]);\\n  const [allObjectives, setAllObjectives] = useState<any[]>([]);\\n  const [agreements, setAgreements] = useState<ExtendedAgreement[]>([]);\\n  const [absences, setAbsences] = useState<Absence[]>([]);\\n  const [filteredAbsences, setFilteredAbsences] = useState<Absence[]>([]);\\n  const [absenceSearchTerm, setAbsenceSearchTerm] = useState(\'\');\\n  const [holidays, setHolidays] = useState<Holiday[]>([]);\\n\\n  const [showAbsenceModal, setShowAbsenceModal] = useState(false);\\n  const initialAbsenceForm: Absence = { employeeId: \'\', employeeName: \'\', type: \'Enfermedad\', startDate: new Date().toISOString().split(\'T\')[0], endDate: new Date().toISOString().split(\'T\')[0], status: \'Pendiente\', hasCertificate: false, reason: \'\', comments: \'\' };\\n  const [absenceForm, setAbsenceForm] = useState<Absence>(initialAbsenceForm);\\n  const [isEditingAbsence, setIsEditingAbsence] = useState(false);\\n\\n  const [holidayForm, setHolidayForm] = useState<any>({ date: \'\', name: \'\', type: \'Nacional\' });\\n  const [syncYear, setSyncYear] = useState(new Date().getFullYear());\\n  const [isSyncing, setIsSyncing] = useState(false);\\n  \\n  const initialAgreement: ExtendedAgreement = { name: \'\', code: \'\', maxHoursWeekly: 48, maxHoursMonthly: 200, saturdayCutoffHour: 13, saturdayRate: 0, nightShiftStart: 21, nightShiftEnd: 6, paysDoubleOnFranco: true, categories: [], holidayIsPlus: true, sundayIs100: false };\\n  const [agreementForm, setAgreementForm] = useState<ExtendedAgreement>(initialAgreement);\\n  const [newCategory, setNewCategory] = useState(\'\');\\n  const [isEditingAgreement, setIsEditingAgreement] = useState(false);\\n\\n  const [showImportModal, setShowImportModal] = useState(false);\\n  const [csvContent, setCsvContent] = useState(\'\');\\n  const [fileName, setFileName] = useState(\'\');\\n  const [importPreview, setImportPreview] = useState<any[]>([]);\\n  const [isImporting, setIsImporting] = useState(false);\\n  \\n  const [activeFormTab, setActiveFormTab] = useState<\'PERSONAL\' | \'LABORAL\' | \'TALLES\' | \'DOCS\'>(\'PERSONAL\');\\n  const initialForm: any = { firstName: \'\', lastName: \'\', dni: \'\', fileNumber: \'\', phone: \'\', email: \'\', category: \'\', status: \'activo\', laborAgreement: \'\', preferredClientId: \'\', preferredObjectiveId: \'\', sizes: { shirt:\'\', pants:\'\', shoes:\'\' }, cuil: \'\', address: \'\', lat: null, lng: null, contractType: \'FullTime\', periodType: \'Mensual\', cycleStartDay: 26, maxHours: 200 };\\n  const [form, setForm] = useState<any>(initialForm);\\n  const [availableCategories, setAvailableCategories] = useState<string[]>([]);\\n  const [isEditing, setIsEditing] = useState(false);\\n  const [isDeletingAll, setIsDeletingAll] = useState(false);\\n  const [isExporting, setIsExporting] = useState(false);\\n  const [isGeocoding, setIsGeocoding] = useState(false);\\n\\n  const inputClass = \\"w-full p-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-sm text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all\\";\\n  const selectClass = \\"w-full p-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-sm text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all appearance-none\\";\\n  const labelClass = \\"text-[10px] font-black uppercase text-slate-500 dark:text-slate-400 mb-1 block ml-1\\";\\n\\n  // --- HOOKS ---\\n  useEffect(() => { const auth = getAuth(); onAuthStateChanged(auth, (user) => { if (user) setCurrentUserName(user.displayName || user.email || \\"Usuario Sin Nombre\\"); else setCurrentUserName(\\"No Logueado\\"); }); }, []);\\n  const registrarAuditoria = async (accion: string, detalle: string) => { try { const auth = getAuth(); const u = auth.currentUser; await addDoc(collection(db, \'audit_logs\'), { timestamp: serverTimestamp(), actorUid: u?.uid || \\"unknown\\", actorName: u?.displayName || u?.email || \\"Desc\\", action: accion, module: \'RRHH\', details: detalle, metadata: { platform: \'web\' } }); } catch (error) {} };\\n\\n  const getCycleDates = (refDate: Date, startDay: number = 26) => { const year = refDate.getFullYear(); const month = refDate.getMonth(); const start = new Date(year, month - 1, startDay); start.setHours(0,0,0,0); const end = new Date(year, month, startDay - 1); end.setHours(23,59,59,999); return { start, end }; };\\n\\n  const replicarAusenciaEnPlanificador = async (absenceId: string, data: Absence) => { try { const auth = getAuth(); const u = auth.currentUser; const q = query(collection(db, \'turnos\'), where(\'absenceId\', \'==\', absenceId)); const snapshot = await getDocs(q); const batch = writeBatch(db); snapshot.docs.forEach(d => batch.delete(d.ref)); const [sY, sM, sD] = data.startDate.split(\'-\').map(Number); const [eY, eM, eD] = data.endDate.split(\'-\').map(Number); const start = new Date(sY, sM - 1, sD); const end = new Date(eY, eM - 1, eD); let code = \'A\'; const t = data.type.toLowerCase(); if (t.includes(\'vacaci\')) code = \'V\'; else if (t.includes(\'licencia\')) code = \'L\'; else if (t.includes(\'enfermedad\') || t.includes(\'medico\')) code = \'E\'; for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) { const turnoRef = doc(collection(db, \'turnos\')); batch.set(turnoRef, { employeeId: data.employeeId, employeeName: data.employeeName, startTime: Timestamp.fromDate(new Date(d.setHours(0, 0, 0, 0))), endTime: Timestamp.fromDate(new Date(d.setHours(23, 59, 59, 999))), type: \'NOVEDAD\', code: code, status: \'Approved\', objectiveName: `NOVEDAD - ${data.type}`, clientId: \'INTERNO\', absenceId: absenceId, isFranco: false, comments: data.reason }); } await batch.commit(); } catch (e) { addToast(\'Error replicando\', \'error\'); } };\\n  const eliminarReplicasPlanificador = async (absenceId: string) => { try { const q = query(collection(db, \'turnos\'), where(\'absenceId\', \'==\', absenceId)); const snapshot = await getDocs(q); const batch = writeBatch(db); snapshot.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); } catch (e) {} };\\n\\n  useEffect(() => { loadData(); loadClientsAndObjectives(); loadAbsences(); loadHolidays(); loadAgreements(); }, []);\\n  useEffect(() => { const activeAbs = absences.filter(a => a.status === \'Pendiente\' || a.status === \'Justificada\').length; const nextHols = holidays.filter(h => new Date(h.date) >= new Date()).length; setGlobalStats({ totalEmployees: employees.length, activeAbsences: activeAbs, nextHolidays: nextHols }); }, [employees, absences, holidays]);\\n  useEffect(() => { const term = searchTerm.toLowerCase(); setFilteredEmployees(employees.filter(e => (e.lastName || \'\').toLowerCase().includes(term) || (e.firstName || \'\').toLowerCase().includes(term) || (e.fileNumber || \'\').includes(term))); }, [searchTerm, employees]);\\n  useEffect(() => { const term = absenceSearchTerm.toLowerCase(); setFilteredAbsences(absences.filter(a => { const name = a.employeeName || \'\'; let searchableName = name; if (!name && a.employeeId) { const emp = employees.find(e => e.id === a.employeeId); if (emp) searchableName = `${emp.lastName} ${emp.firstName}`; } return searchableName.toLowerCase().includes(term); })); }, [absenceSearchTerm, absences, employees]);\\n  useEffect(() => { if (form.laborAgreement) { const selectedAgreement = agreements.find(a => a.name === form.laborAgreement); setAvailableCategories(selectedAgreement?.categories?.length ? selectedAgreement.categories : [\'General\']); } else { setAvailableCategories([]); } }, [form.laborAgreement, agreements]);\\n  \\n  useEffect(() => { if (selectedEmp && holidays.length > 0) { calculateStats(selectedEmp.id!, selectedEmp.laborAgreement || \'\', selectedEmp.cycleStartDay || 26); } }, [currentDate, selectedEmp, holidays, agreements]);\\n\\n  // --- CARGA DE DATOS RAW (SIN FILTROS DE SERVICIO) ---\\n  const loadData = async () => { \\n      try {\\n          const snapshot = await getDocs(collection(db, \'empleados\'));\\n          const data = snapshot.docs.map(doc => ({\\n              id: doc.id,\\n              ...doc.data()\\n          }));\\n          const sorted = data.sort((a: any, b: any) => (a.lastName || \'\').localeCompare(b.lastName || \'\')); \\n          setEmployees(sorted); \\n      } catch (e) {\\n          console.error(\\"Error cargando empleados:\\", e);\\n      }\\n  };\\n\\n  const loadAbsences = async () => { const data = await absenceService.getAll(); setAbsences(data); };\\n  const loadHolidays = async () => { const data = await holidayService.getAll(); setHolidays(data); };\\n  const loadAgreements = async () => { const data = await agreementService.getAll(); setAgreements(data.map(a => ({...a, categories: Array.isArray(a.categories) ? a.categories : [], paysDoubleOnFranco: !!a.paysDoubleOnFranco} as ExtendedAgreement))); };\\n  const loadClientsAndObjectives = async () => { try { const cSnap = await getDocs(collection(db, \'clients\')); setClients(cSnap.docs.map(d => ({ id: d.id, ...d.data() }))); const sSnap = await getDocs(query(collection(db, \'servicios_sla\'), where(\'status\', \'==\', \'active\'))); setAllObjectives(sSnap.docs.map(d => ({ id: d.id, name: d.data().objectiveName || d.data().name, clientId: d.data().clientId }))); } catch (e) {} };\\n\\n  // --- CALCULO ESTADISTICAS ---\\n  const calculateStats = async (empId: string, empAgreementName: string, cycleStartDay: number = 26) => {\\n      setLoadingStats(true);\\n      try {\\n          const ruleBase: ExtendedAgreement = agreements.find(a => a.name === empAgreementName) || initialAgreement;\\n          const rule = { ...ruleBase, holidayIsPlus: ruleBase.holidayIsPlus ?? true, paysDoubleOnFranco: ruleBase.paysDoubleOnFranco ?? true };\\n          const { start: firstDay, end: lastDay } = getCycleDates(currentDate, cycleStartDay);\\n          \\n          const qTurnos = query(collection(db, \'turnos\'), where(\'employeeId\', \'==\', empId), where(\'startTime\', \'>=\', Timestamp.fromDate(firstDay)), where(\'startTime\', \'<=\', Timestamp.fromDate(lastDay)));\\n          const turnosSnap = await getDocs(qTurnos);\\n          const sortedDocs = turnosSnap.docs.map(d => ({ ...d.data(), id: d.id })).sort((a:any, b:any) => a.startTime.seconds - b.startTime.seconds);\\n          \\n          const qAusencias = query(collection(db, \'ausencias\'), where(\'employeeId\', \'==\', empId));\\n          const ausenciasSnap = await getDocs(qAusencias);\\n          let totalVacaciones = 0, totalLicencias = 0, totalAusencias = 0, totalEnfermedad = 0;\\n          \\n          ausenciasSnap.docs.forEach(doc => {\\n             const data = doc.data();\\n             const [sY, sM, sD] = data.startDate.split(\'-\').map(Number);\\n             const [eY, eM, eD] = data.endDate.split(\'-\').map(Number);\\n             const start = new Date(sY, sM - 1, sD);\\n             const end = new Date(eY, eM - 1, eD);\\n             if (start <= lastDay && end >= firstDay) {\\n                 const daysCount = Math.floor((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24)) + 1;\\n                 const type = (data.type || \'\').toLowerCase();\\n                 if (type.includes(\'vacacion\')) totalVacaciones += daysCount;\\n                 else if (type.includes(\'enfermedad\') || type.includes(\'medico\')) totalEnfermedad += daysCount;\\n                 else if (type.includes(\'licencia\')) totalLicencias += daysCount;\\n                 else totalAusencias += daysCount;\\n             }\\n          });\\n\\n          let hoursTotalOperativas = 0, totalNocturnas = 0, totalPlanificado = 0, totalRealizado = 0, hoursOnFranco = 0, hoursOnHoliday = 0, totalFrancos = 0;\\n          let objectivesMap = new Map();\\n          const monthHolidays: {[key: string]: boolean} = {}; holidays.forEach(h => { monthHolidays[h.date] = true; });\\n\\n          sortedDocs.forEach((d:any) => { if (d.code === \'F\' || d.isFranco || d.code === \'FF\') totalFrancos++; });\\n\\n          sortedDocs.forEach((d:any) => {\\n              if (d.status === \'Canceled\') return;\\n              const rawCode = (d.code || \'\').trim().toUpperCase();\\n              if (d.type === \'NOVEDAD\' || !OPERATIVE_CODES.includes(rawCode)) return; \\n\\n              const start = d.startTime.toDate();\\n              const end = d.endTime.toDate();\\n              let duration = (end.getTime() - start.getTime()) / 3600000;\\n              if (duration < 0 || duration > 24) duration = SHIFT_HOURS_LOOKUP[rawCode] || 8;\\n              \\n              totalPlanificado += duration;\\n              if (end <= new Date()) totalRealizado += duration;\\n              \\n              let objName = \\"Sin Asignar\\";\\n              if (d.objectiveId) {\\n                  const found = allObjectives.find(o => o.id === d.objectiveId);\\n                  if (found) objName = found.name;\\n              } else if (d.objectiveName && !d.objectiveName.includes(\\"undefined\\")) {\\n                  objName = d.objectiveName; \\n                  if (objName.length > 15 && !objName.includes(\\" \\")) {\\n                       const found = allObjectives.find(o => o.id === objName);\\n                       if(found) objName = found.name;\\n                  }\\n              }\\n              \\n              if (objName === \\"Sin Asignar\\" && d.clientId) {\\n                  const client = clients.find(c => c.id === d.clientId);\\n                  if(client) objName = `Cliente: ${client.name}`;\\n                  else objName = `Cliente: ${d.clientId}`;\\n              }\\n              \\n              objectivesMap.set(objName, (objectivesMap.get(objName) || 0) + duration);\\n\\n              const night = getNightDuration(start, end, rule.nightShiftStart, rule.nightShiftEnd);\\n              totalNocturnas += night;\\n              const dateKey = getArgentinaDate(d.startTime);\\n              const isFeriado = monthHolidays[dateKey];\\n              const isFT = d.isFrancoTrabajado || rawCode === \'FT\'; \\n              if (isFeriado) hoursOnHoliday += duration;\\n              if (isFT) hoursOnFranco += duration; else hoursTotalOperativas += duration;\\n          });\\n\\n          const baseLimit = rule.maxHoursMonthly || 200;\\n          const excess = Math.max(0, hoursTotalOperativas - baseLimit);\\n          const simpleHours = Math.min(hoursTotalOperativas, baseLimit);\\n          \\n          setEmpStats({ \\n              totalPlanificado: Math.round(totalPlanificado),\\n              totalRealizado: Math.round(totalRealizado),\\n              progress: totalPlanificado > 0 ? Math.round((totalRealizado / totalPlanificado) * 100) : 0,\\n              nightHours: Math.round(totalNocturnas),\\n              dayHours: Math.round(simpleHours),\\n              extra100: Math.round(hoursOnFranco), \\n              extra50: Math.round(excess),          \\n              plusFeriado: Math.round(hoursOnHoliday),\\n              francosCount: totalFrancos,\\n              vacationsCount: totalVacaciones,\\n              licensesCount: totalLicencias + totalEnfermedad,\\n              absencesCount: totalAusencias,\\n              objectives: Array.from(objectivesMap.entries()).map(([name, hours]) => ({ name, hours })),\\n              shiftsCount: sortedDocs.filter((d:any) => OPERATIVE_CODES.includes((d.code||\'\').trim().toUpperCase())).length,\\n              monthlyLimit: rule.maxHoursMonthly,\\n              isOverLimit: hoursTotalOperativas > rule.maxHoursMonthly,\\n              reportData: { turnos: sortedDocs, ausencias: ausenciasSnap.docs.map(d=>d.data()) }\\n          });\\n\\n      } catch (e) { console.error(e); addToast(\'Error stats\', \'error\'); } finally { setLoadingStats(false); }\\n  };\\n  \\n  const changeMonth = (delta: number) => { const newDate = new Date(currentDate); newDate.setMonth(newDate.getMonth() + delta); setCurrentDate(newDate); };\\n  const handleRowClick = (emp: Employee) => { setSelectedEmp(emp); };\\n  \\n  // --- GUARDADO MANUAL (RAW DIRECTO) ---\\n  const handleSave = async () => { \\n      if (!form.lastName) return addToast(\'El apellido es obligatorio\', \'error\'); \\n      \\n      const dataToSave = {\\n          firstName: form.firstName || \'\',\\n          lastName: form.lastName || \'\',\\n          name: `${form.lastName || \'\'}, ${form.firstName || \'\'}`.toUpperCase(),\\n          dni: form.dni || \'\',\\n          cuil: form.cuil || \'\',\\n          fileNumber: form.fileNumber || \'\',\\n          email: form.email || \'\',\\n          phone: form.phone || \'\',\\n          address: form.address || \'\',\\n          lat: form.lat || null,\\n          lng: form.lng || null,\\n          category: form.category || \'Vigilador\',\\n          cct: form.cct || \'\',\\n          laborAgreement: form.laborAgreement || \'\',\\n          status: form.status || \'activo\',\\n          role: \'employee\',\\n          contractType: form.contractType || \'FullTime\',\\n          periodType: form.periodType || \'Mensual\',\\n          startDate: form.startDate || new Date().toISOString().split(\'T\')[0],\\n          cycleStartDay: form.cycleStartDay ? parseInt(form.cycleStartDay) : 26,\\n          maxHours: form.maxHours || 200,\\n          preferredClientId: form.preferredClientId || \'\',\\n          preferredObjectiveId: form.preferredObjectiveId || \'\',\\n          sizes: form.sizes || { shirt: \'\', pants: \'\', shoes: \'\' }\\n      };\\n\\n      try { \\n          if (isEditing && form.id) { \\n              await updateDoc(doc(db, \'empleados\', form.id), dataToSave);\\n              await registrarAuditoria(\'UPDATE_EMPLOYEE\', `Modific贸 legajo: ${form.fileNumber} - ${form.lastName}`); \\n          } else { \\n              if (employees.some(e => e.dni === form.dni)) return addToast(\'Ya existe un empleado con este DNI\', \'error\'); \\n              await addDoc(collection(db, \'empleados\'), dataToSave);\\n              await registrarAuditoria(\'CREATE_EMPLOYEE\', `Cre贸 legajo: ${form.fileNumber} - ${form.lastName}`); \\n          } \\n          \\n          addToast(\'Empleado guardado correctamente\', \'success\');\\n          await loadData(); \\n          setView(\'list\'); \\n          setSelectedEmp(null); \\n      } catch (e) { \\n          console.error(e); \\n          addToast(\'Error al guardar\', \'error\'); \\n      } \\n  };\\n\\n  // --- GEOLOCALIZACION ---\\n  const handleGeocode = async () => {\\n      if(!form.address) return addToast(\'Ingrese una direcci贸n primero\', \'warning\');\\n      setIsGeocoding(true);\\n      try {\\n          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(form.address + \', Argentina\')}&limit=1`);\\n          const data = await res.json();\\n          if(data && data.length > 0) {\\n              setForm({...form, lat: data[0].lat, lng: data[0].lon});\\n              addToast(\'Ubicaci贸n encontrada y guardada\', \'success\');\\n          } else {\\n              addToast(\'No se encontraron coordenadas\', \'error\');\\n          }\\n      } catch(e) {\\n          console.error(e);\\n          addToast(\'Error conectando servicio de mapas\', \'error\');\\n      } finally {\\n          setIsGeocoding(false);\\n      }\\n  };\\n  \\n  const handleDelete = async (id: string) => { const emp = employees.find(e => e.id === id); if(confirm(\'?\')) { await deleteDoc(doc(db, \'empleados\', id)); await registrarAuditoria(\'DELETE_EMPLOYEE\', `Elimin贸 legajo: ${emp?.fileNumber} - ${emp?.lastName}`); loadData(); setSelectedEmp(null); } };\\n  const handleDeleteAll = async () => { if(!confirm(\'BORRAR TODO?\')) return; setIsDeletingAll(true); try { for (const emp of employees) { if (emp.id) await deleteDoc(doc(db, \'empleados\', emp.id)); } await registrarAuditoria(\'DELETE_ALL\', `Eliminaci贸n masiva`); addToast(`Eliminados.`, \'success\'); loadData(); } catch (e) { console.error(e); } finally { setIsDeletingAll(false); } };\\n  const openNew = () => { setForm(initialForm); setIsEditing(false); setView(\'form\'); setSelectedEmp(null); setActiveFormTab(\'PERSONAL\'); };\\n  const openEditFromDetail = () => { if (!selectedEmp) return; setForm(selectedEmp); setIsEditing(true); setView(\'form\'); setSelectedEmp(null); setActiveFormTab(\'PERSONAL\'); };\\n  const handleSaveHoliday = async () => { if(!holidayForm.name) return; await holidayService.add(holidayForm); await registrarAuditoria(\'CREATE_HOLIDAY\', `Feriado: ${holidayForm.name}`); setHolidayForm({ date: \'\', name: \'\', type: \'Nacional\' }); loadHolidays(); };\\n  const handleDeleteHoliday = async (id: string) => { await holidayService.delete(id); await registrarAuditoria(\'DELETE_HOLIDAY\', `Feriado ID: ${id}`); loadHolidays(); };\\n  const handleSyncHolidays = async () => { setIsSyncing(true); try { await holidayService.syncWithGovApi(syncYear); addToast(`Sync OK`, \'success\'); loadHolidays(); } catch (e) { addToast(\'Error\', \'error\'); } finally { setIsSyncing(false); } };\\n  const handleAddCategory = () => { if (newCategory.trim()) { setAgreementForm({ ...agreementForm, categories: [...agreementForm.categories, newCategory.trim()] }); setNewCategory(\'\'); }};\\n  const removeCategory = (idx: number) => { const newCats = [...agreementForm.categories]; newCats.splice(idx, 1); setAgreementForm({ ...agreementForm, categories: newCats }); };\\n  const handleSaveAgreement = async () => { if (!agreementForm.name) return; if (isEditingAgreement && agreementForm.id) { await agreementService.update(agreementForm.id, agreementForm); } else { await agreementService.add(agreementForm); } setAgreementForm(initialAgreement); setIsEditingAgreement(false); loadAgreements(); };\\n  const handleEditAgreement = (a: Agreement) => { setAgreementForm(a as ExtendedAgreement); setIsEditingAgreement(true); };\\n  const handleDeleteAgreement = async (id: string) => { if(confirm(\'?\')) { await agreementService.delete(id); loadAgreements(); } };\\n  const handleOpenAbsenceModal = (absence?: Absence) => { if (absence) { setAbsenceForm(absence); setIsEditingAbsence(true); } else { setAbsenceForm(initialAbsenceForm); setIsEditingAbsence(false); } setShowAbsenceModal(true); };\\n  const handleSaveAbsence = async () => { if (!absenceForm.employeeId) return addToast(\'Seleccione un empleado\', \'error\'); const emp = employees.find(x => x.id === absenceForm.employeeId); const auth = getAuth(); const u = auth.currentUser; const nombreReal = u?.displayName || u?.email || \\"Usuario Desconocido\\"; const dataToSave = { ...absenceForm, employeeName: emp ? `${emp.lastName} ${emp.firstName}` : \'Desconocido\', comments: `${absenceForm.comments || \'\'} (Cargado por: ${nombreReal})`, createdBy: nombreReal, createdAt: new Date().toISOString() }; let savedId = \'\'; if (isEditingAbsence && absenceForm.id) { await absenceService.update(absenceForm.id, dataToSave); savedId = absenceForm.id; await registrarAuditoria(\'UPDATE_ABSENCE\', `Novedad: ${dataToSave.type}`); addToast(\'Actualizado\', \'success\'); } else { const docRef = await absenceService.add(dataToSave); savedId = docRef.id; await registrarAuditoria(\'CREATE_ABSENCE\', `Novedad: ${dataToSave.type}`); addToast(\'Registrado\', \'success\'); } if (savedId) { await replicarAusenciaEnPlanificador(savedId, dataToSave); } setShowAbsenceModal(false); loadAbsences(); };\\n  const handleDeleteAbsence = async (id: string) => { if(confirm(\'驴Eliminar?\')) { await absenceService.delete(id); await eliminarReplicasPlanificador(id); await registrarAuditoria(\'DELETE_ABSENCE\', `Elimin贸 novedad`); loadAbsences(); } };\\n  const getAbsenceEmployeeName = (a: Absence) => { if (a.employeeName) return a.employeeName; const emp = employees.find(e => e.id === a.employeeId); return emp ? `${emp.lastName}, ${emp.firstName}` : \'Desconocido\'; };\\n  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => { const file = e.target.files?.[0]; if (!file) return; setFileName(file.name); const reader = new FileReader(); reader.onload = (evt) => { if (evt.target?.result) { setCsvContent(evt.target.result as string); } }; reader.readAsText(file, \'ISO-8859-1\'); };\\n  \\n  // FUNCION DESCARGAR PLANTILLA\\n  const handleDownloadTemplate = () => { const headers = [ \\"Legajo\\", \\"Apellido, Nombre\\", \\"CUIL\\", \\"Email\\", \\"Telefono\\", \\"Direccion\\", \\"Categoria\\", \\"Convenio\\", \\"Estado\\", \\"Fecha Ingreso\\", \\"Periodo\\", \\"Inicio Ciclo\\", \\"Objetivo\\" ]; const example = [ \\"1020\\", \\"PEREZ, Juan\\", \\"20-12345678-9\\", \\"juan@email.com\\", \\"3511234567\\", \\"Av Colon 1234\\", \\"VIGILADOR\\", \\"422/05\\", \\"activo\\", \\"01/01/2024\\", \\"Mensual\\", \\"26\\", \\"Planta Industrial\\" ]; const csvString = headers.join(\';\') + \'\\\\n\' + example.join(\';\'); const blob = new Blob([\\"\\\\uFEFF\\" + csvString], { type: \'text/csv;charset=utf-8;\' }); const url = URL.createObjectURL(blob); const link = document.createElement(\\"a\\"); link.href = url; link.setAttribute(\\"download\\", \\"Plantilla_Nomina_CronoApp.csv\\"); document.body.appendChild(link); link.click(); document.body.removeChild(link); };\\n  \\n  const handleProcessCSV = () => { \\n      try { \\n          const parsed = parseCSV(csvContent); \\n          if (parsed.length === 0) { alert(\'Archivo vac铆o o formato desconocido.\'); return; } \\n          \\n          const mapped = parsed.map(row => { \\n              const keys = Object.keys(row); \\n              // Detecci贸n de columnas\\n              const findKey = (variations: string[]) => keys.find(k => variations.some(v => k.toLowerCase().includes(v)));\\n              \\n              let keyApellidoNombre = keys.find(k => k.toLowerCase().includes(\'apellido\') && k.toLowerCase().includes(\'nombre\'));\\n              const keyLegajo = findKey([\'legajo\', \'nro\', \'ficha\']);\\n              const keyDni = findKey([\'dni\', \'doc\', \'documento\', \'cuil\', \'cuit\']);\\n              const keyCat = findKey([\'cat\', \'puesto\', \'cargo\']);\\n              const keyConvenio = findKey([\'convenio\', \'cct\']);\\n              const keyObj = findKey([\'objetivo\', \'cliente\', \'servicio\']);\\n              const keyFecha = findKey([\'fecha\', \'ingreso\', \'alta\']);\\n              const keyEmail = findKey([\'email\', \'correo\']);\\n              const keyPhone = findKey([\'tel\', \'cel\', \'movil\']);\\n              const keyAddr = findKey([\'dir\', \'domicilio\', \'calle\']);\\n              const keyStatus = findKey([\'estado\']);\\n              const keyPeriod = findKey([\'periodo\']);\\n              const keyCycle = findKey([\'ciclo\', \'inicio\']);\\n\\n              let fname = \'Sin Nombre\'; let lname = \'Sin Apellido\'; \\n              if (keyApellidoNombre && row[keyApellidoNombre]) { \\n                  const rawName = row[keyApellidoNombre]; \\n                  if (rawName.includes(\',\')) { \\n                      const parts = rawName.split(\',\'); \\n                      lname = parts[0].trim(); \\n                      fname = parts.length > 1 ? parts[1].trim() : \'-\'; \\n                  } else { \\n                      const parts = rawName.split(\' \'); \\n                      lname = parts[0]; \\n                      fname = parts.slice(1).join(\' \'); \\n                  } \\n              } else {\\n                  const kA = findKey([\'apellido\', \'lastname\']);\\n                  const kN = findKey([\'nombre\', \'firstname\']);\\n                  if (kA && kN) { lname = row[kA]; fname = row[kN]; }\\n              }\\n\\n              let dni = \'\'; let cuilRaw = \'\'; \\n              const possibleCuil = row[keyDni] || \'\'; \\n              if (possibleCuil) { \\n                  cuilRaw = possibleCuil.trim(); \\n                  const clean = possibleCuil.replace(/[^0-9]/g, \'\'); \\n                  if (clean.length === 11) dni = clean.substring(2, 10); else if (clean.length >= 7) dni = clean; \\n              } \\n              \\n              const rawData = { \\n                  firstName: fname, \\n                  lastName: lname, \\n                  dni: dni, \\n                  cuil: cuilRaw, \\n                  fileNumber: row[keyLegajo] || \'\', \\n                  category: keyCat ? row[keyCat] : \'\', \\n                  cct: keyConvenio ? row[keyConvenio] : \'\', \\n                  email: keyEmail ? row[keyEmail] : \'\', \\n                  phone: keyPhone ? row[keyPhone] : \'\', \\n                  address: keyAddr ? row[keyAddr] : \'\', \\n                  status: (keyStatus && row[keyStatus].toLowerCase().includes(\'inact\')) ? \'inactivo\' : \'activo\', \\n                  laborAgreement: keyConvenio ? row[keyConvenio] : \'\', \\n                  startDate: keyFecha ? parseDateString(row[keyFecha]) : \'\', \\n                  periodType: keyPeriod ? row[keyPeriod] : \'Mensual\', \\n                  cycleStartDay: keyCycle ? row[keyCycle] : \'26\', \\n                  preferredObjectiveId: \'\', \\n                  objectiveName: keyObj ? row[keyObj] : \'\' \\n              }; \\n              return createEmployeeObject(rawData, allObjectives); \\n          }).filter(x => x.dni && x.dni.length > 5); \\n          \\n          if (mapped.length === 0) { alert(\'No se encontraron registros v谩lidos (DNI/CUIL).\'); } \\n          else { setImportPreview(mapped); } \\n      } catch(e: any) { \\n          console.error(e); \\n          alert(\'Error: \' + e.message); \\n      } \\n  };\\n\\n  const confirmImport = async () => { setIsImporting(true); try { let count = 0; for (const emp of importPreview) { const existing = employees.find(e => e.dni === emp.dni || (emp.fileNumber && e.fileNumber === emp.fileNumber)); if (existing && existing.id) { await updateDoc(doc(db, \'empleados\', existing.id), emp); } else { await addDoc(collection(db, \'empleados\'), emp); } count++; } await registrarAuditoria(\'IMPORT_EMPLOYEES\', `Importados ${count} registros v铆a CSV`); alert(`Se procesaron ${count} registros correctamente.`); setShowImportModal(false); setImportPreview([]); setCsvContent(\'\'); setFileName(\'\'); loadData(); } catch(e) { console.error(e); alert(\'Error importando\'); } finally { setIsImporting(false); } };\\n\\n  const handleExport = () => {\\n      const headers = [\'Legajo\', \'Apellido\', \'Nombre\', \'DNI\', \'CUIL\', \'Email\', \'Tel茅fono\', \'Convenio\', \'Categor铆a\', \'Objetivo Preferido\', \'Estado\'];\\n      const csvRows = [headers.join(\';\')];\\n\\n      employees.forEach(emp => {\\n          const objName = allObjectives.find(o => o.id === emp.preferredObjectiveId)?.name || \'\';\\n          const row = [\\n              emp.fileNumber,\\n              `\\"${emp.lastName}\\"`,\\n              `\\"${emp.firstName}\\"`,\\n              emp.dni,\\n              emp.cuil,\\n              emp.email,\\n              emp.phone,\\n              `\\"${emp.laborAgreement}\\"`,\\n              `\\"${emp.category}\\"`,\\n              `\\"${objName}\\"`,\\n              emp.status\\n          ];\\n          csvRows.push(row.join(\';\'));\\n      });\\n\\n      const blob = new Blob([csvRows.join(\'\\\\n\')], { type: \'text/csv;charset=utf-8;\' });\\n      const url = URL.createObjectURL(blob);\\n      const link = document.createElement(\'a\');\\n      link.href = url;\\n      link.setAttribute(\'download\', `empleados_${new Date().toISOString().split(\'T\')[0]}.csv`);\\n      document.body.appendChild(link);\\n      link.click();\\n      document.body.removeChild(link);\\n  };\\n  \\n  const handleExportReport = async () => {\\n      setIsExporting(true);\\n      try {\\n          const rows = [];\\n          rows.push([\\"Legajo\\", \\"Apellido\\", \\"Nombre\\", \\"DNI\\", \\"Objetivo\\", \\"Hs Normales\\", \\"Hs Nocturnas\\", \\"Hs 100%\\", \\"Hs 50%\\", \\"Plus Feriado\\", \\"Ausencias (Cant)\\", \\"Llegadas Tarde (Hs)\\", \\"Observaciones\\"].join(\';\'));\\n          const listToExport = selectedEmp ? [selectedEmp] : filteredEmployees;\\n          const objectivesLookup = new Map(allObjectives.map(o => [o.id, o.name]));\\n\\n          for (const emp of listToExport) {\\n              const { start, end } = getCycleDates(currentDate, emp.cycleStartDay ? Number(emp.cycleStartDay) : 26);\\n              const qTurnos = query(collection(db, \'turnos\'), where(\'employeeId\', \'==\', emp.id), where(\'startTime\', \'>=\', Timestamp.fromDate(start)), where(\'startTime\', \'<=\', Timestamp.fromDate(end)));\\n              const turnosSnap = await getDocs(qTurnos);\\n              const turnos = turnosSnap.docs.map(d => d.data());\\n              const qAus = query(collection(db, \'ausencias\'), where(\'employeeId\', \'==\', emp.id));\\n              const ausSnap = await getDocs(qAus);\\n              const activeAbs = ausSnap.docs.map(d=>d.data()).filter((a:any) => new Date(a.startDate) >= start && new Date(a.endDate) <= end);\\n              \\n              let hoursNormal = 0, hoursNight = 0, hours50 = 0, hours100 = 0, hoursHoliday = 0, lateHours = 0;\\n              let empObjName = \'General\';\\n              if (emp.preferredObjectiveId && objectivesLookup.has(emp.preferredObjectiveId)) empObjName = objectivesLookup.get(emp.preferredObjectiveId);\\n\\n              const ruleBase = agreements.find(a => a.name === emp.laborAgreement) || initialAgreement;\\n              const rule = { ...ruleBase, nightShiftStart: ruleBase.nightShiftStart || 21, nightShiftEnd: ruleBase.nightShiftEnd || 6 };\\n\\n              turnos.forEach((t:any) => {\\n                  if (t.status === \'Canceled\' || t.type === \'NOVEDAD\') return;\\n                  const s = t.startTime.toDate();\\n                  const e = t.endTime.toDate();\\n                  let dur = (e.getTime() - s.getTime()) / 3600000;\\n                  if (t.isLate && t.realStartTime) { const realStart = t.realStartTime.toDate(); const lateDiff = (realStart.getTime() - s.getTime()) / 3600000; if (lateDiff > 0) lateHours += lateDiff; }\\n                  const night = getNightDuration(s, e, rule.nightShiftStart, rule.nightShiftEnd);\\n                  hoursNight += night;\\n                  if (t.isFrancoTrabajado || t.code === \'FT\') hours100 += dur; else hoursNormal += dur;\\n                  const dStr = getArgentinaDate(t.startTime);\\n                  if (holidays.some(h => h.date === dStr)) hoursHoliday += dur;\\n              });\\n\\n              const obs = [...activeAbs.map((a:any) => `Aus: ${a.type}`), ...turnos.filter((t:any) => t.extensionNote).map((t:any) => `Ext: ${t.extensionNote}`), ...turnos.filter((t:any) => t.entryNote).map((t:any) => `Adel: ${t.entryNote}`)].join(\' | \');\\n              rows.push([emp.fileNumber || \'-\', emp.lastName, emp.firstName, emp.dni, empObjName, hoursNormal.toFixed(2), hoursNight.toFixed(2), hours100.toFixed(2), hours50.toFixed(2), hoursHoliday.toFixed(2), activeAbs.length, lateHours.toFixed(2), `\\"${obs}\\"`].join(\';\'));\\n          }\\n          const blob = new Blob([\\"\\\\uFEFF\\" + rows.join(\'\\\\n\')], { type: \'text/csv;charset=utf-8;\' });\\n          const url = URL.createObjectURL(blob);\\n          const link = document.createElement(\\"a\\");\\n          link.href = url;\\n          link.setAttribute(\\"download\\", `Reporte_RRHH_${selectedEmp ? selectedEmp.lastName : \'Nomina\'}_${currentDate.toISOString().slice(0,7)}.csv`);\\n          document.body.appendChild(link);\\n          link.click();\\n          document.body.removeChild(link);\\n          await registrarAuditoria(\'EXPORT_REPORT\', `Reporte generado: ${selectedEmp ? \'Individual\' : \'N贸mina Completa\'}`);\\n      } catch (e) { addToast(\'Error generando reporte\', \'error\'); } finally { setIsExporting(false); }\\n  };\\n\\n  return (\\n    <DashboardLayout>\\n        {/* --- CONTENIDO PRINCIPAL --- */}\\n        <div className=\\"max-w-full mx-auto space-y-6 animate-in fade-in h-[calc(100vh-100px)] flex flex-col print:hidden\\">\\n            <header className=\\"flex flex-col gap-4 shrink-0 p-1\\">\\n                <div className=\\"flex justify-between items-end\\">\\n                    <div>\\n                        <h1 className=\\"text-3xl font-black text-slate-900 dark:text-white uppercase\\">Gesti贸n RRHH</h1>\\n                        <p className=\\"text-slate-500 text-sm font-medium\\">Personal, Novedades y Reglas.</p>\\n                        <p className=\\"text-[10px] text-indigo-500 mt-1\\">Usuario Activo: <b>{currentUserName}</b></p>\\n                    </div>\\n                    <div className=\\"flex gap-2\\">\\n                        {activeTab === \'legajos\' && view === \'list\' && (\\n                            <>\\n                                <button onClick={() => window.print()} className=\\"bg-slate-700 text-white px-4 py-3 rounded-xl font-black text-xs uppercase shadow-lg flex gap-2 hover:bg-slate-800 transition-colors\\">\\n                                    <Printer size={16}/> Imprimir PDF\\n                                </button>\\n                                <button onClick={handleExport} className=\\"bg-emerald-600 text-white px-4 py-3 rounded-xl font-black text-xs uppercase shadow-lg flex gap-2 hover:bg-emerald-700 transition-colors\\">\\n                                    <FileDown size={16}/> Exportar\\n                                </button>\\n                                <button onClick={() => setShowImportModal(true)} className=\\"bg-slate-800 text-white px-4 py-3 rounded-xl font-black text-xs uppercase shadow-lg flex gap-2 hover:bg-slate-700 transition-colors\\"><FileSpreadsheet size={16}/> Importar</button>\\n                                <button onClick={openNew} className=\\"bg-indigo-600 text-white px-4 py-3 rounded-xl font-black text-xs uppercase shadow-lg flex gap-2 hover:bg-indigo-700 transition-colors\\"><Plus size={16}/> Nuevo</button>\\n                            </>\\n                        )}\\n                        {activeTab === \'ausencias\' && <button onClick={() => handleOpenAbsenceModal()} className=\\"bg-rose-600 text-white px-6 py-3 rounded-xl font-black text-xs uppercase shadow-lg flex gap-2\\"><Plus size={16}/> Nueva Novedad</button>}\\n                    </div>\\n                </div>\\n                <div className=\\"flex gap-2 border-b dark:border-slate-700\\">\\n                    {[\'legajos\', \'ausencias\', \'feriados\', \'convenios\'].map(tab => (\\n                        <button key={tab} onClick={() => { setActiveTab(tab as any); setView(\'list\'); }} className={`px-6 py-3 font-black text-xs uppercase border-b-4 transition-all ${activeTab === tab ? (tab === \'legajos\' ? \'border-indigo-600 text-indigo-600\' : tab === \'ausencias\' ? \'border-rose-500 text-rose-500\' : tab === \'feriados\' ? \'border-emerald-500 text-emerald-500\' : \'border-amber-500 text-amber-500\') : \'border-transparent text-slate-400 hover:text-slate-600\'}`}>{tab}</button>\\n                    ))}\\n                </div>\\n            </header>\\n\\n            {/* SECCIONES DEL DASHBOARD */}\\n            {activeTab === \'legajos\' && view === \'list\' && (\\n                <div className=\\"flex-1 flex gap-6 overflow-hidden relative\\">\\n                    <div className=\\"w-[400px] bg-white dark:bg-slate-800 rounded-[2rem] border dark:border-slate-700 shadow-sm flex flex-col overflow-hidden shrink-0\\">\\n                        <div className=\\"p-4 border-b dark:border-slate-700 flex flex-col gap-4 bg-slate-50/50 dark:bg-slate-800/50\\">\\n                            <div className=\\"flex items-center gap-2 bg-white dark:bg-slate-900 px-4 py-2 rounded-xl border dark:border-slate-700\\">\\n                                <Search size={16} className=\\"text-slate-400\\"/><input placeholder=\\"Buscar...\\" className=\\"bg-transparent outline-none w-full text-sm font-bold text-slate-900 dark:text-white\\" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/>\\n                            </div>\\n                            <div className=\\"flex justify-between items-center\\">\\n                                <div className=\\"flex items-center gap-2 bg-white dark:bg-slate-900 px-2 py-1 rounded-xl border dark:border-slate-700\\"><button onClick={() => changeMonth(-1)} className=\\"p-1 hover:bg-slate-100 rounded-lg\\"><ChevronLeft size={14}/></button><span className=\\"text-[10px] font-black uppercase w-20 text-center\\">{currentDate.toLocaleString(\'es-ES\', { month: \'short\', year: \'2-digit\' })}</span><button onClick={() => changeMonth(1)} className=\\"p-1 hover:bg-slate-100 rounded-lg\\"><ChevronRight size={14}/></button></div>\\n                                {employees.length > 0 && <button onClick={handleDeleteAll} disabled={isDeletingAll} className=\\"text-rose-500 hover:bg-rose-50 px-3 py-1 rounded-lg text-[10px] font-black uppercase transition-colors\\">{isDeletingAll ? \'...\' : \'Borrar Todo\'}</button>}\\n                            </div>\\n                        </div>\\n                        <div className=\\"flex-1 overflow-auto custom-scrollbar\\"><div className=\\"divide-y divide-slate-100 dark:divide-slate-700\\">{filteredEmployees.map(emp => (<div key={emp.id} onClick={() => handleRowClick(emp)} className={`p-4 cursor-pointer transition-colors border-l-4 ${selectedEmp?.id === emp.id ? \'bg-indigo-50 dark:bg-indigo-900/20 border-l-indigo-500\' : \'hover:bg-slate-50 dark:hover:bg-slate-700/50 border-l-transparent\'}`}><div className=\\"flex items-center gap-3\\"><div className={`w-10 h-10 rounded-full flex items-center justify-center font-black text-xs shadow-sm ${selectedEmp?.id === emp.id ? \'bg-indigo-600 text-white\' : \'bg-slate-100 text-slate-500\'}`}>{emp.lastName?.[0]}</div><div className=\\"flex-1 min-w-0\\"><p className={`font-bold text-sm uppercase truncate ${selectedEmp?.id === emp.id ? \'text-indigo-700 dark:text-indigo-300\' : \'text-slate-900 dark:text-white\'}`}>{emp.lastName}, {emp.firstName}</p><div className=\\"flex items-center gap-2 mt-0.5\\"><span className=\\"text-[10px] bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-slate-500 font-mono\\">{emp.fileNumber || \'S/L\'}</span><span className=\\"text-[10px] text-slate-400 truncate\\">{emp.category}</span></div></div><ChevronRight size={16} className={`text-slate-300 ${selectedEmp?.id === emp.id ? \'text-indigo-400\' : \'\'}`}/></div></div>))}{filteredEmployees.length === 0 && <div className=\\"p-8 text-center text-slate-400 text-xs font-medium\\">No se encontraron empleados.</div>}</div></div>\\n                    </div>\\n                    <div className=\\"flex-1 bg-white dark:bg-slate-800 rounded-[2rem] border dark:border-slate-700 shadow-sm flex flex-col overflow-hidden relative\\">\\n                        {selectedEmp ? (\\n                            <div className=\\"h-full flex flex-col animate-in fade-in\\">\\n                                <div className=\\"p-6 border-b dark:border-slate-700 bg-slate-50 dark:bg-slate-900 flex justify-between items-start\\">\\n                                    <div className=\\"flex gap-4\\"><div className=\\"w-20 h-20 rounded-3xl bg-indigo-600 flex items-center justify-center text-3xl font-black text-white shadow-lg shadow-indigo-500/30\\">{selectedEmp.lastName?.[0]}</div><div><h2 className=\\"text-2xl font-black uppercase text-slate-900 dark:text-white\\">{selectedEmp.lastName}, {selectedEmp.firstName}</h2><div className=\\"flex items-center gap-3 mt-1 text-sm font-bold text-slate-500\\"><span className=\\"bg-white dark:bg-slate-800 px-2 py-1 rounded border dark:border-slate-700\\">{selectedEmp.laborAgreement}</span><span className=\\"text-slate-300\\">|</span><span>{selectedEmp.cuil}</span></div></div></div>\\n                                    <div className=\\"flex gap-2\\"><button onClick={() => handleDelete(selectedEmp.id!)} className=\\"p-2 text-rose-500 hover:bg-rose-50 rounded-lg transition-colors\\"><Trash2 size={20}/></button><button onClick={() => setSelectedEmp(null)} className=\\"p-2 text-slate-400 hover:bg-slate-200 rounded-lg transition-colors\\"><X size={20}/></button></div>\\n                                </div>\\n                                <div className=\\"flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6\\">\\n                                    <div className=\\"grid grid-cols-2 gap-4\\">\\n                                         <div className=\\"p-4 border rounded-xl\\"><p className=\\"text-[10px] text-slate-400 font-bold uppercase\\">Objetivo Preferido</p><p className=\\"font-bold\\">{allObjectives.find(o=>o.id===selectedEmp.preferredObjectiveId)?.name || (selectedEmp.preferredObjectiveId ? `ID: ${selectedEmp.preferredObjectiveId}` : \'Sin asignar\')}</p></div>\\n                                         <div className=\\"p-4 border rounded-xl\\"><p className=\\"text-[10px] text-slate-400 font-bold uppercase\\">Contacto</p><p className=\\"font-bold\\">{selectedEmp.phone || \'-\'}</p></div>\\n                                         {/* --- BLOQUE DE DIRECCION Y MAPA --- */}\\n                                         <div className=\\"col-span-2 p-4 border rounded-xl flex items-center justify-between\\">\\n                                             <div><p className=\\"text-[10px] text-slate-400 font-bold uppercase\\">Direcci贸n</p><p className=\\"font-bold\\">{selectedEmp.address || \'Sin direcci贸n\'}</p></div>\\n                                             {selectedEmp.lat && selectedEmp.lng ? (\\n                                                 <a href={`https://www.google.com/maps/search/?api=1&query=${selectedEmp.lat},${selectedEmp.lng}`} target=\\"_blank\\" rel=\\"noreferrer\\" className=\\"flex items-center gap-2 text-indigo-600 font-bold text-xs bg-indigo-50 px-4 py-2 rounded-lg hover:bg-indigo-100 transition-colors\\"><MapPin size={16}/> Ver Ubicaci贸n</a>\\n                                             ) : <span className=\\"text-xs text-slate-300 italic\\">No geolocalizado</span>}\\n                                         </div>\\n                                    </div>\\n                                    {empStats ? (\\n                                        <div className=\\"space-y-4 max-w-3xl mx-auto\\">\\n                                            <div className={`bg-slate-900 text-white p-6 rounded-3xl shadow-lg relative overflow-hidden ${empStats.isOverLimit ? \'ring-4 ring-rose-500\' : \'\'}`}>{empStats.isOverLimit && <div className=\\"absolute top-0 left-0 w-full bg-rose-600 text-white text-[10px] font-black uppercase text-center py-1 animate-pulse\\">隆L铆mite Mensual Excedido!</div>}<div className=\\"absolute top-0 right-0 p-4 opacity-10\\"><BarChart2 size={64}/></div><div className=\\"grid grid-cols-2 gap-8 relative z-10\\"><div><p className=\\"text-[10px] font-black uppercase text-indigo-200 mb-1\\">Total Planificado</p><div className=\\"flex items-baseline gap-2\\"><span className=\\"text-5xl font-black\\">{empStats.totalPlanificado}h</span><span className=\\"text-sm font-medium text-slate-400\\">/ {empStats.monthlyLimit}h</span></div><div className=\\"w-full h-2 bg-slate-800 rounded-full mt-4\\"><div className={`h-full rounded-full ${empStats.isOverLimit ? \'bg-rose-500\' : \'bg-emerald-400\'}`} style={{ width: `${Math.min(empStats.progress, 100)}%` }}/></div></div><div className=\\"flex flex-col justify-center gap-2\\"><div className=\\"flex justify-between items-center bg-white/5 p-3 rounded-xl\\"><span className=\\"text-xs font-bold text-slate-300\\">Realizado</span><span className=\\"font-black text-xl\\">{empStats.totalRealizado}h</span></div><div className=\\"flex justify-between items-center bg-white/5 p-3 rounded-xl\\"><span className=\\"text-xs font-bold text-slate-300\\">Objetivos</span><span className=\\"font-black text-xl\\">{empStats.shiftsCount}</span></div></div></div></div>\\n                                            <div className=\\"grid grid-cols-1 md:grid-cols-4 gap-4\\"><div className=\\"bg-emerald-50 p-5 rounded-2xl border border-emerald-100 flex items-center justify-between\\"><div><p className=\\"text-emerald-700 font-bold text-sm\\">Francos</p><p className=\\"text-2xl font-black text-emerald-800\\">{empStats.francosCount}</p></div><Coffee size={24} className=\\"text-emerald-300\\"/></div><div className=\\"bg-teal-50 p-5 rounded-2xl border border-teal-100 flex items-center justify-between\\"><div><p className=\\"text-teal-700 font-bold text-sm\\">Vacaciones</p><p className=\\"text-2xl font-black text-teal-800\\">{empStats.vacationsCount || 0}</p></div><Activity size={24} className=\\"text-teal-300\\"/></div><div className=\\"bg-purple-50 p-5 rounded-2xl border border-purple-100 flex items-center justify-between\\"><div><p className=\\"text-purple-700 font-bold text-sm\\">Licencias</p><p className=\\"text-2xl font-black text-purple-800\\">{empStats.licensesCount || 0}</p></div><FileText size={24} className=\\"text-purple-300\\"/></div><div className=\\"bg-rose-50 p-5 rounded-2xl border border-rose-100 flex items-center justify-between\\"><div><p className=\\"text-rose-700 font-bold text-sm\\">Ausencias</p><p className=\\"text-2xl font-black text-rose-800\\">{empStats.absencesCount}</p></div><AlertOctagon size={24} className=\\"text-rose-300\\"/></div></div>\\n                                            <div className=\\"grid grid-cols-2 md:grid-cols-5 gap-3\\"><div className=\\"bg-slate-50 p-4 rounded-xl border text-center\\"><p className=\\"text-[10px] uppercase font-black text-slate-400\\">Diurnas</p><p className=\\"text-xl font-black\\">{empStats.dayHours}h</p></div><div className=\\"bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-center\\"><p className=\\"text-[10px] uppercase font-black text-indigo-400\\">Nocturnas</p><p className=\\"text-xl font-black text-indigo-700\\">{empStats.nightHours}h</p></div><div className=\\"bg-emerald-50 p-4 rounded-xl border border-emerald-100 text-center\\"><p className=\\"text-[10px] uppercase font-black text-emerald-600\\">Extra 50%</p><p className=\\"text-xl font-black text-emerald-700\\">{empStats.extra50}h</p></div><div className=\\"bg-rose-50 p-4 rounded-xl border border-rose-100 text-center\\"><p className=\\"text-[10px] uppercase font-black text-rose-600\\">Extra 100%</p><p className=\\"text-xl font-black text-rose-700\\">{empStats.extra100}h</p></div><div className=\\"bg-amber-50 p-4 rounded-xl border border-amber-100 text-center\\"><p className=\\"text-[10px] uppercase font-black text-amber-600\\">Plus Feriado</p><p className=\\"text-xl font-black text-amber-700\\">{empStats.plusFeriado || 0}h</p></div></div>\\n                                            <div className=\\"bg-slate-50 dark:bg-slate-900 rounded-2xl border dark:border-slate-700 overflow-hidden\\"><div className=\\"px-4 py-3 bg-slate-100 dark:bg-slate-950 border-b dark:border-slate-700 text-xs font-black uppercase text-slate-500\\">Desglose por Objetivo</div>{empStats.objectives.map((o:any,i:number)=>(<div key={i} className=\\"flex justify-between items-center p-4 border-b dark:border-slate-700/50 last:border-0 hover:bg-white dark:hover:bg-slate-800 transition-colors\\"><div className=\\"flex items-center gap-3\\"><div className=\\"w-2 h-2 rounded-full bg-indigo-500\\"></div><span className=\\"text-sm font-bold text-slate-700 dark:text-slate-300 uppercase\\">{o.name}</span></div><span className=\\"text-sm font-black text-slate-900 dark:text-white bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded\\">{Math.round(o.hours)}h</span></div>))}{empStats.objectives.length === 0 && <div className=\\"p-4 text-center text-slate-400 text-xs\\">Sin asignaciones este mes.</div>}</div>\\n                                        </div>\\n                                    ) : <div className=\\"flex h-40 items-center justify-center text-slate-400 font-bold animate-pulse\\">Calculando m茅tricas...</div>}\\n                                </div>\\n                                <div className=\\"p-6 border-t dark:border-slate-700 bg-white dark:bg-slate-800\\"><button onClick={openEditFromDetail} className=\\"w-full py-4 bg-slate-900 dark:bg-white dark:text-slate-900 text-white rounded-xl font-black uppercase text-sm hover:scale-[1.02] transition-transform shadow-xl flex items-center justify-center gap-2\\"><Edit2 size={18}/> Editar Datos del Legajo</button></div>\\n                            </div>\\n                        ) : (\\n                            <div className=\\"h-full flex flex-col p-8 animate-in fade-in\\"><h2 className=\\"text-2xl font-black text-slate-800 dark:text-white mb-6 uppercase flex items-center gap-3\\"><Activity className=\\"text-indigo-500\\"/> Resumen Global RRHH</h2><div className=\\"grid grid-cols-2 gap-6 mb-8\\"><div className=\\"bg-indigo-600 text-white p-6 rounded-3xl shadow-xl shadow-indigo-500/20\\"><p className=\\"text-xs font-black uppercase text-indigo-200 mb-2\\">Total N贸mina</p><div className=\\"flex items-center gap-4\\"><Users size={40} className=\\"text-indigo-300\\"/><span className=\\"text-5xl font-black\\">{globalStats.totalEmployees}</span></div></div><div className=\\"bg-white dark:bg-slate-900 border p-6 rounded-3xl shadow-sm\\"><p className=\\"text-xs font-black uppercase text-rose-500 mb-2\\">Novedades Activas</p><div className=\\"flex items-center gap-4\\"><AlertTriangle size={40} className=\\"text-rose-200\\"/><span className=\\"text-5xl font-black text-rose-600\\">{globalStats.activeAbsences}</span></div></div></div><div className=\\"grid grid-cols-3 gap-4\\"><div className=\\"p-4 bg-slate-50 dark:bg-slate-900 rounded-2xl border text-center\\"><Calendar className=\\"mx-auto mb-2 text-slate-400\\"/><p className=\\"text-2xl font-black text-slate-700 dark:text-white\\">{globalStats.nextHolidays}</p><p className=\\"text-[10px] font-bold uppercase text-slate-400\\">Pr贸ximos Feriados</p></div><div className=\\"p-4 bg-slate-50 dark:bg-slate-900 rounded-2xl border text-center\\"><FileText className=\\"mx-auto mb-2 text-slate-400\\"/><p className=\\"text-2xl font-black text-slate-700 dark:text-white\\">{agreements.length}</p><p className=\\"text-[10px] font-bold uppercase text-slate-400\\">Convenios Activos</p></div><div className=\\"p-4 bg-slate-50 dark:bg-slate-900 rounded-2xl border text-center\\"><Briefcase className=\\"mx-auto mb-2 text-slate-400\\"/><p className=\\"text-2xl font-black text-slate-700 dark:text-white\\">{clients.length}</p><p className=\\"text-[10px] font-bold uppercase text-slate-400\\">Clientes Activos</p></div></div><div className=\\"mt-auto pt-8 text-center text-slate-300 text-sm font-medium\\">Seleccione un empleado del listado lateral para ver su detalle individual.</div></div>\\n                        )}\\n                    </div>\\n                </div>\\n            )}\\n\\n            {activeTab === \'legajos\' && view === \'form\' && (\\n                <div className=\\"flex-1 bg-white dark:bg-slate-800 rounded-[2rem] border dark:border-slate-700 shadow-sm p-8 animate-in slide-in-from-right-10 overflow-y-auto\\">\\n                    <div className=\\"flex justify-between items-center mb-8\\"><div className=\\"flex items-center gap-4\\"><button onClick={() => setView(\'list\')} className=\\"p-2 hover:bg-slate-100 rounded-full transition-colors\\"><ArrowLeft/></button><h2 className=\\"text-2xl font-black uppercase dark:text-white\\">{isEditing ? `Editar: ${form.lastName}` : \'Nuevo Legajo\'}</h2></div><div className=\\"flex gap-2\\">{[\'PERSONAL\', \'LABORAL\', \'TALLES\'].map(tab => (<button key={tab} onClick={() => setActiveFormTab(tab as any)} className={`px-4 py-2 rounded-lg text-xs font-black uppercase transition-all ${activeFormTab === tab ? \'bg-indigo-600 text-white shadow-lg\' : \'bg-slate-100 text-slate-400\'}`}>{tab}</button>))}</div></div>\\n                    <div className=\\"max-w-4xl mx-auto space-y-8\\">\\n                        {activeFormTab === \'PERSONAL\' && (<div className=\\"grid grid-cols-2 gap-6\\"><div><label className={labelClass}>Nombre</label><input className={inputClass} value={form.firstName || \'\'} onChange={e => setForm({...form, firstName: e.target.value})} /></div><div><label className={labelClass}>Apellido</label><input className={inputClass} value={form.lastName || \'\'} onChange={e => setForm({...form, lastName: e.target.value})} /></div><div><label className={labelClass}>DNI</label><input className={inputClass} value={form.dni || \'\'} onChange={e => setForm({...form, dni: e.target.value})} /></div><div><label className={labelClass}>CUIL</label><input className={inputClass} value={form.cuil || \'\'} onChange={e => setForm({...form, cuil: e.target.value})} /></div><div><label className={labelClass}>Email</label><input className={inputClass} value={form.email || \'\'} onChange={e => setForm({...form, email: e.target.value})} /></div><div><label className={labelClass}>Tel茅fono</label><input className={inputClass} value={form.phone || \'\'} onChange={e => setForm({...form, phone: e.target.value})} /></div>\\n                        {/* --- CAMPO DIRECCION Y GEOLOCALIZACION --- */}\\n                        <div className=\\"col-span-2\\"><label className={labelClass}>Direcci贸n</label><div className=\\"flex gap-2\\"><input className={inputClass} value={form.address || \'\'} onChange={e => setForm({...form, address: e.target.value})} placeholder=\\"Calle, N煤mero, Localidad\\"/><button onClick={handleGeocode} disabled={isGeocoding} className=\\"px-4 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-bold uppercase text-xs flex items-center gap-2 transition-colors\\">{isGeocoding ? \'...\' : <><MapPin size={16}/> Geolocalizar</>}</button></div><p className=\\"text-[10px] text-slate-400 mt-1 ml-1\\">{form.lat ? `Ubicaci贸n guardada: ${form.lat}, ${form.lng}` : \'Sin coordenadas\'}</p></div></div>)}\\n                        {activeFormTab === \'LABORAL\' && (<div className=\\"grid grid-cols-2 gap-6\\"><div><label className={labelClass}>Legajo N潞</label><input className={inputClass} value={form.fileNumber || \'\'} onChange={e => setForm({...form, fileNumber: e.target.value})} /></div><div><label className={labelClass}>Fecha Ingreso</label><input type=\\"date\\" className={inputClass} value={form.startDate || \'\'} onChange={e => setForm({...form, startDate: e.target.value})} /></div><div><label className={labelClass}>Convenio</label><select className={selectClass} value={form.laborAgreement || \'\'} onChange={e => setForm({...form, laborAgreement: e.target.value})}><option value=\\"\\">Seleccionar...</option>{agreements.map(a => <option key={a.id} value={a.name}>{a.name}</option>)}</select></div><div><label className={labelClass}>Categor铆a</label><select className={selectClass} value={form.category || \'\'} onChange={e => setForm({...form, category: e.target.value})}><option value=\\"\\">Seleccionar...</option>{availableCategories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>\\n                        <div><label className={labelClass}>Objetivo Preferido</label><select className={selectClass} value={form.preferredObjectiveId || \'\'} onChange={e => setForm({...form, preferredObjectiveId: e.target.value})}><option value=\\"\\">Ninguno</option>{allObjectives.map(obj => <option key={obj.id} value={obj.id}>{obj.name}</option>)}</select></div>\\n                        <div><label className={labelClass}>Inicio Ciclo Liquidaci贸n (D铆a)</label><input type=\\"number\\" min=\\"1\\" max=\\"31\\" className={inputClass} value={form.cycleStartDay || 26} onChange={e => setForm({...form, cycleStartDay: parseInt(e.target.value)})} placeholder=\\"Ej: 26\\"/></div><div><label className={labelClass}>Estado</label><select className={selectClass} value={form.status || \'activo\'} onChange={e => setForm({...form, status: e.target.value})}><option value=\\"activo\\">Activo</option><option value=\\"inactivo\\">Inactivo</option></select></div></div>)}\\n                        {activeFormTab === \'TALLES\' && (<div className=\\"grid grid-cols-3 gap-6\\"><div><label className={labelClass}>Camisa/Remera</label><input className={inputClass} value={form.sizes?.shirt || \'\'} onChange={e => setForm({...form, sizes: {...form.sizes, shirt: e.target.value}})} /></div><div><label className={labelClass}>Pantal贸n</label><input className={inputClass} value={form.sizes?.pants || \'\'} onChange={e => setForm({...form, sizes: {...form.sizes, pants: e.target.value}})} /></div><div><label className={labelClass}>Calzado</label><input className={inputClass} value={form.sizes?.shoes || \'\'} onChange={e => setForm({...form, sizes: {...form.sizes, shoes: e.target.value}})} /></div></div>)}\\n                        <div className=\\"pt-8 border-t dark:border-slate-700 flex justify-end gap-4\\"><button onClick={() => setView(\'list\')} className=\\"px-6 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold uppercase text-xs\\">Cancelar</button><button onClick={handleSave} className=\\"px-8 py-3 bg-indigo-600 text-white rounded-xl font-black uppercase text-xs shadow-lg hover:bg-indigo-700 transition-transform hover:scale-105\\">Guardar Cambios</button></div>\\n                    </div>\\n                </div>\\n            )}\\n\\n            {/* OTROS TABS (AUSENCIAS, FERIADOS, CONVENIOS - SIN CAMBIOS) */}\\n            {activeTab === \'feriados\' && (<div className=\\"flex-1 flex gap-6 overflow-hidden\\"><div className=\\"w-1/3 bg-white dark:bg-slate-800 rounded-[2rem] border dark:border-slate-700 p-6\\"><h3 className=\\"text-lg font-black text-slate-900 dark:text-white uppercase mb-4\\">Gesti贸n Feriados</h3><div className=\\"bg-indigo-50 dark:bg-indigo-900/30 p-4 rounded-2xl border border-indigo-100 dark:border-indigo-800 mb-6\\"><label className=\\"text-[10px] font-black uppercase text-indigo-600 mb-2 block\\">Importar Oficiales</label><div className=\\"flex gap-2\\"><select className={selectClass} value={syncYear} onChange={e => setSyncYear(parseInt(e.target.value))}><option value={2024}>2024</option><option value={2025}>2025</option><option value={2026}>2026</option></select><button onClick={handleSyncHolidays} disabled={isSyncing} className=\\"flex-1 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase flex items-center justify-center gap-2 hover:bg-indigo-700 transition-colors\\">{isSyncing ? \'...\' : <><Download size={14}/> Sincronizar</>}</button></div></div><div className=\\"space-y-4 pt-4 border-t dark:border-slate-700\\"><p className=\\"text-[10px] font-black uppercase text-slate-400\\">Carga Manual</p><input className={inputClass} value={holidayForm.name} onChange={e => setHolidayForm({...holidayForm, name: e.target.value})} placeholder=\\"Nombre del Feriado\\"/><input type=\\"date\\" className={inputClass} value={holidayForm.date} onChange={e => setHolidayForm({...holidayForm, date: e.target.value})}/><button onClick={handleSaveHoliday} className=\\"w-full bg-slate-900 text-white py-3 rounded-xl font-black uppercase text-xs\\">Guardar Manual</button></div></div><div className=\\"flex-1 bg-white dark:bg-slate-800 rounded-[2rem] border dark:border-slate-700 p-6 overflow-auto custom-scrollbar\\"><div className=\\"grid grid-cols-1 gap-3\\">{holidays.map(h => (<div key={h.id} className=\\"flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border dark:border-slate-700\\"><div className=\\"flex items-center gap-4\\"><Calendar size={20} className=\\"text-indigo-500\\"/><div><p className=\\"font-black dark:text-white uppercase\\">{h.name}</p><p className=\\"text-xs font-mono text-slate-500\\">{new Date(h.date + \'T00:00:00\').toLocaleDateString()}</p></div></div><button onClick={() => handleDeleteHoliday(h.id!)} className=\\"text-slate-400 hover:text-rose-500\\"><X size={20}/></button></div>))}</div></div></div>)}\\n            {activeTab === \'convenios\' && (<div className=\\"flex-1 flex gap-6 overflow-hidden\\"><div className=\\"w-1/3 bg-white dark:bg-slate-800 rounded-[2rem] border dark:border-slate-700 p-6 overflow-y-auto\\"><h3 className=\\"text-lg font-black text-slate-900 dark:text-white uppercase mb-4 flex items-center gap-2\\">{isEditingAgreement ? <Edit2 size={18}/> : <Book size={18}/>} {isEditingAgreement ? \'Editar\' : \'Nuevo\'} Convenio</h3><div className=\\"space-y-4\\"><div><label className={labelClass}>Nombre</label><input className={inputClass} value={agreementForm.name} onChange={e => setAgreementForm({...agreementForm, name: e.target.value})}/></div><div className=\\"grid grid-cols-2 gap-4\\"><div><label className={labelClass}>Semanal (hs)</label><input type=\\"number\\" className={inputClass} value={agreementForm.maxHoursWeekly} onChange={e => setAgreementForm({...agreementForm, maxHoursWeekly: parseInt(e.target.value)})}/></div><div><label className={labelClass}>Mensual (hs)</label><input type=\\"number\\" className={inputClass} value={agreementForm.maxHoursMonthly} onChange={e => setAgreementForm({...agreementForm, maxHoursMonthly: parseInt(e.target.value)})}/></div></div><div className=\\"bg-slate-50 dark:bg-slate-900 p-3 rounded-xl border dark:border-slate-700\\"><label className={labelClass}>S谩bados > 13hs</label><div className=\\"flex gap-2\\"><button onClick={() => setAgreementForm({...agreementForm, saturdayRate: 0})} className={`flex-1 py-2 rounded-lg text-[10px] font-black ${agreementForm.saturdayRate === 0 ? \'bg-indigo-600 text-white\' : \'bg-white dark:bg-slate-800 text-slate-400\'}`}>NORMAL</button><button onClick={() => setAgreementForm({...agreementForm, saturdayRate: 50})} className={`flex-1 py-2 rounded-lg text-[10px] font-black ${agreementForm.saturdayRate === 50 ? \'bg-emerald-500 text-white\' : \'bg-white dark:bg-slate-800 text-slate-400\'}`}>50%</button><button onClick={() => setAgreementForm({...agreementForm, saturdayRate: 100})} className={`flex-1 py-2 rounded-lg text-[10px] font-black ${agreementForm.saturdayRate === 100 ? \'bg-rose-500 text-white\' : \'bg-white dark:bg-slate-800 text-slate-400\'}`}>100%</button></div></div><div className=\\"space-y-2\\"><div className=\\"flex items-center gap-2\\"><input type=\\"checkbox\\" checked={agreementForm.paysDoubleOnFranco} onChange={e => setAgreementForm({...agreementForm, paysDoubleOnFranco: e.target.checked})}/><span className=\\"text-xs font-bold dark:text-white\\">Paga Franco Trabajado 100%</span></div><div className=\\"flex items-center gap-2\\"><input type=\\"checkbox\\" checked={agreementForm.holidayIsPlus} onChange={e => setAgreementForm({...agreementForm, holidayIsPlus: e.target.checked})}/><span className=\\"text-xs font-bold dark:text-white text-emerald-600\\">Feriados se pagan como PLUS</span></div><div className=\\"flex items-center gap-2\\"><input type=\\"checkbox\\" checked={agreementForm.sundayIs100} onChange={e => setAgreementForm({...agreementForm, sundayIs100: e.target.checked})}/><span className=\\"text-xs font-bold dark:text-white\\">Domingos al 100%</span></div></div><div className=\\"bg-slate-50 dark:bg-slate-900 p-3 rounded-xl border dark:border-slate-700\\"><label className={labelClass}>Categor铆as</label><div className=\\"flex gap-2 mb-2\\"><input className=\\"flex-1 p-2 bg-white dark:bg-slate-800 rounded-lg text-xs text-slate-900 dark:text-white\\" value={newCategory} onChange={e => setNewCategory(e.target.value)} placeholder=\\"Ej: Vigilador\\"/><button onClick={handleAddCategory} className=\\"p-2 bg-indigo-100 text-indigo-600 rounded-lg\\"><Plus size={14}/></button></div><div className=\\"flex flex-wrap gap-2\\">{agreementForm.categories.map((c, idx) => (<span key={idx} className=\\"px-2 py-1 bg-white dark:bg-slate-800 rounded-lg text-[10px] font-bold border dark:border-slate-600 flex items-center gap-1\\">{c} <button onClick={() => removeCategory(idx)} className=\\"text-rose-500\\"><X size={10}/></button></span>))}</div></div><div className=\\"flex gap-2\\">{isEditingAgreement && <button onClick={() => { setIsEditingAgreement(false); setAgreementForm(initialAgreement); }} className=\\"px-4 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold text-xs uppercase\\">Cancelar</button>}<button onClick={handleSaveAgreement} className=\\"flex-1 bg-amber-500 text-white py-3 rounded-xl font-black uppercase text-xs\\">Guardar</button></div></div></div><div className=\\"flex-1 bg-white dark:bg-slate-800 rounded-[2rem] border dark:border-slate-700 p-6 overflow-auto custom-scrollbar\\"><div className=\\"grid grid-cols-1 md:grid-cols-2 gap-3\\">{agreements.map(a => (<div key={a.id} className=\\"p-5 bg-slate-50 dark:bg-slate-900 rounded-[2rem] border dark:border-slate-700 relative group\\"><div className=\\"absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity\\"><button onClick={() => handleEditAgreement(a)} className=\\"text-slate-300 hover:text-indigo-500\\"><Edit2 size={18}/></button><button onClick={() => handleDeleteAgreement(a.id!)} className=\\"text-slate-300 hover:text-rose-500\\"><Trash2 size={18}/></button></div><h3 className=\\"font-black text-slate-800 dark:text-white uppercase mb-2\\">{a.name}</h3><div className=\\"space-y-1 text-xs text-slate-500\\"><p>Semanal: {a.maxHoursWeekly}hs | Mensual: {a.maxHoursMonthly}hs</p><p>S谩bado > 13hs: <span className=\\"font-bold text-indigo-500\\">{a.saturdayRate === 0 ? \'Normal\' : a.saturdayRate + \'%\'}</span></p><p className=\\"flex gap-2 mt-2\\">{a.holidayIsPlus && <span className=\\"bg-emerald-100 text-emerald-700 px-2 rounded-full text-[9px] font-bold\\">Feriado PLUS</span>}{a.paysDoubleOnFranco && <span className=\\"bg-indigo-100 text-indigo-700 px-2 rounded-full text-[9px] font-bold\\">Franco 100%</span>}</p></div></div>))}</div></div></div>)}\\n            {activeTab === \'ausencias\' && (<div className=\\"flex-1 bg-white dark:bg-slate-800 rounded-[2rem] border dark:border-slate-700 p-6 overflow-hidden flex flex-col\\"><div className=\\"flex justify-between items-center mb-6\\"><div className=\\"flex items-center gap-2 bg-slate-50 dark:bg-slate-900 px-4 py-2 rounded-xl border dark:border-slate-700 max-w-md w-full\\"><Search size={16} className=\\"text-slate-400\\"/><input placeholder=\\"Buscar novedad...\\" className=\\"bg-transparent outline-none w-full text-sm font-bold text-slate-900 dark:text-white\\" value={absenceSearchTerm} onChange={e => setAbsenceSearchTerm(e.target.value)}/></div></div><div className=\\"flex-1 overflow-auto custom-scrollbar\\"><table className=\\"w-full text-left\\"><thead className=\\"bg-slate-50 dark:bg-slate-900 sticky top-0\\"><tr><th className=\\"p-4 text-[10px] font-black uppercase text-slate-400\\">Empleado</th><th className=\\"p-4 text-[10px] font-black uppercase text-slate-400\\">Tipo / Motivo</th><th className=\\"p-4 text-[10px] font-black uppercase text-slate-400\\">Periodo</th><th className=\\"p-4 text-[10px] font-black uppercase text-slate-400 text-center\\">Estado</th><th className=\\"p-4 text-[10px] font-black uppercase text-slate-400 text-center\\">Certificado</th><th className=\\"p-4 text-right\\"></th></tr></thead><tbody className=\\"divide-y divide-slate-100 dark:divide-slate-700\\">{filteredAbsences.map(a => (<tr key={a.id} className=\\"hover:bg-slate-50 dark:hover:bg-slate-700/30\\"><td className=\\"p-4 font-bold text-sm text-slate-900 dark:text-white uppercase\\">{getAbsenceEmployeeName(a)}</td><td className=\\"p-4\\"><div className=\\"flex flex-col\\"><span className=\\"text-xs font-bold uppercase\\">{a.type}</span><span className=\\"text-[10px] text-slate-500\\">{a.reason || \'-\'}</span></div></td><td className=\\"p-4 text-xs font-mono text-slate-500\\">{new Date(a.startDate).toLocaleDateString()} - {new Date(a.endDate).toLocaleDateString()}</td><td className=\\"p-4 text-center\\"><span className={`px-2 py-1 rounded text-[10px] font-black uppercase ${a.status === \'Justificada\' ? \'bg-emerald-100 text-emerald-600\' : a.status === \'Injustificada\' ? \'bg-rose-100 text-rose-600\' : \'bg-amber-100 text-amber-600\'}`}>{a.status}</span></td><td className=\\"p-4 text-center\\">{a.hasCertificate ? <span className=\\"text-emerald-500 flex justify-center\\"><FileCheck size={16}/></span> : <span className=\\"text-slate-300\\">-</span>}</td><td className=\\"p-4 text-right flex justify-end gap-2\\"><button onClick={() => handleOpenAbsenceModal(a)} className=\\"text-slate-400 hover:text-indigo-500\\"><Edit2 size={16}/></button><button onClick={() => handleDeleteAbsence(a.id!)} className=\\"text-slate-400 hover:text-rose-500\\"><Trash2 size={16}/></button></td></tr>))}</tbody></table></div></div>)}\\n        </div>\\n\\n        {/* MODAL DE IMPORTACIN CSV (AMPLIADO) */}\\n        {showImportModal && (\\n            <div className=\\"fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4\\">\\n                <div className=\\"bg-white dark:bg-slate-800 p-8 rounded-3xl w-full max-w-6xl shadow-2xl relative flex flex-col h-[90vh]\\">\\n                    <div className=\\"flex justify-between items-center mb-6\\">\\n                        <div>\\n                            <h3 className=\\"text-2xl font-black text-slate-800 dark:text-white flex items-center gap-2\\"><FileSpreadsheet className=\\"text-emerald-500\\"/> Importaci贸n Masiva</h3>\\n                            <p className=\\"text-sm text-slate-500\\">Carga empleados desde un archivo CSV o Excel exportado a CSV.</p>\\n                        </div>\\n                        <div className=\\"flex gap-2\\">\\n                            <button onClick={handleDownloadTemplate} className=\\"px-4 py-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-lg text-xs font-black uppercase hover:bg-indigo-100 transition-colors flex items-center gap-2\\"><Download size={14}/> Descargar Plantilla</button>\\n                            <button onClick={() => {setShowImportModal(false); setImportPreview([]); setCsvContent(\'\');}} className=\\"p-2 hover:bg-slate-100 rounded-full\\"><X/></button>\\n                        </div>\\n                    </div>\\n\\n                    {!csvContent ? (\\n                        <div className=\\"flex-1 flex flex-col items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl bg-slate-50 dark:bg-slate-900/50 p-10\\">\\n                            <UploadCloud size={64} className=\\"text-indigo-400 mb-4\\"/>\\n                            <p className=\\"font-bold text-slate-600 dark:text-slate-300 mb-2\\">Arrastra tu archivo aqu铆 o haz clic para seleccionar</p>\\n                            <p className=\\"text-xs text-slate-400 mb-6\\">Formato soportado: .csv (Excel: Guardar como > CSV delimitado por comas)</p>\\n                            <input type=\\"file\\" accept=\\".csv\\" className=\\"hidden\\" id=\\"csv-upload\\" onChange={handleFileUpload} />\\n                            <label htmlFor=\\"csv-upload\\" className=\\"bg-indigo-600 text-white px-8 py-3 rounded-xl font-black text-xs uppercase cursor-pointer hover:bg-indigo-700 shadow-lg transition-transform hover:scale-105\\">Seleccionar Archivo</label>\\n                        </div>\\n                    ) : (\\n                        <div className=\\"flex-1 flex flex-col overflow-hidden\\">\\n                            <div className=\\"flex justify-between items-center mb-4\\">\\n                                <span className=\\"font-bold text-slate-700 dark:text-slate-300\\">Vista Previa ({importPreview.length} registros v谩lidos)</span>\\n                                <div className=\\"flex gap-2\\">\\n                                    <button onClick={handleProcessCSV} className=\\"px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-white rounded-lg text-xs font-bold\\">Re-Procesar</button>\\n                                    <button onClick={() => setCsvContent(\'\')} className=\\"px-4 py-2 text-rose-500 font-bold text-xs\\">Cancelar</button>\\n                                </div>\\n                            </div>\\n                            <div className=\\"flex-1 overflow-auto border rounded-xl\\">\\n                                <table className=\\"w-full text-xs text-left\\">\\n                                    <thead className=\\"bg-slate-100 dark:bg-slate-900 sticky top-0\\">\\n                                        <tr>\\n                                            <th className=\\"p-3\\">Legajo</th>\\n                                            <th className=\\"p-3\\">Apellido, Nombre</th>\\n                                            <th className=\\"p-3\\">DNI / CUIL</th>\\n                                            <th className=\\"p-3\\">Convenio</th>\\n                                            <th className=\\"p-3\\">Cat.</th>\\n                                            {/* COLUMNAS ADICIONALES SOLICITADAS */}\\n                                            <th className=\\"p-3\\">Objetivo</th>\\n                                            <th className=\\"p-3\\">Contacto</th>\\n                                            <th className=\\"p-3\\">Direcci贸n</th>\\n                                            <th className=\\"p-3\\">Ingreso</th>\\n                                            <th className=\\"p-3\\">Ciclo</th>\\n                                        </tr>\\n                                    </thead>\\n                                    <tbody className=\\"divide-y\\">\\n                                        {importPreview.map((row, i) => (\\n                                            <tr key={i} className=\\"hover:bg-slate-50 dark:hover:bg-slate-800\\">\\n                                                <td className=\\"p-3 font-mono\\">{row.fileNumber}</td>\\n                                                <td className=\\"p-3 font-bold\\">{row.name}</td>\\n                                                <td className=\\"p-3\\">{row.dni}</td>\\n                                                <td className=\\"p-3\\">{row.laborAgreement}</td>\\n                                                <td className=\\"p-3\\">{row.category}</td>\\n                                                {/* DATA EXTRA */}\\n                                                <td className=\\"p-3\\">\\n                                                    {/* Mostrar check si encontr贸 ID, o el nombre crudo si no */}\\n                                                    {row.preferredObjectiveId ? (\\n                                                        <span className=\\"text-emerald-600 font-bold flex items-center gap-1\\"><CheckCircle size={10}/> {allObjectives.find(o=>o.id===row.preferredObjectiveId)?.name || \'ID OK\'}</span>\\n                                                    ) : (\\n                                                        <span className=\\"text-rose-400 italic\\">{row.objectiveName || \'-\'} (No enc.)</span>\\n                                                    )}\\n                                                </td>\\n                                                <td className=\\"p-3\\">\\n                                                    <div className=\\"flex flex-col text-[10px]\\">\\n                                                        {row.email && <span className=\\"text-indigo-500\\">{row.email}</span>}\\n                                                        {row.phone && <span>{row.phone}</span>}\\n                                                        {!row.email && !row.phone && <span className=\\"text-slate-300\\">-</span>}\\n                                                    </div>\\n                                                </td>\\n                                                <td className=\\"p-3 text-[10px] truncate max-w-[150px]\\" title={row.address}>{row.address || \'-\'}</td>\\n                                                <td className=\\"p-3 font-mono\\">{row.startDate || \'-\'}</td>\\n                                                <td className=\\"p-3 font-mono\\">{row.cycleStartDay}</td>\\n                                            </tr>\\n                                        ))}\\n                                    </tbody>\\n                                </table>\\n                            </div>\\n                            <div className=\\"pt-6 mt-4 border-t flex justify-end\\">\\n                                <button onClick={confirmImport} disabled={isImporting || importPreview.length === 0} className=\\"px-8 py-4 bg-emerald-600 text-white rounded-xl font-black text-sm shadow-xl hover:bg-emerald-700 transition-transform hover:scale-105 disabled:opacity-50 disabled:scale-100\\">\\n                                    {isImporting ? \'Importando...\' : `Confirmar Importaci贸n (${importPreview.length})`}\\n                                </button>\\n                            </div>\\n                        </div>\\n                    )}\\n                </div>\\n            </div>\\n        )}\\n\\n        {/* --- VISTA DE IMPRESIN --- */}\\n        <div id=\\"printable-report\\" className=\\"hidden print:block bg-white p-8 w-full h-full absolute top-0 left-0 z-[9999]\\">\\n            {selectedEmp ? (\\n                <div>\\n                    {/* ENCABEZADO REPORTE */}\\n                    <div className=\\"flex justify-between items-center border-b-2 border-black pb-4 mb-6\\">\\n                        <div>\\n                            <h1 className=\\"text-2xl font-bold uppercase\\">Ficha de Liquidaci贸n</h1>\\n                            <p className=\\"text-sm text-gray-600\\">Periodo: {currentDate.toLocaleString(\'es-ES\', { month: \'long\', year: \'numeric\' }).toUpperCase()}</p>\\n                        </div>\\n                        <div className=\\"text-right\\">\\n                            <h2 className=\\"text-xl font-black\\">CRONOAPP</h2>\\n                            <p className=\\"text-xs text-gray-500\\">Generado el: {new Date().toLocaleDateString()}</p>\\n                        </div>\\n                    </div>\\n\\n                    {/* DATOS EMPLEADO */}\\n                    <div className=\\"grid grid-cols-2 gap-4 mb-6 border border-gray-300 p-4 rounded-lg\\">\\n                        <div><span className=\\"font-bold text-xs uppercase block text-gray-500\\">Empleado:</span> {selectedEmp.lastName}, {selectedEmp.firstName}</div>\\n                        <div><span className=\\"font-bold text-xs uppercase block text-gray-500\\">Legajo:</span> {selectedEmp.fileNumber}</div>\\n                        <div><span className=\\"font-bold text-xs uppercase block text-gray-500\\">CUIL:</span> {selectedEmp.cuil}</div>\\n                        <div><span className=\\"font-bold text-xs uppercase block text-gray-500\\">Convenio:</span> {selectedEmp.laborAgreement}</div>\\n                        <div><span className=\\"font-bold text-xs uppercase block text-gray-500\\">Categor铆a:</span> {selectedEmp.category}</div>\\n                        <div><span className=\\"font-bold text-xs uppercase block text-gray-500\\">Ciclo:</span> D铆a {selectedEmp.cycleStartDay} al {selectedEmp.cycleStartDay! - 1}</div>\\n                    </div>\\n\\n                    {/* TABLA DE HORAS */}\\n                    {empStats && (\\n                        <div className=\\"mb-8\\">\\n                            <h3 className=\\"font-bold uppercase text-sm mb-2 border-b border-gray-200\\">Resumen de Horas</h3>\\n                            <table className=\\"w-full text-sm text-left border border-gray-300\\">\\n                                <thead className=\\"bg-gray-100\\">\\n                                    <tr>\\n                                        <th className=\\"p-2 border\\">Concepto</th>\\n                                        <th className=\\"p-2 border text-right\\">Cantidad</th>\\n                                    </tr>\\n                                </thead>\\n                                <tbody>\\n                                    <tr><td className=\\"p-2 border\\">Horas Normales (Diurnas)</td><td className=\\"p-2 border text-right\\">{empStats.dayHours} hs</td></tr>\\n                                    <tr><td className=\\"p-2 border\\">Horas Nocturnas</td><td className=\\"p-2 border text-right\\">{empStats.nightHours} hs</td></tr>\\n                                    <tr><td className=\\"p-2 border\\">Horas al 50% (Extras)</td><td className=\\"p-2 border text-right\\">{empStats.extra50} hs</td></tr>\\n                                    <tr><td className=\\"p-2 border\\">Horas al 100% (Franco Trab.)</td><td className=\\"p-2 border text-right\\">{empStats.extra100} hs</td></tr>\\n                                    <tr><td className=\\"p-2 border\\">Plus Feriado</td><td className=\\"p-2 border text-right\\">{empStats.plusFeriado || 0} hs</td></tr>\\n                                    <tr className=\\"bg-gray-50 font-bold\\"><td className=\\"p-2 border\\">TOTAL REALIZADO</td><td className=\\"p-2 border text-right\\">{empStats.totalRealizado} hs</td></tr>\\n                                </tbody>\\n                            </table>\\n                        </div>\\n                    )}\\n\\n                    {/* DESGLOSE OBJETIVOS */}\\n                    {empStats && empStats.objectives.length > 0 && (\\n                        <div className=\\"mb-8\\">\\n                            <h3 className=\\"font-bold uppercase text-sm mb-2 border-b border-gray-200\\">Distribuci贸n por Objetivo</h3>\\n                            <table className=\\"w-full text-sm text-left border border-gray-300\\">\\n                                <thead className=\\"bg-gray-100\\"><tr><th className=\\"p-2 border\\">Objetivo / Cliente</th><th className=\\"p-2 border text-right\\">Horas</th></tr></thead>\\n                                <tbody>\\n                                    {empStats.objectives.map((o:any, i:number) => (\\n                                        <tr key={i}><td className=\\"p-2 border\\">{o.name}</td><td className=\\"p-2 border text-right\\">{Math.round(o.hours)} hs</td></tr>\\n                                    ))}\\n                                </tbody>\\n                            </table>\\n                        </div>\\n                    )}\\n\\n                    {/* NOVEDADES Y OBSERVACIONES */}\\n                    <div className=\\"mb-12\\">\\n                        <h3 className=\\"font-bold uppercase text-sm mb-2 border-b border-gray-200\\">Novedades del Periodo</h3>\\n                        <div className=\\"border border-gray-300 p-4 min-h-[100px] text-sm\\">\\n                            {/* Ausencias */}\\n                            {empStats?.absencesCount > 0 && <p className=\\"mb-2\\"><strong>Ausencias:</strong> {empStats.absencesCount} d铆as.</p>}\\n                            {/* Observaciones extraidas de los turnos */}\\n                            {empStats?.reportData?.turnos?.filter((t:any) => t.extensionNote || t.entryNote).map((t:any, i:number) => (\\n                                <p key={i} className=\\"mb-1 text-xs text-gray-600\\">\\n                                     {new Date(t.startTime.seconds * 1000).toLocaleDateString()}: {t.extensionNote || t.entryNote}\\n                                </p>\\n                            ))}\\n                            {(!empStats?.absencesCount && !empStats?.reportData?.turnos?.some((t:any) => t.extensionNote || t.entryNote)) && (\\n                                <p className=\\"text-gray-400 italic\\">Sin novedades registradas.</p>\\n                            )}\\n                        </div>\\n                    </div>\\n\\n                    {/* FIRMAS */}\\n                    <div className=\\"flex justify-between mt-20 pt-8 border-t border-gray-200\\">\\n                        <div className=\\"text-center w-1/3\\">\\n                            <div className=\\"border-t border-black mb-2 mx-4\\"></div>\\n                            <p className=\\"text-xs font-bold uppercase\\">Conforme Empleado</p>\\n                        </div>\\n                        <div className=\\"text-center w-1/3\\">\\n                            <div className=\\"border-t border-black mb-2 mx-4\\"></div>\\n                            <p className=\\"text-xs font-bold uppercase\\">Responsable RRHH</p>\\n                        </div>\\n                    </div>\\n                </div>\\n            ) : (\\n                <div className=\\"text-center p-20\\">\\n                    <h1 className=\\"text-4xl font-black mb-4\\">Reporte General de N贸mina</h1>\\n                    <p>Por favor seleccione un empleado individual para imprimir su ficha detallada, o use la opci贸n \\"Exportar CSV\\" para el reporte masivo.</p>\\n                </div>\\n            )}\\n        </div>\\n    </DashboardLayout>\\n  );\\n}\\n"},{"id":"5whb61pmq","name":"index.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\servicios\\\\index.tsx","area":"FRONTEND","content":"import React, { useState, useEffect } from \'react\';\\nimport DashboardLayout from \'@/components/layout/DashboardLayout\';\\nimport { slaService, ServiceSLA } from \'@/services/slaService\'; \\nimport { useToast } from \'@/context/ToastContext\';\\nimport { useAuth } from \'@/context/AuthContext\'; \\nimport { db } from \'@/lib/firebase\';\\n//  IMPORTAMOS onAuthStateChanged PARA EL FIX VISUAL\\nimport { getAuth, onAuthStateChanged } from \'firebase/auth\'; \\nimport { collection, addDoc, serverTimestamp } from \'firebase/firestore\'; \\nimport { \\n  Shield, Calendar, Users, Plus, Trash2, Edit2, \\n  Search, Save, X, MapPin, Briefcase, Clock, ArrowRight, Table, Settings, CheckCircle, CheckSquare, Square, AlertCircle, Info\\n} from \'lucide-react\';\\n\\n// --- 1. MODELO DE DATOS ---\\n\\nexport interface ShiftVariant {\\n  code: string;       // C贸digo corto (ej: \\"BAR\\", \\"M\\")\\n  name: string;       // Nombre descriptivo\\n  startTime: string;  \\n  endTime: string;    \\n  hours: number;      // Duraci贸n en horas\\n  isCustom?: boolean; // Para identificar si fue creado a mano\\n  days?: string[];    // D铆as espec铆ficos para este turno (si es undefined, se asume todos los d铆as)\\n}\\n\\nexport interface ServicePosition {\\n  id: string;\\n  name: string;             // Ej: \\"Puesto 1 - Entrada\\"\\n  coverageType: \'24hs\' | \'12hs_diurno\' | \'12hs_nocturno\' | \'custom\'; \\n  quantity: number;         // Dotaci贸n (Puestos simult谩neos)\\n  allowedShiftTypes: ShiftVariant[]; // Diccionario de turnos habilitados\\n  \\n  activeDays: string[];     // D铆as que el puesto opera en general\\n}\\n\\ninterface ExtendedServiceSLA extends Omit<ServiceSLA, \'shifts\'> {\\n  positions: ServicePosition[];\\n}\\n\\n// --- PRESETS GLOBALES ---\\nconst SHIFT_VARIANTS_DB: Record<string, ShiftVariant> = {\\n    \'M\': { code: \'M\', name: \'Ma帽ana\', startTime: \'07:00\', endTime: \'15:00\', hours: 8 },\\n    \'T\': { code: \'T\', name: \'Tarde\', startTime: \'15:00\', endTime: \'23:00\', hours: 8 },\\n    \'N\': { code: \'N\', name: \'Noche\', startTime: \'23:00\', endTime: \'07:00\', hours: 8 },\\n    \'D12\': { code: \'D12\', name: \'Diurno 12h\', startTime: \'07:00\', endTime: \'19:00\', hours: 12 },\\n    \'N12\': { code: \'N12\', name: \'Nocturno 12h\', startTime: \'19:00\', endTime: \'07:00\', hours: 12 },\\n};\\n\\nexport default function ServiciosSLAPage() {\\n  const { addToast } = useToast();\\n  \\n  //  ESTADO VISUAL DEL USUARIO\\n  const [currentUserName, setCurrentUserName] = useState(\\"Cargando...\\");\\n  \\n  // --- ESTADOS ---\\n  const [view, setView] = useState<\'list\' | \'form\'>(\'list\');\\n  const [services, setServices] = useState<ExtendedServiceSLA[]>([]);\\n  const [clients, setClients] = useState<any[]>([]);\\n  const [availableObjectives, setAvailableObjectives] = useState<any[]>([]);\\n  const [filteredServices, setFilteredServices] = useState<ExtendedServiceSLA[]>([]);\\n  const [searchTerm, setSearchTerm] = useState(\'\');\\n\\n  // Fechas por defecto\\n  const today = new Date();\\n  const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split(\'T\')[0];\\n  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split(\'T\')[0];\\n\\n  const [form, setForm] = useState<ExtendedServiceSLA>({\\n    clientId: \'\', clientName: \'\', objectiveId: \'\', objectiveName: \'\',\\n    startDate: firstDay, endDate: lastDay,\\n    positions: [], totalMonthlyHours: 0, status: \'active\'\\n  });\\n\\n  // Estado del Modal Puesto\\n  const [showPositionModal, setShowPositionModal] = useState(false);\\n  const [positionForm, setPositionForm] = useState<ServicePosition>({\\n    id: \'\', name: \'Puesto 1\', coverageType: \'24hs\', quantity: 1, \\n    activeDays: [\'L\',\'M\',\'X\',\'J\',\'V\',\'S\',\'D\'], allowedShiftTypes: []\\n  });\\n\\n  // Estado para crear turno custom \\"al vuelo\\"\\n  const [newCustomShift, setNewCustomShift] = useState<{\\n      name: string; start: string; end: string; code: string; days: string[]\\n  }>({ \\n      name: \'\', start: \'20:00\', end: \'05:00\', code: \'\', days: [\'V\', \'S\'] \\n  });\\n\\n  const [isEditing, setIsEditing] = useState(false);\\n\\n  //  DETECCIN DE USUARIO REAL AL MONTAR\\n  useEffect(() => {\\n    const auth = getAuth();\\n    const unsubscribe = onAuthStateChanged(auth, (user) => {\\n        if (user) {\\n            // Prioridad: Nombre > Email\\n            setCurrentUserName(user.displayName || user.email || \\"Usuario Sin Nombre\\");\\n        } else {\\n            setCurrentUserName(\\"No Logueado\\");\\n        }\\n    });\\n    return () => unsubscribe();\\n  }, []);\\n\\n  // --- CARGA ---\\n  useEffect(() => { loadData(); loadClients(); }, []);\\n\\n  // B煤squeda\\n  useEffect(() => {\\n    const term = searchTerm.toLowerCase().trim();\\n    if (!term) { setFilteredServices(services); return; }\\n    const filtered = services.filter(s => {\\n      const client = (s.clientName || \'\').toLowerCase();\\n      const objective = (s.objectiveName || \'\').toLowerCase();\\n      return client.includes(term) || objective.includes(term);\\n    });\\n    setFilteredServices(filtered);\\n  }, [searchTerm, services]);\\n\\n  const loadData = async () => {\\n    const data = await slaService.getAll();\\n    const adaptedData = data.map((d: any) => ({ ...d, positions: d.positions || [] }));\\n    setServices(adaptedData);\\n  };\\n\\n  const loadClients = async () => {\\n    const data = await slaService.getClients();\\n    setClients(data);\\n  };\\n\\n  //  FUNCIN DE AUDITORA CORRECTA (Toma el usuario al momento de ejecutar)\\n  const registrarAuditoria = async (accion: string, detalle: string) => {\\n      try {\\n          const auth = getAuth();\\n          const currentUser = auth.currentUser;\\n          \\n          // Prioridad: Nombre > Email > Fallback\\n          const actorName = currentUser?.displayName || currentUser?.email || \\"Usuario Desconocido\\";\\n          const actorUid = currentUser?.uid || \\"SYSTEM\\";\\n\\n          await addDoc(collection(db, \'audit_logs\'), { \\n              timestamp: serverTimestamp(),\\n              actorUid: actorUid,\\n              actorName: actorName, //  Nombre Real\\n              action: accion,\\n              module: \'SERVICIOS\',\\n              details: detalle,\\n              metadata: { platform: \'web\' }\\n          });\\n      } catch (error: any) {\\n          console.error(\\"Error auditor铆a:\\", error);\\n      }\\n  };\\n\\n  // --- HANDLERS GENERALES ---\\n  const handleClientChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\\n    const clientId = e.target.value;\\n    const selectedClient = clients.find(c => c.id === clientId);\\n    if (selectedClient) {\\n        setForm(prev => ({ ...prev, clientId: selectedClient.id, clientName: selectedClient.name, objectiveId: \'\', objectiveName: \'\' }));\\n        setAvailableObjectives(selectedClient.objectives || []);\\n    }\\n  };\\n\\n  const handleObjectiveChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\\n      const objId = e.target.value;\\n      const selectedObj = availableObjectives.find(o => o.id === objId);\\n      if (selectedObj) setForm(prev => ({ ...prev, objectiveId: selectedObj.id, objectiveName: selectedObj.name }));\\n  };\\n\\n  // --- MOTOR DE CLCULO DE HORAS (CORE) ---\\n  const calculateShiftHours = (start: string, end: string) => {\\n    const [h1, m1] = start.split(\':\').map(Number);\\n    const [h2, m2] = end.split(\':\').map(Number);\\n    let diff = (h2 - h1) + (m2 - m1) / 60;\\n    if (diff < 0) diff += 24;\\n    return parseFloat(diff.toFixed(2));\\n  };\\n\\n  // Esta funci贸n ahora simula d铆a por d铆a\\n  const calculateMonthlyBreakdown = (positions: ServicePosition[], startStr: string, endStr: string) => {\\n    if (!startStr || !endStr || positions.length === 0) return [];\\n    \\n    const breakdown: any[] = [];\\n    const sParts = startStr.split(\'-\').map(Number);\\n    const eParts = endStr.split(\'-\').map(Number);\\n    let current = new Date(sParts[0], sParts[1] - 1, sParts[2]);\\n    const end = new Date(eParts[0], eParts[1] - 1, eParts[2]);\\n\\n    // Mapeo de d铆as de JS (0=Domingo) a nuestros c贸digos\\n    const JS_DAY_MAP = [\'D\', \'L\', \'M\', \'X\', \'J\', \'V\', \'S\'];\\n\\n    // Acumulador temporal por mes \\"A帽o-Mes\\" -> { days, hours }\\n    const monthAccumulator: Record<string, { name: string, days: number, hours: number }> = {};\\n\\n    while (current <= end) {\\n        const year = current.getFullYear();\\n        const month = current.getMonth();\\n        const monthKey = `${year}-${month}`;\\n        const monthName = current.toLocaleString(\'es-ES\', { month: \'long\', year: \'numeric\' });\\n        const dayCode = JS_DAY_MAP[current.getDay()]; // L, M, X...\\n\\n        if (!monthAccumulator[monthKey]) {\\n            monthAccumulator[monthKey] = { \\n                name: monthName.charAt(0).toUpperCase() + monthName.slice(1), \\n                days: 0, \\n                hours: 0 \\n            };\\n        }\\n        \\n        monthAccumulator[monthKey].days++;\\n\\n        // Sumar horas de este d铆a espec铆fico\\n        let dayHoursTotal = 0;\\n\\n        positions.forEach(pos => {\\n            let posDailyHours = 0;\\n\\n            if (pos.coverageType === \'24hs\') posDailyHours = 24;\\n            else if (pos.coverageType === \'12hs_diurno\') posDailyHours = 12;\\n            else if (pos.coverageType === \'12hs_nocturno\') posDailyHours = 12;\\n            else if (pos.coverageType === \'custom\') {\\n                // L贸gica Detallada: Sumar solo turnos que apliquen a ESTE d铆a de la semana\\n                pos.allowedShiftTypes.forEach(shift => {\\n                    // Si el turno tiene restricci贸n de d铆as, verificamos\\n                    if (shift.days && shift.days.length > 0) {\\n                        if (shift.days.includes(dayCode)) {\\n                            posDailyHours += shift.hours;\\n                        }\\n                    } else {\\n                        // Si no tiene restricci贸n (Standard), asumimos que aplica todos los d铆as\\n                        posDailyHours += shift.hours;\\n                    }\\n                });\\n            }\\n            \\n            dayHoursTotal += (posDailyHours * pos.quantity);\\n        });\\n\\n        monthAccumulator[monthKey].hours += dayHoursTotal;\\n\\n        // Avanzar 1 d铆a\\n        current.setDate(current.getDate() + 1);\\n    }\\n\\n    // Convertir acumulador a array ordenado\\n    return Object.values(monthAccumulator);\\n  };\\n\\n  const monthlyBreakdown = calculateMonthlyBreakdown(form.positions, form.startDate, form.endDate);\\n  const totalContractHours = Math.round(monthlyBreakdown.reduce((acc, curr) => acc + curr.hours, 0));\\n\\n  // --- MODAL LGICA ---\\n  const openAddPositionModal = () => {\\n      setPositionForm({\\n        id: \'\', name: \'Puesto 1\', coverageType: \'24hs\', quantity: 1, \\n        activeDays: [\'L\',\'M\',\'X\',\'J\',\'V\',\'S\',\'D\'], allowedShiftTypes: [] \\n      });\\n      updateVariantsForCoverage(\'24hs\', { ...positionForm, coverageType: \'24hs\' });\\n      setNewCustomShift({ name: \'\', start: \'20:00\', end: \'05:00\', code: \'\', days: [\'V\', \'S\'] });\\n      setShowPositionModal(true);\\n  };\\n\\n  const updateVariantsForCoverage = (type: string, currentFormState: ServicePosition) => {\\n      let variants: ShiftVariant[] = [];\\n      if (type === \'24hs\') variants = [SHIFT_VARIANTS_DB[\'M\'], SHIFT_VARIANTS_DB[\'T\'], SHIFT_VARIANTS_DB[\'N\'], SHIFT_VARIANTS_DB[\'D12\'], SHIFT_VARIANTS_DB[\'N12\']];\\n      else if (type === \'12hs_diurno\') variants = [SHIFT_VARIANTS_DB[\'M\'], SHIFT_VARIANTS_DB[\'D12\']];\\n      else if (type === \'12hs_nocturno\') variants = [SHIFT_VARIANTS_DB[\'N\'], SHIFT_VARIANTS_DB[\'N12\']];\\n      \\n      setPositionForm({ ...currentFormState, allowedShiftTypes: type === \'custom\' ? [] : variants, coverageType: type as any });\\n  };\\n\\n  const handleCoverageTypeChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\\n      const type = e.target.value;\\n      updateVariantsForCoverage(type, positionForm);\\n  };\\n\\n  // --- LGICA CUSTOM ---\\n  const toggleStandardVariant = (variantKey: string) => {\\n      const variant = SHIFT_VARIANTS_DB[variantKey];\\n      const exists = positionForm.allowedShiftTypes.find(v => v.code === variant.code && !v.isCustom);\\n      let newAllowed = [...positionForm.allowedShiftTypes];\\n      if (exists) newAllowed = newAllowed.filter(v => v.code !== variant.code || v.isCustom);\\n      else newAllowed.push(variant);\\n      setPositionForm({ ...positionForm, allowedShiftTypes: newAllowed });\\n  };\\n\\n  const toggleNewShiftDay = (day: string) => {\\n      setNewCustomShift(prev => {\\n          const days = prev.days.includes(day) ? prev.days.filter(d => d !== day) : [...prev.days, day];\\n          return { ...prev, days };\\n      });\\n  };\\n\\n  const addCustomShift = () => {\\n      if (!newCustomShift.name) return;\\n      const hours = calculateShiftHours(newCustomShift.start, newCustomShift.end);\\n      const code = newCustomShift.code || newCustomShift.name.substring(0,2).toUpperCase();\\n      \\n      const newVariant: ShiftVariant = {\\n          code: code,\\n          name: newCustomShift.name,\\n          startTime: newCustomShift.start,\\n          endTime: newCustomShift.end,\\n          hours: hours,\\n          isCustom: true,\\n          days: newCustomShift.days \\n      };\\n\\n      setPositionForm(prev => ({\\n          ...prev,\\n          allowedShiftTypes: [...prev.allowedShiftTypes, newVariant]\\n      }));\\n      setNewCustomShift(prev => ({ ...prev, name: \'\', code: \'\' })); \\n  };\\n\\n  const removeCustomVariant = (code: string) => {\\n      setPositionForm(prev => ({\\n          ...prev,\\n          allowedShiftTypes: prev.allowedShiftTypes.filter(v => v.code !== code)\\n      }));\\n  };\\n\\n  const handleSavePosition = () => {\\n      if (!positionForm.name) return addToast(\'Nombre requerido\', \'error\');\\n      if (positionForm.allowedShiftTypes.length === 0) return addToast(\'Seleccione al menos un turno\', \'error\');\\n\\n      const newPosition = { ...positionForm, id: positionForm.id || Date.now().toString() };\\n      let updatedPositions = [...form.positions];\\n      if (positionForm.id) updatedPositions = updatedPositions.map(p => p.id === positionForm.id ? newPosition : p);\\n      else updatedPositions.push(newPosition);\\n\\n      // Ahora el c谩lculo se hace en el render principal o al guardar, no necesitamos recalcularlo aqu铆 para guardarlo en state intermedio\\n      setForm({ ...form, positions: updatedPositions });\\n      setShowPositionModal(false);\\n  };\\n\\n  const removePosition = (id: string) => {\\n      const updatedPositions = form.positions.filter(p => p.id !== id);\\n      setForm({ ...form, positions: updatedPositions });\\n  };\\n\\n  // --- GUARDAR FINAL ---\\n  const handleSave = async () => {\\n    if (!form.clientId) return addToast(\'Falta Cliente\', \'error\');\\n    const dataToSave = { ...form } as any; \\n\\n    try {\\n      if (isEditing && form.id) {\\n          await slaService.update(form.id, dataToSave);\\n          await registrarAuditoria(\'UPDATE_CONTRACT\', `Edit贸 contrato: ${form.clientName} - ${form.objectiveName}`);\\n      } else {\\n          await slaService.add(dataToSave);\\n          await registrarAuditoria(\'CREATE_CONTRACT\', `Cre贸 contrato: ${form.clientName} - ${form.objectiveName}`);\\n      }\\n      \\n      addToast(\'Guardado correctamente\', \'success\');\\n      loadData(); setView(\'list\');\\n    } catch (e) { \\n        addToast(\'Error al guardar\', \'error\'); \\n        console.error(e);\\n    }\\n  };\\n\\n  const handleEdit = (srv: ExtendedServiceSLA) => {\\n    setForm(srv);\\n    const client = clients.find(c => c.id === srv.clientId);\\n    if (client) setAvailableObjectives(client.objectives || []);\\n    setIsEditing(true); setView(\'form\');\\n  };\\n\\n  const handleDelete = async (id: string) => {\\n    // Buscar datos para el log antes de borrar\\n    const srv = services.find(s => s.id === id);\\n    if(confirm(\'驴Borrar contrato?\')) { \\n        await slaService.delete(id); \\n        await registrarAuditoria(\'DELETE_CONTRACT\', `Elimin贸 contrato: ${srv?.clientName} - ${srv?.objectiveName}`);\\n        loadData(); \\n    }\\n  };\\n\\n  const openNew = () => {\\n    const t = new Date();\\n    setForm({ \\n        clientId: \'\', clientName: \'\', objectiveId: \'\', objectiveName: \'\', \\n        startDate: new Date(t.getFullYear(), t.getMonth(), 1).toISOString().split(\'T\')[0], \\n        endDate: new Date(t.getFullYear(), t.getMonth() + 1, 0).toISOString().split(\'T\')[0], \\n        positions: [], totalMonthlyHours: 0, status: \'active\' \\n    });\\n    setIsEditing(false); setView(\'form\');\\n  };\\n\\n  return (\\n    <DashboardLayout>\\n      <div className=\\"max-w-7xl mx-auto space-y-6 animate-in fade-in\\">\\n        <header className=\\"flex justify-between items-end\\">\\n          <div>\\n              <h1 className=\\"text-4xl font-black text-slate-900 dark:text-white uppercase\\">Servicios & SLA</h1>\\n              {/*  INDICADOR VISUAL DEL USUARIO */}\\n              <p className=\\"text-[10px] text-indigo-500 mt-1\\">Usuario Activo: <b>{currentUserName}</b></p>\\n          </div>\\n          {view === \'list\' && <button onClick={openNew} className=\\"bg-indigo-600 text-white px-6 py-3 rounded-xl font-black text-xs uppercase shadow-xl flex gap-2\\"><Plus size={16}/> Nuevo Contrato</button>}\\n        </header>\\n\\n        {view === \'list\' && (\\n          <>\\n            <div className=\\"bg-white dark:bg-slate-800 p-4 rounded-2xl border dark:border-slate-700 flex items-center gap-4 shadow-sm\\">\\n              <Search className=\\"text-slate-400\\"/><input placeholder=\\"Buscar...\\" className=\\"w-full bg-transparent outline-none font-bold text-slate-700 dark:text-white uppercase\\" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/>\\n            </div>\\n            <div className=\\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\\">\\n              {filteredServices.map(srv => {\\n                const total = Math.round(calculateMonthlyBreakdown(srv.positions, srv.startDate, srv.endDate).reduce((acc, curr) => acc + curr.hours, 0));\\n                return (\\n                  <div key={srv.id} className=\\"bg-white dark:bg-slate-800 p-6 rounded-[2.5rem] border dark:border-slate-700 shadow-sm hover:shadow-lg transition-all group relative overflow-hidden flex flex-col h-full\\">\\n                    <div className={`absolute left-0 top-0 bottom-0 w-2 ${srv.status === \'active\' ? \'bg-emerald-500\' : \'bg-slate-300\'}`}></div>\\n                    <div className=\\"pl-4 flex-1\\">\\n                      <h3 className=\\"font-black text-lg text-slate-800 dark:text-white uppercase truncate\\">{srv.clientName}</h3>\\n                      <p className=\\"text-sm font-bold text-indigo-500 mt-1 uppercase mb-4 flex items-center gap-1\\"><MapPin size={12}/> {srv.objectiveName}</p>\\n                      <div className=\\"mb-4\\"><p className=\\"text-[9px] font-black uppercase text-slate-400 mb-2\\">Estructura</p><div className=\\"flex flex-wrap gap-2\\">{srv.positions.length > 0 ? srv.positions.map((p, idx) => <span key={idx} className=\\"text-[9px] font-bold bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 px-2 py-1 rounded-md uppercase border border-indigo-100 dark:border-indigo-800\\">{p.quantity}x {p.name}</span>) : <span className=\\"text-[9px] text-slate-400\\">Sin definir</span>}</div></div>\\n                      <div className=\\"mb-4 pt-4 border-t dark:border-slate-700\\"><div className=\\"flex justify-between items-end mb-2\\"><span className=\\"text-[10px] font-black uppercase text-slate-400\\">Total Periodo</span><span className=\\"text-2xl font-black text-indigo-600 dark:text-indigo-400\\">{total} <span className=\\"text-xs\\">hs</span></span></div></div>\\n                    </div>\\n                    <div className=\\"absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2\\">\\n                      <button onClick={() => handleEdit(srv)} className=\\"p-2 bg-white dark:bg-slate-700 rounded-lg shadow text-indigo-600\\"><Edit2 size={14}/></button>\\n                      <button onClick={() => handleDelete(srv.id!)} className=\\"p-2 bg-white dark:bg-slate-700 rounded-lg shadow text-rose-600\\"><Trash2 size={14}/></button>\\n                    </div>\\n                  </div>\\n                );\\n              })}\\n            </div>\\n          </>\\n        )}\\n\\n        {view === \'form\' && (\\n          <div className=\\"bg-white dark:bg-slate-800 p-8 rounded-[3rem] border dark:border-slate-700 shadow-xl\\">\\n            <div className=\\"flex justify-between items-start mb-8\\">\\n               <div><h2 className=\\"text-2xl font-black text-slate-900 dark:text-white uppercase\\">{isEditing ? \'Editar\' : \'Nuevo\'} Contrato</h2><p className=\\"text-slate-400 text-xs mt-1\\">Configure los puestos y la cobertura.</p></div>\\n               <div className=\\"text-right\\"><div className=\\"text-4xl font-black text-indigo-600 dark:text-indigo-400\\">{totalContractHours} <span className=\\"text-sm text-indigo-300 font-bold\\">hs</span></div><div className=\\"text-[10px] font-black uppercase text-slate-400 mt-1\\">Total Presupuestado (C谩lculo Diario)</div></div>\\n            </div>\\n            <div className=\\"grid grid-cols-1 lg:grid-cols-3 gap-8\\">\\n               <div className=\\"space-y-6\\">\\n                 <div><label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Cliente</label><select className=\\"w-full p-4 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-2xl font-bold text-sm dark:text-white\\" value={form.clientId} onChange={handleClientChange}><option value=\\"\\">Seleccionar...</option>{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>\\n                 <div><label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Objetivo</label><select className=\\"w-full p-4 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-2xl font-bold text-sm dark:text-white\\" value={form.objectiveId} onChange={handleObjectiveChange} disabled={!form.clientId}><option value=\\"\\">Seleccionar...</option>{availableObjectives.map(o => <option key={o.id} value={o.id}>{o.name}</option>)}</select></div>\\n                 <div className=\\"grid grid-cols-2 gap-4\\">\\n                     <div><label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Inicio</label><input type=\\"date\\" className=\\"w-full p-4 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-2xl font-bold text-xs dark:text-white\\" value={form.startDate} onChange={e => setForm({...form, startDate: e.target.value})}/></div>\\n                     <div><label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Fin</label><input type=\\"date\\" className=\\"w-full p-4 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-2xl font-bold text-xs dark:text-white\\" value={form.endDate} onChange={e => setForm({...form, endDate: e.target.value})}/></div>\\n                 </div>\\n                 <div className=\\"bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border dark:border-slate-700/50\\"><h4 className=\\"text-[10px] font-black uppercase text-slate-400 mb-3 flex items-center gap-2\\"><Table size={12}/> Facturaci贸n Estimada</h4><div className=\\"max-h-60 overflow-y-auto space-y-1\\">{monthlyBreakdown.map((m, i) => (<div key={i} className=\\"flex justify-between items-center bg-white dark:bg-slate-800 p-2 rounded-xl border dark:border-slate-700\\"><span className=\\"text-[10px] font-bold text-slate-600 dark:text-slate-300 uppercase\\">{m.name}</span><div className=\\"text-right\\"><span className=\\"block text-xs font-black text-indigo-600 dark:text-indigo-400\\">{Math.round(m.hours)} hs</span><span className=\\"block text-[8px] text-slate-400 font-bold\\">{m.days} d铆as</span></div></div>))}</div></div>\\n               </div>\\n               <div className=\\"lg:col-span-2 bg-slate-50 dark:bg-slate-900/30 p-6 rounded-[2.5rem] border dark:border-slate-700/50\\">\\n                  <div className=\\"flex justify-between items-center mb-6\\">\\n                     <h3 className=\\"text-sm font-black uppercase text-slate-700 dark:text-white flex items-center gap-2\\"><Briefcase size={18} className=\\"text-indigo-500\\"/> Estructura Operativa</h3>\\n                     <button onClick={openAddPositionModal} className=\\"bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:scale-105 transition-transform flex items-center gap-2\\"><Plus size={14}/> Agregar Puesto</button>\\n                  </div>\\n                  <div className=\\"space-y-3\\">\\n                     {form.positions.map((pos) => (\\n                        <div key={pos.id} className=\\"bg-white dark:bg-slate-800 p-4 rounded-2xl border dark:border-slate-700 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4\\">\\n                           <div className=\\"flex-1 text-left\\">\\n                              <div className=\\"flex items-center gap-3\\"><h4 className=\\"font-bold text-slate-800 dark:text-white text-sm uppercase\\">{pos.name}</h4><span className=\\"bg-emerald-100 dark:bg-emerald-900 text-emerald-600 dark:text-emerald-300 px-2 py-0.5 rounded text-[9px] font-black uppercase\\">{pos.quantity} PAX</span></div>\\n                              <div className=\\"mt-1 flex items-center gap-2\\"><span className=\\"text-[10px] font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900/50 px-2 rounded\\">{pos.coverageType === \'24hs\' ? \'24 HS\' : pos.coverageType.toUpperCase()}</span></div>\\n                           </div>\\n                           <div className=\\"flex gap-1 flex-wrap justify-end max-w-xs\\">{pos.allowedShiftTypes.map(v => (<div key={v.code} className=\\"text-center bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-lg border dark:border-slate-600\\"><div className=\\"text-[9px] font-black text-slate-600 dark:text-slate-300\\">{v.code}</div><div className=\\"text-[7px] text-slate-400\\">{v.hours}h</div></div>))}</div>\\n                           <button onClick={() => removePosition(pos.id)} className=\\"p-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-rose-500 hover:bg-rose-100\\"><X size={14}/></button>\\n                        </div>\\n                     ))}\\n                  </div>\\n               </div>\\n            </div>\\n            <div className=\\"mt-8 flex justify-end gap-4 border-t dark:border-slate-700 pt-6\\"><button onClick={() => setView(\'list\')} className=\\"text-slate-400 font-bold uppercase text-xs\\">Cancelar</button><button onClick={handleSave} className=\\"bg-slate-900 dark:bg-white dark:text-slate-900 text-white px-8 py-3 rounded-xl font-black uppercase text-xs shadow-xl\\"><Save size={16} className=\\"mr-2 inline\\"/> Guardar</button></div>\\n          </div>\\n        )}\\n\\n        {showPositionModal && (\\n           <div className=\\"fixed inset-0 bg-slate-900/80 z-[100] flex items-center justify-center p-4\\">\\n              <div className=\\"bg-white dark:bg-slate-800 w-full max-w-lg p-8 rounded-[3rem] animate-in zoom-in-95 shadow-2xl border dark:border-slate-600\\">\\n                 <h3 className=\\"text-xl font-black text-slate-900 dark:text-white uppercase mb-6 flex items-center gap-2\\"><Settings className=\\"text-indigo-500\\"/> Definir Puesto</h3>\\n                 <div className=\\"space-y-5\\">\\n                    <div className=\\"grid grid-cols-3 gap-4\\">\\n                        <div className=\\"col-span-2\\"><label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Nombre</label><input className=\\"w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-xl font-bold dark:text-white\\" value={positionForm.name} onChange={e => setPositionForm({...positionForm, name: e.target.value})}/></div>\\n                        <div><label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Pax</label><input type=\\"number\\" min=\\"1\\" className=\\"w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-600 rounded-xl font-bold text-center dark:text-white\\" value={positionForm.quantity} onChange={e => setPositionForm({...positionForm, quantity: parseInt(e.target.value) || 1})}/></div>\\n                    </div>\\n                    <div>\\n                        <label className=\\"text-[10px] font-black uppercase text-slate-400 ml-1\\">Tipo de Cobertura</label>\\n                        <select className=\\"w-full p-3 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 rounded-xl font-bold text-indigo-700 dark:text-indigo-300\\" value={positionForm.coverageType} onChange={handleCoverageTypeChange}>\\n                            <option value=\\"24hs\\">24 HORAS (Lunes a Lunes)</option>\\n                            <option value=\\"12hs_diurno\\">12 HORAS DIURNO</option>\\n                            <option value=\\"12hs_nocturno\\">12 HORAS NOCTURNO</option>\\n                            <option value=\\"custom\\">PERSONALIZADO / TURNOS ESPECFICOS</option>\\n                        </select>\\n                    </div>\\n\\n                    {/* ZONA CUSTOM */}\\n                    {positionForm.coverageType === \'custom\' && (\\n                        <div className=\\"bg-orange-50 dark:bg-orange-900/20 p-4 rounded-2xl border border-orange-100 dark:border-orange-800\\">\\n                             <div className=\\"flex gap-2 items-center mb-4 text-orange-700 dark:text-orange-400 bg-orange-100 dark:bg-orange-900/40 p-2 rounded-lg\\">\\n                                <Info size={14}/>\\n                                <p className=\\"text-[9px] font-bold\\">El c谩lculo de horas es autom谩tico seg煤n los d铆as asignados.</p>\\n                             </div>\\n                            \\n                            <label className=\\"text-[10px] font-black uppercase text-slate-400 mb-2 block\\">1. Turnos Est谩ndar (Todos los d铆as)</label>\\n                            <div className=\\"flex flex-wrap gap-2 mb-4\\">\\n                                {Object.keys(SHIFT_VARIANTS_DB).map((key) => {\\n                                    const v = SHIFT_VARIANTS_DB[key];\\n                                    const sel = positionForm.allowedShiftTypes.some(x => x.code === v.code && !x.isCustom);\\n                                    return <button key={key} onClick={() => toggleStandardVariant(key)} className={`px-3 py-1 rounded-lg border text-[10px] font-bold ${sel ? \'bg-orange-100 border-orange-300 text-orange-700\' : \'bg-white text-slate-500\'}`}>{v.name} ({v.hours}h)</button>\\n                                })}\\n                            </div>\\n\\n                            <label className=\\"text-[10px] font-black uppercase text-slate-400 mb-2 block\\">2. Crear Turno a Medida</label>\\n                            <div className=\\"space-y-2\\">\\n                                <div className=\\"flex gap-2 items-end\\">\\n                                    <div className=\\"flex-1\\"><span className=\\"text-[9px] text-slate-400\\">Nombre</span><input className=\\"w-full p-2 text-xs font-bold rounded-lg border\\" placeholder=\\"Ej: Puerta Bar\\" value={newCustomShift.name} onChange={e => setNewCustomShift({...newCustomShift, name: e.target.value})}/></div>\\n                                    <div className=\\"w-20\\"><span className=\\"text-[9px] text-slate-400\\">Inicio</span><input type=\\"time\\" className=\\"w-full p-2 text-xs font-bold rounded-lg border text-center\\" value={newCustomShift.start} onChange={e => setNewCustomShift({...newCustomShift, start: e.target.value})}/></div>\\n                                    <div className=\\"w-20\\"><span className=\\"text-[9px] text-slate-400\\">Fin</span><input type=\\"time\\" className=\\"w-full p-2 text-xs font-bold rounded-lg border text-center\\" value={newCustomShift.end} onChange={e => setNewCustomShift({...newCustomShift, end: e.target.value})}/></div>\\n                                </div>\\n                                <div>\\n                                    <span className=\\"text-[9px] text-slate-400 block mb-1\\">D铆as Habilitados</span>\\n                                    <div className=\\"flex gap-1 justify-between items-center\\">\\n                                            <div className=\\"flex gap-1\\">\\n                                                {[\'L\',\'M\',\'X\',\'J\',\'V\',\'S\',\'D\'].map(day => (\\n                                                    <button \\n                                                        key={day} \\n                                                        onClick={() => toggleNewShiftDay(day)}\\n                                                        className={`w-7 h-7 rounded text-[9px] font-black transition-colors ${newCustomShift.days.includes(day) ? \'bg-slate-900 text-white\' : \'bg-white border text-slate-400\'}`}\\n                                                    >\\n                                                        {day}\\n                                                    </button>\\n                                                ))}\\n                                            </div>\\n                                            <button onClick={addCustomShift} className=\\"bg-slate-900 text-white px-4 py-1.5 rounded-lg font-bold text-xs hover:scale-105 flex items-center gap-1\\"><Plus size={14}/> Agregar</button>\\n                                    </div>\\n                                </div>\\n                            </div>\\n                        </div>\\n                    )}\\n\\n                    {/* LISTA DE TURNOS HABILITADOS */}\\n                    <div className=\\"bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border dark:border-slate-700\\">\\n                        <label className=\\"text-[10px] font-black uppercase text-slate-400 mb-2 block\\">Turnos Habilitados</label>\\n                        <div className=\\"flex flex-wrap gap-2\\">\\n                            {positionForm.allowedShiftTypes.length > 0 ? positionForm.allowedShiftTypes.map((v) => (\\n                                <div key={v.code} className=\\"flex items-center gap-2 bg-white dark:bg-slate-800 px-3 py-2 rounded-lg border dark:border-slate-600 shadow-sm relative group\\">\\n                                    <span className={`w-6 h-6 flex items-center justify-center rounded text-[10px] font-black ${v.isCustom ? \'bg-orange-100 text-orange-600\' : \'bg-indigo-100 text-indigo-600\'}`}>{v.code}</span>\\n                                    <div>\\n                                        <p className=\\"text-[9px] font-bold text-slate-700 dark:text-white uppercase leading-none\\">{v.name}</p>\\n                                        <div className=\\"flex items-center gap-1\\">\\n                                            <p className=\\"text-[8px] text-slate-400\\">{v.startTime}-{v.endTime} ({v.hours}h)</p>\\n                                            {v.days && <p className=\\"text-[8px] font-black text-slate-500 bg-slate-100 px-1 rounded\\">{v.days.join(\'\')}</p>}\\n                                        </div>\\n                                    </div>\\n                                    {positionForm.coverageType === \'custom\' && <button onClick={() => removeCustomVariant(v.code)} className=\\"absolute -top-1 -right-1 bg-rose-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100\\"><X size={10}/></button>}\\n                                </div>\\n                            )) : <span className=\\"text-xs text-slate-400 italic\\">Ning煤n turno seleccionado.</span>}\\n                        </div>\\n                    </div>\\n\\n                    <div className=\\"pt-4 flex gap-3\\"><button onClick={() => setShowPositionModal(false)} className=\\"flex-1 py-3 bg-slate-100 dark:bg-slate-700 text-slate-500 font-bold rounded-xl uppercase text-xs\\">Cancelar</button><button onClick={handleSavePosition} className=\\"flex-1 py-3 bg-indigo-600 text-white font-black rounded-xl uppercase text-xs shadow-lg\\">Confirmar</button></div>\\n                 </div>\\n              </div>\\n           </div>\\n        )}\\n      </div>\\n    </DashboardLayout>\\n  );\\n}"},{"id":"mko65uesl","name":"test-convenios.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\admin\\\\test-convenios.tsx","area":"FRONTEND","content":"import React, { useEffect, useState } from \'react\';\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, getDocs } from \'firebase/firestore\';\\n\\nexport default function TestConvenios() {\\n  const [data, setData] = useState<any>(null);\\n\\n  useEffect(() => {\\n    getDocs(collection(db, \'convenios_colectivos\')).then(snap => {\\n        setData(snap.docs.map(d => d.data()));\\n    });\\n  }, []);\\n\\n  return (\\n    <div className=\\"p-10 bg-gray-900 text-white min-h-screen font-mono\\">\\n        <h1 className=\\"text-2xl mb-4 text-green-400\\">ESTRUCTURA DE CONVENIOS</h1>\\n        <pre>{JSON.stringify(data, null, 2)}</pre>\\n    </div>\\n  );\\n}\\n"},{"id":"q2e5wwhuo","name":"index.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\index.tsx","area":"FRONTEND","content":"\\nimport { useEffect } from \'react\';\\nimport { useRouter } from \'next/router\';\\nimport { useAuth } from \'@/context/AuthContext\';\\n\\nexport default function IndexPage() {\\n  const router = useRouter();\\n  const { user, loading } = useAuth();\\n\\n  useEffect(() => {\\n    // 1. Si Auth ya respondi贸, decidimos r谩pido\\n    if (!loading) {\\n      if (user) {\\n        router.replace(\'/admin/dashboard\');\\n      } else {\\n        router.replace(\'/login\');\\n      }\\n    }\\n\\n    // 2. TIMEOUT DE SEGURIDAD (La clave para arreglar localhost)\\n    // Si el AuthContext se tarda, forzamos la ida al login a los 1000ms.\\n    const timeout = setTimeout(() => {\\n      if (loading) {\\n        console.warn(\\"Auth tard贸 mucho, redirigiendo a Login por seguridad...\\");\\n        router.replace(\'/login\');\\n      }\\n    }, 1000);\\n\\n    return () => clearTimeout(timeout);\\n  }, [user, loading, router]);\\n\\n  // Spinner simple mientras redirige\\n  return (\\n    <div className=\\"min-h-screen flex items-center justify-center bg-slate-900\\">\\n      <div className=\\"flex flex-col items-center gap-4\\">\\n        <div className=\\"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500\\"></div>\\n        <p className=\\"text-slate-500 text-xs font-bold animate-pulse\\">Iniciando...</p>\\n      </div>\\n    </div>\\n  );\\n}\\n"},{"id":"46s1eflfw","name":"login.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\login.tsx","area":"FRONTEND","content":"\\nimport { useState } from \'react\';\\nimport { useRouter } from \'next/router\';\\nimport { signInWithEmailAndPassword } from \'firebase/auth\';\\nimport { auth } from \'@/lib/firebase\';\\nimport { ShieldCheck, Lock, Mail, Loader2, AlertCircle } from \'lucide-react\';\\n\\nexport default function LoginPage() {\\n  const router = useRouter();\\n  const [email, setEmail] = useState(\'\');\\n  const [password, setPassword] = useState(\'\');\\n  const [error, setError] = useState(\'\');\\n  const [loading, setLoading] = useState(false);\\n\\n  const handleLogin = async (e: React.FormEvent) => {\\n    e.preventDefault();\\n    setLoading(true);\\n    setError(\'\');\\n\\n    try {\\n      await signInWithEmailAndPassword(auth, email, password);\\n      \\n      //  ESTRATEGIA FUERTE: Usar window.location para forzar la recarga y limpiar estado\\n      // Esto soluciona el problema de que \\"no entra al dashboard\\"\\n      window.location.href = \'/admin/dashboard\';\\n      \\n    } catch (err: any) {\\n      console.error(err);\\n      setLoading(false);\\n      // Mensajes de error amigables\\n      if (err.code === \'auth/invalid-credential\' || err.code === \'auth/user-not-found\' || err.code === \'auth/wrong-password\') {\\n        setError(\'Correo o contrase帽a incorrectos.\');\\n      } else if (err.code === \'auth/too-many-requests\') {\\n        setError(\'Muchos intentos fallidos. Espera unos minutos.\');\\n      } else {\\n        setError(\'Error de conexi贸n. Intenta nuevamente.\');\\n      }\\n    }\\n  };\\n\\n  return (\\n    <div className=\\"min-h-screen bg-slate-900 flex items-center justify-center p-4\\">\\n      <div className=\\"bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl animate-in fade-in zoom-in duration-300\\">\\n        <div className=\\"flex flex-col items-center mb-8\\">\\n          <div className=\\"w-12 h-12 bg-indigo-600 rounded-xl flex items-center justify-center text-white mb-4 shadow-lg shadow-indigo-500/30\\">\\n            <ShieldCheck size={28} />\\n          </div>\\n          <h1 className=\\"text-2xl font-black text-slate-900 tracking-tight\\">CronoApp</h1>\\n          <p className=\\"text-slate-500 font-medium\\">Acceso Administrativo</p>\\n        </div>\\n\\n        {error && (\\n          <div className=\\"mb-6 p-4 bg-rose-50 border border-rose-100 text-rose-600 rounded-xl text-sm font-bold flex items-center gap-2 animate-pulse\\">\\n            <AlertCircle size={18} /> {error}\\n          </div>\\n        )}\\n\\n        <form onSubmit={handleLogin} className=\\"space-y-4\\">\\n          <div>\\n            <label className=\\"block text-xs font-black text-slate-700 uppercase mb-2 ml-1\\">Email</label>\\n            <div className=\\"relative\\">\\n              <Mail className=\\"absolute left-4 top-3.5 text-slate-400\\" size={18} />\\n              <input\\n                type=\\"email\\"\\n                value={email}\\n                onChange={(e) => setEmail(e.target.value)}\\n                className=\\"w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-medium text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all\\"\\n                placeholder=\\"admin@cronoapp.com\\"\\n                required\\n              />\\n            </div>\\n          </div>\\n\\n          <div>\\n            <label className=\\"block text-xs font-black text-slate-700 uppercase mb-2 ml-1\\">Contrase帽a</label>\\n            <div className=\\"relative\\">\\n              <Lock className=\\"absolute left-4 top-3.5 text-slate-400\\" size={18} />\\n              <input\\n                type=\\"password\\"\\n                value={password}\\n                onChange={(e) => setPassword(e.target.value)}\\n                className=\\"w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-medium text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all\\"\\n                placeholder=\\"⑩⑩⑩⑩⑩⑩⑩\\"\\n                required\\n              />\\n            </div>\\n          </div>\\n\\n          <button\\n            type=\\"submit\\"\\n            disabled={loading}\\n            className=\\"w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-xl shadow-xl shadow-indigo-200 hover:shadow-indigo-500/30 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2 mt-2\\"\\n          >\\n            {loading ? <Loader2 className=\\"animate-spin\\" /> : \'INGRESAR\'}\\n          </button>\\n        </form>\\n      </div>\\n    </div>\\n  );\\n}\\n"},{"id":"zc25a3kt6","name":"_app.tsx","path":"apps\\\\web2\\\\src\\\\pages\\\\_app.tsx","area":"FRONTEND","content":"\\nimport \'@/styles/globals.css\';\\nimport type { AppProps } from \'next/app\';\\nimport { ThemeProvider } from \'@/context/ThemeContext\';\\nimport { ToastProvider } from \'@/context/ToastContext\';\\nimport Head from \'next/head\';\\n\\nexport default function App({ Component, pageProps }: AppProps) {\\n  return (\\n    <ThemeProvider>\\n      <ToastProvider>\\n        <Head>\\n          <title>CronoApp Enterprise</title>\\n          <meta name=\\"viewport\\" content=\\"width=device-width, initial-scale=1\\" />\\n        </Head>\\n        <Component {...pageProps} />\\n      </ToastProvider>\\n    </ThemeProvider>\\n  );\\n}\\n"},{"id":"ja2dmfqg0","name":"absenceService.ts","path":"apps\\\\web2\\\\src\\\\services\\\\absenceService.ts","area":"FRONTEND","content":"\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, orderBy } from \'firebase/firestore\';\\n\\nexport interface Absence {\\n  id?: string;\\n  employeeId: string;\\n  employeeName: string;\\n  type: string;\\n  startDate: string;\\n  endDate: string;\\n  status: \'Pendiente\' | \'Justificada\' | \'Injustificada\';\\n  hasCertificate: boolean;\\n  reason: string;\\n  comments: string;\\n}\\n\\nexport const absenceService = {\\n  getAll: async () => {\\n    const q = query(collection(db, \'ausencias\'), orderBy(\'startDate\', \'desc\'));\\n    const s = await getDocs(q);\\n    return s.docs.map(d => {\\n        const data = d.data();\\n        return { \\n            id: d.id, \\n            ...data,\\n            // DEFAULTS DE SEGURIDAD PARA EVITAR CRASH\\n            employeeName: data.employeeName || \'\', // Evita undefined\\n            status: data.status || \'Pendiente\',\\n            hasCertificate: data.hasCertificate || false,\\n            reason: data.reason || \'\',\\n            comments: data.comments || \'\'\\n        } as Absence;\\n    });\\n  },\\n\\n  add: async (data: Absence) => addDoc(collection(db, \'ausencias\'), {\\n      ...data,\\n      createdAt: new Date().toISOString()\\n  }),\\n\\n  update: async (id: string, data: Partial<Absence>) => updateDoc(doc(db, \'ausencias\', id), data),\\n  \\n  delete: (id: string) => deleteDoc(doc(db, \'ausencias\', id))\\n};\\n"},{"id":"yu6js073x","name":"agreementService.ts","path":"apps\\\\web2\\\\src\\\\services\\\\agreementService.ts","area":"FRONTEND","content":"\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, orderBy } from \'firebase/firestore\';\\n\\nexport interface Agreement {\\n  id?: string;\\n  name: string;             \\n  code: string;             \\n  maxHoursWeekly: number;   \\n  maxHoursMonthly: number;  \\n  \\n  saturdayCutoffHour: number; // Ej: 13\\n  saturdayRate: number;       // 0=Normal, 50=50%, 100=100% (NUEVO)\\n  \\n  nightShiftStart: number;  \\n  nightShiftEnd: number;    \\n  \\n  paysDoubleOnFranco: boolean; \\n  categories: string[];        \\n}\\n\\nexport const agreementService = {\\n  getAll: async () => {\\n    try {\\n      const q = query(collection(db, \'convenios_colectivos\')); \\n      const s = await getDocs(q);\\n      \\n      return s.docs.map(d => {\\n          const data = d.data();\\n          return { \\n              id: d.id, \\n              name: data.name || \'Sin Nombre\',\\n              code: data.code || \'\',\\n              \\n              maxHoursWeekly: Number(data.maxHoursWeekly || 48),\\n              maxHoursMonthly: Number(data.maxHoursMonthly || 200),\\n              \\n              saturdayCutoffHour: Number(data.saturdayCutoffHour || 13),\\n              saturdayRate: Number(data.saturdayRate !== undefined ? data.saturdayRate : 100), // Default 100% si no existe\\n              \\n              nightShiftStart: Number(data.nightShiftStart || 21),\\n              nightShiftEnd: Number(data.nightShiftEnd || 6),\\n              \\n              paysDoubleOnFranco: data.paysDoubleOnFranco ?? true, \\n              categories: Array.isArray(data.categories) ? data.categories : []\\n          } as Agreement;\\n      });\\n    } catch (e) {\\n      console.error(\\"Error leyendo convenios:\\", e);\\n      return [];\\n    }\\n  },\\n\\n  add: async (data: Agreement) => addDoc(collection(db, \'convenios_colectivos\'), {\\n      ...data,\\n      isActive: true,\\n      createdAt: new Date()\\n  }),\\n  \\n  update: async (id: string, data: Partial<Agreement>) => updateDoc(doc(db, \'convenios_colectivos\', id), data),\\n  \\n  delete: (id: string) => deleteDoc(doc(db, \'convenios_colectivos\', id))\\n};\\n"},{"id":"evmfcq8h7","name":"api.ts","path":"apps\\\\web2\\\\src\\\\services\\\\api.ts","area":"FRONTEND","content":"\\nimport axios from \'axios\';\\n\\n// CONFIGURACIN DE CONEXIN A BASE DE DATOS\\n// Cambiar baseURL por tu backend real (Node/Express/Python)\\nconst API = axios.create({\\n  baseURL: \'http://localhost:4000/api\', \\n  headers: { \'Content-Type\': \'application/json\' }\\n});\\n\\n// SIMULACIN DE DATOS (MOCK) PARA CUANDO NO HAY BACKEND\\nexport const mockData = {\\n  login: async (creds: any) => {\\n    // Simula delay de red\\n    return new Promise(resolve => setTimeout(() => resolve({ token: \'123\', user: \'Admin\' }), 800));\\n  },\\n  getEmployees: async () => [\\n    { id: 1020, name: \'Sartori, Franco\', role: \'Vigilador\', status: \'active\' },\\n    { id: 1021, name: \'Quinteros, Debora\', role: \'Monitor\', status: \'medical\' },\\n    { id: 1022, name: \'Gomez, Carlos\', role: \'Supervisor\', status: \'active\' },\\n  ],\\n  getShifts: async () => {\\n    // Aqu铆 ir铆a la consulta real a tu DB de turnos\\n    return []; \\n  }\\n};\\n\\nexport default API;\\n"},{"id":"azddadq9j","name":"audit.service.ts","path":"apps\\\\web2\\\\src\\\\services\\\\audit.service.ts","area":"FRONTEND","content":"\\nimport { addDoc, collection, serverTimestamp } from \'firebase/firestore\';\\nimport { db } from \'../services/firebase-client.service\';\\n\\nexport const AuditActions = {\\n  OVERRIDE_SHIFT_LIMIT: \'FORZAR_LIMITE_HORAS\',\\n  OVERRIDE_FRANCO: \'FORZAR_FRANCO\',\\n  SHIFT_CREATED: \'TURNO_CREADO\',\\n  SHIFT_DELETED: \'TURNO_ELIMINADO\'\\n};\\n\\nexport const logAudit = async (adminUid, action, details) => {\\n  try {\\n    await addDoc(collection(db, \'auditorias\'), {\\n      adminUid,\\n      action,\\n      details,\\n      timestamp: serverTimestamp(),\\n      userAgent: navigator.userAgent\\n    });\\n    console.log(\' Auditor铆a registrada:\', action);\\n  } catch (error) {\\n    console.error(\' Error registrando auditor铆a:\', error);\\n  }\\n};\\n"},{"id":"wwogfukro","name":"auditService.ts","path":"apps\\\\web2\\\\src\\\\services\\\\auditService.ts","area":"FRONTEND","content":"\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, addDoc, Timestamp } from \'firebase/firestore\';\\n\\nexport const auditService = {\\n    /**\\n     * Registra un evento en la auditor铆a del sistema.\\n     * @param action Qu茅 pas贸 (Ej: \'ALTA_EMPLEADO\', \'BAJA_CLIENTE\')\\n     * @param module En qu茅 m贸dulo (Ej: \'RRHH\', \'CRM\', \'PLANIFICACION\')\\n     * @param details Objeto con los datos relevantes (\\"foto\\" del cambio)\\n     * @param actor Qui茅n lo hizo (email o nombre del usuario)\\n     */\\n    async log(action: string, module: string, details: any, actor: string = \'admin@bacarsa.com.ar\') {\\n        try {\\n            const safeDetails = JSON.parse(JSON.stringify(details || {}));\\n            await addDoc(collection(db, \'historial_operaciones\'), {\\n                action: action.toUpperCase(),\\n                module: module.toUpperCase(),\\n                details: JSON.stringify(safeDetails), \\n                actorName: actor,\\n                timestamp: Timestamp.now(),\\n                createdAt: new Date().toISOString()\\n            });\\n            console.log(` Auditor铆a: [${module}] ${action}`);\\n        } catch (error) {\\n            console.error(\\" Error escribiendo auditor铆a:\\", error);\\n        }\\n    }\\n};\\n"},{"id":"zu195gbl5","name":"clientService.ts","path":"apps\\\\web2\\\\src\\\\services\\\\clientService.ts","area":"FRONTEND","content":"\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, getDocs, query, where } from \'firebase/firestore\';\\nimport { Client, Objective } from \'@/types/wfm\';\\n\\nexport const clientService = {\\n  // Obtener todos los clientes\\n  getClients: async (): Promise<Client[]> => {\\n    try {\\n      const colRef = collection(db, \'clients\');\\n      const snapshot = await getDocs(colRef);\\n      // Mapeo seguro para evitar errores de TS\\n      return snapshot.docs.map(doc => ({\\n        id: doc.id,\\n        name: doc.data().name || \'Sin Nombre\',\\n        cuit: doc.data().cuit || \'\',\\n        ...doc.data()\\n      })) as Client[];\\n    } catch (error) {\\n      console.error(\\"Error getClients:\\", error);\\n      return [];\\n    }\\n  },\\n\\n  // Obtener objetivos de un cliente\\n  getObjectivesByClient: async (clientId: string): Promise<Objective[]> => {\\n    try {\\n      const colRef = collection(db, \'objectives\');\\n      const q = query(colRef, where(\\"clientId\\", \\"==\\", clientId));\\n      const snapshot = await getDocs(q);\\n      \\n      return snapshot.docs.map(doc => ({\\n        id: doc.id,\\n        clientId: doc.data().clientId,\\n        name: doc.data().name || \'Objetivo Sin Nombre\',\\n        address: doc.data().address || \'\'\\n      })) as Objective[];\\n    } catch (error) {\\n      console.error(\\"Error getObjectivesByClient:\\", error);\\n      return [];\\n    }\\n  }\\n};\\n"},{"id":"l3jp5jgyj","name":"crmService.ts","path":"apps\\\\web2\\\\src\\\\services\\\\crmService.ts","area":"FRONTEND","content":"\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc, arrayUnion, orderBy } from \'firebase/firestore\';\\nimport { Client, Objective, Contact, ServiceSLA } from \'@/types/crm\';\\n\\nexport const crmService = {\\n  // CLIENTES\\n  getClients: async () => {\\n    const s = await getDocs(collection(db, \'clients\'));\\n    return s.docs.map(d => ({ id: d.id, ...d.data() } as Client));\\n  },\\n  addClient: (data: any) => addDoc(collection(db, \'clients\'), { \\n    ...data, \\n    contacts: [], \\n    timeline: [], \\n    ltv: 0,\\n    createdAt: new Date() \\n  }),\\n  updateClient: (id: string, data: any) => updateDoc(doc(db, \'clients\', id), data),\\n  deleteClient: (id: string) => deleteDoc(doc(db, \'clients\', id)),\\n\\n  // SEDES (OBJETIVOS)\\n  getObjectives: async (clientId: string) => {\\n    const q = query(collection(db, \'objectives\'), where(\'clientId\', \'==\', clientId));\\n    const s = await getDocs(q);\\n    return s.docs.map(d => ({ id: d.id, ...d.data() } as Objective));\\n  },\\n  addObjective: (data: any) => addDoc(collection(db, \'objectives\'), { ...data, createdAt: new Date() }),\\n  updateObjective: (id: string, data: any) => updateDoc(doc(db, \'objectives\', id), data),\\n  deleteObjective: (id: string) => deleteDoc(doc(db, \'objectives\', id)),\\n\\n  // SERVICIOS (SLA)\\n  getServices: async (objectiveId: string) => {\\n    const q = query(collection(db, \'services\'), where(\'objectiveId\', \'==\', objectiveId));\\n    const s = await getDocs(q);\\n    return s.docs.map(d => ({ id: d.id, ...d.data() } as any));\\n  },\\n  addService: (data: any) => addDoc(collection(db, \'services\'), { ...data, createdAt: new Date() }),\\n\\n  // BITCORA\\n  addTimelineNote: (clientId: string, note: string) => \\n    updateDoc(doc(db, \'clients\', clientId), { \\n      timeline: arrayUnion({ text: note, date: new Date().toISOString(), user: \'Admin\' }) \\n    }),\\n};\\n"},{"id":"qxq5g0kky","name":"employeeService.ts","path":"apps\\\\web2\\\\src\\\\services\\\\employeeService.ts","area":"FRONTEND","content":"import { db } from \'@/lib/firebase\';\\nimport { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from \'firebase/firestore\';\\n\\nexport interface Employee {\\n  id?: string;\\n  firstName: string;\\n  lastName: string;\\n  dni: string;\\n  cuil?: string;           // NUEVO: Agregado campo CUIL\\n  fileNumber: string;\\n  phone: string;\\n  email: string;\\n  category: string;\\n  status: string;\\n  startDate?: string;      // NUEVO: Agregado fecha de ingreso (string en tu DB)\\n  cycleStartDay?: number;  // NUEVO: Agregado inicio de ciclo (number en tu DB)\\n  laborAgreement?: string;\\n  preferredClientId?: string;\\n  preferredObjectiveId?: string;\\n}\\n\\nexport const employeeService = {\\n  getAll: async () => {\\n    try {\\n      console.log(\\" [Service] Buscando empleados...\\");\\n      \\n      // Estrategia de Fallback en Cascada\\n      let snapshot = await getDocs(collection(db, \'empleados\'));\\n      if (snapshot.empty) snapshot = await getDocs(collection(db, \'employees\'));\\n      if (snapshot.empty) snapshot = await getDocs(collection(db, \'users\')); // ltimo recurso\\n\\n      console.log(` [Service] Encontrados ${snapshot.size} documentos.`);\\n\\n      return snapshot.docs.map(d => {\\n          const data = d.data();\\n          \\n          // L贸gica de Nombres: Intentar separar, si no, usar completo\\n          let fName = data.firstName || data.nombre || \'\';\\n          let lName = data.lastName || data.apellido || \'\';\\n          \\n          // Si no hay nombre/apellido por separado pero hay \'name\'\\n          if (!fName && !lName && data.name) {\\n              const parts = data.name.split(\' \');\\n              fName = parts[0];\\n              lName = parts.slice(1).join(\' \') || \'\';\\n          }\\n\\n          return { \\n              id: d.id, \\n              firstName: fName || \'Sin Nombre\',\\n              lastName: lName || \'\',\\n              dni: data.dni || data.document || \'S/D\', // Limpi茅 para que cuil vaya en su propio campo\\n              \\n              // --- NUEVOS CAMPOS ---\\n              cuil: data.cuil || \'\', // Ahora leemos expl铆citamente el CUIL\\n              startDate: data.startDate || data.fechaIngreso || \'\', // Leemos la fecha de ingreso\\n              cycleStartDay: data.cycleStartDay || 1, // Leemos inicio de ciclo (default a 1 si no existe)\\n              // ---------------------\\n\\n              fileNumber: data.fileNumber || data.legajo || \'S/N\',\\n              phone: data.phone || data.telefono || \'\',\\n              email: data.email || \'\',\\n              category: data.category || data.cargo || \'Vigilador\',\\n              status: data.status || data.estado || \'active\',\\n              laborAgreement: data.laborAgreement || data.convenio || \'SUVICO\',\\n              preferredClientId: data.preferredClientId || \'\',\\n              preferredObjectiveId: data.preferredObjectiveId || \'\'\\n          } as Employee;\\n      });\\n    } catch (e) {\\n      console.error(\\" Error cargando empleados:\\", e);\\n      return [];\\n    }\\n  },\\n\\n  add: async (data: Employee) => addDoc(collection(db, \'empleados\'), data),\\n  update: (id: string, data: Partial<Employee>) => updateDoc(doc(db, \'empleados\', id), data),\\n  delete: (id: string) => deleteDoc(doc(db, \'empleados\', id)),\\n};"},{"id":"mkkrvgqdk","name":"firebase-client.service.ts","path":"apps\\\\web2\\\\src\\\\services\\\\firebase-client.service.ts","area":"FRONTEND","content":"\\nimport { getApp, getApps, initializeApp } from \'firebase/app\';\\nimport { getAuth } from \'firebase/auth\';\\nimport { getFirestore } from \'firebase/firestore\';\\nimport { getFunctions, httpsCallable } from \'firebase/functions\';\\n\\n// Configuraci贸n de Firebase\\nconst firebaseConfig = {\\n  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,\\n  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,\\n  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,\\n  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,\\n  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,\\n  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID\\n};\\n\\nconst app = !getApps().length ? initializeApp(firebaseConfig) : getApp();\\n\\nexport const auth = getAuth(app);\\nexport const db = getFirestore(app);\\nexport const functions = getFunctions(app, \'us-central1\');\\n\\n// --- FUNCIONES ---\\nexport const callManageAudits = httpsCallable(functions, \'manageAudits\');\\n"},{"id":"dxj77af3p","name":"firebase.config.ts","path":"apps\\\\web2\\\\src\\\\services\\\\firebase.config.ts","area":"FRONTEND","content":"import { initializeApp, getApps, getApp } from \'firebase/app\';\\nimport { getAuth } from \'firebase/auth\';\\nimport { getFirestore } from \'firebase/firestore\';\\n\\nconst firebaseConfig = {\\n  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,\\n  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,\\n  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,\\n  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,\\n  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,\\n  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID\\n};\\n\\n// Singleton para evitar reinicializaciones en Next.js\\nconst app = !getApps().length ? initializeApp(firebaseConfig) : getApp();\\nconst auth = getAuth(app);\\nconst db = getFirestore(app);\\n\\nexport { auth, db };\\n"},{"id":"52tn7w1gd","name":"holidayService.ts","path":"apps\\\\web2\\\\src\\\\services\\\\holidayService.ts","area":"FRONTEND","content":"\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, addDoc, getDocs, doc, deleteDoc, query, orderBy, where } from \'firebase/firestore\';\\n\\nexport interface Holiday {\\n  id?: string;\\n  date: string; // YYYY-MM-DD\\n  name: string;\\n  type: \'Nacional\' | \'Puente\' | \'Optativo\' | \'Gremial\';\\n}\\n\\nexport const holidayService = {\\n  getAll: async () => {\\n    const q = query(collection(db, \'feriados\'), orderBy(\'date\', \'asc\'));\\n    const s = await getDocs(q);\\n    return s.docs.map(d => ({ id: d.id, ...d.data() } as Holiday));\\n  },\\n\\n  add: async (data: Holiday) => addDoc(collection(db, \'feriados\'), data),\\n  \\n  delete: (id: string) => deleteDoc(doc(db, \'feriados\', id)),\\n\\n  // --- NUEVA FUNCIN: IMPORTAR DESDE API OFICIAL ---\\n  syncWithGovApi: async (year: number) => {\\n    try {\\n      // 1. Fetch a la API p煤blica de Argentina\\n      const response = await fetch(`https://nolaborables.com.ar/api/v2/feriados/${year}`);\\n      if (!response.ok) throw new Error(\'No se pudo conectar con el servidor de feriados.\');\\n      \\n      const data = await response.json();\\n      let addedCount = 0;\\n\\n      // 2. Obtener feriados ya existentes para no duplicar\\n      const existingQuery = query(collection(db, \'feriados\'), where(\'date\', \'>=\', `${year}-01-01`), where(\'date\', \'<=\', `${year}-12-31`));\\n      const existingDocs = await getDocs(existingQuery);\\n      const existingDates = new Set(existingDocs.docs.map(d => d.data().date));\\n\\n      // 3. Procesar y Guardar\\n      const batchPromises = data.map(async (h: any) => {\\n          // Formato API: dia: 1, mes: 1, motivo: \\"A帽o Nuevo\\", tipo: \\"inamovible\\"\\n          const month = String(h.mes).padStart(2, \'0\');\\n          const day = String(h.dia).padStart(2, \'0\');\\n          const dateStr = `${year}-${month}-${day}`;\\n\\n          if (!existingDates.has(dateStr)) {\\n              addedCount++;\\n              return addDoc(collection(db, \'feriados\'), {\\n                  date: dateStr,\\n                  name: h.motivo,\\n                  type: \'Nacional\' // Por defecto vienen nacionales\\n              });\\n          }\\n      });\\n\\n      await Promise.all(batchPromises);\\n      return addedCount;\\n\\n    } catch (e) {\\n      console.error(\\"Error importando feriados:\\", e);\\n      throw e;\\n    }\\n  }\\n};\\n"},{"id":"yojyl3vjr","name":"rrhhService.ts","path":"apps\\\\web2\\\\src\\\\services\\\\rrhhService.ts","area":"FRONTEND","content":"\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, writeBatch } from \'firebase/firestore\';\\n\\nexport const rrhhService = {\\n  // --- EMPLEADOS ---\\n  getEmployees: async () => {\\n    try {\\n      const s = await getDocs(collection(db, \'empleados\'));\\n      return s.docs.map(d => {\\n        const data = d.data();\\n        return { \\n          id: d.id, \\n          legajo: data.fileNumber || data.legajo || \'S/D\', \\n          name: data.name || \'\',\\n          cuit: data.dni || data.cuil || \'\', \\n          address: data.address || \'\',\\n          cct: data.laborAgreement || data.cct || \'\', \\n          category: data.category || \'Sin Categor铆a\',\\n          status: data.isAvailable ? \'activo\' : \'inactivo\',\\n          lat: data.lat || 0,\\n          lng: data.lng || 0,\\n          maxHours: data.maxHours || 200,\\n          periodType: data.periodType || \'Mensual\',\\n          cycleStartDay: data.cycleStartDay || 21,\\n          ...data \\n        };\\n      });\\n    } catch (e) {\\n      console.error(\\"Error leyendo empleados:\\", e);\\n      return [];\\n    }\\n  },\\n\\n  addEmployee: (data: any) => addDoc(collection(db, \'empleados\'), { \\n    ...data, \\n    fileNumber: data.legajo,\\n    dni: data.cuit,\\n    laborAgreement: data.cct,\\n    createdAt: new Date().toISOString(),\\n    isAvailable: true, \\n    docs: [] \\n  }),\\n\\n  updateEmployee: (id: string, data: any) => updateDoc(doc(db, \'empleados\', id), data),\\n  deleteEmployee: (id: string) => deleteDoc(doc(db, \'empleados\', id)),\\n\\n  importEmployeesBatch: async (employeesData: any[]) => {\\n    const batch = writeBatch(db);\\n    employeesData.forEach(emp => {\\n      const docRef = doc(collection(db, \'empleados\'));\\n      batch.set(docRef, {\\n        ...emp,\\n        fileNumber: emp.legajo,\\n        dni: emp.cuit,\\n        laborAgreement: emp.cct,\\n        createdAt: new Date().toISOString(),\\n        isAvailable: true,\\n        docs: []\\n      });\\n    });\\n    await batch.commit();\\n  },\\n\\n  // --- CONVENIOS ---\\n  getAgreements: async () => {\\n    const s = await getDocs(collection(db, \'convenios_colectivos\'));\\n    return s.docs.map(d => ({ id: d.id, ...d.data() }));\\n  },\\n\\n  addAgreement: (data: any) => addDoc(collection(db, \'convenios_colectivos\'), data),\\n  updateAgreement: (id: string, data: any) => updateDoc(doc(db, \'convenios_colectivos\', id), data),\\n  deleteAgreement: (id: string) => deleteDoc(doc(db, \'convenios_colectivos\', id)),\\n\\n  // --- CALENDARIO Y AUSENCIAS ---\\n  getHolidays: async () => {\\n    // Traemos TODOS los feriados cargados para no filtrar por a帽o hardcodeado\\n    const s = await getDocs(collection(db, \'feriados\'));\\n    return s.docs.map(d => ({ id: d.id, ...d.data() })); \\n  },\\n\\n  addHoliday: (data: any) => addDoc(collection(db, \'feriados\'), data),\\n  deleteHoliday: (id: string) => deleteDoc(doc(db, \'feriados\', id)),\\n\\n  // Seed Din谩mico para cualquier a帽o\\n  seedHolidays: async (holidays: any[], yearData: { year: number, link: string }) => {\\n    const batch = writeBatch(db);\\n    \\n    // Guardamos referencia del a帽o (opcional)\\n    const metaRef = doc(collection(db, \'feriados\'));\\n    batch.set(metaRef, { \\n        date: `${yearData.year}-01-00`, \\n        name: \'CONFIG_YEAR\', \\n        link: yearData.link, \\n        type: \'System\' \\n    });\\n\\n    // Guardamos los feriados\\n    holidays.forEach(h => {\\n      const docRef = doc(collection(db, \'feriados\'));\\n      batch.set(docRef, h);\\n    });\\n    await batch.commit();\\n  },\\n\\n  getAbsences: async () => {\\n    const s = await getDocs(collection(db, \'ausencias\'));\\n    return s.docs.map(d => ({ id: d.id, ...d.data() }));\\n  },\\n\\n  addAbsence: (data: any) => addDoc(collection(db, \'ausencias\'), { ...data, createdAt: new Date().toISOString() }),\\n  updateAbsence: (id: string, data: any) => updateDoc(doc(db, \'ausencias\', id), data),\\n  deleteAbsence: (id: string) => deleteDoc(doc(db, \'ausencias\', id))\\n};\\n"},{"id":"0x0hy1pbe","name":"slaService.ts","path":"apps\\\\web2\\\\src\\\\services\\\\slaService.ts","area":"FRONTEND","content":"\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where } from \'firebase/firestore\';\\n\\n// Definici贸n de Turno\\nexport interface Shift {\\n  id: string;\\n  name: string;\\n  position: string;\\n  startTime: string;\\n  endTime: string;\\n  hours: number;\\n  quantity: number;\\n  days: string[];\\n}\\n\\n// Definici贸n de Contrato de Servicio\\nexport interface ServiceSLA {\\n  id?: string;\\n  clientId: string;\\n  clientName: string;\\n  objectiveId: string;\\n  objectiveName: string;\\n  startDate: string;\\n  endDate: string;\\n  shifts: Shift[];\\n  totalMonthlyHours: number;\\n  status: \'active\' | \'inactive\' | \'expired\';\\n}\\n\\nexport const slaService = {\\n  // 1. Obtener todos los servicios (para la lista general)\\n  getAll: async () => {\\n    try {\\n      const q = query(collection(db, \'servicios_sla\'), orderBy(\'clientName\'));\\n      const s = await getDocs(q);\\n      return s.docs.map(d => ({ id: d.id, ...d.data() } as ServiceSLA));\\n    } catch (e) {\\n      console.error(\\"Error getting services:\\", e);\\n      return [];\\n    }\\n  },\\n\\n  // 2. Obtener servicios de un cliente espec铆fico (para la pesta帽a del CRM)\\n  getByClientId: async (clientId: string) => {\\n    try {\\n      const q = query(collection(db, \'servicios_sla\'), where(\'clientId\', \'==\', clientId));\\n      const s = await getDocs(q);\\n      return s.docs.map(d => ({ id: d.id, ...d.data() } as ServiceSLA));\\n    } catch (e) {\\n      console.error(\\"Error filter services:\\", e);\\n      return [];\\n    }\\n  },\\n\\n  // 3. Obtener Clientes y sus Objetivos (CORREGIDO ESPAOL/INGLS)\\n  getClients: async () => {\\n    try {\\n      const q = query(collection(db, \'clients\'), orderBy(\'name\'));\\n      const s = await getDocs(q);\\n      return s.docs.map(d => {\\n        const data = d.data();\\n        return { \\n          id: d.id, \\n          name: data.name || data.fantasyName || \'Sin Nombre\',\\n          // AQU EST LA MAGIA: Leemos \'objetivos\' (tu DB actual) O \'objectives\' (backup)\\n          objectives: data.objetivos || data.objectives || [] \\n        };\\n      });\\n    } catch (e) {\\n      console.error(\\"Error loading clients for dropdown:\\", e);\\n      return [];\\n    }\\n  },\\n\\n  // 4. CRUD B谩sico\\n  add: async (data: ServiceSLA) => addDoc(collection(db, \'servicios_sla\'), data),\\n  \\n  update: (id: string, data: Partial<ServiceSLA>) => updateDoc(doc(db, \'servicios_sla\', id), data),\\n  \\n  delete: (id: string) => deleteDoc(doc(db, \'servicios_sla\', id)),\\n};\\n"},{"id":"in2c1k1az","name":"wfmService.ts","path":"apps\\\\web2\\\\src\\\\services\\\\wfmService.ts","area":"FRONTEND","content":"\\nimport { db } from \'@/lib/firebase\';\\nimport { collection, getDocs, query, where, addDoc, doc, deleteDoc } from \'firebase/firestore\';\\nimport { Client, Objective, Service, Employee } from \'@/types/wfm\';\\n\\nexport const wfmService = {\\n  // Clientes\\n  getClients: async () => {\\n    const s = await getDocs(collection(db, \'clients\'));\\n    return s.docs.map(d => ({ id: d.id, ...d.data() } as Client));\\n  },\\n  // Objetivos por Cliente\\n  getObjectives: async (clientId: string) => {\\n    const q = query(collection(db, \'objectives\'), where(\'clientId\', \'==\', clientId));\\n    const s = await getDocs(q);\\n    return s.docs.map(d => ({ id: d.id, ...d.data() } as Objective));\\n  },\\n  // Servicios por Objetivo\\n  getServices: async (objectiveId: string) => {\\n    const q = query(collection(db, \'services\'), where(\'objectiveId\', \'==\', objectiveId));\\n    const s = await getDocs(q);\\n    return s.docs.map(d => ({ id: d.id, ...d.data() } as Service));\\n  },\\n  // Empleados\\n  getEmployees: async () => {\\n    const s = await getDocs(collection(db, \'employees\'));\\n    return s.docs.map(d => ({ id: d.id, ...d.data() } as Employee));\\n  }\\n};\\n"},{"id":"nobahfewj","name":"globals.css","path":"apps\\\\web2\\\\src\\\\styles\\\\globals.css","area":"FRONTEND","content":"\\n@tailwind base;\\n@tailwind components;\\n@tailwind utilities;\\n\\n@layer base {\\n  body {\\n    @apply transition-colors duration-300;\\n  }\\n  h1, h2, h3, h4, h5, h6 {\\n    @apply font-black tracking-tighter;\\n  }\\n}\\n\\n/* --- REGLAS DE COLORES POR TEMA --- */\\n\\n/* 1. ENTERPRISE (Light Default) */\\n.enterprise body {\\n  background-color: #f8fafc; /* Slate 50 */\\n  color: #0f172a; /* Slate 900 */\\n}\\n\\n/* 2. MODERN SOFT (Light Suave) */\\n.modern body {\\n  background-color: #f3f4f6; /* Gray 100 (Un poco m谩s c谩lido que Slate) */\\n  color: #374151; /* Gray 700 (Texto no tan negro, m谩s suave) */\\n  font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, \\"Segoe UI\\", Roboto, \\"Helvetica Neue\\", Arial, sans-serif;\\n}\\n.modern .bg-white {\\n  background-color: #ffffff !important;\\n  border: none !important; /* Sin bordes duros */\\n  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01) !important; /* Sombras difusas */\\n  border-radius: 1.5rem !important; /* Bordes extra redondeados */\\n}\\n.modern .bg-slate-50 {\\n  background-color: #f9fafb !important; /* Gray 50 */\\n}\\n.modern input, .modern select, .modern textarea {\\n  background-color: #f9fafb !important;\\n  border: 1px solid #e5e7eb !important;\\n  border-radius: 1rem !important;\\n}\\n\\n/* 3. TACTICAL DARK (Slate) */\\n.tactical body {\\n  background-color: #0f172a; \\n  color: #f1f5f9;\\n}\\n.tactical .bg-white {\\n  background-color: #1e293b !important;\\n  border-color: #334155 !important;\\n}\\n\\n/* 4. MIDNIGHT (Blue) */\\n.midnight body {\\n  background-color: #020420;\\n  color: #e0e7ff;\\n}\\n.midnight .bg-white {\\n  background-color: #0f172a !important;\\n  border-color: #1e3a8a !important;\\n}\\n.midnight .text-indigo-600 { color: #60a5fa !important; }\\n\\n/* 5. OLED (Black) */\\n.oled body {\\n  background-color: #000000;\\n  color: #ffffff;\\n}\\n.oled .bg-white {\\n  background-color: #121212 !important;\\n  border-color: #333333 !important;\\n}\\n.oled .bg-slate-50 { background-color: #000000 !important; }\\n\\n/* --- CORRECCIONES GLOBALES MODO OSCURO --- */\\n.dark input, .dark select, .dark textarea {\\n  background-color: rgba(255, 255, 255, 0.05) !important;\\n  border-color: rgba(255, 255, 255, 0.1) !important;\\n  color: #ffffff !important;\\n}\\n.dark .text-slate-900, .dark .text-slate-800 { color: #ffffff !important; }\\n.dark .text-slate-500, .dark .text-slate-400 { color: #94a3b8 !important; }\\n.dark .bg-slate-100 { background-color: rgba(255, 255, 255, 0.1) !important; color: #fff !important; }\\n\\n::-webkit-scrollbar { width: 8px; height: 8px; }\\n::-webkit-scrollbar-track { background: transparent; }\\n::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }\\n.dark ::-webkit-scrollbar-thumb { background: #334155; }\\n\\n\\n/* =========================================\\n   TEMAS PERSONALIZADOS (INYECTADOS)\\n   ========================================= */\\n\\n/* --- MEJORA DE LEGIBILIDAD TEMA CLARO --- */\\n/* Hace que los grises claros sean m谩s oscuros para leer mejor */\\nbody:not(.dark):not(.theme-blue):not(.theme-contrast) .text-slate-500 {\\n    color: #475569 !important; /* Slate-600 */\\n}\\nbody:not(.dark):not(.theme-blue):not(.theme-contrast) .text-slate-400 {\\n    color: #64748b !important; /* Slate-500 */\\n}\\n\\n/* --- TEMA ALTO CONTRASTE (NEGRO/AMARILLO) --- */\\n.theme-contrast body {\\n    background-color: #000000 !important;\\n    color: #FFD700 !important; /* Dorado */\\n}\\n\\n/* Forzar fondos negros y bordes blancos en tarjetas */\\n.theme-contrast .bg-white, \\n.theme-contrast .bg-slate-50, \\n.theme-contrast .bg-slate-100,\\n.theme-contrast .bg-indigo-50 {\\n    background-color: #000000 !important;\\n    border: 1px solid #FFFFFF !important;\\n    color: #FFD700 !important;\\n}\\n\\n/* Forzar textos a blanco o amarillo */\\n.theme-contrast .text-slate-500,\\n.theme-contrast .text-slate-600,\\n.theme-contrast .text-slate-800,\\n.theme-contrast .text-gray-500,\\n.theme-contrast .text-indigo-600,\\n.theme-contrast .text-indigo-700,\\n.theme-contrast .text-indigo-900 {\\n    color: #FFFFFF !important;\\n}\\n\\n/* Botones con borde evidente */\\n.theme-contrast button {\\n    border: 2px solid #FFD700 !important;\\n}\\n\\n/* --- TEMA AZUL PRO (NAVY POLICIAL) --- */\\n.theme-blue body {\\n    background-color: #0f172a !important; /* Slate 900 (Azulado) */\\n    color: #e2e8f0 !important; /* Slate 200 */\\n}\\n\\n/* Tarjetas Azul Profundo */\\n.theme-blue .bg-white,\\n.theme-blue .bg-slate-50,\\n.theme-blue .bg-indigo-50 {\\n    background-color: #1e293b !important; /* Slate 800 */\\n    border-color: #334155 !important; /* Slate 700 */\\n    color: white !important;\\n}\\n\\n/* Textos suavizados para fondo oscuro */\\n.theme-blue .text-slate-500,\\n.theme-blue .text-slate-600,\\n.theme-blue .text-slate-800,\\n.theme-blue .text-indigo-900 {\\n    color: #94a3b8 !important; /* Slate 400 */\\n}\\n\\n.theme-blue .text-indigo-600,\\n.theme-blue .text-indigo-700 {\\n    color: #60a5fa !important; /* Blue 400 */\\n}\\n\\n.theme-blue aside {\\n    background-color: #172554 !important; /* Blue 950 */\\n    border-right: 1px solid #1e3a8a !important;\\n}\\n\\n\\n/* --- FIX DE IMPRESIN (CRONOAPP) --- */\\n@media print {\\n  @page {\\n    margin: 0;\\n    size: auto;\\n  }\\n  \\n  body {\\n    -webkit-print-color-adjust: exact !important;\\n    print-color-adjust: exact !important;\\n    background-color: white !important;\\n  }\\n\\n  /* Ocultar Sidebar, Headers y Navegaci贸n autom谩ticamente */\\n  aside, nav, header, .no-print {\\n    display: none !important;\\n  }\\n\\n  /* Asegurar que el contenido principal ocupe todo el ancho */\\n  main, #root, #__next {\\n    width: 100% !important;\\n    margin: 0 !important;\\n    padding: 0 !important;\\n    display: block !important;\\n  }\\n  \\n  /* Evitar cortes feos en tablas y tarjetas */\\n  .break-inside-avoid {\\n    break-inside: avoid;\\n  }\\n  \\n  /* Ocultar barras de scroll si aparecen */\\n  * {\\n    overflow: visible !important;\\n  }\\n}\\n"},{"id":"wmaq9hh6m","name":"crm.ts","path":"apps\\\\web2\\\\src\\\\types\\\\crm.ts","area":"FRONTEND","content":"\\nexport interface Contact { name: string; role: string; phone: string; email: string; }\\nexport interface Objective { id?: string; clientId: string; name: string; address: string; status: \'active\' | \'inactive\'; }\\n\\nexport interface ServiceSLA {\\n  id?: string;\\n  objectiveId: string;\\n  name: string;\\n  startTime: string; // HH:mm\\n  endTime: string;   // HH:mm\\n  days: number[];    // [1,2,3,4,5] (1=Lunes)\\n  headcount: number; // Personas requeridas\\n  costPerHour: number;\\n}\\n\\nexport interface Client {\\n  id?: string;\\n  name: string;\\n  cuit: string;\\n  industry: string;\\n  status: \'prospecto\' | \'negociacion\' | \'activo\' | \'pausado\';\\n  contacts: Contact[];\\n  timeline: any[];\\n}\\n"},{"id":"b1xi2fd4g","name":"operaciones.types.ts","path":"apps\\\\web2\\\\src\\\\types\\\\operaciones.types.ts","area":"FRONTEND","content":"import { Timestamp } from \'firebase/firestore\';\\r\\n\\r\\n// --- ENUMS (Estados permitidos) ---\\r\\nexport type ShiftStatus = \\r\\n  | \'PENDING\' \\r\\n  | \'PRESENT\'   // En servicio\\r\\n  | \'COMPLETED\' // Finalizado OK\\r\\n  | \'ABSENT\'    // Ausente\\r\\n  | \'CANCELED\'; // Cancelado administrativo\\r\\n\\r\\nexport type ShiftCondition = \\r\\n  | \'LATE\' \\r\\n  | \'IMMINENT\' \\r\\n  | \'ENDING\' \\r\\n  | \'EARLY_ENTRY\' \\r\\n  | \'NORMAL\';\\r\\n\\r\\n// --- INTERFACES PRINCIPALES ---\\r\\n\\r\\nexport interface IEmployee {\\r\\n  id: string;\\r\\n  firstName: string;\\r\\n  lastName: string;\\r\\n  fullName: string;\\r\\n  phone?: string;\\r\\n  // Agrega aqu铆 otros campos necesarios del maestro de empleados\\r\\n}\\r\\n\\r\\nexport interface IShift {\\r\\n  id: string;\\r\\n  // Relaciones\\r\\n  employeeId: string;\\r\\n  employeeName: string;\\r\\n  clientId: string;\\r\\n  clientName: string;\\r\\n  objectiveId: string;\\r\\n  objectiveName: string;\\r\\n  \\r\\n  // Tiempo\\r\\n  startTime: Timestamp;\\r\\n  endTime: Timestamp;\\r\\n  realStartTime?: Timestamp;\\r\\n  realEndTime?: Timestamp;\\r\\n  \\r\\n  // Estado y L贸gica\\r\\n  status: ShiftStatus;\\r\\n  code?: string; // Ej: \'M\', \'T\', \'N\', \'F\'\\r\\n  isFranco?: boolean;\\r\\n  \\r\\n  // Banderas de Novedad\\r\\n  hasNovedad?: boolean;\\r\\n  novedadReason?: string;\\r\\n  \\r\\n  // Banderas de Cobertura\\r\\n  isCoverage?: boolean;\\r\\n  coverageNote?: string;\\r\\n  relatedAbsentShiftId?: string; // Si cubre a otro turno\\r\\n  \\r\\n  // Banderas de Ingreso/Egreso\\r\\n  isEarlyEntry?: boolean;\\r\\n  entryNote?: string;\\r\\n  checkInMethod?: \'MANUAL_RADIO\' | \'APP_QR\' | \'APP_GEO\';\\r\\n  checkoutMethod?: \'MANUAL_RADIO\' | \'APP_QR\';\\r\\n  checkoutNote?: string;\\r\\n  hasCheckoutNovedad?: boolean;\\r\\n\\r\\n  // Campos calculados en frontend (no guardar en BD necesariamente, pero 煤tiles en UI)\\r\\n  shiftDateObj?: Date;\\r\\n  endDateObj?: Date;\\r\\n}\\r\\n\\r\\nexport interface IObjective {\\r\\n  id: string;\\r\\n  name: string;\\r\\n  clientId: string;\\r\\n  clientName: string;\\r\\n  address?: string;\\r\\n  lat: string | number;\\r\\n  lng: string | number;\\r\\n  // Campos auxiliares para el mapa\\r\\n  shifts?: IShiftUI[]; \\r\\n}\\r\\n\\r\\n// --- INTERFAZ EXTENDIDA PARA UI (Lo que usa tu componente GuardCard) ---\\r\\nexport interface IShiftUI extends IShift {\\r\\n  // Banderas calculadas en tiempo real (reloj)\\r\\n  isLate: boolean;\\r\\n  isImminent: boolean;\\r\\n  isEnding: boolean;\\r\\n  isPresent: boolean;\\r\\n  isAbsent: boolean;\\r\\n  isCompleted: boolean;\\r\\n  phone?: string; // Tra铆do del maestro de empleados\\r\\n}\\r\\n\\r\\nexport interface IAuditLog {\\r\\n  action: string;      // Ej: \'INGRESO\', \'EGRESO\', \'NOVEDAD\'\\r\\n  module: \'OPERACIONES\';\\r\\n  details: string;\\r\\n  timestamp: any;      // ServerTimestamp\\r\\n  actorName: string;   // Qui茅n hizo la acci贸n\\r\\n  actorUid: string;\\r\\n}"},{"id":"0ii3s2fz5","name":"planificacion.types.ts","path":"apps\\\\web2\\\\src\\\\types\\\\planificacion.types.ts","area":"FRONTEND","content":"import { Timestamp } from \'firebase/firestore\';\\r\\n\\r\\nexport interface IPlannerShift {\\r\\n    id: string;\\r\\n    employeeId: string;\\r\\n    employeeName: string;\\r\\n    startTime: Timestamp;\\r\\n    endTime: Timestamp;\\r\\n    code: string; // \'M\', \'T\', \'N\', \'F\', etc.\\r\\n    color?: string; // Para UI\\r\\n    status: \'PENDING\' | \'PRESENT\' | \'COMPLETED\' | \'ABSENT\';\\r\\n    // Banderas importantes\\r\\n    isFranco?: boolean;\\r\\n    isCoverage?: boolean;\\r\\n    hasNovedad?: boolean;\\r\\n}\\r\\n\\r\\nexport interface IPlannerEmployee {\\r\\n    id: string;\\r\\n    fullName: string;\\r\\n    // Aqu铆 puedes agregar campos como \'legajo\' o \'sector\' si los usas para filtrar\\r\\n}\\r\\n\\r\\nexport interface ICalendarCell {\\r\\n    day: number;\\r\\n    date: Date;\\r\\n    shifts: IPlannerShift[];\\r\\n    isToday: boolean;\\r\\n    isWeekend: boolean;\\r\\n}\\r\\n\\r\\nexport const SHIFT_CODES = {\\r\\n    \'M\': { label: \'Ma帽ana\', color: \'bg-yellow-100 text-yellow-700 border-yellow-300\' },\\r\\n    \'T\': { label: \'Tarde\', color: \'bg-orange-100 text-orange-700 border-orange-300\' },\\r\\n    \'N\': { label: \'Noche\', color: \'bg-indigo-100 text-indigo-700 border-indigo-300\' },\\r\\n    \'F\': { label: \'Franco\', color: \'bg-slate-100 text-slate-500 border-slate-300\' },\\r\\n    \'X\': { label: \'Ausente\', color: \'bg-rose-100 text-rose-700 border-rose-300\' },\\r\\n    \'C\': { label: \'Cubierto\', color: \'bg-emerald-100 text-emerald-700 border-emerald-300\' },\\r\\n};"},{"id":"sknq4htks","name":"wfm.ts","path":"apps\\\\web2\\\\src\\\\types\\\\wfm.ts","area":"FRONTEND","content":"\\nexport interface Client { id: string; name: string; cuit: string; }\\nexport interface Objective { id: string; clientId: string; name: string; address: string; }\\nexport interface Service { id: string; objectiveId: string; name: string; startTime: string; endTime: string; costPerHour: number; }\\nexport interface Employee { id: string; name: string; role: string; fileNumber: string; }\\nexport interface Assignment { id: string; serviceId: string; employeeId: string; date: string; }\\n"},{"id":"mbwyruz3g","name":"hourCalculator.ts","path":"apps\\\\web2\\\\src\\\\utils\\\\hourCalculator.ts","area":"FRONTEND","content":"\\n/**\\n * LGICA CENTRAL DE CLCULO DE HORAS\\n * Define qu茅 es diurno, nocturno y extra para todo el sistema.\\n */\\n\\nexport const calculateShiftHours = (start: Date, end: Date, rule: any) => {\\n    // 1. Configuraci贸n de nocturnidad (Default: 21:00 a 06:00)\\n    const nightStart = rule?.nightShiftStart ?? 21;\\n    const nightEnd = rule?.nightShiftEnd ?? 6;\\n\\n    let durationMins = 0;\\n    let nightMins = 0;\\n    let current = new Date(start.getTime());\\n    const endTime = end.getTime();\\n\\n    // Iteramos minuto a minuto para precisi贸n exacta\\n    while (current.getTime() < endTime) {\\n        const h = current.getHours();\\n        \\n        durationMins++;\\n        \\n        // 驴Es hora nocturna? (>= 21 O < 6)\\n        if (h >= nightStart || h < nightEnd) {\\n            nightMins++;\\n        }\\n        \\n        current.setMinutes(current.getMinutes() + 1);\\n    }\\n\\n    const total = durationMins / 60;\\n    const nocturnas = nightMins / 60;\\n    const diurnas = total - nocturnas; // <--- LA RESTA CLAVE\\n\\n    return { total, diurnas, nocturnas };\\n};\\n\\nexport const calculatePeriodStats = (shifts: any[], holidaysMap: Record<string, boolean>, rule: any) => {\\n    let stats = { \\n        totalReal: 0, \\n        diurnas: 0, \\n        nocturnas: 0, \\n        extra50: 0, \\n        extra100: 0 \\n    };\\n    \\n    let accumulated = 0;\\n    const limit = rule?.maxHoursMonthly || 200;\\n\\n    // Ordenar turnos por fecha\\n    const sorted = [...shifts].sort((a, b) => {\\n        const tA = a.startTime?.seconds || new Date(a.startTime).getTime();\\n        const tB = b.startTime?.seconds || new Date(b.startTime).getTime();\\n        return tA - tB;\\n    });\\n\\n    sorted.forEach(s => {\\n        if(s.isFranco || s.status === \'cancelled\') return;\\n\\n        // Fechas seguras\\n        const dStart = s.startTime?.toDate ? s.startTime.toDate() : new Date(s.startTime);\\n        const dEnd = s.endTime?.toDate ? s.endTime.toDate() : new Date(s.endTime);\\n\\n        // 1. Calcular desglose del turno\\n        const { total, diurnas, nocturnas } = calculateShiftHours(dStart, dEnd, rule);\\n\\n        stats.totalReal += total;\\n        stats.diurnas += diurnas;\\n        stats.nocturnas += nocturnas;\\n\\n        // 2. Calcular Extras (Desborde del acumulado)\\n        const prevAcc = accumulated;\\n        accumulated += total;\\n\\n        let overflow = 0;\\n        if (prevAcc >= limit) overflow = total; // Todo es extra\\n        else if (accumulated > limit) overflow = accumulated - limit; // Solo el excedente\\n\\n        if (overflow > 0) {\\n            const day = dStart.getDay(); // 0=Dom, 6=Sab\\n            const isSatAfter13 = day === 6 && dStart.getHours() >= 13;\\n            const isSun = day === 0;\\n            const isHoliday = holidaysMap[dStart.toDateString()];\\n\\n            if (isSun || isHoliday || isSatAfter13) {\\n                stats.extra100 += overflow;\\n            } else {\\n                stats.extra50 += overflow;\\n            }\\n        }\\n    });\\n\\n    return stats;\\n};\\n"},{"id":"oxue6lb5w","name":"shiftManager.ts","path":"apps\\\\web2\\\\src\\\\utils\\\\shiftManager.ts","area":"FRONTEND","content":"\\nimport { db } from \'../services/firebase-client.service\';\\nimport { collection, addDoc } from \'firebase/firestore\';\\n\\nexport const procesarAsignacionTurno = async ({ adminUid, newTurnoData, existingTurnos, ausencias, fechaReferencia }, force = false) => {\\n  try {\\n    await addDoc(collection(db, \'turnos\'), newTurnoData);\\n    return { success: true };\\n  } catch (error) {\\n    console.error(error);\\n    return { success: false, error: error.message };\\n  }\\n};\\n"},{"id":"qi5cf691b","name":"crear-admin.js","path":"crear-admin.js","area":"CONFIG","content":"const admin = require(\'firebase-admin\');\\r\\nconst serviceAccount = require(\'./service-account.json\'); // 锔 OJO AQU\\r\\n\\r\\n// Inicializar\\r\\nadmin.initializeApp({\\r\\n  credential: admin.credential.cert(serviceAccount)\\r\\n});\\r\\n\\r\\nconst email = \'admin@bacar.com\'; //  TU EMAIL DE ADMIN\\r\\nconst password = \'password123\'; //  TU CONTRASEA\\r\\n\\r\\nasync function createSuperAdmin() {\\r\\n  try {\\r\\n    // 1. Crear usuario\\r\\n    const userRecord = await admin.auth().createUser({\\r\\n      email: email,\\r\\n      password: password,\\r\\n      displayName: \'Super Admin\',\\r\\n      emailVerified: true,\\r\\n    });\\r\\n\\r\\n    console.log(\'Usuario creado:\', userRecord.uid);\\r\\n\\r\\n    // 2. Asignar Custom Claim \'admin\'\\r\\n    await admin.auth().setCustomUserClaims(userRecord.uid, { role: \'admin\' });\\r\\n    console.log(\'Rol de ADMIN asignado exitosamente.\');\\r\\n\\r\\n    // 3. Crear perfil en Firestore (Opcional, para que no falle la UI)\\r\\n    await admin.firestore().collection(\'empleados\').doc(userRecord.uid).set({\\r\\n        uid: userRecord.uid,\\r\\n        name: \'Super Admin\',\\r\\n        email: email,\\r\\n        role: \'admin\',\\r\\n        isAvailable: true\\r\\n    });\\r\\n    console.log(\'Perfil en Firestore creado.\');\\r\\n\\r\\n  } catch (error) {\\r\\n    console.error(\'Error:\', error);\\r\\n  }\\r\\n}\\r\\n\\r\\ncreateSuperAdmin();\\n\\n\\n\\n"},{"id":"81c0d8ocy","name":"DB_SCHEMA_MAP.json","path":"DB_SCHEMA_MAP.json","area":"CONFIG","content":"{\\n  \\"ausencias\\": {\\n    \\"sampleDocId\\": \\"MZTo3j6HC8zcyN1VYmEK\\",\\n    \\"schema\\": {\\n      \\"employeeId\\": \\"kEsOFbXetreRDrG2O3DdKzaFRVh1\\",\\n      \\"employeeName\\": \\"Garcia Valentina\\",\\n      \\"type\\": \\"Enfermedad\\",\\n      \\"startDate\\": \\"2026-01-02\\",\\n      \\"status\\": \\"Justificada\\",\\n      \\"hasCertificate\\": true,\\n      \\"reason\\": \\"Gripe\\",\\n      \\"comments\\": \\"\\",\\n      \\"createdAt\\": \\"2025-12-30T13:04:03.582Z\\",\\n      \\"endDate\\": \\"2026-01-04\\",\\n      \\"id\\": \\"MZTo3j6HC8zcyN1VYmEK\\"\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"clientes\\": {\\n    \\"sampleDocId\\": \\"C2vShpgfPZur9RRDWhy3\\",\\n    \\"schema\\": {\\n      \\"businessName\\": \\"Bacar sa.\\",\\n      \\"cuit\\": \\"30-66813497-8\\",\\n      \\"contactName\\": \\"\\",\\n      \\"contactEmail\\": \\"\\",\\n      \\"status\\": \\"Active\\",\\n      \\"id\\": \\"C2vShpgfPZur9RRDWhy3\\",\\n      \\"createdAt\\": {\\n        \\"_seconds\\": 1764600314,\\n        \\"_nanoseconds\\": 168000000\\n      }\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"clients\\": {\\n    \\"sampleDocId\\": \\"G7X6lne5Pre8Fl8YawGI\\",\\n    \\"schema\\": {\\n      \\"cuit\\": \\"33-66554433-9\\",\\n      \\"condition\\": \\"Resp. Inscripto\\",\\n      \\"web\\": \\"\\",\\n      \\"industry\\": \\"\\",\\n      \\"status\\": \\"activo\\",\\n      \\"address\\": \\"Av. Fuerza aerea 2475\\",\\n      \\"id\\": \\"G7X6lne5Pre8Fl8YawGI\\",\\n      \\"objetivos\\": [\\n        {\\n          \\"id\\": \\"1766790543839\\",\\n          \\"name\\": \\"Casa Central\\",\\n          \\"address\\": \\"Av. Fuerza A茅rea Argentina 2475, X5010 C贸rdoba, Argentina\\",\\n          \\"lat\\": -31.4310826,\\n          \\"lng\\": -64.2206356,\\n          \\"type\\": \\"Planta\\",\\n          \\"contact\\": \\"\\"\\n        }\\n      ],\\n      \\"city\\": \\"Cordoba\\",\\n      \\"phone\\": \\"3515465559\\",\\n      \\"taxId\\": \\"20244722432\\",\\n      \\"name\\": \\"Martinez Almeyra Mauro\\",\\n      \\"fantasyName\\": \\"Logistica del Sur\\",\\n      \\"email\\": \\"mauromartinez@hotmail.com\\",\\n      \\"historial\\": [\\n        {\\n          \\"id\\": \\"1766790515348\\",\\n          \\"date\\": \\"2025-12-26T23:08:35.348Z\\",\\n          \\"note\\": \\"Datos actualizados\\",\\n          \\"user\\": \\"Sistema\\"\\n        },\\n        {\\n          \\"id\\": \\"1767030997799\\",\\n          \\"date\\": \\"2025-12-29T17:56:37.799Z\\",\\n          \\"note\\": \\"Datos actualizados\\",\\n          \\"user\\": \\"Sistema\\"\\n        }\\n      ]\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"contratos_servicio\\": {\\n    \\"sampleDocId\\": \\"3q6nwi3RFekTqlRblRYQ\\",\\n    \\"schema\\": {\\n      \\"objectiveId\\": \\"rqH5QSY3VZDSDaq68B09\\",\\n      \\"name\\": \\"1x24hs\\",\\n      \\"totalHoursPerMonth\\": 720,\\n      \\"startDate\\": {\\n        \\"_seconds\\": 1764997050,\\n        \\"_nanoseconds\\": 657000000\\n      },\\n      \\"isActive\\": true,\\n      \\"id\\": \\"3q6nwi3RFekTqlRblRYQ\\",\\n      \\"daysOfWeek\\": [\\n        1,\\n        2,\\n        3,\\n        4,\\n        5\\n      ],\\n      \\"quantity\\": 1\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"convenios_colectivos\\": {\\n    \\"sampleDocId\\": \\"EvXc0Hl3s7EaSISRyzJr\\",\\n    \\"schema\\": {\\n      \\"id\\": \\"EvXc0Hl3s7EaSISRyzJr\\",\\n      \\"code\\": \\"FUERA_CONVENIO\\",\\n      \\"name\\": \\"Personal Jer谩rquico\\",\\n      \\"maxHoursWeekly\\": 999,\\n      \\"maxHoursMonthly\\": 999,\\n      \\"overtimeThresholdDaily\\": 24,\\n      \\"saturdayCutoffHour\\": 24,\\n      \\"nightShiftStart\\": 22,\\n      \\"nightShiftEnd\\": 6,\\n      \\"isActive\\": true,\\n      \\"createdAt\\": {\\n        \\"_seconds\\": 1765543588,\\n        \\"_nanoseconds\\": 908000000\\n      }\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"empleados\\": {\\n    \\"sampleDocId\\": \\"6egkZ5PfXYgQUkmitsYVe9eDf6v2\\",\\n    \\"schema\\": {\\n      \\"payrollCycleStartDay\\": 26,\\n      \\"isAvailable\\": true,\\n      \\"fileNumber\\": \\"3040\\",\\n      \\"role\\": \\"employee\\",\\n      \\"contractType\\": \\"FullTime\\",\\n      \\"importedBy\\": \\"2fBfJKMseuTKTNZxXVbsM8JUZ0J3\\",\\n      \\"createdAt\\": {\\n        \\"_seconds\\": 1765996268,\\n        \\"_nanoseconds\\": 354000000\\n      },\\n      \\"uid\\": \\"6egkZ5PfXYgQUkmitsYVe9eDf6v2\\",\\n      \\"payrollCycleEndDay\\": 25,\\n      \\"name\\": \\"Iranzo Fernando Flavio\\",\\n      \\"dni\\": \\"37626110\\",\\n      \\"email\\": \\"iranzofernandoflavio@mail.com\\",\\n      \\"password\\": \\"\\",\\n      \\"clientId\\": \\"JcL6UK26aHrwP3sc4qNi\\",\\n      \\"maxHoursPerMonth\\": 176,\\n      \\"legajo\\": \\"3040\\",\\n      \\"cuit\\": \\"37626110\\",\\n      \\"cct\\": \\"Seguridad Privada (CCT 422/05)\\",\\n      \\"id\\": \\"6egkZ5PfXYgQUkmitsYVe9eDf6v2\\",\\n      \\"status\\": \\"Activo\\",\\n      \\"periodType\\": \\"Mensual\\",\\n      \\"cutoffDay\\": 20,\\n      \\"maxHours\\": 200,\\n      \\"address\\": \\"Santiago del Estero 264, X5022FOF C贸rdoba, Argentina\\",\\n      \\"lng\\": -64.1760596,\\n      \\"lat\\": -31.4150737,\\n      \\"cycleStartDay\\": 26,\\n      \\"firstName\\": \\"Iranzo\\",\\n      \\"lastName\\": \\"Fernando Flavio\\",\\n      \\"phone\\": \\"\\",\\n      \\"preferredClientId\\": \\"NXuH05MhMeTD6wJhw4HW\\",\\n      \\"preferredObjectiveId\\": \\"1766792942091\\",\\n      \\"laborAgreement\\": \\"Seguridad Privada (CCT 422/05)\\",\\n      \\"category\\": \\"\\"\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"feriados\\": {\\n    \\"sampleDocId\\": \\"1xGnUhTzBRHMmkfK6ep8\\",\\n    \\"schema\\": {\\n      \\"date\\": \\"2026-08-17\\",\\n      \\"name\\": \\"San Mart铆n\\",\\n      \\"type\\": \\"Trasladable\\"\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"historial_operaciones\\": {\\n    \\"sampleDocId\\": \\"0VSazNuTLSsT2lsAwQjS\\",\\n    \\"schema\\": {\\n      \\"docId\\": \\"f0VmrSt0v8qHL1ntf8Cz\\",\\n      \\"collection\\": \\"turnos\\",\\n      \\"action\\": \\"UPDATE\\",\\n      \\"changedBy\\": \\"BIar6f7ILATdkucXKH9NTDUkKQG2\\",\\n      \\"timestamp\\": {\\n        \\"_seconds\\": 1766086706,\\n        \\"_nanoseconds\\": 265000000\\n      },\\n      \\"details\\": {\\n        \\"before\\": {\\n          \\"emp\\": \\"Mauro Martinez Almeyra\\",\\n          \\"start\\": {\\n            \\"_seconds\\": 1765936800,\\n            \\"_nanoseconds\\": 0\\n          }\\n        },\\n        \\"after\\": {\\n          \\"emp\\": \\"VACANTE\\",\\n          \\"start\\": \\"No Change\\"\\n        },\\n        \\"overtime\\": false\\n      }\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"patrones_servicio\\": {\\n    \\"sampleDocId\\": \\"0W9tZsqrVGEGQ4n5du07\\",\\n    \\"schema\\": {\\n      \\"id\\": \\"0W9tZsqrVGEGQ4n5du07\\",\\n      \\"contractId\\": \\"SYDgtNzZUuZpcZMeitSk\\",\\n      \\"shiftTypeId\\": \\"M4WNVVYiFpmiijGhv3iy\\",\\n      \\"daysOfWeek\\": [\\n        0,\\n        1,\\n        2,\\n        3,\\n        4,\\n        5,\\n        6\\n      ],\\n      \\"quantityPerDay\\": 1,\\n      \\"validTo\\": null,\\n      \\"active\\": true,\\n      \\"createdAt\\": {\\n        \\"_seconds\\": 1765231187,\\n        \\"_nanoseconds\\": 159000000\\n      },\\n      \\"createdBy\\": \\"BIar6f7ILATdkucXKH9NTDUkKQG2\\",\\n      \\"updatedBy\\": \\"BIar6f7ILATdkucXKH9NTDUkKQG2\\",\\n      \\"validFrom\\": {\\n        \\"_seconds\\": 1765236845,\\n        \\"_nanoseconds\\": 224000000\\n      },\\n      \\"updatedAt\\": {\\n        \\"_seconds\\": 1765236838,\\n        \\"_nanoseconds\\": 454000000\\n      }\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"services\\": {\\n    \\"sampleDocId\\": \\"mVQuhqCUBKiSTxhu8sgP\\",\\n    \\"schema\\": {\\n      \\"objectiveId\\": \\"bsfnnuRih0R5SqJMDFFy\\",\\n      \\"name\\": \\"Vigilancia 24hs\\",\\n      \\"scheduleType\\": \\"24x48\\"\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"servicios_sla\\": {\\n    \\"sampleDocId\\": \\"3qZoX2dY5aSbE7RM8QXo\\",\\n    \\"schema\\": {\\n      \\"clientId\\": \\"NXuH05MhMeTD6wJhw4HW\\",\\n      \\"clientName\\": \\"Bacar sa.\\",\\n      \\"objectiveId\\": \\"1766792942091\\",\\n      \\"objectiveName\\": \\"Planta\\",\\n      \\"startDate\\": \\"2026-01-01\\",\\n      \\"shifts\\": [\\n        {\\n          \\"id\\": \\"1766793011723\\",\\n          \\"name\\": \\"Ma帽ana\\",\\n          \\"position\\": \\"Guardia\\",\\n          \\"startTime\\": \\"06:00\\",\\n          \\"endTime\\": \\"14:00\\",\\n          \\"hours\\": 8,\\n          \\"quantity\\": 2,\\n          \\"days\\": [\\n            \\"L\\",\\n            \\"M\\",\\n            \\"X\\",\\n            \\"J\\",\\n            \\"V\\",\\n            \\"S\\",\\n            \\"D\\"\\n          ]\\n        },\\n        {\\n          \\"id\\": \\"1766793049256\\",\\n          \\"name\\": \\"\\",\\n          \\"position\\": \\"Guardia\\",\\n          \\"startTime\\": \\"14:00\\",\\n          \\"endTime\\": \\"22:00\\",\\n          \\"hours\\": 8,\\n          \\"quantity\\": 2,\\n          \\"days\\": [\\n            \\"L\\",\\n            \\"M\\",\\n            \\"X\\",\\n            \\"J\\",\\n            \\"V\\",\\n            \\"S\\",\\n            \\"D\\"\\n          ]\\n        },\\n        {\\n          \\"id\\": \\"1766793064576\\",\\n          \\"name\\": \\"\\",\\n          \\"position\\": \\"Guardia\\",\\n          \\"startTime\\": \\"22:00\\",\\n          \\"endTime\\": \\"06:00\\",\\n          \\"hours\\": 8,\\n          \\"quantity\\": 1,\\n          \\"days\\": [\\n            \\"L\\",\\n            \\"M\\",\\n            \\"X\\",\\n            \\"J\\",\\n            \\"V\\",\\n            \\"S\\",\\n            \\"D\\"\\n          ]\\n        }\\n      ],\\n      \\"status\\": \\"active\\",\\n      \\"endDate\\": \\"2026-01-31\\",\\n      \\"id\\": \\"3qZoX2dY5aSbE7RM8QXo\\",\\n      \\"totalMonthlyHours\\": 1240\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"system_users\\": {\\n    \\"sampleDocId\\": \\"BIar6f7ILATdkucXKH9NTDUkKQG2\\",\\n    \\"schema\\": {\\n      \\"uid\\": \\"BIar6f7ILATdkucXKH9NTDUkKQG2\\",\\n      \\"email\\": \\"admin@bacarsa.com.ar\\",\\n      \\"displayName\\": \\"Mauro Martinez Almeyra\\",\\n      \\"role\\": \\"SuperAdmin\\",\\n      \\"status\\": \\"Active\\",\\n      \\"createdAt\\": {\\n        \\"_seconds\\": 1764609504,\\n        \\"_nanoseconds\\": 375000000\\n      }\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"tipos_turno\\": {\\n    \\"sampleDocId\\": \\"0z4CaocweURKmDa6fI0O\\",\\n    \\"schema\\": {\\n      \\"contractId\\": \\"3q6nwi3RFekTqlRblRYQ\\",\\n      \\"color\\": \\"#4F46E5\\",\\n      \\"id\\": \\"0z4CaocweURKmDa6fI0O\\",\\n      \\"name\\": \\"Turno ma帽ana\\",\\n      \\"code\\": \\"TM\\",\\n      \\"startTime\\": \\"06:00\\",\\n      \\"durationHours\\": 12\\n    },\\n    \\"subcollections\\": []\\n  },\\n  \\"turnos\\": {\\n    \\"sampleDocId\\": \\"092zM6UOemDni3gy8Y40\\",\\n    \\"schema\\": {\\n      \\"schedulerId\\": \\"SYSTEM_GENERATOR\\",\\n      \\"updatedAt\\": {\\n        \\"_seconds\\": 1766418620,\\n        \\"_nanoseconds\\": 12000000\\n      },\\n      \\"status\\": \\"Assigned\\",\\n      \\"role\\": \\"Vigilador\\",\\n      \\"startTime\\": {\\n        \\"_seconds\\": 1766196000,\\n        \\"_nanoseconds\\": 0\\n      },\\n      \\"objectiveId\\": \\"GTIf57iYSYHLDs09JFwO\\",\\n      \\"employeeName\\": \\"VACANTE\\",\\n      \\"id\\": \\"092zM6UOemDni3gy8Y40\\",\\n      \\"endTime\\": {\\n        \\"_seconds\\": 1766224800,\\n        \\"_nanoseconds\\": 0\\n      },\\n      \\"shiftTypeId\\": \\"lX8ev8sf5U4Zx8Da6HXb\\",\\n      \\"objectiveName\\": \\"Sede\\",\\n      \\"employeeId\\": \\"VACANTE\\"\\n    },\\n    \\"subcollections\\": []\\n  }\\n}"},{"id":"l6asw2wbu","name":"drive-auth.json","path":"drive-auth.json","area":"CONFIG","content":"{\\n  \\"type\\": \\"service_account\\",\\n  \\"project_id\\": \\"cronoapp-sync\\",\\n  \\"private_key_id\\": \\"083b1b2d14fa21c46ccc2cb5780e547a59cc2313\\",\\n  \\"private_key\\": \\"-----BEGIN PRIVATE KEY-----\\\\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC0BZeZIzSXs0U3\\\\ncw434rH6yqqob00NGV76vzdGrouggXvha8dKBF7yE8EZ5r5RIePIbGwBo4rUud45\\\\nZZn7WAK/XbtU6isxmZ//qSwPUrXRe6B2PB3lPG2YAarL1uZPu+Tn7j2LMaYQdaiz\\\\nI14f0gUz15JDkCeTatCoQutInddBwtFnLBH9p7fxRIxrmKgPzwuPksd0537GDmua\\\\nHFb7hC/PMSBvjrmdYaX8sAi9F0mdOfaOZC4mMX9FUEndLk6fD/MynO1OO4Rejl6O\\\\nl2O661mYqTa8ubTy9nNiSXIsPVlsmObvKDcJ4PcO44xQPeQFHnMS4kXuqZhHH3iI\\\\nZLIcM+PTAgMBAAECggEAGmZzi/6wuMqOjQovfJyfM0NDcb4Y06Hz3tvp9FCmo1w5\\\\n2Z4ftMgdUGz7NZw0LtvEduEHmdntAzNa1poC0exfQscxMMvCl9yKrUiW8IxVo6n4\\\\npz47uCF7hP5BmPEkB29rq2Ox3NbkHqfSnKrEI/B92NN1XLkoRKM2hGaD8LtNFRSI\\\\nRawp9PeWU4hq90ybQl8z41LSZ+v2JqAAJm/cMioN7WWesxzI5J2dOdYpn+krUnJ4\\\\nX5E50+lUYl/1fSMJTAFc2rymC1JmJgXLa6Cz/Pg7RSVVsy/fUyMhwbdUb5zj1nKO\\\\nj0Eq2Xo9Ef5wqVJv9JA2xiWeFv73PcCmHGR3y/yEsQKBgQD544KxUEEobVVJuavs\\\\nsuKiupbbTbWg7jQMNAdvJDMA1obGqW3m1bUwQNC+29dALpkm3bbZn5KsgjmvO8y+\\\\nL7OOVgFYRgddsOF8aMODB391Fro/cS6qtU+I+4bND7XZdd7occgbqaDw/e0Xfx1A\\\\nSJzrWgB/nlkkq7mIE6l0q6FaKQKBgQC4bKm72XE73+qBiYdyRiMjzb8sMXdwMXP2\\\\ncNDVWt3LEuMwjF4/BMNzfAPZBUSIOvx4lsVRnm3ODiqchN3PbapO9tS49wnJfnNx\\\\nrb+k/ciiHscRtEmwGpYw4nuhAtEVYjFgitxO+sppF9/gx4//eKHv92nFw8D7pTQG\\\\n2xr3G7OFmwKBgQCUUNbXSx0BU7NVaOCEQsCFeV3kmED/XaKCw7bN3pxvGOUxsIpM\\\\ngfdixnWfcnhV3dKE4P+QN0glH74BJeslzsYx6xYtQJNKppuO7ddtQ9wAsRamZRUf\\\\nuTGVykR+HZ7/jRhaun3c/VdK8kvwsD+6Ud7hSbAWDvQ18b7S52iimOPR0QKBgA9H\\\\nwZB05bLmTJHLCVPoh8TRqUNKHfFHx6nlkwf6bWIEAJrnJm/mPyN0ZQU4MINxD7YW\\\\nF+c5TzPBbLpnL9Gd7nx4awugPElblskWckiDVnpIPooy++ABc+w8961RhG1XI2wy\\\\nVSqeEONAPSZsonuyTQiK4VKnc3fmKjdfNA7BVtB9AoGBAMotrZHADpYQRuVCw3RM\\\\nOHjnYF4DRdWnetzC5LJxwcKMFzBaGFsR7ltM9h6oiM0N/a5WVs2gbYQNRVMl0Tt4\\\\nqPNL508Q0vnFmY04YoRO8ZjFIu4iumLutI2HaCROitBaWwopHWSvJcAPBitb6Qri\\\\nvyLpBA90Nvfrvegxjhd+ZjKD\\\\n-----END PRIVATE KEY-----\\\\n\\",\\n  \\"client_email\\": \\"gemini-sync@cronoapp-sync.iam.gserviceaccount.com\\",\\n  \\"client_id\\": \\"112712153854224359746\\",\\n  \\"auth_uri\\": \\"https://accounts.google.com/o/oauth2/auth\\",\\n  \\"token_uri\\": \\"https://oauth2.googleapis.com/token\\",\\n  \\"auth_provider_x509_cert_url\\": \\"https://www.googleapis.com/oauth2/v1/certs\\",\\n  \\"client_x509_cert_url\\": \\"https://www.googleapis.com/robot/v1/metadata/x509/gemini-sync%40cronoapp-sync.iam.gserviceaccount.com\\",\\n  \\"universe_domain\\": \\"googleapis.com\\"\\n}\\n"},{"id":"8y8145a8u","name":"escanear_conexiones.js","path":"escanear_conexiones.js","area":"CONFIG","content":"const fs = require(\'fs\');\\r\\nconst path = require(\'path\');\\r\\n\\r\\nconsole.log(\\"碉 ESCANEANDO PROYECTO PARA DETECTAR CONEXIONES A FIREBASE...\\");\\r\\nconsole.log(\\"============================================================\\");\\r\\n\\r\\nconst ROOT_DIR = path.join(process.cwd(), \'apps\', \'web2\', \'src\');\\r\\n\\r\\nfunction scanDirectory(directory) {\\r\\n    if (!fs.existsSync(directory)) return;\\r\\n\\r\\n    const files = fs.readdirSync(directory);\\r\\n\\r\\n    files.forEach(file => {\\r\\n        const fullPath = path.join(directory, file);\\r\\n        const stat = fs.statSync(fullPath);\\r\\n\\r\\n        if (stat.isDirectory()) {\\r\\n            scanDirectory(fullPath);\\r\\n        } else if (file.endsWith(\'.tsx\') || file.endsWith(\'.ts\') || file.endsWith(\'.js\')) {\\r\\n            checkFile(fullPath);\\r\\n        }\\r\\n    });\\r\\n}\\r\\n\\r\\nfunction checkFile(filePath) {\\r\\n    const content = fs.readFileSync(filePath, \'utf8\');\\r\\n    // Buscamos patrones como: collection(db, \'nombre\') o collection(db, \\"nombre\\")\\r\\n    const regex = /collection\\\\(db,\\\\s*[\'\\"]([^\'\\"]+)[\'\\"]\\\\)/g;\\r\\n    \\r\\n    let match;\\r\\n    while ((match = regex.exec(content)) !== null) {\\r\\n        const collectionName = match[1];\\r\\n        const relativePath = path.relative(process.cwd(), filePath);\\r\\n        \\r\\n        // Filtramos colecciones comunes para resaltar las conflictivas\\r\\n        let color = \\"\\\\x1b[37m\\"; // Blanco\\r\\n        if (collectionName === \'audit_logs\' || collectionName === \'audits\') color = \\"\\\\x1b[31m\\"; // ROJO (Conflictivo)\\r\\n        if (collectionName === \'historial_operaciones\') color = \\"\\\\x1b[32m\\"; // VERDE (Correcto seg煤n Smart)\\r\\n        if (collectionName === \'novedades\') color = \\"\\\\x1b[33m\\"; // AMARILLO\\r\\n        if (collectionName === \'ausencias\') color = \\"\\\\x1b[33m\\"; // AMARILLO\\r\\n        \\r\\n        console.log(`${color}[${collectionName.padEnd(25)}] \\\\x1b[0m -> ${relativePath}`);\\r\\n    }\\r\\n}\\r\\n\\r\\ntry {\\r\\n    scanDirectory(ROOT_DIR);\\r\\n    console.log(\\"\\\\n============================================================\\");\\r\\n    console.log(\\" Escaneo finalizado. Revisa las l铆neas ROJAS.\\");\\r\\n} catch (e) {\\r\\n    console.error(\\"Error escaneando:\\", e);\\r\\n}"},{"id":"swkkietto","name":"eslint.config.js","path":"eslint.config.js","area":"CONFIG","content":"import js from \'@eslint/js\'\\nimport globals from \'globals\'\\nimport reactHooks from \'eslint-plugin-react-hooks\'\\nimport reactRefresh from \'eslint-plugin-react-refresh\'\\nimport { defineConfig, globalIgnores } from \'eslint/config\'\\n\\nexport default defineConfig([\\n  globalIgnores([\'dist\']),\\n  {\\n    files: [\'**/*.{js,jsx}\'],\\n    extends: [\\n      js.configs.recommended,\\n      reactHooks.configs.flat.recommended,\\n      reactRefresh.configs.vite,\\n    ],\\n    languageOptions: {\\n      ecmaVersion: 2020,\\n      globals: globals.browser,\\n      parserOptions: {\\n        ecmaVersion: \'latest\',\\n        ecmaFeatures: { jsx: true },\\n        sourceType: \'module\',\\n      },\\n    },\\n    rules: {\\n      \'no-unused-vars\': [\'error\', { varsIgnorePattern: \'^[A-Z_]\' }],\\n    },\\n  },\\n])\\n\\n\\n\\n\\n"},{"id":"s2e9yto7y","name":"firebase.json","path":"firebase.json","area":"CONFIG","content":"{\\n  \\"functions\\": {\\n    \\"source\\": \\"apps/functions\\",\\n    \\"codebase\\": \\"default\\",\\n    \\"ignore\\": [\\n      \\"node_modules\\",\\n      \\".git\\",\\n      \\"firebase-debug.log\\",\\n      \\"firebase-debug.*.log\\"\\n    ],\\n    \\"predeploy\\": [\\n      \\"npm --prefix \\\\\\"$RESOURCE_DIR\\\\\\" run build\\"\\n    ]\\n  },\\n  \\"hosting\\": {\\n    \\"public\\": \\"apps/web2/out\\",\\n    \\"ignore\\": [\\n      \\"firebase.json\\",\\n      \\"**/.*\\",\\n      \\"**/node_modules/**\\"\\n    ],\\n    \\"rewrites\\": [\\n      {\\n        \\"source\\": \\"**\\",\\n        \\"destination\\": \\"/index.html\\"\\n      }\\n    ],\\n    \\"cleanUrls\\": true,\\n    \\"trailingSlash\\": true\\n  }\\n}"},{"id":"ii82y2xmv","name":"firestore.indexes.json","path":"firestore.indexes.json","area":"CONFIG","content":"{\\r\\n  \\"indexes\\": [\\r\\n    {\\r\\n      \\"collectionGroup\\": \\"ausencias\\",\\r\\n      \\"queryScope\\": \\"COLLECTION\\",\\r\\n      \\"fields\\": [\\r\\n        {\\r\\n          \\"fieldPath\\": \\"employeeId\\",\\r\\n          \\"order\\": \\"ASCENDING\\"\\r\\n        },\\r\\n        {\\r\\n          \\"fieldPath\\": \\"endDate\\",\\r\\n          \\"order\\": \\"ASCENDING\\"\\r\\n        }\\r\\n      ]\\r\\n    },\\r\\n    {\\r\\n      \\"collectionGroup\\": \\"turnos\\",\\r\\n      \\"queryScope\\": \\"COLLECTION\\",\\r\\n      \\"fields\\": [\\r\\n        {\\r\\n          \\"fieldPath\\": \\"employeeId\\",\\r\\n          \\"order\\": \\"ASCENDING\\"\\r\\n        },\\r\\n        {\\r\\n          \\"fieldPath\\": \\"startTime\\",\\r\\n          \\"order\\": \\"ASCENDING\\"\\r\\n        }\\r\\n      ]\\r\\n    }\\r\\n  ],\\r\\n  \\"fieldOverrides\\": []\\r\\n}\\n\\n\\n\\n"},{"id":"3zgxdt0gm","name":"generar_contexto_source.js","path":"generar_contexto_source.js","area":"CONFIG","content":"const fs = require(\'fs\');\\r\\nconst path = require(\'path\');\\r\\n\\r\\n// --- CONFIGURACIN ---\\r\\nconst OUTPUT_FILE = \'contexto_plataforma.txt\';\\r\\n\\r\\n// 1. CARPETAS PROHIBIDAS (Basura, compilados, librer铆as)\\r\\nconst BLACKLIST_DIRS = [\\r\\n    \'node_modules\',\\r\\n    \'.git\',\\r\\n    \'.next\',       // Build de Next.js\\r\\n    \'.firebase\',   // Emuladores/Build de Firebase\\r\\n    \'dist\',        // Build de NestJS/TS\\r\\n    \'build\',       // Build gen茅rico\\r\\n    \'out\',         // Export est谩tico\\r\\n    \'coverage\',    // Reportes de test\\r\\n    \'.vscode\',\\r\\n    \'.idea\',\\r\\n    \'public\',      // Assets est谩ticos (im谩genes, fuentes)\\r\\n    \'assets\',\\r\\n    \'images\'\\r\\n];\\r\\n\\r\\n// 2. EXTENSIONES PERMITIDAS (Solo c贸digo real)\\r\\nconst ALLOWED_EXTS = [\\r\\n    \'.ts\', \'.tsx\',  // TypeScript\\r\\n    \'.js\', \'.jsx\',  // JavaScript\\r\\n    \'.css\', \'.scss\', // Estilos\\r\\n    \'.json\',        // Configuraci贸n\\r\\n    \'.env\'          // Variables de entorno (OJO: Revisa que no haya claves privadas)\\r\\n];\\r\\n\\r\\n// 3. ARCHIVOS DE CONFIGURACIN CLAVE (Se incluyen aunque est茅n en la ra铆z)\\r\\nconst CONFIG_FILES = [\\r\\n    \'package.json\',\\r\\n    \'tsconfig.json\',\\r\\n    \'next.config.js\',\\r\\n    \'next.config.ts\',\\r\\n    \'tailwind.config.js\',\\r\\n    \'tailwind.config.ts\',\\r\\n    \'postcss.config.js\',\\r\\n    \'.eslintrc.json\',\\r\\n    \'firebase.json\',\\r\\n    \'.firebaserc\'\\r\\n];\\r\\n\\r\\n// 4. ARCHIVOS A IGNORAR ESPECFICAMENTE (Locks y logs)\\r\\nconst IGNORE_FILES = [\\r\\n    \'package-lock.json\',\\r\\n    \'yarn.lock\',\\r\\n    \'pnpm-lock.yaml\',\\r\\n    \'npm-debug.log\'\\r\\n];\\r\\n\\r\\nfunction shouldScanDirectory(dirName) {\\r\\n    return !BLACKLIST_DIRS.includes(dirName);\\r\\n}\\r\\n\\r\\nfunction shouldIncludeFile(fileName) {\\r\\n    // Si es un archivo bloqueado expl铆citamente, adi贸s\\r\\n    if (IGNORE_FILES.includes(fileName)) return false;\\r\\n\\r\\n    // Si es un archivo de configuraci贸n clave, adentro\\r\\n    if (CONFIG_FILES.includes(fileName)) return true;\\r\\n\\r\\n    // Si tiene extensi贸n de c贸digo, adentro\\r\\n    const ext = path.extname(fileName).toLowerCase();\\r\\n    return ALLOWED_EXTS.includes(ext);\\r\\n}\\r\\n\\r\\nfunction scanDirectory(dir, fileList = []) {\\r\\n    let files = [];\\r\\n    try {\\r\\n        files = fs.readdirSync(dir);\\r\\n    } catch (err) {\\r\\n        return fileList;\\r\\n    }\\r\\n\\r\\n    files.forEach(file => {\\r\\n        const filePath = path.join(dir, file);\\r\\n        let stat;\\r\\n        try {\\r\\n            stat = fs.statSync(filePath);\\r\\n        } catch (e) { return; }\\r\\n\\r\\n        if (stat.isDirectory()) {\\r\\n            if (shouldScanDirectory(file)) {\\r\\n                scanDirectory(filePath, fileList);\\r\\n            }\\r\\n        } else {\\r\\n            if (shouldIncludeFile(file)) {\\r\\n                // Filtro adicional: Evitar archivos minificados gigantes\\r\\n                if (stat.size < 500 * 1024) { // Menos de 500KB\\r\\n                    fileList.push(filePath);\\r\\n                }\\r\\n            }\\r\\n        }\\r\\n    });\\r\\n\\r\\n    return fileList;\\r\\n}\\r\\n\\r\\nfunction generateContext() {\\r\\n    console.log(\\"★  Iniciando escaneo de c贸digo fuente (PLATAFORMA PURA)...\\");\\r\\n    const rootDir = process.cwd();\\r\\n    \\r\\n    try {\\r\\n        const allFiles = scanDirectory(rootDir);\\r\\n        \\r\\n        // Filtro final de seguridad: Asegurar que NO haya nada con rutas de \'node_modules\' o \'.next\' que se haya colado\\r\\n        const cleanFiles = allFiles.filter(f => \\r\\n            !f.includes(\'node_modules\') && \\r\\n            !f.includes(\'.next\') && \\r\\n            !f.includes(path.sep + \'dist\' + path.sep)\\r\\n        );\\r\\n\\r\\n        let output = `CONTEXTO PLATAFORMA: ${new Date().toISOString()}\\\\n`;\\r\\n        output += `ARCHIVOS FUENTE: ${cleanFiles.length}\\\\n\\\\n`;\\r\\n\\r\\n        console.log(` Encontrados ${cleanFiles.length} archivos de c贸digo.`);\\r\\n\\r\\n        cleanFiles.forEach(filePath => {\\r\\n            const relativePath = path.relative(rootDir, filePath);\\r\\n            \\r\\n            output += `================================================================================\\\\n`;\\r\\n            output += `FILE: ${relativePath}\\\\n`;\\r\\n            output += `================================================================================\\\\n`;\\r\\n            \\r\\n            try {\\r\\n                const content = fs.readFileSync(filePath, \'utf8\');\\r\\n                output += content + \'\\\\n\\\\n\';\\r\\n            } catch (err) {\\r\\n                output += `[ERROR LECTURA]\\\\n\\\\n`;\\r\\n            }\\r\\n        });\\r\\n\\r\\n        fs.writeFileSync(OUTPUT_FILE, output);\\r\\n        console.log(` Archivo generado: ${OUTPUT_FILE}`);\\r\\n        console.log(`   (Este archivo contiene SOLO el c贸digo que t煤 escribiste y configuraciones, nada de compilados).`);\\r\\n\\r\\n    } catch (error) {\\r\\n        console.error(\\" Error:\\", error);\\r\\n    }\\r\\n}\\r\\n\\r\\ngenerateContext();"},{"id":"mtu8crncx","name":"generar_dashboard_ultimate.js","path":"generar_dashboard_ultimate.js","area":"CONFIG","content":"const fs = require(\'fs\');\\r\\nconst path = require(\'path\');\\r\\n\\r\\n// --- CONFIGURACIN ---\\r\\nconst ROOT_DIR = process.cwd();\\r\\nconst OUTPUT_FILE = \'Auditoria_Automatica.html\';\\r\\n\\r\\n// Filtros\\r\\nconst IGNORE_DIRS = [\'node_modules\', \'.git\', \'.next\', \'.firebase\', \'dist\', \'build\', \'coverage\', \'assets\', \'public\', \'.vscode\'];\\r\\nconst ALLOWED_EXTS = [\'.ts\', \'.tsx\', \'.js\', \'.jsx\', \'.json\', \'.css\'];\\r\\n\\r\\n// --- DETECTOR INTELIGENTE DE ESTRUCTURA ---\\r\\nfunction detectarEstructura() {\\r\\n    console.log(` Ra铆z del proyecto: ${ROOT_DIR}`);\\r\\n    const appsDir = path.join(ROOT_DIR, \'apps\');\\r\\n    \\r\\n    let rutas = { BACKEND: [], FRONTEND: [], CONFIG: [ROOT_DIR] };\\r\\n\\r\\n    if (fs.existsSync(appsDir)) {\\r\\n        const subcarpetas = fs.readdirSync(appsDir);\\r\\n        console.log(` Carpetas encontradas en \'apps/\':`, subcarpetas);\\r\\n\\r\\n        subcarpetas.forEach(folder => {\\r\\n            const fullPath = path.join(appsDir, folder);\\r\\n            if (fs.statSync(fullPath).isDirectory() && !IGNORE_DIRS.includes(folder)) {\\r\\n                // Heur铆stica: Si tiene nest-cli.json o main.ts es Backend, si tiene next.config.js o pages/app es Frontend\\r\\n                const esBackend = fs.existsSync(path.join(fullPath, \'nest-cli.json\')) || folder.includes(\'function\') || folder.includes(\'api\');\\r\\n                const tipo = esBackend ? \'BACKEND\' : \'FRONTEND\';\\r\\n                \\r\\n                // Buscar d贸nde est谩 el c贸digo fuente (src o ra铆z)\\r\\n                const srcPath = path.join(fullPath, \'src\');\\r\\n                const targetPath = fs.existsSync(srcPath) ? srcPath : fullPath;\\r\\n                \\r\\n                rutas[tipo].push({ name: folder, path: targetPath });\\r\\n                console.log(`    Detectado ${tipo}: ${folder} (Ruta: ${targetPath})`);\\r\\n            }\\r\\n        });\\r\\n    } else {\\r\\n        console.warn(\\"锔 No existe la carpeta \'apps\'. Escaneando ra铆z como proyecto 煤nico.\\");\\r\\n        rutas.FRONTEND.push({ name: \'Root App\', path: path.join(ROOT_DIR, \'src\') });\\r\\n    }\\r\\n    return rutas;\\r\\n}\\r\\n\\r\\n// --- ESCANER ---\\r\\nfunction scanDir(directory, area, fileList = []) {\\r\\n    if (!fs.existsSync(directory)) return fileList;\\r\\n\\r\\n    try {\\r\\n        const files = fs.readdirSync(directory);\\r\\n        files.forEach(file => {\\r\\n            const fullPath = path.join(directory, file);\\r\\n            const stat = fs.statSync(fullPath);\\r\\n\\r\\n            if (stat.isDirectory()) {\\r\\n                if (!IGNORE_DIRS.includes(file)) scanDir(fullPath, area, fileList);\\r\\n            } else {\\r\\n                if (ALLOWED_EXTS.includes(path.extname(file)) && stat.size < 500 * 1024) {\\r\\n                    fileList.push({\\r\\n                        id: Math.random().toString(36).substr(2, 9),\\r\\n                        name: file,\\r\\n                        path: path.relative(ROOT_DIR, fullPath),\\r\\n                        area: area,\\r\\n                        content: fs.readFileSync(fullPath, \'utf8\')\\r\\n                    });\\r\\n                }\\r\\n            }\\r\\n        });\\r\\n    } catch (e) { console.error(`Error leyendo ${directory}:`, e.message); }\\r\\n    return fileList;\\r\\n}\\r\\n\\r\\n// --- GENERADOR ---\\r\\nfunction generar() {\\r\\n    const estructura = detectarEstructura();\\r\\n    let allFiles = [];\\r\\n\\r\\n    // Escanear Backend(s)\\r\\n    estructura.BACKEND.forEach(sitio => {\\r\\n        allFiles = scanDir(sitio.path, \'BACKEND\', allFiles);\\r\\n    });\\r\\n\\r\\n    // Escanear Frontend(s)\\r\\n    estructura.FRONTEND.forEach(sitio => {\\r\\n        allFiles = scanDir(sitio.path, \'FRONTEND\', allFiles);\\r\\n    });\\r\\n\\r\\n    // Escanear Config Ra铆z (solo archivos sueltos)\\r\\n    const rootFiles = fs.readdirSync(ROOT_DIR).filter(f => fs.statSync(f).isFile() && ALLOWED_EXTS.includes(path.extname(f)));\\r\\n    rootFiles.forEach(f => {\\r\\n        if (!IGNORE_DIRS.includes(f)) {\\r\\n            allFiles.push({\\r\\n                id: Math.random().toString(36).substr(2, 9),\\r\\n                name: f,\\r\\n                path: f,\\r\\n                area: \'CONFIG\',\\r\\n                content: fs.readFileSync(f, \'utf8\')\\r\\n            });\\r\\n        }\\r\\n    });\\r\\n\\r\\n    console.log(` Total archivos indexados: ${allFiles.length}`);\\r\\n\\r\\n    if (allFiles.length === 0) {\\r\\n        console.error(\\" ERROR FATAL: No se encontr贸 ning煤n archivo. Verifica permisos o ubicaci贸n.\\");\\r\\n        return;\\r\\n    }\\r\\n\\r\\n    const jsonFiles = JSON.stringify(allFiles).replace(/\\\\\\\\/g, \'\\\\\\\\\\\\\\\\\').replace(/\'/g, \\"\\\\\\\\\'\\");\\r\\n\\r\\n    // HTML TEMPLATE (Minimalista y Robusto)\\r\\n    const html = `\\r\\n<!DOCTYPE html>\\r\\n<html lang=\\"es\\">\\r\\n<head>\\r\\n    <meta charset=\\"UTF-8\\">\\r\\n    <title>Dashboard T茅cnico Autom谩tico</title>\\r\\n    <style>\\r\\n        body { margin:0; display:flex; height:100vh; font-family: sans-serif; background: #f8fafc; color: #334155; }\\r\\n        aside { width: 300px; background: #0f172a; color: white; display: flex; flex-direction: column; overflow: hidden; }\\r\\n        .header { padding: 20px; border-bottom: 1px solid #334155; }\\r\\n        .header h2 { margin: 0; font-size: 1.2rem; }\\r\\n        .search { padding: 10px; border-bottom: 1px solid #334155; }\\r\\n        .search input { width: 100%; padding: 8px; background: #1e293b; border: none; color: white; border-radius: 4px; }\\r\\n        \\r\\n        .list { flex: 1; overflow-y: auto; padding: 10px; }\\r\\n        .category { font-size: 0.7rem; font-weight: bold; color: #64748b; margin: 15px 0 5px 5px; letter-spacing: 1px; }\\r\\n        .item { padding: 8px 10px; cursor: pointer; font-size: 0.85rem; color: #cbd5e1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\\r\\n        .item:hover { background: rgba(255,255,255,0.1); color: white; border-radius: 4px; }\\r\\n        .item.active { background: #3b82f6; color: white; border-radius: 4px; }\\r\\n\\r\\n        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }\\r\\n        .topbar { height: 50px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }\\r\\n        .path { font-family: monospace; font-size: 0.9rem; color: #64748b; }\\r\\n        .btn-pdf { padding: 5px 15px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }\\r\\n\\r\\n        #codeArea { flex: 1; overflow: auto; padding: 20px; background: #1e293b; color: #e2e8f0; font-family: \'Consolas\', monospace; font-size: 14px; line-height: 1.5; white-space: pre; }\\r\\n        \\r\\n        /* Syntax Highlight Simple */\\r\\n        .kw { color: #c678dd; } .str { color: #98c379; } .cm { color: #7f848e; font-style: italic; }\\r\\n\\r\\n        @media print {\\r\\n            aside, .topbar button { display: none; }\\r\\n            #codeArea { background: white; color: black; border: 1px solid #ccc; white-space: pre-wrap; }\\r\\n        }\\r\\n    </style>\\r\\n</head>\\r\\n<body>\\r\\n    <aside>\\r\\n        <div class=\\"header\\"><h2>CronoApp Audit</h2></div>\\r\\n        <div class=\\"search\\"><input type=\\"text\\" id=\\"search\\" placeholder=\\"Filtrar...\\" onkeyup=\\"render()\\"></div>\\r\\n        <div class=\\"list\\" id=\\"list\\"></div>\\r\\n    </aside>\\r\\n    <main>\\r\\n        <div class=\\"topbar\\">\\r\\n            <span class=\\"path\\" id=\\"pathDisplay\\">Selecciona un archivo</span>\\r\\n            <button class=\\"btn-pdf\\" onclick=\\"window.print()\\">Imprimir / PDF</button>\\r\\n        </div>\\r\\n        <div id=\\"codeArea\\">// El c贸digo aparecer谩 aqu铆</div>\\r\\n    </main>\\r\\n\\r\\n    <script>\\r\\n        const files = ${jsonFiles};\\r\\n        const listEl = document.getElementById(\'list\');\\r\\n        const codeEl = document.getElementById(\'codeArea\');\\r\\n        const pathEl = document.getElementById(\'pathDisplay\');\\r\\n\\r\\n        function render() {\\r\\n            const term = document.getElementById(\'search\').value.toLowerCase();\\r\\n            const filtered = files.filter(f => f.name.toLowerCase().includes(term) || f.path.toLowerCase().includes(term));\\r\\n            \\r\\n            listEl.innerHTML = \'\';\\r\\n            \\r\\n            [\'BACKEND\', \'FRONTEND\', \'CONFIG\'].forEach(area => {\\r\\n                const group = filtered.filter(f => f.area === area);\\r\\n                if (group.length) {\\r\\n                    const title = document.createElement(\'div\');\\r\\n                    title.className = \'category\';\\r\\n                    title.innerText = area;\\r\\n                    listEl.appendChild(title);\\r\\n                    \\r\\n                    group.forEach(f => {\\r\\n                        const div = document.createElement(\'div\');\\r\\n                        div.className = \'item\';\\r\\n                        div.innerText = f.name; // + \' (\' + f.path.split(/[\\\\\\\\\\\\\\\\/]/).slice(-2,-1)[0] + \')\';\\r\\n                        div.onclick = () => load(f, div);\\r\\n                        listEl.appendChild(div);\\r\\n                    });\\r\\n                }\\r\\n            });\\r\\n        }\\r\\n\\r\\n        function load(file, el) {\\r\\n            document.querySelectorAll(\'.item\').forEach(i => i.classList.remove(\'active\'));\\r\\n            el.classList.add(\'active\');\\r\\n            pathEl.innerText = file.path;\\r\\n            \\r\\n            // Highlight b谩sico\\r\\n            let code = file.content\\r\\n                .replace(/&/g, \\"&amp;\\").replace(/</g, \\"&lt;\\")\\r\\n                .replace(/\\\\\\\\b(import|export|const|let|var|function|return|if|else|class)\\\\\\\\b/g, \'<span class=\\"kw\\">$1</span>\')\\r\\n                .replace(/(\'\'\'.*?\'\'\'|\'.*?\'|\\".*?\\")/g, \'<span class=\\"str\\">$1</span>\')\\r\\n                .replace(/(\\\\\\\\/\\\\\\\\/.*)/g, \'<span class=\\"cm\\">$1</span>\');\\r\\n                \\r\\n            codeEl.innerHTML = code;\\r\\n        }\\r\\n\\r\\n        render();\\r\\n    </script>\\r\\n</body>\\r\\n</html>`;\\r\\n\\r\\n    fs.writeFileSync(OUTPUT_FILE, html);\\r\\n    console.log(` Dashboard generado: ${OUTPUT_FILE}`);\\r\\n}\\r\\n\\r\\ngenerar();"},{"id":"milwb971z","name":"package-lock.json","path":"package-lock.json","area":"CONFIG","content":"{\\r\\n  \\"name\\": \\"cronoapp\\",\\r\\n  \\"version\\": \\"1.0.0\\",\\r\\n  \\"lockfileVersion\\": 3,\\r\\n  \\"requires\\": true,\\r\\n  \\"packages\\": {\\r\\n    \\"\\": {\\r\\n      \\"name\\": \\"cronoapp\\",\\r\\n      \\"version\\": \\"1.0.0\\",\\r\\n      \\"license\\": \\"ISC\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/leaflet\\": \\"^1.9.21\\",\\r\\n        \\"clsx\\": \\"^2.1.1\\",\\r\\n        \\"date-fns\\": \\"^4.1.0\\",\\r\\n        \\"firebase-admin\\": \\"^13.6.0\\",\\r\\n        \\"leaflet\\": \\"^1.9.4\\",\\r\\n        \\"lucide-react\\": \\"^0.555.0\\",\\r\\n        \\"pdfkit\\": \\"^0.17.2\\",\\r\\n        \\"react-leaflet\\": \\"^5.0.0\\",\\r\\n        \\"sonner\\": \\"^2.0.7\\",\\r\\n        \\"tailwind-merge\\": \\"^3.4.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@fastify/busboy\\": {\\r\\n      \\"version\\": \\"3.2.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@fastify/busboy/-/busboy-3.2.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-m9FVDXU3GT2ITSe0UaMA5rU3QkfC/UXtCU8y0gSN/GugTqtVldOBWIB5V6V3sbmenVZUIpU6f+mPEO2+m5iTaA==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/@firebase/app-check-interop-types\\": {\\r\\n      \\"version\\": \\"0.3.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@firebase/app-check-interop-types/-/app-check-interop-types-0.3.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-gAlxfPLT2j8bTI/qfe3ahl2I2YcBQ8cFIBdhAQA4I2f3TndcO+22YizyGYuttLHPQEpWkhmpFW60VCFEPg4g5A==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\"\\r\\n    },\\r\\n    \\"node_modules/@firebase/app-types\\": {\\r\\n      \\"version\\": \\"0.9.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@firebase/app-types/-/app-types-0.9.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-kRVpIl4vVGJ4baogMDINbyrIOtOxqhkZQg4jTq3l8Lw6WSk0xfpEYzezFu+Kl4ve4fbPl79dvwRtaFqAC/ucCw==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\"\\r\\n    },\\r\\n    \\"node_modules/@firebase/auth-interop-types\\": {\\r\\n      \\"version\\": \\"0.2.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@firebase/auth-interop-types/-/auth-interop-types-0.2.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-JPgcXKCuO+CWqGDnigBtvo09HeBs5u/Ktc2GaFj2m01hLarbxthLNm7Fk8iOP1aqAtXV+fnnGj7U28xmk7IwVA==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\"\\r\\n    },\\r\\n    \\"node_modules/@firebase/component\\": {\\r\\n      \\"version\\": \\"0.7.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@firebase/component/-/component-0.7.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-wR9En2A+WESUHexjmRHkqtaVH94WLNKt6rmeqZhSLBybg4Wyf0Umk04SZsS6sBq4102ZsDBFwoqMqJYj2IoDSg==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@firebase/util\\": \\"1.13.0\\",\\r\\n        \\"tslib\\": \\"^2.1.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=20.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@firebase/database\\": {\\r\\n      \\"version\\": \\"1.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@firebase/database/-/database-1.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-gM6MJFae3pTyNLoc9VcJNuaUDej0ctdjn3cVtILo3D5lpp0dmUHHLFN/pUKe7ImyeB1KAvRlEYxvIHNF04Filg==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@firebase/app-check-interop-types\\": \\"0.3.3\\",\\r\\n        \\"@firebase/auth-interop-types\\": \\"0.2.4\\",\\r\\n        \\"@firebase/component\\": \\"0.7.0\\",\\r\\n        \\"@firebase/logger\\": \\"0.5.0\\",\\r\\n        \\"@firebase/util\\": \\"1.13.0\\",\\r\\n        \\"faye-websocket\\": \\"0.11.4\\",\\r\\n        \\"tslib\\": \\"^2.1.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=20.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@firebase/database-compat\\": {\\r\\n      \\"version\\": \\"2.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@firebase/database-compat/-/database-compat-2.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-8nYc43RqxScsePVd1qe1xxvWNf0OBnbwHxmXJ7MHSuuTVYFO3eLyLW3PiCKJ9fHnmIz4p4LbieXwz+qtr9PZDg==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@firebase/component\\": \\"0.7.0\\",\\r\\n        \\"@firebase/database\\": \\"1.1.0\\",\\r\\n        \\"@firebase/database-types\\": \\"1.0.16\\",\\r\\n        \\"@firebase/logger\\": \\"0.5.0\\",\\r\\n        \\"@firebase/util\\": \\"1.13.0\\",\\r\\n        \\"tslib\\": \\"^2.1.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=20.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@firebase/database-types\\": {\\r\\n      \\"version\\": \\"1.0.16\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@firebase/database-types/-/database-types-1.0.16.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-xkQLQfU5De7+SPhEGAXFBnDryUWhhlFXelEg2YeZOQMCdoe7dL64DDAd77SQsR+6uoXIZY5MB4y/inCs4GTfcw==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@firebase/app-types\\": \\"0.9.3\\",\\r\\n        \\"@firebase/util\\": \\"1.13.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@firebase/logger\\": {\\r\\n      \\"version\\": \\"0.5.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@firebase/logger/-/logger-0.5.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-cGskaAvkrnh42b3BA3doDWeBmuHFO/Mx5A83rbRDYakPjO9bJtRL3dX7javzc2Rr/JHZf4HlterTW2lUkfeN4g==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"tslib\\": \\"^2.1.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=20.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@firebase/util\\": {\\r\\n      \\"version\\": \\"1.13.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@firebase/util/-/util-1.13.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-0AZUyYUfpMNcztR5l09izHwXkZpghLgCUaAGjtMwXnCg3bj4ml5VgiwqOMOxJ+Nw4qN/zJAaOQBcJ7KGkWStqQ==\\",\\r\\n      \\"hasInstallScript\\": true,\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"tslib\\": \\"^2.1.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=20.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@google-cloud/firestore\\": {\\r\\n      \\"version\\": \\"7.11.6\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@google-cloud/firestore/-/firestore-7.11.6.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-EW/O8ktzwLfyWBOsNuhRoMi8lrC3clHM5LVFhGvO1HCsLozCOOXRAlHrYBoE6HL42Sc8yYMuCb2XqcnJ4OOEpw==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"@opentelemetry/api\\": \\"^1.3.0\\",\\r\\n        \\"fast-deep-equal\\": \\"^3.1.1\\",\\r\\n        \\"functional-red-black-tree\\": \\"^1.0.1\\",\\r\\n        \\"google-gax\\": \\"^4.3.3\\",\\r\\n        \\"protobufjs\\": \\"^7.2.6\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@google-cloud/paginator\\": {\\r\\n      \\"version\\": \\"5.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@google-cloud/paginator/-/paginator-5.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-DJS3s0OVH4zFDB1PzjxAsHqJT6sKVbRwwML0ZBP9PbU7Yebtu/7SWMRzvO2J3nUi9pRNITCfu4LJeooM2w4pjg==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"arrify\\": \\"^2.0.0\\",\\r\\n        \\"extend\\": \\"^3.0.2\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@google-cloud/projectify\\": {\\r\\n      \\"version\\": \\"4.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@google-cloud/projectify/-/projectify-4.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-MmaX6HeSvyPbWGwFq7mXdo0uQZLGBYCwziiLIGq5JVX+/bdI3SAq6bP98trV5eTWfLuvsMcIC1YJOF2vfteLFA==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@google-cloud/promisify\\": {\\r\\n      \\"version\\": \\"4.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@google-cloud/promisify/-/promisify-4.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Orxzlfb9c67A15cq2JQEyVc7wEsmFBmHjZWZYQMUyJ1qivXyMwdyNOs9odi79hze+2zqdTtu1E19IM/FtqZ10g==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@google-cloud/storage\\": {\\r\\n      \\"version\\": \\"7.18.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@google-cloud/storage/-/storage-7.18.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-r3ZwDMiz4nwW6R922Z1pwpePxyRwE5GdevYX63hRmAQUkUQJcBH/79EnQPDv5cOv1mFBgevdNWQfi3tie3dHrQ==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"@google-cloud/paginator\\": \\"^5.0.0\\",\\r\\n        \\"@google-cloud/projectify\\": \\"^4.0.0\\",\\r\\n        \\"@google-cloud/promisify\\": \\"<4.1.0\\",\\r\\n        \\"abort-controller\\": \\"^3.0.0\\",\\r\\n        \\"async-retry\\": \\"^1.3.3\\",\\r\\n        \\"duplexify\\": \\"^4.1.3\\",\\r\\n        \\"fast-xml-parser\\": \\"^4.4.1\\",\\r\\n        \\"gaxios\\": \\"^6.0.2\\",\\r\\n        \\"google-auth-library\\": \\"^9.6.3\\",\\r\\n        \\"html-entities\\": \\"^2.5.2\\",\\r\\n        \\"mime\\": \\"^3.0.0\\",\\r\\n        \\"p-limit\\": \\"^3.0.1\\",\\r\\n        \\"retry-request\\": \\"^7.0.0\\",\\r\\n        \\"teeny-request\\": \\"^9.0.0\\",\\r\\n        \\"uuid\\": \\"^8.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@google-cloud/storage/node_modules/uuid\\": {\\r\\n      \\"version\\": \\"8.3.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/uuid/-/uuid-8.3.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-+NYs2QeMWy+GWFOEm9xnn6HCDp0l7QBD7ml8zLUmJ+93Q5NF0NocErnwkTkXVFNiX3/fpC6afS8Dhb/gz7R7eg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"bin\\": {\\r\\n        \\"uuid\\": \\"dist/bin/uuid\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@grpc/grpc-js\\": {\\r\\n      \\"version\\": \\"1.14.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@grpc/grpc-js/-/grpc-js-1.14.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-QzVUtEFyu05UNx2xr0fCQmStUO17uVQhGNowtxs00IgTZT6/W2PBLfUkj30s0FKJ29VtTa3ArVNIhNP6akQhqA==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"@grpc/proto-loader\\": \\"^0.8.0\\",\\r\\n        \\"@js-sdsl/ordered-map\\": \\"^4.4.2\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=12.10.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@grpc/grpc-js/node_modules/@grpc/proto-loader\\": {\\r\\n      \\"version\\": \\"0.8.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@grpc/proto-loader/-/proto-loader-0.8.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-rc1hOQtjIWGxcxpb9aHAfLpIctjEnsDehj0DAiVfBlmT84uvR0uUtN2hEi/ecvWVjXUGf5qPF4qEgiLOx1YIMQ==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"lodash.camelcase\\": \\"^4.3.0\\",\\r\\n        \\"long\\": \\"^5.0.0\\",\\r\\n        \\"protobufjs\\": \\"^7.5.3\\",\\r\\n        \\"yargs\\": \\"^17.7.2\\"\\r\\n      },\\r\\n      \\"bin\\": {\\r\\n        \\"proto-loader-gen-types\\": \\"build/bin/proto-loader-gen-types.js\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@grpc/proto-loader\\": {\\r\\n      \\"version\\": \\"0.7.15\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@grpc/proto-loader/-/proto-loader-0.7.15.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-tMXdRCfYVixjuFK+Hk0Q1s38gV9zDiDJfWL3h1rv4Qc39oILCu1TRTDt7+fGUI8K4G1Fj125Hx/ru3azECWTyQ==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"lodash.camelcase\\": \\"^4.3.0\\",\\r\\n        \\"long\\": \\"^5.0.0\\",\\r\\n        \\"protobufjs\\": \\"^7.2.5\\",\\r\\n        \\"yargs\\": \\"^17.7.2\\"\\r\\n      },\\r\\n      \\"bin\\": {\\r\\n        \\"proto-loader-gen-types\\": \\"build/bin/proto-loader-gen-types.js\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@js-sdsl/ordered-map\\": {\\r\\n      \\"version\\": \\"4.4.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@js-sdsl/ordered-map/-/ordered-map-4.4.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-iUKgm52T8HOE/makSxjqoWhe95ZJA1/G1sYsGev2JDKUSS14KAgg1LHb+Ba+IPow0xflbnSkOsZcO08C7w1gYw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"funding\\": {\\r\\n        \\"type\\": \\"opencollective\\",\\r\\n        \\"url\\": \\"https://opencollective.com/js-sdsl\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@opentelemetry/api\\": {\\r\\n      \\"version\\": \\"1.9.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@opentelemetry/api/-/api-1.9.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-3giAOQvZiH5F9bMlMiv8+GSPMeqg0dbaeo58/0SlA9sxSqZhnUtxzX9/2FzyhS9sWQf5S0GJE0AKBrFqjpeYcg==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=8.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@protobufjs/aspromise\\": {\\r\\n      \\"version\\": \\"1.1.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@protobufjs/aspromise/-/aspromise-1.1.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-j+gKExEuLmKwvz3OgROXtrJ2UG2x8Ch2YZUxahh+s1F2HZ+wAceUNLkvy6zKCPVRkU++ZWQrdxsUeQXmcg4uoQ==\\",\\r\\n      \\"license\\": \\"BSD-3-Clause\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/@protobufjs/base64\\": {\\r\\n      \\"version\\": \\"1.1.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@protobufjs/base64/-/base64-1.1.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-AZkcAA5vnN/v4PDqKyMR5lx7hZttPDgClv83E//FMNhR2TMcLUhfRUBHCmSl0oi9zMgDDqRUJkSxO3wm85+XLg==\\",\\r\\n      \\"license\\": \\"BSD-3-Clause\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/@protobufjs/codegen\\": {\\r\\n      \\"version\\": \\"2.0.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@protobufjs/codegen/-/codegen-2.0.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-YyFaikqM5sH0ziFZCN3xDC7zeGaB/d0IUb9CATugHWbd1FRFwWwt4ld4OYMPWu5a3Xe01mGAULCdqhMlPl29Jg==\\",\\r\\n      \\"license\\": \\"BSD-3-Clause\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/@protobufjs/eventemitter\\": {\\r\\n      \\"version\\": \\"1.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@protobufjs/eventemitter/-/eventemitter-1.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-j9ednRT81vYJ9OfVuXG6ERSTdEL1xVsNgqpkxMsbIabzSo3goCjDIveeGv5d03om39ML71RdmrGNjG5SReBP/Q==\\",\\r\\n      \\"license\\": \\"BSD-3-Clause\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/@protobufjs/fetch\\": {\\r\\n      \\"version\\": \\"1.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@protobufjs/fetch/-/fetch-1.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-lljVXpqXebpsijW71PZaCYeIcE5on1w5DlQy5WH6GLbFryLUrBD4932W/E2BSpfRJWseIL4v/KPgBFxDOIdKpQ==\\",\\r\\n      \\"license\\": \\"BSD-3-Clause\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"@protobufjs/aspromise\\": \\"^1.1.1\\",\\r\\n        \\"@protobufjs/inquire\\": \\"^1.1.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@protobufjs/float\\": {\\r\\n      \\"version\\": \\"1.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@protobufjs/float/-/float-1.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Ddb+kVXlXst9d+R9PfTIxh1EdNkgoRe5tOX6t01f1lYWOvJnSPDBlG241QLzcyPdoNTsblLUdujGSE4RzrTZGQ==\\",\\r\\n      \\"license\\": \\"BSD-3-Clause\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/@protobufjs/inquire\\": {\\r\\n      \\"version\\": \\"1.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@protobufjs/inquire/-/inquire-1.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-kdSefcPdruJiFMVSbn801t4vFK7KB/5gd2fYvrxhuJYg8ILrmn9SKSX2tZdV6V+ksulWqS7aXjBcRXl3wHoD9Q==\\",\\r\\n      \\"license\\": \\"BSD-3-Clause\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/@protobufjs/path\\": {\\r\\n      \\"version\\": \\"1.1.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@protobufjs/path/-/path-1.1.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-6JOcJ5Tm08dOHAbdR3GrvP+yUUfkjG5ePsHYczMFLq3ZmMkAD98cDgcT2iA1lJ9NVwFd4tH/iSSoe44YWkltEA==\\",\\r\\n      \\"license\\": \\"BSD-3-Clause\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/@protobufjs/pool\\": {\\r\\n      \\"version\\": \\"1.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@protobufjs/pool/-/pool-1.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-0kELaGSIDBKvcgS4zkjz1PeddatrjYcmMWOlAuAPwAeccUrPHdUqo/J6LiymHHEiJT5NrF1UVwxY14f+fy4WQw==\\",\\r\\n      \\"license\\": \\"BSD-3-Clause\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/@protobufjs/utf8\\": {\\r\\n      \\"version\\": \\"1.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@protobufjs/utf8/-/utf8-1.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Vvn3zZrhQZkkBE8LSuW3em98c0FwgO4nxzv6OdSxPKJIEKY2bGbHn+mhGIPerzI4twdxaP8/0+06HBpwf345Lw==\\",\\r\\n      \\"license\\": \\"BSD-3-Clause\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/@react-leaflet/core\\": {\\r\\n      \\"version\\": \\"3.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@react-leaflet/core/-/core-3.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-3EWmekh4Nz+pGcr+xjf0KNyYfC3U2JjnkWsh0zcqaexYqmmB5ZhH37kz41JXGmKzpaMZCnPofBBm64i+YrEvGQ==\\",\\r\\n      \\"license\\": \\"Hippocratic-2.1\\",\\r\\n      \\"peerDependencies\\": {\\r\\n        \\"leaflet\\": \\"^1.9.0\\",\\r\\n        \\"react\\": \\"^19.0.0\\",\\r\\n        \\"react-dom\\": \\"^19.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@swc/helpers\\": {\\r\\n      \\"version\\": \\"0.5.18\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@swc/helpers/-/helpers-0.5.18.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-TXTnIcNJQEKwThMMqBXsZ4VGAza6bvN4pa41Rkqoio6QBKMvo+5lexeTMScGCIxtzgQJzElcvIltani+adC5PQ==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"tslib\\": \\"^2.8.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@tootallnate/once\\": {\\r\\n      \\"version\\": \\"2.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@tootallnate/once/-/once-2.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-XCuKFP5PS55gnMVu3dty8KPatLqUoy/ZYzDzAGCQ8JNFCkLXzmI7vNHCR+XpbZaMWQK/vQubr7PkYq8g470J/A==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 10\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/body-parser\\": {\\r\\n      \\"version\\": \\"1.19.6\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/body-parser/-/body-parser-1.19.6.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-HLFeCYgz89uk22N5Qg3dvGvsv46B8GLvKKo1zKG4NybA8U2DiEO3w9lqGg29t/tfLRJpJ6iQxnVw4OnB7MoM9g==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/connect\\": \\"*\\",\\r\\n        \\"@types/node\\": \\"*\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/caseless\\": {\\r\\n      \\"version\\": \\"0.12.5\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/caseless/-/caseless-0.12.5.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-hWtVTC2q7hc7xZ/RLbxapMvDMgUnDvKvMOpKal4DrMyfGBUfB1oKaZlIRr6mJL+If3bAP6sV/QneGzF6tJjZDg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/@types/connect\\": {\\r\\n      \\"version\\": \\"3.4.38\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/connect/-/connect-3.4.38.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-K6uROf1LD88uDQqJCktA4yzL1YYAK6NgfsI0v/mTgyPKWsX1CnJ0XPSDhViejru1GcRkLWb8RlzFYJRqGUbaug==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/node\\": \\"*\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/express\\": {\\r\\n      \\"version\\": \\"4.17.25\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/express/-/express-4.17.25.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-dVd04UKsfpINUnK0yBoYHDF3xu7xVH4BuDotC/xGuycx4CgbP48X/KF/586bcObxT0HENHXEU8Nqtu6NR+eKhw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/body-parser\\": \\"*\\",\\r\\n        \\"@types/express-serve-static-core\\": \\"^4.17.33\\",\\r\\n        \\"@types/qs\\": \\"*\\",\\r\\n        \\"@types/serve-static\\": \\"^1\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/express-serve-static-core\\": {\\r\\n      \\"version\\": \\"4.19.7\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/express-serve-static-core/-/express-serve-static-core-4.19.7.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-FvPtiIf1LfhzsaIXhv/PHan/2FeQBbtBDtfX2QfvPxdUelMDEckK08SM6nqo1MIZY3RUlfA+HV8+hFUSio78qg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/node\\": \\"*\\",\\r\\n        \\"@types/qs\\": \\"*\\",\\r\\n        \\"@types/range-parser\\": \\"*\\",\\r\\n        \\"@types/send\\": \\"*\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/geojson\\": {\\r\\n      \\"version\\": \\"7946.0.16\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/geojson/-/geojson-7946.0.16.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-6C8nqWur3j98U6+lXDfTUWIfgvZU+EumvpHKcYjujKH7woYyLj2sUmff0tRhrqM7BohUw7Pz3ZB1jj2gW9Fvmg==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/@types/http-errors\\": {\\r\\n      \\"version\\": \\"2.0.5\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/http-errors/-/http-errors-2.0.5.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-r8Tayk8HJnX0FztbZN7oVqGccWgw98T/0neJphO91KkmOzug1KkofZURD4UaD5uH8AqcFLfdPErnBod0u71/qg==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/@types/jsonwebtoken\\": {\\r\\n      \\"version\\": \\"9.0.10\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/jsonwebtoken/-/jsonwebtoken-9.0.10.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-asx5hIG9Qmf/1oStypjanR7iKTv0gXQ1Ov/jfrX6kS/EO0OFni8orbmGCn0672NHR3kXHwpAwR+B368ZGN/2rA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/ms\\": \\"*\\",\\r\\n        \\"@types/node\\": \\"*\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/leaflet\\": {\\r\\n      \\"version\\": \\"1.9.21\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/leaflet/-/leaflet-1.9.21.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-TbAd9DaPGSnzp6QvtYngntMZgcRk+igFELwR2N99XZn7RXUdKgsXMR+28bUO0rPsWp8MIu/f47luLIQuSLYv/w==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/geojson\\": \\"*\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/long\\": {\\r\\n      \\"version\\": \\"4.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/long/-/long-4.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-MqTGEo5bj5t157U6fA/BiDynNkn0YknVdh48CMPkTSpFTVmvao5UQmm7uEF6xBEo7qIMAlY/JSleYaE6VOdpaA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/@types/mime\\": {\\r\\n      \\"version\\": \\"1.3.5\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/mime/-/mime-1.3.5.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-/pyBZWSLD2n0dcHE3hq8s8ZvcETHtEuF+3E7XVt0Ig2nvsVQXdghHVcEkIWjy9A0wKfTn97a/PSDYohKIlnP/w==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/@types/ms\\": {\\r\\n      \\"version\\": \\"2.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/ms/-/ms-2.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-GsCCIZDE/p3i96vtEqx+7dBUGXrc7zeSK3wwPHIaRThS+9OhWIXRqzs4d6k1SVU8g91DrNRWxWUGhp5KXQb2VA==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/@types/node\\": {\\r\\n      \\"version\\": \\"22.19.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/node/-/node-22.19.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-LCCV0HdSZZZb34qifBsyWlUmok6W7ouER+oQIGBScS8EsZsQbrtFTUrDX4hOl+CS6p7cnNC4td+qrSVGSCTUfQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"undici-types\\": \\"~6.21.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/qs\\": {\\r\\n      \\"version\\": \\"6.14.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/qs/-/qs-6.14.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-eOunJqu0K1923aExK6y8p6fsihYEn/BYuQ4g0CxAAgFc4b/ZLN4CrsRZ55srTdqoiLzU2B2evC+apEIxprEzkQ==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/@types/range-parser\\": {\\r\\n      \\"version\\": \\"1.2.7\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/range-parser/-/range-parser-1.2.7.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-hKormJbkJqzQGhziax5PItDUTMAM9uE2XXQmM37dyd4hVM+5aVl7oVxMVUiVQn2oCQFN/LKCZdvSM0pFRqbSmQ==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/@types/request\\": {\\r\\n      \\"version\\": \\"2.48.13\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/request/-/request-2.48.13.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-FGJ6udDNUCjd19pp0Q3iTiDkwhYup7J8hpMW9c4k53NrccQFFWKRho6hvtPPEhnXWKvukfwAlB6DbDz4yhH5Gg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/caseless\\": \\"*\\",\\r\\n        \\"@types/node\\": \\"*\\",\\r\\n        \\"@types/tough-cookie\\": \\"*\\",\\r\\n        \\"form-data\\": \\"^2.5.5\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/send\\": {\\r\\n      \\"version\\": \\"1.2.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/send/-/send-1.2.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-arsCikDvlU99zl1g69TcAB3mzZPpxgw0UQnaHeC1Nwb015xp8bknZv5rIfri9xTOcMuaVgvabfIRA7PSZVuZIQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/node\\": \\"*\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/serve-static\\": {\\r\\n      \\"version\\": \\"1.15.10\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/serve-static/-/serve-static-1.15.10.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-tRs1dB+g8Itk72rlSI2ZrW6vZg0YrLI81iQSTkMmOqnqCaNr/8Ek4VwWcN5vZgCYWbg/JJSGBlUaYGAOP73qBw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/http-errors\\": \\"*\\",\\r\\n        \\"@types/node\\": \\"*\\",\\r\\n        \\"@types/send\\": \\"<1\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/serve-static/node_modules/@types/send\\": {\\r\\n      \\"version\\": \\"0.17.6\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/send/-/send-0.17.6.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Uqt8rPBE8SY0RK8JB1EzVOIZ32uqy8HwdxCnoCOsYrvnswqmFZ/k+9Ikidlk/ImhsdvBsloHbAlewb2IEBV/Og==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/mime\\": \\"^1\\",\\r\\n        \\"@types/node\\": \\"*\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/@types/tough-cookie\\": {\\r\\n      \\"version\\": \\"4.0.5\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/@types/tough-cookie/-/tough-cookie-4.0.5.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-/Ad8+nIOV7Rl++6f1BdKxFSMgmoqEoYbHRpPcx3JEfv8VRsQe9Z4mCXeJBzxs7mbHY/XOZZuXlRNfhpVPbs6ZA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/abort-controller\\": {\\r\\n      \\"version\\": \\"3.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/abort-controller/-/abort-controller-3.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-h8lQ8tacZYnR3vNQTgibj+tODHI5/+l06Au2Pcriv/Gmet0eaj4TwWH41sO9wnHDiQsEj19q0drzdWdeAHtweg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"event-target-shim\\": \\"^5.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=6.5\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/agent-base\\": {\\r\\n      \\"version\\": \\"7.1.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/agent-base/-/agent-base-7.1.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-MnA+YT8fwfJPgBx3m60MNqakm30XOkyIoH1y6huTQvC0PwZG7ki8NacLBcrPbNoo8vEZy7Jpuk7+jMO+CUovTQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/ansi-regex\\": {\\r\\n      \\"version\\": \\"5.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/ansi-regex/-/ansi-regex-5.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=8\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/ansi-styles\\": {\\r\\n      \\"version\\": \\"4.3.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/ansi-styles/-/ansi-styles-4.3.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-zbB9rCJAT1rbjiVDb2hqKFHNYLxgtk8NURxZ3IZwD3F6NtxbXZQCnnSi1Lkx+IDohdPlFp222wVALIheZJQSEg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"color-convert\\": \\"^2.0.1\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=8\\"\\r\\n      },\\r\\n      \\"funding\\": {\\r\\n        \\"url\\": \\"https://github.com/chalk/ansi-styles?sponsor=1\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/arrify\\": {\\r\\n      \\"version\\": \\"2.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/arrify/-/arrify-2.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-3duEwti880xqi4eAMN8AyR4a0ByT90zoYdLlevfrvU43vb0YZwZVfxOgxWrLXXXpyugL0hNZc9G6BiB5B3nUug==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=8\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/async-retry\\": {\\r\\n      \\"version\\": \\"1.3.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/async-retry/-/async-retry-1.3.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-wfr/jstw9xNi/0teMHrRW7dsz3Lt5ARhYNZ2ewpadnhaIp5mbALhOAP+EAdsC7t4Z6wqsDVv9+W6gm1Dk9mEyw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"retry\\": \\"0.13.1\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/asynckit\\": {\\r\\n      \\"version\\": \\"0.4.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/asynckit/-/asynckit-0.4.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Oei9OH4tRh0YqU3GxhX79dM/mwVgvbZJaSNaRk+bshkj0S5cfHcgYakreBjrHwatXKbz+IoIdYLxrKim2MjW0Q==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/base64-js\\": {\\r\\n      \\"version\\": \\"1.5.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/base64-js/-/base64-js-1.5.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-AKpaYlHn8t4SVbOHCy+b5+KKgvR4vrsD8vbvrbiQJps7fKDTkjkDry6ji0rUJjC0kzbNePLwzxq8iypo41qeWA==\\",\\r\\n      \\"funding\\": [\\r\\n        {\\r\\n          \\"type\\": \\"github\\",\\r\\n          \\"url\\": \\"https://github.com/sponsors/feross\\"\\r\\n        },\\r\\n        {\\r\\n          \\"type\\": \\"patreon\\",\\r\\n          \\"url\\": \\"https://www.patreon.com/feross\\"\\r\\n        },\\r\\n        {\\r\\n          \\"type\\": \\"consulting\\",\\r\\n          \\"url\\": \\"https://feross.org/support\\"\\r\\n        }\\r\\n      ],\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/bignumber.js\\": {\\r\\n      \\"version\\": \\"9.3.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/bignumber.js/-/bignumber.js-9.3.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Ko0uX15oIUS7wJ3Rb30Fs6SkVbLmPBAKdlm7q9+ak9bbIeFf0MwuBsQV6z7+X768/cHsfg+WlysDWJcmthjsjQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\"*\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/brotli\\": {\\r\\n      \\"version\\": \\"1.3.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/brotli/-/brotli-1.3.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-oTKjJdShmDuGW94SyyaoQvAjf30dZaHnjJ8uAF+u2/vGJkJbJPJAT1gDiOJP5v1Zb6f9KEyW/1HpuaWIXtGHPg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"base64-js\\": \\"^1.1.2\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/buffer-equal-constant-time\\": {\\r\\n      \\"version\\": \\"1.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/buffer-equal-constant-time/-/buffer-equal-constant-time-1.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-zRpUiDwd/xk6ADqPMATG8vc9VPrkck7T07OIx0gnjmJAnHnTVXNQG3vfvWNuiZIkwu9KrKdA1iJKfsfTVxE6NA==\\",\\r\\n      \\"license\\": \\"BSD-3-Clause\\"\\r\\n    },\\r\\n    \\"node_modules/call-bind-apply-helpers\\": {\\r\\n      \\"version\\": \\"1.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/call-bind-apply-helpers/-/call-bind-apply-helpers-1.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Sp1ablJ0ivDkSzjcaJdxEunN5/XvksFJ2sMBFfq6x0ryhQV/2b/KwFe21cMpmHtPOSij8K99/wSfoEuTObmuMQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"es-errors\\": \\"^1.3.0\\",\\r\\n        \\"function-bind\\": \\"^1.1.2\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/cliui\\": {\\r\\n      \\"version\\": \\"8.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/cliui/-/cliui-8.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-BSeNnyus75C4//NQ9gQt1/csTXyo/8Sb+afLAkzAptFuMsod9HFokGNudZpi/oQV73hnVK+sR+5PVRMd+Dr7YQ==\\",\\r\\n      \\"license\\": \\"ISC\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"string-width\\": \\"^4.2.0\\",\\r\\n        \\"strip-ansi\\": \\"^6.0.1\\",\\r\\n        \\"wrap-ansi\\": \\"^7.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=12\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/clone\\": {\\r\\n      \\"version\\": \\"2.1.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/clone/-/clone-2.1.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-3Pe/CF1Nn94hyhIYpjtiLhdCoEoz0DqQ+988E9gmeEdQZlojxnOb74wctFyuwWQHzqyf9X7C7MG8juUpqBJT8w==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=0.8\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/clsx\\": {\\r\\n      \\"version\\": \\"2.1.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/clsx/-/clsx-2.1.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-eYm0QWBtUrBWZWG0d386OGAw16Z995PiOVo2B7bjWSbHedGl5e0ZWaq65kOGgUSNesEIDkB9ISbTg/JK9dhCZA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/color-convert\\": {\\r\\n      \\"version\\": \\"2.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/color-convert/-/color-convert-2.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-RRECPsj7iu/xb5oKYcsFHSppFNnsj/52OVTRKb4zP5onXwVF3zVmmToNcOfGC+CRDpfK/U584fMg38ZHCaElKQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"color-name\\": \\"~1.1.4\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=7.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/color-name\\": {\\r\\n      \\"version\\": \\"1.1.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/color-name/-/color-name-1.1.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/combined-stream\\": {\\r\\n      \\"version\\": \\"1.0.8\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/combined-stream/-/combined-stream-1.0.8.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-FQN4MRfuJeHf7cBbBMJFXhKSDq+2kAArBlmRBvcvFE5BB1HZKXtSFASDhdlz9zOYwxh8lDdnvmMOe/+5cdoEdg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"delayed-stream\\": \\"~1.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.8\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/crypto-js\\": {\\r\\n      \\"version\\": \\"4.2.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/crypto-js/-/crypto-js-4.2.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-KALDyEYgpY+Rlob/iriUtjV6d5Eq+Y191A5g4UqLAi8CyGP9N1+FdVbkc1SxKc2r4YAYqG8JzO2KGL+AizD70Q==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/date-fns\\": {\\r\\n      \\"version\\": \\"4.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/date-fns/-/date-fns-4.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Ukq0owbQXxa/U3EGtsdVBkR1w7KOQ5gIBqdH2hkvknzZPYvBxb/aa6E8L7tmjFtkwZBu3UXBbjIgPo/Ez4xaNg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"funding\\": {\\r\\n        \\"type\\": \\"github\\",\\r\\n        \\"url\\": \\"https://github.com/sponsors/kossnocorp\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/debug\\": {\\r\\n      \\"version\\": \\"4.4.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/debug/-/debug-4.4.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-RGwwWnwQvkVfavKVt22FGLw+xYSdzARwm0ru6DhTVA3umU5hZc28V3kO4stgYryrTlLpuvgI9GiijltAjNbcqA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"ms\\": \\"^2.1.3\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=6.0\\"\\r\\n      },\\r\\n      \\"peerDependenciesMeta\\": {\\r\\n        \\"supports-color\\": {\\r\\n          \\"optional\\": true\\r\\n        }\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/delayed-stream\\": {\\r\\n      \\"version\\": \\"1.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/delayed-stream/-/delayed-stream-1.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-ZySD7Nf91aLB0RxL4KGrKHBXl7Eds1DAmEdcoVawXnLD7SDhpNgtuII2aAkg7a7QS41jxPSZ17p4VdGnMHk3MQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=0.4.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/dfa\\": {\\r\\n      \\"version\\": \\"1.2.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/dfa/-/dfa-1.2.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-ED3jP8saaweFTjeGX8HQPjeC1YYyZs98jGNZx6IiBvxW7JG5v492kamAQB3m2wop07CvU/RQmzcKr6bgcC5D/Q==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/dunder-proto\\": {\\r\\n      \\"version\\": \\"1.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/dunder-proto/-/dunder-proto-1.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-KIN/nDJBQRcXw0MLVhZE9iQHmG68qAVIBg9CqmUYjmQIhgij9U5MFvrqkUL5FbtyyzZuOeOt0zdeRe4UY7ct+A==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"call-bind-apply-helpers\\": \\"^1.0.1\\",\\r\\n        \\"es-errors\\": \\"^1.3.0\\",\\r\\n        \\"gopd\\": \\"^1.2.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/duplexify\\": {\\r\\n      \\"version\\": \\"4.1.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/duplexify/-/duplexify-4.1.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-M3BmBhwJRZsSx38lZyhE53Csddgzl5R7xGJNk7CVddZD6CcmwMCH8J+7AprIrQKH7TonKxaCjcv27Qmf+sQ+oA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"end-of-stream\\": \\"^1.4.1\\",\\r\\n        \\"inherits\\": \\"^2.0.3\\",\\r\\n        \\"readable-stream\\": \\"^3.1.1\\",\\r\\n        \\"stream-shift\\": \\"^1.0.2\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/ecdsa-sig-formatter\\": {\\r\\n      \\"version\\": \\"1.0.11\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/ecdsa-sig-formatter/-/ecdsa-sig-formatter-1.0.11.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-nagl3RYrbNv6kQkeJIpt6NJZy8twLB/2vtz6yN9Z4vRKHN4/QZJIEbqohALSgwKdnksuY3k5Addp5lg8sVoVcQ==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"safe-buffer\\": \\"^5.0.1\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/emoji-regex\\": {\\r\\n      \\"version\\": \\"8.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/end-of-stream\\": {\\r\\n      \\"version\\": \\"1.4.5\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/end-of-stream/-/end-of-stream-1.4.5.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-ooEGc6HP26xXq/N+GCGOT0JKCLDGrq2bQUZrQ7gyrJiZANJ/8YDTxTpQBXGMn+WbIQXNVpyWymm7KYVICQnyOg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"once\\": \\"^1.4.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/es-define-property\\": {\\r\\n      \\"version\\": \\"1.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/es-define-property/-/es-define-property-1.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-e3nRfgfUZ4rNGL232gUgX06QNyyez04KdjFrF+LTRoOXmrOgFKDg4BCdsjW8EnT69eqdYGmRpJwiPVYNrCaW3g==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/es-errors\\": {\\r\\n      \\"version\\": \\"1.3.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/es-errors/-/es-errors-1.3.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Zf5H2Kxt2xjTvbJvP2ZWLEICxA6j+hAmMzIlypy4xcBg1vKVnx89Wy0GbS+kf5cwCVFFzdCFh2XSCFNULS6csw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/es-object-atoms\\": {\\r\\n      \\"version\\": \\"1.1.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/es-object-atoms/-/es-object-atoms-1.1.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-FGgH2h8zKNim9ljj7dankFPcICIK9Cp5bm+c2gQSYePhpaG5+esrLODihIorn+Pe6FGJzWhXQotPv73jTaldXA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"es-errors\\": \\"^1.3.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/es-set-tostringtag\\": {\\r\\n      \\"version\\": \\"2.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/es-set-tostringtag/-/es-set-tostringtag-2.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-j6vWzfrGVfyXxge+O0x5sh6cvxAog0a/4Rdd2K36zCMV5eJ+/+tOAngRO8cODMNWbVRdVlmGZQL2YS3yR8bIUA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"es-errors\\": \\"^1.3.0\\",\\r\\n        \\"get-intrinsic\\": \\"^1.2.6\\",\\r\\n        \\"has-tostringtag\\": \\"^1.0.2\\",\\r\\n        \\"hasown\\": \\"^2.0.2\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/escalade\\": {\\r\\n      \\"version\\": \\"3.2.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/escalade/-/escalade-3.2.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/event-target-shim\\": {\\r\\n      \\"version\\": \\"5.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/event-target-shim/-/event-target-shim-5.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-i/2XbnSz/uxRCU6+NdVJgKWDTM427+MqYbkQzD321DuCQJUqOuJKIA0IM2+W2xtYHdKOmZ4dR6fExsd4SXL+WQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/extend\\": {\\r\\n      \\"version\\": \\"3.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/extend/-/extend-3.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-fjquC59cD7CyW6urNXK0FBufkZcoiGG80wTuPujX590cB5Ttln20E2UB4S/WARVqhXffZl2LNgS+gQdPIIim/g==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/farmhash-modern\\": {\\r\\n      \\"version\\": \\"1.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/farmhash-modern/-/farmhash-modern-1.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-6ypT4XfgqJk/F3Yuv4SX26I3doUjt0GTG4a+JgWxXQpxXzTBq8fPUeGHfcYMMDPHJHm3yPOSjaeBwBGAHWXCdA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=18.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/fast-deep-equal\\": {\\r\\n      \\"version\\": \\"3.1.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/fast-deep-equal/-/fast-deep-equal-3.1.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-f3qQ9oQy9j2AhBe/H9VC91wLmKBCCU/gDOnKNAYG5hswO7BLKj09Hc5HYNz9cGI++xlpDCIgDaitVs03ATR84Q==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/fast-xml-parser\\": {\\r\\n      \\"version\\": \\"4.5.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/fast-xml-parser/-/fast-xml-parser-4.5.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-RKihhV+SHsIUGXObeVy9AXiBbFwkVk7Syp8XgwN5U3JV416+Gwp/GO9i0JYKmikykgz/UHRrrV4ROuZEo/T0ig==\\",\\r\\n      \\"funding\\": [\\r\\n        {\\r\\n          \\"type\\": \\"github\\",\\r\\n          \\"url\\": \\"https://github.com/sponsors/NaturalIntelligence\\"\\r\\n        }\\r\\n      ],\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"strnum\\": \\"^1.1.1\\"\\r\\n      },\\r\\n      \\"bin\\": {\\r\\n        \\"fxparser\\": \\"src/cli/cli.js\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/faye-websocket\\": {\\r\\n      \\"version\\": \\"0.11.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/faye-websocket/-/faye-websocket-0.11.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-CzbClwlXAuiRQAlUyfqPgvPoNKTckTPGfwZV4ZdAhVcP2lh9KUxJg2b5GkE7XbjKQ3YJnQ9z6D9ntLAlB+tP8g==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"websocket-driver\\": \\">=0.5.1\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=0.8.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/firebase-admin\\": {\\r\\n      \\"version\\": \\"13.6.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/firebase-admin/-/firebase-admin-13.6.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-GdPA/t0+Cq8p1JnjFRBmxRxAGvF/kl2yfdhALl38PrRp325YxyQ5aNaHui0XmaKcKiGRFIJ/EgBNWFoDP0onjw==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@fastify/busboy\\": \\"^3.0.0\\",\\r\\n        \\"@firebase/database-compat\\": \\"^2.0.0\\",\\r\\n        \\"@firebase/database-types\\": \\"^1.0.6\\",\\r\\n        \\"@types/node\\": \\"^22.8.7\\",\\r\\n        \\"farmhash-modern\\": \\"^1.1.0\\",\\r\\n        \\"fast-deep-equal\\": \\"^3.1.1\\",\\r\\n        \\"google-auth-library\\": \\"^9.14.2\\",\\r\\n        \\"jsonwebtoken\\": \\"^9.0.0\\",\\r\\n        \\"jwks-rsa\\": \\"^3.1.0\\",\\r\\n        \\"node-forge\\": \\"^1.3.1\\",\\r\\n        \\"uuid\\": \\"^11.0.2\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=18\\"\\r\\n      },\\r\\n      \\"optionalDependencies\\": {\\r\\n        \\"@google-cloud/firestore\\": \\"^7.11.0\\",\\r\\n        \\"@google-cloud/storage\\": \\"^7.14.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/fontkit\\": {\\r\\n      \\"version\\": \\"2.0.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/fontkit/-/fontkit-2.0.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-syetQadaUEDNdxdugga9CpEYVaQIxOwk7GlwZWWZ19//qW4zE5bknOKeMBDYAASwnpaSHKJITRLMF9m1fp3s6g==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@swc/helpers\\": \\"^0.5.12\\",\\r\\n        \\"brotli\\": \\"^1.3.2\\",\\r\\n        \\"clone\\": \\"^2.1.2\\",\\r\\n        \\"dfa\\": \\"^1.2.0\\",\\r\\n        \\"fast-deep-equal\\": \\"^3.1.3\\",\\r\\n        \\"restructure\\": \\"^3.0.0\\",\\r\\n        \\"tiny-inflate\\": \\"^1.0.3\\",\\r\\n        \\"unicode-properties\\": \\"^1.4.0\\",\\r\\n        \\"unicode-trie\\": \\"^2.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/form-data\\": {\\r\\n      \\"version\\": \\"2.5.5\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/form-data/-/form-data-2.5.5.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-jqdObeR2rxZZbPSGL+3VckHMYtu+f9//KXBsVny6JSX/pa38Fy+bGjuG8eW/H6USNQWhLi8Num++cU2yOCNz4A==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"asynckit\\": \\"^0.4.0\\",\\r\\n        \\"combined-stream\\": \\"^1.0.8\\",\\r\\n        \\"es-set-tostringtag\\": \\"^2.1.0\\",\\r\\n        \\"hasown\\": \\"^2.0.2\\",\\r\\n        \\"mime-types\\": \\"^2.1.35\\",\\r\\n        \\"safe-buffer\\": \\"^5.2.1\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.12\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/function-bind\\": {\\r\\n      \\"version\\": \\"1.1.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/function-bind/-/function-bind-1.1.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"funding\\": {\\r\\n        \\"url\\": \\"https://github.com/sponsors/ljharb\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/functional-red-black-tree\\": {\\r\\n      \\"version\\": \\"1.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/functional-red-black-tree/-/functional-red-black-tree-1.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-dsKNQNdj6xA3T+QlADDA7mOSlX0qiMINjn0cgr+eGHGsbSHzTabcIogz2+p/iqP1Xs6EP/sS2SbqH+brGTbq0g==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/gaxios\\": {\\r\\n      \\"version\\": \\"6.7.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/gaxios/-/gaxios-6.7.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-LDODD4TMYx7XXdpwxAVRAIAuB0bzv0s+ywFonY46k126qzQHT9ygyoa9tncmOiQmmDrik65UYsEkv3lbfqQ3yQ==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"extend\\": \\"^3.0.2\\",\\r\\n        \\"https-proxy-agent\\": \\"^7.0.1\\",\\r\\n        \\"is-stream\\": \\"^2.0.0\\",\\r\\n        \\"node-fetch\\": \\"^2.6.9\\",\\r\\n        \\"uuid\\": \\"^9.0.1\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/gaxios/node_modules/uuid\\": {\\r\\n      \\"version\\": \\"9.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/uuid/-/uuid-9.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-b+1eJOlsR9K8HJpow9Ok3fiWOWSIcIzXodvv0rQjVoOVNpWMpxf1wZNpt4y9h10odCNrqnYp1OBzRktckBe3sA==\\",\\r\\n      \\"funding\\": [\\r\\n        \\"https://github.com/sponsors/broofa\\",\\r\\n        \\"https://github.com/sponsors/ctavan\\"\\r\\n      ],\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"bin\\": {\\r\\n        \\"uuid\\": \\"dist/bin/uuid\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/gcp-metadata\\": {\\r\\n      \\"version\\": \\"6.1.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/gcp-metadata/-/gcp-metadata-6.1.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-a4tiq7E0/5fTjxPAaH4jpjkSv/uCaU2p5KC6HVGrvl0cDjA8iBZv4vv1gyzlmK0ZUKqwpOyQMKzZQe3lTit77A==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"gaxios\\": \\"^6.1.1\\",\\r\\n        \\"google-logging-utils\\": \\"^0.0.2\\",\\r\\n        \\"json-bigint\\": \\"^1.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/get-caller-file\\": {\\r\\n      \\"version\\": \\"2.0.5\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/get-caller-file/-/get-caller-file-2.0.5.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-DyFP3BM/3YHTQOCUL/w0OZHR0lpKeGrxotcHWcqNEdnltqFwXVfhEBQ94eIo34AfQpo0rGki4cyIiftY06h2Fg==\\",\\r\\n      \\"license\\": \\"ISC\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\"6.* || 8.* || >= 10.*\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/get-intrinsic\\": {\\r\\n      \\"version\\": \\"1.3.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/get-intrinsic/-/get-intrinsic-1.3.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-9fSjSaos/fRIVIp+xSJlE6lfwhES7LNtKaCBIamHsjr2na1BiABJPo0mOjjz8GJDURarmCPGqaiVg5mfjb98CQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"call-bind-apply-helpers\\": \\"^1.0.2\\",\\r\\n        \\"es-define-property\\": \\"^1.0.1\\",\\r\\n        \\"es-errors\\": \\"^1.3.0\\",\\r\\n        \\"es-object-atoms\\": \\"^1.1.1\\",\\r\\n        \\"function-bind\\": \\"^1.1.2\\",\\r\\n        \\"get-proto\\": \\"^1.0.1\\",\\r\\n        \\"gopd\\": \\"^1.2.0\\",\\r\\n        \\"has-symbols\\": \\"^1.1.0\\",\\r\\n        \\"hasown\\": \\"^2.0.2\\",\\r\\n        \\"math-intrinsics\\": \\"^1.1.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      },\\r\\n      \\"funding\\": {\\r\\n        \\"url\\": \\"https://github.com/sponsors/ljharb\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/get-proto\\": {\\r\\n      \\"version\\": \\"1.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/get-proto/-/get-proto-1.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-sTSfBjoXBp89JvIKIefqw7U2CCebsc74kiY6awiGogKtoSGbgjYE/G/+l9sF3MWFPNc9IcoOC4ODfKHfxFmp0g==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"dunder-proto\\": \\"^1.0.1\\",\\r\\n        \\"es-object-atoms\\": \\"^1.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/google-auth-library\\": {\\r\\n      \\"version\\": \\"9.15.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/google-auth-library/-/google-auth-library-9.15.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Jb6Z0+nvECVz+2lzSMt9u98UsoakXxA2HGHMCxh+so3n90XgYWkq5dur19JAJV7ONiJY22yBTyJB1TSkvPq9Ng==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"base64-js\\": \\"^1.3.0\\",\\r\\n        \\"ecdsa-sig-formatter\\": \\"^1.0.11\\",\\r\\n        \\"gaxios\\": \\"^6.1.1\\",\\r\\n        \\"gcp-metadata\\": \\"^6.1.0\\",\\r\\n        \\"gtoken\\": \\"^7.0.0\\",\\r\\n        \\"jws\\": \\"^4.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/google-gax\\": {\\r\\n      \\"version\\": \\"4.6.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/google-gax/-/google-gax-4.6.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-V6eky/xz2mcKfAd1Ioxyd6nmA61gao3n01C+YeuIwu3vzM9EDR6wcVzMSIbLMDXWeoi9SHYctXuKYC5uJUT3eQ==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"@grpc/grpc-js\\": \\"^1.10.9\\",\\r\\n        \\"@grpc/proto-loader\\": \\"^0.7.13\\",\\r\\n        \\"@types/long\\": \\"^4.0.0\\",\\r\\n        \\"abort-controller\\": \\"^3.0.0\\",\\r\\n        \\"duplexify\\": \\"^4.0.0\\",\\r\\n        \\"google-auth-library\\": \\"^9.3.0\\",\\r\\n        \\"node-fetch\\": \\"^2.7.0\\",\\r\\n        \\"object-hash\\": \\"^3.0.0\\",\\r\\n        \\"proto3-json-serializer\\": \\"^2.0.2\\",\\r\\n        \\"protobufjs\\": \\"^7.3.2\\",\\r\\n        \\"retry-request\\": \\"^7.0.0\\",\\r\\n        \\"uuid\\": \\"^9.0.1\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/google-gax/node_modules/uuid\\": {\\r\\n      \\"version\\": \\"9.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/uuid/-/uuid-9.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-b+1eJOlsR9K8HJpow9Ok3fiWOWSIcIzXodvv0rQjVoOVNpWMpxf1wZNpt4y9h10odCNrqnYp1OBzRktckBe3sA==\\",\\r\\n      \\"funding\\": [\\r\\n        \\"https://github.com/sponsors/broofa\\",\\r\\n        \\"https://github.com/sponsors/ctavan\\"\\r\\n      ],\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"bin\\": {\\r\\n        \\"uuid\\": \\"dist/bin/uuid\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/google-logging-utils\\": {\\r\\n      \\"version\\": \\"0.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/google-logging-utils/-/google-logging-utils-0.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-NEgUnEcBiP5HrPzufUkBzJOD/Sxsco3rLNo1F1TNf7ieU8ryUzBhqba8r756CjLX7rn3fHl6iLEwPYuqpoKgQQ==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/gopd\\": {\\r\\n      \\"version\\": \\"1.2.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/gopd/-/gopd-1.2.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-ZUKRh6/kUFoAiTAtTYPZJ3hw9wNxx+BIBOijnlG9PnrJsCcSjs1wyyD6vJpaYtgnzDrKYRSqf3OO6Rfa93xsRg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      },\\r\\n      \\"funding\\": {\\r\\n        \\"url\\": \\"https://github.com/sponsors/ljharb\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/gtoken\\": {\\r\\n      \\"version\\": \\"7.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/gtoken/-/gtoken-7.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-pCcEwRi+TKpMlxAQObHDQ56KawURgyAf6jtIY046fJ5tIv3zDe/LEIubckAO8fj6JnAxLdmWkUfNyulQ2iKdEw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"gaxios\\": \\"^6.0.0\\",\\r\\n        \\"jws\\": \\"^4.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/has-symbols\\": {\\r\\n      \\"version\\": \\"1.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/has-symbols/-/has-symbols-1.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-1cDNdwJ2Jaohmb3sg4OmKaMBwuC48sYni5HUw2DvsC8LjGTLK9h+eb1X6RyuOHe4hT0ULCW68iomhjUoKUqlPQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      },\\r\\n      \\"funding\\": {\\r\\n        \\"url\\": \\"https://github.com/sponsors/ljharb\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/has-tostringtag\\": {\\r\\n      \\"version\\": \\"1.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/has-tostringtag/-/has-tostringtag-1.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-NqADB8VjPFLM2V0VvHUewwwsw0ZWBaIdgo+ieHtK3hasLz4qeCRjYcqfB6AQrBggRKppKF8L52/VqdVsO47Dlw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"has-symbols\\": \\"^1.0.3\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      },\\r\\n      \\"funding\\": {\\r\\n        \\"url\\": \\"https://github.com/sponsors/ljharb\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/hasown\\": {\\r\\n      \\"version\\": \\"2.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/hasown/-/hasown-2.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"function-bind\\": \\"^1.1.2\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/html-entities\\": {\\r\\n      \\"version\\": \\"2.6.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/html-entities/-/html-entities-2.6.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-kig+rMn/QOVRvr7c86gQ8lWXq+Hkv6CbAH1hLu+RG338StTpE8Z0b44SDVaqVu7HGKf27frdmUYEs9hTUX/cLQ==\\",\\r\\n      \\"funding\\": [\\r\\n        {\\r\\n          \\"type\\": \\"github\\",\\r\\n          \\"url\\": \\"https://github.com/sponsors/mdevils\\"\\r\\n        },\\r\\n        {\\r\\n          \\"type\\": \\"patreon\\",\\r\\n          \\"url\\": \\"https://patreon.com/mdevils\\"\\r\\n        }\\r\\n      ],\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/http-parser-js\\": {\\r\\n      \\"version\\": \\"0.5.10\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/http-parser-js/-/http-parser-js-0.5.10.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Pysuw9XpUq5dVc/2SMHpuTY01RFl8fttgcyunjL7eEMhGM3cI4eOmiCycJDVCo/7O7ClfQD3SaI6ftDzqOXYMA==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/http-proxy-agent\\": {\\r\\n      \\"version\\": \\"5.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/http-proxy-agent/-/http-proxy-agent-5.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-n2hY8YdoRE1i7r6M0w9DIw5GgZN0G25P8zLCRQ8rjXtTU3vsNFBI/vWK/UIeE6g5MUUz6avwAPXmL6Fy9D/90w==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"@tootallnate/once\\": \\"2\\",\\r\\n        \\"agent-base\\": \\"6\\",\\r\\n        \\"debug\\": \\"4\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/http-proxy-agent/node_modules/agent-base\\": {\\r\\n      \\"version\\": \\"6.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/agent-base/-/agent-base-6.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-RZNwNclF7+MS/8bDg70amg32dyeZGZxiDuQmZxKLAlQjr3jGyLx+4Kkk58UO7D2QdgFIQCovuSuZESne6RG6XQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"debug\\": \\"4\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 6.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/https-proxy-agent\\": {\\r\\n      \\"version\\": \\"7.0.6\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/https-proxy-agent/-/https-proxy-agent-7.0.6.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-vK9P5/iUfdl95AI+JVyUuIcVtd4ofvtrOr3HNtM2yxC9bnMbEdp3x01OhQNnjb8IJYi38VlTE3mBXwcfvywuSw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"agent-base\\": \\"^7.1.2\\",\\r\\n        \\"debug\\": \\"4\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/inherits\\": {\\r\\n      \\"version\\": \\"2.0.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/inherits/-/inherits-2.0.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ==\\",\\r\\n      \\"license\\": \\"ISC\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/is-fullwidth-code-point\\": {\\r\\n      \\"version\\": \\"3.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=8\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/is-stream\\": {\\r\\n      \\"version\\": \\"2.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/is-stream/-/is-stream-2.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-hFoiJiTl63nn+kstHGBtewWSKnQLpyb155KHheA1l39uvtO9nWIop1p3udqPcUd/xbF1VLMO4n7OI6p7RbngDg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=8\\"\\r\\n      },\\r\\n      \\"funding\\": {\\r\\n        \\"url\\": \\"https://github.com/sponsors/sindresorhus\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/jose\\": {\\r\\n      \\"version\\": \\"4.15.9\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/jose/-/jose-4.15.9.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-1vUQX+IdDMVPj4k8kOxgUqlcK518yluMuGZwqlr44FS1ppZB/5GWh4rZG89erpOBOJjU/OBsnCVFfapsRz6nEA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"funding\\": {\\r\\n        \\"url\\": \\"https://github.com/sponsors/panva\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/jpeg-exif\\": {\\r\\n      \\"version\\": \\"1.1.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/jpeg-exif/-/jpeg-exif-1.1.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-a+bKEcCjtuW5WTdgeXFzswSrdqi0jk4XlEtZlx5A94wCoBpFjfFTbo/Tra5SpNCl/YFZPvcV1dJc+TAYeg6ROQ==\\",\\r\\n      \\"deprecated\\": \\"Package no longer supported. Contact Support at https://www.npmjs.com/support for more info.\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/json-bigint\\": {\\r\\n      \\"version\\": \\"1.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/json-bigint/-/json-bigint-1.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-SiPv/8VpZuWbvLSMtTDU8hEfrZWg/mH/nV/b4o0CYbSxu1UIQPLdwKOCIyLQX+VIPO5vrLX3i8qtqFyhdPSUSQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"bignumber.js\\": \\"^9.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/jsonwebtoken\\": {\\r\\n      \\"version\\": \\"9.0.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/jsonwebtoken/-/jsonwebtoken-9.0.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-MT/xP0CrubFRNLNKvxJ2BYfy53Zkm++5bX9dtuPbqAeQpTVe0MQTFhao8+Cp//EmJp244xt6Drw/GVEGCUj40g==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"jws\\": \\"^4.0.1\\",\\r\\n        \\"lodash.includes\\": \\"^4.3.0\\",\\r\\n        \\"lodash.isboolean\\": \\"^3.0.3\\",\\r\\n        \\"lodash.isinteger\\": \\"^4.0.4\\",\\r\\n        \\"lodash.isnumber\\": \\"^3.0.3\\",\\r\\n        \\"lodash.isplainobject\\": \\"^4.0.6\\",\\r\\n        \\"lodash.isstring\\": \\"^4.0.1\\",\\r\\n        \\"lodash.once\\": \\"^4.0.0\\",\\r\\n        \\"ms\\": \\"^2.1.1\\",\\r\\n        \\"semver\\": \\"^7.5.4\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=12\\",\\r\\n        \\"npm\\": \\">=6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/jwa\\": {\\r\\n      \\"version\\": \\"2.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/jwa/-/jwa-2.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-hRF04fqJIP8Abbkq5NKGN0Bbr3JxlQ+qhZufXVr0DvujKy93ZCbXZMHDL4EOtodSbCWxOqR8MS1tXA5hwqCXDg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"buffer-equal-constant-time\\": \\"^1.0.1\\",\\r\\n        \\"ecdsa-sig-formatter\\": \\"1.0.11\\",\\r\\n        \\"safe-buffer\\": \\"^5.0.1\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/jwks-rsa\\": {\\r\\n      \\"version\\": \\"3.2.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/jwks-rsa/-/jwks-rsa-3.2.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-PwchfHcQK/5PSydeKCs1ylNym0w/SSv8a62DgHJ//7x2ZclCoinlsjAfDxAAbpoTPybOum/Jgy+vkvMmKz89Ww==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/express\\": \\"^4.17.20\\",\\r\\n        \\"@types/jsonwebtoken\\": \\"^9.0.4\\",\\r\\n        \\"debug\\": \\"^4.3.4\\",\\r\\n        \\"jose\\": \\"^4.15.4\\",\\r\\n        \\"limiter\\": \\"^1.1.5\\",\\r\\n        \\"lru-memoizer\\": \\"^2.2.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/jws\\": {\\r\\n      \\"version\\": \\"4.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/jws/-/jws-4.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-EKI/M/yqPncGUUh44xz0PxSidXFr/+r0pA70+gIYhjv+et7yxM+s29Y+VGDkovRofQem0fs7Uvf4+YmAdyRduA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"jwa\\": \\"^2.0.1\\",\\r\\n        \\"safe-buffer\\": \\"^5.0.1\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/leaflet\\": {\\r\\n      \\"version\\": \\"1.9.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/leaflet/-/leaflet-1.9.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-nxS1ynzJOmOlHp+iL3FyWqK89GtNL8U8rvlMOsQdTTssxZwCXh8N2NB3GDQOL+YR3XnWyZAxwQixURb+FA74PA==\\",\\r\\n      \\"license\\": \\"BSD-2-Clause\\"\\r\\n    },\\r\\n    \\"node_modules/limiter\\": {\\r\\n      \\"version\\": \\"1.1.5\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/limiter/-/limiter-1.1.5.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-FWWMIEOxz3GwUI4Ts/IvgVy6LPvoMPgjMdQ185nN6psJyBJ4yOpzqm695/h5umdLJg2vW3GR5iG11MAkR2AzJA==\\"\\r\\n    },\\r\\n    \\"node_modules/linebreak\\": {\\r\\n      \\"version\\": \\"1.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/linebreak/-/linebreak-1.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-MHp03UImeVhB7XZtjd0E4n6+3xr5Dq/9xI/5FptGk5FrbDR3zagPa2DS6U8ks/3HjbKWG9Q1M2ufOzxV2qLYSQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"base64-js\\": \\"0.0.8\\",\\r\\n        \\"unicode-trie\\": \\"^2.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/linebreak/node_modules/base64-js\\": {\\r\\n      \\"version\\": \\"0.0.8\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/base64-js/-/base64-js-0.0.8.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-3XSA2cR/h/73EzlXXdU6YNycmYI7+kicTxks4eJg2g39biHR84slg2+des+p7iHYhbRg/udIS4TD53WabcOUkw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/lodash.camelcase\\": {\\r\\n      \\"version\\": \\"4.3.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lodash.camelcase/-/lodash.camelcase-4.3.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-TwuEnCnxbc3rAvhf/LbG7tJUDzhqXyFnv3dtzLOPgCG/hODL7WFnsbwktkD7yUV0RrreP/l1PALq/YSg6VvjlA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/lodash.clonedeep\\": {\\r\\n      \\"version\\": \\"4.5.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lodash.clonedeep/-/lodash.clonedeep-4.5.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-H5ZhCF25riFd9uB5UCkVKo61m3S/xZk1x4wA6yp/L3RFP6Z/eHH1ymQcGLo7J3GMPfm0V/7m1tryHuGVxpqEBQ==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/lodash.includes\\": {\\r\\n      \\"version\\": \\"4.3.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lodash.includes/-/lodash.includes-4.3.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-W3Bx6mdkRTGtlJISOvVD/lbqjTlPPUDTMnlXZFnVwi9NKJ6tiAk6LVdlhZMm17VZisqhKcgzpO5Wz91PCt5b0w==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/lodash.isboolean\\": {\\r\\n      \\"version\\": \\"3.0.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lodash.isboolean/-/lodash.isboolean-3.0.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Bz5mupy2SVbPHURB98VAcw+aHh4vRV5IPNhILUCsOzRmsTmSQ17jIuqopAentWoehktxGd9e/hbIXq980/1QJg==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/lodash.isinteger\\": {\\r\\n      \\"version\\": \\"4.0.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lodash.isinteger/-/lodash.isinteger-4.0.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-DBwtEWN2caHQ9/imiNeEA5ys1JoRtRfY3d7V9wkqtbycnAmTvRRmbHKDV4a0EYc678/dia0jrte4tjYwVBaZUA==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/lodash.isnumber\\": {\\r\\n      \\"version\\": \\"3.0.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lodash.isnumber/-/lodash.isnumber-3.0.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-QYqzpfwO3/CWf3XP+Z+tkQsfaLL/EnUlXWVkIk5FUPc4sBdTehEqZONuyRt2P67PXAk+NXmTBcc97zw9t1FQrw==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/lodash.isplainobject\\": {\\r\\n      \\"version\\": \\"4.0.6\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lodash.isplainobject/-/lodash.isplainobject-4.0.6.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-oSXzaWypCMHkPC3NvBEaPHf0KsA5mvPrOPgQWDsbg8n7orZ290M0BmC/jgRZ4vcJ6DTAhjrsSYgdsW/F+MFOBA==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/lodash.isstring\\": {\\r\\n      \\"version\\": \\"4.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lodash.isstring/-/lodash.isstring-4.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-0wJxfxH1wgO3GrbuP+dTTk7op+6L41QCXbGINEmD+ny/G/eCqGzxyCsh7159S+mgDDcoarnBw6PC1PS5+wUGgw==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/lodash.once\\": {\\r\\n      \\"version\\": \\"4.1.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lodash.once/-/lodash.once-4.1.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Sb487aTOCr9drQVL8pIxOzVhafOjZN9UU54hiN8PU3uAiSV7lx1yYNpbNmex2PK6dSJoNTSJUUswT651yww3Mg==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/long\\": {\\r\\n      \\"version\\": \\"5.3.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/long/-/long-5.3.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-mNAgZ1GmyNhD7AuqnTG3/VQ26o760+ZYBPKjPvugO8+nLbYfX6TVpJPseBvopbdY+qpZ/lKUnmEc1LeZYS3QAA==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/lru-cache\\": {\\r\\n      \\"version\\": \\"6.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lru-cache/-/lru-cache-6.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Jo6dJ04CmSjuznwJSS3pUeWmd/H0ffTlkXXgwZi+eq1UCmqQwCh+eLsYOYCwY991i2Fah4h1BEMCx4qThGbsiA==\\",\\r\\n      \\"license\\": \\"ISC\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"yallist\\": \\"^4.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=10\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/lru-memoizer\\": {\\r\\n      \\"version\\": \\"2.3.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lru-memoizer/-/lru-memoizer-2.3.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-GXn7gyHAMhO13WSKrIiNfztwxodVsP8IoZ3XfrJV4yH2x0/OeTO/FIaAHTY5YekdGgW94njfuKmyyt1E0mR6Ug==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"lodash.clonedeep\\": \\"^4.5.0\\",\\r\\n        \\"lru-cache\\": \\"6.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/lucide-react\\": {\\r\\n      \\"version\\": \\"0.555.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/lucide-react/-/lucide-react-0.555.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-D8FvHUGbxWBRQM90NZeIyhAvkFfsh3u9ekrMvJ30Z6gnpBHS6HC6ldLg7tL45hwiIz/u66eKDtdA23gwwGsAHA==\\",\\r\\n      \\"license\\": \\"ISC\\",\\r\\n      \\"peerDependencies\\": {\\r\\n        \\"react\\": \\"^16.5.1 || ^17.0.0 || ^18.0.0 || ^19.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/math-intrinsics\\": {\\r\\n      \\"version\\": \\"1.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/math-intrinsics/-/math-intrinsics-1.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-/IXtbwEk5HTPyEwyKX6hGkYXxM9nbj64B+ilVJnC/R6B0pH5G4V3b0pVbL7DBj4tkhBAppbQUlf6F6Xl9LHu1g==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.4\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/mime\\": {\\r\\n      \\"version\\": \\"3.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/mime/-/mime-3.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-jSCU7/VB1loIWBZe14aEYHU/+1UMEHoaO7qxCOVJOw9GgH72VAWppxNcjU+x9a2k3GSIBXNKxXQFqRvvZ7vr3A==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"bin\\": {\\r\\n        \\"mime\\": \\"cli.js\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=10.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/mime-db\\": {\\r\\n      \\"version\\": \\"1.52.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/mime-db/-/mime-db-1.52.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-sPU4uV7dYlvtWJxwwxHD0PuihVNiE7TyAbQ5SWxDCB9mUYvOgroQOwYQQOKPJ8CIbE+1ETVlOoK1UC2nU3gYvg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/mime-types\\": {\\r\\n      \\"version\\": \\"2.1.35\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/mime-types/-/mime-types-2.1.35.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-ZDY+bPm5zTTF+YpCrAU9nK0UgICYPT0QtT1NZWFv4s++TNkcgVaT0g6+4R2uI4MjQjzysHB1zxuWL50hzaeXiw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"mime-db\\": \\"1.52.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 0.6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/ms\\": {\\r\\n      \\"version\\": \\"2.1.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/ms/-/ms-2.1.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/node-fetch\\": {\\r\\n      \\"version\\": \\"2.7.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/node-fetch/-/node-fetch-2.7.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-c4FRfUm/dbcWZ7U+1Wq0AwCyFL+3nt2bEw05wfxSz+DWpWsitgmSgYmy2dQdWyKC1694ELPqMs/YzUSNozLt8A==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"whatwg-url\\": \\"^5.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\"4.x || >=6.0.0\\"\\r\\n      },\\r\\n      \\"peerDependencies\\": {\\r\\n        \\"encoding\\": \\"^0.1.0\\"\\r\\n      },\\r\\n      \\"peerDependenciesMeta\\": {\\r\\n        \\"encoding\\": {\\r\\n          \\"optional\\": true\\r\\n        }\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/node-forge\\": {\\r\\n      \\"version\\": \\"1.3.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/node-forge/-/node-forge-1.3.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-rLvcdSyRCyouf6jcOIPe/BgwG/d7hKjzMKOas33/pHEr6gbq18IK9zV7DiPvzsz0oBJPme6qr6H6kGZuI9/DZg==\\",\\r\\n      \\"license\\": \\"(BSD-3-Clause OR GPL-2.0)\\",\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 6.13.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/object-hash\\": {\\r\\n      \\"version\\": \\"3.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/object-hash/-/object-hash-3.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-RSn9F68PjH9HqtltsSnqYC1XXoWe9Bju5+213R98cNGttag9q9yAOTzdbsqvIa7aNm5WffBZFpWYr2aWrklWAw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/once\\": {\\r\\n      \\"version\\": \\"1.4.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/once/-/once-1.4.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-lNaJgI+2Q5URQBkccEKHTQOPaXdUxnZZElQTZY0MFUAuaEqe1E+Nyvgdz/aIyNi6Z9MzO5dv1H8n58/GELp3+w==\\",\\r\\n      \\"license\\": \\"ISC\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"wrappy\\": \\"1\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/p-limit\\": {\\r\\n      \\"version\\": \\"3.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/p-limit/-/p-limit-3.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-TYOanM3wGwNGsZN2cVTYPArw454xnXj5qmWF1bEoAc4+cU/ol7GVh7odevjp1FNHduHc3KZMcFduxU5Xc6uJRQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"yocto-queue\\": \\"^0.1.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=10\\"\\r\\n      },\\r\\n      \\"funding\\": {\\r\\n        \\"url\\": \\"https://github.com/sponsors/sindresorhus\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/pako\\": {\\r\\n      \\"version\\": \\"0.2.9\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/pako/-/pako-0.2.9.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-NUcwaKxUxWrZLpDG+z/xZaCgQITkA/Dv4V/T6bw7VON6l1Xz/VnrBqrYjZQ12TamKHzITTfOEIYUj48y2KXImA==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/pdfkit\\": {\\r\\n      \\"version\\": \\"0.17.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/pdfkit/-/pdfkit-0.17.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-UnwF5fXy08f0dnp4jchFYAROKMNTaPqb/xgR8GtCzIcqoTnbOqtp3bwKvO4688oHI6vzEEs8Q6vqqEnC5IUELw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"crypto-js\\": \\"^4.2.0\\",\\r\\n        \\"fontkit\\": \\"^2.0.4\\",\\r\\n        \\"jpeg-exif\\": \\"^1.1.4\\",\\r\\n        \\"linebreak\\": \\"^1.1.0\\",\\r\\n        \\"png-js\\": \\"^1.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/png-js\\": {\\r\\n      \\"version\\": \\"1.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/png-js/-/png-js-1.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-k+YsbhpA9e+EFfKjTCH3VW6aoKlyNYI6NYdTfDL4CIvFnvsuO84ttonmZE7rc+v23SLTH8XX+5w/Ak9v0xGY4g==\\"\\r\\n    },\\r\\n    \\"node_modules/proto3-json-serializer\\": {\\r\\n      \\"version\\": \\"2.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/proto3-json-serializer/-/proto3-json-serializer-2.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-SAzp/O4Yh02jGdRc+uIrGoe87dkN/XtwxfZ4ZyafJHymd79ozp5VG5nyZ7ygqPM5+cpLDjjGnYFUkngonyDPOQ==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"protobufjs\\": \\"^7.2.5\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/protobufjs\\": {\\r\\n      \\"version\\": \\"7.5.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/protobufjs/-/protobufjs-7.5.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-CvexbZtbov6jW2eXAvLukXjXUW1TzFaivC46BpWc/3BpcCysb5Vffu+B3XHMm8lVEuy2Mm4XGex8hBSg1yapPg==\\",\\r\\n      \\"hasInstallScript\\": true,\\r\\n      \\"license\\": \\"BSD-3-Clause\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"@protobufjs/aspromise\\": \\"^1.1.2\\",\\r\\n        \\"@protobufjs/base64\\": \\"^1.1.2\\",\\r\\n        \\"@protobufjs/codegen\\": \\"^2.0.4\\",\\r\\n        \\"@protobufjs/eventemitter\\": \\"^1.1.0\\",\\r\\n        \\"@protobufjs/fetch\\": \\"^1.1.0\\",\\r\\n        \\"@protobufjs/float\\": \\"^1.0.2\\",\\r\\n        \\"@protobufjs/inquire\\": \\"^1.1.0\\",\\r\\n        \\"@protobufjs/path\\": \\"^1.1.2\\",\\r\\n        \\"@protobufjs/pool\\": \\"^1.1.0\\",\\r\\n        \\"@protobufjs/utf8\\": \\"^1.1.0\\",\\r\\n        \\"@types/node\\": \\">=13.7.0\\",\\r\\n        \\"long\\": \\"^5.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=12.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/react\\": {\\r\\n      \\"version\\": \\"19.2.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/react/-/react-19.2.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Ku/hhYbVjOQnXDZFv2+RibmLFGwFdeeKHFcOTlrt7xplBnya5OGn/hIRDsqDiSUcfORsDC7MPxwork8jBwsIWA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"peer\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=0.10.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/react-dom\\": {\\r\\n      \\"version\\": \\"19.2.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/react-dom/-/react-dom-19.2.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-yELu4WmLPw5Mr/lmeEpox5rw3RETacE++JgHqQzd2dg+YbJuat3jH4ingc+WPZhxaoFzdv9y33G+F7Nl5O0GBg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"peer\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"scheduler\\": \\"^0.27.0\\"\\r\\n      },\\r\\n      \\"peerDependencies\\": {\\r\\n        \\"react\\": \\"^19.2.3\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/react-leaflet\\": {\\r\\n      \\"version\\": \\"5.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/react-leaflet/-/react-leaflet-5.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-CWbTpr5vcHw5bt9i4zSlPEVQdTVcML390TjeDG0cK59z1ylexpqC6M1PJFjV8jD7CF+ACBFsLIDs6DRMoLEofw==\\",\\r\\n      \\"license\\": \\"Hippocratic-2.1\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"@react-leaflet/core\\": \\"^3.0.0\\"\\r\\n      },\\r\\n      \\"peerDependencies\\": {\\r\\n        \\"leaflet\\": \\"^1.9.0\\",\\r\\n        \\"react\\": \\"^19.0.0\\",\\r\\n        \\"react-dom\\": \\"^19.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/readable-stream\\": {\\r\\n      \\"version\\": \\"3.6.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-9u/sniCrY3D5WdsERHzHE4G2YCXqoG5FTHUiCC4SIbr6XcLZBY05ya9EKjYek9O5xOAwjGq+1JdGBAS7Q9ScoA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"inherits\\": \\"^2.0.3\\",\\r\\n        \\"string_decoder\\": \\"^1.1.1\\",\\r\\n        \\"util-deprecate\\": \\"^1.0.1\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/require-directory\\": {\\r\\n      \\"version\\": \\"2.1.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/require-directory/-/require-directory-2.1.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-fGxEI7+wsG9xrvdjsrlmL22OMTTiHRwAMroiEeMgq8gzoLC/PQr7RsRDSTLUg/bZAZtF+TVIkHc6/4RIKrui+Q==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=0.10.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/restructure\\": {\\r\\n      \\"version\\": \\"3.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/restructure/-/restructure-3.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-gSfoiOEA0VPE6Tukkrr7I0RBdE0s7H1eFCDBk05l1KIQT1UIKNc5JZy6jdyW6eYH3aR3g5b3PuL77rq0hvwtAw==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/retry\\": {\\r\\n      \\"version\\": \\"0.13.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/retry/-/retry-0.13.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-XQBQ3I8W1Cge0Seh+6gjj03LbmRFWuoszgK9ooCpwYIrhhoO80pfq4cUkU5DkknwfOfFteRwlZ56PYOGYyFWdg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 4\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/retry-request\\": {\\r\\n      \\"version\\": \\"7.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/retry-request/-/retry-request-7.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-dUOvLMJ0/JJYEn8NrpOaGNE7X3vpI5XlZS/u0ANjqtcZVKnIxP7IgCFwrKTxENw29emmwug53awKtaMm4i9g5w==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"@types/request\\": \\"^2.48.8\\",\\r\\n        \\"extend\\": \\"^3.0.2\\",\\r\\n        \\"teeny-request\\": \\"^9.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/safe-buffer\\": {\\r\\n      \\"version\\": \\"5.2.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.2.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==\\",\\r\\n      \\"funding\\": [\\r\\n        {\\r\\n          \\"type\\": \\"github\\",\\r\\n          \\"url\\": \\"https://github.com/sponsors/feross\\"\\r\\n        },\\r\\n        {\\r\\n          \\"type\\": \\"patreon\\",\\r\\n          \\"url\\": \\"https://www.patreon.com/feross\\"\\r\\n        },\\r\\n        {\\r\\n          \\"type\\": \\"consulting\\",\\r\\n          \\"url\\": \\"https://feross.org/support\\"\\r\\n        }\\r\\n      ],\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/scheduler\\": {\\r\\n      \\"version\\": \\"0.27.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/scheduler/-/scheduler-0.27.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-eNv+WrVbKu1f3vbYJT/xtiF5syA5HPIMtf9IgY/nKg0sWqzAUEvqY/xm7OcZc/qafLx/iO9FgOmeSAp4v5ti/Q==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"peer\\": true\\r\\n    },\\r\\n    \\"node_modules/semver\\": {\\r\\n      \\"version\\": \\"7.7.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/semver/-/semver-7.7.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-SdsKMrI9TdgjdweUSR9MweHA4EJ8YxHn8DFaDisvhVlUOe4BF1tLD7GAj0lIqWVl+dPb/rExr0Btby5loQm20Q==\\",\\r\\n      \\"license\\": \\"ISC\\",\\r\\n      \\"bin\\": {\\r\\n        \\"semver\\": \\"bin/semver.js\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=10\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/sonner\\": {\\r\\n      \\"version\\": \\"2.0.7\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/sonner/-/sonner-2.0.7.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-W6ZN4p58k8aDKA4XPcx2hpIQXBRAgyiWVkYhT7CvK6D3iAu7xjvVyhQHg2/iaKJZ1XVJ4r7XuwGL+WGEK37i9w==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"peerDependencies\\": {\\r\\n        \\"react\\": \\"^18.0.0 || ^19.0.0 || ^19.0.0-rc\\",\\r\\n        \\"react-dom\\": \\"^18.0.0 || ^19.0.0 || ^19.0.0-rc\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/stream-events\\": {\\r\\n      \\"version\\": \\"1.0.5\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/stream-events/-/stream-events-1.0.5.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-E1GUzBSgvct8Jsb3v2X15pjzN1tYebtbLaMg+eBOUOAxgbLoSbT2NS91ckc5lJD1KfLjId+jXJRgo0qnV5Nerg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"stubs\\": \\"^3.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/stream-shift\\": {\\r\\n      \\"version\\": \\"1.0.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/stream-shift/-/stream-shift-1.0.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-76ORR0DO1o1hlKwTbi/DM3EXWGf3ZJYO8cXX5RJwnul2DEg2oyoZyjLNoQM8WsvZiFKCRfC1O0J7iCvie3RZmQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/string_decoder\\": {\\r\\n      \\"version\\": \\"1.3.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/string_decoder/-/string_decoder-1.3.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-hkRX8U1WjJFd8LsDJ2yQ/wWWxaopEsABU1XfkM8A+j0+85JAGppt16cr1Whg6KIbb4okU6Mql6BOj+uup/wKeA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"safe-buffer\\": \\"~5.2.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/string-width\\": {\\r\\n      \\"version\\": \\"4.2.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"emoji-regex\\": \\"^8.0.0\\",\\r\\n        \\"is-fullwidth-code-point\\": \\"^3.0.0\\",\\r\\n        \\"strip-ansi\\": \\"^6.0.1\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=8\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/strip-ansi\\": {\\r\\n      \\"version\\": \\"6.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"ansi-regex\\": \\"^5.0.1\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=8\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/strnum\\": {\\r\\n      \\"version\\": \\"1.1.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/strnum/-/strnum-1.1.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-vrN+B7DBIoTTZjnPNewwhx6cBA/H+IS7rfW68n7XxC1y7uoiGQBxaKzqucGUgavX15dJgiGztLJ8vxuEzwqBdA==\\",\\r\\n      \\"funding\\": [\\r\\n        {\\r\\n          \\"type\\": \\"github\\",\\r\\n          \\"url\\": \\"https://github.com/sponsors/NaturalIntelligence\\"\\r\\n        }\\r\\n      ],\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/stubs\\": {\\r\\n      \\"version\\": \\"3.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/stubs/-/stubs-3.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-PdHt7hHUJKxvTCgbKX9C1V/ftOcjJQgz8BZwNfV5c4B6dcGqlpelTbJ999jBGZ2jYiPAwcX5dP6oBwVlBlUbxw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/tailwind-merge\\": {\\r\\n      \\"version\\": \\"3.4.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/tailwind-merge/-/tailwind-merge-3.4.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-uSaO4gnW+b3Y2aWoWfFpX62vn2sR3skfhbjsEnaBI81WD1wBLlHZe5sWf0AqjksNdYTbGBEd0UasQMT3SNV15g==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"funding\\": {\\r\\n        \\"type\\": \\"github\\",\\r\\n        \\"url\\": \\"https://github.com/sponsors/dcastil\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/teeny-request\\": {\\r\\n      \\"version\\": \\"9.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/teeny-request/-/teeny-request-9.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-resvxdc6Mgb7YEThw6G6bExlXKkv6+YbuzGg9xuXxSgxJF7Ozs+o8Y9+2R3sArdWdW8nOokoQb1yrpFB0pQK2g==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"http-proxy-agent\\": \\"^5.0.0\\",\\r\\n        \\"https-proxy-agent\\": \\"^5.0.0\\",\\r\\n        \\"node-fetch\\": \\"^2.6.9\\",\\r\\n        \\"stream-events\\": \\"^1.0.5\\",\\r\\n        \\"uuid\\": \\"^9.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=14\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/teeny-request/node_modules/agent-base\\": {\\r\\n      \\"version\\": \\"6.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/agent-base/-/agent-base-6.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-RZNwNclF7+MS/8bDg70amg32dyeZGZxiDuQmZxKLAlQjr3jGyLx+4Kkk58UO7D2QdgFIQCovuSuZESne6RG6XQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"debug\\": \\"4\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 6.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/teeny-request/node_modules/https-proxy-agent\\": {\\r\\n      \\"version\\": \\"5.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/https-proxy-agent/-/https-proxy-agent-5.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-dFcAjpTQFgoLMzC2VwU+C/CbS7uRL0lWmxDITmqm7C+7F0Odmj6s9l6alZc6AELXhrnggM2CeWSXHGOdX2YtwA==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"agent-base\\": \\"6\\",\\r\\n        \\"debug\\": \\"4\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">= 6\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/teeny-request/node_modules/uuid\\": {\\r\\n      \\"version\\": \\"9.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/uuid/-/uuid-9.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-b+1eJOlsR9K8HJpow9Ok3fiWOWSIcIzXodvv0rQjVoOVNpWMpxf1wZNpt4y9h10odCNrqnYp1OBzRktckBe3sA==\\",\\r\\n      \\"funding\\": [\\r\\n        \\"https://github.com/sponsors/broofa\\",\\r\\n        \\"https://github.com/sponsors/ctavan\\"\\r\\n      ],\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"bin\\": {\\r\\n        \\"uuid\\": \\"dist/bin/uuid\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/tiny-inflate\\": {\\r\\n      \\"version\\": \\"1.0.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/tiny-inflate/-/tiny-inflate-1.0.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-pkY1fj1cKHb2seWDy0B16HeWyczlJA9/WW3u3c4z/NiWDsO3DOU5D7nhTLE9CF0yXv/QZFY7sEJmj24dK+Rrqw==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/tr46\\": {\\r\\n      \\"version\\": \\"0.0.3\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/tr46/-/tr46-0.0.3.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-N3WMsuqV66lT30CrXNbEjx4GEwlow3v6rr4mCcv6prnfwhS01rkgyFdjPNBYd9br7LpXV1+Emh01fHnq2Gdgrw==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/tslib\\": {\\r\\n      \\"version\\": \\"2.8.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/tslib/-/tslib-2.8.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-oJFu94HQb+KVduSUQL7wnpmqnfmLsOA/nAh6b6EH0wCEoK0/mPeXU6c3wKDV83MkOuHPRHtSXKKU99IBazS/2w==\\",\\r\\n      \\"license\\": \\"0BSD\\"\\r\\n    },\\r\\n    \\"node_modules/undici-types\\": {\\r\\n      \\"version\\": \\"6.21.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/undici-types/-/undici-types-6.21.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-iwDZqg0QAGrg9Rav5H4n0M64c3mkR59cJ6wQp+7C4nI0gsmExaedaYLNO44eT4AtBBwjbTiGPMlt2Md0T9H9JQ==\\",\\r\\n      \\"license\\": \\"MIT\\"\\r\\n    },\\r\\n    \\"node_modules/unicode-properties\\": {\\r\\n      \\"version\\": \\"1.4.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/unicode-properties/-/unicode-properties-1.4.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-CLjCCLQ6UuMxWnbIylkisbRj31qxHPAurvena/0iwSVbQ2G1VY5/HjV0IRabOEbDHlzZlRdCrD4NhB0JtU40Pg==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"base64-js\\": \\"^1.3.0\\",\\r\\n        \\"unicode-trie\\": \\"^2.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/unicode-trie\\": {\\r\\n      \\"version\\": \\"2.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/unicode-trie/-/unicode-trie-2.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-x7bc76x0bm4prf1VLg79uhAzKw8DVboClSN5VxJuQ+LKDOVEW9CdH+VY7SP+vX7xCYQqzzgQpFqz15zeLvAtZQ==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"pako\\": \\"^0.2.5\\",\\r\\n        \\"tiny-inflate\\": \\"^1.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/util-deprecate\\": {\\r\\n      \\"version\\": \\"1.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/uuid\\": {\\r\\n      \\"version\\": \\"11.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/uuid/-/uuid-11.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-0/A9rDy9P7cJ+8w1c9WD9V//9Wj15Ce2MPz8Ri6032usz+NfePxx5AcN3bN+r6ZL6jEo066/yNYB3tn4pQEx+A==\\",\\r\\n      \\"funding\\": [\\r\\n        \\"https://github.com/sponsors/broofa\\",\\r\\n        \\"https://github.com/sponsors/ctavan\\"\\r\\n      ],\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"bin\\": {\\r\\n        \\"uuid\\": \\"dist/esm/bin/uuid\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/webidl-conversions\\": {\\r\\n      \\"version\\": \\"3.0.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/webidl-conversions/-/webidl-conversions-3.0.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-2JAn3z8AR6rjK8Sm8orRC0h/bcl/DqL7tRPdGZ4I1CjdF+EaMLmYxBHyXuKL849eucPFhvBoxMsflfOb8kxaeQ==\\",\\r\\n      \\"license\\": \\"BSD-2-Clause\\"\\r\\n    },\\r\\n    \\"node_modules/websocket-driver\\": {\\r\\n      \\"version\\": \\"0.7.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/websocket-driver/-/websocket-driver-0.7.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-b17KeDIQVjvb0ssuSDF2cYXSg2iztliJ4B9WdsuB6J952qCPKmnVq4DyW5motImXHDC1cBT/1UezrJVsKw5zjg==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"http-parser-js\\": \\">=0.5.1\\",\\r\\n        \\"safe-buffer\\": \\">=5.1.0\\",\\r\\n        \\"websocket-extensions\\": \\">=0.1.1\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=0.8.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/websocket-extensions\\": {\\r\\n      \\"version\\": \\"0.1.4\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/websocket-extensions/-/websocket-extensions-0.1.4.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-OqedPIGOfsDlo31UNwYbCFMSaO9m9G/0faIHj5/dZFDMFqPTcx6UwqyOy3COEaEOg/9VsGIpdqn62W5KhoKSpg==\\",\\r\\n      \\"license\\": \\"Apache-2.0\\",\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=0.8.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/whatwg-url\\": {\\r\\n      \\"version\\": \\"5.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/whatwg-url/-/whatwg-url-5.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-saE57nupxk6v3HY35+jzBwYa0rKSy0XR8JSxZPwgLr7ys0IBzhGviA1/TUGJLmSVqs8pb9AnvICXEuOHLprYTw==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"dependencies\\": {\\r\\n        \\"tr46\\": \\"~0.0.3\\",\\r\\n        \\"webidl-conversions\\": \\"^3.0.0\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/wrap-ansi\\": {\\r\\n      \\"version\\": \\"7.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-7.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-YVGIj2kamLSTxw6NsZjoBxfSwsn0ycdesmc4p+Q21c5zPuZ1pl+NfxVdxPtdHvmNVOQ6XSYG4AUtyt/Fi7D16Q==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"ansi-styles\\": \\"^4.0.0\\",\\r\\n        \\"string-width\\": \\"^4.1.0\\",\\r\\n        \\"strip-ansi\\": \\"^6.0.0\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=10\\"\\r\\n      },\\r\\n      \\"funding\\": {\\r\\n        \\"url\\": \\"https://github.com/chalk/wrap-ansi?sponsor=1\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/wrappy\\": {\\r\\n      \\"version\\": \\"1.0.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/wrappy/-/wrappy-1.0.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-l4Sp/DRseor9wL6EvV2+TuQn63dMkPjZ/sp9XkghTEbV9KlPS1xUsZ3u7/IQO4wxtcFB4bgpQPRcR3QCvezPcQ==\\",\\r\\n      \\"license\\": \\"ISC\\",\\r\\n      \\"optional\\": true\\r\\n    },\\r\\n    \\"node_modules/y18n\\": {\\r\\n      \\"version\\": \\"5.0.8\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/y18n/-/y18n-5.0.8.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-0pfFzegeDWJHJIAmTLRP2DwHjdF5s7jo9tuztdQxAhINCdvS+3nGINqPd00AphqJR/0LhANUS6/+7SCb98YOfA==\\",\\r\\n      \\"license\\": \\"ISC\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=10\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/yallist\\": {\\r\\n      \\"version\\": \\"4.0.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/yallist/-/yallist-4.0.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-3wdGidZyq5PB084XLES5TpOSRA3wjXAlIWMhum2kRcv/41Sn2emQ0dycQW4uZXLejwKvg6EsvbdlVL+FYEct7A==\\",\\r\\n      \\"license\\": \\"ISC\\"\\r\\n    },\\r\\n    \\"node_modules/yargs\\": {\\r\\n      \\"version\\": \\"17.7.2\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/yargs/-/yargs-17.7.2.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-7dSzzRQ++CKnNI/krKnYRV7JKKPUXMEh61soaHKg9mrWEhzFWhFnxPxGl+69cD1Ou63C13NUPCnmIcrvqCuM6w==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"dependencies\\": {\\r\\n        \\"cliui\\": \\"^8.0.1\\",\\r\\n        \\"escalade\\": \\"^3.1.1\\",\\r\\n        \\"get-caller-file\\": \\"^2.0.5\\",\\r\\n        \\"require-directory\\": \\"^2.1.1\\",\\r\\n        \\"string-width\\": \\"^4.2.3\\",\\r\\n        \\"y18n\\": \\"^5.0.5\\",\\r\\n        \\"yargs-parser\\": \\"^21.1.1\\"\\r\\n      },\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=12\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/yargs-parser\\": {\\r\\n      \\"version\\": \\"21.1.1\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/yargs-parser/-/yargs-parser-21.1.1.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-tVpsJW7DdjecAiFpbIB1e3qxIQsE6NoPc5/eTdrbbIC4h0LVsWhnoa3g+m2HclBIujHzsxZ4VJVA+GUuc2/LBw==\\",\\r\\n      \\"license\\": \\"ISC\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=12\\"\\r\\n      }\\r\\n    },\\r\\n    \\"node_modules/yocto-queue\\": {\\r\\n      \\"version\\": \\"0.1.0\\",\\r\\n      \\"resolved\\": \\"https://registry.npmjs.org/yocto-queue/-/yocto-queue-0.1.0.tgz\\",\\r\\n      \\"integrity\\": \\"sha512-rVksvsnNCdJ/ohGc6xgPwyN8eheCxsiLM8mxuE/t/mOVqJewPuO1miLpTHQiRgTKCLexL4MeAFVagts7HmNZ2Q==\\",\\r\\n      \\"license\\": \\"MIT\\",\\r\\n      \\"optional\\": true,\\r\\n      \\"engines\\": {\\r\\n        \\"node\\": \\">=10\\"\\r\\n      },\\r\\n      \\"funding\\": {\\r\\n        \\"url\\": \\"https://github.com/sponsors/sindresorhus\\"\\r\\n      }\\r\\n    }\\r\\n  }\\r\\n}\\r\\n"},{"id":"2iwhhn270","name":"package.json","path":"package.json","area":"CONFIG","content":"{\\r\\n  \\"name\\": \\"cronoapp\\",\\r\\n  \\"version\\": \\"1.0.0\\",\\r\\n  \\"description\\": \\"Monorepositorio para la aplicaci贸n de cronogramas. Contiene Frontend (web) y Backend (functions).\\",\\r\\n  \\"main\\": \\"index.js\\",\\r\\n  \\"scripts\\": {\\r\\n    \\"test\\": \\"echo \\\\\\"Error: Los tests se ejecutan en las subcarpetas: npm run test --workspace=functions\\\\\\" && exit 1\\",\\r\\n    \\"install:all\\": \\"npm install --workspaces\\",\\r\\n    \\"dev:backend\\": \\"npm run serve --workspace=functions\\",\\r\\n    \\"dev:frontend\\": \\"npm run dev --workspace=web\\"\\r\\n  },\\r\\n  \\"keywords\\": [\\r\\n    \\"firebase\\",\\r\\n    \\"nestjs\\",\\r\\n    \\"nextjs\\",\\r\\n    \\"typescript\\",\\r\\n    \\"monorepo\\"\\r\\n  ],\\r\\n  \\"author\\": \\"Vale - Senior Tech Lead\\",\\r\\n  \\"license\\": \\"ISC\\",\\r\\n  \\"dependencies\\": {\\r\\n    \\"@types/leaflet\\": \\"^1.9.21\\",\\r\\n    \\"clsx\\": \\"^2.1.1\\",\\r\\n    \\"date-fns\\": \\"^4.1.0\\",\\r\\n    \\"firebase-admin\\": \\"^13.6.0\\",\\r\\n    \\"leaflet\\": \\"^1.9.4\\",\\r\\n    \\"lucide-react\\": \\"^0.555.0\\",\\r\\n    \\"pdfkit\\": \\"^0.17.2\\",\\r\\n    \\"react-leaflet\\": \\"^5.0.0\\",\\r\\n    \\"sonner\\": \\"^2.0.7\\",\\r\\n    \\"tailwind-merge\\": \\"^3.4.0\\"\\r\\n  }\\r\\n}\\r\\n"},{"id":"879tpuidp","name":"service-account.json","path":"service-account.json","area":"CONFIG","content":"{\\n  \\"type\\": \\"service_account\\",\\n  \\"project_id\\": \\"comtroldata\\",\\n  \\"private_key_id\\": \\"542b807649adab8f5142487ad529a0522adff565\\",\\n  \\"private_key\\": \\"-----BEGIN PRIVATE KEY-----\\\\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC+EARTAdAae35J\\\\n11vk1mozAg+JRUgHjJ3n2tgcHHJToQZZdWBN090Q2nyxM3j4cdoR5BrDV9x5nhSj\\\\nIU9QTE9Z2Sc4iFx6xac1Di8JdZpWXb7S3Y1n2EIPyeVJLiejzLYExG/ha9JV8mO9\\\\nj0eD+UShtTHXVWhToA/6Jm2o1IZlmoWdTH9cDd8frMAYIOi8aZmpR/rP5H7RGRej\\\\nAvRqoC9eoizbA8u0QHGzkIAvezbOgCBy55J/bVZ1N7ARitdGsnIbiK5H9Sv9QIjC\\\\n0kz+EIdAMH6K3B8YuwtmCX53TMO8xBeGs+CTwXM86tic50WbdnTRV88uAOTEbTBC\\\\nZPr8EiVNAgMBAAECggEAPfzeVC5Gr6RwU2f8Th3KRDmbVJN2gxPPGmPrUPvMI89k\\\\nUT/xeWCsfIct3ONjRHBphaVGP0jEHRw8Mdo20oMY7D5hRtReiSI2vxyRpb2n6Rwp\\\\nFP/yUxiaryiTcfMuNYOaJ+LjdHtkfeiQtC3rTrU5N55vk4IFBSUyoMzwvfwWm0Mi\\\\nJfqmtGO0ADAUGgftkZlmd7Vh7yt3JNJRbsZW/hZFIAAsg7o8kQZ+5Frwmwo8Ntn+\\\\nUd4QryPAtBEUgTeafdeCKzs49Yi3RdbB60CBrcCq8uHgKGPP8xoga2VIIbx+smgr\\\\nV6rDp0GPXpEz3P5pq6LBKAQkfMd/1PMe7B0kCxPQpwKBgQD2X7befQ7JrR+HqZr0\\\\nMnJlzOFUbZT9TOL70e0LhOK7UE5tV5PXC1am8DIx/zuMcIC80f8hnyelHHopEv4+\\\\nvyChk4/U2NbU0ECxPqmDsFsIJJRt/Tc3/9TR8S3L7ZM7s+AezkxuEourrq5DSU1i\\\\n2gLuee1V85oANt3+zUBnt69/BwKBgQDFfRB8MP3GDEk5Y3lm+k8o+P9iLM4V/ZFQ\\\\ny57wq9pEZxWTbXyWefaN7aeg3wRxVpNQTK0HaT8mNppSBeI9c7S3EL5SbvkCyTUk\\\\nVHTN8o4BnQizVwkv5+ILU8UGW6dz/JFhxw55HyiiJO9bbxWzbCQK6pioCOVHDrf7\\\\nZafvlp7QCwKBgQCTDJXNPb8xyE7lXenKjsGQ2TQ0fCNM/DMOMkHVej8JpejpgjgP\\\\nRgk2Im8TQE9+hzePe5dXrfKvrcuL8HYnZVRInBZg5/txkcrK/6eVnhD3Tz34WAY5\\\\nOkz/8X9wFCCopbfDK0aa/B65Hc2NA5dYxN6zD7sEbh0gu57Mkh06ynvIyQKBgQCV\\\\nDSI/CV7PdgBh/vDmxu6t9tgRCc31DO77MuNfs+TFkaPYJF9O1vg+AGtu4ENjIzuF\\\\n9Ij3Ofj+Z2GrnGM3jDeNn2Z1ounvr1qbc97AfVuuXg3uBTea34FcmTnv5YcJ5Er5\\\\nqBoFUn4BeqzornuLcof1cUAMOsKJEdPMOto32s88JwKBgBts8voUhdhCqWu7sDLB\\\\nF6fAuzOQxKxiWB0CPn8GHNJwZgjiPB5+Hj9mZRyfsS5Bn8fmCrC8q4MTpKmpURMd\\\\nxmXteJP63Y6z2TQz8DhfVL84/0cTxC9nkRFqYeIkz+AiHkP8aw5u95f3QbThaGiM\\\\nQzvcb4tHgOvJh5+G4cOnOfHH\\\\n-----END PRIVATE KEY-----\\\\n\\",\\n  \\"client_email\\": \\"firebase-adminsdk-fbsvc@comtroldata.iam.gserviceaccount.com\\",\\n  \\"client_id\\": \\"109561112383296200622\\",\\n  \\"auth_uri\\": \\"https://accounts.google.com/o/oauth2/auth\\",\\n  \\"token_uri\\": \\"https://oauth2.googleapis.com/token\\",\\n  \\"auth_provider_x509_cert_url\\": \\"https://www.googleapis.com/oauth2/v1/certs\\",\\n  \\"client_x509_cert_url\\": \\"https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-fbsvc%40comtroldata.iam.gserviceaccount.com\\",\\n  \\"universe_domain\\": \\"googleapis.com\\"\\n}\\n\\n\\n\\n\\n"},{"id":"wrbeskn1p","name":"SNAPSHOT.js","path":"SNAPSHOT.js","area":"CONFIG","content":"const fs = require(\'fs\');\\nconst path = require(\'path\');\\nconst readline = require(\'readline\');\\n\\n// CONFIGURACIN GLOBAL\\nconst ROOT_DIR = process.cwd();\\nconst BACKUP_ROOT = path.join(ROOT_DIR, \'_SNAPSHOTS_ROOT\');\\nconst IGNORE_LIST = [\'node_modules\', \'.next\', \'.git\', \'.firebase\', \'_SNAPSHOTS_ROOT\', \'.DS_Store\', \'dist\', \'build\', \'.vscode\', \'package-lock.json\', \'yarn.lock\'];\\n\\n// Asegurar carpeta de snapshots\\nif (!fs.existsSync(BACKUP_ROOT)) fs.mkdirSync(BACKUP_ROOT);\\n\\n// --- FUNCIONES UTILITARIAS ---\\n\\nfunction copyRecursive(src, dest) {\\n    if (!fs.existsSync(dest)) fs.mkdirSync(dest, { recursive: true });\\n    const entries = fs.readdirSync(src, { withFileTypes: true });\\n\\n    for (const entry of entries) {\\n        if (IGNORE_LIST.includes(entry.name)) continue;\\n        const srcPath = path.join(src, entry.name);\\n        const destPath = path.join(dest, entry.name);\\n\\n        try {\\n            if (entry.isDirectory()) {\\n                copyRecursive(srcPath, destPath);\\n            } else {\\n                fs.copyFileSync(srcPath, destPath);\\n            }\\n        } catch (err) { /* Ignorar bloqueos de archivos en uso */ }\\n    }\\n}\\n\\n// Funci贸n para vaciar el directorio ra铆z antes de restaurar (con seguridad)\\nfunction clearRootDirectory(rootDir) {\\n    const entries = fs.readdirSync(rootDir, { withFileTypes: true });\\n    for (const entry of entries) {\\n        if (IGNORE_LIST.includes(entry.name) || entry.name === \'snapshot.js\') continue; // No borrar al propio script ni carpetas ignoradas\\n        const fullPath = path.join(rootDir, entry.name);\\n        try {\\n            if (entry.isDirectory()) {\\n                fs.rmSync(fullPath, { recursive: true, force: true });\\n            } else {\\n                fs.unlinkSync(fullPath);\\n            }\\n        } catch (e) { console.error(`锔 No se pudo borrar: ${entry.name}`); }\\n    }\\n}\\n\\n// --- FUNCIONES PRINCIPALES ---\\n\\n// 1. BACKUP COMPLETO (MACRO)\\nconst createFullBackup = (description = \'auto\') => {\\n    const timestamp = new Date().toISOString().replace(/T/, \'_\').replace(/:/g, \'-\').split(\'.\')[0];\\n    const safeDesc = description.replace(/[^a-z0-9]/gi, \'_\');\\n    const folderName = `FULL_BACKUP_${timestamp}__${safeDesc}`;\\n    const targetDir = path.join(BACKUP_ROOT, folderName);\\n\\n    console.log(` [MACRO] Creando Snapshot Completo: ${folderName}...`);\\n    try {\\n        copyRecursive(ROOT_DIR, targetDir);\\n        console.log(` Backup completo guardado en: _SNAPSHOTS_ROOT/${folderName}`);\\n        return targetDir;\\n    } catch (e) {\\n        console.error(` Error en backup completo: ${e.message}`);\\n        return null;\\n    }\\n};\\n\\n// 2. BACKUP DE ARCHIVO NICO (MICRO)\\nconst backupSingleFile = (filePath) => {\\n    if (!fs.existsSync(filePath)) return false;\\n    const backupPath = `${filePath}.bak`;\\n    try {\\n        fs.copyFileSync(filePath, backupPath);\\n        console.log(`★  [MICRO] Backup r谩pido creado: ${path.basename(backupPath)}`);\\n        return true;\\n    } catch (e) {\\n        console.error(` No se pudo crear backup del archivo: ${e.message}`);\\n        return false;\\n    }\\n};\\n\\n// 3. RESTAURAR ARCHIVO NICO (ROLLBACK)\\nconst restoreSingleFile = (filePath) => {\\n    const backupPath = `${filePath}.bak`;\\n    if (!fs.existsSync(backupPath)) {\\n        console.error(`锔 No existe backup (.bak) para: ${path.basename(filePath)}`);\\n        return false;\\n    }\\n    try {\\n        fs.copyFileSync(backupPath, filePath);\\n        console.log(`伙  [ROLLBACK] Archivo restaurado: ${path.basename(filePath)}`);\\n        return true;\\n    } catch (e) {\\n        console.error(` Error al restaurar archivo: ${e.message}`);\\n        return false;\\n    }\\n};\\n\\n// 4. RESTAURAR BACKUP COMPLETO (INTERACTIVO)\\nconst restoreFullBackupInteract = (rl) => {\\n    // Listar backups disponibles\\n    const backups = fs.readdirSync(BACKUP_ROOT)\\n        .filter(f => fs.statSync(path.join(BACKUP_ROOT, f)).isDirectory() && f.includes(\'FULL_BACKUP\'))\\n        .sort().reverse(); // Los m谩s recientes primero\\n\\n    if (backups.length === 0) {\\n        console.log(\' No se encontraron backups en _SNAPSHOTS_ROOT.\');\\n        rl.close();\\n        return;\\n    }\\n\\n    console.log(\'\\\\n Backups Disponibles (M谩s recientes primero):\');\\n    backups.forEach((b, i) => {\\n        console.log(`   [${i + 1}] ${b}`);\\n    });\\n    console.log(\'   [0] Cancelar\');\\n\\n    rl.question(\'\\\\n Elige el n煤mero del backup a restaurar: \', (answer) => {\\n        const idx = parseInt(answer) - 1;\\n        \\n        if (answer === \'0\' || isNaN(idx) || idx < 0 || idx >= backups.length) {\\n            console.log(\' Operaci贸n cancelada.\');\\n            rl.close();\\n            return;\\n        }\\n\\n        const selectedBackup = backups[idx];\\n        const sourcePath = path.join(BACKUP_ROOT, selectedBackup);\\n\\n        console.log(`\\\\n锔  ATENCIN: Se sobrescribir谩 el proyecto actual con la versi贸n: ${selectedBackup}`);\\n        console.log(\'   (Node_modules y .git se mantendr谩n intactos)\');\\n        \\n        rl.question(\'驴Est谩s seguro? Escribe \\"SI\\" para confirmar: \', (confirm) => {\\n            if (confirm.toUpperCase() === \'SI\') {\\n                console.log(\'\\\\nЧ Limpiando directorio actual...\');\\n                clearRootDirectory(ROOT_DIR);\\n                \\n                console.log(`伙  Restaurando desde ${selectedBackup}...`);\\n                copyRecursive(sourcePath, ROOT_DIR);\\n                \\n                console.log(\'\\\\n 隆Restauraci贸n COMPLETA exitosa!\');\\n                console.log(\'   Por favor, reinicia tu servidor de desarrollo si estaba corriendo.\');\\n            } else {\\n                console.log(\' Restauraci贸n cancelada.\');\\n            }\\n            rl.close();\\n        });\\n    });\\n};\\n\\n// --- INTERFAZ DE COMANDOS ---\\n\\nconst args = process.argv.slice(2);\\nconst command = args[0];\\nconst targetArg = args[1];\\n\\nif (command === \'auto\') {\\n    createFullBackup(\'automatico_pre_script\');\\n} else if (command === \'file-backup\' && targetArg) {\\n    backupSingleFile(targetArg);\\n} else if (command === \'file-restore\' && targetArg) {\\n    restoreSingleFile(targetArg);\\n} else {\\n    // MODO INTERACTIVO\\n    const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\\n    console.log(`\\n    =========================================\\n    ★  SNAPSHOT V3.0 - AUTO RESTORE\\n    =========================================\\n    1.  Backup COMPLETO del Proyecto\\n    2. 伙  Restaurar Backup COMPLETO (Autom谩tico)\\n    3.  Salir\\n    =========================================\\n    `);\\n\\n    rl.question(\'Elige una opci贸n: \', (opt) => {\\n        if (opt === \'1\') {\\n            rl.question(\'Descripci贸n (opcional): \', (desc) => { \\n                createFullBackup(desc || \'manual\'); \\n                rl.close(); \\n            });\\n        } else if (opt === \'2\') {\\n            restoreFullBackupInteract(rl);\\n        } else {\\n            rl.close();\\n        }\\n    });\\n}"},{"id":"af87lmqqw","name":"update_planner.js","path":"update_planner.js","area":"CONFIG","content":"const fs = require(\'fs\');\\r\\nconst path = require(\'path\');\\r\\n\\r\\n// --- CONFIGURACIN ---\\r\\nconst INPUT_FILE = \'contexto_limpio.txt\';\\r\\nconst OUTPUT_FILE = \'CronoApp_Audit_System.html\';\\r\\n\\r\\n// --- LGICA DE ANLISIS ---\\r\\nfunction analizarLogica(filePath, content) {\\r\\n    const lower = filePath.toLowerCase();\\r\\n    let description = \\"Archivo de soporte.\\";\\r\\n    let tags = [];\\r\\n\\r\\n    // L贸gica Backend\\r\\n    if (lower.includes(\'.controller.\')) {\\r\\n        description = \\"ENDPOINT API: Recibe peticiones HTTP, valida permisos y datos de entrada antes de llamar al servicio.\\";\\r\\n        tags.push(\\"API\\", \\"Entrada\\");\\r\\n    } else if (lower.includes(\'.service.\')) {\\r\\n        description = \\"LGICA DE NEGOCIO: Contiene el n煤cleo del procesamiento, c谩lculos y comunicaci贸n directa con la base de datos (Firestore).\\";\\r\\n        tags.push(\\"L贸gica\\", \\"DB\\");\\r\\n    } else if (lower.includes(\'.module.\')) {\\r\\n        description = \\"INYECCIN DE DEPENDENCIAS: Archivo de configuraci贸n que agrupa controladores y servicios para que funcionen juntos.\\";\\r\\n        tags.push(\\"Config\\");\\r\\n    } else if (lower.includes(\'cron\')) {\\r\\n        description = \\"AUTOMATIZACIN: Tarea programada que se ejecuta peri贸dicamente (ej: cerrar turnos vencidos).\\";\\r\\n        tags.push(\\"Cron\\", \\"Auto\\");\\r\\n    } \\r\\n    \\r\\n    // L贸gica Frontend\\r\\n    else if (lower.includes(\'pages\')) {\\r\\n        description = \\"VISTA PRINCIPAL: P谩gina accesible mediante URL. Orquesta la carga de datos y la disposici贸n de los componentes.\\";\\r\\n        tags.push(\\"Ruta\\", \\"UI\\");\\r\\n    } else if (lower.includes(\'components\') && lower.includes(\'map\')) {\\r\\n        description = \\"VISUALIZACIN GEOGRFICA: Componente complejo encargado de renderizar mapas, marcadores y estados operativos.\\";\\r\\n        tags.push(\\"Mapa\\", \\"Interactivo\\");\\r\\n    } else if (lower.includes(\'hooks\') || lower.startsWith(\'use\')) {\\r\\n        description = \\"GESTOR DE ESTADO: Hook personalizado que maneja la l贸gica reactiva y la suscripci贸n a datos en tiempo real (Snapshots).\\";\\r\\n        tags.push(\\"L贸gica UI\\", \\"Data\\");\\r\\n    }\\r\\n\\r\\n    return { description, tags };\\r\\n}\\r\\n\\r\\nfunction generarDashboard() {\\r\\n    if (!fs.existsSync(INPUT_FILE)) {\\r\\n        console.error(` ERROR: No existe \'${INPUT_FILE}\'. Ejecuta el generador de contexto primero.`);\\r\\n        return;\\r\\n    }\\r\\n\\r\\n    console.log(\\" Analizando estructura l贸gica...\\");\\r\\n    const rawContent = fs.readFileSync(INPUT_FILE, \'utf8\').replace(/\\\\r\\\\n/g, \'\\\\n\');\\r\\n    const lines = rawContent.split(\'\\\\n\');\\r\\n\\r\\n    // Estructura de Datos Jer谩rquica\\r\\n    const projectTree = {\\r\\n        backend: {},\\r\\n        frontend: {},\\r\\n        config: []\\r\\n    };\\r\\n\\r\\n    let currentFile = null;\\r\\n    let currentContent = [];\\r\\n    let captureContent = false;\\r\\n\\r\\n    // Parser\\r\\n    for (let i = 0; i < lines.length; i++) {\\r\\n        const line = lines[i].trim();\\r\\n        if (line.startsWith(\'FILE: \')) {\\r\\n            if (currentFile) procesarArchivo(currentFile, currentContent.join(\'\\\\n\'), projectTree);\\r\\n            \\r\\n            currentFile = line.replace(\'FILE: \', \'\').trim();\\r\\n            currentContent = [];\\r\\n            captureContent = false;\\r\\n        } else if (line.startsWith(\'======\')) {\\r\\n            if (currentFile) captureContent = true;\\r\\n        } else {\\r\\n            if (captureContent && currentFile) currentContent.push(lines[i]);\\r\\n        }\\r\\n    }\\r\\n    if (currentFile) procesarArchivo(currentFile, currentContent.join(\'\\\\n\'), projectTree);\\r\\n\\r\\n    console.log(\\" Construyendo interfaz gr谩fica...\\");\\r\\n    crearHTML(projectTree);\\r\\n}\\r\\n\\r\\nfunction procesarArchivo(filePath, content, tree) {\\r\\n    const parts = filePath.split(path.sep); // Dividir por carpetas\\r\\n    const fileName = path.basename(filePath);\\r\\n    const meta = analizarLogica(filePath, content);\\r\\n    \\r\\n    const fileData = {\\r\\n        id: Math.random().toString(36).substr(2, 9),\\r\\n        name: fileName,\\r\\n        path: filePath,\\r\\n        content: escapeHtml(content),\\r\\n        logic: meta.description,\\r\\n        tags: meta.tags\\r\\n    };\\r\\n\\r\\n    // Clasificaci贸n\\r\\n    if (filePath.includes(\'apps/functions\') || filePath.includes(\'apps\\\\\\\\functions\')) {\\r\\n        // Intentar agrupar por m贸dulos (src/modules/X)\\r\\n        const moduleMatch = filePath.match(/modules[\\\\\\\\/]([^\\\\\\\\/]+)/);\\r\\n        const moduleName = moduleMatch ? moduleMatch[1].toUpperCase() : \'GENERAL\';\\r\\n        \\r\\n        if (!tree.backend[moduleName]) tree.backend[moduleName] = [];\\r\\n        tree.backend[moduleName].push(fileData);\\r\\n\\r\\n    } else if (filePath.includes(\'apps/web\') || filePath.includes(\'apps\\\\\\\\web\')) {\\r\\n        // Agrupar por tipo (Pages, Components, Hooks)\\r\\n        let group = \'OTROS\';\\r\\n        if (filePath.includes(\'pages\')) group = \'PGINAS (RUTAS)\';\\r\\n        else if (filePath.includes(\'components\')) group = \'COMPONENTES UI\';\\r\\n        else if (filePath.includes(\'hooks\')) group = \'HOOKS (LGICA)\';\\r\\n        else if (filePath.includes(\'lib\')) group = \'LIBRERAS\';\\r\\n\\r\\n        if (!tree.frontend[group]) tree.frontend[group] = [];\\r\\n        tree.frontend[group].push(fileData);\\r\\n    } else {\\r\\n        tree.config.push(fileData);\\r\\n    }\\r\\n}\\r\\n\\r\\nfunction escapeHtml(text) {\\r\\n    return text.replace(/&/g, \\"&amp;\\").replace(/</g, \\"&lt;\\").replace(/>/g, \\"&gt;\\");\\r\\n}\\r\\n\\r\\nfunction crearHTML(tree) {\\r\\n    const jsonTree = JSON.stringify(tree).replace(/\\\\\\\\/g, \'\\\\\\\\\\\\\\\\\').replace(/\'/g, \\"\\\\\\\\\'\\");\\r\\n\\r\\n    const html = `\\r\\n<!DOCTYPE html>\\r\\n<html lang=\\"es\\">\\r\\n<head>\\r\\n    <meta charset=\\"UTF-8\\">\\r\\n    <meta name=\\"viewport\\" content=\\"width=device-width, initial-scale=1.0\\">\\r\\n    <title>CronoApp System Audit</title>\\r\\n    <link href=\\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css\\" rel=\\"stylesheet\\">\\r\\n    <link href=\\"https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap\\" rel=\\"stylesheet\\">\\r\\n    <script src=\\"https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js\\"></script>\\r\\n\\r\\n    <style>\\r\\n        :root {\\r\\n            --bg: #0f172a;\\r\\n            --sidebar: #1e293b;\\r\\n            --border: #334155;\\r\\n            --text: #f1f5f9;\\r\\n            --text-muted: #94a3b8;\\r\\n            --primary: #3b82f6;\\r\\n            --secondary: #10b981;\\r\\n            --accent: #f59e0b;\\r\\n            --code-bg: #0d1117;\\r\\n        }\\r\\n        * { margin: 0; padding: 0; box-sizing: border-box; }\\r\\n        body { font-family: \'Inter\', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }\\r\\n\\r\\n        /* SIDEBAR */\\r\\n        aside { width: 350px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }\\r\\n        .brand { padding: 20px; border-bottom: 1px solid var(--border); background: #020617; }\\r\\n        .brand h1 { font-size: 1.2rem; font-weight: 800; letter-spacing: -0.5px; color: white; }\\r\\n        .brand span { color: var(--primary); }\\r\\n        .brand p { font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; }\\r\\n\\r\\n        .nav-container { flex: 1; overflow-y: auto; padding: 10px; }\\r\\n        \\r\\n        /* Acordeones */\\r\\n        details { margin-bottom: 5px; border-radius: 6px; overflow: hidden; }\\r\\n        summary { \\r\\n            padding: 12px; cursor: pointer; background: rgba(255,255,255,0.03); \\r\\n            font-weight: 600; font-size: 0.85rem; user-select: none;\\r\\n            display: flex; justify-content: space-between; align-items: center;\\r\\n            transition: background 0.2s;\\r\\n        }\\r\\n        summary:hover { background: rgba(255,255,255,0.08); }\\r\\n        summary::marker { content: \'\'; }\\r\\n        summary::after { content: \'\\\\\\\\f078\'; font-family: \'Font Awesome 6 Free\'; font-weight: 900; font-size: 0.7rem; transition: transform 0.2s; }\\r\\n        details[open] summary::after { transform: rotate(180deg); }\\r\\n        details[open] summary { background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--border); }\\r\\n\\r\\n        .sub-group { padding: 5px 0 5px 15px; border-left: 2px solid var(--border); margin-left: 10px; }\\r\\n        .sub-summary { font-size: 0.8rem; color: var(--text-muted); padding: 8px; text-transform: uppercase; letter-spacing: 1px; }\\r\\n\\r\\n        .file-link { \\r\\n            display: flex; align-items: center; gap: 8px; padding: 8px 10px 8px 25px; \\r\\n            font-size: 0.85rem; color: var(--text-muted); cursor: pointer; text-decoration: none; \\r\\n            border-left: 2px solid transparent; transition: all 0.2s; \\r\\n        }\\r\\n        .file-link:hover { color: white; background: rgba(255,255,255,0.05); }\\r\\n        .file-link.active { color: var(--primary); border-left-color: var(--primary); background: rgba(59, 130, 246, 0.1); }\\r\\n        .file-link i { width: 15px; text-align: center; font-size: 0.8rem; }\\r\\n\\r\\n        /* MAIN */\\r\\n        main { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; }\\r\\n        \\r\\n        /* TOP BAR */\\r\\n        .top-bar { \\r\\n            height: 60px; border-bottom: 1px solid var(--border); display: flex; \\r\\n            align-items: center; justify-content: space-between; padding: 0 20px; \\r\\n            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);\\r\\n        }\\r\\n        .file-meta h2 { font-size: 1rem; font-family: \'JetBrains Mono\', monospace; }\\r\\n        .file-path { font-size: 0.75rem; color: var(--text-muted); font-family: \'JetBrains Mono\', monospace; }\\r\\n        .actions { display: flex; gap: 10px; }\\r\\n        .btn { \\r\\n            padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border); \\r\\n            background: transparent; color: var(--text); cursor: pointer; font-size: 0.8rem; \\r\\n            display: flex; align-items: center; gap: 6px; transition: all 0.2s;\\r\\n        }\\r\\n        .btn:hover { background: var(--primary); border-color: var(--primary); }\\r\\n        .btn-refresh { color: var(--secondary); border-color: var(--secondary); }\\r\\n        .btn-refresh:hover { background: var(--secondary); color: white; }\\r\\n\\r\\n        /* CONTENT AREA */\\r\\n        .content-area { flex: 1; overflow-y: auto; padding: 30px; display: none; }\\r\\n        .content-area.active { display: block; }\\r\\n\\r\\n        /* LOGIC CARD */\\r\\n        .logic-card { \\r\\n            background: #162032; border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; \\r\\n            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);\\r\\n        }\\r\\n        .logic-title { font-size: 0.8rem; font-weight: 800; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }\\r\\n        .logic-text { font-size: 0.95rem; line-height: 1.6; color: #cbd5e1; }\\r\\n        .tags { display: flex; gap: 8px; margin-top: 15px; }\\r\\n        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; background: rgba(255,255,255,0.1); color: var(--text-muted); }\\r\\n\\r\\n        /* CODE EDITOR */\\r\\n        .code-wrapper { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: var(--code-bg); }\\r\\n        .code-header { \\r\\n            padding: 8px 15px; background: #1f293b; border-bottom: 1px solid var(--border); \\r\\n            font-size: 0.75rem; color: var(--text-muted); font-family: \'JetBrains Mono\', monospace;\\r\\n            display: flex; justify-content: space-between;\\r\\n        }\\r\\n        pre { margin: 0; padding: 20px; overflow-x: auto; }\\r\\n        code { font-family: \'JetBrains Mono\', monospace; font-size: 0.85rem; line-height: 1.5; color: #e5e7eb; }\\r\\n\\r\\n        /* WELCOME */\\r\\n        .welcome { \\r\\n            height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; \\r\\n            text-align: center; color: var(--text-muted); \\r\\n        }\\r\\n        .welcome i { font-size: 4rem; margin-bottom: 20px; color: var(--primary); opacity: 0.5; }\\r\\n        .welcome h2 { font-size: 1.5rem; color: white; margin-bottom: 10px; }\\r\\n\\r\\n        /* SYNTAX */\\r\\n        .kw { color: #c678dd; } .fn { color: #61afef; } .str { color: #98c379; } .cm { color: #5c6370; font-style: italic; }\\r\\n    </style>\\r\\n</head>\\r\\n<body>\\r\\n\\r\\n    <aside>\\r\\n        <div class=\\"brand\\">\\r\\n            <h1>CronoApp <span>Audit</span></h1>\\r\\n            <p>Sistema de Auditor铆a T茅cnica</p>\\r\\n            <p style=\\"font-size: 0.65rem; opacity: 0.5; margin-top: 2px;\\">Generado: ${new Date().toLocaleString()}</p>\\r\\n        </div>\\r\\n        <div class=\\"nav-container\\" id=\\"navRoot\\">\\r\\n            </div>\\r\\n    </aside>\\r\\n\\r\\n    <main>\\r\\n        <div class=\\"top-bar\\">\\r\\n            <div class=\\"file-meta\\" id=\\"headerMeta\\" style=\\"opacity: 0;\\">\\r\\n                <h2 id=\\"headerTitle\\">Nombre del Archivo</h2>\\r\\n                <span class=\\"file-path\\" id=\\"headerPath\\">ruta/del/archivo</span>\\r\\n            </div>\\r\\n            <div class=\\"actions\\">\\r\\n                <button class=\\"btn btn-refresh\\" onclick=\\"alert(\'Para actualizar, ejecuta nuevamente: node generar_dashboard_ultimate.js en tu terminal.\')\\">\\r\\n                    <i class=\\"fas fa-sync\\"></i> Actualizar\\r\\n                </button>\\r\\n                <button class=\\"btn\\" onclick=\\"exportPDF()\\">\\r\\n                    <i class=\\"fas fa-file-pdf\\"></i> PDF\\r\\n                </button>\\r\\n            </div>\\r\\n        </div>\\r\\n\\r\\n        <div id=\\"welcomeScreen\\" class=\\"welcome\\">\\r\\n            <i class=\\"fas fa-laptop-code\\"></i>\\r\\n            <h2>Selecciona un componente</h2>\\r\\n            <p>Navega por el panel izquierdo para auditar la l贸gica y c贸digo.</p>\\r\\n        </div>\\r\\n\\r\\n        <div id=\\"contentArea\\" class=\\"content-area\\">\\r\\n            <div class=\\"logic-card\\">\\r\\n                <div class=\\"logic-title\\"><i class=\\"fas fa-brain\\"></i> An谩lisis L贸gico</div>\\r\\n                <p class=\\"logic-text\\" id=\\"logicDesc\\">Descripci贸n del archivo...</p>\\r\\n                <div class=\\"tags\\" id=\\"logicTags\\"></div>\\r\\n            </div>\\r\\n\\r\\n            <div class=\\"code-wrapper\\">\\r\\n                <div class=\\"code-header\\">CDIGO FUENTE</div>\\r\\n                <pre><code id=\\"codeBlock\\"></code></pre>\\r\\n            </div>\\r\\n        </div>\\r\\n    </main>\\r\\n\\r\\n    <script>\\r\\n        const data = ${jsonTree};\\r\\n\\r\\n        function init() {\\r\\n            const nav = document.getElementById(\'navRoot\');\\r\\n            \\r\\n            // 1. BACKEND SECTION\\r\\n            const backendDetails = createSection(\'BACKEND (Functions)\', \'fa-server\', \'var(--primary)\');\\r\\n            Object.keys(data.backend).forEach(moduleName => {\\r\\n                const subDetails = document.createElement(\'details\');\\r\\n                subDetails.innerHTML = \\\\`<summary class=\\"sub-summary\\"><i class=\\"fas fa-folder\\" style=\\"margin-right:8px\\"></i> \\\\${moduleName}</summary>\\\\`;\\r\\n                const subGroup = document.createElement(\'div\');\\r\\n                subGroup.className = \'sub-group\';\\r\\n                \\r\\n                data.backend[moduleName].forEach(file => {\\r\\n                    subGroup.appendChild(createFileLink(file));\\r\\n                });\\r\\n                \\r\\n                subDetails.appendChild(subGroup);\\r\\n                backendDetails.querySelector(\'.group-content\').appendChild(subDetails);\\r\\n            });\\r\\n            nav.appendChild(backendDetails);\\r\\n\\r\\n            // 2. FRONTEND SECTION\\r\\n            const frontendDetails = createSection(\'FRONTEND (Web)\', \'fa-desktop\', \'var(--secondary)\');\\r\\n            Object.keys(data.frontend).forEach(groupName => {\\r\\n                const subDetails = document.createElement(\'details\');\\r\\n                subDetails.innerHTML = \\\\`<summary class=\\"sub-summary\\"><i class=\\"fas fa-layer-group\\" style=\\"margin-right:8px\\"></i> \\\\${groupName}</summary>\\\\`;\\r\\n                const subGroup = document.createElement(\'div\');\\r\\n                subGroup.className = \'sub-group\';\\r\\n                \\r\\n                data.frontend[groupName].forEach(file => {\\r\\n                    subGroup.appendChild(createFileLink(file));\\r\\n                });\\r\\n                \\r\\n                subDetails.appendChild(subGroup);\\r\\n                frontendDetails.querySelector(\'.group-content\').appendChild(subDetails);\\r\\n            });\\r\\n            nav.appendChild(frontendDetails);\\r\\n\\r\\n            // 3. CONFIG\\r\\n            const configDetails = createSection(\'CONFIGURACIN\', \'fa-cogs\', \'#94a3b8\');\\r\\n            const configGroup = document.createElement(\'div\');\\r\\n            configGroup.className = \'sub-group\';\\r\\n            data.config.forEach(file => configGroup.appendChild(createFileLink(file)));\\r\\n            configDetails.querySelector(\'.group-content\').appendChild(configGroup);\\r\\n            nav.appendChild(configDetails);\\r\\n        }\\r\\n\\r\\n        function createSection(title, icon, color) {\\r\\n            const details = document.createElement(\'details\');\\r\\n            details.open = true;\\r\\n            details.innerHTML = \\\\`\\r\\n                <summary style=\\"color: \\\\${color}\\"><i class=\\"fas \\\\${icon}\\" style=\\"margin-right: 10px;\\"></i> \\\\${title}</summary>\\r\\n                <div class=\\"group-content\\" style=\\"padding-left: 10px;\\"></div>\\r\\n            \\\\`;\\r\\n            return details;\\r\\n        }\\r\\n\\r\\n        function createFileLink(file) {\\r\\n            const a = document.createElement(\'a\');\\r\\n            a.className = \'file-link\';\\r\\n            let icon = \'fa-file-code\';\\r\\n            if (file.name.includes(\'ts\')) icon = \'fa-js-square\';\\r\\n            if (file.name.includes(\'json\')) icon = \'fa-cog\';\\r\\n            \\r\\n            a.innerHTML = \\\\`<i class=\\"fas \\\\${icon}\\"></i> \\\\${file.name}\\\\`;\\r\\n            a.onclick = () => loadFile(file, a);\\r\\n            return a;\\r\\n        }\\r\\n\\r\\n        function loadFile(file, element) {\\r\\n            // UI Updates\\r\\n            document.querySelectorAll(\'.file-link\').forEach(e => e.classList.remove(\'active\'));\\r\\n            element.classList.add(\'active\');\\r\\n            document.getElementById(\'welcomeScreen\').style.display = \'none\';\\r\\n            document.getElementById(\'contentArea\').classList.add(\'active\');\\r\\n            document.getElementById(\'headerMeta\').style.opacity = \'1\';\\r\\n\\r\\n            // Set Data\\r\\n            document.getElementById(\'headerTitle\').innerText = file.name;\\r\\n            document.getElementById(\'headerPath\').innerText = file.path;\\r\\n            document.getElementById(\'logicDesc\').innerText = file.logic;\\r\\n            \\r\\n            // Tags\\r\\n            const tagsContainer = document.getElementById(\'logicTags\');\\r\\n            tagsContainer.innerHTML = \'\';\\r\\n            file.tags.forEach(tag => {\\r\\n                const span = document.createElement(\'span\');\\r\\n                span.className = \'tag\';\\r\\n                span.innerText = tag;\\r\\n                tagsContainer.appendChild(span);\\r\\n            });\\r\\n\\r\\n            // Code & Syntax\\r\\n            document.getElementById(\'codeBlock\').innerHTML = syntaxHighlight(file.content);\\r\\n        }\\r\\n\\r\\n        function syntaxHighlight(code) {\\r\\n            let html = code.replace(/&/g, \\"&amp;\\").replace(/</g, \\"&lt;\\").replace(/>/g, \\"&gt;\\");\\r\\n            html = html.replace(/\\\\\\\\b(import|export|const|let|var|function|return|if|else|async|await|class|interface|from)\\\\\\\\b/g, \'<span class=\\"kw\\">$1</span>\');\\r\\n            html = html.replace(/\\\\\\\\b(string|number|boolean|any|void|Promise|console|log)\\\\\\\\b/g, \'<span class=\\"fn\\">$1</span>\');\\r\\n            html = html.replace(/(\'\'\'.*?\'\'\'|\'.*?\'|\\".*?\\")/g, \'<span class=\\"str\\">$1</span>\');\\r\\n            html = html.replace(/(\\\\\\\\/\\\\\\\\/.*)/g, \'<span class=\\"cm\\">$1</span>\');\\r\\n            return html;\\r\\n        }\\r\\n\\r\\n        function exportPDF() {\\r\\n            const element = document.getElementById(\'contentArea\');\\r\\n            const title = document.getElementById(\'headerTitle\').innerText;\\r\\n            const opt = {\\r\\n                margin: 10,\\r\\n                filename: \\\\`Auditoria_\\\\${title}.pdf\\\\`,\\r\\n                image: { type: \'jpeg\', quality: 0.98 },\\r\\n                html2canvas: { scale: 2 },\\r\\n                jsPDF: { unit: \'mm\', format: \'a4\', orientation: \'portrait\' }\\r\\n            };\\r\\n            html2pdf().set(opt).from(element).save();\\r\\n        }\\r\\n\\r\\n        init();\\r\\n    </script>\\r\\n</body>\\r\\n</html>\\r\\n    `;\\r\\n\\r\\n    fs.writeFileSync(OUTPUT_FILE, html);\\r\\n    console.log(` DASHBOARD GENERADO: ${OUTPUT_FILE}`);\\r\\n}\\r\\n\\r\\ngenerarDashboard();"},{"id":"3kgeppi6r","name":"vite.config.js","path":"vite.config.js","area":"CONFIG","content":"import { defineConfig } from \'vite\'\\nimport react from \'@vitejs/plugin-react-swc\'\\n\\n// https://vite.dev/config/\\nexport default defineConfig({\\n  plugins: [react()],\\n})\\n\\n\\n"}];
        const listEl = document.getElementById('list');
        const codeEl = document.getElementById('codeArea');
        const pathEl = document.getElementById('pathDisplay');

        function render() {
            const term = document.getElementById('search').value.toLowerCase();
            const filtered = files.filter(f => f.name.toLowerCase().includes(term) || f.path.toLowerCase().includes(term));
            
            listEl.innerHTML = '';
            
            ['BACKEND', 'FRONTEND', 'CONFIG'].forEach(area => {
                const group = filtered.filter(f => f.area === area);
                if (group.length) {
                    const title = document.createElement('div');
                    title.className = 'category';
                    title.innerText = area;
                    listEl.appendChild(title);
                    
                    group.forEach(f => {
                        const div = document.createElement('div');
                        div.className = 'item';
                        div.innerText = f.name; // + ' (' + f.path.split(/[\\/]/).slice(-2,-1)[0] + ')';
                        div.onclick = () => load(f, div);
                        listEl.appendChild(div);
                    });
                }
            });
        }

        function load(file, el) {
            document.querySelectorAll('.item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            pathEl.innerText = file.path;
            
            // Highlight b谩sico
            let code = file.content
                .replace(/&/g, "&amp;").replace(/</g, "&lt;")
                .replace(/\b(import|export|const|let|var|function|return|if|else|class)\b/g, '<span class="kw">$1</span>')
                .replace(/('''.*?'''|'.*?'|".*?")/g, '<span class="str">$1</span>')
                .replace(/(\/\/.*)/g, '<span class="cm">$1</span>');
                
            codeEl.innerHTML = code;
        }

        render();
    </script>
</body>
</html>